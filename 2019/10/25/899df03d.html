<!DOCTYPE html><html lang="[&quot;zh-Hans&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚"><meta name="keywords" content="MyBatis, MyBatisæŠ€æœ¯å†…å¹•"><meta name="author" content="ğŸ³Antä¸¶"><meta name="copyright" content="ğŸ³Antä¸¶"><title>åŸºç¡€æ”¯æŒå±‚â€”â€”åå°„æ¨¡å— | BLOG | CAYZLH</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/logo/favicon.ico"><link rel="stylesheet" href="/blog/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-129095667-1', 'auto');
ga('send', 'pageview');</script><meta name="google-site-verification" content="VrcbMTVpFGlHkIERHBt753dAtXKF4qirjnDweuXSRJw"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blog/atom.xml" title="BLOG | CAYZLH" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%B7%A5%E5%85%B7%E7%AE%B1"><span class="toc-text">åå°„å·¥å…·ç®±</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Reflector-amp-ReflectorFactory"><span class="toc-text">Reflector &amp; ReflectorFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeParameterResolver"><span class="toc-text">TypeParameterResolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ObjectFactory"><span class="toc-text">ObjectFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Property%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">Propertyå·¥å…·ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MetaClass"><span class="toc-text">MetaClass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ObjectWrapper"><span class="toc-text">ObjectWrapper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MetaObject"><span class="toc-text">MetaObject</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-text">ç±»å‹è½¬æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeHandler"><span class="toc-text">TypeHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeHandlerRegistry"><span class="toc-text">TypeHandlerRegistry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeAliasRegistry"><span class="toc-text">TypeAliasRegistry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/image/IMG_4207.JPG"></div><div class="author-info__name text-center">ğŸ³Antä¸¶</div><div class="author-info__description text-center">CODE IS POETRY</div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://telegram.me/Q2F5emxo">contact me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">98</span></a><a class="author-info-articles__tags article-meta" href="/blog/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"><span class="pull-left">ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹</span><span class="pull-right">âˆš</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"><span class="pull-left">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</span><span class="pull-right">âˆš</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="pull-left">Javaè®¾è®¡æ¨¡å¼</span><span class="pull-right">âˆš</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">BLOG | CAYZLH</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">åŸºç¡€æ”¯æŒå±‚â€”â€”åå°„æ¨¡å—</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/">ä¹¦ç±</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">8.7k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 37 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm-20200609160003190_wDXqrk.png" alt="æ•´ä½“æ¶æ„"></p>
<blockquote>
<p>è¿™ç¯‡ä»‹ç»MyBatisçš„åå°„æ¨¡å—</p>
</blockquote>
<h3 id="åå°„å·¥å…·ç®±"><a href="#åå°„å·¥å…·ç®±" class="headerlink" title="åå°„å·¥å…·ç®±"></a>åå°„å·¥å…·ç®±</h3><p>Mybatis åœ¨è¿›è¡Œå‚æ•°å¤„ç†ã€ç»“æœæ˜ å°„ç­‰æ“ä½œæ—¶ï¼Œä¼šæ¶‰åŠå¤§é‡çš„åå°„æ“ä½œã€‚Java ä¸­çš„åå°„è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯ä»£ç ç¼–å†™èµ·æ¥æ¯”è¾ƒå¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼Œä¸ºäº†ç®€åŒ–åå°„æ“ä½œçš„ç›¸å…³ä»£ç ï¼ŒMybatis æä¾›äº†ä¸“é—¨çš„åå°„æ¨¡å—ï¼Œè¯¥æ¨¡å—ä½äº <code>org.apache.ibatis.reflection</code> åŒ…ä¸­ï¼Œå®ƒå¯¹å¸¸è§çš„åå°„æ“ä½œåšäº†è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´åŠ ç®€æ´æ–¹ä¾¿çš„åå°„ APIã€‚</p>
<h4 id="Reflector-amp-ReflectorFactory"><a href="#Reflector-amp-ReflectorFactory" class="headerlink" title="Reflector &amp; ReflectorFactory"></a>Reflector &amp; ReflectorFactory</h4><p>Reflectoræ˜¯MyBatisä¸­åå°„æ¨¡å—çš„åŸºç¡€ï¼Œæ¯éš”Reflectorå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªç±»ï¼Œåœ¨Reflectorä¸­ç¼“å­˜äº†åå°„æ“ä½œéœ€è¦ä½¿ç”¨çš„ç´¯çš„å…ƒä¿¡æ¯ã€‚</p>
<p>Reflectorä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Private Class &lt;?&gt; type; <span class="comment">//å¯¹åº”çš„ C1 ass ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯è¯»å±æ€§çš„åç§°é›†åˆï¼Œå¯è¯»å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” getter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> String I readablepropertynames= EMPTY STRING ARRAY</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯å†™å±æ€§çš„åç§°é›†åˆï¼Œå¯å†™å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” setter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> String  [writeablepropertynames EMPTY STRING ARRAY;</span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ Invoker å¯¹è±¡ï¼Œå®ƒæ˜¯å¯¹ setter æ–¹æ³•å¯¹åº” </span></span><br><span class="line"><span class="comment">// Me thod å¯¹è±¡çš„å°è£…ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Invoker&gt; setmethods =<span class="keyword">new</span> Hashmap &lt;String, Invoker&gt;  ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å±æ€§ç›¸åº”çš„ getter æ–¹æ³•é›†åˆï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue ä¹Ÿæ˜¯ Invoker å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Invoker&gt; getmethods =<span class="keyword">new</span> Hashmap &lt;String, Invoker&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ setter æ–¹æ³•çš„å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Class &lt;?&gt;&gt; settypes =<span class="keyword">new</span> Hashmap &lt;string, Class &lt;?&gt;&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ </span></span><br><span class="line"><span class="keyword">private</span> Map &lt;string, Class &lt;?&gt;&gt; gettypes=<span class="keyword">new</span> Hashmap &lt;string, Class &lt;?&gt;&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Constructor &lt;?&gt; <span class="keyword">default</span> Constructor; <span class="comment">//è®°å½•äº†é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†æ‰€æœ‰å±æ€§åç§°çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;string, String&gt; caseinsensitivepropertymap-<span class="keyword">new</span> Hashmap &lt;String, String&gt; ();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨Reflectorçš„æ„é€ æ–¹æ³•ä¸­ä¼šè§£æåˆ¶å®šçš„Classå¯¹è±¡ï¼Œå¹¶å¡«å……ä¸Šè¿°é›†åˆã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reflector</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">  type = clazz; <span class="comment">// åˆå§‹åŒ–typeå­—æ®µ</span></span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾clazzçš„é»˜è®¤æ„é€ æ–¹æ³•ï¼Œå…·ä½“å®ç°æ˜¯é€šè¿‡åå°„éå†æ‰€æœ‰æ„é€ æ–¹æ³•</span></span><br><span class="line">  addDefaultConstructor(clazz);</span><br><span class="line">  addGetMethods(clazz); <span class="comment">// å¤„ç†clazzä¸­çš„getteræ–¹æ³•ï¼Œå¡«å……getMethodsé›†åˆå’ŒgetTypesé›†åˆ</span></span><br><span class="line">  addSetMethods(clazz); <span class="comment">// å¤„ç†clazzä¸­çš„setteræ–¹æ³•ï¼Œå¡«å……setMethodsé›†åˆå’ŒsetTypesé›†åˆ</span></span><br><span class="line">  addFields(clazz); <span class="comment">// å¤„ç†æ²¡æœ‰getter/setteræ–¹æ³•çš„å­—æ®µ</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®getMethods/setMethodsé›†åˆï¼Œåˆå§‹åŒ–å¯è¯»/å†™å±æ€§çš„åç§°é›†åˆ</span></span><br><span class="line">  readablePropertyNames = getMethods.keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">  writablePropertyNames = setMethods.keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–caseInsensitivePropertyMapé›†åˆï¼Œå…¶ä¸­è®°å½•äº†æ‰€æœ‰å¤§å†™æ ¼å¼çš„å±æ€§åç§°</span></span><br><span class="line">  <span class="keyword">for</span> (String propName : readablePropertyNames) &#123;</span><br><span class="line">    caseInsensitivePropertyMap.put(</span><br><span class="line">      propName.toUpperCase(Locale.ENGLISH), propName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (String propName : writablePropertyNames) &#123;</span><br><span class="line">    caseInsensitivePropertyMap.put(</span><br><span class="line">      propName.toUpperCase(Locale.ENGLISH), propName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Reflector.Addgetmethodso()</code>æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ <code>getter</code> æ–¹æ³•ï¼Œ<code>Reflector. addSetMethods()</code>æ–¹æ³•è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ <code>setter</code> æ–¹æ³•ï¼Œä¸¤è€…çš„é€»è¾‘ç±»ä¼¼ã€‚</p>
<p><code>Reflector. Addgetmethods()</code> æ–¹æ³•æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ã€‚</p>
<ol>
<li><p>é¦–å…ˆï¼Œè°ƒç”¨Reflector.getClassMethods()æ–¹æ³•è·å–å½“å‰ç±»åŠå…¶çˆ¶ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå“åº”çš„Methodå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Method[] getClassMethods(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">  <span class="comment">// ç”¨äºè®°å½•åˆ¶å®šç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå¯¹åº”çš„Methodå¯¹è±¡</span></span><br><span class="line">  Map&lt;String, Method&gt; uniqueMethods = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  Class&lt;?&gt; currentClass = clazz;</span><br><span class="line">  <span class="keyword">while</span> (currentClass != <span class="keyword">null</span> &amp;&amp; currentClass != Object.class) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•currentClassè¿™ä¸ªç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³•</span></span><br><span class="line">    addUniqueMethods(uniqueMethods, currentClass.getDeclaredMethods());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we also need to look for interface methods -</span></span><br><span class="line">    <span class="comment">// because the class may be abstract</span></span><br><span class="line">    <span class="comment">// è®°å½•æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•</span></span><br><span class="line">    Class&lt;?&gt;[] interfaces = currentClass.getInterfaces();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; anInterface : interfaces) &#123;</span><br><span class="line">      addUniqueMethods(uniqueMethods, anInterface.getMethods());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–çˆ¶ç±»ï¼Œç»§ç»­whileå¾ªç¯</span></span><br><span class="line">    currentClass = currentClass.getSuperclass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Collection&lt;Method&gt; methods = uniqueMethods.values();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]);<span class="comment">// è½¬æ¢æˆMethodsæ•°ç»„è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ç„¶åï¼ŒæŒ‰ç…§JavaBeançš„è§„èŒƒï¼Œä»Reflector.getClassMethods()æ–¹æ³•è¿”å›çš„Methodæ•°ç»„ä¸­æŸ¥æ‰¾è¯¥ç±»ä¸­å®šä¹‰çš„getteræ–¹æ³•ï¼Œå°†å…¶è®°å½•åˆ°<code>conflictingGetters</code>é›†åˆä¸­ã€‚<code>conflictingGetters</code>é›†åˆçš„keyä¸ºå±æ€§åç§°ï¼Œvalueæ˜¯è¯¥å±æ€§å¯¹åº”çš„getteræ–¹æ³•çš„é›†åˆã€‚</p>
</li>
<li><p>å½“å­ç±»è¦†ç›–äº†çˆ¶ç±»çš„getteræ–¹æ³•ä¸”è¿”å›å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨æ­¥éª¤1ä¸­å°±ä¼šäº§ç”Ÿä¸¤ä¸ªç­¾åä¸åŒçš„æ–¹æ³•ã€‚</p>
</li>
</ol>
<h4 id="TypeParameterResolver"><a href="#TypeParameterResolver" class="headerlink" title="TypeParameterResolver"></a>TypeParameterResolver</h4><p>åœ¨å¼€ å§‹ä»‹ç» TypeParameterResolverä¹‹å‰ï¼Œå…ˆç®€ å• ä»‹ç» ä¸€ä¸‹Typeæ¥å£çš„åŸºç¡€ çŸ¥è¯† ã€‚Typeæ˜¯æ‰€æœ‰ç±» å‹çš„çˆ¶æ¥å£ï¼Œå®ƒ æœ‰å››ä¸ª å­æ¥å£å’Œä¸€ä¸ª å® ç° ç±» ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/image-20200606160310736_88u4tj.png" alt="image-20200606160310736"></p>
<p>ä¸‹é¢æ¥ çœ‹è¿™ äº›å­æ¥å£å’Œå­ç±» æ‰€ä»£è¡¨çš„ç±» å‹ã€‚</p>
<ul>
<li><p><strong>Class</strong>æ¯”è¾ƒ å¸¸è§ ï¼Œå®ƒ è¡¨ç¤ºçš„æ˜¯åŸå§‹ç±» å‹ã€‚</p>
<p>Classç±» çš„å¯¹ è±¡è¡¨ç¤ºJVMä¸­çš„ä¸€ä¸ª ç±» æˆ–æ¥å£ï¼Œ æ¯ä¸ª Javaç±» åœ¨JVMé‡Œéƒ½è¡¨ç° ä¸º ä¸€ä¸ª Classå¯¹ è±¡ã€‚</p>
<p>åœ¨ç¨‹åºä¸­å¯ä»¥é€šè¿‡ â€œ<strong>ç±»å.class</strong>â€ã€â€œ**å¯¹è±¡.getClass()<strong>â€æˆ–æ˜¯â€œ</strong>Class.forName(â€œç±» åâ€)**â€ç­‰æ–¹å¼è· å–Classå¯¹ è±¡ã€‚</p>
<p>æ•° ç»„ ä¹Ÿè¢«æ˜ å°„ä¸º Classå¯¹ è±¡ï¼Œæ‰€æœ‰å…ƒç´ ç±» å‹ç›¸åŒä¸”ç»´ æ•° ç›¸åŒçš„æ•° ç»„ éƒ½å…±äº«åŒä¸€ä¸ª Classå¯¹ è±¡ã€‚</p>
</li>
<li><p><strong>ParameterizedType</strong> è¡¨ç¤ºçš„æ˜¯å‚ æ•° åŒ–ç±» å‹ï¼Œä¾‹å¦‚ List<string>ã€ Map&lt;Integerï¼ŒString&gt;ã€ Service<user>è¿™ ç§ å¸¦ æœ‰æ³›å‹çš„ç±» å‹ã€‚</user></string></p>
<p>ParameterizedTypeæ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯:</p>
<ul>
<li><code>Type getRawType()</code>â€”â€“è¿”å›å‚ æ•° åŒ–ç±» å‹ä¸­çš„åŸå§‹ç±» å‹ï¼Œä¾‹å¦‚List<strin>çš„åŸå§‹ç±» å‹ä¸º Listã€‚</strin></li>
<li><code>Type[] getActualTypeArguments()</code>â€”â€“è· å–å‚ æ•° åŒ–ç±» å‹çš„ç±» å‹å˜ é‡æˆ–æ˜¯å® é™… ç±» å‹åˆ— è¡¨ï¼Œä¾‹å¦‚Map&lt;Integerï¼ŒString&gt;çš„å® é™… æ³›å‹åˆ—è¡¨Integerå’Œ Stringã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ è¯¥ åˆ—è¡¨çš„å…ƒç´ ç±» å‹éƒ½æ˜¯Type,ä¹Ÿå°±æ˜¯è¯´ ï¼Œå¯èƒ½å­˜åœ¨å¤šå±‚ åµŒå¥—çš„æƒ…å†µ ã€‚</li>
<li><code>Type getOwnerType()</code>â€”â€“è¿”å›æ˜¯ç±» å‹æ‰€å± çš„ç±» å‹ï¼Œä¾‹å¦‚å­˜åœ¨A<t>ç±» ï¼Œå…¶ä¸­å®šä¹‰ äº† å†… éƒ¨ç±» InnerA<i>ï¼Œåˆ™ InnerA<i>å± çš„ç±» å‹ä¸º A<t>ï¼Œå¦‚æœæ˜¯é¡¶ å±‚ ç±» å‹åˆ™ è¿”å›nullã€‚ è¿™ ç§ å…³ ç³»æ¯”è¾ƒ å¸¸è§ çš„ç¤ºä¾‹æ˜¯Map&lt;Kï¼ŒV&gt;æ¥å£ä¸ Map.Entry&lt;Kï¼ŒV&gt;æ¥å£ï¼ŒMap&lt;Kï¼ŒV&gt; æ¥ å£ æ˜¯Map&lt;K,V&gt;æ¥å£çš„æ‰€æœ‰è€…ã€‚</t></i></i></t></li>
</ul>
</li>
<li><p><code>TypeVariable</code>è¡¨ç¤ºçš„æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ ç”¨æ¥ åæ˜ åœ¨JVMç¼– è¯‘ è¯¥ æ³›å‹å‰çš„ä¿¡æ¯ã€‚</p>
<p>ä¾‹å¦‚List<t> ä¸­çš„Tå°±æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ åœ¨ç¼– è¯‘ æ—¶ éœ€è¢«è½¬ æ¢ ä¸º ä¸€ä¸ª å…·ä½“ çš„ç±» å‹åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</t></p>
<p>è¯¥ æ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯:</p>
<ul>
<li><p><code>Type[] getBounds()</code>â€”â€“è· å–ç±» å‹å˜ é‡çš„ä¸Šè¾¹ ç•Œï¼Œå¦‚æœæœªæ˜ç¡® å£° æ˜ä¸Šè¾¹ ç•Œåˆ™ é»˜è®¤ ä¸º Objectã€‚ </p>
<p>ä¾‹å¦‚ class Test<k extends person>ä¸­ K çš„ä¸Šç•Œå°±æ˜¯ Personã€‚</k></p>
</li>
<li><p> <code>D getGenericDeclaration()</code>â€”â€“è· å–å£° æ˜è¯¥ ç±» å‹å˜ é‡çš„åŸå§‹ç±» å‹ï¼Œä¾‹ å¦‚ class Test<k extends person> ä¸­ çš„åŸå§‹ç±» å‹æ˜¯ Testã€‚</k></p>
</li>
<li><p><code>String getName()</code>â€” è· å–åœ¨æºç  ä¸­å®šä¹‰ æ—¶ çš„åå­—ï¼Œä¸Šä¾‹ä¸­ä¸º Kã€‚</p>
</li>
</ul>
</li>
<li><p><code>GenericArrayType</code> è¡¨ç¤ºçš„æ˜¯æ•° ç»„ ç±» å‹ä¸”ç»„ æˆå…ƒç´ æ˜¯ ParameterizedType æˆ– TypeVariableã€‚ </p>
<p>ä¾‹å¦‚ List<string>æˆ–T[]ã€‚è¯¥ æ¥å£åªæœ‰ Type getGenericComponentType()â€”ä¸ª æ–¹æ³•ï¼Œå®ƒ è¿”å›æ•° ç»„ çš„ç»„ æˆå…ƒç´ ã€‚</string></p>
</li>
<li><p><code>WildcardType</code> è¡¨ç¤ºçš„æ˜¯é€šé…ç¬¦æ³›å‹ï¼Œä¾‹å¦‚<code>? extends Number</code> å’Œ<code>? uper Integer</code>ã€‚</p>
<p>WildcardTypeæ¥å£æœ‰ä¸¤ ä¸ª æ–¹æ³•ï¼Œåˆ†åˆ« æ˜¯:</p>
<ul>
<li><code>Type[] getUpperBounds()</code>â€”-è¿”å›æ³›å‹å˜ é‡çš„ä¸Šç•Œã€‚ </li>
<li> <code>Type[] getLowerBounds()</code>â€”- è¿”å›æ³›å‹å˜ é‡çš„ä¸‹ç•Œã€‚</li>
</ul>
</li>
</ul>
<p> å›åˆ°å¯¹ <code>TypeParameterResolve</code>ï¼Œå®ƒ æ˜¯ä¸€ä¸ª å·¥å…·ç±» ï¼Œæä¾›äº†ä¸€ç³»åˆ—é™ æ€ æ–¹æ³•æ¥ è§£ææŒ‡å®šç±» ä¸­çš„å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ã€‚TypeParameterResolverä¸­å„ä¸ª é™ æ€ æ–¹æ³•ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¤§è‡´å¦‚ä¸‹å›¾ æ‰€ç¤ºï¼Œä¸º ä¿æŒæ¸… æ™° ï¼Œå…¶ä¸­é€’ å½’ è°ƒ ç”¨æ²¡ æœ‰è¡¨ç° å‡ºæ¥ ï¼Œåœ¨åé¢ çš„ä»£ç  åˆ†æè¿‡ ç¨‹ä¸­ä¼š è¿› è¡Œå¼ºè°ƒ ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/image-20200606162023961_yxCRz4.png" alt="image-20200606162023961"></p>
<p><code>TypeParameterResolver</code> ä¸­ é€š è¿‡ <code>resolveFieldType()</code>æ–¹ æ³• ã€ <code>resolveRetumType()</code>æ–¹ æ³• ã€ <code>resolveParamTypes()</code>æ–¹æ³•åˆ†åˆ« è§£æå­—æ®µç±» å‹ã€æ–¹æ³•è¿”å›å€¼ ç±» å‹å’Œæ–¹æ³•å‚ æ•° åˆ—è¡¨ä¸­å„ä¸ª å‚ æ•° çš„ç±» å‹ã€‚ è¿™ ä¸‰ä¸ª æ–¹æ³•çš„é€» è¾‘ åŸºæœ¬ç±» ä¼¼ï¼Œè¿™ é‡Œä»¥resolveFieldType()æ–¹æ³•ä¸º ä¾‹è¿› è¡Œä»‹ç» ï¼Œ<code>TypeParameterResolver.resolveFieldType()</code>æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The field type as &#123;<span class="doctag">@link</span> Type&#125;. If it has type parameters in the declaration,</span></span><br><span class="line"><span class="comment">   *         they will be resolved to the actual runtime &#123;<span class="doctag">@link</span> Type&#125;s.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Type <span class="title">resolveFieldType</span><span class="params">(Field field, Type srcType)</span> </span>&#123;</span><br><span class="line">  Type fieldType = field.getGenericType();</span><br><span class="line">  Class&lt;?&gt; declaringClass = field.getDeclaringClass();</span><br><span class="line">  <span class="keyword">return</span> resolveType(fieldType, srcType, declaringClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸‰ä¸ª æ–¹æ³•éƒ½ä¼š è°ƒ ç”¨<code>resolveType()</code>æ–¹æ³•ï¼Œè¯¥ æ–¹æ³•ä¼š æ ¹æ®å…¶ç¬¬ä¸€ä¸ª å‚ æ•° çš„ ç±» å‹ï¼Œå³ å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ï¼Œé€‰ æ‹© åˆé€‚çš„æ–¹æ³•è¿› è¡Œè§£æã€‚<code>resolveType()</code>æ–¹æ³•çš„ ç¬¬äºŒä¸ª å‚ æ•° è¡¨ç¤ºæŸ¥ æ‰¾ è¯¥ å­—æ®µã€è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„èµ·å§‹ä½ç½®ã€‚ç¬¬ä¸‰ä¸ª å‚ æ•° åˆ™ è¡¨ç¤ºè¯¥ å­—æ®µã€æ–¹æ³• å®šä¹‰ æ‰€åœ¨çš„ç±» ã€‚<code>TypeParameterResolver.resolveType()</code>æ–¹æ³•ä»£ç  å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Type <span class="title">resolveType</span><span class="params">(Type type, Type srcType, Class&lt;?&gt; declaringClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">    <span class="comment">// è§£æTypeVariableç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveTypeVar((TypeVariable&lt;?&gt;) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">    <span class="comment">// è§£æParameterizedTypeç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveParameterizedType((ParameterizedType) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType) &#123;</span><br><span class="line">    <span class="comment">// è§£ægenericArrayTypeç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveGenericArrayType((GenericArrayType) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> type; <span class="comment">// classç±»å‹</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å­—æ®µã€è¿”å›å€¼ ã€å‚ æ•° ä¸å¯èƒ½ç›´æ¥å®šä¹‰ æˆWildcardTypeç±» å‹ï¼Œä½†å¯ä»¥åµŒå¥—åœ¨åˆ« çš„ç±» å‹ä¸­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œé€šè¿‡ä¸€ä¸ªç¤ºä¾‹åˆ†æ<code>resolveType</code>æ–¹æ³•ï¼Œ å‡è®¾æœ‰ä¸‰ä¸ªç±» ClassAã€SubClassAã€TestTypeï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><code>ClassA</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassA</span> &lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123; </span><br><span class="line">  <span class="keyword">protected</span> Map&lt;K, V&gt; map;</span><br><span class="line">	<span class="comment">// â€¢â€¢â€¢ map çš„ getter/setter æ–¹ æ³• (ç•¥ )</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubClassA</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubClassA</span> &lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ClassA</span>&lt;<span class="title">T</span>,<span class="title">T</span>&gt; </span>&#123; </span><br><span class="line">  <span class="comment">// ...... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TestType</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  SubClassA&lt;Long&gt; sa = <span class="keyword">new</span> SubClassA();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">    Field f = ClassA.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    System.out.println(f.getGenericType());</span><br><span class="line">    System.out.println(f.getGenericType() <span class="keyword">instanceof</span> ParameterizedType);</span><br><span class="line">    <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">    <span class="comment">// java.util.Map&lt;K, V&gt;</span></span><br><span class="line">    <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æSubA&lt;Long&gt;(ParameterizedTypeç±» å‹)ä¸­çš„mapå­—æ®µï¼Œæ³¨æ„:ParameterizedTypelmplæ˜¯</span></span><br><span class="line">    <span class="comment">// åœ¨ sun.reflect.generics.reflectiveObjects åŒ…ä¸‹çš„ ParameterizedTypeæ¥å£å® ç°</span></span><br><span class="line"></span><br><span class="line">    Type type = TypeParameterResolver.resolveFieldType(</span><br><span class="line">      f, ParameterizedTypelmpl.make(SubClassA.class, </span><br><span class="line">                                    <span class="keyword">new</span> Type[]&#123;Long.class&#125;, TestType.class));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ç”Ÿæˆä¸Šè¿°ParameterizedTypeå¯¹ è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ è°ƒ ç”¨ TypeParameterResolver.resolveFieldType ()æ–¹ æ³• :</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// TypeParameterResolver.resolveFieldType(f,</span></span><br><span class="line">    <span class="comment">// TestType.class.getDeclaredField(&quot;sa&quot;).getGenericType());</span></span><br><span class="line">    System.out.println(type.getClass());</span><br><span class="line">    <span class="comment">// è¾“ å‡º :class TypeParameterResolver$ParameterizedTypelmpl</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼ŒTypeParameterResolver$ParameterizedTypeImplæ˜¯ParameterizedTypeæ¥å£çš„å® ç° </span></span><br><span class="line">    ParameterizedType p = (ParameterizedType) type; </span><br><span class="line">    System.out.println(p.getRawType());</span><br><span class="line">    <span class="comment">// è¾“ å‡º :interface java.util.Map</span></span><br><span class="line"></span><br><span class="line">    System.out.println(p.getOwnerType());</span><br><span class="line">    <span class="comment">// è¾“ å‡º:null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Type t : p .getActualTypeArguments()) &#123;</span><br><span class="line">      System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“ å‡º:</span></span><br><span class="line">    <span class="comment">// class java.lang.Long</span></span><br><span class="line">    <span class="comment">// class java.lang.Long</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å‰é¢çš„Typeæ¥å£çš„ä»‹ç»ï¼Œä¸Šä¾‹ä¸­ClassA.mapå­—æ®µå£°æ˜çš„ç±»å‹Map&lt;K,V&gt;æ˜¯ParamelerizedTypeç±»å‹ï¼ŒresolveType()æ–¹æ³•å›è°ƒç”¨resolvParameterizedType()æ–¹æ³•è¿›è¡Œè§£æã€‚</p>
<p>é¦–å…ˆä»‹ç»resolveParameterizedType()æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¾…è§£æçš„ParameterizedTypeç±»å‹</li>
<li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯è§£ææ“ä½œçš„èµ·å§‹ç±»å‹</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå®šä¹‰è¯¥å­—æ®µæˆ–æ–¹æ³•çš„ç±»çš„Classå¯¹è±¡</li>
</ul>
<p>åœ¨è¯¥ç¤ºä¾‹ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Map&lt;K,V&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeTest.SubA<long>å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰ç›¸åº”çš„Classå¯¹è±¡ã€‚</long></p>
<p><strong>ç»§ç»­åˆ†æ<code>scanSuperTypes()</code>æ–¹æ³•</strong>ï¼Œè¯¥æ–¹æ³•å›é€’å½’æ•´ä¸ªç»§æ‰¿ç»“æ„å¹¶å®Œæˆç±»å‹å˜é‡çš„è§£æã€‚åœ¨è¯¥ç¤ºä¾‹ä¹‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°Kå¯¹åº”çš„TypeVariableå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeText.SubA<long>å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰å¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯SubClassAå¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯Class&lt;T,T&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ã€‚</long></p>
<p><code>scanSuperTypes()</code>æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Type <span class="title">scanSuperTypes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TypeVariable&lt;?&gt; typeVar, Type srcType, </span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; declaringClass, Class&lt;?&gt; clazz, Type superclass)</span> </span>&#123;</span><br><span class="line">    Type result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (superclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">      ParameterizedType parentAsType = (ParameterizedType) superclass;</span><br><span class="line">      Class&lt;?&gt; parentAsClass = (Class&lt;?&gt;) parentAsType.getRawType();</span><br><span class="line">      <span class="keyword">if</span> (declaringClass == parentAsClass) &#123;</span><br><span class="line">        Type[] typeArgs = parentAsType.getActualTypeArguments();</span><br><span class="line">        TypeVariable&lt;?&gt;[] declaredTypeVars = </span><br><span class="line">          declaringClass.getTypeParameters();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; declaredTypeVars.length; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (declaredTypeVars[i] == typeVar) &#123;</span><br><span class="line">            <span class="keyword">if</span> (typeArgs[i] <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">              TypeVariable&lt;?&gt;[] typeParams = clazz.getTypeParameters();</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; typeParams.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (typeParams[j] == typeArgs[i]) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (srcType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                    result = ((ParameterizedType) srcType).getActualTypeArguments()[j];</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              result = typeArgs[i];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaringClass.isAssignableFrom(parentAsClass)) &#123;</span><br><span class="line">        result = resolveTypeVar(typeVar, parentAsType, declaringClass);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (superclass <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">      <span class="keyword">if</span> (declaringClass.isAssignableFrom((Class&lt;?&gt;) superclass)) &#123;</span><br><span class="line">        result = resolveTypeVar(typeVar, superclass, declaringClass);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹å›¾å±•ç¤ºäº†scanSuperTypes()æ–¹æ³•è§£æç±»å‹å˜é‡çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607094904927_ZT0Sxt.png" alt="image-20200607094904927"></p>
<h4 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h4><p>MyBatisä¸­å¾ˆå¤šæ¨¡å—ä¼šä½¿ç”¨åˆ°ObjectFactoryæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº†å¤šä¸ªcreate()æ–¹æ³•çš„é‡è½½ï¼Œé€šè¿‡è¿™äº›create()æ–¹æ³•å¯ä»¥åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚ObjectFactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets configuration properties.</span></span><br><span class="line"><span class="comment">   * è®¾ç½®é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> properties configuration properties</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a new object with default constructor. </span></span><br><span class="line"><span class="comment">   * é€šè¿‡æ— å‚æ„é€ å™¨åˆ›å»ºæŒ‡å®šç±»çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a new object with the specified constructor and params.</span></span><br><span class="line"><span class="comment">   * æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œä»æŒ‡å®šç±»å‹ä¸­é€‰æ‹©åˆé€‚çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> constructorArgTypes Constructor argument types</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> constructorArgs Constructor argument values</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns true if this object can have a set of other objects.</span></span><br><span class="line"><span class="comment">   * It&#x27;s main purpose is to support non-java.util.Collection objects like Scala collections.</span></span><br><span class="line"><span class="comment">   * æ£€æµ‹æŒ‡å®šç±»å‹æ˜¯å¦ä¸ºé›†åˆç±»å‹ï¼Œä¸»è¦å¤„ç†java.util.CollectiopnåŠå…¶å­ç±»</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> whether it is a collection or not</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 3.1.0</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DefaultObjectFactory</code>æ˜¯<code>MyBatis</code>æä¾›çš„<code>ObjectFactory</code>æ¥å£çš„å”¯ä¸€å® ç° ï¼Œå®ƒ æ˜¯ä¸€ä¸ª åå°„å·¥å‚ ï¼Œ å…¶ <code>create()</code>æ–¹æ³•é€šè¿‡ è°ƒ ç”¨ <code>instantiateClass()</code>æ–¹æ³•å® ç° ã€‚</p>
<p><code>DefaultObjectFactory.instantiateClass()</code>æ–¹æ³•ä¼š æ ¹æ®ä¼  å…¥çš„å‚ æ•° åˆ—è¡¨é€‰ æ‹© åˆé€‚çš„æ„ é€ å‡½æ•° å® ä¾‹åŒ–å¯¹ è±¡ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span>  &lt;T&gt; <span class="function">T <span class="title">instantiateClass</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;T&gt; constructor;</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes == <span class="keyword">null</span> || constructorArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        constructor = type.getDeclaredConstructor();</span><br><span class="line">        <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">          constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">      &#125;</span><br><span class="line">      constructor = type.getDeclaredConstructor(constructorArgTypes.toArray(<span class="keyword">new</span> Class[constructorArgTypes.size()]));</span><br><span class="line">      <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> constructor.newInstance(constructorArgs.toArray(<span class="keyword">new</span> Object[constructorArgs.size()]));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      StringBuilder argTypes = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; argType : constructorArgTypes) &#123;</span><br><span class="line">          argTypes.append(argType.getSimpleName());</span><br><span class="line">          argTypes.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argTypes.deleteCharAt(argTypes.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      StringBuilder argValues = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgs != <span class="keyword">null</span> &amp;&amp; !constructorArgs.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object argValue : constructorArgs) &#123;</span><br><span class="line">          argValues.append(String.valueOf(argValue));</span><br><span class="line">          argValues.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argValues.deleteCharAt(argValues.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">&quot;Error instantiating &quot;</span> + type + <span class="string">&quot; with invalid types (&quot;</span> + argTypes + <span class="string">&quot;) or values (&quot;</span> + argValues + <span class="string">&quot;). Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†ä½¿ç”¨MyBatisæä¾›çš„<code>DefaultObjectFactory</code>å®ç°ï¼Œè¿˜å¯ä»¥åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè‡ªå®šä¹‰çš„ObjectFactoryæ¥å£å®ç°ç´¯ï¼Œ ä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ã€‚</p>
<h4 id="Propertyå·¥å…·ç±»"><a href="#Propertyå·¥å…·ç±»" class="headerlink" title="Propertyå·¥å…·ç±»"></a>Propertyå·¥å…·ç±»</h4><p><code>org.apache.ibatis.reflection.property</code> åŒ…ä¸‹ï¼Œæä¾›äº† PropertyCopierã€PropertyNamerã€PropertyTokenizer ä¸‰ä¸ªå±æ€§ç›¸å…³çš„å·¥å…·ç±»ã€‚</p>
<p><strong>PropertyTokenizer</strong></p>
<p>åœ¨ä½¿ç”¨MyBatisçš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°ä¸€äº›å±æ€§è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼Œåœ¨æŸ¥è¯¢ç”¨æˆ·ï¼ˆUserï¼‰çš„è®¢å•ï¼ˆOrderï¼‰çš„ç»“æœé›†å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>user_name</th>
<th>order</th>
<th>item1</th>
<th>item2</th>
<th>â€¦</th>
</tr>
</thead>
<tbody><tr>
<td>Mary</td>
<td>124640</td>
<td>iPhone 8 plus</td>
<td>MacBook Pro</td>
<td>â€¦</td>
</tr>
<tr>
<td>Lisa</td>
<td>46546</td>
<td>iPhone 11 Pro</td>
<td>Mac Pro</td>
<td>â€¦</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p>å¯¹è±¡æ¨¡å‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607100948201_0zx3nS.png" alt="image-20200607100948201"></p>
<p>å‡è®¾ç°åœ¨éœ€è¦å°†ç»“æœé›†ä¸­çš„<code>item1</code>åˆ—é›¨ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•ï¼ˆOrderï¼‰çš„ç¬¬ä¸€æ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼Œ<code>item2</code>ä¸ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•çš„ï¼ˆOrderï¼‰çš„ç¬¬äºŒæ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼ˆè¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­å¾ˆå°‘è¿™æ ·çš„è®¾è®¡ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ˜ å°„è§„åˆ™ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;rm4testProTool&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orders[0].items[0].name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;iteml&quot;</span> /&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orders[0].items[1].name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;item2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>orders[0].items[0].name</code>è¿™ç§ç”±<code> .</code>å’Œ<code>[]</code>ç»„æˆçš„è¡¨è¾¾å¼æ˜¯ç”±<code>PropertyTokenizer</code>è¿›è¡Œè§£æçš„ã€‚ä»¥ä¸‹æ˜¯æ­¤ç±»çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyTokenizer</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">PropertyTokenizer</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// å½“å‰è¡¨è¾¾å¼çš„åç§°</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å½“å‰è¡¨è¾¾å¼çš„ç´¢å¼•å</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String indexedName;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç´¢å¼•ä¸‹æ ‡</span></span><br><span class="line">  <span class="keyword">private</span> String index;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å­è¡¨è¾¾å¼</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String children;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PropertyTokenizer</span><span class="params">(String fullname)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ . çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">int</span> delim = fullname.indexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ– name</span></span><br><span class="line">      name = fullname.substring(<span class="number">0</span>, delim);</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–children</span></span><br><span class="line">      children = fullname.substring(delim + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      name = fullname;</span><br><span class="line">      children = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–indexname</span></span><br><span class="line">    indexedName = name;</span><br><span class="line">    delim = name.indexOf(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–index</span></span><br><span class="line">      index = name.substring(delim + <span class="number">1</span>, name.length() - <span class="number">1</span>);</span><br><span class="line">      name = name.substring(<span class="number">0</span>, delim);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getIndexedName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> indexedName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> children != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nextæ–¹æ³•ä¸­ä¼šåˆ›å»ºPropertyTokenizerå¯¹è±¡å¹¶è§£æchildrenå­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PropertyTokenizer <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PropertyTokenizer(children);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Remove is not supported, as it has no meaning in the context of properties.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PropertyTokenizer</code>ç»§æ‰¿äº†<code>Iterator</code>æ¥å£ï¼Œå®ƒå¯ä»¥è¿­ä»£å¤„ç†åµŒå¥—å¤šå±‚è¡¨è¾¾å¼ã€‚</p>
<p><code>next()</code>æ–¹æ³•ä¸­ä¼šåˆ›å»º<code>PropertyTokenizer</code>å¯¹è±¡å¹¶è§£æ<code>children</code>å­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼ã€‚</p>
<p>ç»§ç»­ä½¿ç”¨è®¢å•ç¤ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæè¿°è§£æå±æ€§è¡¨è¾¾å¼<code>orders[0].items[0].name</code>çš„è¿­ä»£è¿‡ç¨‹ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607102830771_hVgxny.png" alt="image-20200607102830771"></p>
<p><strong>PropertyNamer</strong></p>
<p><code>PropertyNamer</code>æ˜¯å¦ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†ä¸‹åˆ—é™æ€æ–¹æ³•å¸®åŠ©å®Œæˆæ–¹æ³•ååˆ°å±æ€§åçš„è½¬æ¢ï¼Œä»¥åŠå¤šç§æ£€æµ‹æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyNamer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PropertyNamer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prevent Instantiation of Static Class</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†æ–¹æ³•åè½¬æ¢æˆå±æ€§å</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">methodToProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;is&quot;</span>)) &#123;</span><br><span class="line">      name = name.substring(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">      name = name.substring(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">&quot;Error parsing property name &#x27;&quot;</span> + name + <span class="string">&quot;&#x27;.  Didn&#x27;t start with &#x27;is&#x27;, &#x27;get&#x27; or &#x27;set&#x27;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name.length() == <span class="number">1</span> || (name.length() &gt; <span class="number">1</span> &amp;&amp; !Character.isUpperCase(name.charAt(<span class="number">1</span>)))) &#123;</span><br><span class="line">      name = name.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(Locale.ENGLISH) + name.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;set&quot;</span>) || name.startsWith(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isGetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;set&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>PropertyCopier</strong></p>
<p><code>PropertyCopier</code>æ˜¯ä¸€ä¸ªå±æ€§æ‹·è´çš„å·¥å…·ç±»ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<code>copyBeanProperties()</code>æ–¹æ³•ï¼Œä¸»è¦å®ç°ç›¸åŒç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å±æ€§å€¼æ‹·è´ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyCopier</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PropertyCopier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prevent Instantiation of Static Class</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyBeanProperties</span><span class="params">(Class&lt;?&gt; type, Object sourceBean, Object destinationBean)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; parent = type;</span><br><span class="line">    <span class="keyword">while</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Field[] fields = parent.getDeclaredFields();</span><br><span class="line">      <span class="keyword">for</span>(Field field : fields) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">          field.set(destinationBean, field.get(sourceBean));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">// Nothing useful to do, will only fail on final fields, which will be ignored.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç»§ç»­æ‹·è´çˆ¶ç±»ä¸­å®šä¹‰çš„å­—æ®µ</span></span><br><span class="line">      parent = parent.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MetaClass"><a href="#MetaClass" class="headerlink" title="MetaClass"></a>MetaClass</h4><p><code>org.apache.ibatis.reflection.MetaClass</code> ï¼Œç±»çš„å…ƒæ•°æ®ï¼ŒåŸºäº Reflector å’Œ PropertyTokenizer ï¼Œæä¾›å¯¹æŒ‡å®šç±»çš„å„ç§éªšæ“ä½œã€‚å®ç°äº†å¯¹å¤æ‚çš„å±æ€§è¡¨è¾¾å¼çš„è§£æï¼Œå¹¶å®ç°äº†è·å–æŒ‡å®šå±æ€§æè¿°ä¿¡æ¯çš„åŠŸèƒ½ã€‚</p>
<p>ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºç¼“å­˜Reflectorå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory reflectorFactory;</span><br><span class="line">  <span class="comment">// åˆ›å»ºMetaClassæ—¶ä¼šæŒ‡å®šä¸€ä¸ªç±»ï¼Œè¯¥Reflectorå¯¹è±¡ä¼šç”¨äºè®°å½•è¯¥ç±»ç›¸å…³çš„å…ƒä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Reflector reflector;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MetaClassçš„æ„é€ æ–¹æ³•æ˜¯ä½¿ç”¨privateä¿®é¥°çš„</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MetaClass</span><span class="params">(Class&lt;?&gt; type, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.reflectorFactory = reflectorFactory;</span><br><span class="line">    <span class="comment">// åˆ›å»ºReflectorå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">this</span>.reflector = reflectorFactory.findForClass(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºMetaClasså¯¹è±¡</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MetaClass <span class="title">forClass</span><span class="params">(Class&lt;?&gt; type, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MetaClass(type, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MetaClass <span class="title">metaClassForProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; propType = reflector.getGetterType(name);</span><br><span class="line">    <span class="keyword">return</span> MetaClass.forClass(propType, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å§”æ‰˜ç»™buildProperty()æ–¹æ³•å®ç°</span></span><br><span class="line">    StringBuilder prop = buildProperty(name, <span class="keyword">new</span> StringBuilder());</span><br><span class="line">    <span class="keyword">return</span> prop.length() &gt; <span class="number">0</span> ? prop.toString() : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findProperty</span><span class="params">(String name, <span class="keyword">boolean</span> useCamelCaseMapping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (useCamelCaseMapping) &#123;</span><br><span class="line">      name = name.replace(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> findProperty(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getGetterNames() &#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getGetablePropertyNames();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getSetterNames() &#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getSetablePropertyNames();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      MetaClass metaProp = metaClassForProperty(prop.getName());</span><br><span class="line">      <span class="keyword">return</span> metaProp.getSetterType(prop.getChildren());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.getSetterType(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      MetaClass metaProp = metaClassForProperty(prop);</span><br><span class="line">      <span class="keyword">return</span> metaProp.getGetterType(prop.getChildren());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// issue #506. Resolve the type inside a Collection Object</span></span><br><span class="line">    <span class="keyword">return</span> getGetterType(prop);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> MetaClass <span class="title">metaClassForProperty</span><span class="params">(PropertyTokenizer prop)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; propType = getGetterType(prop);</span><br><span class="line">    <span class="keyword">return</span> MetaClass.forClass(propType, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; getGetterType(PropertyTokenizer prop) &#123;</span><br><span class="line">    Class&lt;?&gt; type = reflector.getGetterType(prop.getName());</span><br><span class="line">    <span class="keyword">if</span> (prop.getIndex() != <span class="keyword">null</span> &amp;&amp; Collection.class.isAssignableFrom(type)) &#123;</span><br><span class="line">      Type returnType = getGenericGetterType(prop.getName());</span><br><span class="line">      <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type[] actualTypeArguments = ((ParameterizedType) returnType).getActualTypeArguments();</span><br><span class="line">        <span class="keyword">if</span> (actualTypeArguments != <span class="keyword">null</span> &amp;&amp; actualTypeArguments.length == <span class="number">1</span>) &#123;</span><br><span class="line">          returnType = actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            type = (Class&lt;?&gt;) returnType;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            type = (Class&lt;?&gt;) ((ParameterizedType) returnType).getRawType();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Type <span class="title">getGenericGetterType</span><span class="params">(String propertyName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Invoker invoker = reflector.getGetInvoker(propertyName);</span><br><span class="line">      <span class="keyword">if</span> (invoker <span class="keyword">instanceof</span> MethodInvoker) &#123;</span><br><span class="line">        Field _method = MethodInvoker.class.getDeclaredField(<span class="string">&quot;method&quot;</span>);</span><br><span class="line">        _method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Method method = (Method) _method.get(invoker);</span><br><span class="line">        <span class="keyword">return</span> TypeParameterResolver.resolveReturnType(method, reflector.getType());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (invoker <span class="keyword">instanceof</span> GetFieldInvoker) &#123;</span><br><span class="line">        Field _field = GetFieldInvoker.class.getDeclaredField(<span class="string">&quot;field&quot;</span>);</span><br><span class="line">        _field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Field field = (Field) _field.get(invoker);</span><br><span class="line">        <span class="keyword">return</span> TypeParameterResolver.resolveFieldType(field, reflector.getType());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (reflector.hasSetter(prop.getName())) &#123;</span><br><span class="line">        MetaClass metaProp = metaClassForProperty(prop.getName());</span><br><span class="line">        <span class="keyword">return</span> metaProp.hasSetter(prop.getChildren());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.hasSetter(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æŒ‡å®šå±æ€§æ˜¯å¦æœ‰ getting æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasGetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (reflector.hasGetter(prop.getName())) &#123;</span><br><span class="line">        MetaClass metaProp = metaClassForProperty(prop);</span><br><span class="line">        <span class="keyword">return</span> metaProp.hasGetter(prop.getChildren());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.hasGetter(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Invoker <span class="title">getGetInvoker</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getGetInvoker(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Invoker <span class="title">getSetInvoker</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getSetInvoker(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> StringBuilder <span class="title">buildProperty</span><span class="params">(String name, StringBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è§£æå±æ€§è¡¨è¾¾å¼</span></span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123; <span class="comment">// æ˜¯å¦è¿˜æœ‰å­è¡¨è¾¾å¼</span></span><br><span class="line">      <span class="comment">// æŸ¥æ‰¾Propertytokenizer.nameå¯¹åº”çš„å±æ€§</span></span><br><span class="line">      String propertyName = reflector.findPropertyName(prop.getName());</span><br><span class="line">      <span class="keyword">if</span> (propertyName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.append(propertyName);</span><br><span class="line">        builder.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸ºè¯¥å±æ€§åˆ›å»ºå¯¹åº”çš„MetaClasså¯¹è±¡</span></span><br><span class="line">        MetaClass metaProp = metaClassForProperty(propertyName);</span><br><span class="line">        <span class="comment">// é€’å½’è§£æchildrenå­—æ®µï¼Œå°†è§£æç»“æœæ·»åŠ åˆ°builderä¸­ä¿å­˜</span></span><br><span class="line">        metaProp.buildProperty(prop.getChildren(), builder);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// é€’å½’å‡ºå£</span></span><br><span class="line">      String propertyName = reflector.findPropertyName(name);</span><br><span class="line">      <span class="keyword">if</span> (propertyName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.append(propertyName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasDefaultConstructor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.hasDefaultConstructor();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MetaClassä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯findProperty()ï¼Œå®ƒæ˜¯é€šè¿‡è°ƒç”¨MetaClass.buildProperty()æ–¹æ³•å®ç°çš„ï¼Œ äºŒbuildProperty()æ–¹æ³•ä¼šé€šè¿‡PropertyTokenizerè§£æå¤æ‚çš„å±æ€§è¡¨è¾¾å¼</strong></li>
</ul>
<h4 id="ObjectWrapper"><a href="#ObjectWrapper" class="headerlink" title="ObjectWrapper"></a>ObjectWrapper</h4><p><code>MetaClass</code>æ˜¯Mybatiså¯¹ç±»çº§åˆ«çš„å…ƒä¿¡æ¯çš„å°è£…å’Œå¤„ç†ï¼Œä¸‹é¢æ¥çœ‹MyBatiså¯¹å¯¹è±¡çº§åˆ«çš„å…ƒä¿¡æ¯çš„å¤„ç†ã€‚<code>ObjectWrapper</code>æ¥å£æ˜¯å¯¹å¯¹è±¡çš„åŒ…è£…ï¼ŒæŠ½è±¡äº†å¯¹è±¡çš„å±æ€§ä¿¡æ¯ï¼Œå®ƒå®šä¹‰äº†ä¸€ç³»åˆ—æŸ¥è¯¢å¯¹è±¡å±æ€§ä¿¡æ¯çš„æ–¹æ³•ï¼Œä»¥åŠæ›´æ–°å±æ€§çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”å±æ€§çš„ç›¸åº”getteræ–¹æ³•ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è·å–æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼</span></span><br><span class="line">  <span class="function">Object <span class="title">get</span><span class="params">(PropertyTokenizer prop)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”çš„setteræ–¹æ³•</span></span><br><span class="line">  <span class="comment">// å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è®¾ç½®æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(PropertyTokenizer prop, Object value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾å±æ€§è¡¨è¾¾å¼æŒ‡å®šçš„å±æ€§ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦å¿½ç•¥å±æ€§è¡¨è¾¾å¼ä¸­çš„ä¸‹åˆ’çº¿</span></span><br><span class="line">  <span class="function">String <span class="title">findProperty</span><span class="params">(String name, <span class="keyword">boolean</span> useCamelCaseMapping)</span></span>;</span><br><span class="line"></span><br><span class="line">  String[] getGetterNames();</span><br><span class="line"></span><br><span class="line">  String[] getSetterNames();</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; getSetterType(String name);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; getGetterType(String name);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">hasSetter</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">hasGetter</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸ºå±æ€§è¡¨è¾¾å¼çš„å±æ€§åˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡</span></span><br><span class="line">  <span class="function">MetaObject <span class="title">instantiatePropertyValue</span><span class="params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Object element)</span></span>;</span><br><span class="line">  </span><br><span class="line">  &lt;E&gt; <span class="function"><span class="keyword">void</span> <span class="title">addAll</span><span class="params">(List&lt;E&gt; element)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ObjectWrapperFactoryè´Ÿè´£åˆ›å»ºObjectWrapperå¯¹è±¡ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607105809062_CxBOIT.png" alt="image-20200607105809062"></p>
<p><code>DefaultObjectWrapperFactory</code>å® ç° äº† <code>ObjectWrapperFactory</code>æ¥å£ï¼Œä½†å®ƒ å® ç° çš„ <code>getWrapperFor()</code> æ–¹æ³•å§‹ç»ˆ æŠ›å‡ºå¼‚ å¸¸ï¼Œ<code>hasWrapperFor()</code>æ–¹æ³•å§‹ç»ˆ è¿”å›falseï¼Œæ‰€ä»¥è¯¥ å® ç° å® é™… ä¸Šæ˜¯ä¸å¯ç”¨çš„ã€‚ä½†æ˜¯ ä¸ ObjectFactory ç±» ä¼¼ï¼Œæˆ‘ä»¬ å¯ä»¥åœ¨ mybatis-config.xml ä¸­é…ç½®è‡ªå®šä¹‰ çš„ ObjectWrapperFactory å® ç° ç±» è¿› è¡Œæ‰© å±•ï¼Œåœ¨åé¢ä»‹ç» MyBatisåˆå§‹åŒ–æ—¶ è¿˜ ä¼š æåˆ°è¯¥ æ‰© å±•ç‚¹ã€‚</p>
<p><code>BaseWrapper</code>æ˜¯ä¸€ä¸ªå®ç°äº†<code>ObjectWrapper</code>æ¥å£çš„æŠ½è±¡ç±»ï¼Œå…¶ä¸­å°è£…äº†<code>MetaObject</code>å¯¹è±¡ï¼Œå¹¶æä¾›äº†ä¸‰ä¸ªæ–¹å‹‡çš„æ–¹æ³•æä¾›å…¶å­ç±»ä½¿ç”¨ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607110710849_oIM782.png" alt="image-20200607110710849"></p>
<p>BaseWrapper,resolveCollection()æ–¹æ³•ä¼š è°ƒ ç”¨ MetaObject.get Value()æ–¹æ³•ï¼Œå®ƒ ä¼š è§£æå± æ€§è¡¨è¾¾ å¼å¹¶ è· å–æŒ‡å®šçš„å± æ€§ã€‚</p>
<p>BaseWrapper.getCollectionValue()æ–¹æ³•å’Œ setCollectionValue()æ–¹æ³•ä¼š è§£æå± æ€§è¡¨è¾¾ å¼çš„ç´¢å¼• ä¿¡æ¯ï¼Œç„¶åè· å–/è®¾ ç½®å¯¹ åº” é¡¹ ã€‚</p>
<h4 id="MetaObject"><a href="#MetaObject" class="headerlink" title="MetaObject"></a>MetaObject</h4><p><code>org.apache.ibatis.reflection.MetaObject</code> ï¼Œå¯¹è±¡å…ƒæ•°æ®ï¼Œæä¾›äº†å¯¹è±¡çš„å±æ€§å€¼çš„è·å¾—å’Œè®¾ç½®ç­‰ç­‰æ–¹æ³•ã€‚ å¯ä»¥ç†è§£æˆï¼Œå¯¹ BaseWrapper æ“ä½œçš„è¿›ä¸€æ­¥<strong>å¢å¼º</strong>ã€‚</p>
<blockquote>
<p>ObjectWrapperæä¾›äº†è·å–/è®¾ç½®å¯¹è±¡ä¸­æŒ‡å®šçš„å±æ€§å€¼ã€æ£€æµ‹getter/setterç­‰å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ˜¯ObjectWrapperåªæ˜¯è¿™äº›åŠŸèƒ½çš„æœ€åä¸€ç«™ï¼Œæˆ‘ä»¬çœç•¥äº†å¯¹å±æ€§è¡¨è¾¾å¼è§£æè¿‡ç¨‹çš„ä»‹ç»ï¼Œè€Œè¯¥è§£æè¿‡ç¨‹æ˜¯åœ¨MetaObjectä¸­å®ç°çš„ã€‚</p>
</blockquote>
<p><strong>MetaObject</strong>ä¸­å­—æ®µçš„å«ä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹JavaBeanå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object originalObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šæ–‡ä»‹ç»çš„ObjectWrapperå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†originalObjectå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectWrapper objectWrapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£å®ä¾‹åŒ–originalObjectçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectFactory objectFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£åˆ›å»ºObjectWrapperçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectWrapperFactory objectWrapperFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºåˆ›å»ºå¹¶ç¼“å­˜Reflectorå¯¹è±¡çš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory reflectorFactory;</span><br></pre></td></tr></table></figure>

<p><strong>MetaObjectçš„æ„é€ æ–¹æ³•</strong>ä¼šæ ¹æ®ä¼ å…¥çš„åŸå§‹å¯¹è±¡çš„ç±»å‹ä»¥åŠObjectFactoryå·¥å‚çš„å®ç°ï¼Œ åˆ›å»ºç›¸åº”çš„ObjectWrapperå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">MetaObject</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.originalObject = object;</span><br><span class="line">    <span class="keyword">this</span>.objectFactory = objectFactory;</span><br><span class="line">    <span class="keyword">this</span>.objectWrapperFactory = objectWrapperFactory;</span><br><span class="line">    <span class="keyword">this</span>.reflectorFactory = reflectorFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> ObjectWrapper) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = (ObjectWrapper) object;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objectWrapperFactory.hasWrapperFor(object)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = objectWrapperFactory.getWrapperFor(<span class="keyword">this</span>, object);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> MapWrapper(<span class="keyword">this</span>, (Map) object);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> CollectionWrapper(<span class="keyword">this</span>, (Collection) object);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> BeanWrapper(<span class="keyword">this</span>, object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>MetaObjectå’ŒObjectWrapperä¸­å…³äºç±»çº§åˆ«çš„æ–¹æ³•ï¼Œä¾‹å¦‚hasGetter()ã€hasSetter()ã€findProperty()ç­‰æ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨MetaClassçš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</p>
<p>å…¶ä»–æ–¹æ³•éƒ½æ˜¯å…³äºå¯¹è±¡çº§åˆ«çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ä¸ObjectWrapperé…åˆå®ç°ï¼Œä¾‹å¦‚MetaObject.getValue()/setValue()æ–¹æ³•ã€‚</p>
<p>ä»¥ä¸‹æ˜¯getValue()çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="comment">// æ ¹æ®PropertyTokenizerè§£æåæŒ‡å®šçš„å±æ€§ï¼Œåˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡</span></span><br><span class="line">      MetaObject metaValue = metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">      <span class="keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> metaValue.getValue(prop.getChildren());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> objectWrapper.get(prop);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h3><p>JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨PreparedStatementä¸ºSQLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œéœ€è¦ä»Javaç±»å‹è½¬æ¢æˆJDBCç±»å‹ï¼Œè€Œä»ç»“æœé›†è·å–æ•°æ®çš„æ—¶å€™ï¼Œåˆ™éœ€è¦ä»JDBCç±»å‹è½¬æ¢æˆJavaç±»å‹ã€‚</p>
<p>MyBatisä½¿ç”¨ç±»å‹è½¬æ¢å¤„ç†å™¨å®Œè½¦è¿‡äº†ä¸Šè¿°ä¸¤ç§è½¬æ¢ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607224820211_lIdG1a.png" alt="image-20200607224820211"></p>
<blockquote>
<p>åœ¨ MyBatisä¸­ä½¿ç”¨JdbcTypeè¿™ ä¸ª æšä¸¾ ç±» å‹ä»£è¡¨JDBCä¸­çš„æ•° æ®ç±» å‹ï¼Œè¯¥ æšä¸¾ ç±» å‹ä¸­å®šä¹‰ äº† TYPE_CODEå­—æ®µï¼Œè®° å½• äº† JDBCç±» å‹åœ¨java.sql.Typesä¸­ç›¸åº” çš„å¸¸é‡ ç¼– ç  ï¼Œå¹¶ é€šè¿‡ ä¸€ä¸ª é™ æ€ é›†åˆcodeLookup (HashMap&lt;Integerï¼ŒJdbcType&gt;ç±» å‹)ç»´ æŠ¤ äº†å¸¸é‡ç¼– ç  ä¸JdbcTypeä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p>
</blockquote>
<h4 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h4><p>MyBatisä¸­æ‰€æœ‰çš„ç±» å‹è½¬ æ¢ å™¨éƒ½ç»§ æ‰¿äº† TypeHandleræ¥å£ï¼Œåœ¨ TypeHandleræ¥å£ä¸­å®šä¹‰ äº†å¦‚ ä¸‹å››ä¸ª æ–¹æ³•ï¼Œè¿™ å››ä¸ª æ–¹æ³•åˆ†ä¸º ä¸¤ ç±» :setParameter()æ–¹æ³•è´Ÿ è´£ å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJava ç±» å‹:<code>getResult()</code>æ–¹æ³•åŠå…¶é‡è½½ è´Ÿ è´£ å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åœ¨é€šè¿‡ PreparedStatementä¸º SQLè¯­ å¥ç»‘ å®šå‚ æ•° æ—¶ ï¼Œä¼š å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJavaç±» å‹</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//ä» ResultSetä¸­è· å–æ•° æ®æ—¶ ä¼š è°ƒ ç”¨æ­¤æ–¹æ³•ï¼Œä¼š å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹</span></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰TypeHandlerå®ç°ï¼ŒMyBatisæä¾›äº†BaseTypeHandlerè¿™ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†TypeHandleræ¥å£ï¼Œå¹¶ç»§æ‰¿äº†TypeReferenceæŠ½è±¡ç±»ï¼Œå…¶ç»§æ‰¿ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607225857225_4Xvffn.png" alt="image-20200607225857225"></p>
<p>åœ¨BaseTypeHandlerä¸­å®ç°äº†<code>TypeHandler.setParameter()</code>æ–¹æ³•å’Œ<code>TypeHandler.getResult()</code>æ–¹æ³•ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å¯¹äºéç©ºæ•°æ®çš„å¤„ç†éƒ½äº¤ç»™äº†å­ç±»å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TypeReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfiguration</span><span class="params">(Configuration c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.configuration = c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (jdbcType == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;JDBC requires that the JdbcType must be specified for all nullable parameters.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        ps.setNull(i, jdbcType.TYPE_CODE);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;Error setting null for parameter #&quot;</span> + i + <span class="string">&quot; with JdbcType &quot;</span> + jdbcType + <span class="string">&quot; . &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Cause: &quot;</span> + e, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        setNonNullParameter(ps, i, parameter, jdbcType);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;Error setting non null for parameter #&quot;</span> + i + <span class="string">&quot; with JdbcType &quot;</span> + jdbcType + <span class="string">&quot; . &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Try setting a different JdbcType for this parameter or a different configuration property. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Cause: &quot;</span> + e, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(rs, columnName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column &#x27;&quot;</span> + columnName + <span class="string">&quot;&#x27; from result set.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(rs, columnIndex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column #&quot;</span> + columnIndex+ <span class="string">&quot; from result set.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(cs, columnIndex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column #&quot;</span> + columnIndex+ <span class="string">&quot; from callable statement.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ TypeHandlerç”¨äºå®Œæˆå•ä¸ªå‚æ•°ä»¥åŠå•ä¸ªåˆ—å€¼çš„ç±»å‹è½¬æ¢ï¼Œ å¦‚æœå­˜åœ¨å¤šåˆ—å€¼è½¬æ¢æˆä¸€ä¸ªJavaå¯¹è±¡çš„éœ€æ±‚ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘åœ¨ä½¿ç”¨æ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰åˆé€‚çš„æ˜ å°„è§„åˆ™ï¼ˆ<resultmap>ï¼‰å®Œæˆæ˜ å°„ã€‚</resultmap></p>
<h4 id="TypeHandlerRegistry"><a href="#TypeHandlerRegistry" class="headerlink" title="TypeHandlerRegistry"></a>TypeHandlerRegistry</h4><p>ä»‹ç»å®ŒTypeHandleræ¥å£åŠå…¶åŠŸèƒ½ä¹‹åï¼ŒMyBatiså¦‚ä½•ç®¡ç†ä¼—å¤šçš„TypeHanlderæ¥å£å®ç°ï¼Œå¦‚ä½•çŸ¥é“ä½•æ—¶ä½¿ç”¨å“ªä¸ªTypeHandleræ¥å£å®ç°å®Œæˆè½¬æ¢å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªå·¥ä½œæ˜¯ç”±TypeHandlerRegistryå®Œæˆçš„ï¼Œåœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šä¸ºæ‰€æœ‰å·²çŸ¥çš„TypeHanlderåˆ›å»ºå¯¹è±¡ï¼Œå¹¶å®ç°æ³¨å†Œåˆ°TypeHandlerRegistryä¸­ï¼Œ ç”±TypeHandlerRegistryè´Ÿè´£ç®¡ç†è¿™äº›TypeHandlerå¯¹è±¡ã€‚</p>
<p><strong>TypeHandlerRegistry</strong>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•JdbcTypeä¸TypeHandlerä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­JdbcTypeæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå®šä¹‰å¯¹åº”çš„JDBCç±»å‹</span></span><br><span class="line"><span class="comment">// è¯¥é›†åˆä¸»è¦ç”¨äºä»ç»“æœé›†è¯»å–æ•°æ®æ—¶ï¼Œå°†æ•°æ®ä»Jdbcç±»å‹è½¬æ¢æˆJavaç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = </span><br><span class="line">  <span class="keyword">new</span> EnumMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•äº†Javaç±»å‹å‘æŒ‡å®šJdbcTypeè½¬æ¢æ—¶ï¼Œéœ€è¦ä½¿ç”¨çš„TypeHandlerå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚Javaç±»å‹ä¸­çš„Stringå¯èƒ½è½¬æ¢æˆæ•°æ®åº“çš„charã€varcharç­‰å¤šç§ç±»å‹ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = </span><br><span class="line">  <span class="keyword">new</span> ConcurrentHashMap&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•äº†å…¨éƒ¨TypeHandlerçš„ç±»å‹ä»¥åŠè¯¥ç±»å‹ç›¸åº”çš„TypeHandlerå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeHandler&lt;Object&gt; UNKNOWN_TYPE_HANDLER = </span><br><span class="line">  <span class="keyword">new</span> UnknownTypeHandler(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©ºTypeHandleré›†åˆçš„æ ‡è¯†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; ALL_TYPE_HANDLERS_MAP = </span><br><span class="line">  <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>1. æ³¨å†ŒTypeHandlerå¯¹è±¡</strong></p>
<p>TypeHandlerRegistry.register()æ–¹æ³•å® ç° äº†æ³¨å†Œ TypeHandlerå¯¹ è±¡çš„åŠŸèƒ½ï¼Œè¯¥ æ³¨å†Œ è¿‡ ç¨‹ä¼š å‘ä¸Š è¿°å››ä¸ª é›†åˆä¸­æ·»åŠ TypeHandlerå¯¹ è±¡ã€‚register()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡è½½ ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¦‚å›¾ ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607231443963_Zd5zVS.png" alt="image-20200607231443963"></p>
<p>ä» ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤šæ•° register()æ–¹æ³•æœ€ç»ˆ ä¼š è°ƒ ç”¨é‡è½½(4) å®Œæˆæ³¨å†Œ åŠŸèƒ½ï¼Œå…ˆæ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ï¼Œå…¶ä¸‰ä¸ª å‚ æ•° åˆ†åˆ« æŒ‡å®šäº† TypeHandlerèƒ½å¤Ÿ å¤„ ç†çš„Javaç±» å‹ã€Jdbcç±» å‹ä»¥åŠ TypeHandlerå¯¹ è±¡ã€‚</p>
<p>é‡è½½(4)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (javaType != <span class="keyword">null</span>) &#123;<span class="comment">// æ£€æµ‹æ˜¯å¦æ˜ç¡®æŒ‡å®šäº†TypeHanlderèƒ½å¤Ÿå¤„ç†çš„Javaç±»å‹</span></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šjavaç±»å‹åœ¨TYPE_HANDLER_MAPé›†åˆä¸­å¯¹åº”TypeHanlderé›†åˆ</span></span><br><span class="line">    Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; map = TYPE_HANDLER_MAP.get(javaType);</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span> || map == NULL_TYPE_HANDLER_MAP) &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæ–°çš„TypeHandleré›†åˆï¼Œå¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­</span></span><br><span class="line">      map = <span class="keyword">new</span> HashMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;();</span><br><span class="line">      TYPE_HANDLER_MAP.put(javaType, map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†TypeHandlerå¯¹è±¡æ³¨å†Œåˆ°å¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­</span></span><br><span class="line">    map.put(jdbcType, handler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å‘ALL_TYPE_HANDLERS_MAPé›†åˆæ³¨å†ŒTypeHandlerç±»å‹å’Œå¯¹åº”çš„TypeHanlderå¯¹è±¡</span></span><br><span class="line">  ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨(1)ã€œ(3)è¿™ ä¸‰ä¸ª <code>register()</code>æ–¹æ³•é‡è½½ ä¸­ä¼š å° è¯• è¯» å–<code>TypeHandler</code>ç±» ä¸­å®šä¹‰ çš„<code>@MappedTypes</code> æ³¨è§£å’Œ<code>@MappedJdbcTypes</code>æ³¨è§£ï¼Œ<code>@MappedTypes</code>æ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ <code>TypeHandler</code>å® ç° ç±» èƒ½å¤Ÿ å¤„ ç† çš„Javaç±» å‹çš„é›†åˆï¼Œ<code>@MappedJdbcTypes</code>æ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ <code>TypeHandler</code>å® ç° ç±» èƒ½å¤Ÿ å¤„ ç†çš„JDBC ç±» å‹é›†åˆã€‚<code>register()</code>æ–¹æ³•çš„é‡è½½(1)ã€œ(3)çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p>
<p>é‡è½½(1)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Only handler type</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">  MappedTypes mappedTypes = typeHandlerClass.getAnnotation(MappedTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; javaTypeClass : mappedTypes.value()) &#123;</span><br><span class="line">      register(javaTypeClass, typeHandlerClass);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">    register(getInstance(<span class="keyword">null</span>, typeHandlerClass));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡è½½(2)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(TypeHandler&lt;T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">  MappedTypes mappedTypes = typeHandler.getClass().getAnnotation(MappedTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; handledType : mappedTypes.value()) &#123;</span><br><span class="line">      register(handledType, typeHandler);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// @since 3.1.0 - try to auto-discover the mapped type</span></span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound &amp;&amp; typeHandler <span class="keyword">instanceof</span> TypeReference) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      TypeReference&lt;T&gt; typeReference = (TypeReference&lt;T&gt;) typeHandler;</span><br><span class="line">      register(typeReference.getRawType(), typeHandler);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="comment">// maybe users define the TypeReference with a different type and are not assignable, so just ignore it</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">    register((Class&lt;T&gt;) <span class="keyword">null</span>, typeHandler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡è½½(3)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">  MappedJdbcTypes mappedJdbcTypes = typeHandler.getClass().getAnnotation(MappedJdbcTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedJdbcTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (JdbcType handledJdbcType : mappedJdbcTypes.value()) &#123;</span><br><span class="line">      register(javaType, handledJdbcType, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mappedJdbcTypes.includeNullJdbcType()) &#123;</span><br><span class="line">      register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Š è¿° å…¨ éƒ¨ çš„ <code>register()</code>æ–¹ æ³• é‡ è½½ éƒ½ æ˜¯ åœ¨ å‘ <code>TYPE_HANDLER_MAP</code>é›† åˆ å’Œ <code>ALL_TYPE_HANDLERS_MAP</code> é›†åˆæ³¨å†Œ <code>TypeHandler</code> å¯¹ è±¡ï¼Œè€Œé‡è½½(5)æ˜¯å‘ <code>JDBC_TYPE_HANDLER_MAP</code> é›†åˆæ³¨å†Œ <code>TypeHandler</code>å¯¹ è±¡ï¼Œå…¶å…·ä½“ å® ç° å¦‚ä¸‹:</p>
<p>é‡è½½(5)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">  JDBC_TYPE_HANDLER_MAP.put(jdbcType, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TypeHandlerRegistry</code>é™¤äº†æä¾›æ³¨å†Œ å• ä¸ª <code>TypeHandlerçš„register()</code>é‡è½½ ï¼Œè¿˜ å¯ä»¥æ‰« ææ•´ä¸ª åŒ…ä¸‹ çš„<code>TypeHandler</code>æ¥å£å® ç° ç±» ï¼Œå¹¶ å°† å®Œæˆè¿™ äº›<code>TypeHandler</code>å® ç° ç±» çš„æ³¨å†Œ ã€‚</p>
<p>é‡è½½(6)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">  ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„æ¥å£å®ç°ç±»</span></span><br><span class="line">  resolverUtil.find(<span class="keyword">new</span> ResolverUtil.IsA(TypeHandler.class), packageName);</span><br><span class="line">  Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; handlerSet = resolverUtil.getClasses();</span><br><span class="line">  <span class="keyword">for</span> (Class&lt;?&gt; type : handlerSet) &#123;</span><br><span class="line">    <span class="comment">//Ignore inner classes and interfaces (including package-info.java) and abstract classes</span></span><br><span class="line">    <span class="keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) &#123;</span><br><span class="line">      register(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. æŸ¥æ‰¾TypeHandler</strong></p>
<p><code>TypeHandlerRegistry</code>æä¾›äº†æŸ¥ æ‰¾ <code>TypeHandler</code>å¯¹ è±¡çš„åŠŸèƒ½ã€‚<code>TypeHandlerRegistry.getTypeHandler()</code>æ–¹æ³•å® ç° äº†ä» ä¸Šè¿°å››ä¸ª é›†åˆä¸­è· å–å¯¹ åº” <code>TypeHandler</code>å¯¹ è±¡çš„åŠŸèƒ½ã€‚TypeHandlerRegistry.getTypeHandler()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡ è½½ ä¹‹é—´ çš„å…³ ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608163219733_jqTbhc.png" alt="image-20200608163219733"></p>
<p>ç» è¿‡ ä¸€ç³»åˆ—ç±» å‹è½¬ æ¢ ä¹‹åï¼Œ<code>TypeHandlerRegistry.getTypeHandler()</code>æ–¹æ³•çš„å¤šä¸ª é‡è½½ éƒ½ä¼š è°ƒ ç”¨ <code>TypeHandlerRegistry.getTypeHandle(Type, JdbcType)</code>è¿™ ä¸ª é‡è½½ æ–¹æ³•ï¼Œå®ƒ ä¼š æ ¹æ®æŒ‡å®šçš„ Java ç±» å‹å’Œ JdbcTypeç±» å‹æŸ¥ æ‰¾ ç›¸åº” çš„TypeHandlerå¯¹ è±¡ã€‚</p>
<h4 id="TypeAliasRegistry"><a href="#TypeAliasRegistry" class="headerlink" title="TypeAliasRegistry"></a>TypeAliasRegistry</h4><p>åœ¨ç¼– å†™ SQLè¯­ å¥æ—¶ ï¼Œä½¿ç”¨åˆ« åå¯ä»¥æ–¹ä¾¿ç†è§£ä»¥åŠç»´ æŠ¤ ï¼Œä¾‹å¦‚è¡¨åæˆ–åˆ—åå¾ˆ é•¿ æ—¶ ï¼Œæˆ‘ä»¬ ä¸€èˆ¬ ä¼š ä¸º å…¶è®¾ è®¡ æ˜“æ‡‚ æ˜“ç»´ æŠ¤ çš„åˆ« åã€‚MyBatiså°† SQLè¯­ å¥ä¸­åˆ« åçš„æ¦‚ å¿µè¿› è¡Œäº†å»¶ä¼¸å’Œæ‰© å±•ï¼ŒMyBatis å¯ä»¥ä¸º ä¸€ä¸ª ç±» æ·»åŠ ä¸€ä¸ª åˆ« åï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡ åˆ« åå¼•ç”¨è¯¥ ç±» ã€‚</p>
<p><code>MyBatis</code>é€šè¿‡ <code>TypeAliasRegistry</code>ç±» å®Œæˆåˆ« åæ³¨å†Œ å’Œç®¡ç†çš„åŠŸèƒ½ï¼Œ<code>TypeAliasRegistry</code>çš„ç»“ æ„ æ¯” è¾ƒ ç®€ å• ï¼Œå®ƒ é€šè¿‡ <code>TYPE_ALIASES</code>å­—æ®µ(<code>Map&lt;Stringï¼ŒClass&lt;?&gt;&gt;</code>ç±» å‹)ç®¡ç†åˆ« åä¸ Javaç±» å‹ä¹‹é—´ çš„å¯¹ åº” å…³ ç³»ï¼Œé€šè¿‡ <code>TypeAHasRegistiy.registerAlias()</code>æ–¹æ³•å®Œæˆæ³¨å†Œ åˆ« åï¼Œè¯¥ æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, Class&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (alias == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;The parameter alias cannot be null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†åˆ«åè½¬æ¢æˆå°å†™</span></span><br><span class="line">  String key = alias.toLowerCase(Locale.ENGLISH);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ£€æµ‹åˆ«åæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (TYPE_ALIASES.containsKey(key) </span><br><span class="line">      &amp;&amp; TYPE_ALIASES.get(key) != <span class="keyword">null</span> </span><br><span class="line">      &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  TYPE_ALIASES.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨ <code>TypeAliasRegistry</code>çš„æ„ é€ æ–¹æ³•ä¸­ï¼Œé»˜è®¤ ä¸º Javaçš„åŸºæœ¬ç±» å‹åŠå…¶æ•° ç»„ ç±» å‹ã€åŸºæœ¬ç±» å‹çš„å° è£… ç±» åŠå…¶æ•°ç»„ç±»å‹ã€Dateã€BigDecimalã€Biglntegerã€Mapã€HashMapã€Listã€ArrayListã€Collectionã€ Iteratorã€ResultSetç­‰ç±» å‹æ·»åŠ äº†åˆ«åã€‚</p>
</blockquote>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
<li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">ğŸ³Antä¸¶</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.cayzlh.com/2019/10/25/899df03d.html">https://www.cayzlh.com/2019/10/25/899df03d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.cayzlh.com">BLOG | CAYZLH</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/MyBatis/">MyBatis</a><a class="post-meta__tags" href="/blog/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><a class="post-meta__tags" href="/blog/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/">åŸºç¡€æ”¯æŒå±‚</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2019/10/26/899df03d.html"><i class="fa fa-chevron-left">  </i><span>åŸºç¡€æ”¯æŒå±‚â€”â€”æ—¥å¿—æ¨¡å—</span></a></div><div class="next-post pull-right"><a href="/blog/2019/10/24/94150c5.html"><span>åŸºç¡€æ”¯æŒå±‚â€”â€”è§£æå™¨æ¨¡å—</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="footer_custom_text">hitokoto</div><div class="copyright">ğŸ³Antä¸¶ &copy;2019 - 2021</div><div class="icp"><a><span>ç²¤ICPå¤‡20058712å·</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.9.0"></script><script src="/blog/js/fancybox.js?version=1.9.0"></script><script src="/blog/js/sidebar.js?version=1.9.0"></script><script src="/blog/js/copy.js?version=1.9.0"></script><script src="/blog/js/fireworks.js?version=1.9.0"></script><script src="/blog/js/transition.js?version=1.9.0"></script><script src="/blog/js/scroll.js?version=1.9.0"></script><script src="/blog/js/head.js?version=1.9.0"></script><script src="/blog/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>