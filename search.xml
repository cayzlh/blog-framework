<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SpringBootå•å…ƒæµ‹è¯•</title>
      <link href="/blog/2021/03/12/1832342668.html"/>
      <url>/blog/2021/03/12/1832342668.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€-å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ"><a href="#ä¸€ã€-å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ" class="headerlink" title="ä¸€ã€ å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ"></a>ä¸€ã€ å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ</h2><h3 id="æ¦‚å¿µï¼š"><a href="#æ¦‚å¿µï¼š" class="headerlink" title="æ¦‚å¿µï¼š"></a><strong>æ¦‚å¿µï¼š</strong></h3><ol><li>å•å…ƒæµ‹è¯•ï¼ˆunit testingï¼‰ï¼Œæ˜¯æŒ‡å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ã€‚åœ¨Javaä¸­å•å…ƒæµ‹è¯•çš„æœ€å°å•å…ƒæ˜¯ç±»ã€‚</li><li>å•å…ƒæµ‹è¯•æ˜¯å¼€å‘è€…ç¼–å†™çš„ä¸€å°æ®µä»£ç ï¼Œç”¨äºæ£€éªŒè¢«æµ‹ä»£ç çš„ä¸€ä¸ªå¾ˆå°çš„ã€å¾ˆæ˜ç¡®çš„åŠŸèƒ½æ˜¯å¦æ­£ç¡®ã€‚æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå°±æ˜¯ä¸ºäº†è¯æ˜è¿™ æ®µä»£ç çš„è¡Œä¸ºå’Œæˆ‘ä»¬æœŸæœ›æ˜¯å¦ä¸€è‡´ã€‚</li></ol><h3 id="å•å…ƒæµ‹è¯•å¼•ç”¨ï¼š"><a href="#å•å…ƒæµ‹è¯•å¼•ç”¨ï¼š" class="headerlink" title="å•å…ƒæµ‹è¯•å¼•ç”¨ï¼š"></a><strong>å•å…ƒæµ‹è¯•å¼•ç”¨ï¼š</strong></h3><ol><li>ä¼—æ‰€å‘¨çŸ¥ï¼Œé€šè¿‡spring initializeåˆ›å»ºçš„Spring Booté¡¹ç›®ä¼šåœ¨Mavenä¸­è‡ªåŠ¨æºå¸¦å¾ˆå¤šstarterä¾èµ–ï¼š</li></ol><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044716155290871615529087504.jpg" alt="å›¾ç‰‡"></p><p>å…¶ä¸­åŒ…å«äº†ä¸€ä¸ªåä¸º<code>spring-boot-starter-test</code>çš„ä¾èµ–ï¼Œæœ¬æ–‡æ˜¯å›´ç»•è¿™ä¸ªä¾èµ–å±•å¼€ã€‚</p><ol><li>Spring Bootä¸­å¼•å…¥å•å…ƒæµ‹è¯•å¾ˆç®€å•ï¼Œæ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼ˆå³<code>spring-boot-starter-test</code>ä¾èµ–ï¼‰ï¼š</li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><ol><li>spring-boot-starter-testæœ‰å¦‚ä¸‹å‡ ä¸ªåº“ï¼š</li></ol><p><code>spring-boot-starter-test</code>UMLå›¾ï¼š</p><p><img src="https://7.dusays.com/2021/03/12/208e02005c0b7.png" alt="image-20210312142854430"></p><p><img src="https://7.dusays.com/2021/03/12/23696982579aa.png" alt="image-20210312142907488"></p><h2 id="äºŒã€å•å…ƒæµ‹è¯•çš„ä½œç”¨"><a href="#äºŒã€å•å…ƒæµ‹è¯•çš„ä½œç”¨" class="headerlink" title="äºŒã€å•å…ƒæµ‹è¯•çš„ä½œç”¨"></a>äºŒã€å•å…ƒæµ‹è¯•çš„ä½œç”¨</h2><p>åœ¨æ²¡æœ‰æ¥è§¦å•å…ƒæµ‹è¯•ä¹‹å‰æˆ‘ä»¬æ˜¯æ€ä¹ˆåšæµ‹è¯•çš„ï¼Ÿä¸€èˆ¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044716155290871615529087678.jpg" alt="å›¾ç‰‡"></p><p>åœ¨æ—¶é—´å…è®¸çš„æƒ…å†µä¸‹ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ˜¯ç¨‹åºå‘˜å¯¹ä»£ç çš„è‡ªæµ‹ï¼Œè¿™æ˜¯å¯¹è‡ªå·±ä»£ç çš„è´Ÿè´£ã€‚</p><h3 id="å†™å•å…ƒæµ‹è¯•çš„ä¸¤ä¸ªåŠ¨æœºï¼š"><a href="#å†™å•å…ƒæµ‹è¯•çš„ä¸¤ä¸ªåŠ¨æœºï¼š" class="headerlink" title="å†™å•å…ƒæµ‹è¯•çš„ä¸¤ä¸ªåŠ¨æœºï¼š"></a><strong>å†™å•å…ƒæµ‹è¯•çš„ä¸¤ä¸ªåŠ¨æœºï¼š</strong></h3><ol><li>ä¿è¯æˆ–éªŒè¯å®ç°åŠŸèƒ½ã€‚</li><li>ä¿æŠ¤å·²ç»å®ç°çš„åŠŸèƒ½ä¸è¢«ç ´åã€‚</li></ol><h2 id="ä¸‰ã€Spring-Bootå¼•å…¥çš„MockMvcçš„æ¦‚å¿µ"><a href="#ä¸‰ã€Spring-Bootå¼•å…¥çš„MockMvcçš„æ¦‚å¿µ" class="headerlink" title="ä¸‰ã€Spring Bootå¼•å…¥çš„MockMvcçš„æ¦‚å¿µ"></a>ä¸‰ã€Spring Bootå¼•å…¥çš„MockMvcçš„æ¦‚å¿µ</h2><ol><li>ä»€ä¹ˆæ˜¯Mock?</li></ol><p>åœ¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œæ¨¡æ‹Ÿå¯¹è±¡ï¼ˆè‹±è¯­ï¼šmock objectï¼‰æ˜¯ä»¥å¯æ§çš„æ–¹å¼æ¨¡æ‹ŸçœŸå®å¯¹è±¡è¡Œä¸ºçš„å‡å¯¹è±¡ã€‚åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸é€šè¿‡æ¨¡æ‹Ÿä¸€äº›è¾“å…¥æ•°æ®ï¼Œæ¥éªŒè¯ç¨‹åºæ˜¯å¦è¾¾åˆ°é¢„æœŸç»“æœã€‚</p><ol><li>ä¸ºä»€ä¹ˆä½¿ç”¨Mockå¯¹è±¡ï¼Ÿ</li></ol><p>ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤æ‚çš„ã€çœŸå®çš„å¯¹è±¡è¡Œä¸ºã€‚å¦‚æœåœ¨å•å…ƒæµ‹è¯•ä¸­æ— æ³•ä½¿ç”¨çœŸå®å¯¹è±¡ï¼Œå¯é‡‡ç”¨æ¨¡æ‹Ÿå¯¹è±¡è¿›è¡Œæ›¿ä»£ã€‚</p><ol><li>MockMvcçš„æ¦‚å¿µ</li></ol><p>MockMvcæ˜¯ç”±spring-teståŒ…æä¾›ï¼Œå®ç°äº†å¯¹Httpè¯·æ±‚çš„æ¨¡æ‹Ÿï¼Œèƒ½å¤Ÿç›´æ¥ä½¿ç”¨ç½‘ç»œçš„å½¢å¼ï¼Œè½¬æ¢åˆ°Controllerçš„è°ƒç”¨ï¼Œä½¿å¾—æµ‹è¯•é€Ÿåº¦å¿«ã€ä¸ä¾èµ–ç½‘ç»œç¯å¢ƒã€‚åŒæ—¶æä¾›äº†ä¸€å¥—éªŒè¯çš„å·¥å…·ï¼Œç»“æœçš„éªŒè¯ååˆ†æ–¹ä¾¿ã€‚</p><p>æ¥å£MockMvcBuilderï¼Œæä¾›ä¸€ä¸ªå”¯ä¸€çš„buildæ–¹æ³•ï¼Œç”¨æ¥æ„é€ MockMvcã€‚ä¸»è¦æœ‰ä¸¤ä¸ªå®ç°ï¼šStandaloneMockMvcBuilderå’ŒDefaultMockMvcBuilderã€‚</p><p><img src="https://7.dusays.com/2021/03/12/8ca41b998aaab.png" alt="image-20210312142923082"></p><ol><li>MockMVCçš„åŸºæœ¬æ­¥éª¤</li></ol><p>(1) mockMvc.performæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ã€‚(2) MockMvcRequestBuilders.get(â€œXXXâ€)æ„é€ ä¸€ä¸ªè¯·æ±‚ã€‚(3) ResultActions.paramæ·»åŠ è¯·æ±‚ä¼ å€¼ (4) ResultActions.accept()è®¾ç½®è¿”å›ç±»å‹ (5) ResultActions.andExpectæ·»åŠ æ‰§è¡Œå®Œæˆåçš„æ–­è¨€ã€‚(6) ResultActions.andDoæ·»åŠ ä¸€ä¸ªç»“æœå¤„ç†å™¨ï¼Œè¡¨ç¤ºè¦å¯¹ç»“æœåšç‚¹ä»€ä¹ˆäº‹æƒ…ï¼Œæ¯”å¦‚å¤„ä½¿ç”¨print()è¾“å‡ºæ•´ä¸ªå“åº”ç»“æœä¿¡æ¯ã€‚(7) ResultActions.andReturnè¡¨ç¤ºæ‰§è¡Œå®Œæˆåè¿”å›ç›¸åº”çš„ç»“æœã€‚</p><h2 id="å››ã€Serviceå±‚çš„å•å…ƒæµ‹è¯•"><a href="#å››ã€Serviceå±‚çš„å•å…ƒæµ‹è¯•" class="headerlink" title="å››ã€Serviceå±‚çš„å•å…ƒæµ‹è¯•"></a>å››ã€Serviceå±‚çš„å•å…ƒæµ‹è¯•</h2><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong> Spring Bootä¸­å•å…ƒæµ‹è¯•ç±»å†™åœ¨src/test/javaç›®å½•ä¸‹ï¼Œä½ å¯ä»¥æ‰‹åŠ¨åˆ›å»ºå…·ä½“æµ‹è¯•ç±»ï¼Œä¹Ÿå¯ä»¥é€šè¿‡IDEAè‡ªåŠ¨åˆ›å»ºæµ‹è¯•ç±»ï¼Œå¦‚ä¸‹å›¾ï¼šï¼ˆæ³¨ï¼šç‚¹é€‰å¹¶æ‰“å¼€ç›¸åº”ä»£ç ç•Œé¢ï¼Œå†ç‚¹å‡»èœå•æ çš„Navigateï¼‰</p><p><img src="https://7.dusays.com/2021/03/12/b9128a7d66811.png" alt="image-20210312140744322"></p><p><strong>ç¬¬äºŒæ­¥ï¼š</strong> æŒ‰ç…§ç¬¬ä¸€æ­¥çš„æ–¹æ³•ï¼Œç‚¹å‡»æµ‹è¯•åï¼Œå‡ºç°<strong>å›¾ä¸€</strong> çš„å¯¹è¯æ¡†ï¼ˆå¦‚æœæƒ³è¦æµ‹è¯•çš„ç±»å·²ç»å­˜åœ¨æµ‹è¯•ç±»äº†ä¼šè¢«åˆ—å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•ç±»ï¼‰ï¼Œç‚¹å‡»â€Create New Testâ€¦â€ä¼šå¼¹å‡º<strong>å›¾äºŒ</strong> çš„å¯¹è¯æ¡†ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ç”ŸæˆsetUpä»¥åŠè¦æµ‹è¯•çš„æˆå‘˜æ–¹æ³•ç­‰ï¼š</p><p>å›¾ä¸€</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044716155290871615529087979.jpg" alt="å›¾ç‰‡"></p><p>å›¾äºŒ</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044816155290881615529088115.jpg" alt="å›¾ç‰‡"></p><p><strong>ç¬¬ä¸‰æ­¥ï¼š</strong> è‡³æ­¤Serviceå±‚çš„æµ‹è¯•ç±»å°±åˆ›å»ºå¥½äº†ï¼Œæµ‹è¯•ç±»è‡ªåŠ¨ç”Ÿæˆåˆ°äº†src/test/javaç›®å½•ä¸‹<strong>é¡¹ç›®çš„åŒçº§ç›®å½•ä¸­</strong> ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044816155290881615529088185.jpg" alt="å›¾ç‰‡"></p><p>Serviceå±‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">public class XXXServiceTest &#123;</span><br><span class="line">@Resource</span><br><span class="line">private XXXService XXXService;</span><br><span class="line">@Test</span><br><span class="line">public void conflictTime() &#123;</span><br><span class="line">        DateTimeFormatter dtf &#x3D; DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        LocalDate start &#x3D; LocalDate.parse(&quot;2020-10-26&quot;, dtf);</span><br><span class="line">        LocalDate end &#x3D; LocalDate.parse(&quot;2020-10-31&quot;, dtf);</span><br><span class="line">        Integer integer &#x3D; XXXService.ConflictTime(&quot;10000001&quot;, start, end);</span><br><span class="line">        Assert.assertThat(integer, Matchers.notNullValue());&#x2F;&#x2F;assertThatæ–­è¨€åé¢ä»‹ç»</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨è§£è§£é‡Šï¼š</strong></p><p><code>@SpringBootTest</code>ï¼šè·å–å¯åŠ¨ç±»ï¼ŒåŠ è½½é…ç½®ï¼Œå¯»æ‰¾ä¸»é…ç½®å¯åŠ¨ç±»ï¼ˆè¢« @SpringBootApplication æ³¨è§£çš„ï¼‰ <code>@RunWith(SpringRunner.class)</code>ï¼šè®©JUnitè¿è¡ŒSpringçš„æµ‹è¯•ç¯å¢ƒ,è·å¾—Springç¯å¢ƒçš„ä¸Šä¸‹æ–‡çš„æ”¯æŒ</p><h2 id="äº”ã€Controllerå±‚çš„å•å…ƒæµ‹è¯•"><a href="#äº”ã€Controllerå±‚çš„å•å…ƒæµ‹è¯•" class="headerlink" title="äº”ã€Controllerå±‚çš„å•å…ƒæµ‹è¯•"></a>äº”ã€Controllerå±‚çš„å•å…ƒæµ‹è¯•</h2><p>åˆ›å»ºæµ‹è¯•ç±»æ­¥éª¤è§ç¬¬å››éƒ¨åˆ†ï¼Œæ­¤å¤„ç•¥ã€‚</p><p>ç¬¬å››éƒ¨åˆ†åªæ˜¯é’ˆå¯¹Serviceå±‚åšäº†æµ‹è¯•ï¼Œä½†æ˜¯å’±ä¹ˆä¹Ÿéœ€è¦å¯¹Controllerå±‚ï¼ˆAPIï¼‰åšæµ‹è¯•ï¼Œè¿™æ—¶å€™å°±ç”¨åˆ°MockMvcäº†ï¼Œå®ƒä½¿å¾—ä½ æ— éœ€å¯åŠ¨é¡¹ç›®å·¥ç¨‹å°±èƒ½æµ‹è¯•è¿™äº›æ¥å£</p><p>MockMvcå®ç°äº†å¯¹Httpè¯·æ±‚çš„æ¨¡æ‹Ÿï¼Œèƒ½å¤Ÿç›´æ¥ä½¿ç”¨ç½‘ç»œçš„å½¢å¼ï¼Œè½¬æ¢åˆ°Controllerçš„è°ƒç”¨ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æµ‹è¯•é€Ÿåº¦å¿«ã€ä¸ä¾èµ–ç½‘ç»œç¯å¢ƒï¼Œè€Œä¸”æä¾›äº†ä¸€å¥—éªŒè¯çš„å·¥å…·ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—è¯·æ±‚çš„éªŒè¯ç»Ÿä¸€è€Œä¸”å¾ˆæ–¹ä¾¿ã€‚</p><p>Controllerå±‚éƒ¨åˆ†çš„ä»£ç å°†åˆ†ä¸ºä¸‰ä¸ªä»£ç å—è®²è§£ï¼Œé‡Œé¢æœ‰çœ‹ä¸æ‡‚çš„ä»£ç å…ˆä¸è¦ç€æ€¥å“¦ğŸ˜„ï¼Œä¼šåœ¨ç¬¬äº”éƒ¨åˆ†ç»“å°¾å¤„ç»™å¤§å®¶æ±‡æ€»è§£ç­”çš„ï¼Œå¤§å®¶è¦åšæŒçœ‹åˆ°æœ€åå“Ÿï¼ğŸ˜</p><p><strong>ä»£ç å—ä¸€ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@AutoConfigureMockMvc</span><br><span class="line">public class DfTaskRecordControllerTest &#123;</span><br><span class="line">@Autowired</span><br><span class="line">private MockMvc mockMvc;</span><br><span class="line">@Before</span><br><span class="line">public void setUp() throws Exception &#123;</span><br><span class="line">       System.out.println(&quot;---------------start---------------&quot;);</span><br><span class="line">       save();</span><br><span class="line">get();</span><br><span class="line">       System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨è§£è§£é‡Šï¼š</strong></p><p><code>@SpringBootTest</code>&gt;ï¼šè·å–å¯åŠ¨ç±»ï¼ŒåŠ è½½é…ç½®ï¼Œå¯»æ‰¾ä¸»é…ç½®å¯åŠ¨ç±»ï¼ˆè¢« @SpringBootApplication æ³¨è§£çš„ï¼‰</p><p><code>@RunWith(SpringRunner.class)</code>&gt;ï¼šè®©JUnitè¿è¡ŒSpringçš„æµ‹è¯•ç¯å¢ƒ,è·å¾—Springç¯å¢ƒçš„ä¸Šä¸‹æ–‡çš„æ”¯æŒ <code>@AutoConfigureMockMvc</code>ï¼šç”¨äºè‡ªåŠ¨é…ç½®MockMvc,é…ç½®åMockMvcç±»å¯ä»¥ç›´æ¥æ³¨å…¥,ç›¸å½“äºnew MockMvc <code>@Before</code>:åˆå§‹åŒ–æ–¹æ³• ,å¯¹äºæ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•éƒ½è¦æ‰§è¡Œä¸€æ¬¡</p><p><strong>ä»£ç å—äºŒï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">@Transactional</span><br><span class="line">@Rollback()</span><br><span class="line">public void save() throws Exception &#123;</span><br><span class="line">        String json&quot;&#123;â€¦â€¦&#125;&quot;;</span><br><span class="line">&#x2F;&#x2F;æ‰§è¡Œä¸€ä¸ªRequestBuilderè¯·æ±‚ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒSpringMVCçš„æµç¨‹å¹¶æ˜ å°„åˆ°ç›¸åº”çš„æ§åˆ¶å™¨æ‰§è¡Œå¤„ç†ï¼›</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders</span><br><span class="line">                .post(&quot;&#x2F;XXX&#x2F;save&quot;)</span><br><span class="line">                .content(json.getBytes()) &#x2F;&#x2F;ä¼ jsonå‚æ•°</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">                .header(&quot;Authorization&quot;,&quot;Bearer ********-****-****-****-************&quot;)</span><br><span class="line">        )</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andDo(print());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨è§£è§£é‡Šï¼š</strong></p><p><code>@Transactional</code>:å¼€å¯äº‹åŠ¡åŠŸèƒ½</p><p><code>@Rollback()</code>: äº‹åŠ¡å›æ»š,é»˜è®¤æ˜¯true</p><p><strong>ä»£ç å—ä¸‰ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void get() throws Exception&#123;</span><br><span class="line">        ResultActions resultActions &#x3D; mockMvc.perform(MockMvcRequestBuilders</span><br><span class="line">                .get(&quot;&#x2F;XXX&#x2F;get&quot;)</span><br><span class="line">                .param(&quot;id&quot;, &quot;**********&quot;)</span><br><span class="line">                .header(&quot;Authorization&quot;, &quot;Bearer ********-****-****-****-************&quot;)</span><br><span class="line">        );</span><br><span class="line">        resultActions.andReturn().getResponse().setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        resultActions.andExpect(MockMvcResultMatchers.status().isOk()).andDo(print());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>/get</code>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044816155290881615529088275.jpg" alt="å›¾ç‰‡"></p><p><strong>ç°åœ¨å°†ä¸Šé¢çš„ä¸€äº›çç¢çš„çŸ¥è¯†ç‚¹æ±‡æ€»ä¸€ä¸‹ï¼š</strong></p><p><code>1. mockMvc.perform</code>ï¼šæ‰§è¡Œä¸€ä¸ªè¯·æ±‚</p><p><code>2. MockMvcRequestBuilders.get(â€œ/XXX/getâ€)</code>ï¼šæ„é€ ä¸€ä¸ªè¯·æ±‚ï¼ŒPostè¯·æ±‚ä½¿ç”¨.postæ–¹æ³•</p><p><code>3. contentType(MediaType.APPLICATION_JSON_VALUE)</code>ï¼šä»£è¡¨å‘é€ç«¯å‘é€çš„æ•°æ®æ ¼å¼æ˜¯application/json;charset=UTF-8</p><p><code>4. accept(MediaType.APPLICATION_JSON)</code>ï¼šä»£è¡¨å®¢æˆ·ç«¯å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹ä¸ºapplication/json;charset=UTF-8</p><p><code>5. header(â€œAuthorizationâ€,â€œBearer XXXXâ€)</code>ï¼šä»£è¡¨åœ¨æŠ¥æ–‡å¤´æ·»åŠ ä¸€äº›å¿…é¡»çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯token</p><p><code>6. ResultActions.andExpect</code>ï¼šæ·»åŠ æ‰§è¡Œå®Œæˆåçš„æ–­è¨€</p><p><code>7. ResultActions.andExpect(MockMvcResultMatchers.status().isOk())</code>ï¼šæ–¹æ³•çœ‹è¯·æ±‚çš„çŠ¶æ€å“åº”ç æ˜¯å¦ä¸º200å¦‚æœä¸æ˜¯åˆ™æŠ›å¼‚å¸¸ï¼Œæµ‹è¯•ä¸é€šè¿‡</p><p><code>8. ResultActions.andDo</code>ï¼šæ·»åŠ ä¸€ä¸ªç»“æœå¤„ç†å™¨ï¼Œè¡¨ç¤ºè¦å¯¹ç»“æœåšç‚¹ä»€ä¹ˆäº‹æƒ…ï¼Œæ¯”å¦‚æ­¤å¤„ä½¿ç”¨print()ï¼šè¾“å‡ºæ•´ä¸ªå“åº”ç»“æœä¿¡æ¯</p><h2 id="å…­ã€æ–­è¨€çš„æ¦‚å¿µ"><a href="#å…­ã€æ–­è¨€çš„æ¦‚å¿µ" class="headerlink" title="å…­ã€æ–­è¨€çš„æ¦‚å¿µ"></a>å…­ã€æ–­è¨€çš„æ¦‚å¿µ</h2><ol><li>æ–­è¨€ï¼ˆassertï¼‰ï¼Œæ˜¯ç¼–ç¨‹æœ¯è¯­ï¼Œè¡¨ç¤ºä¸ºä¸€äº›å¸ƒå°”è¡¨è¾¾å¼ï¼Œç¨‹åºå‘˜ç›¸ä¿¡åœ¨ç¨‹åºä¸­çš„æŸä¸ªç‰¹å®šç‚¹è¯¥è¡¨è¾¾å¼å€¼ä¸ºçœŸã€‚å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å¯ç”¨å’Œç¦ç”¨æ–­è¨€éªŒè¯ï¼Œå› æ­¤å¯ä»¥åœ¨æµ‹è¯•æ—¶å¯ç”¨æ–­è¨€è€Œåœ¨éƒ¨ç½²æ—¶ç¦ç”¨æ–­è¨€ã€‚</li><li>ä½¿ç”¨æ–­è¨€æ˜¯åˆ¤æ–­ä¸€ä¸ªå‡½æ•°æˆ–å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•æ‰€äº§ç”Ÿçš„ç»“æœæ˜¯å¦ç¬¦åˆä½ æœŸæœ›é‚£ä¸ªç»“æœã€‚</li></ol><h2 id="ä¸ƒã€æ–°æ–­è¨€assertThatä½¿ç”¨"><a href="#ä¸ƒã€æ–°æ–­è¨€assertThatä½¿ç”¨" class="headerlink" title="ä¸ƒã€æ–°æ–­è¨€assertThatä½¿ç”¨"></a>ä¸ƒã€æ–°æ–­è¨€assertThatä½¿ç”¨</h2><p>JUnit 4.4 ç»“åˆ Hamcrest æä¾›äº†ä¸€ä¸ªå…¨æ–°çš„æ–­è¨€è¯­æ³•â€”â€”assertThatã€‚ç¨‹åºå‘˜å¯ä»¥åªä½¿ç”¨ assertThat ä¸€ä¸ªæ–­è¨€è¯­å¥ï¼Œç»“åˆ Hamcrest æä¾›çš„åŒ¹é…ç¬¦ï¼Œå°±å¯ä»¥è¡¨è¾¾å…¨éƒ¨çš„æµ‹è¯•æ€æƒ³ã€‚</p><p><strong>assertThat çš„ä¼˜ç‚¹ï¼š</strong></p><p><strong>ä¼˜ç‚¹ 1ï¼š</strong> ä»¥å‰ JUnit æä¾›äº†å¾ˆå¤šçš„ assertion è¯­å¥ï¼Œå¦‚ï¼šassertEqualsï¼ŒassertNotSameï¼ŒassertFalseï¼ŒassertTrueï¼ŒassertNotNullï¼ŒassertNull ç­‰ï¼Œç°åœ¨æœ‰äº† JUnit 4.4ï¼Œä¸€æ¡ assertThat å³å¯ä»¥æ›¿ä»£æ‰€æœ‰çš„ assertion è¯­å¥ï¼Œè¿™æ ·å¯ä»¥åœ¨æ‰€æœ‰çš„å•å…ƒæµ‹è¯•ä¸­åªä½¿ç”¨ä¸€ä¸ªæ–­è¨€æ–¹æ³•ï¼Œä½¿å¾—ç¼–å†™æµ‹è¯•ç”¨ä¾‹å˜å¾—ç®€å•ï¼Œä»£ç é£æ ¼å˜å¾—ç»Ÿä¸€ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚</p><p><strong>ä¼˜ç‚¹ 2ï¼š</strong> assertThat ä½¿ç”¨äº† Hamcrest çš„ Matcher åŒ¹é…ç¬¦ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨åŒ¹é…ç¬¦è§„å®šçš„åŒ¹é…å‡†åˆ™ç²¾ç¡®çš„æŒ‡å®šä¸€äº›æƒ³è®¾å®šæ»¡è¶³çš„æ¡ä»¶ï¼Œå…·æœ‰å¾ˆå¼ºçš„æ˜“è¯»æ€§ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»ã€‚</p><p><strong>ä¼˜ç‚¹ 3ï¼š</strong> assertThat ä¸å†åƒ assertEquals é‚£æ ·ï¼Œä½¿ç”¨æ¯”è¾ƒéš¾æ‡‚çš„â€œè°“å®¾ä¸»â€è¯­æ³•æ¨¡å¼ï¼ˆå¦‚ï¼šassertEquals(3, x);ï¼‰ï¼Œç›¸åï¼ŒassertThat ä½¿ç”¨äº†ç±»ä¼¼äºâ€œä¸»è°“å®¾â€çš„æ˜“è¯»è¯­æ³•æ¨¡å¼ï¼ˆå¦‚ï¼šassertThat(x,is(3));ï¼‰ï¼Œä½¿å¾—ä»£ç æ›´åŠ ç›´è§‚ã€æ˜“è¯»ã€‚</p><p><strong>assertThat çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">assertThat( [value], [matcher statement] );</span><br></pre></td></tr></table></figure><p><strong>value</strong> ï¼šæ¥ä¸‹æ¥æƒ³è¦æµ‹è¯•çš„å˜é‡å€¼ï¼›<strong>matcher statement</strong> ï¼šä½¿ç”¨ Hamcrest åŒ¹é…ç¬¦æ¥è¡¨è¾¾çš„å¯¹å‰é¢å˜é‡æ‰€æœŸæœ›çš„å€¼çš„å£°æ˜ï¼Œå¦‚æœ value å€¼ä¸ matcher statement æ‰€è¡¨è¾¾çš„æœŸæœ›å€¼ç›¸ç¬¦ï¼Œåˆ™æµ‹è¯•æˆåŠŸï¼Œå¦åˆ™æµ‹è¯•å¤±è´¥ã€‚</p><h2 id="å…«ã€Postmanä¸Spring-Boot-å•å…ƒæµ‹è¯•çš„åŒºåˆ«"><a href="#å…«ã€Postmanä¸Spring-Boot-å•å…ƒæµ‹è¯•çš„åŒºåˆ«" class="headerlink" title="å…«ã€Postmanä¸Spring Boot å•å…ƒæµ‹è¯•çš„åŒºåˆ«"></a>å…«ã€Postmanä¸Spring Boot å•å…ƒæµ‹è¯•çš„åŒºåˆ«</h2><ol><li>Spring Bootçš„å•å…ƒæµ‹è¯•ä¸»è¦é’ˆå¯¹æ–¹æ³•å±‚é¢ï¼Œå¯ä»¥æµ‹è¯•Serviceå±‚è¿™ç±»éå¯¹å¤–æš´éœ²çš„æ¥å£çš„ç±»ä¸­æ–¹æ³•ï¼Œå¹¶ä¸”å¯ä¸€æ¬¡æ€§æ‰¹é‡æµ‹è¯•å¤šä¸ªæ–¹æ³•ã€æ”¯æŒäº‹åŠ¡å›æ»šã€‚</li><li>Postmané’ˆå¯¹æ¥å£è¿›è¡Œhttpæµ‹è¯•ï¼Œæˆ‘å¹³æ—¶è¿™ä¸ªæ¯”è¾ƒå¤šï¼Œåˆ›å»ºçš„æµ‹è¯•æ¥å£å¯ä¿å­˜ã€åˆ†ç±»ã€‚</li></ol><h2 id="ä¹ã€PostmanåŸºæœ¬ç”¨æ³•"><a href="#ä¹ã€PostmanåŸºæœ¬ç”¨æ³•" class="headerlink" title="ä¹ã€PostmanåŸºæœ¬ç”¨æ³•"></a>ä¹ã€PostmanåŸºæœ¬ç”¨æ³•</h2><p>Postmanæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ç½‘é¡µè°ƒè¯•ä¸å‘é€ç½‘é¡µHTTPè¯·æ±‚çš„å·¥å…·ã€‚Postmanèƒ½å¤Ÿå‘é€ä»»ä½•ç±»å‹çš„HTTPè¯·æ±‚(GET, HEAD, POST,PUT..)ï¼Œé™„å¸¦ä»»ä½•æ•°é‡çš„å‚æ•°å’ŒHTTP headersã€‚æ”¯æŒä¸åŒçš„è®¤è¯æœºåˆ¶ï¼ˆbasic, digest,OAuthï¼‰ï¼Œæ¥æ”¶åˆ°çš„å“åº”è¯­æ³•é«˜äº®ï¼ˆHTMLï¼ŒJSONæˆ–XMLï¼‰ã€‚</p><p><strong>å®‰è£…Postman</strong></p><p>å®˜æ–¹ç½‘ç«™ï¼š</p><p><a href="https://www.getpostman.com/apps">https://www.getpostman.com/apps</a></p><p><img src="https://7.dusays.com/2021/03/12/fb189913d88c3.png" alt="image-20210312140706367"></p><p>å®‰è£…åï¼ŒPostmanæ˜¯ä»‹æ ·å©¶å„¿æ»´~~ğŸ˜Š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2021/03/14044816155290881615529088535.jpg" alt="å›¾ç‰‡"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹-åŸºç¡€å…¥é—¨</title>
      <link href="/blog/2021/01/05/d2d07489.html"/>
      <url>/blog/2021/01/05/d2d07489.html</url>
      
        <content type="html"><![CDATA[<p><em>Elasticsearch</em> æ˜¯ä¸€ä¸ªå®æ—¶çš„åˆ†å¸ƒå¼æœç´¢åˆ†æå¼•æ“ï¼Œå®ƒèƒ½è®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å’Œè§„æ¨¡ï¼Œå»æ¢ç´¢ä½ çš„æ•°æ®ã€‚ å®ƒè¢«ç”¨ä½œå…¨æ–‡æ£€ç´¢ã€ç»“æ„åŒ–æœç´¢ã€åˆ†æä»¥åŠè¿™ä¸‰ä¸ªåŠŸèƒ½çš„ç»„åˆã€‚</p><p>Elasticsearch ä¸­æ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶æ˜¯å…¨æ–°çš„æˆ–è€…æ˜¯é©å‘½æ€§çš„ã€‚å…¨æ–‡æœç´¢å¾ˆä¹…ä¹‹å‰å°±å·²ç»å¯ä»¥åšåˆ°äº†ï¼Œ å°±åƒå¾ˆæ—©ä¹‹å‰å‡ºç°çš„åˆ†æç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ã€‚ <strong>é©å‘½æ€§çš„æˆæœåœ¨äºå°†è¿™äº›å•ç‹¬çš„ï¼Œæœ‰ç”¨çš„ç»„ä»¶èåˆåˆ°ä¸€ä¸ªå•ä¸€çš„ã€ä¸€è‡´çš„ã€å®æ—¶çš„åº”ç”¨ä¸­ã€‚</strong></p><h2 id="Elasticsearchæ˜¯ä»€ä¹ˆ"><a href="#Elasticsearchæ˜¯ä»€ä¹ˆ" class="headerlink" title="Elasticsearchæ˜¯ä»€ä¹ˆ"></a>Elasticsearchæ˜¯ä»€ä¹ˆ</h2><p>Elasticsearch æ˜¯ä¸€ä¸ªå¼€æºçš„æœç´¢å¼•æ“ï¼Œå»ºç«‹åœ¨ä¸€ä¸ªå…¨æ–‡æœç´¢å¼•æ“åº“ <a href="https://lucene.apache.org/core/">Apache Luceneâ„¢</a> åŸºç¡€ä¹‹ä¸Šã€‚ Lucene å¯ä»¥è¯´æ˜¯å½“ä¸‹æœ€å…ˆè¿›ã€é«˜æ€§èƒ½ã€å…¨åŠŸèƒ½çš„æœç´¢å¼•æ“åº“â€”æ— è®ºæ˜¯å¼€æºè¿˜æ˜¯ç§æœ‰ã€‚</p><p>ä½†æ˜¯ Lucene ä»…ä»…åªæ˜¯ä¸€ä¸ªåº“ã€‚ä¸ºäº†å……åˆ†å‘æŒ¥å…¶åŠŸèƒ½ï¼Œä½ éœ€è¦ä½¿ç”¨ Java å¹¶å°† Lucene ç›´æ¥é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚ æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ‚¨å¯èƒ½éœ€è¦è·å¾—ä¿¡æ¯æ£€ç´¢å­¦ä½æ‰èƒ½äº†è§£å…¶å·¥ä½œåŸç†ã€‚Lucene <em>éå¸¸</em> å¤æ‚ã€‚</p><p>Elasticsearch ä¹Ÿæ˜¯ä½¿ç”¨ Java ç¼–å†™çš„ï¼Œå®ƒçš„å†…éƒ¨ä½¿ç”¨ Lucene åšç´¢å¼•ä¸æœç´¢ï¼Œä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯ä½¿å…¨æ–‡æ£€ç´¢å˜å¾—ç®€å•ï¼Œ é€šè¿‡éšè— Lucene çš„å¤æ‚æ€§ï¼Œå–è€Œä»£ä¹‹çš„æä¾›ä¸€å¥—ç®€å•ä¸€è‡´çš„ RESTful APIã€‚</p><p>ç„¶è€Œï¼ŒElasticsearch ä¸ä»…ä»…æ˜¯ Luceneï¼Œå¹¶ä¸”ä¹Ÿä¸ä»…ä»…åªæ˜¯ä¸€ä¸ªå…¨æ–‡æœç´¢å¼•æ“ã€‚ å®ƒå¯ä»¥è¢«ä¸‹é¢è¿™æ ·å‡†ç¡®çš„å½¢å®¹ï¼š</p><ul><li>ä¸€ä¸ªåˆ†å¸ƒå¼çš„å®æ—¶æ–‡æ¡£å­˜å‚¨ï¼Œ<em>æ¯ä¸ªå­—æ®µ</em> å¯ä»¥è¢«ç´¢å¼•ä¸æœç´¢</li><li>ä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶åˆ†ææœç´¢å¼•æ“</li><li>èƒ½èƒœä»»ä¸Šç™¾ä¸ªæœåŠ¡èŠ‚ç‚¹çš„æ‰©å±•ï¼Œå¹¶æ”¯æŒ PB çº§åˆ«çš„ç»“æ„åŒ–æˆ–è€…éç»“æ„åŒ–æ•°æ®</li></ul><blockquote><p>Elasticsearch å°†æ‰€æœ‰çš„åŠŸèƒ½æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„æœåŠ¡ï¼Œè¿™æ ·ä½ å¯ä»¥é€šè¿‡ç¨‹åºä¸å®ƒæä¾›çš„ç®€å•çš„ RESTful API è¿›è¡Œé€šä¿¡ï¼Œ å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€å……å½“ web å®¢æˆ·ç«¯ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œï¼ˆå»å……å½“è¿™ä¸ªå®¢æˆ·ç«¯ï¼‰ã€‚</p></blockquote><h3 id="å®‰è£…å¹¶è¿è¡ŒElasticsearch"><a href="#å®‰è£…å¹¶è¿è¡ŒElasticsearch" class="headerlink" title="å®‰è£…å¹¶è¿è¡ŒElasticsearch"></a>å®‰è£…å¹¶è¿è¡ŒElasticsearch</h3><p>1ã€å®‰è£…æ­¥éª¤å‚è€ƒ<a href="/2021/01/05/93edb835.html">Dockeréƒ¨ç½²elasticsearch</a>ã€‚</p><p>2ã€éªŒè¯æ˜¯å¦è¿è¡ŒæˆåŠŸï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://localhost:9200/?pretty&#x27;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸‹é¢ç±»ä¼¼çš„å“åº”åˆ™æˆåŠŸï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;72Hw8Z7&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;cluster_name&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;qjNWdKc2TtePsX9apDnatw&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;number&quot;</span> : <span class="string">&quot;5.6.12&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_hash&quot;</span> : <span class="string">&quot;cfe3d9f&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_date&quot;</span> : <span class="string">&quot;2018-09-10T20:12:43.732Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;lucene_version&quot;</span> : <span class="string">&quot;6.6.1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™å°±æ„å‘³ç€ä½ ç°åœ¨å·²ç»å¯åŠ¨å¹¶è¿è¡Œä¸€ä¸ª Elasticsearch èŠ‚ç‚¹äº†ï¼Œä½ å¯ä»¥ç”¨å®ƒåšå®éªŒäº†ã€‚ å•ä¸ª <em>èŠ‚ç‚¹</em> å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿è¡Œä¸­çš„ Elasticsearch çš„å®ä¾‹ã€‚ è€Œä¸€ä¸ª é›†ç¾¤ æ˜¯ä¸€ç»„æ‹¥æœ‰ç›¸åŒ <code>cluster.name</code> çš„èŠ‚ç‚¹ï¼Œ ä»–ä»¬èƒ½ä¸€èµ·å·¥ä½œå¹¶å…±äº«æ•°æ®ï¼Œè¿˜æä¾›å®¹é”™ä¸å¯ä¼¸ç¼©æ€§ã€‚(å½“ç„¶ï¼Œä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤) ä½ å¯ä»¥åœ¨ <code>elasticsearch.yml</code> é…ç½®æ–‡ä»¶ä¸­ ä¿®æ”¹ <code>cluster.name</code> ï¼Œè¯¥æ–‡ä»¶ä¼šåœ¨èŠ‚ç‚¹å¯åŠ¨æ—¶åŠ è½½ (è¯‘è€…æ³¨ï¼šè¿™ä¸ªé‡å¯æœåŠ¡åæ‰ä¼šç”Ÿæ•ˆ)ã€‚ </p></blockquote><h3 id="ä¸Elasticsearchäº¤äº’"><a href="#ä¸Elasticsearchäº¤äº’" class="headerlink" title="ä¸Elasticsearchäº¤äº’"></a>ä¸Elasticsearchäº¤äº’</h3><h2 id="é›†ç¾¤å†…çš„åŸç†"><a href="#é›†ç¾¤å†…çš„åŸç†" class="headerlink" title="é›†ç¾¤å†…çš„åŸç†"></a>é›†ç¾¤å†…çš„åŸç†</h2><h2 id="æ•°æ®è¾“å…¥å’Œè¾“å‡º"><a href="#æ•°æ®è¾“å…¥å’Œè¾“å‡º" class="headerlink" title="æ•°æ®è¾“å…¥å’Œè¾“å‡º"></a>æ•°æ®è¾“å…¥å’Œè¾“å‡º</h2><h2 id="åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"><a href="#åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨" class="headerlink" title="åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"></a>åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨</h2><h2 id="æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·"><a href="#æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·" class="headerlink" title="æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·"></a>æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·</h2><h2 id="æ˜ å°„ä¸åˆ†æ"><a href="#æ˜ å°„ä¸åˆ†æ" class="headerlink" title="æ˜ å°„ä¸åˆ†æ"></a>æ˜ å°„ä¸åˆ†æ</h2><h2 id="è¯·æ±‚ä½“æŸ¥è¯¢"><a href="#è¯·æ±‚ä½“æŸ¥è¯¢" class="headerlink" title="è¯·æ±‚ä½“æŸ¥è¯¢"></a>è¯·æ±‚ä½“æŸ¥è¯¢</h2><h2 id="æ’åºä¸ç›¸å…³æ€§"><a href="#æ’åºä¸ç›¸å…³æ€§" class="headerlink" title="æ’åºä¸ç›¸å…³æ€§"></a>æ’åºä¸ç›¸å…³æ€§</h2><h2 id="æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢"><a href="#æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢" class="headerlink" title="æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢"></a>æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢</h2><h2 id="ç´¢å¼•ç®¡ç†"><a href="#ç´¢å¼•ç®¡ç†" class="headerlink" title="ç´¢å¼•ç®¡ç†"></a>ç´¢å¼•ç®¡ç†</h2><h2 id="åˆ†ç‰‡å†…éƒ¨ç®¡ç†"><a href="#åˆ†ç‰‡å†…éƒ¨ç®¡ç†" class="headerlink" title="åˆ†ç‰‡å†…éƒ¨ç®¡ç†"></a>åˆ†ç‰‡å†…éƒ¨ç®¡ç†</h2>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ ¸å¿ƒå¤„ç†å±‚-SqlNode&amp;SqlSource</title>
      <link href="/blog/2020/08/21/bebe404d.html"/>
      <url>/blog/2020/08/21/bebe404d.html</url>
      
        <content type="html"><![CDATA[<p>æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†<code>MyBatis</code>çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»<code>MyBatis</code>çš„åˆå§‹åŒ–ã€åŠ¨æ€<code>SQL</code>è¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠ<code>SQL</code>è¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æ<code>MyBatis</code>çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£<code>MyBatis</code>çš„æ ¸å¿ƒåŸç†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622175512211_aegXOG.png" alt="image-20200622175512211"></p><blockquote><p>æœ¬ç¯‡ä»‹ç»SqINode&amp;SqISource</p></blockquote><p>æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>SQL</code>èŠ‚ç‚¹ä¼šè¢«è§£ææˆ<code>MappedStatement</code>å¯¹è±¡ï¼Œå…¶ä¸­çš„<code>SQL</code>è¯­å¥ä¼šè¢«è§£ææˆ<code>SqlSource</code>å¯¹è±¡ï¼Œ<code>SQL</code>è¯­å¥ä¸­å®šä¹‰çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€æ–‡æœ¬èŠ‚ç‚¹ç­‰ï¼Œåˆ™ç”±<code>SqlNode</code>æ¥å£çš„ç›¸åº”å®ç°è¡¨ç¤ºã€‚</p><p><code>SqlSource</code>æ¥å£çš„å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlSource</code>æ¥å£çš„å®ç°ç±»å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17323715982615571598261557744.png" alt="image-20200824173236987"></p><ul><li><code>DynamicSqlSource</code>è´Ÿè´£å¤„ç†åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œ<code>RawSqlSource</code>è´Ÿè´£å¤„ç†é™æ€è¯­å¥ï¼Œä¸¤è€…æœ€ç»ˆéƒ½ä¼šå°†å¤„ç†åçš„<code>SQL</code>è¯­å¥å°è£…æˆ<code>StaticSqlSource</code>è¿”å›ã€‚</li><li><code>DynamicSqlSource</code>ä¸<code>StaticSqlSource</code>çš„ä¸»è¦åŒºåˆ«ï¼š<ul><li><code>StaticSqlSource</code>ä¸­è®°å½•çš„<code>SQL</code>è¯­å¥ä¸­å¯èƒ½å«æœ‰<code>?</code>å ä½ç¬¦ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥æäº¤ç»™æ•°æ®åº“æ‰§è¡Œ</li><li><code>DynamicSqlSource</code>ä¸­å°è£…çš„<code>SQL</code>è¯­å¥è¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—è§£æï¼Œæ‰ä¼šæœ€ç»ˆå½¢æˆæ•°æ®åº“å¯æ‰§è¡Œçš„<code>SQL</code>è¯­å¥</li></ul></li></ul><h2 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h2><p>ç»„åˆæ¨¡å¼æ˜¯å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ï¼Œä»¥è¡¨ç¤º<code>éƒ¨åˆ†-æ•´ä½“</code>çš„å±‚æ¬¡ç»“æ„(ä¸€èˆ¬æ˜¯æ ‘å½¢ç»“æ„)ï¼Œç”¨æˆ·å¯ä»¥åƒå¤„ç†ä¸€ä¸ªç®€å•å¯¹è±¡ä¸€æ ·æ¥å¤„ç†ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œä»è€Œä½¿å¾—è°ƒç”¨è€…æ— é¡»äº†è§£å¤æ‚å…ƒç´ çš„å†…éƒ¨ç»“æ„ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17400415982620041598262004554.png" alt="image-20200824174003381"></p><p>ç»„åˆæ¨¡å¼ä¸­çš„å„æ¨¡å¼å¦‚ä¸‹ï¼š</p><ul><li><p><strong>æŠ½è±¡ç»„ä»¶(<code>Component</code>)</strong></p><p><code>Component</code>æ¥å£å®šä¹‰äº†æ ‘å½¢ç»“æ„ä¸­æ‰€æœ‰ç±»çš„å…¬å…±è¡Œä¸ºï¼Œä¾‹å¦‚è¿™é‡Œçš„<code>operation()</code>æ–¹æ³•ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…¶ä¸­è¿˜ä¼šå®šä¹‰ä¸€äº›ç”¨äºç®¡ç†å­ç»„ä»¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¿™é‡Œçš„<code>add()</code>ã€<code>remove()</code>ã€<code>getChild()</code>æ–¹æ³•ã€‚</p></li><li><p><strong>æ ‘å¶(<code>Leaf</code>)</strong></p><p><code>Leaf</code>åœ¨æ ‘å½¢ç»“æ„ä¸­è¡¨ç¤ºå¶èŠ‚ç‚¹å¯¹è±¡ï¼Œå¶èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ã€‚</p></li><li><p><strong>æ ‘æ(<code>Composite</code>)</strong></p><p>å®šä¹‰æœ‰å­ç»„ä»¶çš„é‚£äº›ç»„ä»¶çš„è¡Œä¸ºã€‚è¯¥è§’è‰²ç”¨äºç®¡ç†å­ç»„ä»¶ï¼Œå¹¶é€šè¿‡<code>operation()</code>æ–¹æ³•è°ƒç”¨å…¶ç®¡ç†çš„å­ç»„ä»¶çš„ç›¸å…³æ“ä½œã€‚</p></li><li><p><strong>è°ƒç”¨è€…(<code>Client</code>)</strong></p><p>é€šè¿‡<code>Component</code>æ¥å£æ“çºµæ•´ä¸ªæ ‘å½¢ç»“æ„ã€‚</p></li></ul><p><u>ç»„åˆæ¨¡å¼ä¸»è¦æœ‰ä¸¤ç‚¹å¥½å¤„</u>ï¼Œ<strong>é¦–å…ˆç»„åˆæ¨¡å¼å¯ä»¥å¸®åŠ©è°ƒç”¨è€…å±è”½å¯¹è±¡çš„å¤æ‚æ€§</strong>ã€‚</p><p>å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œä½¿ç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸ä½¿ç”¨å•ä¸ª<code>Component</code>å¯¹è±¡æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨è€…å¹¶ä¸å¿…å…³å¿ƒè‡ªå·±å¤„ç†çš„æ˜¯å•ä¸ª<code>Component</code>å¯¹è±¡è¿˜æ˜¯æ•´ä¸ªæ ‘å½¢ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥å°†è°ƒç”¨è€…ä¸å¤æ‚å¯¹è±¡è¿›è¡Œè§£è€¦ã€‚</p><p>å¦å¤–ï¼Œ<strong>ä½¿ç”¨äº†ç»„åˆæ¨¡å¼ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ æ ‘ä¸­èŠ‚ç‚¹çš„æ–¹å¼ï¼Œæ·»åŠ æ–°çš„Componentå¯¹è±¡ï¼Œä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ï¼Œè¿™ç¬¦åˆ<code>å¼€æ”¾-å°é—­</code>åŸåˆ™ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–æ—¥åçš„ç»´æŠ¤å·¥ä½œã€‚</strong></p><p><u>ç»„åˆæ¨¡å¼åœ¨å¸¦æ¥ä¸Šè¿°å¥½å¤„çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¼•å…¥ä¸€äº›é—®é¢˜</u>ã€‚</p><p>ä¾‹å¦‚ï¼Œæœ‰äº›åœºæ™¯ä¸‹ç¨‹åºå¸Œæœ›ä¸€ä¸ªç»„åˆç»“æ„ä¸­åªèƒ½æœ‰æŸäº›ç‰¹å®šçš„ç»„ä»¶ï¼Œæ­¤æ—¶å°±å¾ˆéš¾ç›´æ¥é€šè¿‡ç»„ä»¶ç±»å‹è¿›è¡Œé™åˆ¶(å› ä¸ºéƒ½æ˜¯<code>Component</code>æ¥å£çš„å®ç°ç±»)ï¼Œè¿™å°±å¿…é¡»åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æµ‹ã€‚è€Œä¸”ï¼Œåœ¨é€’å½’ç¨‹åºä¸­å®šä½é—®é¢˜ä¹Ÿæ˜¯ä¸€ä»¶æ¯”è¾ƒå¤æ‚çš„äº‹æƒ…ã€‚</p><p><code>MyBatis</code>åœ¨å¤„ç†åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æ—¶ï¼Œåº”ç”¨åˆ°äº†ç»„åˆè®¾è®¡æ¨¡å¼ã€‚<code>MyBatis</code>ä¼šå°†åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹è§£ææˆå¯¹åº”çš„<code>SqlNode</code>å®ç°ï¼Œå¹¶å½¢æˆæ ‘å½¢ç»“æ„ã€‚</p><h2 id="OGNLè¡¨è¾¾å¼"><a href="#OGNLè¡¨è¾¾å¼" class="headerlink" title="OGNLè¡¨è¾¾å¼"></a>OGNLè¡¨è¾¾å¼</h2><p><code>OGNL</code>(<strong>Object Graphic Navigation Languageï¼Œå¯¹è±¡å›¾å¯¼èˆªè¯­è¨€</strong>)è¡¨è¾¾å¼åœ¨<code>Struts</code>ã€<code>MyBatis</code>ç­‰å¼€æºé¡¹ç›®ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå…¶ä¸­<code>Struts</code>æ¡†æ¶æ›´æ˜¯å°†<code>OGNL</code>ä½œä¸ºé»˜è®¤çš„è¡¨è¾¾å¼è¯­è¨€ã€‚</p><p>åœ¨<code>MyBatis</code>ä¸­æ¶‰åŠçš„<code>OGNL</code>è¡¨è¾¾å¼çš„åŠŸèƒ½ä¸»è¦æ˜¯ï¼š<strong>å­˜å–<code>Java</code>å¯¹è±¡æ ‘ä¸­çš„å±æ€§</strong>ã€<strong>è°ƒç”¨<code>Java</code>å¯¹è±¡æ ‘ä¸­çš„æ–¹æ³•ç­‰</strong>ã€‚</p><p><strong>OGNLä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼š</strong></p><ul><li><p><strong>è¡¨è¾¾å¼</strong></p><p><code>OGNL</code>è¡¨è¾¾å¼æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ ¹æ®è¡¨è¾¾å¼è§£æå¾—åˆ°çš„ã€‚</p><p>ä¾‹å¦‚ï¼š</p><p><code>å¯¹è±¡å.æ–¹æ³•å</code>è¡¨ç¤ºè°ƒç”¨æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•</p><p><code>@[ç±»çš„å®Œå…¨é™å®šå]@[é™æ€æ–¹æ³•æˆ–é™æ€å­—æ®µ]</code>è¡¨ç¤ºè°ƒç”¨æŒ‡å®šç±»çš„é™æ€æ–¹æ³•æˆ–è®¿é—®é™æ€å­—æ®µ</p><p><code>OGNL</code>è¡¨è¾¾å¼è¿˜å¯ä»¥å®Œæˆ<u>å˜é‡èµ‹å€¼</u>ã€<u>æ“ä½œé›†åˆ</u>ç­‰æ“ä½œã€‚</p></li><li><p><strong>rootå¯¹è±¡</strong></p><p><code>OGNL</code>è¡¨è¾¾å¼æŒ‡å®šäº†å…·ä½“çš„æ“ä½œï¼Œè€Œ<code>root</code>å¯¹è±¡æŒ‡å®šäº†éœ€è¦æ“ä½œçš„å¯¹è±¡ã€‚</p></li><li><p><strong>OgnlContextï¼ˆä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</strong></p><p><code>OgnlContext</code>ç±»ç»§æ‰¿äº†<code>Map</code>æ¥å£ï¼Œ<code>OgnlContext</code>å¯¹è±¡è¯´ç™½äº†ä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>Map</code>å¯¹è±¡ã€‚</p><p>æ—¢ç„¶å¦‚æ­¤ï¼Œ<code>OgnIContext</code>å¯¹è±¡ä¸­å°±å¯ä»¥å­˜æ”¾é™¤<code>root</code>å¯¹è±¡ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡ã€‚</p><p>åœ¨ä½¿ç”¨<code>OGNL</code>è¡¨è¾¾å¼æ“ä½œé<code>root</code>å¯¹è±¡æ—¶ï¼Œéœ€è¦ä½¿ç”¨<code>#</code>å‰ç¼€ï¼Œè€Œæ“ä½œ<code>root</code>å¯¹è±¡åˆ™ä¸éœ€è¦ä½¿ç”¨<code>#</code>å‰ç¼€ã€‚</p></li></ul><p>åœ¨<code>MyBatis</code>ä¸­ï¼Œä½¿ç”¨<code>OgnlCache</code>å¯¹åŸç”Ÿçš„<code>OGNL</code>è¿›è¡Œäº†å°è£…ã€‚<code>OGNL</code>è¡¨è¾¾å¼çš„è§£æè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œ<code>OgnlCache</code>ä¸­ä½¿ç”¨<code>expressionCache</code>å­—æ®µ(é™æ€æˆå‘˜ï¼Œ<code>ConcurrentHashMap&lt;String,Object&gt;</code>ç±»å‹)å¯¹è§£æåçš„<code>OGNL</code>è¡¨è¾¾å¼è¿›è¡Œç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; expressionCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(String expression, Object root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Map&lt;Object, OgnlClassResolver&gt; context = Ognl.createDefaultContext(root, <span class="keyword">new</span> OgnlClassResolver());</span><br><span class="line">    <span class="keyword">return</span> Ognl.getValue(parseExpression(expression), context, root);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (OgnlException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error evaluating expression &#x27;&quot;</span> + expression + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">parseExpression</span><span class="params">(String expression)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">  Object node = expressionCache.get(expression);</span><br><span class="line">  <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">    node = Ognl.parseExpression(expression);</span><br><span class="line">    expressionCache.put(expression, node);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DynamicContext"><a href="#DynamicContext" class="headerlink" title="DynamicContext"></a>DynamicContext</h2><p><code>DynamicContext</code>ä¸»è¦ç”¨äºè®°å½•è§£æåŠ¨æ€<code>SQL</code>è¯­å¥ä¹‹åäº§ç”Ÿçš„<code>SQL</code>è¯­å¥ç‰‡æ®µï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç”¨äºè®°å½•åŠ¨æ€<code>SQL</code>è¯­å¥è§£æç»“æœçš„å®¹å™¨ã€‚</p><p>å…¶ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ContextMap bindings;</span><br><span class="line"><span class="comment">// åœ¨SqlNodeè§£æåŠ¨æ€sqlçš„æ—¶å€™ï¼Œä¼šå°†è§£æåçš„sqlè¯­å¥ç‰‡æ®µæ·»åŠ åˆ°è¯¥å±æ€§ä¸­ä¿å­˜ï¼Œæœ€ç»ˆæ‹¼å‡‘å‡ºä¸€æ¡å®Œæ•´çš„sqlè¯­å¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder();</span><br></pre></td></tr></table></figure><p><code>ContextMap</code>æ˜¯<code>DynamicContext</code>ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†<code>HashMap</code>å¹¶é‡å†™äº†<code>get()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextMap</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2977601501966151582L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†ç”¨æˆ·ä¼ çš„å‚æ•°å°è£…æˆMetaObjectå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> MetaObject parameterMetaObject;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ContextMap</span><span class="params">(MetaObject parameterMetaObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.parameterMetaObject = parameterMetaObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    String strKey = (String) key;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.containsKey(strKey)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.get(strKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parameterMetaObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// issue #61 do not modify the context when reading</span></span><br><span class="line">      <span class="keyword">return</span> parameterMetaObject.getValue(strKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DynamicContext</code>çš„æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–<code>bindings</code>é›†åˆï¼Œæ³¨æ„æ„é€ æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°<code>pammeterObject</code>ï¼Œå®ƒæ˜¯è¿è¡Œæ—¶ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ï¼Œå…¶ä¸­åŒ…å«äº†åç»­ç”¨äºæ›¿æ¢<code>#&#123;&#125;</code>å ä½ç¬¦çš„å®å‚ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicContext</span><span class="params">(Configuration configuration, Object parameterObject)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parameterObject != <span class="keyword">null</span> &amp;&amp; !(parameterObject <span class="keyword">instanceof</span> Map)) &#123;</span><br><span class="line">    <span class="comment">// å¯¹äºä¸æ˜¯Mapç±»å‹çš„å‚æ•°ï¼Œä¼šåˆ›è£…MetaObjectå¯¹è±¡ï¼Œå¹¶å°è£…æˆContextMapå¯¹è±¡</span></span><br><span class="line">    MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">    bindings = <span class="keyword">new</span> ContextMap(metaObject);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    bindings = <span class="keyword">new</span> ContextMap(<span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  bindings.put(PARAMETER_OBJECT_KEY, parameterObject);</span><br><span class="line">  bindings.put(DATABASE_ID_KEY, configuration.getDatabaseId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SqlNode"><a href="#SqlNode" class="headerlink" title="SqlNode"></a>SqlNode</h2><p>æ¥ä¸‹æ¥çœ‹çœ‹SqlNodeçš„å®ç°ç±»æ˜¯å¦‚ä½•è§£æå…¶å¯¹åº”çš„SQLèŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlNode</span> </span>&#123;</span><br><span class="line">  <span class="comment">// apply()æ˜¯SqlNodeæ¥å£ä¸­å®šä¹‰çš„å”¯ä¸€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å®å‚ï¼Œå‚æ•°è§£æè¯¥SqlNodeæ‰€</span></span><br><span class="line">  <span class="comment">// è®°å½•çš„åŠ¨æ€SQLèŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨DynamicContext.appendSql()æ–¹æ³•å°†è§£æåçš„SQLç‰‡æ®µè¿½åŠ åˆ°</span></span><br><span class="line">  <span class="comment">// DynamicContext.sqlBuilderä¸­ä¿å­˜</span></span><br><span class="line">  <span class="comment">// å½“SQLèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰SqlNodeå®Œæˆè§£æåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»DynamicContextä¸­è·å–ä¸€æ¡åŠ¨æ€ç”Ÿæˆçš„ã€</span></span><br><span class="line">  <span class="comment">// å®Œæ•´çš„SQLè¯­å¥</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlNode</code>æ¥å£æœ‰å¤šä¸ªå®ç°ç±»ï¼Œæ¯ä¸ªå®ç°ç±»å¯¹åº”ä¸€ä¸ªåŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€‚æŒ‰ç…§ç»„åˆæ¨¡å¼çš„è§’è‰²æ¥åˆ’åˆ†ï¼Œ<code>SqlNode</code>æ‰®æ¼”äº†æŠ½è±¡ç»„ä»¶çš„è§’è‰²ï¼Œ<code>MixedSqlNode</code>æ‰®æ¼”äº†æ ‘æèŠ‚ç‚¹çš„è§’è‰²ï¼Œ<code>TextSqlNode</code>èŠ‚ç‚¹æ‰®æ¼”äº†æ ‘å¶èŠ‚ç‚¹çš„è§’è‰²ç­‰ç­‰ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/16395615983447961598344796478.png" alt="image-20200825163955175"></p><p><strong>1ã€StaticTextSqINode&amp;MixedSqINode</strong></p><p><code>StaticTextSqINode</code>ä¸­ä½¿ç”¨<code>text</code>å­—æ®µ(<code>String</code>ç±»å‹)è®°å½•äº†å¯¹åº”çš„éåŠ¨æ€<code>SQL</code>è¯­å¥èŠ‚ç‚¹ï¼Œå…¶<code>apply()</code>æ–¹æ³•ç›´æ¥å°†<code>text</code>å­—æ®µè¿½åŠ åˆ°<code>DynamicContext.sqlBuilder</code>å­—æ®µä¸­ã€‚</p><p><code>MixedSqINode</code>ä¸­ä½¿ç”¨<code>contents</code>å­—æ®µ(<code>List&lt;SqlNode&gt;</code>ç±»å‹)è®°å½•å…¶å­èŠ‚ç‚¹å¯¹åº”çš„<code>SqlNode</code>å¯¹è±¡é›†åˆï¼Œå…¶<code>apply()</code>æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨<code>contents</code>é›†åˆä¸­æ‰€æœ‰<code>SqlNode</code>å¯¹è±¡çš„<code>apply()</code>æ–¹æ³•ã€‚</p><p><strong>2ã€TextSqlNode</strong></p><p><u><code>TextSqlNode</code>è¡¨ç¤ºçš„æ˜¯åŒ…å«å ä½ç¬¦çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€‚</u><code>TextSqlNode.apply()</code>æ–¹æ³•ä¼šä½¿ç”¨<code>GenericTokenParser</code>è§£æ<code>$&#123;&#125;</code>å ä½ç¬¦ï¼Œå¹¶ç›´æ¥æ›¿æ¢æˆç”¨æˆ·ç»™å®šçš„å®é™…å‚æ•°å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºGenericTokenParserè§£æå™¨ï¼Œ</span></span><br><span class="line">  GenericTokenParser parser = createParser(<span class="keyword">new</span> BindingTokenParser(context, injectionFilter));</span><br><span class="line">  <span class="comment">// å°†è§£æåçš„SQLç‰‡æ®µæ·»åŠ åˆ°DynamicContextä¸­</span></span><br><span class="line">  context.appendSql(parser.parse(text));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> GenericTokenParser <span class="title">createParser</span><span class="params">(TokenHandler handler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;$&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**<code>BindingTokenParser</code>**æ˜¯<code>TextSqlNode</code>ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿äº†<code>TokenHandler</code>æ¥å£ï¼Œ<u>å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®<code>DynamicContext.bindings</code>é›†åˆä¸­çš„ä¿¡æ¯è§£æ<code>SQL</code>è¯­å¥èŠ‚ç‚¹ä¸­çš„<code>$&#123;&#125;</code>å ä½ç¬¦</u>ã€‚<code>BindingTokenParser.context</code>å­—æ®µæŒ‡å‘äº†å¯¹åº”çš„<code>DynamicContext</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingTokenParser</span> <span class="keyword">implements</span> <span class="title">TokenHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> DynamicContext context;</span><br><span class="line">  <span class="keyword">private</span> Pattern injectionFilter;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BindingTokenParser</span><span class="params">(DynamicContext context, Pattern injectionFilter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">    <span class="keyword">this</span>.injectionFilter = injectionFilter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">    Object parameter = context.getBindings().get(<span class="string">&quot;_parameter&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">      context.getBindings().put(<span class="string">&quot;value&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SimpleTypeRegistry.isSimpleType(parameter.getClass())) &#123;</span><br><span class="line">      context.getBindings().put(<span class="string">&quot;value&quot;</span>, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    Object value = OgnlCache.getValue(content, context.getBindings());</span><br><span class="line">    String srtValue = (value == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : String.valueOf(value)); <span class="comment">// issue #274 return &quot;&quot; instead of &quot;null&quot;</span></span><br><span class="line">    checkInjection(srtValue);</span><br><span class="line">    <span class="keyword">return</span> srtValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkInjection</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (injectionFilter != <span class="keyword">null</span> &amp;&amp; !injectionFilter.matcher(value).matches()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ScriptingException(<span class="string">&quot;Invalid input. Please conform to regex&quot;</span> + injectionFilter.pattern());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3ã€IfSqlNode</strong></p><p><code>IfSqlNode</code>å¯¹åº”çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æ˜¯<code>&lt;if&gt;</code>èŠ‚ç‚¹ï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªæ ¸å¿ƒå­—æ®µã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºè§£æifèŠ‚ç‚¹çš„testè¡¨è¾¾å¼çš„å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExpressionEvaluator evaluator;</span><br><span class="line"><span class="comment">// è®°å½•äº†testè¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String test;</span><br><span class="line"><span class="comment">// è®°å½•å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br></pre></td></tr></table></figure><p><code>IfSqlNode.apply()</code>æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡<code>ExpressionEvaluator.evaluateBoolean()</code>æ–¹æ³•æ£€æµ‹å…¶<code>test</code>è¡¨è¾¾<br>å¼æ˜¯å¦ä¸º<code>true</code>ï¼Œç„¶åæ ¹æ®<code>test</code>è¡¨è¾¾å¼çš„ç»“æœï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œå…¶å­èŠ‚ç‚¹çš„<code>apply()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">    contents.apply(context);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluateBoolean</span><span class="params">(String expression, Object parameterObject)</span> </span>&#123;</span><br><span class="line">  Object value = OgnlCache.getValue(expression, parameterObject);</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Boolean) value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(String.valueOf(value)).compareTo(BigDecimal.ZERO) != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4ã€TrimSqINode&amp;WhereSqINode&amp;SetSqINode</strong></p><p><code>TrimSqlNode</code>ä¼šæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœï¼Œæ·»åŠ æˆ–åˆ é™¤ç›¸åº”çš„å‰ç¼€æˆ–åç¼€ã€‚å…¶ä¸­å‡ ä¸ªå­—æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br><span class="line"><span class="comment">// SQLè¯­å¥æ·»åŠ çš„å‰ç¼€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line"><span class="comment">// SQLè¯­å¥æ·»åŠ çš„åç¼€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String suffix;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; prefixesToOverride;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; suffixesToOverride;</span><br></pre></td></tr></table></figure><p>åœ¨<code>TrimSqlNode</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨<code>parseOverrides()</code>æ–¹æ³•å¯¹å‚æ•°<code>prefixesToOverride</code>(å¯¹åº”<code>&lt;trim&gt;</code>èŠ‚ç‚¹çš„<code>prefixOverrides</code>å±æ€§)å’Œå‚æ•°<code>suffixesToOverride</code>(å¯¹åº”<code>&lt;trim&gt;</code>èŠ‚ç‚¹çš„<code>suffixOverrides</code>å±æ€§)è¿›è¡Œè§£æï¼Œå¹¶åˆå§‹åŒ–<code>prefixesToOverride</code>å’Œ<code>sufflxesToOverride</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">parseOverrides</span><span class="params">(String overrides)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (overrides != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> StringTokenizer parser = <span class="keyword">new</span> StringTokenizer(overrides, <span class="string">&quot;|&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;(parser.countTokens());</span><br><span class="line">    <span class="keyword">while</span> (parser.hasMoreTokens()) &#123;</span><br><span class="line">      list.add(parser.nextToken().toUpperCase(Locale.ENGLISH));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TrimSqlNode.apply()</code>æ–¹æ³•é¦–å…ˆè§£æå­èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœå¤„ç†å‰ç¼€å’Œåç¼€ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºFilteredDynamicContextå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†DynamicContext</span></span><br><span class="line">  FilteredDynamicContext filteredDynamicContext = <span class="keyword">new</span> FilteredDynamicContext(context);</span><br><span class="line">  <span class="comment">// è°ƒç”¨å­èŠ‚ç‚¹çš„applyæ–¹æ³•è¿›è¡Œè§£æ</span></span><br><span class="line">  <span class="keyword">boolean</span> result = contents.apply(filteredDynamicContext);</span><br><span class="line">  <span class="comment">// å¤„ç†å‰ç¼€å’Œåç¼€</span></span><br><span class="line">  filteredDynamicContext.applyAll();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†å‰ç¼€å’Œåç¼€çš„ä¸»è¦é€»è¾‘æ˜¯åœ¨<code>FilteredDynamicContext</code>ä¸­å®ç°çš„ï¼Œå®ƒç»§æ‰¿äº†<code>DynamicContext</code>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯<code>DynamicContext</code>çš„ä»£ç†ç±»ã€‚</p><p><code>FilteredDynamicContext</code>é™¤äº†å°†å¯¹åº”æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™å…¶ä¸­å°è£…çš„<code>DynamicContext</code>å¯¹è±¡ï¼Œè¿˜æä¾›äº†å¤„ç†å‰ç¼€å’Œåç¼€çš„<code>applyAll()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteredDynamicContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åº•å±‚å°è£…çš„DynamicContextå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> DynamicContext delegate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€å’Œåç¼€</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> prefixApplied;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> suffixApplied;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">private</span> StringBuilder sqlBuffer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœï¼Œå¹¶å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™</span></span><br><span class="line">    sqlBuffer = <span class="keyword">new</span> StringBuilder(sqlBuffer.toString().trim());</span><br><span class="line">    String trimmedUppercaseSql = sqlBuffer.toString().toUpperCase(Locale.ENGLISH);</span><br><span class="line">    <span class="keyword">if</span> (trimmedUppercaseSql.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      applyPrefix(sqlBuffer, trimmedUppercaseSql);<span class="comment">// å¤„ç†å‰ç¼€</span></span><br><span class="line">      applySuffix(sqlBuffer, trimmedUppercaseSql);<span class="comment">// å¤„ç†åç¼€</span></span><br><span class="line">    &#125;</span><br><span class="line">    delegate.appendSql(sqlBuffer.toString());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å‰ç¼€</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyPrefix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!prefixApplied) &#123;</span><br><span class="line">      prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (prefixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String toRemove : prefixesToOverride) &#123;</span><br><span class="line">          <span class="keyword">if</span> (trimmedUppercaseSql.startsWith(toRemove)) &#123;</span><br><span class="line">            sql.delete(<span class="number">0</span>, toRemove.trim().length());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (prefix != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sql.insert(<span class="number">0</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">        sql.insert(<span class="number">0</span>, prefix);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†åç¼€</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySuffix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!suffixApplied) &#123;</span><br><span class="line">      suffixApplied = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (suffixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String toRemove : suffixesToOverride) &#123;</span><br><span class="line">          <span class="keyword">if</span> (trimmedUppercaseSql.endsWith(toRemove) || </span><br><span class="line">              trimmedUppercaseSql.endsWith(toRemove.trim())) &#123;</span><br><span class="line">            <span class="keyword">int</span> start = sql.length() - toRemove.trim().length();</span><br><span class="line">            <span class="keyword">int</span> end = sql.length();</span><br><span class="line">            sql.delete(start, end);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (suffix != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sql.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        sql.append(suffix);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><u><code>WhereSqlNode</code>å’Œ<code>SetSqlNode</code>éƒ½ç»§æ‰¿äº†<code>TrimSqlNode</code></u>ã€‚</p><p>å…¶ä¸­<code>WhereSqlNode</code>æŒ‡å®šäº†<code>prefix</code>å­—æ®µä¸º<code>WHERE</code>ï¼Œ<code>prefixesToOverride</code>é›†åˆä¸­çš„é¡¹ä¸º<code>AND</code>å’Œ<code>OR</code>ï¼Œ<code>suffix</code>å­—æ®µå’Œ<code>suffixesToOverride</code>é›†åˆä¸º<code>null</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>&lt;where&gt;</code>èŠ‚ç‚¹è§£æåçš„<code>SQL</code>è¯­å¥ç‰‡æ®µå¦‚æœä»¥<code>AND</code>æˆ–<code>OR</code>å¼€å¤´ï¼Œåˆ™å°†å¼€å¤´å¤„çš„<code>AND</code>æˆ–<code>OR</code>åˆ é™¤ï¼Œä¹‹åå†å°†<code>WHERE</code>å…³é”®å­—æ·»åŠ åˆ°<code>SQL</code>ç‰‡æ®µå¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥<code>&lt;where&gt;</code>èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„<code>SQL</code>ç‰‡æ®µã€‚</p><p><code>SetSqlNode</code>æŒ‡å®šäº†<code>prefix</code>å­—æ®µä¸º<code>SET</code>ï¼Œ<code>suffixesToOverride</code>é›†åˆä¸­çš„é¡¹åªæœ‰<code>suffix</code>å­—æ®µå’Œ<code>prefixesToOverride</code>é›†åˆä¸º<code>null</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>&lt;set&gt;</code>èŠ‚ç‚¹è§£æåçš„<code>SQL</code>è¯­å¥ç‰‡æ®µå¦‚æœä»¥<code>,</code>ç»“å°¾ï¼Œåˆ™å°†ç»“å°¾å¤„çš„åˆ é™¤æ‰ï¼Œä¹‹åå†å°†<code>SET</code>å…³é”®å­—æ·»åŠ åˆ°<code>SQL</code>ç‰‡æ®µçš„å¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥<code>&lt;set&gt;</code>èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„<code>SQL</code>ç‰‡æ®µã€‚</p><p><strong>5ã€ForeachSqINode</strong></p><p>åœ¨åŠ¨æ€<code>SQL</code>è¯­å¥ä¸­æ„å»º<code>IN</code>æ¡ä»¶è¯­å¥çš„æ—¶å€™ï¼Œé€šå¸¸éœ€è¦å¯¹ä¸€ä¸ªé›†åˆè¿›è¡Œè¿­ä»£ï¼Œ<code>MyBatis</code>æä¾›äº†<code>&lt;foreach&gt;</code>æ ‡ç­¾å®ç°è¯¥åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨<code>&lt;foreach&gt;</code>æ ‡ç­¾è¿­ä»£é›†åˆæ—¶ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨é›†åˆçš„å…ƒç´ å’Œç´¢å¼•å€¼ï¼Œè¿˜å¯ä»¥åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰æˆ–ç»“æŸä¹‹åæ·»åŠ æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå…è®¸åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ·»åŠ æŒ‡å®šçš„åˆ†éš”ç¬¦ã€‚</p><p>è§£æ<code>&lt;foreach&gt;</code>èŠ‚ç‚¹å¯¹åº”çš„<code>sqlnode</code>å®ç°ç±»æ˜¯<code>ForeachSqlNode</code>ï¼Œä»¥ä¸‹æ˜¯å…¶ä¸­å®šä¹‰çš„å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºåˆ¤æ–­å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ï¼ŒForeachSqlNodeæ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºè¯¥å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExpressionEvaluator evaluator;</span><br><span class="line"><span class="comment">// è¿­ä»£çš„é›†åˆè¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String collectionExpression;</span><br><span class="line"><span class="comment">// å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br><span class="line"><span class="comment">// å¾ªç¯å¼€å§‹å‰è¦æ·»åŠ çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String open;</span><br><span class="line"><span class="comment">// å¾ªç¯ç»“æŸæ—¶è¦æ·»åŠ çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String close;</span><br><span class="line"><span class="comment">// åˆ†éš”ç¬¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String separator;</span><br><span class="line"><span class="comment">// æœ¬æ¬¡è¿­ä»£çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String item;</span><br><span class="line"><span class="comment">// å½“å‰è¿­ä»£çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String index;</span><br><span class="line"><span class="comment">// é…ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br></pre></td></tr></table></figure><p><code>ForeachSqINode</code>ä¸­æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯<code>PrefixedContext</code>å’Œ<code>FilteredDynamicContext</code>ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†<code>DynamicContext</code>ï¼ŒåŒæ—¶ä¹Ÿéƒ½æ˜¯<code>DynamicContext</code>çš„ä»£ç†ç±»ã€‚</p><p><strong><code>PreFixedContext</code></strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PrefixedContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DynamicContext delegate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> prefixApplied;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendSql</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!prefixApplied &amp;&amp; sql != <span class="keyword">null</span> &amp;&amp; sql.trim().length() &gt; <span class="number">0</span>) &#123; <span class="comment">// æ˜¯å¦éœ€è¦è¿½åŠ å‰ç¼€</span></span><br><span class="line">      delegate.appendSql(prefix); <span class="comment">// è¿½åŠ å‰ç¼€</span></span><br><span class="line">      prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    delegate.appendSql(sql); <span class="comment">// è¿½åŠ sql</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>FilteredDynamicContext</code></strong></p><p><code>FilteredDynamicContext</code>è´Ÿè´£å¤„ç†<code>#&#123;&#125;</code>å ä½ç¬¦ï¼Œä½†å®ƒå¹¶æœªå®Œå…¨è§£æ<code>#&#123;&#125;</code>å ä½ç¬¦ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteredDynamicContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">// DynamicContextå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DynamicContext delegate;</span><br><span class="line">  <span class="comment">// ç´¢å¼•ä½ç½®</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">  <span class="comment">// å¯¹åº”é›†åˆé¡¹çš„index</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String itemIndex;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String item;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendSql</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;#&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, <span class="keyword">new</span> TokenHandler() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        String newContent = </span><br><span class="line">          content.replaceFirst(<span class="string">&quot;^\\s*&quot;</span> + item + <span class="string">&quot;(?![^.,:\\s])&quot;</span>, itemizeItem(item, index));</span><br><span class="line">        <span class="keyword">if</span> (itemIndex != <span class="keyword">null</span> &amp;&amp; newContent.equals(content)) &#123;</span><br><span class="line">          newContent = </span><br><span class="line">            content.replaceFirst(<span class="string">&quot;^\\s*&quot;</span> + itemIndex + <span class="string">&quot;(?![^.,:\\s])&quot;</span>, </span><br><span class="line">                                 itemizeItem(itemIndex, index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(<span class="string">&quot;#&#123;&quot;</span>).append(newContent).append(<span class="string">&quot;&#125;&quot;</span>).toString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    delegate.appendSql(parser.parse(sql));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUniqueNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> delegate.getUniqueNumber();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>6ã€ChooseSqlNode</strong></p><p>å¦‚æœåœ¨ç¼–å†™åŠ¨æ€<code>SQL</code>è¯­å¥æ—¶éœ€è¦ç±»ä¼¼<code>Java</code>ä¸­çš„<code>switch</code>è¯­å¥çš„åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<code>&lt;choose&gt;</code>ã€<code>&lt;when&gt;</code>å’Œ<code>&lt;otherwise&gt;</code>ä¸‰ä¸ªæ ‡ç­¾çš„ç»„åˆã€‚<code>MyBatis</code>ä¼šå°†<code>&lt;choose&gt;</code>æ ‡ç­¾è§£ææˆ<code>ChooseSqlNode</code>ï¼Œå°†<code>&lt;when&gt;</code>æ ‡ç­¾è§£ææˆ<code>IfSqlNode</code>ï¼Œå°†<code>&lt;otherwise&gt;</code>æ ‡ç­¾è§£ææˆ<code>MixedSqlNode</code>ã€‚</p><p><code>ChooseSqlNode.apply()</code>æ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆéå†<code>ifSqlNodes</code>é›†åˆå¹¶è°ƒç”¨å…¶ä¸­<code>SqlNode</code><br>å¯¹è±¡çš„<code>apply()</code>æ–¹æ³•ï¼Œç„¶åæ ¹æ®å‰é¢çš„å¤„ç†ç»“æœå†³å®šæ˜¯å¦è°ƒç”¨<code>defaultSqlNode</code>çš„<code>apply()</code>æ–¹æ³•ã€‚</p><p><strong>7ã€VarDecISqINode</strong></p><p><code>VarDeclSqlNode</code>è¡¨ç¤ºçš„æ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ä¸­çš„<code>&lt;bind&gt;</code>èŠ‚ç‚¹,è¯¥èŠ‚ç‚¹å¯ä»¥ä»<code>OGNL</code>è¡¨è¾¾å¼ä¸­åˆ›å»ºä¸€ä¸ªå˜é‡å¹¶å°†å…¶è®°å½•åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚</p><p>åœ¨<code>VarDecISqINode</code>ä¸­é€šè¿‡<code>name</code>å­—æ®µè®°å½•<code>&lt;bind&gt;</code>èŠ‚ç‚¹çš„<code>name</code>å±æ€§å€¼ï¼Œ<code>expression</code>å­—æ®µè®°å½•<code>&lt;bind&gt;</code>èŠ‚ç‚¹çš„<code>value</code>å±æ€§å€¼ã€‚</p><h2 id="SqlSourceBuilder"><a href="#SqlSourceBuilder" class="headerlink" title="SqlSourceBuilder"></a>SqlSourceBuilder</h2><p>åœ¨ç»è¿‡<code>SqlNode.apply()</code>æ–¹æ³•çš„è§£æä¹‹åï¼Œ<code>SQL</code>è¯­å¥ä¼šè¢«ä¼ é€’åˆ°<code>SqlSourceBuilder</code>ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„è§£æã€‚</p><p><code>SqISourceBuilder</code>ä¸»è¦å®Œæˆäº†ä¸¤æ–¹é¢çš„æ“ä½œï¼Œä¸€æ–¹é¢æ˜¯è§£æ<code>SQL</code>è¯­å¥ä¸­çš„<code>#&#123;&#125;</code><br>å ä½ç¬¦ä¸­å®šä¹‰çš„å±æ€§ï¼Œæ ¼å¼ç±»ä¼¼äº<code>#&#123;__frc_item_0,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;</code>ï¼Œå¦ä¸€æ–¹é¢æ˜¯å°†<code>SQL</code>è¯­å¥ä¸­çš„<code>#&#123;&#125;</code>å ä½ç¬¦æ›¿æ¢æˆ<code>?</code>å ä½ç¬¦ã€‚</p><p><code>SqlSourceBuilder</code>ä¹Ÿæ˜¯<code>BaseBuilder</code>çš„å­ç±»ä¹‹ä¸€ï¼Œå…¶æ ¸å¿ƒé€»è¾‘ä½äº<code>parse()</code>æ–¹æ³•ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parse</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†ä¹‹åçš„sqlè¯­å¥</span></span><br><span class="line">  <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨æˆ·ä¼ å…¥çš„å®å‚ç±»å‹</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸‰ä¸ªå‚æ•°è®°å½•äº†å½¢å‚ä¸å®å‚çš„å¯¹åº”å…³ç³»ï¼Œå…¶å®å°±æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†åçš„DynamicContext.bindingsé›†åˆ</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆ›å»ºParameterMappingTokenHandlerå¯¹è±¡ï¼Œ å®ƒæ˜¯è§£æ#&#123;&#125;å ä½ç¬¦ä¸­çš„å‚æ•°å±æ€§ä»¥åŠæ›¿æ¢å ä½ç¬¦çš„æ ¸å¿ƒ</span></span><br><span class="line">  ParameterMappingTokenHandler handler = </span><br><span class="line">    <span class="keyword">new</span> ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é…åˆParameterMappingTokenHandlerè§£æå ä½ç¬¦</span></span><br><span class="line">  GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;#&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, handler);</span><br><span class="line">  String sql = parser.parse(originalSql);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StaticSqlSource(configuration, sql, handler.getParameterMappings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DynamicSqlSource"><a href="#DynamicSqlSource" class="headerlink" title="DynamicSqlSource"></a>DynamicSqlSource</h2><p><code>DynamicSqlSource</code>è´Ÿè´£è§£æåŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„<code>Sqlource</code>å®ç°ä¹‹ä¸€ã€‚<code>SqlNode</code>ä¸­ä½¿ç”¨äº†ç»„åˆæ¨¡å¼ï¼Œå½¢æˆäº†ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œ<code>DynamicSqlSource</code>ä¸­ä½¿ç”¨<code>rootSqlNode</code>å­—æ®µ(<code>SqlNode</code>ç±»å‹)è®°å½•äº†å¾…è§£æçš„<code>SqlNode</code>æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</p><p><code>DynamicSqlSource.getBoundSql()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºDynamicContextå¯¹è±¡</span></span><br><span class="line">  DynamicContext context = <span class="keyword">new</span> DynamicContext(configuration, parameterObject);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é€šè¿‡è°ƒç”¨rootSqlNode.apply()æ–¹æ³•è°ƒç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å…¨éƒ¨SqlNode.apply()æ–¹æ³•ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯ä¸ªSqlNodeçš„apply()æ–¹æ³•éƒ½å°†è§£æå¾—åˆ°çš„SQLè¯­å¥ç‰‡æ®µè¿½åŠ åˆ°contextä¸­ï¼Œ</span></span><br><span class="line">  <span class="comment">// æœ€ç»ˆé€šè¿‡context.getSql()å¾—åˆ°å®Œæ•´çš„SQLè¯­å¥</span></span><br><span class="line">  rootSqlNode.apply(context);</span><br><span class="line">  SqlSourceBuilder sqlSourceParser = <span class="keyword">new</span> SqlSourceBuilder(configuration);</span><br><span class="line">  Class&lt;?&gt; parameterType = parameterObject == <span class="keyword">null</span> ? </span><br><span class="line">    Object.class : parameterObject.getClass();</span><br><span class="line">  SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), </span><br><span class="line">                                              parameterType, context.getBindings());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆ›å»ºBoundSqlå¯¹è±¡ï¼Œå¹¶å°†DynamicContext.bindingsä¸­çš„å‚æ•°ä¿¡æ¯å¤åˆ¶åˆ°å…¶</span></span><br><span class="line">  BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">    boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/10441615985826561598582656771.png" alt="image-20200828104415997"></p><h2 id="RawSqISource"><a href="#RawSqISource" class="headerlink" title="RawSqISource"></a>RawSqISource</h2><p><code>RawSqISource</code>æ˜¯<code>SqlSource</code>çš„å¦ä¸€ä¸ªå®ç°ï¼Œå…¶é€»è¾‘ä¸<code>DynamicSqlSource</code>ç±»ä¼¼ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶æœºä¸ä¸€æ ·ï¼Œå¤„ç†çš„<code>SQL</code>è¯­å¥ç±»å‹ä¹Ÿä¸ä¸€æ ·ã€‚</p><p>å‰é¢ä»‹ç»<code>XMLScriptBuilder.parseDynamicTags()</code>æ–¹æ³•æ—¶æåˆ°è¿‡ï¼Œå¦‚æœèŠ‚ç‚¹åªåŒ…å«<code>#&#123;&#125;</code>å ä½ç¬¦ï¼Œè€Œä¸åŒ…å«åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æˆ–æœªè§£æçš„<code>$&#123;&#125;</code>å ä½ç¬¦çš„è¯ï¼Œåˆ™ä¸æ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œä¼šåˆ›å»ºç›¸åº”çš„<code>StaticTextSqlNode</code>å¯¹è±¡ã€‚</p><p>åœ¨<code>XMLScriptBuilder.parseScriptNode()</code>æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ•´ä¸ª<code>SQL</code>èŠ‚ç‚¹æ˜¯å¦ä¸ºåŠ¨æ€çš„ï¼Œå¦‚æœä¸æ˜¯åŠ¨æ€çš„<code>SQL</code>èŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºç›¸åº”çš„<code>RawSqlSource</code>å¯¹è±¡ã€‚</p><p><strong><code>RawSqlSource</code>åœ¨æ„é€ æ–¹æ³•ä¸­é¦–å…ˆä¼šè°ƒç”¨<code>getSql()</code>æ–¹æ³•ï¼Œå…¶ä¸­é€šè¿‡è°ƒç”¨<code>SqlNode.apply()</code>æ–¹æ³•å®Œæˆ<code>SQL</code>è¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥å¤„ç†ï¼›</strong>ä¹‹åä¼šä½¿ç”¨<code>SqlSourceBuilder</code>å®Œæˆå ä½ç¬¦çš„æ›¿æ¢å’Œ<code>ParameterMapping</code>é›†åˆçš„åˆ›å»ºï¼Œå¹¶è¿”å›<code>StaticSqlSource</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RawSqlSource</span> <span class="keyword">implements</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSource sqlSource;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RawSqlSource</span><span class="params">(Configuration configuration, SqlNode rootSqlNode, Class&lt;?&gt; parameterType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨getsql()æ–¹æ³•ï¼Œå®ŒæˆSQLè¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥è§£æ</span></span><br><span class="line">    <span class="keyword">this</span>(configuration, getSql(configuration, rootSqlNode), parameterType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RawSqlSource</span><span class="params">(Configuration configuration, String sql, Class&lt;?&gt; parameterType)</span> </span>&#123;</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = <span class="keyword">new</span> SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; clazz = parameterType == <span class="keyword">null</span> ? Object.class : parameterType;</span><br><span class="line">    sqlSource = sqlSourceParser.parse(sql, clazz, <span class="keyword">new</span> HashMap&lt;String, Object&gt;());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getSql</span><span class="params">(Configuration configuration, SqlNode rootSqlNode)</span> </span>&#123;</span><br><span class="line">    DynamicContext context = <span class="keyword">new</span> DynamicContext(configuration, <span class="keyword">null</span>);</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    <span class="keyword">return</span> context.getSql();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sqlSource.getBoundSql(parameterObject);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è®ºæ˜¯<code>StaticSqlSource</code>ã€<code>DynamicSqlSource</code>è¿˜æ˜¯<code>RawSqlSource</code>ï¼Œæœ€ç»ˆéƒ½ä¼šç»Ÿä¸€ç”Ÿæˆ<code>BoundSql</code>å¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†<u>å®Œæ•´çš„<code>SQL</code>è¯­å¥(å¯èƒ½åŒ…å«<code>?</code>å ä½ç¬¦)</u>ã€<u>å‚æ•°æ˜ å°„å…³ç³»(<code>parameterMappings</code>é›†åˆ)</u>ä»¥åŠ<u>ç”¨æˆ·ä¼ å…¥çš„å‚æ•°(<code>additionalParameters</code>é›†åˆ)</u>ã€‚</p><p>å¦å¤–ï¼Œ<code>DynamicSqlSource</code>è´Ÿè´£å¤„ç†åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œ<code>RawSqlSource</code>è´Ÿè´£å¤„ç†é™æ€<code>SQL</code>è¯­å¥ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ<u>ä¸¤è€…è§£æ<code>SQL</code>è¯­å¥çš„æ—¶æœºä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…çš„è§£ææ—¶æœºæ˜¯åœ¨å®é™…æ‰§è¡Œ<code>SQL</code>è¯­å¥ä¹‹å‰ï¼Œè€Œåè€…åˆ™æ˜¯åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶å®Œæˆ<code>SQL</code>è¯­å¥çš„è§£æã€‚</u></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> æ ¸å¿ƒå¤„ç†å±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ¸å¿ƒå¤„ç†å±‚-MyBatisåˆå§‹åŒ–</title>
      <link href="/blog/2020/06/22/c499e157.html"/>
      <url>/blog/2020/06/22/c499e157.html</url>
      
        <content type="html"><![CDATA[<p>æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†<code>MyBatis</code>çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»<code>MyBatis</code>çš„åˆå§‹åŒ–ã€åŠ¨æ€<code>SQL</code>è¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠ<code>SQL</code>è¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æ<code>MyBatis</code>çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£<code>MyBatis</code>çš„æ ¸å¿ƒåŸç†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622175512211_aegXOG.png" alt="image-20200622175512211"></p><blockquote><p>æœ¬ç¯‡ä»‹ç»MyBatisçš„åˆå§‹åŒ–</p></blockquote><p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¼šè¯»å–<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½é…ç½®æ–‡ä»¶æŒ‡å®šçš„ç±»ï¼Œå¤„ç†ç±»ä¸­çš„æ³¨è§£ï¼Œåˆ›å»ºä¸€äº›é…ç½®å¯¹è±¡ï¼Œæœ€ç»ˆå®Œæˆæ¡†æ¶ä¸­å„ä¸ªæ¨¡å—çš„åˆå§‹åŒ–ã€‚</p><p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>JavaAPI</code>çš„æ–¹å¼å¯¹<code>MyBatis</code>è¿›è¡Œé…ç½®ï¼Œè¿™ç§ç¡¬ç¼–ç çš„é…ç½®æ–¹å¼ä¸»è¦ç”¨åœ¨é…ç½®é‡æ¯”è¾ƒå°‘ä¸”é…ç½®ä¿¡æ¯ä¸å¸¸å˜åŒ–çš„åœºæ™¯ä¸‹ã€‚</p><h2 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h2><p>åœ¨<code>MyBatis</code>å¤„ç†<code>mybatis-config.xml</code>ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºç›¸åº”çš„é…ç½®å¯¹è±¡ï¼Œè¯¥è¿‡ç¨‹çš„è®¾è®¡ä½¿ç”¨åˆ°<strong>å»ºé€ è€…æ¨¡å¼</strong>çš„ç›¸å…³çŸ¥è¯†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622215026613_lPP12T.png" alt="image-20200622215026613"></p><p>å»ºé€ è€…æ¨¡å¼ä¸­çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š</p><ul><li><p><strong>å»ºé€ è€…(Builder)æ¥å£</strong></p><p>Builderæ¥å£ç”¨äºå®šä¹‰å»ºé€ è€…æ„å»ºäº§å“å¯¹è±¡çš„å„éƒ¨åˆ†çš„è¡Œä¸ºã€‚</p></li><li><p><strong>å…·ä½“å»ºé€ è€…(ConcreteBuilder)è§’è‰²</strong></p><p><strong>åœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„æ˜¯å…·ä½“å»ºé€ è€…ã€‚</strong>å…·ä½“å»ºé€ è€…ç±»å¿…é¡»å®ç°å»ºé€ è€…æ¥å£æ‰€è¦æ±‚çš„ä¸¤ç±»æ–¹æ³•ï¼š</p><p>ä¸€ç±»æ˜¯å»ºé€ æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„<code>buildPart1()</code>ã€<code>buildPart2()</code>ç­‰æ–¹æ³•ã€‚</p><p>å¦ä¸€ç±»æ˜¯è·å–æ„å»ºå¥½çš„äº§å“å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„<code>getProduct()</code>æ–¹æ³•ã€‚</p></li><li><p><strong>å¯¼æ¼”(Director)è§’è‰²</strong></p><p>è¯¥è§’è‰²ä¼šé€šè¿‡è°ƒç”¨å…·ä½“å»ºé€ è€…ï¼Œ åˆ›å»ºéœ€è¦çš„äº§å“å¯¹è±¡</p></li><li><p><strong>äº§å“(Product)è§’è‰²</strong></p><p>äº§å“å¯¹è±¡å°±æ˜¯ç”¨æˆ·éœ€è¦ä½¿ç”¨çš„å¤æ‚å¯¹è±¡</p></li></ul><p>å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>å»ºé€ è€…æ¨¡å¼ä¸­çš„å¯¼æ¼”è§’è‰²å¹¶ä¸éœ€è¦çŸ¥æ™“äº§å“ç±»çš„å†…éƒ¨ç»†èŠ‚ï¼Œå®ƒåªæä¾›éœ€è¦çš„ä¿¡æ¯ç»™å»ºé€ è€…ï¼Œç”±å…·ä½“å»ºé€ è€…å¤„ç†è¿™äº›ä¿¡æ¯(è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚)å¹¶å®Œæˆäº§å“æ„é€ ã€‚è¿™å°±ä½¿<strong>äº§å“å¯¹è±¡çš„ä¸Šå±‚ä»£ç ä¸äº§å“å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ã€‚</strong></li><li>å»ºé€ è€…æ¨¡å¼å°†å¤æ‚äº§å“çš„åˆ›å»ºè¿‡ç¨‹åˆ†æ•£åˆ°äº†ä¸åŒçš„æ„é€ æ­¥éª¤ä¸­ï¼Œè¿™æ ·å¯ä»¥å¯¹äº§å“åˆ›å»ºè¿‡ç¨‹å®ç°æ›´åŠ ç²¾ç»†çš„æ§åˆ¶ï¼Œä¹Ÿä¼šä½¿<strong>åˆ›å»ºè¿‡ç¨‹æ›´åŠ æ¸…æ™°ã€‚</strong></li><li>æ¯ä¸ªå…·ä½“å»ºé€ è€…éƒ½å¯ä»¥åˆ›å»ºå‡ºå®Œæ•´çš„äº§å“å¯¹è±¡ï¼Œè€Œä¸”å…·ä½“å»ºé€ è€…ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡ä¸åŒçš„å…·ä½“å»ºé€ è€…ï¼Œå¾—åˆ°ä¸åŒçš„äº§å“å¯¹è±¡ã€‚<strong>å½“æœ‰æ–°äº§å“å‡ºç°æ—¶ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„å…·ä½“å»ºé€ è€…å³å¯å®Œæˆæ‰©å±•</strong>ï¼Œè¿™ç¬¦åˆ<strong>å¼€æ”¾-å°é—­</strong>åŸåˆ™ã€‚</li></ul><p>å»ºé€ è€…æ¨¡å¼ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå®ƒæ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œ<strong>å¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚æ€§å¾ˆå¤§ï¼Œåˆ™ä¸é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼ã€‚</strong></p><p>å¦‚æœäº§å“ç§ç±»è¾ƒå¤šï¼Œä¸”å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå°±éœ€è¦å®šä¹‰å¤šä¸ªå…·ä½“å»ºé€ è€…ç±»æ¥å®ç°è¿™ç§å˜åŒ–ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå˜å¾—å¾ˆå¤æ‚ï¼Œä¸æ˜“äºç†è§£ã€‚</p><h2 id="BaseBuilder"><a href="#BaseBuilder" class="headerlink" title="BaseBuilder"></a>BaseBuilder</h2><p><code>MyBatis</code>åˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œæ˜¯åŠ è½½å¹¶è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ã€æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠç›¸å…³çš„æ³¨è§£ä¿¡æ¯ã€‚<code>MyBatis</code>çš„åˆå§‹åŒ–å…¥å£æ˜¯<code>SqlSessionFactoryBuilder.build()</code>æ–¹æ³•ï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å–é…ç½®æ–‡ä»¶</span></span><br><span class="line">    XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">    <span class="comment">// è§£æé…ç½®æ–‡ä»¶å¾—åˆ°Configurationå¯¹è±¡ï¼Œåˆ›å»ºDefaultSqlSessionFactoryå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error building SqlSession.&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      reader.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SqlSessionFactoryBuilder.build()</code>æ–¹æ³•ä¼šåˆ›å»º<code>XMLConfigBuilder</code>å¯¹è±¡æ¥è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ï¼Œè€Œ<code>XMLConfigBuilder</code>ç»§æ‰¿è‡ª<code>BaseBuilder</code>æŠ½è±¡ç±»ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/23/image-20200623160844166_VAke1q.png" alt="image-20200623160844166"></p><p><code>MyBatis</code>çš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¿™é‡Œçš„<code>BaseBuilder</code>æŠ½è±¡ç±»å°±æ‰®æ¼”ç€å»ºé€ è€…æ¥å£çš„è§’è‰²ã€‚<code>BaseBuilder</code>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationæ˜¯MyBatisåˆå§‹åŒ–è¿‡ç¨‹çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒMyBatisä¸­å‡ ä¹å…¨éƒ¨çš„é…ç½®ä¿¡æ¯éƒ½ä¼šä¿å­˜åˆ°Configurationä¸­</span></span><br><span class="line"><span class="comment">// Configurationå¯¹è±¡æ˜¯åœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­åˆ›å»ºä¸”æ˜¯å…¨å±€å”¯ä¸€çš„ï¼ˆall-in-oneé…ç½®å¯¹è±¡ï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeAliases&gt;æ ‡ç­¾å®šä¹‰åˆ«åï¼Œè¿™äº›å®šä¹‰çš„åˆ«åéƒ½ä¼šè®°å½•åœ¨</span></span><br><span class="line"><span class="comment">// TypeAliasRegistryå¯¹è±¡ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeAliasRegistry typeAliasRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeHandlers&gt;æ ‡ç­¾æ·»åŠ è‡ªå®šä¹‰TypeHandlerå™¨ï¼Œ</span></span><br><span class="line"><span class="comment">// å®ŒæˆæŒ‡å®šæ•°æ®åº“ç±»å‹ä¸Javaç±»å‹çš„è½¬æ¢ï¼Œè¿™äº›TypeHandleréƒ½ä¼šè®°å½•åœ¨TypeHandlerRegistryä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;</span><br></pre></td></tr></table></figure><p><code>BaseBuilder</code>ä¸­è®°å½•çš„<code>TypeAliasRegistry</code>å¯¹è±¡å’Œ<code>TypeHandlerRegistry</code>å¯¹è±¡ï¼Œå…¶å®æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨<code>Configuration</code>å¯¹è±¡åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ã€‚</p><p><code>Configuration</code>ç±»ä¸­å®šä¹‰äº†è¿™ä¸¤ä¸ªå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeHandlerRegistry typeHandlerRegistry = <span class="keyword">new</span> TypeHandlerRegistry();</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeAliasRegistry typeAliasRegistry = <span class="keyword">new</span> TypeAliasRegistry();</span><br></pre></td></tr></table></figure><p>åœ¨<code>BaseBuilder</code>æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡ç›¸åº”çš„<code>Configuration.get*()</code>æ–¹æ³•å¾—åˆ°<code>TypeAliasRegistry</code>å¯¹è±¡å’Œ<code>TypeHandlerRegistry</code>å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™<code>BaseBuilder</code>ç›¸åº”å­—æ®µã€‚</p><p><code>BaseBuilder.resolveAlias()</code>æ–¹æ³•ä¾èµ–<code>TypeAliasRegistry</code>è§£æåˆ«åï¼Œ<code>BaseBuilder.resolveTypeHandler()</code>æ–¹æ³•ä¾èµ–<code>TypeHandlerRegistry</code>æŸ¥æ‰¾æŒ‡å®šçš„<code>TypeHandler</code>å¯¹è±¡ã€‚</p><p><code>MyBatis</code>ä½¿ç”¨<code>JdbcType</code>æšä¸¾ç±»å‹è¡¨ç¤º<code>JDBC</code>ç±»å‹ã€‚<code>MyBatis</code>ä¸­å¸¸ç”¨çš„æšä¸¾ç±»å‹è¿˜æœ‰<code>ResultSetType</code>å’Œ<code>ParameterMode:ResultSetType</code>æšä¸¾ç±»å‹è¡¨ç¤ºç»“æœé›†ç±»å‹ï¼Œä½¿ç”¨<code>ParameterMode</code>æšä¸¾ç±»å‹è¡¨ç¤ºå­˜å‚¨è¿‡ç¨‹ä¸­çš„å‚æ•°ç±»å‹ã€‚</p><p>åœ¨<code>BaseBuilder</code>ä¸­æä¾›äº†ç›¸åº”çš„<code>resolveJdbcType()</code>ã€<code>resolveResultSetType()</code>ã€<code>resolveParameterMode()</code>æ–¹æ³•ï¼Œå°†<code>String</code>è½¬æ¢æˆå¯¹åº”çš„æšä¸¾å¯¹è±¡ã€‚</p><h2 id="XMLConfigBuilder"><a href="#XMLConfigBuilder" class="headerlink" title="XMLConfigBuilder"></a>XMLConfigBuilder</h2><p><code>XMLConfigBuilder</code>æ˜¯<code>BaseBuilder</code>çš„ä¼—å¤šå­ç±»ä¹‹ä¸€ï¼Œå®ƒæ‰®æ¼”çš„æ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚**<code>XMLConfigBuilder</code>ä¸»è¦è´Ÿè´£è§£æ<code>mybatis-config.xml</code>é…ç½®ã€‚**</p><p>æ ¸å¿ƒå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ‡è¯†æ˜¯å¦å·²ç»è§£æè¿‡mybatis-config.xmlæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> parsed;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºè§£æmybatis-config.xmlé…ç½®æ–‡ä»¶çš„XpathParserå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> XPathParser parser;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è¯† &lt;environment&gt; é…ç½®çš„åç§°ï¼Œ é»˜è®¤è¯»å–&lt;environment&gt;æ ‡ç­¾çš„é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">private</span> String environment;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£åˆ›å»ºå’Œç¼“å­˜Reflectorå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory localReflectorFactory = <span class="keyword">new</span> DefaultReflectorFactory();</span><br></pre></td></tr></table></figure><p><code>XMLConfigBuilder.parse()</code>æ–¹æ³•æ˜¯è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶çš„å…¥å£ï¼Œå®ƒé€šè¿‡è°ƒç”¨<code>XMLConfigBuilder.parseConfiguration()</code>æ–¹æ³•å®ç°æ•´ä¸ªè§£æè¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Configuration <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®parsedå˜é‡çš„å€¼åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆäº†å¯¹mybatis-config.xmlé…ç½®æ–‡ä»¶çš„è§£æ</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ° configuration èŠ‚ç‚¹ï¼Œå¼€å§‹è§£æ</span></span><br><span class="line">  parseConfiguration(parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));</span><br><span class="line">  <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è§£æpropertiesèŠ‚ç‚¹</span></span><br><span class="line">    propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">    <span class="comment">// è§£æsettingsèŠ‚ç‚¹</span></span><br><span class="line">    Properties settings = settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">    loadCustomVfs(settings);</span><br><span class="line">    typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">    pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">    objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">    objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">    reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">    settingsElement(settings);</span><br><span class="line">    <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">    environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">    databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">    typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">    mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;properties&gt;</code>èŠ‚ç‚¹</strong></p><p><code>XMLConfigBuilder.propertiesElement()</code>æ–¹æ³•ä¼šè§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­çš„<code>properties</code>èŠ‚ç‚¹å¹¶å½¢æˆ<code>java.util.Properties</code>å¯¹è±¡ï¼Œä¹‹åå°†è¯¥<code>Properties</code>å¯¹è±¡è®¾ç½®åˆ°<code>XPathParser</code>å’Œ<code>Configuration</code>çš„<code>variables</code>å­—æ®µä¸­ã€‚åœ¨åé¢çš„è§£æè¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨è¯¥<code>Properties</code>å¯¹è±¡ä¸­çš„ä¿¡æ¯æ›¿æ¢å ä½ç¬¦ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">propertiesElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è§£æ&lt;properties&gt;çš„å­èŠ‚ç‚¹ï¼ˆ&lt;property&gt;æ ‡ç­¾ï¼‰çš„nameå’Œvalueå±æ€§ï¼Œ å¹¶è®°å½•åˆ°Propertiesä¸­</span></span><br><span class="line">    Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// è§£æ&lt;properties&gt;çš„resourceå’Œurlå±æ€§ï¼Œè¿™ä¸¤ä¸ªå±æ€§ç”¨äºç¡®å®špropertiesé…ç½®æ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line">    String resource = context.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">    String url = context.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    <span class="comment">// resourceå’Œurlå±æ€§ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">    Properties vars = configuration.getVariables();</span><br><span class="line">    <span class="keyword">if</span> (vars != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°XPathParserå’ŒConfigurationçš„variableså­—æ®µ</span></span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;settings&gt;</code>èŠ‚ç‚¹</strong></p><p><code>XMLConfigBuilder.settingsAsProperties()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>settings</code>èŠ‚ç‚¹ï¼Œåœ¨<code>settings</code>ç‚¹ä¸‹çš„é…ç½®æ˜¯<code>MyBatis</code>å…¨å±€æ€§çš„é…ç½®ï¼Œå®ƒä»¬ä¼šæ”¹å˜<code>MyBatis</code>çš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œè¿™äº›å…¨å±€é…ç½®ä¿¡æ¯éƒ½ä¼šè¢«è®°å½•åˆ°<code>Configuration</code>å¯¹è±¡çš„å¯¹åº”å±æ€§ä¸­ã€‚</p><p>ä¾‹å¦‚ï¼šå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é…ç½®<code>autoMappingBehavior</code>ä¿®æ”¹<code>MyBatis</code>æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„çš„åŠŸèƒ½ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">&lt;!- autoMappingBehavioré…ç½®é¡¹ æ˜¯å†³ å®šMyBatisæ˜¯å¦å¹µ å¯ è‡ªåŠ¨ æ˜ å°„åŠŸèƒ½çš„æ¡ ä»¶ä¹‹ä¸€ --&gt; </span><br><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;autoMappingBehavior&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PARTIAL&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>Configuration</code>ä¸­å­˜åœ¨ä¸€ä¸ªåŒåçš„ç›¸åº”å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> AutoMappingBehavior autoMappingBehavior = AutoMappingBehavior.PARTIAL;</span><br></pre></td></tr></table></figure><p><code>settingsAsProperties()</code>æ–¹æ³•çš„è§£ææ–¹å¼ä¸<code>propertiesElement()</code>æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯å¤šäº†ä½¿ç”¨<code>MetaClass</code>æ£€æµ‹<code>key</code>æŒ‡å®šçš„å±æ€§åœ¨<code>Configuration</code>ç±»ä¸­æ˜¯å¦æœ‰å¯¹åº”<code>setter</code>æ–¹æ³•çš„æ­¥éª¤ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">settingsAsProperties</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Properties();</span><br><span class="line">  &#125;</span><br><span class="line">  Properties props = context.getChildrenAsProperties();</span><br><span class="line">  <span class="comment">// Check that all settings are known to the configuration class</span></span><br><span class="line">  <span class="comment">// åˆ›å»º Configuration å¯¹åº”çš„MetaClasså¯¹è±¡</span></span><br><span class="line">  MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ£€æµ‹Configurationä¸­æ˜¯å¦å®šä¹‰äº†keyæŒ‡å®šå±æ€§ç›¸åº”çš„setteræ–¹æ³•</span></span><br><span class="line">  <span class="keyword">for</span> (Object key : props.keySet()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;typeAliases&gt;</code>ã€<code>&lt;typeHandlers&gt;</code>èŠ‚ç‚¹</strong></p><p><code>XMLConfigBuilder.typeAliasesElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>typeAliases</code>èŠ‚ç‚¹ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡<code>TypeAliasRegistry</code>å®Œæˆåˆ«åçš„æ³¨å†Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeAliasesElement</span><span class="params">(XNode parent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// å¤„ç†å…¨éƒ¨å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123; <span class="comment">// å¤„ç†packageèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// è·å–æŒ‡å®šåŒ…å</span></span><br><span class="line">        String typeAliasPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡TypeAliasRegistryæ‰«ææŒ‡å®šåŒ…ä¸­æ‰€æœ‰çš„ç±»ï¼Œå¹¶è§£æ@Aliasæ³¨è§£ï¼Œå®Œæˆåˆ«åæ³¨å†Œ</span></span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¤„ç†typeAliasèŠ‚ç‚¹</span></span><br><span class="line">        String alias = child.getStringAttribute(<span class="string">&quot;alias&quot;</span>); <span class="comment">// è·å–æŒ‡å®šåˆ«å</span></span><br><span class="line">        String type = child.getStringAttribute(<span class="string">&quot;type&quot;</span>); <span class="comment">// è·å–åˆ«åå¯¹åº”çš„ç±»å‹</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">          <span class="keyword">if</span> (alias == <span class="keyword">null</span>) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz); <span class="comment">// æ‰«æ@Aliasæ³¨è§£ï¼Œå®Œæˆæ³¨å†Œ</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz); <span class="comment">// æ³¨å†Œåˆ«å</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>XMLConfigBuilder.typeHandlerElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>typeHandlers</code>èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡<code>TypeHandlerRegistry</code>å¯¹è±¡å®Œæˆ<code>TypeHandler</code>çš„æ³¨å†Œï¼Œè¯¥æ–¹æ³•çš„å®ç°ä¸<code>typeAliasesElement()</code>æ–¹æ³•ç±»ä¼¼ã€‚</p><p><strong>è§£æ<code>&lt;plugins&gt;</code>èŠ‚ç‚¹</strong></p><p>æ’ä»¶æ˜¯<code>MyBatis</code>æä¾›çš„æ‰©å±•æœºåˆ¶ä¹‹ä¸€ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰æ’ä»¶åœ¨<code>SQL</code>è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸€ç‚¹è¿›è¡Œæ‹¦æˆªã€‚</p><p><code>MyBatis</code>ä¸­çš„è‡ªå®šä¹‰æ’ä»¶åªéœ€å®ç°<code>Interceptor</code>æ¥å£ï¼Œå¹¶é€šè¿‡æ³¨è§£æŒ‡å®šæƒ³è¦æ‹¦æˆªçš„æ–¹æ³•ç­¾åå³å¯ã€‚è¿™é‡Œåˆ†æMyBatisä¸­å¦‚ä½•åŠ è½½å’Œç®¡ç†æ’ä»¶ã€‚<br><code>XMLConfigBuilder.pluginElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>plugins</code>èŠ‚ç‚¹ä¸­å®šä¹‰çš„æ’ä»¶ï¼Œå¹¶å®Œæˆå®ä¾‹åŒ–å’Œé…ç½®æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      <span class="comment">// è·å–pluginèŠ‚ç‚¹çš„interceptorå±æ€§</span></span><br><span class="line">      String interceptor = child.getStringAttribute(<span class="string">&quot;interceptor&quot;</span>);</span><br><span class="line">      <span class="comment">// è·å–pluginèŠ‚ç‚¹ä¸‹çš„propertiesé…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡</span></span><br><span class="line">      Properties properties = child.getChildrenAsProperties();</span><br><span class="line">      <span class="comment">// é€šè¿‡TypeAliasRegistryè§£æåˆ«åä¹‹åï¼Œå®ä¾‹åŒ–Interceptorå¯¹è±¡</span></span><br><span class="line">      Interceptor interceptorInstance </span><br><span class="line">        = (Interceptor) resolveClass(interceptor).newInstance();</span><br><span class="line">      <span class="comment">// è®¾ç½®Interceptorçš„å±æ€§</span></span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">      <span class="comment">// è®°å½•Interceptorå¯¹è±¡</span></span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰é…ç½®çš„<code>Interceptor</code>å¯¹è±¡éƒ½æ˜¯é€šè¿‡<code>Configuration.interceptorChain</code>å­—æ®µ(<code>InterceptorChain</code>ç±»å‹)ç®¡ç†çš„ï¼Œ<code>InterceptorChain</code>åº•å±‚ä½¿ç”¨<code>ArrayList&lt;Interceptor&gt;</code>å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;Interceptor&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">pluginAll</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Interceptor interceptor : interceptors) &#123;</span><br><span class="line">      target = interceptor.plugin(target);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptor</span><span class="params">(Interceptor interceptor)</span> </span>&#123;</span><br><span class="line">    interceptors.add(interceptor);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Interceptor&gt; <span class="title">getInterceptors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableList(interceptors);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;objectFactory&gt;</code>èŠ‚ç‚¹</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰<code>Objectory</code>å®ç°ç±»ã€<code>ObjectWrapperFactory</code>å®ç°ç±»ä»¥åŠ<code>ReflectorFactory</code>å®ç°ç±»å¯¹<code>MyBatis</code>è¿›è¡Œæ‰©å±•ã€‚<br><code>XMLConfigBuilder.objectFactoryElement()</code>æ–¹æ³•è´Ÿè´£è§£æå¹¶å®ä¾‹åŒ–<code>&lt;objectFactory&gt;</code>èŠ‚ç‚¹æŒ‡å®šçš„<code>ObjectFactory</code>å®ç°ç±»ï¼Œä¹‹åå°†è‡ªå®šä¹‰çš„<code>ObjectFactory</code>å¯¹è±¡è®°å½•åˆ°<code>Configuration.objectFactory</code>å­—æ®µä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">objectFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–&lt;objectFactory&gt;èŠ‚ç‚¹çš„typeå±æ€§</span></span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line"><span class="comment">// è·å–&lt;ObjectFactory&gt;èŠ‚ç‚¹ä¸‹é…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡</span></span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// è¿›è¡Œåˆ«åè§£æåï¼Œå®ä¾‹åŒ–è‡ªå®šä¹‰ObjectFactoryå®ç°</span></span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).newInstance();</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå®šä¹‰ObjectFactoryå±æ€§ï¼Œ å®Œæˆåˆå§‹åŒ–ç›¸å…³æ“ä½œ</span></span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    <span class="comment">// å°†è‡ªå®šä¹‰ObjectFactoryå¯¹è±¡è®°å½•åˆ°Configurationå¯¹è±¡çš„ObjectFactoryå­—æ®µä¸­ï¼Œå¾…åç»­ä½¿ç”¨</span></span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>XMLConfigBuilder</code>å¯¹<code>&lt;objectWrapperFactory&gt;</code>èŠ‚ç‚¹ã€<code>&lt;reflectorFactory&gt;</code>èŠ‚ç‚¹çš„è§£æä¸ä¸Šè¿°è¿‡ç¨‹ç±»ä¼¼ï¼Œæœ€ç»ˆä¼šå°†è§£æå¾—åˆ°çš„è‡ªå®šä¹‰å¯¹è±¡è®°å½•åˆ°<code>Configuration</code>çš„ç›¸åº”å­—æ®µä¸­ã€‚</p><p><strong>è§£æ<code>&lt;environments&gt;</code>èŠ‚ç‚¹</strong></p><p>åœ¨å®é™…ç”Ÿäº§ä¸­ï¼ŒåŒä¸€é¡¹ç›®å¯èƒ½åˆ†ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§å¤šä¸ªä¸åŒçš„ç¯å¢ƒï¼Œæ¯ä¸ªç¯å¢ƒçš„é…ç½®å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒã€‚</p><p><code>MyBatis</code>å¯ä»¥é…ç½®å¤šä¸ª<code>&lt;environment&gt;</code>èŠ‚ç‚¹ï¼Œæ¯ä¸ª<code>&lt;environment&gt;</code>èŠ‚ç‚¹å¯¹åº”ä¸€ç§ç¯å¢ƒçš„é…ç½®ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡å¯ä»¥é…ç½®å¤šä¸ªç¯å¢ƒï¼Œæ¯ä¸ª<code>SqlSessionFactory</code>å®ä¾‹åªèƒ½é€‰æ‹©å…¶ä¸€ã€‚</p><p><code>XMLConfigBuilder.environmentsElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;environments&gt;</code>çš„ç›¸å…³é…ç½®ï¼Œå®ƒä¼šæ ¹æ®<code>XMLConfigBuilder.environment</code>å­—æ®µå€¼ç¡®å®šè¦ä½¿ç”¨çš„<code>&lt;environment&gt;</code>é…ç½®ï¼Œä¹‹ååˆ›å»ºå¯¹åº”çš„<code>TransactionFactory</code>å’Œ<code>DataSource</code>å¯¹è±¡ï¼Œå¹¶å°è£…è¿›<code>Environment</code>å¯¹è±¡ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æœªæŒ‡å®š XMLConfigBuilder.environment å­—æ®µï¼Œåˆ™ä½¿ç”¨defaultå±æ€§æŒ‡å®šçš„&lt;environment&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">      environment = context.getStringAttribute(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id = child.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">        TransactionFactory txFactory </span><br><span class="line">          = transactionManagerElement(child.evalNode(<span class="string">&quot;transactionManager&quot;</span>));</span><br><span class="line">        DataSourceFactory dsFactory = dataSourceElement(child.evalNode(<span class="string">&quot;dataSource&quot;</span>));</span><br><span class="line">        DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">        Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.Builder(id)</span><br><span class="line">          .transactionFactory(txFactory)</span><br><span class="line">          .dataSource(dataSource);</span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;databaseldProvider&gt;</code>èŠ‚ç‚¹</strong></p><p><code>MyBatis</code>ä¸èƒ½åƒ<code>Hibernate</code>é‚£æ ·ï¼Œç›´æ¥å¸®åŠ©å¼€å‘äººå‘˜å±è”½å¤šç§æ•°æ®åº“äº§å“åœ¨<code>SQL</code>è¯­è¨€æ”¯æŒæ–¹é¢çš„å·®å¼‚ã€‚</p><p>ä½†æ˜¯åœ¨<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡<code>&lt;databaseIdProvider&gt;</code>å®šä¹‰æ‰€æœ‰æ”¯æŒçš„æ•°æ®åº“äº§å“çš„<code>databaseld</code>,ç„¶ååœ¨æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰<code>SQL</code>è¯­å¥èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡<code>databaseld</code>æŒ‡å®šè¯¥<code>SQL</code>è¯­å¥åº”ç”¨çš„æ•°æ®åº“äº§å“ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p><p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®å‰é¢ç¡®å®šçš„<code>DataSource</code>ç¡®å®šå½“å‰ä½¿ç”¨çš„æ•°æ®åº“äº§å“ï¼Œç„¶ååœ¨è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼ŒåŠ è½½ä¸å¸¦<code>databaseld</code>å±æ€§å’Œå¸¦æœ‰åŒ¹é…å½“å‰æ•°æ®åº“<code>databaseld</code>å±æ€§çš„æ‰€æœ‰SQLè¯­å¥ã€‚å¦‚æœåŒæ—¶æ‰¾åˆ°å¸¦æœ‰<code>databaseld</code>å’Œä¸å¸¦<code>databaseld</code>çš„ç›¸åŒè¯­å¥ï¼Œåˆ™åè€…ä¼šè¢«èˆå¼ƒï¼Œä½¿ç”¨å‰è€…ã€‚</p><p><code>XMLConfigBuilder.databaseIdProviderElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;databaseIdProvider&gt;</code>èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºæŒ‡å®šçš„<code>DatabaseldProvider</code>å¯¹è±¡ã€‚<code>DatabaseldProvider</code>ä¼šè¿”å›<code>databaseld</code>å€¼ï¼Œ<code>MyBatis</code>ä¼šæ ¹æ®<code>databaseld</code>é€‰æ‹©åˆé€‚çš„<code>SQL</code>è¿›è¡Œæ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">databaseIdProviderElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  DatabaseIdProvider databaseIdProvider = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">    <span class="comment">// awful patch to keep backward compatibility</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;VENDOR&quot;</span>.equals(type)) &#123;</span><br><span class="line">      type = <span class="string">&quot;DB_VENDOR&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// åˆ›å»ºDatabaseIdProviderå¯¹è±¡</span></span><br><span class="line">    databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance();</span><br><span class="line">    <span class="comment">// é…ç½®DatabaseIdProviderï¼Œå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    databaseIdProvider.setProperties(properties);</span><br><span class="line">  &#125;</span><br><span class="line">  Environment environment = configuration.getEnvironment();</span><br><span class="line">  <span class="keyword">if</span> (environment != <span class="keyword">null</span> &amp;&amp; databaseIdProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡å‰é¢ç¡®å®šçš„DataSourceè·å–databaseldï¼Œå¹¶è®°å½•åˆ°Configuration.databaseldå­—æ®µä¸­</span></span><br><span class="line">    String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource());</span><br><span class="line">    configuration.setDatabaseId(databaseId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MyBatis</code>æä¾›çš„<code>DatabaseldProvider</code>æ¥å£åŠå…¶å®ç°æ¯”è¾ƒç®€å•ã€‚</p><p><code>DatabaseldProvider</code>æ¥å£çš„æ ¸å¿ƒæ–¹æ³•æ˜¯<code>getDatabaseId()</code>æ–¹æ³•ï¼Œå®ƒä¸»è¦è´Ÿè´£é€šè¿‡ç»™å®šçš„<code>DataSource</code>æ¥æŸ¥æ‰¾å¯¹åº”çš„<code>databaseld</code>ã€‚</p><blockquote><p><code>MyBatis</code>æä¾›äº†<code>VendorDatabaseldProvider</code>å’Œ<code>DefaukDatabaseldProvider</code>ä¸¤ä¸ªå®ç°ï¼Œå…¶ä¸­<code>DefaultDatabaseldProvider</code>å·±è¿‡æ—¶ã€‚</p></blockquote><p><code>VendorDatabaseIdProvider.getDatabaseId()</code>æ–¹æ³•åœ¨æ¥æ”¶åˆ°<code>DataSource</code>å¯¹è±¡æ—¶ï¼Œä¼šå…ˆè§£æ<code>DataSource</code>æ‰€è¿æ¥çš„æ•°æ®åº“äº§å“åç§°ï¼Œä¹‹åæ ¹æ®<code>&lt;databaseIdProvider&gt;</code>èŠ‚ç‚¹é…ç½®çš„æ•°æ®åº“äº§å“åç§°ä¸<code>databaseld</code>çš„å¯¹åº”å…³ç³»ç¡®å®šæœ€ç»ˆçš„<code>databaseld</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDatabaseName</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æDataSourceè¿æ¥çš„æ•°æ®åº“äº§å“çš„åç§°</span></span><br><span class="line">  String productName = getDatabaseProductName(dataSource);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; property : properties.entrySet()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (productName.contains((String) property.getKey())) &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) property.getValue();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no match, return null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> productName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDatabaseProductName</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  Connection con = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    con = dataSource.getConnection();</span><br><span class="line">    DatabaseMetaData metaData = con.getMetaData();</span><br><span class="line">    <span class="keyword">return</span> metaData.getDatabaseProductName();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        con.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="comment">// ignored</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ<code>&lt;mappers&gt;</code>èŠ‚ç‚¹</strong></p><p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œé™¤äº†åŠ è½½<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½å…¨éƒ¨çš„æ˜ å°„é…ç½®æ–‡ä»¶ï¼Œ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­çš„<code>&lt;mappers&gt;</code>èŠ‚ç‚¹ä¼šå‘Šè¯‰<code>MyBatis</code>å»å“ªäº›ä½ç½®æŸ¥æ‰¾æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠä½¿ç”¨äº†é…ç½®æ³¨è§£æ ‡è¯†çš„æ¥å£ã€‚<br><code>XMLConfigBuilder.mapperElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;mappers&gt;</code>èŠ‚ç‚¹ï¼Œå®ƒä¼šåˆ›å»º<code>XMLMapperBuilder</code>å¯¹è±¡åŠ è½½æ˜ å°„æ–‡ä»¶ï¼Œå¦‚æœæ˜ å°„é…ç½®æ–‡ä»¶å­˜åœ¨ç›¸åº”çš„<code>Mapper</code>æ¥å£ï¼Œä¹Ÿä¼šåŠ è½½ç›¸åº”çš„<code>Mapper</code>æ¥å£ï¼Œè§£æå…¶ä¸­çš„æ³¨è§£å¹¶å®Œæˆå‘<code>MapperRegistry</code>çš„æ³¨å†Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// å¤„ç†&lt;mappers&gt;çš„å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;<span class="comment">// &lt;package&gt;å­èŠ‚ç‚¹</span></span><br><span class="line">        String mapperPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‰«ææŒ‡å®šçš„åŒ…ï¼Œå¹¶å‘MapperRegistryæ³¨å†ŒMapperæ¥å£</span></span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è· å–&lt;mapper&gt;èŠ‚ç‚¹çš„resourceã€urlã€classå±æ€§ï¼Œè¿™ä¸‰ä¸ªå±æ€§äº’æ–¥</span></span><br><span class="line">        String resource = child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        String url = child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        String mapperClass = child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†resourceæˆ–æ˜¯urlå±æ€§ï¼Œåˆ™åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// å¹¶é€šè¿‡è¯¥å¯¹è±¡è§£æresourceæˆ–æ˜¯urlå±æ€§æŒ‡å®šçš„Mapperé…ç½®æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">          InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">          <span class="comment">// åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line">          XMLMapperBuilder mapperParser = </span><br><span class="line">            <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource,</span><br><span class="line">                                 configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">          <span class="comment">// åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line">          XMLMapperBuilder mapperParser = </span><br><span class="line">            <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, </span><br><span class="line">                                 configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†classå±æ€§ï¼Œåˆ™å‘MapperRegistryæ³¨å†Œè¯¥Mapperæ¥å£</span></span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="XMLMapperBuilder"><a href="#XMLMapperBuilder" class="headerlink" title="XMLMapperBuilder"></a>XMLMapperBuilder</h2><p>é€šè¿‡å¯¹<code>XMLConfigBuilder.mapperElement()</code>æ–¹æ³•çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œ<code>XMLMapperBuilder</code>è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ï¼Œå®ƒç»§æ‰¿äº†<code>BaseBuilder</code>æŠ½è±¡ç±»ï¼Œä¹Ÿæ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚<code>XMLMapperBuilder.parse()</code>æ–¹æ³•æ˜¯è§£ææ˜ å°„æ–‡ä»¶çš„å…¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²åŠ è½½è¿‡è¯¥æ˜ å°„æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">    <span class="comment">// å°†resourceæ·»åŠ åˆ°Configurationâ€¢loadedResourcesé›†åˆä¸­ä¿å­˜ï¼Œå®ƒæ˜¯HashSet&lt;String&gt;</span></span><br><span class="line">    <span class="comment">// ç±»å‹çš„é›†åˆï¼Œå…¶ä¸­è®°å½•äº†å·²ç»åŠ æ ½è¿‡çš„æ˜ å°„æ–‡ä»¶ã€‚</span></span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;resultMap&gt;èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;cache-ref&gt;èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„SQLè¯­å¥èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>XMLMapperBuilder</code>ä¹Ÿæ˜¯å°†æ¯ä¸ªèŠ‚ç‚¹çš„è§£æè¿‡ç¨‹å°è£…æˆäº†ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•ç”±<code>XMLMapperBuilder.configurationElement()</code>æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configurationElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    String namespace = context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (namespace == <span class="keyword">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">    cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">    cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">    parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">    resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">    sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line">    buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>1. è§£æ<code>&lt;cache&gt;</code>èŠ‚ç‚¹</strong></p><p><code>MyBatis</code>æ‹¥æœ‰éå¸¸å¼ºå¤§çš„äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œé…ç½®ï¼Œ**<code>MyBatis</code>é»˜è®¤æƒ…**<br><strong>å†µä¸‹æ²¡æœ‰å¼€å¯äºŒçº§ç¼“å­˜ï¼Œå¦‚æœè¦ä¸ºæŸå‘½åç©ºé—´å¼€å¯äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ç›¸åº”æ˜ å°„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ <code>&lt;cache&gt;</code>èŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥é€šè¿‡é…ç½®<code>&lt;cache&gt;</code>èŠ‚ç‚¹çš„ç›¸å…³å±æ€§ï¼Œä¸ºäºŒçº§ç¼“å­˜é…ç½®ç›¸åº”çš„ç‰¹æ€§(æœ¬è´¨ä¸Šå°±æ˜¯æ·»åŠ ç›¸åº”çš„è£…é¥°å™¨)ã€‚</strong></p><p><code>XMLMapperBuilder.cacheElement()</code>æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æ<code>&lt;cache&gt;</code>èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;PERPETUAL&quot;</span>);</span><br><span class="line">    Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);</span><br><span class="line">    String eviction = context.getStringAttribute(<span class="string">&quot;eviction&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">    Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);</span><br><span class="line">    Long flushInterval = context.getLongAttribute(<span class="string">&quot;flushInterval&quot;</span>);</span><br><span class="line">    Integer size = context.getIntAttribute(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> readWrite = !context.getBooleanAttribute(<span class="string">&quot;readOnly&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> blocking = context.getBooleanAttribute(<span class="string">&quot;blocking&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    Properties props = context.getChildrenAsProperties();</span><br><span class="line">    builderAssistant.useNewCache(</span><br><span class="line">      typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MapperBuilderAssistant</code>æ˜¯ä¸€ä¸ªè¾…åŠ©ç±»ï¼Œå…¶<code>useNewCache()</code>æ–¹æ³•è´Ÿè´£åˆ›å»º<code>Cache</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>Configuration.caches</code>é›†åˆä¸­ä¿å­˜ã€‚</p><p><code>Configuration</code>ä¸­çš„<code>caches</code>å­—æ®µæ˜¯<code>StrictMap&lt;Cache&gt;</code>ç±»å‹çš„å­—æ®µï¼Œå®ƒè®°å½•<code>Cache</code>çš„id(é»˜è®¤æ˜¯æ˜ å°„æ–‡ä»¶çš„<code>namespace</code>)ä¸<code>Cache</code>å¯¹è±¡(äºŒçº§ç¼“å­˜)ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><p><code>StrictMap</code>ç»§æ‰¿äº†<code>HashMap</code>,å¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†å°‘è®¸ä¿®æ”¹ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨<code>StrictMap.put()</code>æ–¹æ³•ï¼Œå¦‚æœæ£€æµ‹åˆ°é‡å¤çš„<code>key</code>åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰é‡å¤çš„<code>key</code>åˆ™æ·»åŠ <code>key</code>ä»¥åŠ<code>value</code>ï¼ŒåŒæ—¶ä¼šæ ¹æ®<code>key</code>äº§ç”Ÿ<code>shortKey</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(String key, V value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (containsKey(key)) &#123; <span class="comment">// å¦‚æœå·²ç»åŒ…å«äº†è¯¥keyï¼Œåˆ™ç›´æ¥è¿”å›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(name + <span class="string">&quot; already contains value for &quot;</span> + key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (key.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§å°†keyåˆ‡åˆ†æˆæ•°ç»„ï¼Œå¹¶å°†æ•°ç»„çš„æœ€åä¸€é¡¹ä½œä¸ºshortKey</span></span><br><span class="line">    <span class="keyword">final</span> String shortKey = getShortName(key);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.get(shortKey) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸åŒ…å«æŒ‡å®šçš„sortKeyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹</span></span><br><span class="line">      <span class="keyword">super</span>.put(shortKey, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœshortKeyå·²å­˜åœ¨ï¼Œåˆ™å°†valueä¿®æ”¹æˆAmbiguityå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">super</span>.put(shortKey, (V) <span class="keyword">new</span> Ambiguity(shortKey));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value); <span class="comment">// å¦‚æœä¸åŒ…å«è¯¥keyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Ambiguity</code>æ˜¯<code>StrictMap</code>ä¸­å®šä¹‰çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å­˜åœ¨<strong>äºŒä¹‰æ€§çš„é”®å€¼å¯¹</strong>ã€‚<code>Ambiguity</code>ä¸­ä½¿ç”¨<code>subject</code>å­—æ®µè®°å½•äº†å­˜åœ¨äºŒä¹‰æ€§çš„<code>key</code>ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„<code>getter</code>æ–¹æ³•ã€‚</p><p><code>StrictMap.get()</code>æ–¹æ³•ä¼šæ£€æµ‹<code>value</code>æ˜¯å¦å­˜åœ¨ä»¥åŠ<code>value</code>æ˜¯å¦ä¸º<code>Ambiguity</code>ç±»å‹å¯¹è±¡ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  V value = <span class="keyword">super</span>.get(key);</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœkeyæ²¡æœ‰å¯¹åº”çš„valueï¼Œå°±æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Ambiguity) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MapperBuilderAssistant. useNewCache()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Class&lt;? extends Cache&gt; evictionClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Long flushInterval,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Integer size,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> readWrite,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> blocking,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Properties props)</span> </span>&#123;</span><br><span class="line">  Cache cache = <span class="keyword">new</span> CacheBuilder(currentNamespace)</span><br><span class="line">    .implementation(valueOrDefault(typeClass, PerpetualCache.class))</span><br><span class="line">    .addDecorator(valueOrDefault(evictionClass, LruCache.class))</span><br><span class="line">    .clearInterval(flushInterval)</span><br><span class="line">    .size(size)</span><br><span class="line">    .readWrite(readWrite)</span><br><span class="line">    .blocking(blocking)</span><br><span class="line">    .properties(props)</span><br><span class="line">    .build();</span><br><span class="line">  configuration.addCache(cache);</span><br><span class="line">  currentCache = cache;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheBuilder</code>æ˜¯<code>Cache</code>çš„å»ºé€ è€…ï¼Œå…¶å­—æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯¹åº”çš„æ˜¯æ˜ å°„æ–‡ä»¶ä¸­é…ç½®çš„namespace</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"><span class="comment">// Cacheå¯¹è±¡çš„çœŸæ­£å®ç°ç±»</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends Cache&gt; implementation;</span><br><span class="line"><span class="comment">// è£…é¥°å™¨é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Cache&gt;&gt; decorators;</span><br><span class="line"><span class="comment">// ç¼“å­˜å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> Integer size;</span><br><span class="line"><span class="comment">// æ¸…ç†æ—¶é—´å‘¨æœŸ</span></span><br><span class="line"><span class="keyword">private</span> Long clearInterval;</span><br><span class="line"><span class="comment">// æ˜¯å¦å¯è¯»å†™</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> readWrite;</span><br><span class="line"><span class="comment">// å…¶ä»–é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> Properties properties;</span><br><span class="line"><span class="comment">// æ˜¯å¦é˜»å¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> blocking;</span><br></pre></td></tr></table></figure><p><code>CacheBuilder.build()</code>æ–¹æ³•ï¼Œæ ¹æ®<code>CacheBuilder</code>ä¸­ä¸Šè¿°å­—æ®µçš„å€¼åˆ›å»º<code>Cache</code>å¯¹è±¡å¹¶æ·»åŠ åˆé€‚çš„è£…é¥°å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setDefaultImplementations();</span><br><span class="line">  Cache cache = newBaseCacheInstance(implementation, id);</span><br><span class="line">  setCacheProperties(cache);</span><br><span class="line">  <span class="comment">// issue #352, do not apply decorators to custom caches</span></span><br><span class="line">  <span class="keyword">if</span> (PerpetualCache.class.equals(cache.getClass())) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends Cache&gt; decorator : decorators) &#123;</span><br><span class="line">      cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">      setCacheProperties(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    cache = setStandardDecorators(cache);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123;</span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheBuilder.setCacheProperties()</code>æ–¹æ³•ä¼šæ ¹æ®<code>&lt;cache&gt;</code>èŠ‚ç‚¹ä¸‹é…ç½®çš„<code>&lt;property&gt;</code>ä¿¡æ¯ï¼Œåˆå§‹åŒ–<code>Cache</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCacheProperties</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">    MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">      String name = (String) entry.getKey();</span><br><span class="line">      String value = (String) entry.getValue();</span><br><span class="line">      <span class="keyword">if</span> (metaCache.hasSetter(name)) &#123;</span><br><span class="line">        Class&lt;?&gt; type = metaCache.getSetterType(name);</span><br><span class="line">        <span class="keyword">if</span> (String.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">int</span>.class == type</span><br><span class="line">                   || Integer.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Integer.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">long</span>.class == type</span><br><span class="line">                   || Long.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Long.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">short</span>.class == type</span><br><span class="line">                   || Short.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Short.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">byte</span>.class == type</span><br><span class="line">                   || Byte.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Byte.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">float</span>.class == type</span><br><span class="line">                   || Float.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Float.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">boolean</span>.class == type</span><br><span class="line">                   || Boolean.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Boolean.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">double</span>.class == type</span><br><span class="line">                   || Double.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Double.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (InitializingObject.class.isAssignableFrom(cache.getClass()))&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ((InitializingObject) cache).initialize();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheBuilder.setStandardDecorators()</code>æ–¹æ³•ä¼šæ ¹æ®<code>CacheBuilder</code>ä¸­å„ä¸ªå­—æ®µçš„å€¼ï¼Œä¸º<code>cache</code>å¯¹è±¡æ·»åŠ å¯¹åº”çš„è£…é¥°å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Cache <span class="title">setStandardDecorators</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="keyword">null</span> &amp;&amp; metaCache.hasSetter(<span class="string">&quot;size&quot;</span>)) &#123;</span><br><span class="line">      metaCache.setValue(<span class="string">&quot;size&quot;</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clearInterval != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> ScheduledCache(cache);</span><br><span class="line">      ((ScheduledCache) cache).setClearInterval(clearInterval);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (readWrite) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> SerializedCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">    cache = <span class="keyword">new</span> SynchronizedCache(cache);</span><br><span class="line">    <span class="keyword">if</span> (blocking) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> BlockingCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹</strong></p><p><code>XMLMapperBuilder.cacheElement()</code>æ–¹æ³•ä¼šä¸ºæ¯ä¸ª<code>namespace</code>åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„<code>Cache</code>å¯¹è±¡ï¼Œå¹¶åœ¨<code>Configuration.caches</code>é›†åˆä¸­è®°å½•<code>namespace</code>ä¸<code>Cache</code>å¯¹è±¡ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><p>å¦‚æœå¸Œæœ›å¤šä¸ª<code>namespace</code>å…±ç”¨åŒä¸€ä¸ªäºŒçº§ç¼“å­˜ï¼Œå³åŒä¸€ä¸ª<code>Cache</code>å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>&lt;cache-ref&gt;</code>ç‚¹è¿›è¡Œé…ç½®ã€‚</p><blockquote><p><code>XMLMapperBuilder.cacheReffilement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹ã€‚</p></blockquote><p>è¿™é‡Œé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯<code>Configuration.cacheRefMap</code>é›†åˆï¼Œè¯¥é›†åˆæ˜¯<code>HashMap&lt;Stringï¼ŒString&gt;</code>ç±»å‹ï¼Œå…¶ä¸­<code>key</code>æ˜¯<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹æ‰€åœ¨çš„<code>namespace</code>ï¼Œ<code>value</code>æ˜¯<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹çš„<code>namespace</code>å±æ€§æ‰€æŒ‡å®šçš„<code>namespace</code>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰è€…å…±ç”¨åè€…çš„<code>Cache</code>å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾ï¼Œ<code>namespace2</code>å…±ç”¨äº†<code>namespace1</code>çš„<code>Cache</code>å¯¹è±¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/10/image-20200710104632511_3VqX9N.png" alt="image-20200710104632511"></p><p><code>XMLMapperBuilder.cacheReffilement()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheRefElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    configuration.addCacheRef(</span><br><span class="line">      builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">    CacheRefResolver cacheRefResolver = <span class="keyword">new</span> CacheRefResolver(</span><br><span class="line">      builderAssistant, context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      cacheRefResolver.resolveCacheRef();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœè§£æè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™æ·»åŠ åˆ°Configuration.incompleteCacheRefsé›†åˆï¼Œç¨åå†è§£æ</span></span><br><span class="line">      configuration.addIncompleteCacheRef(cacheRefResolver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheRefResolver</code>æ˜¯ä¸€ä¸ªç®€å•çš„<code>Cache</code>å¼•ç”¨è§£æå™¨ï¼Œå…¶ä¸­å°è£…äº†è¢«å¼•ç”¨çš„<code>namespace</code>ä»¥åŠå½“å‰<code>XMLMapperBuilder</code>å¯¹åº”çš„<code>MapperBuilderAssistant</code>å¯¹è±¡ã€‚</p><p><code>CacheRefResolver.resolveCacheRef()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>MapperBuilderAssistant.useCacheRef()</code>æ–¹æ³•ã€‚åœ¨<code>MapperBuilderAssistant.useCacheRef()</code>æ–¹æ³•ä¸­ä¼šé€šè¿‡<code>namespace</code>æŸ¥æ‰¾è¢«å¼•ç”¨çš„<code>Cache</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useCacheRef</span><span class="params">(String namespace)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (namespace == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      unresolvedCacheRef = <span class="keyword">true</span>;</span><br><span class="line">      Cache cache = configuration.getCache(namespace);</span><br><span class="line">      <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      currentCache = cache;</span><br><span class="line">      unresolvedCacheRef = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">return</span> cache;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªéœ€è¦äº†è§£çš„<code>Configuration</code>å­—æ®µæ˜¯<code>incompleteCacheRefs</code>é›†åˆï¼Œå®ƒæ˜¯<code>LinkedList&lt;CacheRefResolver&gt;</code>ç±»å‹ï¼Œå…¶ä¸­è®°å½•äº†å½“å‰è§£æå‡ºç°å¼‚å¸¸çš„<code>CacheRefResolver</code>å¯¹è±¡ã€‚</p><p><strong>3. è§£æ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹</strong></p><p><code>select</code>è¯­å¥æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†æ˜¯ä¸€å¼ <strong>äºŒç»´è¡¨</strong>ï¼Œ<u>æ°´å¹³æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€ä¸ªä¸ªå­—æ®µï¼Œå‚ç›´æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€æ¡æ¡è®°å½•</u>ã€‚</p><p>è€Œ<code>Java</code>æ˜¯é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå¯¹è±¡æ˜¯æ ¹æ®ç±»å®šä¹‰åˆ›å»ºçš„ï¼Œç±»ä¹‹é—´çš„å¼•ç”¨å…³ç³»å¯ä»¥è®¤ä¸ºæ˜¯åµŒå¥—çš„ç»“æ„ã€‚</p><p>åœ¨<code>JDBC</code>ç¼–ç¨‹ä¸­ï¼Œä¸ºäº†å°†ç»“æœé›†ä¸­çš„æ•°æ®æ˜ å°„æˆå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å†™ä»£ç ä»ç»“æœé›†ä¸­è·å–æ•°æ®ï¼Œç„¶åå°è£…æˆå¯¹åº”çš„å¯¹è±¡å¹¶è®¾ç½®å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œè¿™äº›éƒ½æ˜¯å¤§é‡çš„é‡å¤æ€§ä»£ç ã€‚</p><p>ä¸ºäº†å‡å°‘è¿™äº›é‡å¤çš„ä»£ç ï¼Œ<code>MyBatis</code>ä½¿ç”¨<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹å®šä¹‰äº†ç»“æœé›†ä¸ç»“æœå¯¹è±¡(<code>JavaBean</code>å¯¹è±¡)ä¹‹é—´çš„æ˜ å°„è§„åˆ™ï¼Œ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†çš„æ˜ å°„éœ€æ±‚ï¼Œä»è€Œå‡å°‘å¼€å‘äººå‘˜çš„é‡å¤æ€§åŠ³åŠ¨ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</p><p>æ¯ä¸ª<code>ResultMapping</code>å¯¹è±¡è®°å½•äº†ç»“æœé›†ä¸­çš„ä¸€åˆ—ä¸<code>JavaBean</code>ä¸­ä¸€ä¸ªå±æ€§ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ä¸‹é™¤äº†<code>&lt;discriminator&gt;</code>å­èŠ‚ç‚¹çš„å…¶ä»–å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šè¢«è§£ææˆå¯¹åº”çš„<code>ResultMapping</code>å¯¹è±¡ã€‚æ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="comment">//  åº” èŠ‚ ç‚¹çš„propertyå± æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸ è¯¥ åˆ—è¿› è¡Œæ˜ å°„çš„å± æ€§</span></span><br><span class="line"><span class="keyword">private</span> String property;</span><br><span class="line"><span class="comment">// æ•°æ®åº“è·å–çš„åˆ—åæˆ–åˆ«å</span></span><br><span class="line"><span class="keyword">private</span> String column;</span><br><span class="line"><span class="comment">// å¯¹åº”çš„javaç±»å‹ï¼ŒJavaBeançš„å®Œå…¨é™å®šå</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line"><span class="comment">// JDBCç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„typeHandlerå±æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ç±»å‹å¤„ç†å™¨ï¼Œå®ƒä¼šè¦†ç›–é»˜è®¤çš„ç±»å‹å¤„ç†å™¨ï¼Œåé¢ä¼šä»‹ç»è¯¥å­—æ®µçš„ä½œç”¨</span></span><br><span class="line"><span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„resultMapå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;resultMap&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒè´Ÿè´£å°†ç»“æœé›†ä¸­çš„ä¸€éƒ¨</span></span><br><span class="line"><span class="comment">// åˆ†åˆ—æ˜ å°„æˆå…¶ä»–å…³è”çš„ç»“æœå¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡joinæ–¹å¼è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œç„¶åç›´æ¥æ˜ å°„æˆå¤šä¸ªå¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">// å¹¶åŒæ—¶è®¾ç½®è¿™äº›å¯¹è±¡ä¹‹é—´çš„ç»„åˆå…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„selectå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;select&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒä¼šæŠŠæŒ‡å®šçš„åˆ—çš„å€¼ä¼ å…¥</span></span><br><span class="line"><span class="comment">// selectå±æ€§æŒ‡å®šçš„selectè¯­å¥ä¸­ä½œä¸ºå‚æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚ä½¿ç”¨selectå±æ€§å¯èƒ½ä¼šå¯¼è‡´N+1é—®é¢˜</span></span><br><span class="line"><span class="keyword">private</span> String nestedQueryId;</span><br><span class="line"><span class="comment">// éç©ºå­—æ®µé›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> String columnPrefix;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> String resultSet;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> String foreignColumn;</span><br><span class="line"><span class="comment">// æ˜¯å¦å»¶è¿ŸåŠ è½½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br></pre></td></tr></table></figure><p><code>ResultMapping</code>ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨<code>Builder</code>ç±»ï¼Œä¹Ÿåº”ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¯¥<code>Builder</code>ç±»ä¸»è¦ç”¨äºæ•°æ®æ•´ç†å’Œæ•°æ®æ ¡éªŒæ ¡éªŒã€‚</p><p>å¦ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»æ˜¯<code>ResultMap</code>ï¼Œæ¯ä¸ª<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹éƒ½ä¼šè¢«è§£ææˆä¸€ä¸ª<code>ResultMap</code>å¯¹è±¡ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ‰€å®šä¹‰çš„æ˜ å°„å…³ç³»ï¼Œåˆ™ä½¿ç”¨<code>ResultMapping</code>å¯¹è±¡è¡¨ç¤ºã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/12/image-20200712084001741_Piqi53.png" alt="image-20200712084001741"></p><p><code>ResultMap</code>å­—æ®µå®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„idå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„typeå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line"><span class="comment">// ResultMappingå¯¹è±¡é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰IDæ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;id&gt;èŠ‚ç‚¹å’Œ&lt;constructor&gt;èŠ‚ç‚¹çš„&lt;idArg&gt;å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;constructor&gt;æ‰€æœ‰å­å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­ä¸å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•æ‰€æœ‰æ˜ å°„å…³ç³»ä¸­æ¶‰åŠçš„columnå±æ€§çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line"><span class="comment">// é‰´åˆ«å™¨</span></span><br><span class="line"><span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line"><span class="comment">// æ˜¯å¦å«æœ‰åµŒå¥—çš„ç»“æœæ˜ å°„ï¼Œå¦‚æœæŸä¸ªæ˜ å°„å…³ç³»ä¸­å­˜åœ¨resultMapå±æ€§ï¼Œä¸”ä¸å­˜åœ¨resultSetå±æ€§ï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line"><span class="comment">// æ˜¯å¦å«æœ‰åµŒå¥—æŸ¥è¯¢ï¼Œå¦‚æœæŸä¸ªå±æ€§æ˜ å°„å­˜åœ¨selectå±æ€§ï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line"><span class="comment">// æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„</span></span><br><span class="line"><span class="keyword">private</span> Boolean autoMapping;</span><br></pre></td></tr></table></figure><p>åœ¨<code>XMLMapperBuilder</code>ä¸­é€šè¿‡<code>resultMapElements()</code>æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„å…¨éƒ¨<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨<code>resultMapElement()</code>æ–¹æ³•å¤„ç†æ¯ä¸ª<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ResultMap <span class="title">resultMapElement</span><span class="params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  String id </span><br><span class="line">    = resultMapNode.getStringAttribute(</span><br><span class="line">    <span class="string">&quot;id&quot;</span>, resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  String type </span><br><span class="line">    = resultMapNode.getStringAttribute(</span><br><span class="line">    <span class="string">&quot;type&quot;</span>,resultMapNode.getStringAttribute(</span><br><span class="line">      <span class="string">&quot;ofType&quot;</span>,resultMapNode.getStringAttribute(<span class="string">&quot;resultType&quot;</span>,</span><br><span class="line">                                     resultMapNode.getStringAttribute(<span class="string">&quot;javaType&quot;</span>))));</span><br><span class="line">  String extend = resultMapNode.getStringAttribute(<span class="string">&quot;extends&quot;</span>);</span><br><span class="line">  Boolean autoMapping = resultMapNode.getBooleanAttribute(<span class="string">&quot;autoMapping&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">  Discriminator discriminator = <span class="keyword">null</span>;</span><br><span class="line">  List&lt;ResultMapping&gt; resultMappings = <span class="keyword">new</span> ArrayList&lt;ResultMapping&gt;();</span><br><span class="line">  resultMappings.addAll(additionalResultMappings);</span><br><span class="line">  List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">  <span class="keyword">for</span> (XNode resultChild : resultChildren) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">        flags.add(ResultFlag.ID);</span><br><span class="line">      &#125;</span><br><span class="line">      resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ResultMapResolver resultMapResolver = <span class="keyword">new</span> ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IncompleteElementException  e) &#123;</span><br><span class="line">    configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¤„ç†<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥è¿‡ç¨‹åœ¨æ‰§è¡Œè·å–åˆ°<code>id</code>å±æ€§å’Œ<code>type</code>å±æ€§ä¹‹åï¼Œå°±ä¼šé€šè¿‡<code>XMLMapperBuilder.buildResultMappingFromContext()</code>æ–¹æ³•ä¸º<code>&lt;result&gt;</code>èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„<code>ResultMapping</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ResultMapping <span class="title">buildResultMappingFromContext</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  String property;</span><br><span class="line">  <span class="comment">// è·å–propertyçš„å±æ€§å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">    property = context.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    property = context.getStringAttribute(<span class="string">&quot;property&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  String column = context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">  String javaType = context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">  String jdbcType = context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">  String nestedSelect = context.getStringAttribute(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">  String nestedResultMap = context.getStringAttribute(</span><br><span class="line">    <span class="string">&quot;resultMap&quot;</span>,processNestedResultMappings(context, </span><br><span class="line">                                            Collections.&lt;ResultMapping&gt;emptyList()));</span><br><span class="line">  String notNullColumn = context.getStringAttribute(<span class="string">&quot;notNullColumn&quot;</span>);</span><br><span class="line">  String columnPrefix = context.getStringAttribute(<span class="string">&quot;columnPrefix&quot;</span>);</span><br><span class="line">  String typeHandler = context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">  String resultSet = context.getStringAttribute(<span class="string">&quot;resultSet&quot;</span>);</span><br><span class="line">  String foreignColumn = context.getStringAttribute(<span class="string">&quot;foreignColumn&quot;</span>);</span><br><span class="line">  <span class="keyword">boolean</span> lazy = <span class="string">&quot;lazy&quot;</span>.equals(</span><br><span class="line">    context.getStringAttribute(<span class="string">&quot;fetchType&quot;</span>, </span><br><span class="line">                               configuration.isLazyLoadingEnabled() ? <span class="string">&quot;lazy&quot;</span> : <span class="string">&quot;eager&quot;</span>));</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass </span><br><span class="line">    = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler);</span><br><span class="line">  JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">  <span class="keyword">return</span> builderAssistant.buildResultMapping(</span><br><span class="line">    resultType, property, column, javaTypeClass, </span><br><span class="line">    jdbcTypeEnum, nestedSelect, nestedResultMap, </span><br><span class="line">    notNullColumn, columnPrefix, typeHandlerClass, flags, </span><br><span class="line">    resultSet, foreignColumn, lazy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MapperBuilderAssistant.buildResultMapping()</code>çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">buildResultMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; resultType,</span></span></span><br><span class="line"><span class="function"><span class="params">  String property,</span></span></span><br><span class="line"><span class="function"><span class="params">  String column,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; javaType,</span></span></span><br><span class="line"><span class="function"><span class="params">  JdbcType jdbcType,</span></span></span><br><span class="line"><span class="function"><span class="params">  String nestedSelect,</span></span></span><br><span class="line"><span class="function"><span class="params">  String nestedResultMap,</span></span></span><br><span class="line"><span class="function"><span class="params">  String notNullColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">  String columnPrefix,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">  List&lt;ResultFlag&gt; flags,</span></span></span><br><span class="line"><span class="function"><span class="params">  String resultSet,</span></span></span><br><span class="line"><span class="function"><span class="params">  String foreignColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">boolean</span> lazy)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType);</span><br><span class="line">  TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);</span><br><span class="line">  List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(configuration, property, column, javaTypeClass)</span><br><span class="line">    .jdbcType(jdbcType)</span><br><span class="line">    .nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="keyword">true</span>))</span><br><span class="line">    .nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="keyword">true</span>))</span><br><span class="line">    .resultSet(resultSet)</span><br><span class="line">    .typeHandler(typeHandlerInstance)</span><br><span class="line">    .flags(flags == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;() : flags)</span><br><span class="line">    .composites(composites)</span><br><span class="line">    .notNullColumns(parseMultipleColumnNames(notNullColumn))</span><br><span class="line">    .columnPrefix(columnPrefix)</span><br><span class="line">    .foreignColumn(foreignColumn)</span><br><span class="line">    .lazy(lazy)</span><br><span class="line">    .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>ResultMapping</code>å¯¹è±¡é›†åˆä¹‹åï¼Œä¼šè°ƒç”¨<code>ResultMapResolver.resolve()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨<code>MapperBuilderAssistant.addResultMap()</code>æ–¹æ³•åˆ›å»º<code>ResultMap</code>å¯¹è±¡ï¼Œå¹¶å°†<code>ResultMap</code>å¯¹è±¡æ·»åŠ åˆ°<code>Configuration.resultMaps</code>é›†åˆä¸­ä¿å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">addResultMap</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String id,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">  String extend,</span></span></span><br><span class="line"><span class="function"><span class="params">  Discriminator discriminator,</span></span></span><br><span class="line"><span class="function"><span class="params">  List&lt;ResultMapping&gt; resultMappings,</span></span></span><br><span class="line"><span class="function"><span class="params">  Boolean autoMapping)</span> </span>&#123;</span><br><span class="line">  id = applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">  extend = applyCurrentNamespace(extend, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extend != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!configuration.hasResultMap(extend)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ResultMap resultMap = configuration.getResultMap(extend);</span><br><span class="line">    List&lt;ResultMapping&gt; extendedResultMappings = <span class="keyword">new</span> ArrayList&lt;ResultMapping&gt;(resultMap.getResultMappings());</span><br><span class="line">    extendedResultMappings.removeAll(resultMappings);</span><br><span class="line">    <span class="comment">// Remove parent constructor if this resultMap declares a constructor.</span></span><br><span class="line">    <span class="keyword">boolean</span> declaresConstructor = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">      <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">        declaresConstructor = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (declaresConstructor) &#123;</span><br><span class="line">      Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator();</span><br><span class="line">      <span class="keyword">while</span> (extendedResultMappingsIter.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">          extendedResultMappingsIter.remove();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resultMappings.addAll(extendedResultMappings);</span><br><span class="line">  &#125;</span><br><span class="line">  ResultMap resultMap = <span class="keyword">new</span> ResultMap.Builder(configuration, id, type, resultMappings, autoMapping)</span><br><span class="line">    .discriminator(discriminator)</span><br><span class="line">    .build();</span><br><span class="line">  configuration.addResultMap(resultMap);</span><br><span class="line">  <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>&lt;constructor&gt;</code>èŠ‚ç‚¹çš„è§£æï¼Œç”±<code>XMLMapperBuilder.processConstructorElement()</code>æ–¹æ³•å®Œæˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processConstructorElement</span><span class="params">(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  List&lt;XNode&gt; argChildren = resultChild.getChildren();</span><br><span class="line">  <span class="keyword">for</span> (XNode argChild : argChildren) &#123;</span><br><span class="line">    List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">    flags.add(ResultFlag.CONSTRUCTOR);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;idArg&quot;</span>.equals(argChild.getName())) &#123;</span><br><span class="line">      flags.add(ResultFlag.ID);</span><br><span class="line">    &#125;</span><br><span class="line">    resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¼šè§£æ<code>&lt;association&gt;</code>èŠ‚ç‚¹ï¼Œæ­£å¦‚å‰é¢å¯¹<code>XMLMapperBuilder.resultMapElement()</code>æ–¹æ³•çš„ä»‹ç»ï¼Œ<code>&lt;association&gt;</code>èŠ‚ç‚¹ä¹Ÿæ˜¯åœ¨<code>XMLMapperBuilder.buildResultMappingFromContext()</code>æ–¹æ³•ä¸­å®Œæˆè§£æçš„ã€‚</p><p><code>&lt;discriminator&gt;</code>èŠ‚ç‚¹çš„è§£æï¼Œè¯¥è§£æè¿‡ç¨‹ç”±<code>XMLMapperBuilder.processDiscriminatorElement()</code>æ–¹æ³•å®Œæˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Discriminator <span class="title">processDiscriminatorElement</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  String column = context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">  String javaType = context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">  String jdbcType = context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">  String typeHandler = context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler);</span><br><span class="line">  JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">  Map&lt;String, String&gt; discriminatorMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">  <span class="keyword">for</span> (XNode caseChild : context.getChildren()) &#123;</span><br><span class="line">    String value = caseChild.getStringAttribute(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    String resultMap = caseChild.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>, processNestedResultMappings(caseChild, resultMappings));</span><br><span class="line">    discriminatorMap.put(value, resultMap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. è§£æ<code>&lt;sql&gt;</code>èŠ‚ç‚¹</strong></p><p><code>XMLMapperBuilder.sqlElement()</code>æ–¹æ³•è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨éƒ¨<code>&lt;sql&gt;</code>èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  sqlElement(list, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">    String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line">    String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    id = builderAssistant.applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">      sqlFragments.put(id, context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="XMLStatementBuilder"><a href="#XMLStatementBuilder" class="headerlink" title="XMLStatementBuilder"></a>XMLStatementBuilder</h2><p>é™¤äº†èŠ‚ç‚¹è§£æï¼Œæ˜ å°„æ–‡ä»¶ä¸­è¿˜æœ‰ä¸€ç±»æ¯”è¾ƒé‡è¦çš„èŠ‚ç‚¹éœ€è¦è§£æï¼Œä¹Ÿå°±æ˜¯<code>SQL</code>èŠ‚ç‚¹ã€‚<code>SQL</code>èŠ‚ç‚¹ä¸»è¦ç”¨äºå®šä¹‰<code>SQL</code>è¯­å¥ï¼Œ<code>SQL</code>èŠ‚ç‚¹ç”±<code>XMLStatementBuilder</code>è´Ÿè´£è§£æã€‚</p><p><code>MyBatis</code>ä½¿ç”¨<code>SqlSource</code>æ¥å£è¡¨ç¤ºæ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£ä¸­å®šä¹‰çš„<code>SQL</code>è¯­å¥ï¼Œä½†å®ƒè¡¨ç¤ºçš„<code>SQL</code>è¯­å¥æ˜¯ä¸èƒ½ç›´æ¥è¢«æ•°æ®åº“æ‰§è¡Œçš„ï¼Œå› ä¸ºå…¶ä¸­å¯èƒ½å«æœ‰åŠ¨æ€<code>SQL</code>è¯­å¥ç›¸å…³çš„èŠ‚ç‚¹æˆ–æ˜¯å ä½ç¬¦ç­‰éœ€è¦è§£æçš„å…ƒç´ ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"><span class="comment">// getBoundSql()æ–¹æ³•ä¼šæ ¹æ®æ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£æè¿°çš„SQLè¯­å¥ï¼Œä»¥åŠä¼ å…¥çš„å‚æ•°ï¼Œè¿”å›å¯æ‰§è¡Œçš„SQL</span></span><br><span class="line">  <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MyBatis</code>ä½¿ç”¨<code>MappedStatement</code>è¡¨ç¤ºæ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>SQL</code>èŠ‚ç‚¹ï¼Œ<code>MappedStatement</code>åŒ…å«äº†è¿™äº›èŠ‚ç‚¹çš„å¾ˆå¤šå±æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// idå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> String resource;</span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="keyword">private</span> Integer fetchSize;</span><br><span class="line"><span class="keyword">private</span> Integer timeout;</span><br><span class="line"><span class="keyword">private</span> StatementType statementType;</span><br><span class="line"><span class="keyword">private</span> ResultSetType resultSetType;</span><br><span class="line"><span class="comment">// å¯¹åº”ä¸€æ¡sqlè¯­å¥</span></span><br><span class="line"><span class="keyword">private</span> SqlSource sqlSource;</span><br><span class="line"><span class="keyword">private</span> Cache cache;</span><br><span class="line"><span class="keyword">private</span> ParameterMap parameterMap;</span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMap&gt; resultMaps;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> flushCacheRequired;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> useCache;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> resultOrdered;</span><br><span class="line"><span class="comment">// sqlç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> SqlCommandType sqlCommandType;</span><br><span class="line"><span class="keyword">private</span> KeyGenerator keyGenerator;</span><br><span class="line"><span class="keyword">private</span> String[] keyProperties;</span><br><span class="line"><span class="keyword">private</span> String[] keyColumns;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line"><span class="keyword">private</span> String databaseId;</span><br><span class="line"><span class="keyword">private</span> Log statementLog;</span><br><span class="line"><span class="keyword">private</span> LanguageDriver lang;</span><br><span class="line"><span class="keyword">private</span> String[] resultSets;</span><br></pre></td></tr></table></figure><p><code>XMLStatementBuilder.parseStatementNode()</code>æ–¹æ³•æ˜¯è§£æ<code>SQL</code>èŠ‚ç‚¹çš„å…¥å£å‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="keyword">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Integer fetchSize = context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">  Integer timeout = context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  String parameterMap = context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">  String parameterType = context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">  String resultMap = context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">  String resultType = context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  String lang = context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">  LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  String resultSetType = context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">  StatementType statementType = </span><br><span class="line">    StatementType.valueOf(</span><br><span class="line">    context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">  ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®èŠ‚ç‚¹åç§°å†³å®šSqlCommandType</span></span><br><span class="line">  String nodeName = context.getNode().getNodeName();</span><br><span class="line">  SqlCommandType sqlCommandType = </span><br><span class="line">    SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">  <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">  XMLIncludeTransformer includeParser = </span><br><span class="line">    <span class="keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">  includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">  processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">  SqlSource sqlSource = </span><br><span class="line">    langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">  String resultSets = context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">  String keyProperty = context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  KeyGenerator keyGenerator;</span><br><span class="line">  String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">    keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyGenerator = </span><br><span class="line">      context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                                  configuration.isUseGeneratedKeys() </span><br><span class="line">                                  &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">      ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(</span><br><span class="line">    id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">    fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, </span><br><span class="line">    resultTypeClass,resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">    keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>1. è§£æ<code>&lt;include&gt;</code>èŠ‚ç‚¹</strong></p><p>åœ¨è§£æ<code>SQL</code>èŠ‚ç‚¹ä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡<code>XMLIncludeTransformer</code>è§£æ<code>SQL</code>è¯­å¥ä¸­çš„<code>&lt;include&gt;</code>èŠ‚ç‚¹ï¼Œè¯¥è¿‡ç¨‹ä¼šå°†<code>&lt;include&gt;</code>èŠ‚ç‚¹æ›¿æ¢æˆ<code>&lt;sql&gt;</code>èŠ‚ç‚¹ä¸­å®šä¹‰çš„<code>SQL</code>ç‰‡æ®µï¼Œå¹¶å°†å…¶ä¸­çš„<code>$&#123;xxx&#125;</code>å ä½ç¬¦æ›¿æ¢æˆçœŸå®çš„å‚æ•°ï¼Œè¯¥è§£æè¿‡ç¨‹åœ¨<code>XMLIncludeTransformer.applyIncludes()</code>æ–¹æ³•ä¸­å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyIncludes</span><span class="params">(Node source)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–mybatis-config.xmlä¸­&lt;properties&gt;èŠ‚ç‚¹ä¸‹å®šä¹‰çš„å˜é‡é›†åˆ</span></span><br><span class="line">  Properties variablesContext = <span class="keyword">new</span> Properties();</span><br><span class="line">  Properties configurationVariables = configuration.getVariables();</span><br><span class="line">  <span class="keyword">if</span> (configurationVariables != <span class="keyword">null</span>) &#123;</span><br><span class="line">    variablesContext.putAll(configurationVariables);</span><br><span class="line">  &#125;</span><br><span class="line">  applyIncludes(source, variablesContext, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†&lt;include&gt;èŠ‚ç‚¹çš„é‡è½½æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyIncludes</span><span class="params">(Node source, <span class="keyword">final</span> Properties variablesContext, <span class="keyword">boolean</span> included)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (source.getNodeName().equals(<span class="string">&quot;include&quot;</span>)) &#123;</span><br><span class="line">    Node toInclude = findSqlFragment(getStringAttribute(source, <span class="string">&quot;refid&quot;</span>), variablesContext);</span><br><span class="line">    Properties toIncludeContext = getVariablesContext(source, variablesContext);</span><br><span class="line">    applyIncludes(toInclude, toIncludeContext, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;</span><br><span class="line">      toInclude = source.getOwnerDocument().importNode(toInclude, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    source.getParentNode().replaceChild(toInclude, source);</span><br><span class="line">    <span class="keyword">while</span> (toInclude.hasChildNodes()) &#123;</span><br><span class="line">      toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);</span><br><span class="line">    &#125;</span><br><span class="line">    toInclude.getParentNode().removeChild(toInclude);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (included &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// replace variables in attribute values</span></span><br><span class="line">      NamedNodeMap attributes = source.getAttributes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">        Node attr = attributes.item(i);</span><br><span class="line">        attr.setNodeValue(PropertyParser.parse(attr.getNodeValue(), variablesContext));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NodeList children = source.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">      applyIncludes(children.item(i), variablesContext, included);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (included &amp;&amp; source.getNodeType() == Node.TEXT_NODE</span><br><span class="line">             &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">// replace variables in text node</span></span><br><span class="line">    source.setNodeValue(PropertyParser.parse(source.getNodeValue(), variablesContext));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>&lt;inClude&gt;</code>èŠ‚ç‚¹å’Œ<code>&lt;sql&gt;</code>èŠ‚ç‚¹å¯ä»¥é…åˆä½¿ç”¨ã€å¤šå±‚åµŒå¥—ï¼Œå®ç°æ›´åŠ å¤æ‚çš„<code>sql</code>ç‰‡æ®µçš„é‡ç”¨ï¼Œè¿™æ ·çš„è¯ï¼Œè§£æè¿‡ç¨‹å°±ä¼šé€’å½’æ›´å¤šå±‚ï¼Œæµç¨‹å˜å¾—æ›´åŠ å¤æ‚ã€‚</p><p><strong>2. è§£æ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹</strong></p><p>åœ¨<code>&lt;insert&gt;</code>ã€<code>&lt;update&gt;</code>èŠ‚ç‚¹ä¸­å¯ä»¥å®šä¹‰<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹æ¥è§£å†³ä¸»é”®è‡ªå¢é—®é¢˜ï¼Œ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹å¯¹åº”çš„<code>KeyGenerator</code>æ¥å£åœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œç°åœ¨é‡ç‚¹å…³èŠ‚ç‚¹çš„è§£æã€‚</p><p><code>XMLStatementBuilder.processSelectKeyNodes()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>SQL</code>èŠ‚ç‚¹ä¸­å­èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectKeyNodes</span><span class="params">(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å…¨éƒ¨selectKeyèŠ‚ç‚¹</span></span><br><span class="line">  List&lt;XNode&gt; selectKeyNodes = context.evalNodes(<span class="string">&quot;selectKey&quot;</span>);</span><br><span class="line">  <span class="comment">// è§£æselectKeyèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, <span class="keyword">null</span>);</span><br><span class="line">  removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>parseSelectKeyNodes()</code>æ–¹æ³•ä¸­ä¼šä¸º<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ç”Ÿæˆ<code>id</code>ï¼Œæ£€æµ‹<code>databaseld</code>æ˜¯å¦åŒ¹é…ä»¥åŠæ˜¯å¦å·±ç»åŠ è½½è¿‡ç›¸åŒ<code>id</code>ä¸”<code>databaseld</code>ä¸ä¸ºç©ºçš„<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨<code>parseSelectKeyNode()</code>æ–¹æ³•å¤„ç†æ¯ä¸ª<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ã€‚<br>åœ¨<code>parseSelectKeyNode()</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè¯»å–<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹çš„ä¸€ç³»åˆ—å±æ€§ï¼Œç„¶åè°ƒç”¨<code>LanguageDriver.createSqlSource()</code>æ–¹æ³•åˆ›å»ºå¯¹åº”çš„<code>SqlSource</code>å¯¹è±¡ï¼Œæœ€ååˆ›å»º<code>MappedStatement</code>å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°<code>Configuration.mappedStatements</code>é›†åˆä¸­ä¿å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectKeyNode</span><span class="params">(String id, XNode nodeToHandle, </span></span></span><br><span class="line"><span class="function"><span class="params">                                Class&lt;?&gt; parameterTypeClass, </span></span></span><br><span class="line"><span class="function"><span class="params">                                LanguageDriver langDriver, String databaseId)</span> </span>&#123;</span><br><span class="line">  String resultType = nodeToHandle.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  StatementType statementType </span><br><span class="line">    = StatementType.valueOf(</span><br><span class="line">    nodeToHandle.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, </span><br><span class="line">                                    StatementType.PREPARED.toString()));</span><br><span class="line">  String keyProperty = nodeToHandle.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = nodeToHandle.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  <span class="keyword">boolean</span> executeBefore = <span class="string">&quot;BEFORE&quot;</span>.equals(nodeToHandle.getStringAttribute(<span class="string">&quot;order&quot;</span>, <span class="string">&quot;AFTER&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//defaults</span></span><br><span class="line">  <span class="keyword">boolean</span> useCache = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = <span class="keyword">false</span>;</span><br><span class="line">  KeyGenerator keyGenerator = NoKeyGenerator.INSTANCE;</span><br><span class="line">  Integer fetchSize = <span class="keyword">null</span>;</span><br><span class="line">  Integer timeout = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = <span class="keyword">false</span>;</span><br><span class="line">  String parameterMap = <span class="keyword">null</span>;</span><br><span class="line">  String resultMap = <span class="keyword">null</span>;</span><br><span class="line">  ResultSetType resultSetTypeEnum = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  SqlSource sqlSource </span><br><span class="line">    = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);</span><br><span class="line">  SqlCommandType sqlCommandType </span><br><span class="line">    = SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(</span><br><span class="line">    id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">    fetchSize, timeout, parameterMap, parameterTypeClass, </span><br><span class="line">    resultMap, resultTypeClass,</span><br><span class="line">    resultSetTypeEnum, flushCache, useCache, resultOrdered,    </span><br><span class="line">    keyGenerator, keyProperty, keyColumn, databaseId, langDriver, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  id = builderAssistant.applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  MappedStatement keyStatement = configuration.getMappedStatement(id, <span class="keyword">false</span>);</span><br><span class="line">  configuration.addKeyGenerator(id, <span class="keyword">new</span> SelectKeyGenerator(keyStatement, executeBefore));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LanguageDriver</code>æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/17001915960996191596099619233.png" alt="image-20200730170018404"></p><p>åœ¨<code>Configuration</code>çš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬ç”±æ­¤å¯ä»¥åˆ¤æ–­é»˜è®¤ä½¿ç”¨çš„<code>XMLLanguageDriver</code>å®ç°ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">languageRegistry.setDefaultDriverClass(XMLLanguageDriver.class);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„<code>LanguageDriver</code>å®ç°ï¼Œå¹¶åœ¨<code>mybatis-config.xml</code>ä¸­é€šè¿‡<code>defaultScriptingLanguage</code>é…ç½®æŒ‡å®šä½¿ç”¨è¯¥è‡ªå®šä¹‰å®ç°ã€‚<br>åœ¨<code>XMLLanguageDriver.createSqlSource()</code>æ–¹æ³•ä¸­ä¼šåˆ›å»º<code>XMLScriptBuilder</code>å¯¹è±¡å¹¶<code>XMLScriptBuilder.parseScriptNode()</code>æ–¹æ³•åˆ›å»º<code>SqlSource</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parseScriptNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  MixedSqlNode rootSqlNode = parseDynamicTags(context);</span><br><span class="line">  SqlSource sqlSource = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    sqlSource = <span class="keyword">new</span> DynamicSqlSource(configuration, rootSqlNode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sqlSource = <span class="keyword">new</span> RawSqlSource(configuration, rootSqlNode, parameterType);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sqlSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>XMLScriptBuilder.parseDynamicTags()</code>æ–¹æ³•ä¸­ï¼Œä¼šéå†<code>&lt;selectKey&gt;</code>ä¸‹çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœåŒ…å«ä»»ä½•æ ‡ç­¾èŠ‚ç‚¹ï¼Œåˆ™è®¤ä¸ºæ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ï¼›å¦‚æœæ–‡æœ¬èŠ‚ç‚¹ä¸­å«æœ‰<code>$&#123;&#125;</code>å ä½ç¬¦ï¼Œä¹Ÿè®¤ä¸ºå…¶ä¸ºåŠ¨æ€SQLè¯­å¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> MixedSqlNode <span class="title">parseDynamicTags</span><span class="params">(XNode node)</span> </span>&#123;</span><br><span class="line">  List&lt;SqlNode&gt; contents = <span class="keyword">new</span> ArrayList&lt;SqlNode&gt;();</span><br><span class="line">  NodeList children = node.getNode().getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">    XNode child = node.newXNode(children.item(i));</span><br><span class="line">    <span class="keyword">if</span> (child.getNode().getNodeType() </span><br><span class="line">        == Node.CDATA_SECTION_NODE || </span><br><span class="line">        child.getNode().getNodeType() == Node.TEXT_NODE) &#123;</span><br><span class="line">      String data = child.getStringBody(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      TextSqlNode textSqlNode = <span class="keyword">new</span> TextSqlNode(data);</span><br><span class="line">      <span class="keyword">if</span> (textSqlNode.isDynamic()) &#123;</span><br><span class="line">        contents.add(textSqlNode);</span><br><span class="line">        isDynamic = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        contents.add(<span class="keyword">new</span> StaticTextSqlNode(data));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; <span class="comment">// issue #628</span></span><br><span class="line">      String nodeName = child.getNode().getNodeName();</span><br><span class="line">      NodeHandler handler = nodeHandlerMap.get(nodeName);</span><br><span class="line">      <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Unknown element &lt;&quot;</span> + nodeName + <span class="string">&quot;&gt; in SQL statement.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      handler.handleNode(child, contents);</span><br><span class="line">      isDynamic = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MixedSqlNode(contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢é‡åˆ°çš„<code>TextSqlNode</code>ã€<code>StaticTextSqlNode</code>ç­‰éƒ½æ˜¯<code>SqlNode</code>æ¥å£çš„å®ç°ï¼Œ<code>SqlNode</code>æ¥å£çš„<br>æ¯ä¸ªå®ç°éƒ½å¯¹åº”äºä¸åŒçš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ç±»å‹ï¼Œæ¯ä¸ªå®ç°çš„å…·ä½“ä»£ç åé¢é‡åˆ°äº†å†è¯¦ç»†åˆ†æã€‚</p><p><code>TextSqlNode.isDynamic()</code>æ–¹æ³•ä¸­ä¼šé€šè¿‡<code>GenericTokenParser</code>å’Œ<code>DynamicCheckerTokenParser</code>é…åˆè§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦ä¸ºåŠ¨æ€<code>SQL</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDynamic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DynamicCheckerTokenParser checker = <span class="keyword">new</span> DynamicCheckerTokenParser();</span><br><span class="line">  GenericTokenParser parser = createParser(checker);</span><br><span class="line">  parser.parse(text);</span><br><span class="line">  <span class="keyword">return</span> checker.isDynamic();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.isDynamic = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. è§£æSQLèŠ‚ç‚¹</strong></p><p>ç»è¿‡ä¸Šè¿°ä¸¤ä¸ªè§£æè¿‡ç¨‹ä¹‹åï¼Œ<code>&lt;include&gt;</code>èŠ‚ç‚¹å’Œ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹å·±ç»è¢«è§£æå¹¶åˆ é™¤æ‰äº†ã€‚<code>XMLStatementBuilder.parseStatementNode()</code>æ–¹æ³•å‰©ä½™çš„æ“ä½œå°±æ˜¯è§£æ<code>SQL</code>èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="keyword">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Integer fetchSize = context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">  Integer timeout = context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  String parameterMap = context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">  String parameterType = context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">  String resultMap = context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">  String resultType = context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  String lang = context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">  LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  String resultSetType = context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">  StatementType statementType = StatementType.valueOf(context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">  ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">  String nodeName = context.getNode().getNodeName();</span><br><span class="line">  SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">  <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">  XMLIncludeTransformer includeParser = <span class="keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">  includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">  processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">  SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">  String resultSets = context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">  String keyProperty = context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  KeyGenerator keyGenerator;</span><br><span class="line">  String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">    keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyGenerator = context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                                               configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">      ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">                                      fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">                                      resultSetTypeEnum, flushCache, useCache, resultOrdered, </span><br><span class="line">                                      keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»‘å®šMapperæ¥å£"><a href="#ç»‘å®šMapperæ¥å£" class="headerlink" title="ç»‘å®šMapperæ¥å£"></a>ç»‘å®šMapperæ¥å£</h2><p>æ¯ä¸ªæ˜ å°„é…ç½®æ–‡ä»¶çš„å‘½åç©ºé—´å¯ä»¥ç»‘å®šä¸€ä¸ª<code>Mapper</code>æ¥å£ï¼Œå¹¶æ³¨å†Œåˆ°<code>MapperRegistry</code>ä¸­ã€‚</p><p>åœ¨<code>XMLMapperBuilder.bindMapperForNamespace()</code>æ–¹æ³•ä¸­ï¼Œå®Œæˆäº†æ˜ å°„é…ç½®æ–‡ä»¶ä¸å¯¹åº”<code>Mapper</code>æ¥å£çš„ç»‘å®šã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindMapperForNamespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String namespace = builderAssistant.getCurrentNamespace();</span><br><span class="line">  <span class="keyword">if</span> (namespace != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; boundType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      boundType = Resources.classForName(namespace);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="comment">//ignore, bound type is not required</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (boundType != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!configuration.hasMapper(boundType)) &#123;</span><br><span class="line">        <span class="comment">// Spring may not know the real resource name so we set a flag</span></span><br><span class="line">        <span class="comment">// to prevent loading again this resource from the mapper interface</span></span><br><span class="line">        <span class="comment">// look at MapperAnnotationBuilder#loadXmlResource</span></span><br><span class="line">        configuration.addLoadedResource(<span class="string">&quot;namespace:&quot;</span> + namespace);</span><br><span class="line">        configuration.addMapper(boundType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»‹ç»<code>MapperRegistry.addMapper()</code>æ–¹æ³•æ—¶ï¼Œåªæåˆ°äº†è¯¥æ–¹æ³•ä¼šå‘<code>MapperRegistry.knownMappers</code>é›†åˆæ³¨å†ŒæŒ‡å®šçš„<code>Mapper</code>æ¥å£ï¼Œå…¶å®è¯¥æ–¹æ³•è¿˜ä¼šåˆ›å»º<code>MapperAnnotationBuilder</code>ï¼Œå¹¶è°ƒç”¨<code>MapperAnnotationBuilder.parse()</code>æ–¹æ³•è§£æ<code>Mapper</code>æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String resource = type.toString();</span><br><span class="line">  <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    loadXmlResource();</span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    assistant.setCurrentNamespace(type.getName());</span><br><span class="line">    parseCache();</span><br><span class="line">    parseCacheRef();</span><br><span class="line">    Method[] methods = type.getMethods();</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// issue #237</span></span><br><span class="line">        <span class="keyword">if</span> (!method.isBridge()) &#123;</span><br><span class="line">          parseStatement(method);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteMethod(<span class="keyword">new</span> MethodResolver(<span class="keyword">this</span>, method));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  parsePendingMethods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¤„ç†incomplete-é›†åˆ"><a href="#å¤„ç†incomplete-é›†åˆ" class="headerlink" title="å¤„ç†incomplete*é›†åˆ"></a>å¤„ç†incomplete*é›†åˆ</h2><p><code>XMLMapperBuilder.configurationElement()</code>æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œæ˜¯æŒ‰ç…§ä»æ–‡ä»¶å¤´åˆ°æ–‡ä»¶å°¾çš„é¡ºåºè§£æçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åœ¨è§£æä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šå¼•ç”¨å®šä¹‰åœ¨è¯¥èŠ‚ç‚¹ä¹‹åçš„ã€è¿˜æœªè§£æçš„èŠ‚ç‚¹ï¼Œè¿™å°±ä¼šå¯¼è‡´è§£æå¤±è´¥å¹¶æŠ›å‡º<code>IncompleteElementException</code>ã€‚</p><p>æ ¹æ®æŠ›å‡ºå¼‚å¸¸çš„èŠ‚ç‚¹ä¸åŒï¼Œ<code>MyBatis</code>ä¼šåˆ›å»ºä¸åŒçš„<code>*Resolver</code>å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°<code>Configuration</code>çš„ä¸åŒ<code>incomplete*</code>é›†åˆä¸­ã€‚</p><p>ä¾‹å¦‚ï¼Œ</p><ul><li><p>è§£æ<code>Mapper</code>æ¥å£ä¸­çš„æ–¹æ³•å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šåˆ›å»º<code>MethodResolver</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ°<code>Configuration.incompleteMethods</code>é›†åˆ(<code>LinkedList&lt;MethodResolver&gt;</code>ç±»å‹)ä¸­æš‚å­˜;</p></li><li><p>è§£æ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>ResultMapResolver</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteResultMaps</code>(<code>LinkedList&lt;ResultMapResolver&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜;</p></li><li><p>è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>CacheRefResolver</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteCacheRefs</code>(<code>LinkedList&lt;CacheRefResolver&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜;</p></li><li><p>è§£æ<code>SQL</code>è¯­å¥èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>XMLStatementBuilder</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteStatements</code>(<code>LinkedList&lt;XMLStatementBuilder&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜ã€‚</p></li></ul><p>åœ¨<code>XMLMapperBuilder.parse()</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡<code>configurationElement()</code>æ–¹æ³•å®Œäº†ä¸€æ¬¡æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æåï¼Œè¿˜ä¼šè°ƒç”¨<code>parsePendingResultMaps()</code>æ–¹æ³•ã€<code>parsePendingChacheRefs()</code>æ–¹æ³•ã€<code>parsePendingStatements()</code>æ–¹æ³•ä¸‰ä¸ª<code>parsePending*()</code>æ–¹æ³•å¤„ç†<code>Configuration</code>ä¸­å¯¹åº”çš„ä¸‰ä¸ª<code>incomplete*</code>é›†åˆã€‚æ‰€æœ‰<code>parsePending*()</code>æ–¹æ³•çš„é€»è¾‘éƒ½æ˜¯åŸºæœ¬ç±»ä¼¼çš„ï¼Œè¿™é‡Œä»¥<code>parsePendingStatements()</code>æ–¹æ³•ä¸ºä¾‹è¿›è¡Œåˆ†æ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePendingStatements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements();</span><br><span class="line">  <span class="keyword">synchronized</span> (incompleteStatements) &#123;</span><br><span class="line">    Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        iter.next().parseStatementNode();</span><br><span class="line">        iter.remove();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        <span class="comment">// Statement is still missing a resource...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<code>MyBatis</code>çš„åˆå§‹åŒ–è¿‡ç¨‹å°±å…¨éƒ¨ä»‹ç»å®Œäº†ï¼Œå…¶ä¸­åˆ†æäº†<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ã€æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ä»¥åŠ<code>Mapper</code>æ¥å£ä¸­ç›¸å…³æ³¨è§£çš„è§£æè¿‡ç¨‹ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> æ ¸å¿ƒå¤„ç†å±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆçŸ¥è¯†æ¢³ç†ï¼‰</title>
      <link href="/blog/2020/03/31/741621cd.html"/>
      <url>/blog/2020/03/31/741621cd.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Aspect Oriented Programming with Spring</p><p>é¢å‘åˆ‡é¢çš„ç¼–ç¨‹ï¼ˆAOPï¼‰é€šè¿‡æä¾›å¦ä¸€ç§æ€è€ƒç¨‹åºç»“æ„çš„æ–¹å¼æ¥è¡¥å……é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼ˆOOPï¼‰ã€‚</p></blockquote><p> OOPä¸­æ¨¡å—åŒ–çš„å…³é”®å•å…ƒæ˜¯ç±»ï¼Œè€Œåœ¨AOPä¸­æ¨¡å—åŒ–æ˜¯æ–¹é¢ã€‚åˆ‡é¢ä½¿å…³æ³¨ç‚¹ï¼ˆä¾‹å¦‚äº‹åŠ¡ç®¡ç†ï¼‰çš„æ¨¡å—åŒ–è·¨è¶Šäº†å¤šä¸ªç±»å‹å’Œå¯¹è±¡ã€‚ ï¼ˆè¿™ç§å…³æ³¨åœ¨AOPæ–‡çŒ®ä¸­é€šå¸¸è¢«ç§°ä¸ºâ€œè·¨é¢†åŸŸâ€å…³æ³¨ã€‚ï¼‰</p><p>Springçš„å…³é”®ç»„ä»¶ä¹‹ä¸€æ˜¯AOPæ¡†æ¶ã€‚å°½ç®¡Spring IoCå®¹å™¨ä¸ä¾èµ–äºAOPï¼Œä½†<strong>AOPæ˜¯å¯¹Spring IoCçš„è¡¥å……ï¼Œå¯ä»¥æä¾›åŠŸèƒ½å¼ºå¤§çš„ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆã€‚</strong></p><blockquote><p>Spring AOP with AspectJ pointcuts</p><p>Spring provides simple and powerful ways of writing custom aspects by using either a <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop-schema">schema-based approach</a> or the <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop-ataspectj">@AspectJ annotation style</a>. Both of these styles offer fully typed advice and use of the AspectJ pointcut language while still using Spring AOP for weaving.</p><p>å…·æœ‰AspectJåˆ‡å…¥ç‚¹çš„Spring AOP<br>é€šè¿‡ä½¿ç”¨<strong>åŸºäºæ¨¡å¼çš„æ–¹æ³•</strong>æˆ–**@AspectJæ³¨è§£æ ·å¼**ï¼ŒSpringæä¾›äº†ç¼–å†™è‡ªå®šä¹‰åˆ‡é¢çš„ç®€å•è€Œå¼ºå¤§çš„æ–¹æ³•ã€‚è¿™ä¸¤ç§æ ·å¼éƒ½æä¾›äº†å®Œå…¨ç±»å‹åŒ–çš„å»ºè®®ï¼Œå¹¶ä½¿ç”¨äº†AspectJåˆ‡å…¥ç‚¹è¯­è¨€ï¼ŒåŒæ—¶ä»ç„¶ä½¿ç”¨Spring AOPè¿›è¡Œç¼–ç¨‹ã€‚</p></blockquote><h2 id="Spring-AOPæ¦‚å¿µ"><a href="#Spring-AOPæ¦‚å¿µ" class="headerlink" title="Spring AOPæ¦‚å¿µ"></a>Spring AOPæ¦‚å¿µ</h2><p>ä¸€äº›é‡è¦çš„AOPæ¦‚å¿µå’Œæœ¯è¯­ã€‚<em>è¿™äº›æœ¯è¯­ä¸æ˜¯ç‰¹å®šäºSpringçš„ã€‚</em></p><ul><li><p><strong>åˆ‡é¢ï¼ˆAspectï¼‰</strong></p><p>ç±»æ˜¯å¯¹ç‰©ä½“ç‰¹å¾çš„æŠ½è±¡ï¼Œ<em>åˆ‡é¢å°±æ˜¯å¯¹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æŠ½è±¡</em>ã€‚</p><blockquote><p>åœ¨Spring AOPä¸­ï¼Œåˆ‡é¢æ˜¯é€šè¿‡ä½¿ç”¨å¸¸è§„ç±»ï¼ˆåŸºäºæ¶æ„çš„æ–¹æ³•ï¼‰æˆ–ä½¿ç”¨@Aspectæ³¨é‡Šï¼ˆ@AspectJæ ·å¼ï¼‰æ³¨é‡Šçš„å¸¸è§„ç±»æ¥å®ç°çš„ã€‚</p></blockquote><p><code>aspect</code> ç”± <code>pointcount</code> å’Œ <code>advice</code> ç»„æˆ, å®ƒæ—¢åŒ…å«äº†æ¨ªåˆ‡é€»è¾‘çš„å®šä¹‰, ä¹ŸåŒ…æ‹¬äº†è¿æ¥ç‚¹çš„å®šä¹‰. Spring AOPå°±æ˜¯è´Ÿè´£å®æ–½åˆ‡é¢çš„æ¡†æ¶, å®ƒå°†åˆ‡é¢æ‰€å®šä¹‰çš„æ¨ªåˆ‡é€»è¾‘ç»‡å…¥åˆ°åˆ‡é¢æ‰€æŒ‡å®šçš„è¿æ¥ç‚¹ä¸­.<br>AOPçš„å·¥ä½œé‡å¿ƒåœ¨äºå¦‚ä½•å°†å¢å¼ºç»‡å…¥ç›®æ ‡å¯¹è±¡çš„è¿æ¥ç‚¹ä¸Š, è¿™é‡ŒåŒ…å«ä¸¤ä¸ªå·¥ä½œ:</p><ol><li>å¦‚ä½•é€šè¿‡ pointcut å’Œ advice å®šä½åˆ°ç‰¹å®šçš„ joinpoint ä¸Š</li><li>å¦‚ä½•åœ¨ advice ä¸­ç¼–å†™åˆ‡é¢ä»£ç .</li></ol></li><li><p><strong>è¿æ¥ç‚¹ï¼ˆJoin pointï¼‰</strong></p><blockquote><p>A point during the execution of a program, such as the execution of a method or the handling of an exception. In Spring AOP, a join point always represents a method execution.</p></blockquote><p>ç¨‹åºè¿è¡Œä¸­çš„ä¸€äº›æ—¶é—´ç‚¹ï¼Œä¾‹å¦‚ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¼‚å¸¸çš„å¤„ç†ã€‚<br><code>åœ¨ Spring AOP ä¸­, join point æ€»æ˜¯æ–¹æ³•çš„æ‰§è¡Œç‚¹, å³åªæœ‰æ–¹æ³•è¿æ¥ç‚¹.</code></p></li><li><p><strong>å¢å¼ºï¼ˆAdviceï¼‰</strong></p><blockquote><p>Action taken by an aspect at a particular join point. Different types of advice include â€œaroundâ€, â€œbeforeâ€ and â€œafterâ€ advice. (Advice types are discussed later.) Many AOP frameworks, including Spring, model an advice as an interceptor and maintain a chain of interceptors around the join point.</p></blockquote><p>åˆ‡é¢åœ¨ç‰¹å®šçš„è¿æ¥ç‚¹å¤„é‡‡å–çš„æ“ä½œã€‚ä¸åŒç±»å‹çš„å»ºè®®åŒ…æ‹¬<code>around</code>ï¼Œ<code>before</code>å’Œ<code>after</code>é€šçŸ¥ã€‚ åŒ…æ‹¬Springåœ¨å†…çš„è®¸å¤šAOPæ¡†æ¶éƒ½å°†é€šçŸ¥å»ºæ¨¡ä¸ºæ‹¦æˆªå™¨ï¼Œå¹¶åœ¨è¿æ¥ç‚¹å‘¨å›´ç»´æŠ¤ä¸€ç³»åˆ—æ‹¦æˆªå™¨ã€‚</p><p>ç”± <code>aspect</code> æ·»åŠ åˆ°ç‰¹å®šçš„ join point(å³æ»¡è¶³ <code>point cut</code> è§„åˆ™çš„ join point) çš„ä¸€æ®µä»£ç .<br>è®¸å¤š <code>AOP</code>æ¡†æ¶, åŒ…æ‹¬ <code>Spring AOP</code>, ä¼šå°† <code>advice</code> æ¨¡æ‹Ÿä¸ºä¸€ä¸ªæ‹¦æˆªå™¨(<code>interceptor</code>), å¹¶ä¸”åœ¨ join point ä¸Šç»´æŠ¤å¤šä¸ª <code>advice</code>, è¿›è¡Œå±‚å±‚æ‹¦æˆª.<br><em>ä¾‹å¦‚ <code>HTTP</code> é‰´æƒçš„å®ç°, æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªä½¿ç”¨ <code>RequestMapping</code> æ ‡æ³¨çš„æ–¹æ³•ç»‡å…¥ <code>advice</code>, å½“ <code>HTTP</code> è¯·æ±‚åˆ°æ¥æ—¶, é¦–å…ˆè¿›å…¥åˆ° <code>advice</code> ä»£ç ä¸­, åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ†æè¿™ä¸ª <code>HTTP</code> è¯·æ±‚æ˜¯å¦æœ‰ç›¸åº”çš„æƒé™, å¦‚æœæœ‰, åˆ™æ‰§è¡Œ <code>Controller</code>, å¦‚æœæ²¡æœ‰, åˆ™æŠ›å‡ºå¼‚å¸¸. è¿™é‡Œçš„ <code>advice</code> å°±æ‰®æ¼”ç€é‰´æƒæ‹¦æˆªå™¨çš„è§’è‰²äº†.</em></p></li><li><p><strong>åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰</strong></p><blockquote><p>A predicate that matches join points. Advice is associated with a pointcut expression and runs at any join point matched by the pointcut (for example, the execution of a method with a certain name). The concept of join points as matched by pointcut expressions is central to AOP, and Spring uses the AspectJ pointcut expression language by default.</p></blockquote><p>åŒ¹é…è¿æ¥ç‚¹çš„è°“è¯ã€‚é€šçŸ¥ä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å…³è”ï¼Œå¹¶åœ¨ä¸è¯¥åˆ‡å…¥ç‚¹åŒ¹é…çš„ä»»ä½•è¿æ¥ç‚¹å¤„è¿è¡Œï¼ˆä¾‹å¦‚ï¼Œæ‰§è¡Œå…·æœ‰ç‰¹å®šåç§°çš„æ–¹æ³•ï¼‰ã€‚ä½¿ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ¥åŒ¹é…è¿æ¥ç‚¹æ˜¯AOPçš„æ ¸å¿ƒï¼Œå¹¶ä¸”Springé»˜è®¤ä½¿ç”¨AspectJåˆ‡å…¥ç‚¹è¡¨è¾¾è¯­è¨€ã€‚</p><p>åœ¨ <code>Spring</code> ä¸­, æ‰€æœ‰çš„æ–¹æ³•éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ <code>joinpoint</code>, ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸å¸Œæœ›åœ¨æ‰€æœ‰çš„æ–¹æ³•ä¸Šéƒ½æ·»åŠ  <code>Advice</code>, è€Œ pointcut çš„ä½œç”¨å°±æ˜¯æä¾›ä¸€ç»„è§„åˆ™(ä½¿ç”¨ <em>AspectJ pointcut expression language</em> æ¥æè¿°) æ¥åŒ¹é…<code>joinpoint</code>, ç»™æ»¡è¶³è§„åˆ™çš„ <code>joinpoint</code> æ·»åŠ  <code>Advice</code>.</p></li><li><p><strong>å¼•å…¥ï¼ˆIntroductionï¼‰</strong></p><blockquote><p>Declaring additional methods or fields on behalf of a type. Spring AOP lets you introduce new interfaces (and a corresponding implementation) to any advised object. For example, you could use an introduction to make a bean implement an <code>IsModified</code> interface, to simplify caching. (An introduction is known as an inter-type declaration in the AspectJ community.)</p></blockquote><p>ä»£è¡¨ç±»å‹å£°æ˜å…¶ä»–æ–¹æ³•æˆ–å­—æ®µã€‚ Spring AOPå…è®¸æ‚¨å‘ä»»ä½•å»ºè®®çš„å¯¹è±¡å¼•å…¥æ–°çš„æ¥å£ï¼ˆå’Œç›¸åº”çš„å®ç°ï¼‰ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<em>å¼•å…¥</em>ä½¿<code>Bean</code>å®ç°<code>IsModified</code>æ¥å£ï¼Œä»¥ç®€åŒ–ç¼“å­˜ã€‚ ï¼ˆåœ¨AspectJç¤¾åŒºä¸­ï¼Œ<strong>å¼•å…¥</strong>è¢«ç§°ä¸ºç±»å‹é—´å£°æ˜ã€‚ï¼‰</p></li></ul><blockquote><p>ä¸ºä¸€ä¸ªç±»å‹æ·»åŠ é¢å¤–çš„æ–¹æ³•æˆ–å­—æ®µ. <code>Spring AOP</code> å…è®¸æˆ‘ä»¬ä¸º <code>ç›®æ ‡å¯¹è±¡</code> å¼•å…¥æ–°çš„æ¥å£(å’Œå¯¹åº”çš„å®ç°). ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>introduction</code> æ¥ä¸ºä¸€ä¸ª <code>bean</code> å®ç° <code>IsModified</code> æ¥å£, å¹¶ä»¥æ­¤æ¥ç®€åŒ– <code>caching</code> çš„å®ç°.</p></blockquote><ul><li><p><strong>ç›®æ ‡å¯¹è±¡ï¼ˆTarget objectï¼‰</strong></p><blockquote><p>An object being advised by one or more aspects. Also referred to as the â€œadvised objectâ€. Since Spring AOP is implemented by using runtime proxies, this object is always a proxied object.</p></blockquote><p>ä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢é€šçŸ¥çš„å¯¹è±¡ã€‚ä¹Ÿç§°ä¸ºâ€œç›®æ ‡å¯¹è±¡â€ã€‚ç”±äº<code>Spring AOP</code>æ˜¯ä½¿ç”¨è¿è¡Œæ—¶<strong>ä»£ç†</strong>å®ç°çš„ï¼Œå› æ­¤<strong>è¯¥å¯¹è±¡å§‹ç»ˆæ˜¯ä»£ç†å¯¹è±¡</strong>ã€‚</p><p>å› ä¸º Spring AOP ä½¿ç”¨è¿è¡Œæ—¶ä»£ç†çš„æ–¹å¼æ¥å®ç° aspect, å› æ­¤ adviced object æ€»æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡(proxied object)ã€‚</p><p><em>æ³¨æ„, adviced object æŒ‡çš„ä¸æ˜¯åŸæ¥çš„ç±», è€Œæ˜¯ç»‡å…¥ advice åæ‰€äº§ç”Ÿçš„ä»£ç†ç±»</em></p></li><li><p><strong>ä»£ç†ï¼ˆAOP proxyï¼‰</strong></p><blockquote><p> An object created by the AOP framework in order to implement the aspect contracts (advise method executions and so on). In the Spring Framework, an AOP proxy is a JDK dynamic proxy or a CGLIB proxy.</p></blockquote><p>ä¸€ä¸ªç±»è¢« AOP ç»‡å…¥ <code>advice</code>ï¼Œ å°±ä¼šäº§ç”Ÿä¸€ä¸ªç»“æœç±», å®ƒæ˜¯èåˆäº†åŸç±»å’Œå¢å¼ºé€»è¾‘çš„ä»£ç†ç±»ã€‚åœ¨ Spring AOP ä¸­, ä¸€ä¸ª AOP ä»£ç†æ˜¯ä¸€ä¸ª JDK åŠ¨æ€ä»£ç†å¯¹è±¡æˆ– CGLIB ä»£ç†å¯¹è±¡ã€‚</p></li><li><p><strong>ç»‡å…¥ï¼ˆWeavingï¼‰</strong></p><blockquote><p> linking aspects with other application types or objects to create an advised object. This can be done at compile time (using the AspectJ compiler, for example), load time, or at runtime. Spring AOP, like other pure Java AOP frameworks, performs weaving at runtime.</p></blockquote><p>å°†åˆ‡é¢ä¸å…¶ä»–åº”ç”¨ç¨‹åºç±»å‹æˆ–å¯¹è±¡é“¾æ¥ä»¥åˆ›å»ºå»ºè®®çš„å¯¹è±¡ï¼ˆå°† aspect å’Œå…¶ä»–å¯¹è±¡è¿æ¥èµ·æ¥, å¹¶åˆ›å»º adviced object çš„è¿‡ç¨‹ï¼‰ã€‚è¿™å¯ä»¥åœ¨ç¼–è¯‘æ—¶ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨<code>AspectJ</code>ç¼–è¯‘å™¨ï¼‰ï¼ŒåŠ è½½æ—¶æˆ–åœ¨è¿è¡Œæ—¶å®Œæˆã€‚åƒå…¶ä»–çº¯Java AOPæ¡†æ¶ä¸€æ ·ï¼Œ<code>Spring AOP</code>åœ¨è¿è¡Œæ—¶æ‰§è¡Œç¼–ç»‡ã€‚æ ¹æ®ä¸åŒçš„å®ç°æŠ€æœ¯, AOPç»‡å…¥æœ‰ä¸‰ç§æ–¹å¼:</p><ul><li>ç¼–è¯‘å™¨ç»‡å…¥, è¿™è¦æ±‚æœ‰ç‰¹æ®Šçš„Javaç¼–è¯‘å™¨.</li><li>ç±»è£…è½½æœŸç»‡å…¥, è¿™éœ€è¦æœ‰ç‰¹æ®Šçš„ç±»è£…è½½å™¨.</li><li>åŠ¨æ€ä»£ç†ç»‡å…¥, åœ¨è¿è¡ŒæœŸä¸ºç›®æ ‡ç±»æ·»åŠ å¢å¼º(Advice)ç”Ÿæˆå­ç±»çš„æ–¹å¼.<br>Spring é‡‡ç”¨åŠ¨æ€ä»£ç†ç»‡å…¥, è€ŒAspectJé‡‡ç”¨ç¼–è¯‘å™¨ç»‡å…¥å’Œç±»è£…è½½æœŸç»‡å…¥.</li></ul></li></ul><h3 id="adviceçš„å‡ ç§ç±»å‹"><a href="#adviceçš„å‡ ç§ç±»å‹" class="headerlink" title="adviceçš„å‡ ç§ç±»å‹"></a>adviceçš„å‡ ç§ç±»å‹</h3><ul><li><p><strong>å‰ç½®é€šçŸ¥ï¼ˆBefore adviceï¼‰</strong></p><p>åœ¨è¿æ¥ç‚¹ä¹‹å‰è¿è¡Œä½†æ— æ³•é˜»æ­¢æ‰§è¡Œæµå‰è¿›åˆ°è¿æ¥ç‚¹çš„é€šçŸ¥ï¼ˆé™¤éå®ƒå¼•å‘å¼‚å¸¸ï¼‰ã€‚</p></li><li><p><strong>åç½®é€šçŸ¥ï¼ˆAfter returning adviceï¼‰</strong></p><p>è¿æ¥ç‚¹æ­£å¸¸å®Œæˆåè¦è¿è¡Œçš„é€šçŸ¥ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ–¹æ³•è¿”å›è€Œæ²¡æœ‰å¼•å‘å¼‚å¸¸ï¼‰ã€‚</p></li><li><p><strong>æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter throwing adviceï¼‰</strong></p><p>å¦‚æœå­˜åœ¨æ–¹æ³•åˆ™é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥æ‰§è¡Œçš„é€šçŸ¥ã€‚</p></li><li><p><strong>åœ¨finallyæ‰§è¡Œåé€šçŸ¥ï¼ˆAfter (finally) adviceï¼‰</strong></p><p>æ— è®ºè¿æ¥ç‚¹é€€å‡ºçš„æ–¹å¼å¦‚ä½•ï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸è¿”å›ï¼‰ï¼Œéƒ½å°†æ‰§è¡Œé€šçŸ¥ã€‚</p></li><li><p><strong>ç¯ç»•é€šçŸ¥ï¼ˆAround advice</strong>ï¼‰</p><p>å›´ç»•è”æ¥ç‚¹çš„é€šçŸ¥ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€‚è¿™æ˜¯æœ€æœ‰åŠ›çš„é€šçŸ¥ã€‚<strong>ç¯ç»•é€šçŸ¥å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰å’Œä¹‹åæ‰§è¡Œè‡ªå®šä¹‰è¡Œä¸º</strong>ã€‚å®ƒè¿˜è´Ÿè´£é€‰æ‹©æ˜¯è¿”å›è¿æ¥ç‚¹è¿˜æ˜¯é€šè¿‡è¿”å›å…¶è‡ªèº«çš„è¿”å›å€¼æˆ–å¼•å‘å¼‚å¸¸æ¥è¿›è¡Œé€šçŸ¥çš„æ–¹æ³•æ‰§è¡Œã€‚</p></li></ul><h2 id="AOPä»£ç†"><a href="#AOPä»£ç†" class="headerlink" title="AOPä»£ç†"></a>AOPä»£ç†</h2><p><code>Spring AOP</code>é»˜è®¤å°†æ ‡å‡†<code>JDK</code>åŠ¨æ€ä»£ç†ç”¨äº<code>AOP</code>ä»£ç†ã€‚è¿™ä½¿å¾—å¯ä»¥ä»£ç†ä»»ä½•æ¥å£ï¼ˆæˆ–ä¸€ç»„æ¥å£ï¼‰ã€‚</p><p><code>Spring AOP</code>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>CGLIB</code>ä»£ç†ã€‚è¿™å¯¹äºä»£ç†ç±»è€Œä¸æ˜¯æ¥å£æ˜¯å¿…éœ€çš„ã€‚<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸šåŠ¡å¯¹è±¡æœªå®ç°æ¥å£ï¼Œåˆ™ä½¿ç”¨CGLIBã€‚</strong>ç”±äºå¯¹æ¥å£è€Œä¸æ˜¯å¯¹ç±»è¿›è¡Œç¼–ç¨‹æ˜¯ä¸€ç§å¥½ä¹ æƒ¯ï¼Œå› æ­¤ä¸šåŠ¡ç±»é€šå¸¸å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡æ¥å£ã€‚åœ¨é‚£äº›éœ€è¦å»ºè®®åœ¨æ¥å£ä¸Šæœªå£°æ˜çš„æ–¹æ³•æˆ–éœ€è¦å°†ä»£ç†å¯¹è±¡ä½œä¸ºå…·ä½“ç±»å‹ä¼ é€’ç»™æ–¹æ³•çš„æƒ…å†µä¸‹ï¼ˆåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼‰ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ç”¨<code>CGLIB</code>ã€‚</p><h3 id="Spring-Beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Spring-Beançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Spring Beançš„ç”Ÿå‘½å‘¨æœŸ"></a>Spring Beançš„ç”Ÿå‘½å‘¨æœŸ</h3><blockquote><p>æ’æ’­ä¸€ä¸‹Spring Beançš„ç”Ÿå‘½å‘¨æœŸ</p></blockquote><p>ä¸¤ä¸ªæ¦‚å¿µï¼š<code>Spring Bean</code> å’Œ <code>å¯¹è±¡</code>ï¼š</p><ol><li><strong>spring bean</strong>â€”â€”å—springå®¹å™¨ç®¡ç†çš„å¯¹è±¡ï¼Œå¯èƒ½ç»è¿‡äº†å®Œæ•´çš„spring beanç”Ÿå‘½å‘¨æœŸï¼ˆä¸ºä»€ä¹ˆæ˜¯å¯èƒ½ï¼Ÿéš¾é“è¿˜æœ‰beanæ˜¯æ²¡æœ‰ç»è¿‡beanç”Ÿå‘½å‘¨æœŸçš„ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå…·ä½“æˆ‘ä»¬åé¢æ–‡ç« åˆ†æï¼‰ï¼Œæœ€ç»ˆå­˜åœ¨springå®¹å™¨å½“ä¸­ï¼›ä¸€ä¸ªbeanä¸€å®šæ˜¯ä¸ªå¯¹è±¡</li><li><strong>å¯¹è±¡</strong>â€”â€”ä»»ä½•ç¬¦åˆjavaè¯­æ³•è§„åˆ™å®ä¾‹åŒ–å‡ºæ¥çš„å¯¹è±¡ï¼Œä½†æ˜¯ä¸€ä¸ªå¯¹è±¡å¹¶ä¸ä¸€å®šæ˜¯spring beanï¼›</li></ol><p>æ‰€è°“çš„beançš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ç£ç›˜ä¸Šçš„ç±»é€šè¿‡Springæ‰«æï¼Œç„¶åå®ä¾‹åŒ–ï¼Œè·Ÿç€åˆå§‹åŒ–ï¼Œç»§è€Œæ”¾åˆ°å®¹å™¨å½“ä¸­çš„è¿‡ç¨‹ã€‚ä¸‹å›¾å±•ç¤ºSpring Beançš„ç”Ÿå‘½å‘¨æœŸå¤§æ¦‚æœ‰å“ªäº›æ­¥éª¤ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/20191118210559319.png" alt="Spring Beançš„ç”Ÿå‘½å‘¨æœŸ"></p><p><strong>å…¶ä¸­AOPçš„ä»£ç†ä¹Ÿæ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆçš„ã€‚</strong></p><h2 id="AOPçš„ä½¿ç”¨"><a href="#AOPçš„ä½¿ç”¨" class="headerlink" title="AOPçš„ä½¿ç”¨"></a>AOPçš„ä½¿ç”¨</h2><h3 id="AspectJä¸-AspectJ"><a href="#AspectJä¸-AspectJ" class="headerlink" title="AspectJä¸@AspectJ"></a>AspectJä¸@AspectJ</h3><p><code>@AspectJ</code>æ˜¯ä¸€ç§å°†åˆ‡é¢å£°æ˜ä¸ºå¸¦æœ‰æ³¨è§£çš„å¸¸è§„<code>Java</code>ç±»çš„æ ·å¼ã€‚ <code>@AspectJ</code>æ ·å¼æ˜¯<code>AspectJ</code>é¡¹ç›®åœ¨<code>AspectJ 5</code>ç‰ˆæœ¬ä¸­å¼•å…¥çš„ã€‚ <code>Spring</code>ä½¿ç”¨<code>AspectJ</code>æä¾›çš„ç”¨äºåˆ‡å…¥ç‚¹è§£æå’ŒåŒ¹é…çš„åº“æ¥è§£é‡Šä¸<code>AspectJ 5</code>ç›¸åŒçš„æ³¨è§£ã€‚ä½†æ˜¯ï¼Œ<code>AOP</code>è¿è¡Œæ—¶ä»ç„¶æ˜¯çº¯<code>Spring AOP</code>ï¼Œå¹¶ä¸”ä¸ä¾èµ–äº<code>AspectJ</code>ç¼–è¯‘å™¨æˆ–ç¼–ç»‡å™¨ã€‚</p><blockquote><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œ<code>Spring</code>å€Ÿé‰´äº†<code>AspectJ</code>çš„è¯­æ³•ã€‚</p><p>ä½¿ç”¨<code>AspectJ</code>ç¼–è¯‘å™¨å’Œ<code>weaver</code>å¯ä»¥ä½¿ç”¨å®Œæ•´çš„<code>AspectJ</code>è¯­æ³•ã€‚</p></blockquote><blockquote><p>AspectJ æ˜¯æœ€æ—©ã€åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§çš„ AOP å®ç°ä¹‹ä¸€ï¼Œå¯¹æ•´å¥— AOP æœºåˆ¶éƒ½æœ‰è¾ƒå¥½çš„å®ç°ï¼Œå¾ˆå¤šå…¶ä»–è¯­è¨€çš„ AOP å®ç°ï¼Œä¹Ÿå€Ÿé‰´æˆ–é‡‡çº³äº† AspectJ ä¸­å¾ˆå¤šè®¾è®¡ã€‚</p></blockquote><h3 id="å¯ç”¨-AspectJæ”¯æŒ"><a href="#å¯ç”¨-AspectJæ”¯æŒ" class="headerlink" title="å¯ç”¨@AspectJæ”¯æŒ"></a>å¯ç”¨@AspectJæ”¯æŒ</h3><ol><li><p>é€šè¿‡<code>Java</code>é…ç½®å¯ç”¨<code>@AspectJ</code>æ”¯æŒ</p><p>åœ¨é…ç½®ç±»åŠ ä¸Š<code>@EnableAspectJAutoProxy</code>æ³¨è§£ä»¥å¯ç”¨<code>@AspectJ</code>æ”¯æŒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡<code>XML</code>é…ç½®å¯ç”¨<code>@Aspect</code>Jæ”¯æŒ</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="å£°æ˜ä¸€ä¸ªåˆ‡é¢"><a href="#å£°æ˜ä¸€ä¸ªåˆ‡é¢" class="headerlink" title="å£°æ˜ä¸€ä¸ªåˆ‡é¢"></a>å£°æ˜ä¸€ä¸ªåˆ‡é¢</h3><p>å¯ç”¨<code>@AspectJ</code>æ”¯æŒåï¼Œ<code>Spring</code>ä¼šè‡ªåŠ¨æ£€æµ‹åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨<code>@AspectJ</code>åˆ‡é¢ï¼ˆå…·æœ‰<code>@Aspect</code>æ‰¹æ³¨ï¼‰çš„ç±»å®šä¹‰çš„beanï¼Œå¹¶ç”¨äºé…ç½®<code>Spring AOP</code>ã€‚</p><ol><li><p>ä½¿ç”¨xmlé…ç½®å£°æ˜åˆ‡é¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.xyz.NotVeryUsefulAspect&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configure properties of the aspect here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨æ³¨è§£å£°æ˜åˆ‡é¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xyz;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotVeryUsefulAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="å£°æ˜åˆ‡å…¥ç‚¹"><a href="#å£°æ˜åˆ‡å…¥ç‚¹" class="headerlink" title="å£°æ˜åˆ‡å…¥ç‚¹"></a>å£°æ˜åˆ‡å…¥ç‚¹</h3><p>åˆ‡å…¥ç‚¹ç¡®å®šäº†å…³æ³¨çš„çš„è¿æ¥ç‚¹ï¼Œä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶æ‰§è¡Œé€šçŸ¥çš„æ—¶æœºã€‚ <code>Spring AOP</code>ä»…æ”¯æŒ<code>Spring Bean</code>çš„æ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹ï¼Œå¯ä»¥å°†åˆ‡å…¥ç‚¹è§†ä¸ºä¸<code>Spring Bean</code>ä¸Šçš„æ–¹æ³•æ‰§è¡ŒåŒ¹é…ã€‚</p><p>åˆ‡å…¥ç‚¹å£°æ˜ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªåŒ…å«åç§°å’Œä»»ä½•å‚æ•°çš„ç­¾åï¼Œä»¥åŠä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¯¥åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç²¾ç¡®åœ°ç¡®å®šæˆ‘ä»¬å…³æ³¨çš„æ–¹æ³•æ‰§è¡Œã€‚åœ¨<code>AOP</code>çš„<code>@AspectJ</code>æ‰¹æ³¨æ ·å¼ä¸­ï¼Œå¸¸è§„æ–¹æ³•å®šä¹‰æä¾›äº†åˆ‡å…¥ç‚¹ç­¾åã€‚ å¹¶é€šè¿‡ä½¿ç”¨<code>@Pointcut</code>æ³¨è§£å£°æ˜åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼ˆ<strong>ç”¨ä½œåˆ‡å…¥ç‚¹ç­¾åçš„æ–¹æ³•å¿…é¡»å…·æœ‰voidè¿”å›ç±»å‹</strong>ï¼‰ã€‚</p><p>ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* transfer(..))&quot;)</span> <span class="comment">// åˆ‡å…¥ç‚¹è¡¨è¾¾å¼</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">anyOldTransfer</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// åˆ‡å…¥ç‚¹æ–¹æ³•ç­¾å</span></span><br></pre></td></tr></table></figure><h4 id="æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦"><a href="#æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦" class="headerlink" title="æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦"></a>æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦</h4><p><code>Spring AOP</code>æ”¯æŒä»¥ä¸‹åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„<code>AspectJ</code>åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦ï¼ˆPCDï¼‰ï¼š</p><ul><li><p><code>execution</code>ï¼šåŒ¹é…æ–¹æ³•æ‰§è¡Œçš„è¿æ¥ç‚¹ï¼Œè¿™æ˜¯ä½ å°†ä¼šç”¨åˆ°çš„Springçš„æœ€ä¸»è¦çš„åˆ‡å…¥ç‚¹æŒ‡å®šè€…ã€‚</p><blockquote><p>æè¿°çš„æœ€å°ç²’åº¦ç²¾ç¡®åˆ°æ–¹æ³•ï¼ˆç”šè‡³æ–¹æ³•çš„å‚æ•°ï¼‰</p></blockquote></li><li><p><code>within</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šç±»å‹çš„è¿æ¥ç‚¹ï¼ˆåœ¨ä½¿ç”¨SpringAOPçš„æ—¶å€™ï¼Œåœ¨åŒ¹é…çš„ç±»å‹ä¸­å®šä¹‰çš„æ–¹æ³•çš„æ‰§è¡Œï¼‰ã€‚</p><blockquote><p>æè¿°çš„æœ€å°ç²’åº¦ä»…ä»…åˆ°ä¸€ä¸ªç±»</p></blockquote></li><li><p><code>this</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨Spring AOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­bean referenceï¼ˆSpring AOP ä»£ç†ï¼‰æ˜¯<strong>æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚</strong>ï¼ˆä»£ç†çš„å¯¹è±¡æœ¬èº«ï¼‰</p></li><li><p><code>target</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­ç›®æ ‡å¯¹è±¡ï¼ˆè¢«ä»£ç†çš„appolication objectï¼‰æ˜¯<strong>æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚</strong>ï¼ˆè¢«ä»£ç†çš„å¯¹è±¡ï¼‰</p></li><li><p><code>args</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨Spring AOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­å‚æ•°æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚</p></li><li><p><code>@target</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­æ‰§è¡Œçš„å¯¹è±¡çš„ç±»å·²ç»æœ‰æŒ‡å®šç±»å‹çš„æ³¨è§£ã€‚</p></li><li><p>@argsï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­å®é™…ä¼ å…¥å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹æœ‰æŒ‡å®šç±»å‹çš„æ³¨è§£ã€‚</p></li><li><p><code>@within</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼Œå…¶ä¸­è¿æ¥ç‚¹æ‰€åœ¨ç±»å‹å·²æŒ‡å®šæ³¨è§£ï¼ˆåœ¨ä½¿ç”¨Spring AOPçš„æ—¶å€™ï¼Œæ‰€æ‰§è¡Œçš„æ–¹æ³•æ‰€åœ¨ç±»å‹å·²æŒ‡å®šæ³¨è§£ï¼‰ã€‚</p></li><li><p> <code>@annotation</code>ï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­è¿æ¥ç‚¹çš„ä¸»é¢˜æœ‰æŸç§ç»™å®šçš„æ³¨è§£åˆå¹¶åˆ‡å…¥ç‚¹è¡¨è¾¾å¼</p></li></ul><h4 id="ç»„åˆåˆ‡å…¥ç‚¹"><a href="#ç»„åˆåˆ‡å…¥ç‚¹" class="headerlink" title="ç»„åˆåˆ‡å…¥ç‚¹"></a>ç»„åˆåˆ‡å…¥ç‚¹</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨<code>&amp;&amp;</code>ï¼Œ<code>||</code>ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼å’Œ<code>ï¼</code>æ‚¨ä¹Ÿå¯ä»¥æŒ‰åç§°å¼•ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸‰ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(public * *(..))&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">anyPublicOperation</span><span class="params">()</span> </span>&#123;&#125;  <span class="comment">// 1âƒ£ï¸ åŒ¹é…æ‰€æœ‰å…¬å…±æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut(&quot;within(com.xyz.someapp.trading..*)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inTrading</span><span class="params">()</span> </span>&#123;&#125;  <span class="comment">// 2âƒ£ï¸ åŒ¹é…æŒ‡å®šåŒ…é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut(&quot;anyPublicOperation() &amp;&amp; inTrading()&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tradingOperation</span><span class="params">()</span> </span>&#123;&#125;  <span class="comment">// 3âƒ£ï¸ åŒ¹é…æŒ‡å®šåŒ…é‡Œé¢çš„æ‰€æœ‰å…¬å…±æ–¹æ³•</span></span><br></pre></td></tr></table></figure><h4 id="å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰"><a href="#å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰" class="headerlink" title="å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰"></a>å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰</h4><p>åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œå¼€å‘äººå‘˜é€šå¸¸å¸Œæœ›ä»å¤šä¸ªæ–¹é¢å¼•ç”¨åº”ç”¨ç¨‹åºçš„æ¨¡å—å’Œç‰¹å®šçš„æ“ä½œé›†ã€‚æˆ‘ä»¬å»ºè®®ä¸ºæ­¤å®šä¹‰ä¸€ä¸ª <code>SystemArchitecture</code>åˆ‡é¢ï¼Œä»¥æ•è·å¸¸è§çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚è¿™æ ·çš„æ–¹é¢é€šå¸¸ç±»ä¼¼äºä»¥ä¸‹ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.someapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemArchitecture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the web layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.web package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.web..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inWebLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the service layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.service package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.service..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inServiceLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the data access layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.dao package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.someapp.dao..*)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inDataAccessLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A business service is the execution of any method defined on a service</span></span><br><span class="line"><span class="comment">     * interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">     * &quot;service&quot; package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If you group service interfaces by functional area (for example,</span></span><br><span class="line"><span class="comment">     * in packages com.xyz.someapp.abc.service and com.xyz.someapp.def.service) then</span></span><br><span class="line"><span class="comment">     * the pointcut expression &quot;execution(* com.xyz.someapp..service.*.*(..))&quot;</span></span><br><span class="line"><span class="comment">     * could be used instead.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Alternatively, you can write the expression using the &#x27;bean&#x27;</span></span><br><span class="line"><span class="comment">     * PCD, like so &quot;bean(*Service)&quot;. (This assumes that you have</span></span><br><span class="line"><span class="comment">     * named your Spring service beans in a consistent fashion.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.xyz.someapp..service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">businessService</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A data access operation is the execution of any method defined on a</span></span><br><span class="line"><span class="comment">     * dao interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">     * &quot;dao&quot; package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.xyz.someapp.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dataAccessOperation</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨éœ€è¦åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ä»»ä½•åœ°æ–¹å¼•ç”¨åˆ‡é¢ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹ã€‚ä¾‹å¦‚ï¼Œè¦ä½¿æœåŠ¡å±‚å…·æœ‰äº‹åŠ¡æ€§ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    &lt;aop:advisor</span><br><span class="line">        pointcut=&quot;com.xyz.someapp.SystemArchitecture.businessService()&quot;</span><br><span class="line">        advice-ref=&quot;tx-advice&quot;/&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;tx-advice&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h4><blockquote><p>è¯­æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) <span class="keyword">throws</span>-pattern?)</span><br></pre></td></tr></table></figure><ul><li>é—®å·è¡¨ç¤ºå½“å‰é¡¹æœ‰ä¹Ÿå¯ä»¥æ²¡æœ‰</li><li>å…¶ä¸­å„é¡¹è¯­ä¹‰å¦‚ä¸‹ï¼š<ul><li><strong>modifiers- pattern</strong>ï¼šæ–¹æ³•çš„å¯è§æ€§ï¼Œå¦‚ public, protected</li><li><strong>ret-type- pattern</strong>ï¼šæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œå¦‚ int, void ç­‰</li><li><strong>declaring-type- pattern</strong>ï¼šæ–¹æ³•æ‰€åœ¨ç±»çš„å…¨è·¯å¾„åï¼Œå¦‚ com, spring, Aspect</li><li><strong>name- pattern</strong>ï¼šæ–¹æ³•åï¼Œå¦‚ bui sinessservice () </li><li><strong>param- pattern</strong>ï¼šæ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œå¦‚ java. Lang String</li><li><strong>throws- pattern</strong>: æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå¦‚ java.Lang. Exception</li></ul></li></ul></blockquote><p>ä¸€äº›å¸¸è§çš„è¡¨è¾¾å¼ï¼š</p><ul><li><p>åŒ¹é…ä»»æ„<code>public</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(<span class="keyword">public</span> * *(..))</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…æ‰€æœ‰ä»¥<code>set</code>å¼€å¤´çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* set*(..))</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…<code>AccountService</code>æ¥å£å®šä¹‰çš„ä»»ä½•æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* com.xyz.service.AccountService.*(..))</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…æŒ‡å®šåŒ…ä¸‹çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* com.xyz.service.*.*(..))</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…æŒ‡å®šåŒ…ä¸‹é¢çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­åŒ…ä¸‹çš„ç±»æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(* com.xyz.service..*.*(..))</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…<code>service</code>åŒ…ä¸­çš„æ‰€æœ‰è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">within(com.xyz.service.*)</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…<code>service</code>ä¸€ä¸ªæˆ–å¤šä¸ªå­åŒ…ä¸­çš„æ‰€æœ‰è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">within(com.xyz.service..*)</span><br></pre></td></tr></table></figure></li><li><p>ä»£ç†å®ç°<code>AccountService</code>æ¥å£çš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>(com.xyz.service.AccountService)</span><br></pre></td></tr></table></figure></li><li><p>ç›®æ ‡å¯¹è±¡å®ç°AccountServiceæ¥å£çš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">target(com.xyz.service.AccountService)</span><br></pre></td></tr></table></figure></li><li><p>ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°å¹¶ä¸”åœ¨è¿è¡Œæ—¶ä¼ é€’çš„å‚æ•°ä¸ºSerializableçš„è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">args(java.io.Serializable)</span><br></pre></td></tr></table></figure></li><li><p>ç›®æ ‡å¯¹è±¡å…·æœ‰<code>@Transactional</code>æ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@target(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure></li><li><p>ç›®æ ‡å¯¹è±¡çš„å£°æ˜ç±»å‹å…·æœ‰<code>@Transactional</code>æ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@within(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure></li><li><p>ä»»ä½•æ‰§è¡Œæ–¹æ³•å¸¦æœ‰@Transactionalæ‰¹æ³¨çš„è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@annotation(org.springframework.transaction.annotation.Transactional)</span></span><br></pre></td></tr></table></figure></li><li><p>ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°çš„è”æ¥ç‚¹ï¼Œå¹¶ä¸”ä¼ é€’çš„å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹å…·æœ‰<code>Classified</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@args(com.xyz.security.Classified)</span></span><br></pre></td></tr></table></figure></li><li><p>åä¸º<code>tradeService</code>çš„<code>Spring bean</code>ä¸Šçš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">bean(tradeService)</span><br></pre></td></tr></table></figure></li><li><p><code>Spring Bean</code>ä¸Šå…·æœ‰ä¸é€šé…ç¬¦è¡¨è¾¾å¼<code>* Service</code>åŒ¹é…çš„åç§°çš„ä»»ä½•è¿æ¥ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">bean(*Service)</span><br></pre></td></tr></table></figure></li></ul><h3 id="å£°æ˜é€šçŸ¥"><a href="#å£°æ˜é€šçŸ¥" class="headerlink" title="å£°æ˜é€šçŸ¥"></a>å£°æ˜é€šçŸ¥</h3><p>é€šçŸ¥ç”¨æ¥å£°æ˜æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œä¹‹åæˆ–å‘¨å›´è¿è¡Œã€‚åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å¯ä»¥æ˜¯å¯¹å‘½ååˆ‡å…¥ç‚¹çš„ç®€å•å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å°±åœ°å£°æ˜çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚</p><h4 id="Before-Advice"><a href="#Before-Advice" class="headerlink" title="Before Advice"></a>Before Advice</h4><p>ä½¿ç”¨<code>@Before</code>æ³¨è§£åœ¨åˆ‡é¢ä¸­å£°æ˜é€šçŸ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜é€šçŸ¥çš„åŒæ—¶å£°æ˜åˆ‡å…¥ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="After-Returning-Advice"><a href="#After-Returning-Advice" class="headerlink" title="After Returning Advice"></a>After Returning Advice</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ—¶ï¼Œæ‚¨éœ€è¦åœ¨é€šçŸ¥æ­£æ–‡ä¸­è®¿é—®è¿”å›çš„å®é™…å€¼ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>@AfterReturning</code>çš„å½¢å¼ç»‘å®šè¿”å›å€¼ä»¥è·å–è¯¥è®¿é—®æƒé™ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(</span></span><br><span class="line"><span class="meta">        pointcut=&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;,</span></span><br><span class="line"><span class="meta">        returning=&quot;retVal&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">(Object retVal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="After-Throwing-Advice"><a href="#After-Throwing-Advice" class="headerlink" title="After Throwing Advice"></a>After Throwing Advice</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterThrowingExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRecoveryActions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šå¼‚å¸¸ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterThrowingExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(</span></span><br><span class="line"><span class="meta">        pointcut=&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;,</span></span><br><span class="line"><span class="meta">        throwing=&quot;ex&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRecoveryActions</span><span class="params">(DataAccessException ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="After-Finally-Advice"><a href="#After-Finally-Advice" class="headerlink" title="After (Finally) Advice"></a>After (Finally) Advice</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterFinallyExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doReleaseLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Around-Advice"><a href="#Around-Advice" class="headerlink" title="Around Advice"></a>Around Advice</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;com.xyz.myapp.SystemArchitecture.businessService()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// start stopwatch</span></span><br><span class="line">        Object retVal = pjp.proceed();</span><br><span class="line">        <span class="comment">// stop stopwatch</span></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h3><p>å¼•å…¥ï¼ˆ<strong>Introductions</strong>ï¼‰ï¼ˆåœ¨AspectJä¸­ç§°ä¸ºç±»å‹é—´å£°æ˜ï¼‰ä½¿åˆ‡é¢å¯ä»¥å£°æ˜é€šçŸ¥å¯¹è±¡å®ç°ç»™å®šçš„æ¥å£ï¼Œå¹¶ä»£è¡¨é‚£äº›å¯¹è±¡æä¾›è¯¥æ¥å£çš„å®ç°ã€‚</p><p>æ‚¨å¯ä»¥ä½¿ç”¨<code>@DeclareParents</code>æ‰¹æ³¨è¿›è¡Œä»‹ç»ã€‚æ­¤æ‰¹æ³¨ç”¨äºå£°æ˜åŒ¹é…ç±»å‹å…·æœ‰æ–°çš„çˆ¶ä»£ï¼ˆå› æ­¤è€Œå¾—åï¼‰ã€‚ä¾‹å¦‚ï¼Œç»™å®šä¸€ä¸ªåä¸º<code>UsageTracked</code>çš„æ¥å£å’Œè¯¥æ¥å£åä¸º<code>DefaultUsageTracked</code>çš„å®ç°ï¼Œä»¥ä¸‹æ–¹é¢å£°æ˜æœåŠ¡æ¥å£çš„æ‰€æœ‰å®ç°è€…ä¹Ÿéƒ½å®ç°äº†<code>UsageTracked</code>æ¥å£ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡JMXå…¬å¼€ç»Ÿè®¡ä¿¡æ¯ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsageTracking</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeclareParents(value=&quot;com.xzy.myapp.service.*+&quot;, defaultImpl=DefaultUsageTracked.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UsageTracked mixin;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordUsage</span><span class="params">(UsageTracked usageTracked)</span> </span>&#123;</span><br><span class="line">        usageTracked.incrementUseCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-AOPå®ä¾‹"><a href="#Spring-AOPå®ä¾‹" class="headerlink" title="Spring AOPå®ä¾‹"></a>Spring AOPå®ä¾‹</h2><p><strong>ä»£ç åœ°å€ï¼š</strong><a href="https://github.com/cayzlh/cayzlh-demos">https://github.com/cayzlh/cayzlh-demos</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li><code>Spring</code>å€Ÿé‰´äº†<code>AspectJ</code>çš„è¯­æ³•</li><li><code>Spring</code>é€šè¿‡åŠ¨æ€ä»£ç†æ¥å®ç°<code>aop</code></li><li>å¯¹æ¥å£åˆ›å»ºä»£ç†ä¼˜äºå¯¹ç±»åˆ›å»ºä»£ç†ï¼Œå› ä¸ºä¼šäº§ç”Ÿæ›´åŠ æ¾è€¦åˆçš„ç³»ç»Ÿï¼Œæ‰€ä»¥springé»˜è®¤æ˜¯ä½¿ç”¨JDKä»£ç†ã€‚å¯¹ç±»ä»£ç†æ˜¯è®©é—ç•™ç³»ç»Ÿæˆ–æ— æ³•å®ç°æ¥å£çš„ç¬¬ä¸‰æ–¹ç±»åº“åŒæ ·å¯ä»¥å¾—åˆ°é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼åº”è¯¥æ˜¯å¤‡ç”¨æ–¹æ¡ˆ</li><li>æ ‡è®°ä¸º<code>final</code>çš„æ–¹æ³•ä¸èƒ½å¤Ÿè¢«é€šçŸ¥ã€‚springæ˜¯ä¸ºç›®æ ‡ç±»äº§ç”Ÿå­ç±»ã€‚ä»»ä½•éœ€è¦è¢«é€šçŸ¥çš„æ–¹æ³•éƒ½è¢«å¤å†™ï¼Œå°†é€šçŸ¥ç»‡å…¥ã€‚<code>final</code>æ–¹æ³•æ˜¯ä¸å…è®¸é‡å†™çš„</li><li>springåªæ”¯æŒæ–¹æ³•è¿æ¥ç‚¹ï¼šä¸æä¾›å±æ€§æ¥å…¥ç‚¹ï¼Œspringçš„è§‚ç‚¹æ˜¯å±æ€§æ‹¦æˆªç ´åäº†å°è£…ã€‚é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜¯å¯¹è±¡è‡ªå·±å¤„ç†å·¥ä½œï¼Œå…¶ä»–å¯¹è±¡åªèƒ½é€šè¿‡æ–¹æ³•è°ƒç”¨çš„å¾—åˆ°çš„ç»“æœ</li></ul><blockquote><p>springåœ¨è¿è¡ŒæœŸï¼Œç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨</p><p>Spring AOP ä¼˜å…ˆå¯¹æ¥å£è¿›è¡Œä»£ç† ï¼ˆä½¿ç”¨JdkåŠ¨æ€ä»£ç†ï¼‰å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œæ‰ä¼šå¯¹ç±»è¿›è¡Œä»£ç† ï¼ˆä½¿ç”¨cglibåŠ¨æ€ä»£ç†ï¼‰</p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop">Springå®˜ç½‘(aop)</a></li><li><a href="https://zhuanlan.zhihu.com/p/97223347">Spring AOPç®€ä»‹ä¸åº•å±‚å®ç°æœºåˆ¶â€”â€”åŠ¨æ€ä»£ç†</a></li><li><a href="https://blog.csdn.net/java_lyvee/article/details/101793774">springæºç ç³»åˆ—ï¼ˆä¸€ï¼‰â€”â€”springå¾ªç¯å¼•ç”¨</a></li><li><a href="https://segmentfault.com/a/1190000007469968">å½»åº•å¾æœ Spring AOP ä¹‹ ç†è®ºç¯‡</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatisä¸­ç”¨åˆ°çš„å‡ ç§è®¾è®¡æ¨¡å¼</title>
      <link href="/blog/2020/03/23/26b455b4.html"/>
      <url>/blog/2020/03/23/26b455b4.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è½¬è½½è‡ªï¼š<a href="http://www.crazyant.net/2022.html">http://www.crazyant.net/2022.html</a></p></blockquote><p>Mybatisè‡³å°‘é‡åˆ°äº†ä»¥ä¸‹çš„è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ï¼š</p><ol><li><strong>Builderæ¨¡å¼</strong>ï¼Œä¾‹å¦‚<code>SqlSessionFactoryBuilder</code>ã€<code>XMLConfigBuilder</code>ã€<code>XMLMapperBuilder</code>ã€<code>XMLStatementBuilder</code>ã€<code>CacheBuilder</code>ï¼›</li><li><strong>å·¥å‚æ¨¡å¼</strong>ï¼Œä¾‹å¦‚<code>SqlSessionFactory</code>ã€<code>ObjectFactory</code>ã€<code>MapperProxyFactory</code>ï¼›</li><li><strong>å•ä¾‹æ¨¡å¼</strong>ï¼Œä¾‹å¦‚ErrorContextå’Œ<code>LogFactory</code>ï¼›</li><li><strong>ä»£ç†æ¨¡å¼</strong>ï¼ŒMybatiså®ç°çš„æ ¸å¿ƒï¼Œæ¯”å¦‚<code>MapperProxy</code>ã€<code>ConnectionLogger</code>ï¼Œç”¨çš„jdkçš„åŠ¨æ€ä»£ç†ï¼›è¿˜æœ‰executor.loaderåŒ…ä½¿ç”¨äº†cglibæˆ–è€…javassistè¾¾åˆ°å»¶è¿ŸåŠ è½½çš„æ•ˆæœï¼›</li><li>ç»„åˆæ¨¡å¼ï¼Œä¾‹å¦‚<code>SqlNode</code>å’Œå„ä¸ªå­ç±»<code>ChooseSqlNode</code>ç­‰ï¼›</li><li><strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>ï¼Œä¾‹å¦‚<code>BaseExecutor</code>å’Œ<code>SimpleExecutor</code>ï¼Œè¿˜æœ‰<code>BaseTypeHandler</code>å’Œæ‰€æœ‰çš„å­ç±»ä¾‹å¦‚<code>IntegerTypeHandler</code>ï¼›</li><li><strong>é€‚é…å™¨æ¨¡å¼</strong>ï¼Œä¾‹å¦‚Logçš„Mybatisæ¥å£å’Œå®ƒå¯¹jdbcã€log4jç­‰å„ç§æ—¥å¿—æ¡†æ¶çš„é€‚é…å®ç°ï¼›</li><li><strong>è£…é¥°è€…æ¨¡å¼</strong>ï¼Œä¾‹å¦‚CacheåŒ…ä¸­çš„cache.decoratorså­åŒ…ä¸­ç­‰å„ä¸ªè£…é¥°è€…çš„å®ç°ï¼›</li><li><strong>è¿­ä»£å™¨æ¨¡å¼</strong>ï¼Œä¾‹å¦‚è¿­ä»£å™¨æ¨¡å¼<code>PropertyTokenizer</code>ï¼›</li></ol><p>æ¥ä¸‹æ¥æŒ¨ä¸ªæ¨¡å¼è¿›è¡Œè§£è¯»ï¼Œå…ˆä»‹ç»æ¨¡å¼è‡ªèº«çš„çŸ¥è¯†ï¼Œç„¶åè§£è¯»åœ¨Mybatisä¸­æ€æ ·åº”ç”¨äº†è¯¥æ¨¡å¼ã€‚</p><h2 id="Builderæ¨¡å¼"><a href="#Builderæ¨¡å¼" class="headerlink" title="Builderæ¨¡å¼"></a>Builderæ¨¡å¼</h2><p>Builderæ¨¡å¼çš„å®šä¹‰æ˜¯â€œå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºâ€ï¼Œå®ƒå±äºåˆ›å»ºç±»æ¨¡å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡çš„æ„å»ºæ¯”è¾ƒå¤æ‚ï¼Œè¶…å‡ºäº†æ„é€ å‡½æ•°æ‰€èƒ½åŒ…å«çš„èŒƒå›´ï¼Œå°±å¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼å’ŒBuilderæ¨¡å¼ï¼Œç›¸å¯¹äºå·¥å‚æ¨¡å¼ä¼šäº§å‡ºä¸€ä¸ªå®Œæ•´çš„äº§å“ï¼ŒBuilderåº”ç”¨äºæ›´åŠ å¤æ‚çš„å¯¹è±¡çš„æ„å»ºï¼Œç”šè‡³åªä¼šæ„å»ºäº§å“çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/c32qrf.jpg" alt="Builderæ¨¡å¼"></p><p>åœ¨Mybatisç¯å¢ƒçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œ<code>SqlSessionFactoryBuilder</code>ä¼šè°ƒç”¨<code>XMLConfigBuilder</code>è¯»å–æ‰€æœ‰çš„<code>MybatisMapConfig.xml</code>å’Œæ‰€æœ‰çš„*Mapper.xmlæ–‡ä»¶ï¼Œæ„å»ºMybatisè¿è¡Œçš„æ ¸å¿ƒå¯¹è±¡Configurationå¯¹è±¡ï¼Œç„¶åå°†è¯¥Configurationå¯¹è±¡ä½œä¸ºå‚æ•°æ„å»ºä¸€ä¸ªSqlSessionFactoryå¯¹è±¡ã€‚</p><p>å…¶ä¸­<code>XMLConfigBuilder</code>åœ¨æ„å»º<code>Configuration</code>å¯¹è±¡æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨<code>XMLMapperBuilder</code>ç”¨äºè¯»å–*Mapperæ–‡ä»¶ï¼Œè€Œ<code>XMLMapperBuilder</code>ä¼šä½¿ç”¨<code>XMLStatementBuilder</code>æ¥è¯»å–å’Œbuildæ‰€æœ‰çš„SQLè¯­å¥ã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªç›¸ä¼¼çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯è¿™äº›Builderä¼šè¯»å–æ–‡ä»¶æˆ–è€…é…ç½®ï¼Œç„¶ååšå¤§é‡çš„XpathParserè§£æã€é…ç½®æˆ–è¯­æ³•çš„è§£æã€åå°„ç”Ÿæˆå¯¹è±¡ã€å­˜å…¥ç»“æœç¼“å­˜ç­‰æ­¥éª¤ï¼Œè¿™ä¹ˆå¤šçš„å·¥ä½œéƒ½ä¸æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°æ‰€èƒ½åŒ…æ‹¬çš„ï¼Œå› æ­¤å¤§é‡é‡‡ç”¨äº†Builderæ¨¡å¼æ¥è§£å†³ã€‚</p><p>å¯¹äºbuilderçš„å…·ä½“ç±»ï¼Œæ–¹æ³•éƒ½å¤§éƒ½ç”¨build*å¼€å¤´ï¼Œæ¯”å¦‚<code>SqlSessionFactoryBuilder</code>ä¸ºä¾‹ï¼Œå®ƒåŒ…å«ä»¥ä¸‹æ–¹æ³•ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/KAGdgM.jpg" alt="SqlSessionFactoryBuilder"></p><p>å³æ ¹æ®ä¸åŒçš„è¾“å…¥å‚æ•°æ¥æ„å»º<code>SqlSessionFactory</code>è¿™ä¸ªå·¥å‚å¯¹è±¡ã€‚</p><h2 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h2><p>åœ¨Mybatisä¸­æ¯”å¦‚<code>SqlSessionFactory</code>ä½¿ç”¨çš„æ˜¯å·¥å‚æ¨¡å¼ï¼Œè¯¥å·¥å‚æ²¡æœ‰é‚£ä¹ˆå¤æ‚çš„é€»è¾‘ï¼Œæ˜¯ä¸€ä¸ªç®€å•å·¥å‚æ¨¡å¼ã€‚</p><p>ç®€å•å·¥å‚æ¨¡å¼(Simple Factory Pattern)ï¼šåˆç§°ä¸ºé™æ€å·¥å‚æ–¹æ³•(Static Factory Method)æ¨¡å¼ï¼Œå®ƒå±äºç±»åˆ›å»ºå‹æ¨¡å¼ã€‚åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ï¼Œå¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒè¿”å›ä¸åŒç±»çš„å®ä¾‹ã€‚ç®€å•å·¥å‚æ¨¡å¼ä¸“é—¨å®šä¹‰ä¸€ä¸ªç±»æ¥è´Ÿè´£åˆ›å»ºå…¶ä»–ç±»çš„å®ä¾‹ï¼Œè¢«åˆ›å»ºçš„å®ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„çˆ¶ç±»ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/Z3PDMk.jpg" alt="ç®€å•å·¥å‚æ¨¡å¼"></p><p>SqlSessionå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªMybatiså·¥ä½œçš„æ ¸å¿ƒçš„æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥æ‰§è¡Œæ‰§è¡ŒSQLè¯­å¥ã€è·å–Mappersã€ç®¡ç†äº‹åŠ¡ã€‚ç±»ä¼¼äºè¿æ¥MySQLçš„Connectionå¯¹è±¡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/70L93B.jpg" alt="70L93B"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥Factoryçš„openSessionæ–¹æ³•é‡è½½äº†å¾ˆå¤šä¸ªï¼Œåˆ†åˆ«æ”¯æŒautoCommitã€Executorã€Transactionç­‰å‚æ•°çš„è¾“å…¥ï¼Œæ¥æ„å»ºæ ¸å¿ƒçš„SqlSessionå¯¹è±¡ã€‚</p><p>åœ¨DefaultSqlSessionFactoryçš„é»˜è®¤å·¥å‚å®ç°é‡Œï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºå·¥å‚æ€ä¹ˆäº§å‡ºä¸€ä¸ªäº§å“ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             TransactionIsolationLevel level,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">boolean</span> autoCommit)</span> </span>&#123;</span><br><span class="line">Transaction tx = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">final</span> Environment environment = configuration.getEnvironment();</span><br><span class="line"><span class="keyword">final</span> TransactionFactory transactionFactory = </span><br><span class="line">        getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">tx = </span><br><span class="line">        transactionFactory.newTransaction(environment.getDataSource(), </span><br><span class="line">                                          level, autoCommit);</span><br><span class="line"><span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call</span></span><br><span class="line"><span class="comment">// close()</span></span><br><span class="line"><span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">ErrorContext.instance().reset();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªopenSessionè°ƒç”¨çš„åº•å±‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…ˆä»configurationè¯»å–å¯¹åº”çš„ç¯å¢ƒé…ç½®ï¼Œç„¶ååˆå§‹åŒ–<code>TransactionFactory</code>è·å¾—ä¸€ä¸ª<code>Transaction</code>å¯¹è±¡ï¼Œç„¶åé€šè¿‡<code>Transaction</code>è·å–ä¸€ä¸ª<code>Executor</code>å¯¹è±¡ï¼Œæœ€åé€šè¿‡configurationã€Executorã€æ˜¯å¦autoCommitä¸‰ä¸ªå‚æ•°æ„å»ºäº†<code>SqlSession</code>ã€‚</p><p>åœ¨è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥çœ‹åˆ°ç«¯å€ªï¼Œ<code>SqlSession</code>çš„æ‰§è¡Œï¼Œå…¶å®æ˜¯å§”æ‰˜ç»™å¯¹åº”çš„<code>Executor</code>æ¥è¿›è¡Œçš„ã€‚</p><p>è€Œå¯¹äº<code>LogFactory</code>ï¼Œå®ƒçš„å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Log&gt; logConstructor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LogFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// disable construction</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Log <span class="title">getLog</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getLog(aClass.getName());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªç‰¹åˆ«çš„åœ°æ–¹ï¼Œæ˜¯Logå˜é‡çš„çš„ç±»å‹æ˜¯<code>Constructor</code>ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å·¥å‚ç”Ÿäº§çš„ä¸åªæ˜¯ä¸€ä¸ªäº§å“ï¼Œè€Œæ˜¯å…·æœ‰Logå…¬å…±æ¥å£çš„ä¸€ç³»åˆ—äº§å“ï¼Œæ¯”å¦‚<code>Log4jImpl</code>ã€<code>Slf4jImpl</code>ç­‰å¾ˆå¤šå…·ä½“çš„Logã€‚</p><h2 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><p>å•ä¾‹æ¨¡å¼(Singleton Pattern)ï¼šå•ä¾‹æ¨¡å¼ç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªç±»ç§°ä¸ºå•ä¾‹ç±»ï¼Œå®ƒæä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•ã€‚</p><p>å•ä¾‹æ¨¡å¼çš„è¦ç‚¹æœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼›äºŒæ˜¯å®ƒå¿…é¡»è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹ï¼›ä¸‰æ˜¯å®ƒå¿…é¡»è‡ªè¡Œå‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼ã€‚å•ä¾‹æ¨¡å¼åˆåå•ä»¶æ¨¡å¼æˆ–å•æ€æ¨¡å¼ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/tHOgLF.jpg" alt="tHOgLF"></p><p>åœ¨Mybatisä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°å•ä¾‹æ¨¡å¼ï¼Œ<code>ErrorContext</code>å’Œ<code>LogFactory</code>ï¼Œå…¶ä¸­<code>ErrorContext</code>æ˜¯ç”¨åœ¨æ¯ä¸ªçº¿ç¨‹èŒƒå›´å†…çš„å•ä¾‹ï¼Œç”¨äºè®°å½•è¯¥çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒé”™è¯¯ä¿¡æ¯ï¼Œè€Œ<code>LogFactory</code>åˆ™æ˜¯æä¾›ç»™æ•´ä¸ªMybatisä½¿ç”¨çš„æ—¥å¿—å·¥å‚ï¼Œç”¨äºè·å¾—é’ˆå¯¹é¡¹ç›®é…ç½®å¥½çš„æ—¥å¿—å¯¹è±¡ã€‚</p><p><code>ErrorContext</code>çš„å•ä¾‹å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ErrorContext&gt; LOCAL = <span class="keyword">new</span> ThreadLocal&lt;ErrorContext&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ErrorContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ErrorContext <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ErrorContext context = LOCAL.get();</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = <span class="keyword">new</span> ErrorContext();</span><br><span class="line">            LOCAL.set(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°æ˜¯privateä¿®é¥°ï¼Œå…·æœ‰ä¸€ä¸ªstaticçš„å±€éƒ¨instanceå˜é‡å’Œä¸€ä¸ªè·å–instanceå˜é‡çš„æ–¹æ³•ï¼Œåœ¨è·å–å®ä¾‹çš„æ–¹æ³•ä¸­ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºå¦‚æœæ˜¯çš„è¯å°±å…ˆåˆ›å»ºï¼Œç„¶åè¿”å›æ„é€ å¥½çš„å¯¹è±¡ã€‚</p><p>åªæ˜¯è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„åœ°æ–¹æ˜¯ï¼ŒLOCALçš„é™æ€å®ä¾‹å˜é‡ä½¿ç”¨äº†<code>ThreadLocal</code>ä¿®é¥°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå±äºæ¯ä¸ªçº¿ç¨‹å„è‡ªçš„æ•°æ®ï¼Œè€Œåœ¨<code>instance()</code>æ–¹æ³•ä¸­ï¼Œå…ˆè·å–æœ¬çº¿ç¨‹çš„è¯¥å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºè¯¥çº¿ç¨‹ç‹¬æœ‰çš„<code>ErrorContext</code>ã€‚</p><h2 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h2><p>ä»£ç†æ¨¡å¼å¯ä»¥è®¤ä¸ºæ˜¯Mybatisçš„æ ¸å¿ƒä½¿ç”¨çš„æ¨¡å¼ï¼Œæ­£æ˜¯ç”±äºè¿™ä¸ªæ¨¡å¼ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™<code>Mapper.java</code>æ¥å£ï¼Œä¸éœ€è¦å®ç°ï¼Œç”±Mybatisåå°å¸®æˆ‘ä»¬å®Œæˆå…·ä½“SQLçš„æ‰§è¡Œã€‚</p><p>ä»£ç†æ¨¡å¼(Proxy Pattern) ï¼šç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ ç†ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå¯¹è±¡çš„å¼•ç”¨ã€‚ä»£ç†æ¨¡å¼çš„è‹± æ–‡å«åšProxyæˆ–Surrogateï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚</p><p>ä»£ç†æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š</p><ul><li>Subject: æŠ½è±¡ä¸»é¢˜è§’è‰²</li><li>Proxy: ä»£ç†ä¸»é¢˜è§’è‰²</li><li>RealSubject: çœŸå®ä¸»é¢˜è§’è‰²</li></ul><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/57qXzr.jpg" alt="57qXzr"></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€ä¸ªæ˜¯æå‰åˆ›å»ºä¸€ä¸ªProxyï¼Œç¬¬äºŒä¸ªæ˜¯ä½¿ç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è¯·æ±‚Proxyï¼Œç„¶åç”±Proxyæ¥æ‰§è¡Œå…·ä½“äº‹åŠ¡ï¼›</p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>Configuration</code>çš„<code>getMapper</code>æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨<code>mapperRegistry.getMapper</code>æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•åˆä¼šè°ƒç”¨<code>mapperProxyFactory.newInstance(sqlSession)</code>æ¥ç”Ÿæˆä¸€ä¸ªå…·ä½“çš„ä»£ç†ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> mapperInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Method, MapperMethod&gt; <span class="title">getMethodCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> methodCache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), </span><br><span class="line">                                          <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;,</span><br><span class="line">                mapperProxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, </span><br><span class="line">                                                              mapperInterface, methodCache);</span><br><span class="line">        <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œå…ˆé€šè¿‡<code>T newInstance(SqlSession sqlSession)</code>æ–¹æ³•ä¼šå¾—åˆ°ä¸€ä¸ª<code>MapperProxy</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨<code>T newInstance(MapperProxy mapperProxy)</code>ç”Ÿæˆä»£ç†å¯¹è±¡ç„¶åè¿”å›ã€‚</p><p>è€ŒæŸ¥çœ‹<code>MapperProxy</code>çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">                <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">        <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>éå¸¸å…¸å‹çš„ï¼Œè¯¥<code>MapperProxy</code>ç±»å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œå¹¶ä¸”å®ç°äº†è¯¥æ¥å£çš„<code>invoke</code>æ–¹æ³•ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™<code>Mapper.java</code>æ¥å£ç±»ï¼Œå½“çœŸæ­£æ‰§è¡Œä¸€ä¸ª<code>Mapper</code>æ¥å£çš„æ—¶å€™ï¼Œå°±ä¼šè½¬å‘ç»™<code>MapperProxy.invoke</code>æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•åˆ™ä¼šè°ƒç”¨åç»­çš„<code>sqlSession.cud&gt;executor.execute&gt;prepareStatement</code>ç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå®ŒæˆSQLçš„æ‰§è¡Œå’Œè¿”å›ã€‚</p><h2 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h2><p>ç»„åˆæ¨¡å¼ç»„åˆå¤šä¸ªå¯¹è±¡å½¢æˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œæ•´ä½“-éƒ¨åˆ†â€çš„ç»“æ„å±‚æ¬¡ã€‚</p><p>ç»„åˆæ¨¡å¼å¯¹å•ä¸ªå¯¹è±¡(å¶å­å¯¹è±¡)å’Œç»„åˆå¯¹è±¡(ç»„åˆå¯¹è±¡)å…·æœ‰ä¸€è‡´æ€§ï¼Œå®ƒå°†å¯¹è±¡ç»„ç»‡åˆ°æ ‘ç»“æ„ä¸­ï¼Œå¯ä»¥ç”¨æ¥æè¿°æ•´ä½“ä¸éƒ¨åˆ†çš„å…³ç³»ã€‚åŒæ—¶å®ƒä¹Ÿæ¨¡ç³Šäº†ç®€å•å…ƒç´ (å¶å­å¯¹è±¡)å’Œå¤æ‚å…ƒç´ (å®¹å™¨å¯¹è±¡)çš„æ¦‚å¿µï¼Œä½¿å¾—å®¢æˆ·èƒ½å¤Ÿåƒå¤„ç†ç®€å•å…ƒç´ ä¸€æ ·æ¥å¤„ç†å¤æ‚å…ƒç´ ï¼Œä»è€Œä½¿å®¢æˆ·ç¨‹åºèƒ½å¤Ÿä¸å¤æ‚å…ƒç´ çš„å†…éƒ¨ç»“æ„è§£è€¦ã€‚</p><p>åœ¨ä½¿ç”¨ç»„åˆæ¨¡å¼ä¸­éœ€è¦æ³¨æ„ä¸€ç‚¹ä¹Ÿæ˜¯ç»„åˆæ¨¡å¼æœ€å…³é”®çš„åœ°æ–¹ï¼šå¶å­å¯¹è±¡å’Œç»„åˆå¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£ã€‚è¿™å°±æ˜¯ç»„åˆæ¨¡å¼èƒ½å¤Ÿå°†å¶å­èŠ‚ç‚¹å’Œå¯¹è±¡èŠ‚ç‚¹è¿›è¡Œä¸€è‡´å¤„ç†çš„åŸå› ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/kEL5d7.jpg" alt="kEL5d7"></p><p>Mybatisæ”¯æŒåŠ¨æ€SQLçš„å¼ºå¤§åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™ä¸ªSQLï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;org.format.dynamicproxy.mybatis.bean.User&quot;</span>&gt;</span></span><br><span class="line">    UPDATE users</span><br><span class="line">    <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;SET&quot;</span> <span class="attr">prefixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">            name = #&#123;name&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;age != null and age != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">            , age = #&#123;age&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;birthday != null and birthday != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">            , birthday = #&#123;birthday&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    where id = $&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé¢ä½¿ç”¨åˆ°äº†trimã€ifç­‰åŠ¨æ€å…ƒç´ ï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶æ¥ç”Ÿæˆä¸åŒæƒ…å†µä¸‹çš„SQLï¼›</p><p>åœ¨<code>DynamicSqlSource.getBoundSql</code>æ–¹æ³•é‡Œï¼Œè°ƒç”¨äº†<code>rootSqlNode.apply(context)</code>æ–¹æ³•ï¼Œ<code>apply</code>æ–¹æ³•æ˜¯æ‰€æœ‰çš„åŠ¨æ€èŠ‚ç‚¹éƒ½å®ç°çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlNode</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå®ç°è¯¥<code>SqlSource</code>æ¥å£çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°±æ˜¯æ•´ä¸ªç»„åˆæ¨¡å¼æ ‘çš„å„ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/4eSz9o.jpg" alt="4eSz9o"></p><p>ç»„åˆæ¨¡å¼çš„ç®€å•ä¹‹å¤„åœ¨äºï¼Œæ‰€æœ‰çš„å­èŠ‚ç‚¹éƒ½æ˜¯åŒä¸€ç±»èŠ‚ç‚¹ï¼Œå¯ä»¥é€’å½’çš„å‘ä¸‹æ‰§è¡Œï¼Œæ¯”å¦‚å¯¹äºTextSqlNodeï¼Œå› ä¸ºå®ƒæ˜¯æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç›´æ¥å°†å¯¹åº”çš„å†…å®¹appendåˆ°SQLè¯­å¥ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  GenericTokenParser parser = createParser(<span class="keyword">new</span> BindingTokenParser(context,</span><br><span class="line">                                                                  injectionFilter));</span><br><span class="line">  context.appendSql(parser.parse(text));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºIfSqlNodeï¼Œå°±éœ€è¦å…ˆåšåˆ¤æ–­ï¼Œå¦‚æœåˆ¤æ–­é€šè¿‡ï¼Œä»ç„¶ä¼šè°ƒç”¨å­å…ƒç´ çš„SqlNodeï¼Œå³<code>contents.apply</code>æ–¹æ³•ï¼Œå®ç°é€’å½’çš„è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">        contents.apply(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h2><p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯æ‰€æœ‰æ¨¡å¼ä¸­æœ€ä¸ºå¸¸è§çš„å‡ ä¸ªæ¨¡å¼ä¹‹ä¸€ï¼Œæ˜¯åŸºäºç»§æ‰¿çš„ä»£ç å¤ç”¨çš„åŸºæœ¬æŠ€æœ¯ã€‚</p><p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼éœ€è¦å¼€å‘æŠ½è±¡ç±»å’Œå…·ä½“å­ç±»çš„è®¾è®¡å¸ˆä¹‹é—´çš„åä½œã€‚ä¸€ä¸ªè®¾è®¡å¸ˆè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ï¼Œå¦ä¸€äº›è®¾è®¡å¸ˆåˆ™è´Ÿè´£ç»™å‡ºè¿™ä¸ªç®—æ³•çš„å„ä¸ªé€»è¾‘æ­¥éª¤ã€‚ä»£è¡¨è¿™äº›å…·ä½“é€»è¾‘æ­¥éª¤çš„æ–¹æ³•ç§°åšåŸºæœ¬æ–¹æ³•(primitive method)ï¼›è€Œå°†è¿™äº›åŸºæœ¬æ–¹æ³•æ±‡æ€»èµ·æ¥çš„æ–¹æ³•å«åšæ¨¡æ¿æ–¹æ³•(template method)ï¼Œè¿™ä¸ªè®¾è®¡æ¨¡å¼çš„åå­—å°±æ˜¯ä»æ­¤è€Œæ¥ã€‚</p><p>æ¨¡æ¿ç±»å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/mPNlOa.jpg" alt="mPNlOa"></p><p>åœ¨Mybatisä¸­ï¼ŒsqlSessionçš„SQLæ‰§è¡Œï¼Œéƒ½æ˜¯å§”æ‰˜ç»™Executorå®ç°çš„ï¼ŒExecutoråŒ…å«ä»¥ä¸‹ç»“æ„ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/dq9xXH.jpg" alt="dq9xXH"></p><p>å…¶ä¸­çš„BaseExecutorå°±é‡‡ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå®ƒå®ç°äº†å¤§éƒ¨åˆ†çš„SQLæ‰§è¡Œé€»è¾‘ï¼Œç„¶åæŠŠä»¥ä¸‹å‡ ä¸ªæ–¹æ³•äº¤ç»™å­ç±»å®šåˆ¶åŒ–å®Œæˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">     contents.apply(context);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ¨¡æ¿æ–¹æ³•ç±»æœ‰å‡ ä¸ªå­ç±»çš„å…·ä½“å®ç°ï¼Œä½¿ç”¨äº†ä¸åŒçš„ç­–ç•¥ï¼š</p><ul><li>ç®€å•<code>SimpleExecutor</code>ï¼šæ¯æ‰§è¡Œä¸€æ¬¡<code>update</code>æˆ–<code>select</code>ï¼Œå°±å¼€å¯ä¸€ä¸ª<code>Statement</code>å¯¹è±¡ï¼Œç”¨å®Œç«‹åˆ»å…³é—­<code>Statement</code>å¯¹è±¡ã€‚ï¼ˆå¯ä»¥æ˜¯<code>Statement</code>æˆ–<code>PrepareStatement</code>å¯¹è±¡ï¼‰</li><li>é‡ç”¨<code>ReuseExecutor</code>ï¼šæ‰§è¡Œ<code>update</code>æˆ–<code>select</code>ï¼Œä»¥sqlä½œä¸ºkeyæŸ¥æ‰¾<code>Statement</code>å¯¹è±¡ï¼Œå­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºï¼Œç”¨å®Œåï¼Œä¸å…³é—­<code>Statement</code>å¯¹è±¡ï¼Œè€Œæ˜¯æ”¾ç½®äº<code>Map</code>å†…ï¼Œä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨ã€‚ï¼ˆå¯ä»¥æ˜¯<code>Statement</code>æˆ–<code>PrepareStatement</code>å¯¹è±¡ï¼‰</li><li>æ‰¹é‡<code>BatchExecutor</code>ï¼šæ‰§è¡Œupdateï¼ˆæ²¡æœ‰selectï¼ŒJDBCæ‰¹å¤„ç†ä¸æ”¯æŒselectï¼‰ï¼Œå°†æ‰€æœ‰sqléƒ½æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­ï¼ˆ<code>addBatch()</code>ï¼‰ï¼Œç­‰å¾…ç»Ÿä¸€æ‰§è¡Œï¼ˆ<code>executeBatch()</code>ï¼‰ï¼Œå®ƒç¼“å­˜äº†å¤šä¸ªStatementå¯¹è±¡ï¼Œæ¯ä¸ªStatementå¯¹è±¡éƒ½æ˜¯<code>addBatch()</code>å®Œæ¯•åï¼Œç­‰å¾…é€ä¸€æ‰§è¡Œ<code>executeBatch()</code>æ‰¹å¤„ç†çš„ï¼›<code>BatchExecutor</code>ç›¸å½“äºç»´æŠ¤äº†å¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶é‡Œéƒ½è£…äº†å¾ˆå¤šå±äºè‡ªå·±çš„SQLï¼Œå°±åƒè‹¹æœè“é‡Œè£…äº†å¾ˆå¤šè‹¹æœï¼Œç•ªèŒ„è“é‡Œè£…äº†å¾ˆå¤šç•ªèŒ„ï¼Œæœ€åï¼Œå†ç»Ÿä¸€å€’è¿›ä»“åº“ã€‚ï¼ˆå¯ä»¥æ˜¯Statementæˆ–PrepareStatementå¯¹è±¡ï¼‰</li></ul><p>æ¯”å¦‚åœ¨SimpleExecutorä¸­è¿™æ ·å®ç°updateæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        <span class="keyword">return</span> handler.update(stmt);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h2><p>é€‚é…å™¨æ¨¡å¼(Adapter Pattern) ï¼šå°†ä¸€ä¸ªæ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œé€‚é…å™¨æ¨¡å¼ä½¿æ¥å£ä¸å…¼å®¹çš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œï¼Œå…¶åˆ«åä¸ºåŒ…è£…å™¨(Wrapper)ã€‚é€‚é…å™¨æ¨¡å¼æ—¢å¯ä»¥ä½œä¸ºç±»ç»“æ„å‹æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/rkEM6Y.jpg" alt="rkEM6Y"></p><p>åœ¨Mybatsiçš„loggingåŒ…ä¸­ï¼Œæœ‰ä¸€ä¸ªLogæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDebugEnabled</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTraceEnabled</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, Throwable e)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">trace</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">warn</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ¥å£å®šä¹‰äº†Mybatisç›´æ¥ä½¿ç”¨çš„æ—¥å¿—æ–¹æ³•ï¼Œè€ŒLogæ¥å£å…·ä½“ç”±è°æ¥å®ç°å‘¢ï¼ŸMybatisæä¾›äº†å¤šç§æ—¥å¿—æ¡†æ¶çš„å®ç°ï¼Œè¿™äº›å®ç°éƒ½åŒ¹é…è¿™ä¸ªLogæ¥å£æ‰€å®šä¹‰çš„æ¥å£æ–¹æ³•ï¼Œæœ€ç»ˆå®ç°äº†æ‰€æœ‰å¤–éƒ¨æ—¥å¿—æ¡†æ¶åˆ°Mybatisæ—¥å¿—åŒ…çš„é€‚é…ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/uVGQZ0.jpg" alt="uVGQZ0"></p><p>æ¯”å¦‚å¯¹äº<code>Log4jImpl</code>çš„å®ç°æ¥è¯´ï¼Œè¯¥å®ç°æŒæœ‰äº†<code>org.apache.log4j.Logger</code>çš„å®ä¾‹ï¼Œç„¶åæ‰€æœ‰çš„æ—¥å¿—æ–¹æ³•ï¼Œå‡å§”æ‰˜è¯¥å®ä¾‹æ¥å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Log4jImpl</span> <span class="keyword">implements</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FQCN = Log4jImpl.class.getName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Log4jImpl</span><span class="params">(String clazz)</span> </span>&#123;</span><br><span class="line">        log = Logger.getLogger(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDebugEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> log.isDebugEnabled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTraceEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> log.isTraceEnabled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, Throwable e)</span> </span>&#123;</span><br><span class="line">        log.log(FQCN, Level.ERROR, s, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        log.log(FQCN, Level.ERROR, s, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        log.log(FQCN, Level.DEBUG, s, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trace</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        log.log(FQCN, Level.TRACE, s, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        log.log(FQCN, Level.WARN, s, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è£…é¥°è€…æ¨¡å¼"><a href="#è£…é¥°è€…æ¨¡å¼" class="headerlink" title="è£…é¥°è€…æ¨¡å¼"></a>è£…é¥°è€…æ¨¡å¼</h2><p>è£…é¥°æ¨¡å¼(Decorator Pattern) ï¼šåŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ ä¸€äº›é¢å¤–çš„èŒè´£(Responsibility)ï¼Œå°±å¢åŠ å¯¹è±¡åŠŸèƒ½æ¥è¯´ï¼Œè£…é¥°æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»å®ç°æ›´ä¸ºçµæ´»ã€‚å…¶åˆ«åä¹Ÿå¯ä»¥ç§°ä¸ºåŒ…è£…å™¨(Wrapper)ï¼Œä¸é€‚é…å™¨æ¨¡å¼çš„åˆ«åç›¸åŒï¼Œä½†å®ƒä»¬é€‚ç”¨äºä¸åŒçš„åœºåˆã€‚æ ¹æ®ç¿»è¯‘çš„ä¸åŒï¼Œè£…é¥°æ¨¡å¼ä¹Ÿæœ‰äººç§°ä¹‹ä¸ºâ€œæ²¹æ¼†å·¥æ¨¡å¼â€ï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/BdaHcM.jpg" alt="BdaHcM"></p><p>åœ¨mybatisä¸­ï¼Œç¼“å­˜çš„åŠŸèƒ½ç”±æ ¹æ¥å£<code>Cacheï¼ˆorg.apache.ibatis.cache.Cacheï¼‰</code>å®šä¹‰ã€‚æ•´ä¸ªä½“ç³»é‡‡ç”¨è£…é¥°å™¨è®¾è®¡æ¨¡å¼ï¼Œæ•°æ®å­˜å‚¨å’Œç¼“å­˜çš„åŸºæœ¬åŠŸèƒ½ç”±<code>PerpetualCacheï¼ˆorg.apache.ibatis.cache.impl.PerpetualCacheï¼‰</code>æ°¸ä¹…ç¼“å­˜å®ç°ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ—çš„è£…é¥°å™¨æ¥å¯¹<code>PerpetualCache</code>æ°¸ä¹…ç¼“å­˜è¿›è¡Œç¼“å­˜ç­–ç•¥ç­‰æ–¹ä¾¿çš„æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š</p><p>ç”¨äºè£…é¥°PerpetualCacheçš„æ ‡å‡†è£…é¥°å™¨å…±æœ‰8ä¸ªï¼ˆå…¨éƒ¨åœ¨org.apache.ibatis.cache.decoratorsåŒ…ä¸­ï¼‰ï¼š</p><ol><li><code>FifoCache</code>ï¼šå…ˆè¿›å…ˆå‡ºç®—æ³•ï¼Œç¼“å­˜å›æ”¶ç­–ç•¥</li><li><code>LoggingCache</code>ï¼šè¾“å‡ºç¼“å­˜å‘½ä¸­çš„æ—¥å¿—ä¿¡æ¯</li><li><code>LruCache</code>ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œç¼“å­˜å›æ”¶ç­–ç•¥</li><li><code>ScheduledCache</code>ï¼šè°ƒåº¦ç¼“å­˜ï¼Œè´Ÿè´£å®šæ—¶æ¸…ç©ºç¼“å­˜</li><li><code>SerializedCache</code>ï¼šç¼“å­˜åºåˆ—åŒ–å’Œååºåˆ—åŒ–å­˜å‚¨</li><li><code>SoftCache</code>ï¼šåŸºäºè½¯å¼•ç”¨å®ç°çš„ç¼“å­˜ç®¡ç†ç­–ç•¥</li><li><code>SynchronizedCache</code>ï¼šåŒæ­¥çš„ç¼“å­˜è£…é¥°å™¨ï¼Œç”¨äºé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘è®¿é—®</li><li><code>WeakCache</code>ï¼šåŸºäºå¼±å¼•ç”¨å®ç°çš„ç¼“å­˜ç®¡ç†ç­–ç•¥</li></ol><p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è£…é¥°å™¨<code>TransactionalCache</code>ï¼šäº‹åŠ¡æ€§çš„ç¼“å­˜æ­£å¦‚å¤§å¤šæ•°æŒä¹…å±‚æ¡†æ¶ä¸€æ ·ï¼Œmybatisç¼“å­˜åŒæ ·åˆ†ä¸ºä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜</p><ul><li>ä¸€çº§ç¼“å­˜ï¼Œåˆå«æœ¬åœ°ç¼“å­˜ï¼Œæ˜¯<code>PerpetualCache</code>ç±»å‹çš„æ°¸ä¹…ç¼“å­˜ï¼Œä¿å­˜åœ¨æ‰§è¡Œå™¨ä¸­ï¼ˆ<code>BaseExecutor</code>ï¼‰ï¼Œè€Œæ‰§è¡Œå™¨åˆåœ¨<code>SqlSession</code>ï¼ˆ<code>DefaultSqlSession</code>ï¼‰ä¸­ï¼Œæ‰€ä»¥ä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸä¸<code>SqlSession</code>æ˜¯ç›¸åŒçš„ã€‚</li><li>äºŒçº§ç¼“å­˜ï¼Œåˆå«è‡ªå®šä¹‰ç¼“å­˜ï¼Œå®ç°äº†<code>Cache</code>æ¥å£çš„ç±»éƒ½å¯ä»¥ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œæ‰€ä»¥å¯é…ç½®å¦‚encacheç­‰çš„ç¬¬ä¸‰æ–¹ç¼“å­˜ã€‚äºŒçº§ç¼“å­˜ä»¥namespaceåç§°ç©ºé—´ä¸ºå…¶å”¯ä¸€æ ‡è¯†ï¼Œè¢«ä¿å­˜åœ¨<code>Configuration</code>æ ¸å¿ƒé…ç½®å¯¹è±¡ä¸­ã€‚</li></ul><p>äºŒçº§ç¼“å­˜å¯¹è±¡çš„é»˜è®¤ç±»å‹ä¸ºPerpetualCacheï¼Œå¦‚æœé…ç½®çš„ç¼“å­˜æ˜¯é»˜è®¤ç±»å‹ï¼Œåˆ™mybatisä¼šæ ¹æ®é…ç½®è‡ªåŠ¨è¿½åŠ ä¸€ç³»åˆ—è£…é¥°å™¨ã€‚</p><p>Cacheå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨é¡ºåºä¸ºï¼š</p><p><code>SynchronizedCache</code>â€“&gt;<code>LoggingCache</code>â€“&gt;<code>SerializedCache</code>â€“&gt;<code>ScheduledCache</code>â€“&gt;<code>LruCache</code>â€“&gt;<code>PerpetualCache</code></p><h2 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h2><p>è¿­ä»£å™¨ï¼ˆIteratorï¼‰æ¨¡å¼ï¼Œåˆå«åšæ¸¸æ ‡ï¼ˆCursorï¼‰æ¨¡å¼ã€‚GOFç»™å‡ºçš„å®šä¹‰ä¸ºï¼šæä¾›ä¸€ç§æ–¹æ³•è®¿é—®ä¸€ä¸ªå®¹å™¨ï¼ˆcontainerï¼‰å¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨ç»†èŠ‚ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/49UcwT.jpg" alt="49UcwT"></p><p>Javaçš„<code>Iterator</code>å°±æ˜¯è¿­ä»£å™¨æ¨¡å¼çš„æ¥å£ï¼Œåªè¦å®ç°äº†è¯¥æ¥å£ï¼Œå°±ç›¸å½“äºåº”ç”¨äº†è¿­ä»£å™¨æ¨¡å¼ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/dsNpxb.jpg" alt="dsNpxb"></p><p>æ¯”å¦‚Mybatisçš„<code>PropertyTokenizer</code>æ˜¯propertyåŒ…ä¸­çš„é‡é‡çº§ç±»ï¼Œè¯¥ç±»ä¼šè¢«reflectionåŒ…ä¸­å…¶ä»–çš„ç±»é¢‘ç¹çš„å¼•ç”¨åˆ°ã€‚è¿™ä¸ªç±»å®ç°äº†<code>Iterator</code>æ¥å£ï¼Œåœ¨ä½¿ç”¨æ—¶ç»å¸¸è¢«ç”¨åˆ°çš„æ˜¯<code>Iterator</code>æ¥å£ä¸­çš„<code>hasNext</code>è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyTokenizer</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">PropertyTokenizer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String indexedName;</span><br><span class="line">    <span class="keyword">private</span> String index;</span><br><span class="line">    <span class="keyword">private</span> String children;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertyTokenizer</span><span class="params">(String fullname)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> delim = fullname.indexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            name = fullname.substring(<span class="number">0</span>, delim);</span><br><span class="line">            children = fullname.substring(delim + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            name = fullname;</span><br><span class="line">            children = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        indexedName = name;</span><br><span class="line">        delim = name.indexOf(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            index = name.substring(delim + <span class="number">1</span>, name.length() - <span class="number">1</span>);</span><br><span class="line">            name = name.substring(<span class="number">0</span>, delim);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIndexedName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> indexedName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyTokenizer <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PropertyTokenizer(children);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">                <span class="string">&quot;Remove is not supported, as it has no meaning in the context of properties.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²åˆ°æ„é€ å‡½æ•°ï¼Œç„¶åæä¾›äº†iteratoræ–¹æ³•å¯¹è§£æåçš„å­ä¸²è¿›è¡Œéå†ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„æ–¹æ³•ç±»ã€‚</p><p><strong>å‚è€ƒèµ„æ–™</strong></p><ul><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/index.html">å›¾è¯´è®¾è®¡æ¨¡å¼</a></li><li><a href="http://www.cnblogs.com/dongying/p/4142476.html">æ·±å…¥æµ…å‡ºMybatisç³»åˆ—ï¼ˆåï¼‰â€”SQLæ‰§è¡Œæµç¨‹åˆ†æï¼ˆæºç ç¯‡ï¼‰</a></li><li><a href="http://www.cnblogs.com/chenssy/p/3299719.html">è®¾è®¡æ¨¡å¼è¯»ä¹¦ç¬”è®°â€”â€“ç»„åˆæ¨¡å¼</a></li><li><a href="http://blog.csdn.net/wagcy/article/details/32963235">Mybatis3.3.xæŠ€æœ¯å†…å¹•ï¼ˆå››ï¼‰ï¼šäº”é¼ é—¹ä¸œäº¬ä¹‹æ‰§è¡Œå™¨Executorè®¾è®¡åŸæœ¬</a></li><li><a href="https://my.oschina.net/lixin91/blog/620068">mybatisç¼“å­˜æœºåˆ¶è¯¦è§£ï¼ˆä¸€ï¼‰â€”â€”Cache</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶ </category>
          
          <category> MyBatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring AOPå’ŒSpring Transactionæºç èµ„æ–™æ•´ç†</title>
      <link href="/blog/2020/01/27/9cf21717.html"/>
      <url>/blog/2020/01/27/9cf21717.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h2><p>å‰é¢å­¦ä¹ äº†Spring AOPçš„æºç ï¼Œæ¥ä¸‹æ¥å‡†å¤‡çœ‹AOPç›¸å…³æºç ã€‚Spring AOPåŸºäºSpring IOCæœºåˆ¶ã€‚</p><p>åœ¨å­¦ä¹ å®ŒSpring AOPä¹‹åå¯ä»¥ç»§ç»­çœ‹çœ‹Spring Transactionæºç ã€‚</p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><p>é€šè¿‡è°ƒè¯• <code>org.springframework.aop.aspectj.autoproxy.AspectJAutoProxyCreatorTests</code> è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•ï¼Œæ¥è·Ÿæºç ã€‚</p><h3 id="Spring-Transaction"><a href="#Spring-Transaction" class="headerlink" title="Spring Transaction"></a>Spring Transaction</h3><ul><li><p>è°ƒè¯• <code>&lt;tx:advice /&gt;</code> æ ‡ç­¾çš„è§£æçš„æµç¨‹</p><p>å¯è°ƒè¯• <code>org.springframework.transaction.TxNamespaceHandlerTests</code> è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•ã€‚</p><ul><li><code>#invokeTransactional()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</li><li><code>#rollbackRules()</code> æ–¹æ³•ï¼Œå›æ»šäº‹åŠ¡ã€‚</li></ul></li><li><p>è°ƒè¯• <code>@Transactional</code> æ³¨è§£çš„è§£æçš„æµç¨‹</p><p>ä½¿ç”¨çš„è¿˜æ˜¯ <code>org.springframework.transaction.TxNamespaceHandlerTests</code> è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•</p></li></ul><h2 id="èµ„æ–™æ•´ç†"><a href="#èµ„æ–™æ•´ç†" class="headerlink" title="èµ„æ–™æ•´ç†"></a>èµ„æ–™æ•´ç†</h2><h3 id="Spring-AOP-1"><a href="#Spring-AOP-1" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><ul><li><a href="https://book.douban.com/subject/30452948/">Spring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ)</a> - AOPéƒ¨åˆ†</li><li><a href="https://www.cnblogs.com/xrq730/p/6753160.html">ã€Šã€Springæºç åˆ†æã€‘AOPæºç è§£æï¼ˆä¸Šç¯‡ï¼‰ã€‹</a> ï¼Œå¯¹ Spring AOP XML é…ç½®çš„æ–¹å¼è¿›è¡Œæºç è§£æã€‚</li><li><a href="https://www.cnblogs.com/xrq730/p/6757608.html">ã€Šã€Springæºç åˆ†æã€‘AOPæºç è§£æï¼ˆä¸‹ç¯‡ï¼‰ã€‹</a> ï¼Œå’Œ<a href="https://book.douban.com/subject/30452948/">Spring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ)</a> çš„å†…å®¹ç›¸äº’è¡¥å……</li></ul><h3 id="Spring-Transaction-1"><a href="#Spring-Transaction-1" class="headerlink" title="Spring Transaction"></a>Spring Transaction</h3><ul><li><a href="https://book.douban.com/subject/30452948/">Spring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ)</a> - äº‹åŠ¡ç›¸å…³éƒ¨åˆ†</li><li><a href="http://www.linkedkeeper.com/1045.html">ã€ŠåŸåˆ› Spring æºç è§£æä¹‹äº‹åŠ¡ç¯‡ã€‹</a></li><li><a href="http://www.baowenwei.com/post/spring/spring-shi-wu-de-yuan-ma-fen-xi-qi">ã€ŠSpring-äº‹åŠ¡çš„æºç åˆ†æï¼ˆä¸ƒï¼‰ã€‹</a></li><li><a href="https://juejin.im/post/5b00c52ef265da0b95276091">ã€Šå¯èƒ½æ˜¯æœ€æ¼‚äº®çš„ Spring äº‹åŠ¡ç®¡ç†è¯¦è§£ã€‹</a></li></ul><h2 id="åç½®"><a href="#åç½®" class="headerlink" title="åç½®"></a>åç½®</h2><p><code>Spring MVC</code></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æºç å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ</title>
      <link href="/blog/2020/01/26/101fc769.html"/>
      <url>/blog/2020/01/26/101fc769.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4045">http://cmsblogs.com/?p=4045</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><h2 id="bean-çš„è½¬æ¢è¿‡ç¨‹"><a href="#bean-çš„è½¬æ¢è¿‡ç¨‹" class="headerlink" title="bean çš„è½¬æ¢è¿‡ç¨‹"></a>bean çš„è½¬æ¢è¿‡ç¨‹</h2><p>ä¸‹é¢è¿™å¼ å›¾æ¼”ç¤ºäº†ä¸€ä¸ªå¯ç”¨çš„<code>bean</code>æ˜¯å¦‚ä½•ä»<code>xml</code>é…ç½®æ–‡ä»¶ä¸­æ¼”å˜è¿‡æ¥çš„.</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/spring-201901311001_BJamFt.jpg" alt="img"></p><h2 id="ApplicationContext-çš„æ¶æ„å›¾"><a href="#ApplicationContext-çš„æ¶æ„å›¾" class="headerlink" title="ApplicationContext çš„æ¶æ„å›¾"></a>ApplicationContext çš„æ¶æ„å›¾</h2><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/spring-201901311002-20200528151019732_6Qhaoy.jpg" alt="img"></p><h2 id="loadBean-çš„å…¨æµç¨‹"><a href="#loadBean-çš„å…¨æµç¨‹" class="headerlink" title="loadBean çš„å…¨æµç¨‹"></a>loadBean çš„å…¨æµç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/spring-201901311003-20200528151032304_XtJJ2j.jpg" alt="img"></p><h2 id="getBean-çš„å…¨æµç¨‹"><a href="#getBean-çš„å…¨æµç¨‹" class="headerlink" title="getBean çš„å…¨æµç¨‹"></a>getBean çš„å…¨æµç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/spring-201901311004_y7TnNL.jpg" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥åˆ†æApplicationContextçš„refresh()</title>
      <link href="/blog/2020/01/26/ea3a33da.html"/>
      <url>/blog/2020/01/26/ea3a33da.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4043">http://cmsblogs.com/?p=4043</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>ä¸Šç¯‡åšå®¢å¯¹ ApplicationContext ç›¸å…³çš„æ¥å£åšäº†ä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œä½œä¸ºä¸€ä¸ªé«˜å¯Œå¸…çº§åˆ«çš„ Spring å®¹å™¨ï¼Œå®ƒæ¶‰åŠçš„æ–¹æ³•å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå…¨éƒ¨ä»‹ç»æ˜¯ä¸å¯èƒ½çš„ï¼Œè€Œä¸”å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½å·²ç»åœ¨å‰é¢ç³»åˆ—åšå®¢ä¸­åšäº†è¯¦ç»†çš„ä»‹ç»ï¼Œæ‰€ä»¥è¿™ç¯‡åšé—®ä»‹ç» ApplicationContext æœ€é‡è¦çš„æ–¹æ³•ï¼ˆå°ç¼–è®¤ä¸ºçš„ï¼‰ ï¼š<code>refresh()</code>ã€‚</p><p><code>refresh()</code> æ˜¯å®šä¹‰åœ¨ ConfigurableApplicationContext ç±»ä¸­çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load or refresh the persistent representation of the configuration,</span></span><br><span class="line"><span class="comment"> * which might an XML file, properties file, or relational database schema.</span></span><br><span class="line"><span class="comment"> * As this is a startup method, it should destroy already created singletons</span></span><br><span class="line"><span class="comment"> * if it fails, to avoid dangling resources. In other words, after invocation</span></span><br><span class="line"><span class="comment"> * of that method, either all or no singletons at all should be instantiated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException if the bean factory could not be initialized</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException if already initialized and multiple refresh</span></span><br><span class="line"><span class="comment"> * attempts are not supported</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br></pre></td></tr></table></figure><p>ä½œç”¨å°±æ˜¯ï¼š<strong>åˆ·æ–° Spring çš„åº”ç”¨ä¸Šä¸‹æ–‡</strong>ã€‚å…¶å®ç°æ˜¯åœ¨ AbstractApplicationContext ä¸­å®ç°ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    <span class="comment">// å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">    prepareRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory</span></span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¡«å……BeanFactoryåŠŸèƒ½</span></span><br><span class="line">    prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</span></span><br><span class="line">      postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor</span></span><br><span class="line">      registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</span></span><br><span class="line">      initMessageSource();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨</span></span><br><span class="line">      initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean</span></span><br><span class="line">      onRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åœ¨æ‰€æœ‰beanä¸­æŸ¥æ‰¾listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</span></span><br><span class="line">      registerListeners();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„)</span></span><br><span class="line">      finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨lifecycleProcessoråˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡ºContextRefreshEventé€šçŸ¥åˆ«äºº</span></span><br><span class="line">      finishRefresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  é”€æ¯å·²ç»åˆ›å»ºçš„Bean</span></span><br><span class="line">      destroyBeans();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é‡ç½®å®¹å™¨æ¿€æ´»æ ‡ç­¾</span></span><br><span class="line">      cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">      <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">      resetCommonCaches();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯ä¸€ä¸ªæ–¹æ³•éƒ½éå¸¸é‡è¦ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªåœ°è§£é‡Šè¯´æ˜ã€‚</p><h2 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh()"></a>prepareRefresh()</h2><blockquote><p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¯¹ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡æˆ–è€…ç³»ç»Ÿå±æ€§è¿›è¡Œå‡†å¤‡å’Œæ ¡éªŒ,å¦‚ç¯å¢ƒå˜é‡ä¸­å¿…é¡»è®¾ç½®æŸä¸ªå€¼æ‰èƒ½è¿è¡Œï¼Œå¦åˆ™ä¸èƒ½è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨è¿™é‡ŒåŠ è¿™ä¸ªæ ¡éªŒï¼Œé‡å†™initPropertySourcesæ–¹æ³•å°±å¥½äº†</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å¯åŠ¨æ—¥æœŸ</span></span><br><span class="line">  <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">  <span class="comment">// è®¾ç½® context å½“å‰çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–context environmentï¼ˆä¸Šä¸‹æ–‡ç¯å¢ƒï¼‰ä¸­çš„å ä½ç¬¦å±æ€§æ¥æº</span></span><br><span class="line">  initPropertySources();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯</span></span><br><span class="line">  getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå¦‚ï¼š</p><ol><li>è®¾ç½® context å¯åŠ¨æ—¶é—´</li><li>è®¾ç½® context çš„å½“å‰çŠ¶æ€</li><li>åˆå§‹åŒ– context environment ä¸­å ä½ç¬¦</li><li>å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯</li></ol><h2 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory()"></a>obtainFreshBeanFactory()</h2><blockquote><p>åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ·æ–° BeanFactory</span></span><br><span class="line">  refreshBeanFactory();</span><br><span class="line">  <span class="comment">// è·å– BeanFactory</span></span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ–¹æ³•å°±åœ¨ <code>refreshBeanFactory()</code> ï¼Œè¯¥æ–¹æ³•çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯åˆ›å»º BeanFactory å¹¶å¯¹å…¶å°±è¡Œä¸€ç•ªåˆå§‹åŒ–ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">    destroyBeans();</span><br><span class="line">    closeBeanFactory();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">    beanFactory.setSerializationId(getId());</span><br><span class="line">    customizeBeanFactory(beanFactory);</span><br><span class="line">    loadBeanDefinitions(beanFactory);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">      <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åˆ¤æ–­å½“å‰å®¹å™¨æ˜¯å¦å­˜åœ¨ä¸€ä¸ª BeanFactoryï¼Œå¦‚æœå­˜åœ¨åˆ™å¯¹å…¶è¿›è¡Œé”€æ¯å’Œå…³é—­</li><li>è°ƒç”¨ <code>createBeanFactory()</code> åˆ›å»ºä¸€ä¸ª BeanFactory å®ä¾‹ï¼Œå…¶å®å°±æ˜¯ DefaultListableBeanFactory</li><li>è‡ªå®šä¹‰ BeanFactory</li><li>åŠ è½½ BeanDefinition</li><li>å°†åˆ›å»ºå¥½çš„ bean å·¥å‚çš„å¼•ç”¨äº¤ç»™çš„ context æ¥ç®¡ç†</li></ol><p>ä¸Šé¢ 5 ä¸ªæ­¥éª¤ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯æœ‰å¿…è¦è®²è§£ä¸‹ç¬¬ 4 æ­¥ï¼šåŠ è½½ BeanDefinitionã€‚å¦‚æœå„ä½çœ‹è¿‡ ã€æ­»ç£• Springã€‘ç³»åˆ—çš„è¯ï¼Œåœ¨åˆšåˆšå¼€å§‹åˆ†ææºç çš„æ—¶å€™ï¼Œå°ç¼–å°±æ˜¯ä»¥ <code>loadBeanDefinitions()</code> ä¸ºå…¥å£æ¥åˆ†æçš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;bean.xml&quot;</span>);</span><br><span class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">reader.loadBeanDefinitions(resource);</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡è¿™æ®µä»£ç çš„ <code>loadBeanDefinitions()</code> æ˜¯å®šä¹‰åœ¨ BeanDefinitionReader ä¸­ï¼Œè€Œæ­¤å¤„çš„ <code>loadBeanDefinitions()</code> åˆ™æ˜¯å®šä¹‰åœ¨ AbstractRefreshableApplicationContext ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException, IOException</span></span><br></pre></td></tr></table></figure><p>ç”±å…·ä½“çš„å­ç±»å®ç°ï¼Œæˆ‘ä»¬ä»¥ AbstractXmlApplicationContext ä¸ºä¾‹ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">  XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Configure the bean definition reader with this context&#x27;s</span></span><br><span class="line">  <span class="comment">// resource loading environment.</span></span><br><span class="line">  beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">  beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">  beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></span><br><span class="line">  <span class="comment">// then proceed with actually loading the bean definitions.</span></span><br><span class="line">  initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">  loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å»º XmlBeanDefinitionReader å®ä¾‹å¯¹è±¡ beanDefinitionReaderï¼Œè°ƒç”¨ <code>initBeanDefinitionReader()</code> å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ <code>loadBeanDefinitions()</code> åŠ è½½ BeanDefinitionã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">  Resource[] configResources = getConfigResources();</span><br><span class="line">  <span class="keyword">if</span> (configResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configResources);</span><br><span class="line">  &#125;</span><br><span class="line">  String[] configLocations = getConfigLocations();</span><br><span class="line">  <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configLocations);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®å†…éƒ¨ä¾ç„¶æ˜¯è°ƒç”¨ <code>BeanDefinitionReader#loadBeanDefinitionn()</code> è¿›è¡Œ BeanDefinition çš„åŠ è½½è¿›ç¨‹ã€‚</p><h2 id="prepareBeanFactory-beanFactory"><a href="#prepareBeanFactory-beanFactory" class="headerlink" title="prepareBeanFactory(beanFactory)"></a>prepareBeanFactory(beanFactory)</h2><blockquote><p>å¡«å…… BeanFactory åŠŸèƒ½</p></blockquote><p>ä¸Šé¢è·å–è·å–çš„ BeanFactory é™¤äº†åŠ è½½äº†ä¸€äº› BeanDefinition å°±æ²¡æœ‰å…¶ä»–ä»»ä½•ä¸œè¥¿äº†ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®è¿˜ä¸èƒ½æŠ•å…¥ç”Ÿäº§ï¼Œå› ä¸ºè¿˜å°‘é…ç½®äº†ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚ contextçš„ ClassLoader å’Œ åç½®å¤„ç†å™¨ç­‰ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®beanFactoryçš„classLoader</span></span><br><span class="line">  beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®beanFactoryçš„è¡¨è¾¾å¼è¯­è¨€å¤„ç†å™¨,Spring3å¼€å§‹å¢åŠ äº†å¯¹è¯­è¨€è¡¨è¾¾å¼çš„æ”¯æŒ,é»˜è®¤å¯ä»¥ä½¿ç”¨#&#123;bean.xxx&#125;çš„å½¢å¼æ¥è°ƒç”¨ç›¸å…³å±æ€§å€¼</span></span><br><span class="line">  beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">  <span class="comment">// ä¸ºbeanFactoryå¢åŠ ä¸€ä¸ªé»˜è®¤çš„propertyEditor</span></span><br><span class="line">  beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ ApplicationContextAwareProcessor</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">  <span class="comment">// è®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£</span></span><br><span class="line">  beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å‡ ä¸ªè‡ªåŠ¨è£…é…çš„ç‰¹æ®Šè§„åˆ™</span></span><br><span class="line">  beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">  beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¢åŠ å¯¹AspectJçš„æ”¯æŒ</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">    <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œé»˜è®¤çš„ç³»ç»Ÿç¯å¢ƒbean</span></span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„æºç çŸ¥é“è¿™ä¸ªå°±æ˜¯å¯¹ BeanFactory è®¾ç½®å„ç§å„ç§çš„åŠŸèƒ½ã€‚</p><h2 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory()"></a>postProcessBeanFactory()</h2><blockquote><p>æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ServletContextAwareProcessor(<span class="keyword">this</span>.servletContext, <span class="keyword">this</span>.servletConfig));</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ServletContextAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ServletConfigAware.class);</span><br><span class="line"></span><br><span class="line">  WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, <span class="keyword">this</span>.servletContext);</span><br><span class="line">  WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, <span class="keyword">this</span>.servletContext, <span class="keyword">this</span>.servletConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ·»åŠ  ServletContextAwareProcessor åˆ° BeanFactory å®¹å™¨ä¸­ï¼Œè¯¥ processor å®ç° BeanPostProcessor æ¥å£ï¼Œä¸»è¦ç”¨äºå°†ServletContext ä¼ é€’ç»™å®ç°äº† ServletContextAware æ¥å£çš„ bean</li><li>å¿½ç•¥ ServletContextAwareã€ServletConfigAware</li><li>æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„åŸŸï¼ˆscopeï¼‰åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿ WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚æ¯”å¦‚ â€œrequestâ€ , â€œsessionâ€ , â€œglobalSessionâ€ , â€œapplicationâ€</li><li>æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„ Environment bean åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚å¦‚ï¼šâ€contextParametersâ€, â€œcontextAttributesâ€</li></ol><h2 id="invokeBeanFactoryPostProcessors"><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors()"></a>invokeBeanFactoryPostProcessors()</h2><blockquote><p>æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®šä¹‰ä¸€ä¸ª set ä¿å­˜æ‰€æœ‰çš„ BeanFactoryPostProcessors</span></span><br><span class="line">  Set&lt;String&gt; processedBeans = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰ BeanFactory ä¸º BeanDefinitionRegistry</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">    BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">    <span class="comment">// BeanFactoryPostProcessor é›†åˆ</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// BeanDefinitionRegistryPostProcessor é›†åˆ</span></span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿­ä»£æ³¨å†Œçš„ beanFactoryPostProcessors</span></span><br><span class="line">    <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ BeanDefinitionRegistryPostProcessorï¼Œåˆ™è°ƒç”¨ postProcessBeanDefinitionRegistry è¿›è¡Œæ³¨å†Œï¼Œ</span></span><br><span class="line">      <span class="comment">// åŒæ—¶åŠ å…¥åˆ° registryProcessors é›†åˆä¸­</span></span><br><span class="line">      <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">        BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">          (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">        registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">        registryProcessors.add(registryProcessor);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™å½“åšæ™®é€šçš„ BeanFactoryPostProcessor å¤„ç†</span></span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ° regularPostProcessors é›†åˆä¸­å³å¯ï¼Œä¾¿äºåé¢åšåç»­å¤„ç†</span></span><br><span class="line">        regularPostProcessors.add(postProcessor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºä¿å­˜å½“å‰å¤„ç†çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆå¤„ç†å®ç°äº† PriorityOrdered (æœ‰é™æ’åºæ¥å£)çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">      beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">        processedBeans.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ å…¥registryProcessorsé›†åˆ</span></span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰å®ç°äº† PriorityOrdered çš„ BeanDefinitionRegistryPostProcessors çš„ postProcessBeanDefinitionRegistry()</span></span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºï¼Œä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨</span></span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶æ¬¡ï¼Œè°ƒç”¨æ˜¯å®ç°äº† Orderedï¼ˆæ™®é€šæ’åºæ¥å£ï¼‰çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">    <span class="comment">// é€»è¾‘å’Œ ä¸Šé¢ä¸€æ ·</span></span><br><span class="line">    postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">        processedBeans.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åè°ƒç”¨å…¶ä»–çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">    <span class="keyword">boolean</span> reiterate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">      reiterate = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// è·å– BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ²¡æœ‰åŒ…å«åœ¨ processedBeans ä¸­çš„ï¼ˆå› ä¸ºåŒ…å«äº†çš„éƒ½å·²ç»å¤„ç†äº†ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">          currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">          processedBeans.add(ppName);</span><br><span class="line">          reiterate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸ä¸Šé¢å¤„ç†é€»è¾‘ä¸€è‡´</span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰ BeanDefinitionRegistryPostProcessor (åŒ…æ‹¬æ‰‹åŠ¨æ³¨å†Œå’Œé€šè¿‡é…ç½®æ–‡ä»¶æ³¨å†Œ)</span></span><br><span class="line">    <span class="comment">// å’Œ BeanFactoryPostProcessor(åªæœ‰æ‰‹åŠ¨æ³¨å†Œ)çš„å›è°ƒå‡½æ•°(postProcessBeanFactory())</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯ BeanDefinitionRegistry åªéœ€è¦è°ƒç”¨å…¶å›è°ƒå‡½æ•°ï¼ˆpostProcessBeanFactory()ï¼‰å³å¯</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  String[] postProcessorNames =</span><br><span class="line">    beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡ŒåŒæ ·éœ€è¦åŒºåˆ† PriorityOrdered ã€Ordered å’Œ no Ordered</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="comment">// å·²ç»å¤„ç†è¿‡äº†çš„ï¼Œè·³è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">      <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// PriorityOrdered</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ordered</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no Ordered</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, PriorityOrdered æ¥å£</span></span><br><span class="line">  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">  invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Next, Ordered æ¥å£</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">    orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">  &#125;</span><br><span class="line">  sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">  invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, no ordered</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">    nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">  &#125;</span><br><span class="line">  invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">  <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line">  beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¾ƒé•¿ï¼Œä½†æ˜¯å¤„ç†é€»è¾‘è¾ƒä¸ºå•ä¸€ï¼Œå°±æ˜¯å¯¹æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessors ã€æ‰‹åŠ¨æ³¨å†Œçš„ BeanFactoryPostProcessor ä»¥åŠé€šè¿‡é…ç½®æ–‡ä»¶æ–¹å¼çš„ BeanFactoryPostProcessor æŒ‰ç…§ PriorityOrdered ã€ Orderedã€no ordered ä¸‰ç§æ–¹å¼åˆ†å¼€å¤„ç†ã€è°ƒç”¨ã€‚</p><h2 id="registerBeanPostProcessors"><a href="#registerBeanPostProcessors" class="headerlink" title="registerBeanPostProcessors"></a>registerBeanPostProcessors</h2><blockquote><p>æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor</p></blockquote><p>ä¸ BeanFactoryPostProcessor ä¸€æ ·ï¼Œä¹Ÿæ˜¯å§”æ‰˜ç»™ PostProcessorRegistrationDelegate æ¥å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰€æœ‰çš„ BeanPostProcessors</span></span><br><span class="line">  String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œ BeanPostProcessorChecker</span></span><br><span class="line">  <span class="comment">// ä¸»è¦ç”¨äºè®°å½•ä¸€äº› bean çš„ä¿¡æ¯ï¼Œè¿™äº› bean ä¸ç¬¦åˆæ‰€æœ‰ BeanPostProcessors å¤„ç†çš„èµ„æ ¼æ—¶</span></span><br><span class="line">  <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒºåˆ† PriorityOrderedã€Ordered ã€ no ordered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// MergedBeanDefinition</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      priorityOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">        internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, PriorityOrdered</span></span><br><span class="line">  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Next, Ordered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    orderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// onOrdered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    nonOrderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, all internal BeanPostProcessors.</span></span><br><span class="line">  sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡æ–°æ³¨å†Œç”¨æ¥è‡ªåŠ¨æ¢æµ‹å†…éƒ¨ApplicationListenerçš„post-processorï¼Œè¿™æ ·å¯ä»¥å°†ä»–ä»¬ç§»åˆ°å¤„ç†å™¨é“¾æ¡çš„æœ«å°¾</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource"></a>initMessageSource</h2><blockquote><p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</p></blockquote><p>å…¶å®è¯¥æ–¹æ³•å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ª MessageSource æ¥å£çš„å®ç°ç±»ï¼Œä¸»è¦ç”¨äºå›½é™…åŒ–/i18nã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">  <span class="comment">// åŒ…å« â€œmessageSourceâ€ bean</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰çˆ¶ç±»</span></span><br><span class="line">    <span class="comment">// HierarchicalMessageSource åˆ†çº§å¤„ç†çš„ MessageSource</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">      HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">      <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ³¨å†Œçˆ¶ MessageSourceï¼Œåˆ™è®¾ç½®ä¸ºçˆ¶ç±»ä¸Šä¸‹æ–‡çš„çš„ MessageSource</span></span><br><span class="line">        hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ç©º MessageSource</span></span><br><span class="line">    DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">    dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">    <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">    beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Unable to locate MessageSource with name &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">                   <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster"></a>initApplicationEventMulticaster</h2><blockquote><p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨ applicationEventMulticaster beanï¼Œåˆ™è·å–èµ‹å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">      beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰åˆ™æ–°å»º SimpleApplicationEventMulticasterï¼Œå¹¶å®Œæˆ bean çš„æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">    beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot;</span> +</span><br><span class="line">                   APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">                   <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå½“å‰å®¹å™¨ä¸­å­˜åœ¨ applicationEventMulticaster çš„ beanï¼Œåˆ™å¯¹ applicationEventMulticaster èµ‹å€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ª SimpleApplicationEventMulticaster çš„å¯¹è±¡ï¼ˆé»˜è®¤çš„ï¼‰ï¼Œå¹¶å®Œæˆæ³¨å†Œã€‚</p><h2 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h2><blockquote><p>ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean</p></blockquote><p>é¢„ç•™ç»™ AbstractApplicationContext çš„å­ç±»ç”¨äºåˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šçš„ beanï¼Œè¯¥æ–¹æ³•éœ€è¦åœ¨æ‰€æœ‰å•ä¾‹ bean åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚</p><h2 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners"></a>registerListeners</h2><blockquote><p>åœ¨æ‰€æœ‰ bean ä¸­æŸ¥æ‰¾ listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ³¨å†Œé™æ€ ç›‘å¬å™¨</span></span><br><span class="line">  <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">    getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">    getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡³æ­¤ï¼Œå·²ç»å®Œæˆå°†ç›‘å¬å™¨æ³¨å†Œåˆ°ApplicationEventMulticasterä¸­ï¼Œä¸‹é¢å°†å‘å¸ƒå‰æœŸçš„äº‹ä»¶ç»™ç›‘å¬å™¨ã€‚</span></span><br><span class="line">  Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">  <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">      getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization"></a>finishBeanFactoryInitialization</h2><blockquote><p>åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„)</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–è½¬æ¢å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">      beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">    beanFactory.setConversionService(</span><br><span class="line">      beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰æ²¡æœ‰æ³¨å†Œ bean åç½®å¤„ç†å™¨ï¼ˆä¾‹å¦‚PropertyPlaceholderConfigurerï¼‰ï¼Œåˆ™æ³¨å†Œé»˜è®¤çš„è§£æå™¨</span></span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">    beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">  String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">    getBean(weaverAwareName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ ClassLoader</span></span><br><span class="line">  beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">  beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh"></a>finishRefresh</h2><blockquote><p>å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ lifecycleProcessor åˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡º ContextRefreshEvent é€šçŸ¥åˆ«äºº</p></blockquote><p>ä¸»è¦æ˜¯è°ƒç”¨ <code>LifecycleProcessor#onRefresh()</code> ï¼Œå¹¶ä¸”å‘å¸ƒäº‹ä»¶ï¼ˆContextRefreshedEventï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">  clearResourceCaches();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">  initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">  getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Publish the final event.</span></span><br><span class="line">  publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line">  LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ApplicationContextç›¸å…³æ¥å£æ¶æ„åˆ†æ</title>
      <link href="/blog/2020/01/26/1a84ff95.html"/>
      <url>/blog/2020/01/26/1a84ff95.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4036">http://cmsblogs.com/?p=4036</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>å‰é¢çš„æ–‡ç« éƒ½æ˜¯åŸºäº BeanFactory è¿™ä¸ªå®¹å™¨æ¥è¿›è¡Œåˆ†æçš„ï¼ŒBeanFactory å®¹å™¨æœ‰ç‚¹å„¿ç®€å•ï¼Œå¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒæˆ‘ä»¬é€šå¸¸ä¼šé€‰æ‹© ApplicationContext ï¼Œç›¸å¯¹äºå¤§å¤šæ•°äººè€Œè¨€ï¼Œå®ƒæ‰æ˜¯æ­£è§„å†›ï¼Œç›¸æ¯”äº BeanFactory è¿™ä¸ªæ‚ç‰Œå†›è€Œè¨€ï¼Œå®ƒç”±å¦‚ä¸‹å‡ ä¸ªåŒºåˆ«ï¼š</p><ol><li>ç»§æ‰¿ MessageSourceï¼Œæä¾›å›½é™…åŒ–çš„æ ‡å‡†è®¿é—®ç­–ç•¥ã€‚</li><li>ç»§æ‰¿ ApplicationEventPublisher ï¼Œæä¾›å¼ºå¤§çš„äº‹ä»¶æœºåˆ¶ã€‚</li><li>æ‰©å±• ResourceLoaderï¼Œå¯ä»¥ç”¨æ¥åŠ è½½å¤šä¸ª Resourceï¼Œå¯ä»¥çµæ´»è®¿é—®ä¸åŒçš„èµ„æºã€‚</li><li>å¯¹ Web åº”ç”¨çš„æ”¯æŒã€‚</li></ol><h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>ä¸‹å›¾æ˜¯ ApplicationContext ç»“æ„ç±»å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15409479819725_t0jF0z_flFIsn.jpg" alt="img"></p><ul><li><p><strong>BeanFactory</strong>ï¼šSpring ç®¡ç† Bean çš„é¡¶å±‚æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºä»–æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ Spring å®¹å™¨ã€‚</p><p>ApplicationContext ç»§æ‰¿ BeanFactory çš„ä¸¤ä¸ªå­ç±»ï¼šHierarchicalBeanFactory å’Œ ListableBeanFactoryã€‚HierarchicalBeanFactory æ˜¯ä¸€ä¸ªå…·æœ‰å±‚çº§å…³ç³»çš„ BeanFactoryï¼Œæ‹¥æœ‰å±æ€§ parentBeanFactoryã€‚ListableBeanFactory å®ç°äº†æšä¸¾æ–¹æ³•å¯ä»¥åˆ—ä¸¾å‡ºå½“å‰ BeanFactory ä¸­æ‰€æœ‰çš„ bean å¯¹è±¡è€Œä¸å¿…æ ¹æ® name ä¸€ä¸ªä¸€ä¸ªçš„è·å–ã€‚</p></li><li><p><strong>ApplicationEventPublisher</strong>ï¼šç”¨äºå°è£…äº‹ä»¶å‘å¸ƒåŠŸèƒ½çš„æ¥å£ï¼Œå‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆListenerï¼‰å‘é€äº‹ä»¶æ¶ˆæ¯ã€‚</p></li><li><p><strong>ResourceLoader</strong>ï¼šSpring åŠ è½½èµ„æºçš„é¡¶å±‚æ¥å£ï¼Œç”¨äºä»ä¸€ä¸ªæºåŠ è½½èµ„æºæ–‡ä»¶ã€‚</p><p>ApplicationContext ç»§æ‰¿ ResourceLoader çš„å­ç±» ResourcePatternResolverï¼Œè¯¥æ¥å£æ˜¯å°† location è§£æä¸º Resource å¯¹è±¡çš„ç­–ç•¥æ¥å£ã€‚</p></li><li><p><strong>MessageSource</strong>ï¼šè§£æ message çš„ç­–ç•¥æ¥å£ï¼Œç”¨ä¸æ”¯æ’‘å›½é™…åŒ–ç­‰åŠŸèƒ½ã€‚</p></li><li><p><strong>EnvironmentCapable</strong>ï¼šç”¨äºè·å– Environment çš„æ¥å£ã€‚</p></li></ul><h2 id="ApplicationContext-çš„å­æ¥å£"><a href="#ApplicationContext-çš„å­æ¥å£" class="headerlink" title="ApplicationContext çš„å­æ¥å£"></a>ApplicationContext çš„å­æ¥å£</h2><p>ApplicationContext æœ‰ä¸¤ä¸ªç›´æ¥å­ç±»ï¼šWebApplicationContext å’Œ ConfigurableApplicationContextã€‚</p><h3 id="WebApplicationContext"><a href="#WebApplicationContext" class="headerlink" title="WebApplicationContext"></a><strong>WebApplicationContext</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span> </span>&#123;</span><br><span class="line">    <span class="function">ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ¥å£åªæœ‰ä¸€ä¸ª <code>getServletContext()</code> ï¼Œç”¨äºç»™ servlet æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><h3 id="ConfigurableApplicationContext"><a href="#ConfigurableApplicationContext" class="headerlink" title="ConfigurableApplicationContext"></a><strong>ConfigurableApplicationContext</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span>, <span class="title">Lifecycle</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line"> <span class="comment">// ä¸º ApplicationContext è®¾ç½®å”¯ä¸€ ID</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ä¸º ApplicationContext è®¾ç½® parent</span></span><br><span class="line"> <span class="comment">// çˆ¶ç±»ä¸åº”è¯¥è¢«ä¿®æ”¹ï¼šå¦‚æœåˆ›å»ºçš„å¯¹è±¡ä¸å¯ç”¨æ—¶ï¼Œåˆ™åº”è¯¥åœ¨æ„é€ å‡½æ•°å¤–éƒ¨è®¾ç½®å®ƒ</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext parent)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è®¾ç½® Environment</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(ConfigurableEnvironment environment)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è·å– Environment</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function">ConfigurableEnvironment <span class="title">getEnvironment</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ·»åŠ  BeanFactoryPostProcessor</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor postProcessor)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ·»åŠ  ApplicationListener</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ·»åŠ  ProtocolResolver</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">addProtocolResolver</span><span class="params">(ProtocolResolver resolver)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// åŠ è½½æˆ–è€…åˆ·æ–°é…ç½®</span></span><br><span class="line"> <span class="comment">// è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ³¨å†Œ shutdown hook</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å…³é—­ ApplicationContext</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ApplicationContext æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è·å–å½“å‰ä¸Šä¸‹æ–‡çš„ BeanFactory</span></span><br><span class="line"> <span class="function">ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ° ConfigurableApplicationContext æ¥å£æä¾›çš„æ–¹æ³•éƒ½æ˜¯å¯¹ ApplicationContext è¿›è¡Œé…ç½®çš„ï¼Œä¾‹å¦‚ <code>setEnvironment()</code>ã€<code>addBeanFactoryPostProcessor</code>ï¼ŒåŒæ—¶å®ƒè¿˜ç»§æ‰¿äº†å¦‚ä¸‹ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li>Lifecycleï¼šå¯¹ context ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œå®ƒæä¾› <code>start()</code> å’Œ <code>stop()</code> æ–¹æ³•å¯åŠ¨å’Œæš‚åœç»„ä»¶ã€‚</li><li>Closeableï¼šæ ‡å‡† JDK æ‰€æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºæœ€åå…³é—­ç»„ä»¶é‡Šæ”¾èµ„æºç­‰ã€‚</li></ul><p><code>WebApplicationContext</code> æ¥å£å’Œ <code>ConfigurableApplicationContext</code> æ¥å£æœ‰ä¸€ä¸ªå…±åŒçš„å­ç±»æ¥å£ <code>ConfigurableWebApplicationContext</code>ï¼Œè¯¥æ¥å£å°†è¿™ä¸¤ä¸ªæ¥å£è¿›è¡Œåˆå¹¶ï¼Œæä¾›äº†ä¸€ä¸ªå¯é…ç½®ã€å¯ç®¡ç†ã€å¯å…³é—­çš„WebApplicationContextï¼ŒåŒæ—¶è¯¥æ¥å£è¿˜å¢åŠ äº† <code>setServletContext()</code>ï¼Œ<code>setServletConfig()</code>ç­‰æ–¹æ³•ï¼Œç”¨äºè£…é…WebApplicationContextã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">WebApplicationContext</span>, <span class="title">ConfigurableApplicationContext</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setServletContext</span><span class="params">(<span class="meta">@Nullable</span> ServletContext servletContext)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setServletConfig</span><span class="params">(<span class="meta">@Nullable</span> ServletConfig servletConfig)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function">ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setNamespace</span><span class="params">(<span class="meta">@Nullable</span> String namespace)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function">String <span class="title">getNamespace</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setConfigLocation</span><span class="params">(String configLocation)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setConfigLocations</span><span class="params">(String... configLocations)</span></span>;</span><br><span class="line"></span><br><span class="line"> String[] getConfigLocations();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸‰ä¸ªæ¥å£å°±å¯ä»¥æ„æˆä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ Spring å®¹å™¨ï¼Œæ•´ä¸ª Spring å®¹å™¨ä½“ç³»æ¶‰åŠçš„æ¥å£è¾ƒå¤šï¼Œæ‰€ä»¥ä¸‹é¢å°ç¼–å°±ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»æ¥çœ‹çœ‹ ApplicationContext çš„å®ç°ï¼ˆå…¶å®åœ¨å‰é¢ä¸€ç³»åˆ—çš„æ–‡ç« ä¸­ï¼Œå°ç¼–å¯¹æ¶‰åŠçš„å¤§éƒ¨åˆ†æ¥å£éƒ½å·²ç»åˆ†æäº†å…¶åŸç†ï¼‰ï¼Œå½“ç„¶ä¸å¯èƒ½æ¯ä¸ªæ–¹æ³•éƒ½æ¶‰åŠåˆ°ï¼Œä½†å°ç¼–ä¼šæŠŠå…¶ä¸­æœ€ä¸ºé‡è¦çš„å®ç°æ–¹æ³•è´´å‡ºæ¥åˆ†æã€‚</p><blockquote><p>ApplicationContext çš„å®ç°ç±»è¾ƒå¤šï¼Œå°±ä»¥ ClassPathXmlApplicationContext æ¥åˆ†æ ApplicationContextã€‚</p></blockquote><h2 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h2><p><code>ClassPathXmlApplicationContext</code> æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹  Spring è¿‡ç¨‹ä¸­ç”¨çš„éå¸¸å¤šçš„ä¸€ä¸ªç±»ï¼Œå¾ˆå¤šäººç¬¬ä¸€ä¸ªæ¥è§¦çš„ Spring å®¹å™¨å°±æ˜¯å®ƒï¼ŒåŒ…æ‹¬å°ç¼–è‡ªå·±ï¼Œä¸‹é¢ä»£ç æˆ‘æƒ³å¾ˆå¤šäººä¾ç„¶è¿˜è®°å¾—å§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">StudentService studentService = (StudentService)ac.getBean(<span class="string">&quot;studentService&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾æ˜¯ ClassPathXmlApplicationContext çš„ç»“æ„ç±»å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15410421887266-20200528144153812_tzVVcv.jpg" alt="img"></p><p>ä¸»è¦çš„çš„ç±»å±‚çº§å…³ç³»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.context.support.AbstractApplicationContext</span><br><span class="line">      org.springframework.context.support.AbstractRefreshableApplicationContext</span><br><span class="line">            org.springframework.context.support.AbstractRefreshableConfigApplicationContext</span><br><span class="line">                  org.springframework.context.support.AbstractXmlApplicationContext</span><br><span class="line">                        org.springframework.context.support.ClassPathXmlApplicationContext</span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å…¸å‹çš„åº”ç”¨ï¼ŒAbstractApplicationContext å®ç°äº† ConfigurableApplicationContext è¿™ä¸ªå…¨å®¶æ¡¶æ¥å£ï¼Œå…¶å­ç±» AbstractRefreshableConfigApplicationContext åˆå®ç°äº† BeanNameAware å’Œ InitializingBean æ¥å£ã€‚æ‰€ä»¥ ClassPathXmlApplicationContext è®¾è®¡çš„é¡¶çº§æ¥å£æœ‰ï¼š</p><ul><li><code>BeanFactory</code>ï¼šSpring å®¹å™¨ Bean çš„ç®¡ç†</li><li><code>MessageSource</code>ï¼šç®¡ç† message ï¼Œå®ç°å›½é™…åŒ–ç­‰åŠŸèƒ½</li><li><code>ApplicationEventPublisher</code>ï¼šäº‹ä»¶å‘å¸ƒ</li><li><code>ResourcePatternResolver</code>ï¼šèµ„æºåŠ è½½</li><li><code>EnvironmentCapable</code>ï¼šç³»ç»Ÿ Environmentï¼ˆprofile + Propertiesï¼‰ ç›¸å…³</li><li><code>Lifecycle</code>ï¼šç®¡ç†ç”Ÿå‘½å‘¨æœŸ</li><li><code>Closeable</code>ï¼šå…³é—­ï¼Œé‡Šæ”¾èµ„æº</li><li><code>InitializingBean</code>ï¼šè‡ªå®šä¹‰åˆå§‹åŒ–</li><li><code>BeanNameAware</code>ï¼šè®¾ç½® beanName çš„ Aware æ¥å£</li></ul><p>ä¸‹é¢å°±è¿™äº›æ¥å£æ¥ä¸€ä¸€åˆ†æã€‚</p><h3 id="MessageSource"><a href="#MessageSource" class="headerlink" title="MessageSource"></a>MessageSource</h3><p>MessageSource å®šä¹‰äº†è·å– message çš„ç­–ç•¥æ–¹æ³• <code>getMessage()</code>ï¼Œåœ¨ ApplicationContext ä½“ç³»ä¸­ï¼Œè¯¥æ–¹æ³• AbstractApplicationContext å®ç°ï¼Œåœ¨ AbstractApplicationContext ä¸­ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª MessageSource å®ä¾‹ï¼Œå°† <code>getMessage()</code> çš„å®ç°ç»™è¯¥å®ä¾‹æ¥å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> MessageSource messageSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° getMessage()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, <span class="meta">@Nullable</span> Object[] args, <span class="meta">@Nullable</span> String defaultMessage, Locale locale)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// å§”æ‰˜ç»™ messageSource å®ç°</span></span><br><span class="line"> <span class="keyword">return</span> getMessageSource().getMessage(code, args, defaultMessage, locale);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MessageSource <span class="title">getMessageSource</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.messageSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;MessageSource not initialized - &quot;</span> +</span><br><span class="line">    <span class="string">&quot;call &#x27;refresh&#x27; before accessing messages via the context: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">this</span>.messageSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£å®ç° æ˜¯åœ¨ <code>AbstractMessageSource</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getMessage</span><span class="params">(String code, <span class="meta">@Nullable</span> Object[] args, <span class="meta">@Nullable</span> String defaultMessage, Locale locale)</span> </span>&#123;</span><br><span class="line"> String msg = getMessageInternal(code, args, locale);</span><br><span class="line"> <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> msg;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (defaultMessage == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> getDefaultMessage(code);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> renderDefaultMessage(defaultMessage, args, locale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„å®ç°è¿™é‡Œå°±ä¸åˆ†æäº†ã€‚</p><h3 id="ApplicationEventPublisher"><a href="#ApplicationEventPublisher" class="headerlink" title="ApplicationEventPublisher"></a>ApplicationEventPublisher</h3><p>ç”¨äºå°è£…äº‹ä»¶å‘å¸ƒåŠŸèƒ½çš„æ¥å£ï¼Œå‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆListenerï¼‰å‘é€äº‹ä»¶æ¶ˆæ¯ã€‚</p><p>è¯¥æ¥å£æä¾›äº†ä¸€ä¸ª <code>publishEvent()</code> ç”¨äºé€šçŸ¥åœ¨æ­¤åº”ç”¨ç¨‹åºä¸­æ³¨å†Œçš„æ‰€æœ‰çš„ç›‘å¬å™¨ã€‚</p><p>è¯¥æ–¹æ³•åœ¨ AbstractApplicationContext ä¸­å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">  publishEvent(event, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Publishing event in &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + event);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ApplicationEvent applicationEvent;</span><br><span class="line">  <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) &#123;</span><br><span class="line">    applicationEvent = (ApplicationEvent) event;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    applicationEvent = <span class="keyword">new</span> PayloadApplicationEvent&lt;&gt;(<span class="keyword">this</span>, event);</span><br><span class="line">    <span class="keyword">if</span> (eventType == <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventType = ((PayloadApplicationEvent) applicationEvent).getResolvableType();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">      ((AbstractApplicationContext) <span class="keyword">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.parent.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæŒ‡å®šçš„äº‹ä»¶ä¸æ˜¯ApplicationEventï¼Œåˆ™å®ƒå°†åŒ…è£…åœ¨PayloadApplicationEventä¸­ã€‚å¦‚æœå­˜åœ¨çˆ¶çº§ ApplicationContext ï¼Œåˆ™åŒæ ·è¦å°† event å‘å¸ƒç»™çˆ¶çº§ ApplicationContextã€‚</p><h3 id="ResourcePatternResolver"><a href="#ResourcePatternResolver" class="headerlink" title="ResourcePatternResolver"></a>ResourcePatternResolver</h3><p>ResourcePatternResolver æ¥å£ç»§æ‰¿ ResourceLoader æ¥å£ï¼Œä¸ºå°† location è§£æä¸º Resource å¯¹è±¡çš„ç­–ç•¥æ¥å£ã€‚ä»–æä¾›çš„ <code>getResources()</code> åœ¨ AbstractApplicationContext ä¸­å®ç°ï¼Œåœ¨ AbstractApplicationContext ä¸­ä»–æŒæœ‰ä¸€ä¸ª ResourcePatternResolver çš„å®ä¾‹å¯¹è±¡ã€‚</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">this</span>.resourcePatternResolver.getResources(locationPattern);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå°ä¼™ä¼´å¯¹ Spring çš„ ResourceLoader æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œä½ ä¼šå‘ç°æœ€ç»ˆæ˜¯åœ¨ PathMatchingResourcePatternResolver ä¸­å®ç°ï¼Œè¯¥ç±»æ˜¯ ResourcePatternResolver æ¥å£çš„å®ç°è€…ã€‚</p><h3 id="EnvironmentCapable"><a href="#EnvironmentCapable" class="headerlink" title="EnvironmentCapable"></a>EnvironmentCapable</h3><p>æä¾›å½“å‰ç³»ç»Ÿç¯å¢ƒ Environment ç»„ä»¶ã€‚æä¾›äº†ä¸€ä¸ª <code>getEnvironment()</code> ç”¨äºè¿”å› Environment å®ä¾‹å¯¹è±¡ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractApplicationContext å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableEnvironment <span class="title">getEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.environment = createEnvironment();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">this</span>.environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæŒæœ‰çš„ environment å®ä¾‹å¯¹è±¡ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>createEnvironment()</code> åˆ›å»ºä¸€ä¸ªã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableEnvironment <span class="title">createEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StandardEnvironment æ˜¯ä¸€ä¸ªé€‚ç”¨äºé WEB åº”ç”¨çš„ Environmentã€‚</p><h3 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h3><p>ä¸€ä¸ªç”¨äºç®¡ç†å£°æ˜å‘¨æœŸçš„æ¥å£ã€‚</p><p>åœ¨ AbstractApplicationContext ä¸­å­˜åœ¨ä¸€ä¸ª LifecycleProcessor ç±»å‹çš„å®ä¾‹å¯¹è±¡ lifecycleProcessorï¼ŒAbstractApplicationContext ä¸­å…³äº Lifecycle æ¥å£çš„å®ç°éƒ½æ˜¯å§”æ‰˜ç»™ lifecycleProcessor å®ç°çš„ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  getLifecycleProcessor().start();</span><br><span class="line">  publishEvent(<span class="keyword">new</span> ContextStartedEvent(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  getLifecycleProcessor().stop();</span><br><span class="line">  publishEvent(<span class="keyword">new</span> ContextStoppedEvent(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.lifecycleProcessor.isRunning());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨ã€åœæ­¢çš„æ—¶å€™ä¼šåˆ†åˆ«å‘å¸ƒ ContextStartedEvent å’Œ ContextStoppedEvent äº‹ä»¶ã€‚</p><h3 id="Closeable"><a href="#Closeable" class="headerlink" title="Closeable"></a>Closeable</h3><p>Closeable æ¥å£ç”¨äºå…³é—­å’Œé‡Šæ”¾èµ„æºï¼Œæä¾›äº† <code>close()</code> ä»¥é‡Šæ”¾å¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºã€‚åœ¨ ApplicationContext ä½“ç³»ä¸­ç”±AbstractApplicationContext å®ç°ï¼Œç”¨äºå…³é—­ ApplicationContext é”€æ¯æ‰€æœ‰ bean ï¼Œæ­¤å¤–å¦‚æœæ³¨å†Œæœ‰ JVM shutdown hookï¼ŒåŒæ ·è¦å°†å…¶ç§»é™¤ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    doClose();</span><br><span class="line">    <span class="comment">// If we registered a JVM shutdown hook, we don&#x27;t need it anymore now:</span></span><br><span class="line">    <span class="comment">// We&#x27;ve already explicitly closed the context.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.shutdownHook != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Runtime.getRuntime().removeShutdownHook(<span class="keyword">this</span>.shutdownHook);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">        <span class="comment">// ignore - VM is already shutting down</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>doClose()</code> å‘å¸ƒ ContextClosedEvent äº‹ä»¶ï¼Œé”€æ¯æ‰€æœ‰ beanï¼ˆå•ä¾‹ï¼‰ï¼Œå…³é—­ BeanFactory ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Publish shutdown event.</span></span><br><span class="line">    publishEvent(<span class="keyword">new</span> ContextClosedEvent(<span class="keyword">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    logger.warn(<span class="string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">  destroyBeans();</span><br><span class="line">  closeBeanFactory();</span><br><span class="line">  onClose();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="InitializingBean"><a href="#InitializingBean" class="headerlink" title="InitializingBean"></a>InitializingBean</h3><p>InitializingBean ä¸º bean æä¾›äº†åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒæä¾›çš„ <code>afterPropertiesSet()</code> ç”¨äºæ‰§è¡Œåˆå§‹åŒ–åŠ¨ä½œã€‚åœ¨ ApplicationContext ä½“ç³»ä¸­ï¼Œè¯¥æ–¹æ³•ç”± AbstractRefreshableConfigApplicationContext å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">    refresh();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>refresh()</code> ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractApplicationContext ä¸­æ‰§è¡Œï¼Œæ‰§è¡Œæ•´ä¸ª Spring å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¯¥æ–¹æ³•å°†åœ¨ä¸‹ç¯‡æ–‡ç« è¿›è¡Œè¯¦ç»†åˆ†æè¯´æ˜ã€‚</p><h3 id="BeanNameAware"><a href="#BeanNameAware" class="headerlink" title="BeanNameAware"></a>BeanNameAware</h3><p>è®¾ç½® bean name çš„æ¥å£ã€‚æ¥å£åœ¨ AbstractRefreshableConfigApplicationContext ä¸­å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.setIdCalled) &#123;</span><br><span class="line">    <span class="keyword">super</span>.setId(name);</span><br><span class="line">    setDisplayName(<span class="string">&quot;ApplicationContext &#x27;&quot;</span> + name + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>ç”±äºç¯‡å¹…é—®é¢˜å†åŠ ä¸Šå¤§éƒ¨åˆ†æ¥å£éƒ½å·²ç»åœ¨å‰é¢æ–‡ç« è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦æ˜¯ä»¥ Spring Framework çš„ ApplicationContext ä¸ºä¸­å¿ƒï¼Œå¯¹å…¶ç»“æ„å’ŒåŠŸèƒ½çš„å®ç°è¿›è¡Œäº†ç®€è¦çš„è¯´æ˜ã€‚</p><p><strong>è¿™é‡Œä¸å¾—ä¸è¯´ Spring çœŸçš„æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„æ¡†æ¶ï¼Œå…·æœ‰è‰¯å¥½çš„ç»“æ„è®¾è®¡å’Œæ¥å£æŠ½è±¡ï¼Œå®ƒçš„æ¯ä¸€ä¸ªæ¥å£èŒèƒ½å•ä¸€ï¼Œä¸”éƒ½æ˜¯å…·ä½“åŠŸèƒ½åˆ°å„ä¸ªæ¨¡å—çš„é«˜åº¦æŠ½è±¡ï¼Œä¸”å‡ ä¹æ¯å¥—æ¥å£éƒ½æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å®ç°ï¼ˆdefaultXXXï¼‰ã€‚</strong></p><p>å¯¹äº ApplicationContext ä½“ç³»è€Œè¨€ï¼Œä»–ç»§æ‰¿ Spring ä¸­ä¼—å¤šçš„æ ¸å¿ƒæ¥å£ï¼Œèƒ½å¤Ÿä¸ºå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„ Spring å®¹å™¨ï¼Œæ¥å£ ConfigurableApplicationContext å¯¹ ApplicationContext æ¥å£å†æ¬¡è¿›è¡Œæ‰©å±•ï¼Œæä¾›äº†ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†åŠŸèƒ½ã€‚</p><p>æŠ½è±¡ç±» ApplicationContext å¯¹æ•´å¥—æ¥å£æä¾›äº†å¤§éƒ¨åˆ†çš„é»˜è®¤å®ç°ï¼Œå°†å…¶ä¸­â€œä¸æ˜“å˜åŠ¨â€çš„éƒ¨åˆ†è¿›è¡Œäº†å°è£…ï¼Œé€šè¿‡â€œç»„åˆâ€çš„æ–¹å¼å°†â€œå®¹æ˜“å˜åŠ¨â€çš„åŠŸèƒ½å§”æ‰˜ç»™å…¶ä»–ç±»æ¥å®ç°ï¼ŒåŒæ—¶åˆ©ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°†ä¸€äº›æ–¹æ³•çš„å®ç°å¼€æ”¾å‡ºå»ç”±å­ç±»å®ç°ï¼Œä»è€Œå®ç°â€œ**<u>å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­</u>**â€çš„è®¾è®¡åŸåˆ™ã€‚</p><p>æœ€åæˆ‘ä»¬å†æ¥é¢†ç•¥ä¸‹å›¾çš„é£é‡‡ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15410421887266-20200528145142270_hlq2Td.jpg" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹åˆ†æbeançš„ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="/blog/2020/01/26/90c034e1.html"/>
      <url>/blog/2020/01/26/90c034e1.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4034">http://cmsblogs.com/?p=4034</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨åˆ†æ Spring Bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­æåˆ° Spring å¹¶ä¸æ˜¯ä¸€å¯åŠ¨å®¹å™¨å°±å¼€å¯ bean çš„å®ä¾‹åŒ–è¿›ç¨‹ï¼Œåªæœ‰å½“å®¢æˆ·ç«¯é€šè¿‡æ˜¾ç¤ºæˆ–è€…éšå¼çš„æ–¹å¼è°ƒç”¨ BeanFactory çš„ <code>getBean()</code> æ–¹æ³•æ¥è¯·æ±‚æŸä¸ªå®ä¾‹å¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šè§¦å‘ç›¸åº” bean çš„å®ä¾‹åŒ–è¿›ç¨‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥ä½¿ç”¨ ApplicationContext å®¹å™¨ï¼Œå› ä¸ºè¯¥å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šç«‹åˆ»è°ƒç”¨æ³¨å†Œåˆ°è¯¥å®¹å™¨æ‰€æœ‰ bean å®šä¹‰çš„å®ä¾‹åŒ–æ–¹æ³•ã€‚å½“ç„¶å¯¹äº BeanFactory å®¹å™¨è€Œè¨€å¹¶ä¸æ˜¯æ‰€æœ‰çš„ <code>getBean()</code> æ–¹æ³•éƒ½ä¼šè§¦å‘å®ä¾‹åŒ–è¿›ç¨‹ï¼Œæ¯”å¦‚ signleton ç±»å‹çš„ beanï¼Œè¯¥ç±»å‹çš„ bean åªä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>getBean()</code> çš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œè€Œåç»­çš„è°ƒç”¨åˆ™ä¼šç›´æ¥è¿”å›å®¹å™¨ç¼“å­˜ä¸­çš„å®ä¾‹å¯¹è±¡ã€‚</p><p><code>getBean()</code> åªæ˜¯ bean å®ä¾‹åŒ–è¿›ç¨‹çš„å…¥å£ï¼ŒçœŸæ­£çš„å®ç°é€»è¾‘å…¶å®æ˜¯åœ¨ AbstractAutowireCapableBeanFactory çš„ <code>doCreateBean()</code> å®ç°ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15359386381747_wNxvJ5_Lyaby1.jpg" alt="img"></p><p>åŸæ¥æˆ‘ä»¬é‡‡ç”¨ new çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç”¨å®Œè¯¥å¯¹è±¡åœ¨å…¶è„±ç¦»ä½œç”¨åŸŸåå°±ä¼šè¢«å›æ”¶ï¼Œå¯¹äºåç»­æ“ä½œæˆ‘ä»¬æ— æƒä¹Ÿæ²¡æ³•å¹²æ¶‰ï¼Œä½†æ˜¯é‡‡ç”¨ Spring å®¹å™¨åï¼Œæˆ‘ä»¬å®Œå…¨æ‘†è„±äº†è¿™ç§å‘½è¿ï¼ŒSpring å®¹å™¨å°†ä¼šå¯¹å…¶æ‰€æœ‰ç®¡ç†çš„ Bean å¯¹è±¡å…¨éƒ¨ç»™äºˆä¸€ä¸ªç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œå¹²æ¶‰ï¼ˆæ¯”å¦‚å¯¹ bean è¿›è¡Œå¢å¼ºå¤„ç†ï¼Œå¯¹ bean è¿›è¡Œç¯¡æ”¹ï¼‰ï¼Œå¦‚ä¸Šå›¾ã€‚</p><h2 id="bean-å®ä¾‹åŒ–"><a href="#bean-å®ä¾‹åŒ–" class="headerlink" title="bean å®ä¾‹åŒ–"></a>bean å®ä¾‹åŒ–</h2><p>åœ¨ <code>doCreateBean()</code> ä¸­é¦–å…ˆè¿›è¡Œ bean å®ä¾‹åŒ–å·¥ä½œï¼Œä¸»è¦ç”± <code>createBeanInstance()</code> å®ç°ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª BeanWrapper å¯¹è±¡ã€‚BeanWrapper å¯¹è±¡æ˜¯ Spring çš„ä¸€ä¸ªä½çº§ Bean åŸºç¡€ç»“æ„çš„æ ¸å¿ƒæ¥å£ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯ä½çº§å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªæ—¶å€™çš„ Bean è¿˜ä¸èƒ½å¤Ÿè¢«æˆ‘ä»¬ä½¿ç”¨ï¼Œè¿æœ€åŸºæœ¬çš„å±æ€§éƒ½æ²¡æœ‰è®¾ç½®ã€‚è€Œä¸”åœ¨æˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¸€èˆ¬éƒ½ä¸ä¼šç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œè€Œæ˜¯é€šè¿‡ BeanFactory éšå¼ä½¿ç”¨ã€‚</p><p>BeanWrapper æ¥å£æœ‰ä¸€ä¸ªé»˜è®¤å®ç°ç±» BeanWrapperImplï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¯¹ Bean è¿›è¡Œâ€œåŒ…è£¹â€ï¼Œç„¶åå¯¹è¿™ä¸ªåŒ…è£¹çš„ bean è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚åç»­æ³¨å…¥ bean å±æ€§ã€‚</p><p>åœ¨å®ä¾‹åŒ– bean è¿‡ç¨‹ä¸­ï¼ŒSpring é‡‡ç”¨â€œç­–ç•¥æ¨¡å¼â€æ¥å†³å®šé‡‡ç”¨å“ªç§æ–¹å¼æ¥å®ä¾‹åŒ– beanï¼Œä¸€èˆ¬æœ‰åå°„å’Œ CGLIB åŠ¨æ€å­—èŠ‚ç ä¸¤ç§æ–¹å¼ã€‚</p><p>InstantiationStrategy å®šä¹‰äº† Bean å®ä¾‹åŒ–ç­–ç•¥çš„æŠ½è±¡æ¥å£ï¼Œå…¶å­ç±» SimpleInstantiationStrategy æä¾›äº†åŸºäºåå°„æ¥å®ä¾‹åŒ–å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸æ”¯æŒæ–¹æ³•æ³¨å…¥æ–¹å¼çš„å¯¹è±¡å®ä¾‹åŒ–ã€‚</p><p>CglibSubclassingInstantiationStrategy ç»§æ‰¿ SimpleInstantiationStrategyï¼Œä»–é™¤äº†æ‹¥æœ‰çˆ¶ç±»ä»¥åå°„å®ä¾‹åŒ–å¯¹è±¡çš„åŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†é€šè¿‡ CGLIB çš„åŠ¨æ€å­—èŠ‚ç çš„åŠŸèƒ½è¿›è€Œæ”¯æŒæ–¹æ³•æ³¨å…¥æ‰€éœ€çš„å¯¹è±¡å®ä¾‹åŒ–éœ€æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring é‡‡ç”¨ CglibSubclassingInstantiationStrategyã€‚</p><h2 id="æ¿€æ´»-Aware"><a href="#æ¿€æ´»-Aware" class="headerlink" title="æ¿€æ´» Aware"></a>æ¿€æ´» Aware</h2><p>å½“ Spring å®Œæˆ bean å¯¹è±¡å®ä¾‹åŒ–å¹¶ä¸”è®¾ç½®å®Œç›¸å…³å±æ€§å’Œä¾èµ–åï¼Œåˆ™ä¼šå¼€å§‹ bean çš„åˆå§‹åŒ–è¿›ç¨‹ï¼ˆ<code>initializeBean()</code>ï¼‰ï¼Œåˆå§‹åŒ–ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯æ£€æŸ¥å½“å‰ bean å¯¹è±¡æ˜¯å¦å®ç°äº†ä¸€ç³»åˆ—ä»¥ Aware ç»“å°¾çš„çš„æ¥å£ã€‚</p><p>Aware æ¥å£ä¸º Spring å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œæ˜¯ä¸€ä¸ªå…·æœ‰æ ‡è¯†ä½œç”¨çš„è¶…çº§æ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ bean æ˜¯å…·æœ‰è¢« Spring å®¹å™¨é€šçŸ¥çš„èƒ½åŠ›ï¼Œé€šçŸ¥çš„æ–¹å¼æ˜¯é‡‡ç”¨å›è°ƒçš„æ–¹å¼ã€‚</p><p>åœ¨åˆå§‹åŒ–é˜¶æ®µä¸»è¦æ˜¯æ„ŸçŸ¥ BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAware ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">      ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">      ClassLoader bcl = getBeanClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (bcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">      ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>BeanNameAware</code>ï¼šå¯¹è¯¥ bean å¯¹è±¡å®šä¹‰çš„ beanName è®¾ç½®åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­</li><li><code>BeanClassLoaderAware</code>ï¼šå°†å½“å‰ bean å¯¹è±¡ç›¸åº”çš„ ClassLoader æ³¨å…¥åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­</li><li><code>BeanFactoryAware</code>ï¼šBeanFactory å®¹å™¨ä¼šå°†è‡ªèº«æ³¨å…¥åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­ï¼Œè¿™æ ·å½“å‰å¯¹è±¡å°±ä¼šæ‹¥æœ‰ä¸€ä¸ª BeanFactory å®¹å™¨çš„å¼•ç”¨ã€‚</li></ul><p><strong>å½“ç„¶ï¼ŒSpring ä¸ä»…ä»…åªæ˜¯æä¾›äº†ä¸Šé¢ä¸‰ä¸ª Aware æ¥å£ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—ï¼š</strong></p><ul><li><code>LoadTimeWeaverAware</code>ï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ</li><li><code>BootstrapContextAware</code>ï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI</li><li><code>ResourceLoaderAware</code>ï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨</li><li><code>PortletConfigAware</code>ï¼šPortletConfig</li><li><code>PortletContextAware</code>ï¼šPortletContext</li><li><code>ServletConfigAware</code>ï¼šServletConfig</li><li><code>ServletContextAware</code>ï¼šServletContext</li><li><code>MessageSourceAware</code>ï¼šå›½é™…åŒ–</li><li><code>ApplicationEventPublisherAware</code>ï¼šåº”ç”¨äº‹ä»¶</li><li><code>NotificationPublisherAware</code>ï¼šJMXé€šçŸ¥</li></ul><h2 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h2><p>åˆå§‹åŒ–ç¬¬äºŒä¸ªé˜¶æ®µåˆ™æ˜¯ BeanPostProcessor å¢å¼ºå¤„ç†ï¼Œåœ¨è¯¥é˜¶æ®µ BeanPostProcessor ä¼šå¤„ç†å½“å‰å®¹å™¨å†…æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å®ä¾‹åŒ–åçš„ bean å¯¹è±¡ã€‚</p><p><u>å®ƒä¸»è¦æ˜¯å¯¹ Spring å®¹å™¨æä¾›çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œæœ‰æ•ˆçš„æ‰©å±•ï¼Œå…è®¸ Spring åœ¨åˆå§‹åŒ– bean é˜¶æ®µå¯¹å…¶è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œå¦‚å¤„ç†æ ‡è®°æ¥å£æˆ–è€…ä¸ºå…¶æä¾›ä»£ç†å®ç°ã€‚</u></p><p>BeanPostProcessor æ¥å£æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåœ¨ä¸åŒçš„æ—¶æœºæ‰§è¡Œï¼Œåˆ†åˆ«å¯¹åº”ä¸Šå›¾çš„å‰ç½®å¤„ç†å’Œåç½®å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="InitializingBean-å’Œ-init-method"><a href="#InitializingBean-å’Œ-init-method" class="headerlink" title="InitializingBean å’Œ init-method"></a>InitializingBean å’Œ init-method</h2><p>InitializingBean æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒä¸º Spring Bean çš„åˆå§‹åŒ–æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå®ƒæœ‰ä¸€ä¸ª <code>afterPropertiesSet()</code> æ–¹æ³•ï¼Œåœ¨ bean çš„åˆå§‹åŒ–è¿›ç¨‹ä¸­ä¼šåˆ¤æ–­å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBeanï¼Œå¦‚æœå®ç°äº†åˆ™è°ƒç”¨ <code>afterPropertiesSet()</code> è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚ç„¶åå†æ£€æŸ¥æ˜¯å¦ä¹ŸæŒ‡å®šäº† init-method()ï¼Œå¦‚æœæŒ‡å®šäº†åˆ™é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æŒ‡å®šçš„ init-method()ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeInitMethods</span><span class="params">(String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> isInitializingBean = (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">  <span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">          ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;, getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> pae.getException();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mbd != <span class="keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">    String initMethodName = mbd.getInitMethodName();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">        !(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">        !mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">      invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº Spring è€Œè¨€ï¼Œè™½ç„¶ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å®ç°åˆå§‹åŒ–å®šåˆ¶åŒ–ï¼Œä½†æ˜¯æ›´åŠ æ¨å´‡ <code>init-method</code> æ–¹å¼ï¼Œå› ä¸ºå¯¹äº InitializingBean æ¥å£è€Œè¨€ï¼Œä»–éœ€è¦ bean å»å®ç°æ¥å£ï¼Œè¿™æ ·å°±ä¼šæ±¡æŸ“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæ˜¾å¾— Spring å…·æœ‰ä¸€å®šçš„ä¾µå…¥æ€§ã€‚ä½†æ˜¯ç”±äº <code>init-method</code> æ˜¯é‡‡ç”¨åå°„çš„æ–¹å¼ï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡ä¸Šç›¸å¯¹äº InitializingBean æ¥å£å›è°ƒçš„æ–¹å¼å¯èƒ½ä¼šä½ä¸€äº›ã€‚</p><h2 id="DisposableBean-å’Œ-destroy-method"><a href="#DisposableBean-å’Œ-destroy-method" class="headerlink" title="DisposableBean å’Œ destroy-method"></a>DisposableBean å’Œ destroy-method</h2><p>ä¸ InitializingBean å’Œ init-method ç”¨äºå¯¹è±¡çš„è‡ªå®šä¹‰åˆå§‹åŒ–å·¥ä½œç›¸ä¼¼ï¼ŒDisposableBeanå’Œ destroy-method åˆ™ç”¨äºå¯¹è±¡çš„è‡ªå®šä¹‰é”€æ¯å·¥ä½œã€‚</p><p>å½“ä¸€ä¸ª bean å¯¹è±¡ç»å†äº†å®ä¾‹åŒ–ã€è®¾ç½®å±æ€§ã€åˆå§‹åŒ–é˜¶æ®µ,é‚£ä¹ˆè¯¥ bean å¯¹è±¡å°±å¯ä»¥ä¾›å®¹å™¨ä½¿ç”¨äº†ï¼ˆè°ƒç”¨çš„è¿‡ç¨‹ï¼‰ã€‚å½“å®Œæˆè°ƒç”¨åï¼Œå¦‚æœæ˜¯ singleton ç±»å‹çš„ bean ï¼Œåˆ™ä¼šçœ‹å½“å‰ bean æ˜¯å¦åº”å®ç°äº† DisposableBean æ¥å£æˆ–è€…é…ç½®äº† destroy-method å±æ€§ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™ä¼šä¸ºè¯¥å®ä¾‹æ³¨å†Œä¸€ä¸ªç”¨äºå¯¹è±¡é”€æ¯çš„å›è°ƒæ–¹æ³•ï¼Œä¾¿äºåœ¨è¿™äº› singleton ç±»å‹çš„ bean å¯¹è±¡é”€æ¯ä¹‹å‰æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚</p><p>ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯å¯¹è±¡å®Œæˆè°ƒç”¨åå°±ä¼šç«‹åˆ»æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ Spring å®¹å™¨è¿˜å¤„äºè¿è¡Œé˜¶æ®µï¼Œåªæœ‰å½“ Spring å®¹å™¨å…³é—­çš„æ—¶å€™æ‰ä¼šå»è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œ Spring å®¹å™¨ä¸ä¼šè¿™ä¹ˆèªæ˜ä¼šè‡ªåŠ¨å»è°ƒç”¨è¿™äº›é”€æ¯æ–¹æ³•ï¼Œè€Œæ˜¯éœ€è¦æˆ‘ä»¬ä¸»åŠ¨å»å‘ŠçŸ¥ Spring å®¹å™¨ã€‚</p><ul><li>å¯¹äº BeanFactory å®¹å™¨è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦ä¸»åŠ¨è°ƒç”¨ <code>destroySingletons()</code> é€šçŸ¥ BeanFactory å®¹å™¨å»æ‰§è¡Œç›¸åº”çš„é”€æ¯æ–¹æ³•ã€‚</li><li>å¯¹äº ApplicationContext å®¹å™¨è€Œè¨€è°ƒç”¨ <code>registerShutdownHook()</code> æ–¹æ³•ã€‚</li></ul><h2 id="å®è·µéªŒè¯"><a href="#å®è·µéªŒè¯" class="headerlink" title="å®è·µéªŒè¯"></a>å®è·µéªŒè¯</h2><p>ä¸‹é¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥çœŸå®çœ‹çœ‹çœ‹ä¸Šé¢æ‰§è¡Œçš„é€»è¾‘ï¼Œæ¯•ç«Ÿç†è®ºæ˜¯ä¸èƒ½ç¼ºå°‘å®è·µçš„ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">lifeCycleBean</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span>,<span class="title">BeanFactoryAware</span>,<span class="title">BeanClassLoaderAware</span>,<span class="title">BeanPostProcessor</span>,</span></span><br><span class="line"><span class="class">        <span class="title">InitializingBean</span>,<span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String test;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest</span><span class="params">(String test)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å±æ€§æ³¨å…¥....&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.test = test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">lifeCycleBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ„é€ å‡½æ•°è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ–¹æ³•è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanFactoryAware è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanNameAware è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanClassLoaderAware è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanPostProcessor postProcessBeforeInitialization è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeanPostProcessor postProcessAfterInitialization è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DisposableBean destroy è¢«è°ƒåŠ¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;InitializingBean afterPropertiesSet è¢«è°ƒåŠ¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init-method è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyMethdo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy-method è¢«è°ƒç”¨...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lifeCycleBean ç»§æ‰¿äº† <code>BeanNameAware</code> , <code>BeanFactoryAware</code> , <code>BeanClassLoaderAware</code> , <code>BeanPostProcessor</code> , <code>InitializingBean</code> , <code>DisposableBean</code> å…­ä¸ªæ¥å£ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸€ä¸ª test å±æ€§ç”¨äºéªŒè¯å±æ€§æ³¨å…¥å’Œæä¾›ä¸€ä¸ª <code>display()</code> ç”¨äºæ¨¡æ‹Ÿè°ƒç”¨ã€‚ é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;lifeCycle&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test.lifeCycleBean&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">&quot;initMethod&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyMethdo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½® init-method å’Œ destroy-methodã€‚æµ‹è¯•æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// BeanFactory å®¹å™¨ä¸€å®šè¦è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œ BeanPostProcessor æ³¨å†Œ</span></span><br><span class="line">factory.addBeanPostProcessor(<span class="keyword">new</span> lifeCycleBean());</span><br><span class="line"></span><br><span class="line">lifeCycleBean lifeCycleBean = (lifeCycleBean) factory.getBean(<span class="string">&quot;lifeCycle&quot;</span>);</span><br><span class="line">lifeCycleBean.display();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;æ–¹æ³•è°ƒç”¨å®Œæˆï¼Œå®¹å™¨å¼€å§‹å…³é—­....&quot;</span>);</span><br><span class="line"><span class="comment">// å…³é—­å®¹å™¨</span></span><br><span class="line">factory.destroySingletons();</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ„é€ å‡½æ•°è°ƒç”¨...</span><br><span class="line">æ„é€ å‡½æ•°è°ƒç”¨...</span><br><span class="line">å±æ€§æ³¨å…¥....</span><br><span class="line">BeanNameAware è¢«è°ƒç”¨...</span><br><span class="line">BeanClassLoaderAware è¢«è°ƒç”¨...</span><br><span class="line">BeanFactoryAware è¢«è°ƒç”¨...</span><br><span class="line">BeanPostProcessor postProcessBeforeInitialization è¢«è°ƒç”¨...</span><br><span class="line">InitializingBean afterPropertiesSet è¢«è°ƒåŠ¨...</span><br><span class="line">init-method è¢«è°ƒç”¨...</span><br><span class="line">BeanPostProcessor postProcessAfterInitialization è¢«è°ƒç”¨...</span><br><span class="line">æ–¹æ³•è°ƒç”¨...</span><br><span class="line">æ–¹æ³•è°ƒç”¨å®Œæˆï¼Œå®¹å™¨å¼€å§‹å…³é—­....</span><br><span class="line">DisposableBean destroy è¢«è°ƒåŠ¨...</span><br><span class="line">destroy-method è¢«è°ƒç”¨...</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°è°ƒç”¨æ˜¯å› ä¸ºè¦æ³¨å…¥ä¸€ä¸ª BeanPostProcessorï¼ˆä½ ä¹Ÿå¯ä»¥å¦å¤–æä¾›ä¸€ä¸ª BeanPostProcessor å®ä¾‹ï¼‰ã€‚</p><p>æ ¹æ®æ‰§è¡Œçš„ç»“æœå·²ç»ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ Spring Bean çš„å£°æ˜å‘¨æœŸè¿‡ç¨‹å¦‚ä¸‹ï¼ˆæ–¹æ³•çº§åˆ«ï¼‰ï¼š</p><ol><li>Spring å®¹å™¨æ ¹æ®å®ä¾‹åŒ–ç­–ç•¥å¯¹ Bean è¿›è¡Œå®ä¾‹åŒ–ã€‚</li><li>å®ä¾‹åŒ–å®Œæˆåï¼Œå¦‚æœè¯¥ bean è®¾ç½®äº†ä¸€äº›å±æ€§çš„è¯ï¼Œåˆ™åˆ©ç”¨ set æ–¹æ³•è®¾ç½®ä¸€äº›å±æ€§ã€‚</li><li>å¦‚æœè¯¥ Bean å®ç°äº† BeanNameAware æ¥å£ï¼Œåˆ™è°ƒç”¨ <code>setBeanName()</code> æ–¹æ³•ã€‚</li><li>å¦‚æœè¯¥ bean å®ç°äº† BeanClassLoaderAware æ¥å£ï¼Œåˆ™è°ƒç”¨ <code>setBeanClassLoader()</code> æ–¹æ³•ã€‚</li><li>å¦‚æœè¯¥ bean å®ç°äº† BeanFactoryAwareæ¥å£ï¼Œåˆ™è°ƒç”¨ <code>setBeanFactory()</code> æ–¹æ³•ã€‚</li><li>å¦‚æœè¯¥å®¹å™¨æ³¨å†Œäº† BeanPostProcessorï¼Œåˆ™ä¼šè°ƒç”¨<code>postProcessBeforeInitialization()</code> æ–¹æ³•å®Œæˆ bean å‰ç½®å¤„ç†</li><li>å¦‚æœè¯¥ bean å®ç°äº† InitializingBean æ¥å£ï¼Œåˆ™è°ƒç”¨ ã€‚<code>afterPropertiesSet()</code> æ–¹æ³•ã€‚</li><li>å¦‚æœè¯¥ bean é…ç½®äº† init-method æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ init-method æŒ‡å®šçš„æ–¹æ³•ã€‚</li><li>åˆå§‹åŒ–å®Œæˆåï¼Œå¦‚æœè¯¥å®¹å™¨æ³¨å†Œäº† BeanPostProcessor åˆ™ä¼šè°ƒç”¨ <code>postProcessAfterInitialization()</code> æ–¹æ³•å®Œæˆ bean çš„åç½®å¤„ç†ã€‚</li><li>å¯¹è±¡å®Œæˆåˆå§‹åŒ–ï¼Œå¼€å§‹æ–¹æ³•è°ƒç”¨ã€‚</li><li>åœ¨å®¹å™¨è¿›è¡Œå…³é—­ä¹‹å‰ï¼Œå¦‚æœè¯¥ bean å®ç°äº† DisposableBean æ¥å£ï¼Œåˆ™è°ƒç”¨ <code>destroy()</code> æ–¹æ³•ã€‚</li><li>åœ¨å®¹å™¨è¿›è¡Œå…³é—­ä¹‹å‰ï¼Œå¦‚æœè¯¥ bean é…ç½®äº† destroy-mehodï¼Œåˆ™è°ƒç”¨å…¶æŒ‡å®šçš„æ–¹æ³•ã€‚</li><li>åˆ°è¿™é‡Œä¸€ä¸ª bean ä¹Ÿå°±å®Œæˆäº†å®ƒçš„ä¸€ç”Ÿã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springçš„ç¯å¢ƒ&amp;å±æ€§ï¼šPropertySourceã€Environmentã€Profile</title>
      <link href="/blog/2020/01/25/8ce6797f.html"/>
      <url>/blog/2020/01/25/8ce6797f.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4032">http://cmsblogs.com/?p=4032</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><code>spring.profiles.active</code> å’Œ <code>@Profile</code> è¿™ä¸¤ä¸ªæˆ‘ç›¸ä¿¡å„ä½éƒ½ç†Ÿæ‚‰å§ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¯ä»¥å®ç°ä¸åŒç¯å¢ƒä¸‹ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰å‚æ•°é…ç½®çš„åˆ‡æ¢ã€‚</p><p>å…¶å®å…³äºç¯å¢ƒçš„åˆ‡æ¢ï¼Œåœ¨åšå®¢ <a href="/2020/01/23/cd2eaad8.html"> IOC ä¹‹ PropertyPlaceholderConfigurer çš„åº”ç”¨</a> å·²ç»ä»‹ç»äº†åˆ©ç”¨ PropertyPlaceholderConfigurer æ¥å®ç°åŠ¨æ€åˆ‡æ¢é…ç½®ç¯å¢ƒï¼Œå½“ç„¶è¿™ç§æ–¹æ³•éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæœ‰ç‚¹å„¿éº»çƒ¦ã€‚ä½†æ˜¯å¯¹äºè¿™ç§éå¸¸å®é™…çš„éœ€æ±‚ï¼ŒSpring æ€ä¹ˆå¯èƒ½æ²¡æœ‰æä¾›å‘¢ï¼Ÿä¸‹é¢å°±è¿™ä¸ªé—®é¢˜æ¥å¯¹ Spring çš„<strong>ç¯å¢ƒ &amp; å±æ€§</strong>æ¥åšä¸€ä¸ªåˆ†æè¯´æ˜ã€‚</p><h2 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h2><p>Spring ç¯å¢ƒ &amp; å±æ€§ç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼š<code>PropertySource</code>ã€<code>PropertyResolver</code>ã€<code>Profile</code> å’Œ <code>Environment</code>ã€‚</p><ul><li><strong>PropertySource</strong>ï¼šå±æ€§æºï¼Œkey-value å±æ€§å¯¹æŠ½è±¡ï¼Œç”¨äºé…ç½®æ•°æ®ã€‚</li><li><strong>PropertyResolver</strong>ï¼šå±æ€§è§£æå™¨ï¼Œç”¨äºè§£æå±æ€§é…ç½®</li><li><strong>Profile</strong>ï¼šå‰–é¢ï¼Œåªæœ‰æ¿€æ´»çš„å‰–é¢çš„ç»„ä»¶/é…ç½®æ‰ä¼šæ³¨å†Œåˆ° Spring å®¹å™¨ï¼Œç±»ä¼¼äº Spring Boot ä¸­çš„ profile</li><li><strong>Environment</strong>ï¼šç¯å¢ƒï¼ŒProfile å’Œ PropertyResolver çš„ç»„åˆã€‚</li></ul><p>ä¸‹é¢æ˜¯æ•´ä¸ªä½“ç³»çš„ç»“æ„å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15398567835599_IpITEl_QAdnEu.jpg" alt="img"></p><p>ä¸‹é¢å°±é’ˆå¯¹ä¸Šé¢ç»“æ„å›¾å¯¹ Spring çš„ Properties &amp; Environment åšä¸€ä¸ªè¯¦ç»†çš„åˆ†æã€‚</p><h2 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h2><h3 id="PropertyResolver"><a href="#PropertyResolver" class="headerlink" title="PropertyResolver"></a>PropertyResolver</h3><blockquote><p>å±æ€§è§£æå™¨ï¼Œç”¨äºè§£æä»»ä½•åŸºç¡€æºçš„å±æ€§çš„æ¥å£</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertyResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦åŒ…å«æŸä¸ªå±æ€§</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsProperty</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å±æ€§å€¼ å¦‚æœæ‰¾ä¸åˆ°è¿”å›null</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getProperty</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å±æ€§å€¼ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¿”å›é»˜è®¤å€¼  </span></span><br><span class="line">    <span class="function">String <span class="title">getProperty</span><span class="params">(String key, String defaultValue)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°è¿”å›null</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°è¿”å›é»˜è®¤å€¼</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetType, T defaultValue)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalStateException</span></span><br><span class="line">    <span class="function">String <span class="title">getRequiredProperty</span><span class="params">(String key)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalStateException</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getRequiredProperty</span><span class="params">(String key, Class&lt;T&gt; targetType)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢æ–‡æœ¬ä¸­çš„å ä½ç¬¦ï¼ˆ$&#123;key&#125;ï¼‰åˆ°å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°ä¸è§£æ</span></span><br><span class="line">    <span class="function">String <span class="title">resolvePlaceholders</span><span class="params">(String text)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢æ–‡æœ¬ä¸­çš„å ä½ç¬¦ï¼ˆ$&#123;key&#125;ï¼‰åˆ°å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalArgumentException</span></span><br><span class="line">    <span class="function">String <span class="title">resolveRequiredPlaceholders</span><span class="params">(String text)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» API ä¸Šé¢æˆ‘ä»¬å°±çŸ¥é“å±æ€§è§£æå™¨ PropertyResolver çš„ä½œç”¨äº†ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyResolver propertyResolver = <span class="keyword">new</span> PropertySourcesPropertyResolver(propertySources);</span><br><span class="line"></span><br><span class="line">System.out.println(propertyResolver.getProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">System.out.println(propertyResolver.getProperty(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;chenssy&quot;</span>));</span><br><span class="line">System.out.println(propertyResolver.resolvePlaceholders(<span class="string">&quot;my name is  $&#123;name&#125;&quot;</span>));</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾æ˜¯ PropertyResolver ä½“ç³»ç»“æ„å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/201810241001_UC9RsT_5WoqUp.png" alt="201810241001"></p><ul><li><strong>ConfigurablePropertyResolver</strong>ï¼šä¾›å±æ€§ç±»å‹è½¬æ¢çš„åŠŸèƒ½</li><li><strong>AbstractPropertyResolver</strong>ï¼šè§£æå±æ€§æ–‡ä»¶çš„æŠ½è±¡åŸºç±»</li><li><strong>PropertySourcesPropertyResolver</strong>ï¼šPropertyResolver çš„å®ç°è€…ï¼Œä»–å¯¹ä¸€ç»„ PropertySources æä¾›å±æ€§è§£ææœåŠ¡</li></ul><h3 id="ConfigurablePropertyResolver"><a href="#ConfigurablePropertyResolver" class="headerlink" title="ConfigurablePropertyResolver"></a>ConfigurablePropertyResolver</h3><blockquote><p>æä¾›å±æ€§ç±»å‹è½¬æ¢çš„åŠŸèƒ½</p></blockquote><p>é€šä¿—ç‚¹è¯´å°±æ˜¯ ConfigurablePropertyResolver æä¾›å±æ€§å€¼ç±»å‹è½¬æ¢æ‰€éœ€è¦çš„ ConversionServiceã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurablePropertyResolver</span> <span class="keyword">extends</span> <span class="title">PropertyResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ‰§è¡Œç±»å‹è½¬æ¢æ—¶ä½¿ç”¨çš„ ConfigurableConversionService</span></span><br><span class="line">    <span class="function">ConfigurableConversionService <span class="title">getConversionService</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® ConfigurableConversionService</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setConversionService</span><span class="params">(ConfigurableConversionService conversionService)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å ä½ç¬¦å‰ç¼€</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPlaceholderPrefix</span><span class="params">(String placeholderPrefix)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å ä½ç¬¦åç¼€</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPlaceholderSuffix</span><span class="params">(String placeholderSuffix)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å ä½ç¬¦ä¸é»˜è®¤å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setValueSeparator</span><span class="params">(<span class="meta">@Nullable</span> String valueSeparator)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å½“é‡åˆ°åµŒå¥—åœ¨ç»™å®šå±æ€§å€¼å†…çš„ä¸å¯è§£æçš„å ä½ç¬¦æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// å½“å±æ€§å€¼åŒ…å«ä¸å¯è§£æçš„å ä½ç¬¦æ—¶ï¼ŒgetProperty(String)åŠå…¶å˜ä½“çš„å®ç°å¿…é¡»æ£€æŸ¥æ­¤å¤„è®¾ç½®çš„å€¼ä»¥ç¡®å®šæ­£ç¡®çš„è¡Œä¸ºã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setIgnoreUnresolvableNestedPlaceholders</span><span class="params">(<span class="keyword">boolean</span> ignoreUnresolvableNestedPlaceholders)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å®šå¿…é¡»å­˜åœ¨å“ªäº›å±æ€§ï¼Œä»¥ä¾¿ç”±validateRequiredPropertiesï¼ˆï¼‰éªŒè¯</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRequiredProperties</span><span class="params">(String... requiredProperties)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éªŒè¯setRequiredPropertiesæŒ‡å®šçš„æ¯ä¸ªå±æ€§æ˜¯å¦å­˜åœ¨å¹¶è§£æä¸ºénullå€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validateRequiredProperties</span><span class="params">()</span> <span class="keyword">throws</span> MissingRequiredPropertiesException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» ConfigurablePropertyResolver æ‰€æä¾›çš„æ–¹æ³•æ¥çœ‹ï¼Œé™¤äº†è®¿é—®å’Œè®¾ç½® ConversionService å¤–ï¼Œä¸»è¦è¿˜æä¾›äº†ä¸€äº›è§£æè§„åˆ™ä¹‹ç±»çš„æ–¹æ³•ã€‚</p><p>å°± Properties ä½“ç³»è€Œè¨€ï¼ŒPropertyResolver å®šä¹‰äº†è®¿é—® Properties å±æ€§å€¼çš„æ–¹æ³•ï¼Œè€Œ ConfigurablePropertyResolver åˆ™å®šä¹‰äº†è§£æ Properties ä¸€äº›ç›¸å…³çš„è§„åˆ™å’Œå€¼è¿›è¡Œç±»å‹è½¬æ¢æ‰€éœ€è¦çš„ Serviceã€‚</p><p>è¯¥ä½“ç³»æœ‰ä¸¤ä¸ªå®ç°è€…ï¼š<code>AbstractPropertyResolver</code> å’Œ <code>PropertySourcesPropertyResolver</code>ï¼Œå…¶ä¸­ <code>AbstractPropertyResolver</code> ä¸ºå®ç°çš„æŠ½è±¡åŸºç±»ï¼Œ<code>PropertySourcesPropertyResolver</code> ä¸ºçœŸæ­£çš„å®ç°è€…ã€‚</p><h3 id="AbstractPropertyResolver"><a href="#AbstractPropertyResolver" class="headerlink" title="AbstractPropertyResolver"></a>AbstractPropertyResolver</h3><blockquote><p>è§£æå±æ€§æ–‡ä»¶çš„æŠ½è±¡åŸºç±»</p></blockquote><p>AbstractPropertyResolver ä½œä¸ºåŸºç±»å®ƒä»…ä»…åªæ˜¯è®¾ç½®äº†ä¸€äº›è§£æå±æ€§æ–‡ä»¶æ‰€éœ€è¦é…ç½®æˆ–è€…è½¬æ¢å™¨ï¼Œå¦‚ <code>setConversionService()</code>ã€<code>setPlaceholderPrefix()</code>ã€<code>setValueSeparator()</code>ï¼Œå…¶å®è¿™äº›æ–¹æ³•çš„å®ç°éƒ½æ¯”è¾ƒç®€å•éƒ½æ˜¯è®¾ç½®æˆ–è€…è·å– AbstractPropertyResolver æ‰€æä¾›çš„å±æ€§ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹è½¬æ¢å»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ConfigurableConversionService conversionService;</span><br><span class="line"><span class="comment">// å ä½ç¬¦</span></span><br><span class="line"><span class="keyword">private</span> PropertyPlaceholderHelper nonStrictHelper;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> PropertyPlaceholderHelper strictHelper;</span><br><span class="line"><span class="comment">// è®¾ç½®æ˜¯å¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> ignoreUnresolvableNestedPlaceholders = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// å ä½ç¬¦å‰ç¼€</span></span><br><span class="line"><span class="keyword">private</span> String placeholderPrefix = SystemPropertyUtils.PLACEHOLDER_PREFIX;</span><br><span class="line"><span class="comment">// å ä½ç¬¦åç¼€</span></span><br><span class="line"><span class="keyword">private</span> String placeholderSuffix = SystemPropertyUtils.PLACEHOLDER_SUFFIX;</span><br><span class="line"><span class="comment">// ä¸é»˜è®¤å€¼çš„åˆ†å‰²</span></span><br><span class="line"><span class="keyword">private</span> String valueSeparator = SystemPropertyUtils.VALUE_SEPARATOR;</span><br><span class="line"><span class="comment">// å¿…é¡»è¦æœ‰çš„å­—æ®µå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; requiredProperties = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br></pre></td></tr></table></figure><p>è¿™äº›å±æ€§éƒ½æ˜¯ ConfigurablePropertyResolver æ¥å£æ‰€æä¾›æ–¹æ³•éœ€è¦çš„å±æ€§ï¼Œä»–æ‰€æä¾›çš„æ–¹æ³•éƒ½æ˜¯è®¾ç½®å’Œè¯»å–è¿™äº›å€¼ï¼Œå¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableConversionService <span class="title">getConversionService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// éœ€è¦æä¾›ç‹¬ç«‹çš„DefaultConversionServiceï¼Œè€Œä¸æ˜¯PropertySourcesPropertyResolver ä½¿ç”¨çš„å…±äº«DefaultConversionServiceã€‚</span></span><br><span class="line">  ConfigurableConversionService cs = <span class="keyword">this</span>.conversionService;</span><br><span class="line">  <span class="keyword">if</span> (cs == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      cs = <span class="keyword">this</span>.conversionService;</span><br><span class="line">      <span class="keyword">if</span> (cs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cs = <span class="keyword">new</span> DefaultConversionService();</span><br><span class="line">        <span class="keyword">this</span>.conversionService = cs;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConversionService</span><span class="params">(ConfigurableConversionService conversionService)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(conversionService, <span class="string">&quot;ConversionService must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.conversionService = conversionService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPlaceholderPrefix</span><span class="params">(String placeholderPrefix)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(placeholderPrefix, <span class="string">&quot;&#x27;placeholderPrefix&#x27; must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.placeholderPrefix = placeholderPrefix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPlaceholderSuffix</span><span class="params">(String placeholderSuffix)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(placeholderSuffix, <span class="string">&quot;&#x27;placeholderSuffix&#x27; must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.placeholderSuffix = placeholderSuffix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¯¹å±æ€§çš„è®¿é—®åˆ™å§”æ‰˜ç»™å­ç±» PropertySourcesPropertyResolver å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getProperty(key, String.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getProperty</span><span class="params">(String key, String defaultValue)</span> </span>&#123;</span><br><span class="line">  String value = getProperty(key);</span><br><span class="line">  <span class="keyword">return</span> (value != <span class="keyword">null</span> ? value : defaultValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetType, T defaultValue)</span> </span>&#123;</span><br><span class="line">  T value = getProperty(key, targetType);</span><br><span class="line">  <span class="keyword">return</span> (value != <span class="keyword">null</span> ? value : defaultValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRequiredProperty</span><span class="params">(String key)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">  String value = getProperty(key);</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Required key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getRequiredProperty</span><span class="params">(String key, Class&lt;T&gt; valueType)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">  T value = getProperty(key, valueType);</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Required key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br></pre></td></tr></table></figure><h3 id="PropertySourcesPropertyResolver"><a href="#PropertySourcesPropertyResolver" class="headerlink" title="PropertySourcesPropertyResolver"></a>PropertySourcesPropertyResolver</h3><blockquote><p>PropertyResolver çš„å®ç°è€…ï¼Œä»–å¯¹ä¸€ç»„ PropertySources æä¾›å±æ€§è§£ææœåŠ¡</p></blockquote><p>å®ƒä»…æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼šPropertySourcesã€‚è¯¥æˆå‘˜å˜é‡å†…éƒ¨å­˜å‚¨ç€ä¸€ç»„ PropertySourceï¼Œè¡¨ç¤º key-value é”®å€¼å¯¹çš„æºçš„æŠ½è±¡åŸºç±»ï¼Œå³ä¸€ä¸ª PropertySource å¯¹è±¡åˆ™æ˜¯ä¸€ä¸ª key-value é”®å€¼å¯¹ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertySource</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> T source;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹å¤–å…¬å¼€çš„ <code>getProperty()</code> éƒ½æ˜¯å§”æ‰˜ç»™ <code>getProperty(String key, Class&lt;T&gt; targetValueType, boolean resolveNestedPlaceholders)</code> å®ç°ï¼Œä»–æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸ºï¼š</p><ul><li>keyï¼šè·å–çš„ key</li><li>targetValueTypeï¼š ç›®æ ‡ value çš„ç±»å‹</li><li>resolveNestedPlaceholdersï¼šæ˜¯å¦è§£å†³åµŒå¥—å ä½ç¬¦</li></ul><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetValueType, <span class="keyword">boolean</span> resolveNestedPlaceholders)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.propertySources != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (PropertySource&lt;?&gt; propertySource : <span class="keyword">this</span>.propertySources) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Searching for key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in PropertySource &#x27;&quot;</span> +</span><br><span class="line">                     propertySource.getName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Object value = propertySource.getProperty(key);</span><br><span class="line">      <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resolveNestedPlaceholders &amp;&amp; value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          value = resolveNestedPlaceholders((String) value);</span><br><span class="line">        &#125;</span><br><span class="line">        logKeyFound(key, propertySource, value);</span><br><span class="line">        <span class="keyword">return</span> convertValueIfNecessary(value, targetValueType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Could not find key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in any property source&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä» propertySource ä¸­è·å–æŒ‡å®š key çš„ value å€¼ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåµŒå¥—å ä½ç¬¦è§£æï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨ <code>resolveNestedPlaceholders()</code> è¿›è¡ŒåµŒå¥—å ä½ç¬¦è§£æï¼Œç„¶åè°ƒç”¨ <code>convertValueIfNecessary()</code> è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><p><strong>resolveNestedPlaceholders()</strong></p><p>è¯¥æ–¹æ³•ç”¨äºè§£æç»™å®šå­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ï¼ŒåŒæ—¶æ ¹æ® ignoreUnresolvableNestedPlaceholders çš„å€¼ï¼Œæ¥ç¡®å®šæ˜¯å¦å¯¹ä¸å¯è§£æçš„å ä½ç¬¦çš„å¤„ç†æ–¹æ³•ï¼šæ˜¯å¿½ç•¥è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ˆè¯¥å€¼ç”± <code>setIgnoreUnresolvableNestedPlaceholders()</code> è®¾ç½®ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveNestedPlaceholders</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">this</span>.ignoreUnresolvableNestedPlaceholders ?</span><br><span class="line">          resolvePlaceholders(value) : resolveRequiredPlaceholders(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ this.ignoreUnresolvableNestedPlaceholders ä¸º trueï¼Œåˆ™è°ƒç”¨ <code>resolvePlaceholders()</code> ï¼Œå¦åˆ™è°ƒç”¨ <code>resolveRequiredPlaceholders()</code>ä½†æ˜¯æ— è®ºæ˜¯å“ªä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šåˆ° <code>doResolvePlaceholders()</code>ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>String ç±»å‹çš„ textï¼šå¾…è§£æçš„å­—ç¬¦ä¸²</li><li>PropertyPlaceholderHelper ç±»å‹çš„ helperï¼šç”¨äºè§£æå ä½ç¬¦çš„å·¥å…·ç±»ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">doResolvePlaceholders</span><span class="params">(String text, PropertyPlaceholderHelper helper)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> helper.replacePlaceholders(text, <span class="keyword">this</span>::getPropertyAsRawString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PropertyPlaceholderHelper æ˜¯ç”¨äºå¤„ç†åŒ…å«å ä½ç¬¦å€¼çš„å­—ç¬¦ä¸²ï¼Œæ„é€ è¯¥å®ä¾‹éœ€è¦å››ä¸ªå‚æ•°ï¼š</p><ul><li>placeholderPrefixï¼šå ä½ç¬¦å‰ç¼€</li><li>placeholderSuffixï¼šå ä½ç¬¦åç¼€</li><li>valueSeparatorï¼šå ä½ç¬¦å˜é‡ä¸å…³è”çš„é»˜è®¤å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦</li><li>ignoreUnresolvablePlaceholdersï¼šæŒ‡ç¤ºæ˜¯å¦å¿½ç•¥ä¸å¯è§£æçš„å ä½ç¬¦ï¼ˆtrueï¼‰æˆ–æŠ›å‡ºå¼‚å¸¸ï¼ˆfalseï¼‰</li></ul><p>æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertyPlaceholderHelper</span><span class="params">(String placeholderPrefix, String placeholderSuffix,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Nullable</span> String valueSeparator, <span class="keyword">boolean</span> ignoreUnresolvablePlaceholders)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Assert.notNull(placeholderPrefix, <span class="string">&quot;&#x27;placeholderPrefix&#x27; must not be null&quot;</span>);</span><br><span class="line">  Assert.notNull(placeholderSuffix, <span class="string">&quot;&#x27;placeholderSuffix&#x27; must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.placeholderPrefix = placeholderPrefix;</span><br><span class="line">  <span class="keyword">this</span>.placeholderSuffix = placeholderSuffix;</span><br><span class="line">  String simplePrefixForSuffix = wellKnownSimplePrefixes.get(<span class="keyword">this</span>.placeholderSuffix);</span><br><span class="line">  <span class="keyword">if</span> (simplePrefixForSuffix != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.placeholderPrefix.endsWith(simplePrefixForSuffix)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.simplePrefix = simplePrefixForSuffix;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.simplePrefix = <span class="keyword">this</span>.placeholderPrefix;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.valueSeparator = valueSeparator;</span><br><span class="line">  <span class="keyword">this</span>.ignoreUnresolvablePlaceholders = ignoreUnresolvablePlaceholders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°± PropertySourcesPropertyResolver è€Œè¨€ï¼Œå…¶çˆ¶ç±» AbstractPropertyResolver å·²ç»å¯¹ä¸Šè¿°å››ä¸ªå€¼åšäº†å®šä¹‰ï¼šplaceholderPrefix ä¸º <code>$&#123;</code>ï¼ŒplaceholderSuffix ä¸º <code>&#125;</code>ï¼ŒvalueSeparator ä¸º <code>:</code>ï¼ŒignoreUnresolvablePlaceholders é»˜è®¤ä¸º falseï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸åº”çš„ setter æ–¹æ³•è‡ªå®šä¹‰ã€‚</p><p>è°ƒç”¨ PropertyPlaceholderHelper çš„ <code>replacePlaceholders()</code> å¯¹å ä½ç¬¦è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¾…è§£æçš„å­—ç¬¦ä¸² value ï¼Œä¸€ä¸ªæ˜¯ PlaceholderResolver ç±»å‹çš„ placeholderResolverï¼Œä»–æ˜¯å®šä¹‰å ä½ç¬¦è§£æçš„ç­–ç•¥ç±»ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replacePlaceholders</span><span class="params">(String value, PlaceholderResolver placeholderResolver)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(value, <span class="string">&quot;&#x27;value&#x27; must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> parseStringValue(value, placeholderResolver, <span class="keyword">new</span> HashSet&lt;&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨å§”æ‰˜ç»™ <code>parseStringValue()</code> å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">parseStringValue</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String value, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  StringBuilder result = <span class="keyword">new</span> StringBuilder(value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€ç´¢å‰ç¼€ï¼Œ$&#123;</span></span><br><span class="line">  <span class="keyword">int</span> startIndex = value.indexOf(<span class="keyword">this</span>.placeholderPrefix);</span><br><span class="line">  <span class="keyword">while</span> (startIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€ç´¢åç¼€ ,&#125;</span></span><br><span class="line">    <span class="keyword">int</span> endIndex = findPlaceholderEndIndex(result, startIndex);</span><br><span class="line">    <span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// å‰ç¼€å’Œåç¼€ä¹‹é—´çš„å­—ç¬¦ä¸²</span></span><br><span class="line">      String placeholder = result.substring(startIndex + <span class="keyword">this</span>.placeholderPrefix.length(), endIndex);</span><br><span class="line">      String originalPlaceholder = placeholder;</span><br><span class="line">      <span class="comment">// å¾ªç¯å ä½ç¬¦</span></span><br><span class="line">      <span class="comment">// åˆ¤æ–­è¯¥å ä½ç¬¦æ˜¯å¦å·²ç»å¤„ç†äº†</span></span><br><span class="line">      <span class="keyword">if</span> (!visitedPlaceholders.add(originalPlaceholder)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">          <span class="string">&quot;Circular placeholder reference &#x27;&quot;</span> + originalPlaceholder + <span class="string">&quot;&#x27; in property definitions&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// é€’å½’è°ƒç”¨ï¼Œè§£æå ä½ç¬¦</span></span><br><span class="line">      placeholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);</span><br><span class="line">      <span class="comment">// è·å–å€¼</span></span><br><span class="line">      String propVal = placeholderResolver.resolvePlaceholder(placeholder);</span><br><span class="line">      <span class="comment">// propval ä¸ºç©ºï¼Œåˆ™æå–é»˜è®¤å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (propVal == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.valueSeparator != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> separatorIndex = placeholder.indexOf(<span class="keyword">this</span>.valueSeparator);</span><br><span class="line">        <span class="keyword">if</span> (separatorIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">          String actualPlaceholder = placeholder.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">          String defaultValue = placeholder.substring(separatorIndex + <span class="keyword">this</span>.valueSeparator.length());</span><br><span class="line">          propVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);</span><br><span class="line">          <span class="keyword">if</span> (propVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">            propVal = defaultValue;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (propVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// é€’å½’è°ƒç”¨ï¼Œè§£æå…ˆå‰è§£æçš„å ä½ç¬¦å€¼ä¸­åŒ…å«çš„å ä½ç¬¦</span></span><br><span class="line">        propVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);</span><br><span class="line">        result.replace(startIndex, endIndex + <span class="keyword">this</span>.placeholderSuffix.length(), propVal);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">          logger.trace(<span class="string">&quot;Resolved placeholder &#x27;&quot;</span> + placeholder + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, startIndex + propVal.length());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.ignoreUnresolvablePlaceholders) &#123;</span><br><span class="line">        <span class="comment">// Proceed with unprocessed value.</span></span><br><span class="line">        startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, endIndex + <span class="keyword">this</span>.placeholderSuffix.length());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Could not resolve placeholder &#x27;&quot;</span> +</span><br><span class="line">                                           placeholder + <span class="string">&quot;&#x27;&quot;</span> + <span class="string">&quot; in value \&quot;&quot;</span> + value + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      visitedPlaceholders.remove(originalPlaceholder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      startIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯è·å–å ä½ç¬¦ <code>$&#123;&#125;</code> ä¸­é—´çš„å€¼ï¼Œè¿™é‡Œé¢ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œå› ä¸ºå¯èƒ½ä¼šå­˜åœ¨è¿™ç§æƒ…å†µ <code>$&#123;$&#123;name&#125;&#125;</code>ã€‚</p><p><strong>convertValueIfNecessary()</strong></p><p>è¯¥æ–¹æ³•æ˜¯ä¸æ˜¯æ„Ÿè§‰åˆ°éå¸¸çš„ç†Ÿæ‚‰ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å®Œæˆç±»å‹è½¬æ¢çš„ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">convertValueIfNecessary</span><span class="params">(Object value, <span class="meta">@Nullable</span> Class&lt;T&gt; targetType)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (targetType == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) value;</span><br><span class="line">  &#125;</span><br><span class="line">  ConversionService conversionServiceToUse = <span class="keyword">this</span>.conversionService;</span><br><span class="line">  <span class="keyword">if</span> (conversionServiceToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Avoid initialization of shared DefaultConversionService if</span></span><br><span class="line">    <span class="comment">// no standard type conversion is needed in the first place...</span></span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isAssignableValue(targetType, value)) &#123;</span><br><span class="line">      <span class="keyword">return</span> (T) value;</span><br><span class="line">    &#125;</span><br><span class="line">    conversionServiceToUse = DefaultConversionService.getSharedInstance();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> conversionServiceToUse.convert(value, targetType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–ç±»å‹è½¬æ¢æœåŠ¡ conversionService ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¯ä»¥é€šè¿‡åå°„æ¥è®¾ç½®ï¼Œå¦‚æœå¯ä»¥åˆ™ç›´æ¥å¼ºè½¬è¿”å›ï¼Œå¦åˆ™æ„é€ ä¸€ä¸ª DefaultConversionService å®ä¾‹ï¼Œæœ€åè°ƒç”¨å…¶ <code>convert()</code> å®Œæˆç±»å‹è½¬æ¢ï¼Œåç»­å°±æ˜¯ Spring ç±»å‹è½¬æ¢ä½“ç³»çš„äº‹æƒ…äº†ï¼Œå¦‚æœå¯¹å…¶ä¸äº†è§£ï¼Œå¯ä»¥å‚è€ƒå°ç¼–è¿™ç¯‡åšå®¢ï¼š<a href="/2020/01/24/683bb448.html">IOC ä¹‹æ·±å…¥åˆ†æ Bean çš„ç±»å‹è½¬æ¢ä½“ç³»</a></p><h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><blockquote><p>è¡¨ç¤ºå½“å‰åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œçš„ç¯å¢ƒ</p></blockquote><p>åº”ç”¨ç¨‹åºçš„ç¯å¢ƒæœ‰ä¸¤ä¸ªå…³é”®æ–¹é¢ï¼šprofile å’Œ propertiesã€‚</p><ul><li>properties çš„æ–¹æ³•ç”± PropertyResolver å®šä¹‰ã€‚</li><li>profile åˆ™è¡¨ç¤ºå½“å‰çš„è¿è¡Œç¯å¢ƒï¼Œå¯¹äºåº”ç”¨ç¨‹åºä¸­çš„ properties è€Œè¨€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„éƒ½ä¼šåŠ è½½åˆ°ç³»ç»Ÿä¸­ï¼Œåªæœ‰å…¶å±æ€§ä¸ profile ä¸€ç›´æ‰ä¼šè¢«æ¿€æ´»åŠ è½½ï¼Œ</li></ul><p>æ‰€ä»¥ Environment å¯¹è±¡çš„ä½œç”¨æ˜¯ç¡®å®šå“ªäº›é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰å½“å‰å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä»¥åŠé»˜è®¤æƒ…å†µä¸‹å“ªäº›é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰åº”å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚properties åœ¨å‡ ä¹æ‰€æœ‰åº”ç”¨ç¨‹åºä¸­éƒ½å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œå¹¶ä¸”æœ‰å¤šç§æ¥æºï¼šå±æ€§æ–‡ä»¶ï¼ŒJVM ç³»ç»Ÿå±æ€§ï¼Œç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒJNDIï¼Œservlet ä¸Šä¸‹æ–‡å‚æ•°ï¼Œad-hoc å±æ€§å¯¹è±¡ï¼Œæ˜ å°„ç­‰ã€‚åŒæ—¶å®ƒç»§æ‰¿ PropertyResolver æ¥å£ï¼Œæ‰€ä»¥ä¸å±æ€§ç›¸å…³çš„ Environment å¯¹è±¡å…¶ä¸»è¦æ˜¯ä¸ºç”¨æˆ·æä¾›æ–¹ä¾¿çš„æœåŠ¡æ¥å£ï¼Œç”¨äºé…ç½®å±æ€§æºå’Œä»ä¸­å±æ€§æºä¸­è§£æå±æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Environment</span> <span class="keyword">extends</span> <span class="title">PropertyResolver</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿”å›æ­¤ç¯å¢ƒä¸‹æ¿€æ´»çš„é…ç½®æ–‡ä»¶é›†</span></span><br><span class="line">    String[] getActiveProfiles();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæœªè®¾ç½®æ¿€æ´»é…ç½®æ–‡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„æ¿€æ´»çš„é…ç½®æ–‡ä»¶é›†</span></span><br><span class="line">    String[] getDefaultProfiles();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">acceptsProfiles</span><span class="params">(String... profiles)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Environment ä½“ç³»ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15403714670613_02ZL9z_ul8OAy.jpg" alt="img"></p><ul><li>PropertyResolverï¼šæä¾›å±æ€§è®¿é—®åŠŸèƒ½</li><li>Environmentï¼šæä¾›è®¿é—®å’Œåˆ¤æ–­ profiles çš„åŠŸèƒ½</li><li>ConfigurableEnvironmentï¼šæä¾›è®¾ç½®æ¿€æ´»çš„ profile å’Œé»˜è®¤çš„ profile çš„åŠŸèƒ½ä»¥åŠæ“ä½œ Properties çš„å·¥å…·</li><li>ConfigurableWebEnvironmentï¼šæä¾›é…ç½® Servlet ä¸Šä¸‹æ–‡å’Œ Servlet å‚æ•°çš„åŠŸèƒ½</li><li>AbstractEnvironmentï¼šå®ç°äº† ConfigurableEnvironment æ¥å£ï¼Œé»˜è®¤å±æ€§å’Œå­˜å‚¨å®¹å™¨çš„å®šä¹‰ï¼Œå¹¶ä¸”å®ç°äº† ConfigurableEnvironment çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºå­ç±»é¢„ç•™å¯è¦†ç›–äº†æ‰©å±•æ–¹æ³•</li><li>StandardEnvironmentï¼šç»§æ‰¿è‡ª AbstractEnvironment ï¼Œé Servlet(Web) ç¯å¢ƒä¸‹çš„æ ‡å‡† Environment å®ç°</li><li>StandardServletEnvironmentï¼šç»§æ‰¿è‡ª StandardEnvironment ï¼ŒServlet(Web) ç¯å¢ƒä¸‹çš„æ ‡å‡† Environment å®ç°</li></ul><h3 id="ConfigurableEnvironment"><a href="#ConfigurableEnvironment" class="headerlink" title="ConfigurableEnvironment"></a>ConfigurableEnvironment</h3><blockquote><p>æä¾›è®¾ç½®æ¿€æ´»çš„ profile å’Œé»˜è®¤çš„ profile çš„åŠŸèƒ½ä»¥åŠæ“ä½œ Properties çš„å·¥å…·</p></blockquote><p>è¯¥ç±»é™¤äº†ç»§æ‰¿ Environment æ¥å£å¤–è¿˜ç»§æ‰¿äº† ConfigurablePropertyResolver æ¥å£ï¼Œæ‰€ä»¥å®ƒå³å…·å¤‡äº†è®¾ç½® profile çš„åŠŸèƒ½ä¹Ÿå…·å¤‡äº†æ“ä½œ Properties çš„åŠŸèƒ½ã€‚åŒæ—¶è¿˜å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¾ç½®å’ŒéªŒè¯æ‰€éœ€è¦çš„å±æ€§ï¼Œè‡ªå®šä¹‰è½¬æ¢æœåŠ¡ç­‰åŠŸèƒ½ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableEnvironment</span> <span class="keyword">extends</span> <span class="title">Environment</span>, <span class="title">ConfigurablePropertyResolver</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŒ‡å®šè¯¥ç¯å¢ƒä¸‹çš„ profile é›†</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setActiveProfiles</span><span class="params">(String... profiles)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ æ­¤ç¯å¢ƒçš„ profile</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addActiveProfile</span><span class="params">(String profile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤çš„ profile</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDefaultProfiles</span><span class="params">(String... profiles)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ­¤ç¯å¢ƒçš„ PropertySources</span></span><br><span class="line">    <span class="function">MutablePropertySources <span class="title">getPropertySources</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å°è¯•è¿”å› System.getenv() çš„å€¼ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›é€šè¿‡ System.getenv(string) çš„æ¥è®¿é—®å„ä¸ªé”®çš„æ˜ å°„</span></span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getSystemEnvironment</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è¿”å› System.getProperties() çš„å€¼ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›é€šè¿‡ System.getProperties(string) çš„æ¥è®¿é—®å„ä¸ªé”®çš„æ˜ å°„</span></span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getSystemProperties</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(ConfigurableEnvironment parent)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AbstractEnvironment"><a href="#AbstractEnvironment" class="headerlink" title="AbstractEnvironment"></a>AbstractEnvironment</h3><blockquote><p>Environment çš„åŸºç¡€å®ç°</p></blockquote><p>å…è®¸é€šè¿‡è®¾ç½® ACTIVE_PROFILES_PROPERTY_NAME å’ŒDEFAULT_PROFILES_PROPERTY_NAME å±æ€§æŒ‡å®šæ´»åŠ¨å’Œé»˜è®¤é…ç½®æ–‡ä»¶ã€‚å­ç±»çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬é»˜è®¤æ·»åŠ çš„ PropertySource å¯¹è±¡ã€‚è€Œ AbstractEnvironment åˆ™æ²¡æœ‰æ·»åŠ ä»»ä½•å†…å®¹ã€‚å­ç±»åº”è¯¥é€šè¿‡å—ä¿æŠ¤çš„ <code>customizePropertySources(MutablePropertySources)</code> é’©å­æä¾›å±æ€§æºï¼Œè€Œå®¢æˆ·ç«¯åº”è¯¥ä½¿ç”¨<code>ConfigurableEnvironment.getPropertySources()</code>è¿›è¡Œè‡ªå®šä¹‰å¹¶å¯¹MutablePropertySources APIè¿›è¡Œæ“ä½œã€‚</p><p>åœ¨ AbstractEnvironment æœ‰ä¸¤å¯¹å˜é‡ï¼Œè¿™ä¸¤å¯¹å˜é‡ç»´æŠ¤ç€æ¿€æ´»å’Œé»˜è®¤é…ç½® profileã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTIVE_PROFILES_PROPERTY_NAME = <span class="string">&quot;spring.profiles.active&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; activeProfiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROFILES_PROPERTY_NAME = <span class="string">&quot;spring.profiles.default&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; defaultProfiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(getReservedDefaultProfiles());</span><br></pre></td></tr></table></figure><p>ç”±äºå®ç°æ–¹æ³•è¾ƒå¤šï¼Œè¿™é‡Œåªå…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼š<code>setActiveProfiles()</code> å’Œ <code>getActiveProfiles()</code>ã€‚</p><p><strong>setActiveProfiles()</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setActiveProfiles</span><span class="params">(String... profiles)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(profiles, <span class="string">&quot;Profile array must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Activating profiles &quot;</span> + Arrays.asList(profiles));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.activeProfiles) &#123;</span><br><span class="line">    <span class="keyword">this</span>.activeProfiles.clear();</span><br><span class="line">    <span class="keyword">for</span> (String profile : profiles) &#123;</span><br><span class="line">      validateProfile(profile);</span><br><span class="line">      <span class="keyword">this</span>.activeProfiles.add(profile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å…¶å®å°±æ˜¯æ“ä½œ activeProfiles é›†åˆï¼Œåœ¨æ¯æ¬¡è®¾ç½®ä¹‹å‰éƒ½ä¼šå°†è¯¥é›†åˆæ¸…ç©ºé‡æ–°æ·»åŠ ï¼Œæ·»åŠ ä¹‹å‰è°ƒç”¨ <code>validateProfile()</code> å¯¹æ·»åŠ çš„ profile è¿›è¡Œæ ¡éªŒï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateProfile</span><span class="params">(String profile)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.hasText(profile)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid profile [&quot;</span> + profile + <span class="string">&quot;]: must contain text&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (profile.charAt(<span class="number">0</span>) == <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid profile [&quot;</span> + profile + <span class="string">&quot;]: must not begin with ! operator&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ ¡éªŒè¿‡ç¨‹æ¯”è¾ƒå¼±ï¼Œå­ç±»å¯ä»¥æä¾›æ›´åŠ ä¸¥æ ¼çš„æ ¡éªŒè§„åˆ™ã€‚</p><p><strong>getActiveProfiles()</strong></p><p>ä» <code>getActiveProfiles()</code> ä¸­æˆ‘ä»¬å¯ä»¥çŒœå‡ºè¿™ä¸ªæ–¹æ³•å®ç°çš„é€»è¾‘ï¼šè·å– activeProfiles é›†åˆå³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] getActiveProfiles() &#123;</span><br><span class="line">  <span class="keyword">return</span> StringUtils.toStringArray(doGetActiveProfiles());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å§”æ‰˜ç»™ <code>doGetActiveProfiles()</code> å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Set&lt;String&gt; <span class="title">doGetActiveProfiles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.activeProfiles) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.activeProfiles.isEmpty()) &#123;</span><br><span class="line">      String profiles = getProperty(ACTIVE_PROFILES_PROPERTY_NAME);</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(profiles)) &#123;</span><br><span class="line">        setActiveProfiles(StringUtils.commaDelimitedListToStringArray(</span><br><span class="line">          StringUtils.trimAllWhitespace(profiles)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.activeProfiles;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ activeProfiles ä¸ºç©ºï¼Œåˆ™ä» Properties ä¸­è·å– spring.profiles.active é…ç½®ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>setActiveProfiles()</code> è®¾ç½® profileï¼Œæœ€åè¿”å›ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹BeanDefinitionæ³¨å†Œæœºï¼šBeanDefinitionRegistry</title>
      <link href="/blog/2020/01/25/86c712d3.html"/>
      <url>/blog/2020/01/25/86c712d3.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4026">http://cmsblogs.com/?p=4026</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>å°†å®šä¹‰ bean çš„èµ„æºæ–‡ä»¶è§£ææˆ BeanDefinition åéœ€è¦å°†å…¶æ³¨å…¥å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± BeanDefinitionRegistry æ¥å®Œæˆã€‚</p><p><strong>BeanDefinitionRegistryï¼šå‘æ³¨å†Œè¡¨ä¸­æ³¨å†Œ BeanDefinition å®ä¾‹ï¼Œå®Œæˆæ³¨å†Œçš„è¿‡ç¨‹ã€‚</strong></p><p>ä¸‹å›¾æ˜¯ BeanDefinitionRegistry ç±»ç»“æ„å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15397559425630_7v1hdo_IqTnko.jpg" alt="img"></p><p>BeanDefinitionRegistry ç»§æ‰¿äº† AliasRegistry æ¥å£ï¼Œå…¶æ ¸å¿ƒå­ç±»æœ‰ä¸‰ä¸ªï¼š<code>SimpleBeanDefinitionRegistry</code>ã€<code>DefaultListableBeanFactory</code>ã€<code>GenericApplicationContext</code>ã€‚</p><h2 id="AliasRegistry"><a href="#AliasRegistry" class="headerlink" title="AliasRegistry"></a>AliasRegistry</h2><p><strong>ç”¨äºåˆ«åç®¡ç†çš„é€šç”¨å‹æ¥å£ï¼Œä½œä¸º BeanDefinitionRegistry çš„é¡¶å±‚æ¥å£ã€‚</strong> AliasRegistry å®šä¹‰äº†ä¸€äº›åˆ«åç®¡ç†çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AliasRegistry</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String name, String alias)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">removeAlias</span><span class="params">(String alias)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isAlias</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"> String[] getAliases(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BeanDefinitionRegistry"><a href="#BeanDefinitionRegistry" class="headerlink" title="BeanDefinitionRegistry"></a>BeanDefinitionRegistry</h2><p><strong>BeanDefinition çš„æ³¨å†Œæ¥å£ï¼Œå¦‚ RootBeanDefinition å’Œ ChildBeanDefinitionã€‚å®ƒé€šå¸¸ç”± BeanFactories å®ç°ï¼Œåœ¨ Spring ä¸­å·²çŸ¥çš„å®ç°è€…ä¸ºï¼šDefaultListableBeanFactory å’Œ GenericApplicationContextã€‚BeanDefinitionRegistry æ˜¯ Spring çš„ Bean å·¥å‚åŒ…ä¸­å”¯ä¸€å°è£… BeanDefinition æ³¨å†Œçš„æ¥å£ã€‚</strong></p><p>BeanDefinitionRegistry æ¥å£å®šä¹‰äº†å…³äº BeanDefinition æ³¨å†Œã€æ³¨é”€ã€æŸ¥è¯¢ç­‰ä¸€ç³»åˆ—çš„æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾€æ³¨å†Œè¡¨ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ BeanDefinition å®ä¾‹</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤æ³¨å†Œè¡¨ä¸­å·²æ³¨å†Œçš„ BeanDefinition å®ä¾‹</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">removeBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æ³¨å†Œä¸­å–å¾—æŒ‡å®šçš„ BeanDefinition å®ä¾‹</span></span><br><span class="line"> <span class="function">BeanDefinition <span class="title">getBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ BeanDefinition å®ä¾‹æ˜¯å¦åœ¨æ³¨å†Œè¡¨ä¸­ï¼ˆæ˜¯å¦æ³¨å†Œï¼‰</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(String beanName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–å¾—æ³¨å†Œè¡¨ä¸­æ‰€æœ‰ BeanDefinition å®ä¾‹çš„ beanNameï¼ˆæ ‡è¯†ï¼‰</span></span><br><span class="line"> String[] getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ³¨å†Œè¡¨ä¸­ BeanDefinition å®ä¾‹çš„æ•°é‡</span></span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">getBeanDefinitionCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// beanNameï¼ˆæ ‡è¯†ï¼‰æ˜¯å¦è¢«å ç”¨</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isBeanNameInUse</span><span class="params">(String beanName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SimpleBeanDefinitionRegistry"><a href="#SimpleBeanDefinitionRegistry" class="headerlink" title="SimpleBeanDefinitionRegistry"></a>SimpleBeanDefinitionRegistry</h2><p><strong>SimpleBeanDefinitionRegistry æ˜¯ BeanDefinitionRegistry ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œå®ƒè¿˜ç»§æ‰¿ SimpleAliasRegistryï¼ˆ AliasRegistry çš„ç®€å•å®ç°ï¼‰ï¼Œå®ƒä»…ä»…åªæä¾›æ³¨å†Œè¡¨åŠŸèƒ½ï¼Œæ— å·¥å‚åŠŸèƒ½</strong>ã€‚</p><p>SimpleBeanDefinitionRegistry ä½¿ç”¨ ConcurrentHashMap æ¥å­˜å‚¨æ³¨å†Œçš„ BeanDefinitionã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br></pre></td></tr></table></figure><p>ä»–å¯¹æ³¨å†Œå…¶ä¸­çš„ BeanDefinition éƒ½æ˜¯åŸºäº beanDefinitionMap è¿™ä¸ªé›†åˆæ¥å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line"> Assert.hasText(beanName, <span class="string">&quot;&#x27;beanName&#x27; must not be empty&quot;</span>);</span><br><span class="line"> Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"> <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.beanDefinitionMap.remove(beanName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(beanName);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">getBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line"> BeanDefinition bd = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line"> <span class="keyword">if</span> (bd == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(beanName);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ç®€å•ã€ç²—æš´ã€‚</p><h2 id="DefaultListableBeanFactory"><a href="#DefaultListableBeanFactory" class="headerlink" title="DefaultListableBeanFactory"></a>DefaultListableBeanFactory</h2><p><strong>DefaultListableBeanFactoryï¼ŒConfigurableListableBeanFactoryï¼ˆå…¶å®å°±æ˜¯ BeanFactory ï¼‰ å’Œ BeanDefinitionRegistry æ¥å£çš„é»˜è®¤å®ç°ï¼šä¸€ä¸ªåŸºäº BeanDefinition å…ƒæ•°æ®çš„å®Œæ•´ bean å·¥å‚</strong>ã€‚</p><p>æ‰€ä»¥ç›¸å¯¹äº SimpleBeanDefinitionRegistry è€Œè¨€ï¼ŒDefaultListableBeanFactory åˆ™æ˜¯ä¸€ä¸ªå…·æœ‰æ³¨å†ŒåŠŸèƒ½çš„å®Œæ•´ bean å·¥å‚ã€‚å®ƒåŒæ ·æ˜¯ç”¨ ConcurrentHashMap æ•°æ®ç»“æ„æ¥å­˜å‚¨æ³¨å†Œçš„ BeanDefinitionã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œè¡¨ï¼Œç”± BeanDefinition çš„æ ‡è¯† ï¼ˆbeanNameï¼‰ ä¸å…¶å®ä¾‹ç»„æˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, bean&gt;(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è¯†ï¼ˆbeanNameï¼‰é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; beanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">64</span>);</span><br></pre></td></tr></table></figure><p>åœ¨çœ‹ <code>registerBeanDefinition()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">      <span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">        List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">        updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">        updatedDefinitions.add(beanName);</span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">          Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.manualSingletonNames);</span><br><span class="line">          updatedSingletons.remove(beanName);</span><br><span class="line">          <span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ³¨å†Œ BeanDefinition</span></span><br><span class="line">      <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">      <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">      <span class="keyword">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">    resetBeanDefinition(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¸Šé¢ä¸€å †ä»£ç æœ€é‡è¦å°±åªæœ‰ä¸€å¥ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br></pre></td></tr></table></figure><p><code>removeBeanDefinition()</code> å…¶å®ä¹Ÿæ˜¯è°ƒç”¨ <code>beanDefinitionMap.remove(beanName)</code>ã€‚</p><p>å¯¹äºç±» GenericApplicationContext ï¼ŒæŸ¥çœ‹æºç ä½ ä¼šå‘ç°ä»–å®ç°æ³¨å†Œã€æ³¨é”€åŠŸèƒ½éƒ½æ˜¯å§”æ‰˜ DefaultListableBeanFactory å®ç°çš„ã€‚</p><blockquote><p>æ‰€ä»¥ BeanDefinition æ³¨å†Œå¹¶ä¸æ˜¯éå¸¸é«˜å¤§ä¸Šçš„åŠŸèƒ½ï¼Œå†…éƒ¨å°±æ˜¯ç”¨ä¸€ä¸ª Map å®ç° ï¼Œå¹¶ä¸æ˜¯å¤šä¹ˆé«˜å¤§ä¸Šçš„éªšæ“ä½œï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæ½œæ„è¯†åœ°è®¤ä¸ºæŸäº›æŠ€æœ¯å¾ˆé«˜å¤§ä¸Šå°±è§‰å¾—ä»–å¾ˆæ·±å¥¥ï¼Œå¦‚æœè¯•ç€å»ä¸€æ¢ç©¶ç«Ÿä½ ä¼šå‘ç°ï¼ŒåŸæ¥è¿™ä¹ˆç®€å•ã€‚è™½ç„¶ BeanDefinitionRegistry å®ç°ç®€å•ï¼Œä½†æ˜¯å®ƒä½œä¸º Spring IOC å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œå…¶åœ°ä½è¿˜æ˜¯å¾ˆé‡çš„ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy</title>
      <link href="/blog/2020/01/24/25302edf.html"/>
      <url>/blog/2020/01/24/25302edf.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4022">http://cmsblogs.com/?p=4022</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨å¼€å§‹åˆ†æ InstantiationStrategy ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•å›é¡¾ä¸‹ bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼š</p><ol><li>bean çš„åˆ›å»ºï¼Œä¸»è¦æ˜¯ <code>AbstractAutowireCapableBeanFactory.doCreateBean()</code> ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ bean çš„å®ä¾‹åŒ–ã€å±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯¹äº bean çš„å®ä¾‹åŒ–è¿‡ç¨‹è¿™æ˜¯æ ¹æ® bean çš„ç±»å‹æ¥åˆ¤æ–­çš„ï¼Œå¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™ç›´æ¥ä» factoryBeanInstanceCache ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è°ƒç”¨ <code>createBeanInstance()</code> åˆ›å»ºã€‚</li><li>åœ¨ <code>createBeanInstance()</code> ä¸­ï¼Œå¦‚æœ Supplier ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> å®ä¾‹åŒ– beanã€‚å¦‚æœ factory ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>instantiateUsingFactoryMethod()</code> å®ä¾‹åŒ– bean ï¼Œå¦‚æœéƒ½ä¸æ˜¯åˆ™è°ƒç”¨ <code>instantiateBean()</code> å®ä¾‹åŒ–bean ã€‚ä½†æ˜¯æ— è®ºæ˜¯ <code>instantiateUsingFactoryMethod()</code> è¿˜æ˜¯ <code>instantiateBean()</code> æœ€åéƒ½ä¸€å®šä¼šè°ƒç”¨åˆ° InstantiationStrategy æ¥å£çš„ <code>instantiate()</code>ã€‚</li></ol><h2 id="InstantiationStrategy"><a href="#InstantiationStrategy" class="headerlink" title="InstantiationStrategy"></a>InstantiationStrategy</h2><p>InstantiationStrategy æ¥å£å®šä¹‰äº† Spring Bean å®ä¾‹åŒ–çš„ç­–ç•¥ï¼Œæ ¹æ®åˆ›å»ºå¯¹è±¡æƒ…å†µçš„ä¸åŒï¼Œæä¾›äº†ä¸‰ç§ç­–ç•¥ï¼š<strong>æ— å‚æ„é€ æ–¹æ³•</strong>ã€<strong>æœ‰å‚æ„é€ æ–¹æ³•</strong>ã€<strong>å·¥å‚æ–¹æ³•</strong>ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstantiationStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŒ‡å®šæ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">   Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="meta">@Nullable</span> Object factoryBean, Method factoryMethod, <span class="meta">@Nullable</span> Object... args)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SimpleInstantiationStrategy"><a href="#SimpleInstantiationStrategy" class="headerlink" title="SimpleInstantiationStrategy"></a>SimpleInstantiationStrategy</h3><p><code>InstantiationStrategy</code> æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š<code>SimpleInstantiationStrategy</code> å’Œ <code>CglibSubclassingInstantiationStrategy</code>ã€‚</p><p><code>SimpleInstantiationStrategy</code> å¯¹ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•éƒ½åšäº†ç®€å•çš„å®ç°ã€‚</p><p>å¦‚æœæ˜¯å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™ç›´æ¥ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@Nullable</span> Object factoryBean, <span class="keyword">final</span> Method factoryMethod, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      currentlyInvokedFactoryMethod.set(factoryMethod);</span><br><span class="line">      Object result = factoryMethod.invoke(factoryBean, args);</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> NullBean();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (priorInvokedFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.remove();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœç•¥ catch</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æ„é€ æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ MethodOverridesï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¯ç›´æ¥ä½¿ç”¨åå°„ï¼Œå¦‚æœæœ‰åˆ™å°±éœ€è¦ CGLIB å®ä¾‹åŒ–å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Don&#x27;t override the class with CGLIB if no overrides.</span></span><br><span class="line">  <span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">    Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">    <span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</span><br><span class="line">      constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">      <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">        <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;Specified class is an interface&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            constructorToUse = AccessController.doPrivileged(</span><br><span class="line">              (PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            constructorToUse =   clazz.getDeclaredConstructor();</span><br><span class="line">          &#125;</span><br><span class="line">          bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;No default constructor found&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Must generate CGLIB subclass.</span></span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// use own privileged to change accessibility (when security is on)</span></span><br><span class="line">      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(ctor);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (args != <span class="keyword">null</span> ? BeanUtils.instantiateClass(ctor, args) : BeanUtils.instantiateClass(ctor));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, ctor, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SimpleInstantiationStrategy å¯¹ <code>instantiateWithMethodInjection()</code> çš„å®ç°ä»»åŠ¡äº¤ç»™äº†å­ç±» CglibSubclassingInstantiationStrategyã€‚</p><h3 id="MethodOverrides"><a href="#MethodOverrides" class="headerlink" title="MethodOverrides"></a>MethodOverrides</h3><p>å¯¹äº MethodOverridesï¼Œåœ¨ BeanDefinitionParserDelegate ç±»è§£æ <code>&lt;bean/&gt;</code> çš„æ—¶å€™æ˜¯å¦è¿˜è®°å¾—è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š<code>parseLookupOverrideSubElements()</code> å’Œ <code>parseReplacedMethodSubElements()</code> è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºè§£æ lookup-method å’Œ replaced-methodã€‚<code>parseLookupOverrideSubElements()</code> æºç å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15395929815414_38Okah_ZrNViV.jpg" alt="img"></p><p>æ›´å¤šå…³äº lookup-method å’Œ replaced-method è¯·çœ‹ï¼š<a href="/2020/01/24/fa973ffe.html">IOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method</a></p><h3 id="CGLIB-å®ä¾‹åŒ–ç­–ç•¥"><a href="#CGLIB-å®ä¾‹åŒ–ç­–ç•¥" class="headerlink" title="CGLIB å®ä¾‹åŒ–ç­–ç•¥"></a>CGLIB å®ä¾‹åŒ–ç­–ç•¥</h3><p>ç±» CglibSubclassingInstantiationStrategy ä¸º Spring å®ä¾‹åŒ– bean çš„é»˜è®¤å®ä¾‹åŒ–ç­–ç•¥ï¼Œå…¶ä¸»è¦åŠŸèƒ½è¿˜æ˜¯å¯¹çˆ¶ç±»åŠŸèƒ½è¿›è¡Œè¡¥å……ï¼šå…¶çˆ¶ç±»å°† CGLIB çš„å®ä¾‹åŒ–ç­–ç•¥å§”æ‰˜å…¶å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SimpleInstantiationStrategy</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Method Injection not supported in SimpleInstantiationStrategy&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CglibSubclassingInstantiationStrategy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CglibSubclassingInstantiationStrategy å®ä¾‹åŒ– bean ç­–ç•¥æ˜¯é€šè¿‡å…¶å†…éƒ¨ç±» CglibSubclassCreator æ¥å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                <span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CglibSubclassCreator(bd, owner).instantiate(ctor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»º CglibSubclassCreator å®ä¾‹ç„¶åè°ƒç”¨å…¶ <code>instantiate()</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºåŠ¨æ€åˆ›å»ºå­ç±»å®ä¾‹ï¼ŒåŒæ—¶å®ç°æ‰€éœ€è¦çš„ lookupsï¼ˆlookup-methodã€replace-methodï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(<span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; subclass = createEnhancedSubclass(<span class="keyword">this</span>.beanDefinition);</span><br><span class="line">  Object instance;</span><br><span class="line">  <span class="keyword">if</span> (ctor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instance = BeanUtils.instantiateClass(subclass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());</span><br><span class="line">      instance = enhancedSubclassConstructor.newInstance(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(<span class="keyword">this</span>.beanDefinition.getBeanClass(),</span><br><span class="line">                                           <span class="string">&quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot;</span> + subclass.getName() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è¿™ä¸ªåœ°æ–¹è§£å†³ä¸€ä¸ªbugï¼Œbugæäº¤æŠ¥å‘Šhttps://jira.spring.io/browse/SPR-10785</span></span><br><span class="line">  <span class="comment">// SPR-10785: set callbacks directly on the instance instead of in the</span></span><br><span class="line">  <span class="comment">// enhanced class (via the Enhancer) in order to avoid memory leaks.</span></span><br><span class="line">  Factory factory = (Factory) instance;</span><br><span class="line">  factory.setCallbacks(<span class="keyword">new</span> Callback[] &#123;NoOp.INSTANCE,</span><br><span class="line">                                       <span class="keyword">new</span> LookupOverrideMethodInterceptor(<span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner),</span><br><span class="line">                                       <span class="keyword">new</span> ReplaceOverrideMethodInterceptor(<span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner)&#125;);</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>createEnhancedSubclass()</code> ä¸ºæä¾›çš„ BeanDefinition åˆ›å»º bean ç±»çš„å¢å¼ºå­ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createEnhancedSubclass(RootBeanDefinition beanDefinition) &#123;</span><br><span class="line"> <span class="comment">// cglibé‡Œé¢çš„ç”¨æ³•ï¼Œå¯¹åŸå§‹classè¿›è¡Œå¢å¼ºï¼Œå¹¶è®¾ç½®callback</span></span><br><span class="line"> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"> enhancer.setSuperclass(beanDefinition.getBeanClass());</span><br><span class="line"> enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.owner <span class="keyword">instanceof</span> ConfigurableBeanFactory) &#123;</span><br><span class="line">  ClassLoader cl = ((ConfigurableBeanFactory) <span class="keyword">this</span>.owner).getBeanClassLoader();</span><br><span class="line">  enhancer.setStrategy(<span class="keyword">new</span> ClassLoaderAwareGeneratorStrategy(cl));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// è¿‡æ»¤ï¼Œè‡ªå®šä¹‰é€»è¾‘æ¥æŒ‡å®šè°ƒç”¨çš„callbackä¸‹æ ‡</span></span><br><span class="line"> enhancer.setCallbackFilter(<span class="keyword">new</span> MethodOverrideCallbackFilter(beanDefinition));</span><br><span class="line"> enhancer.setCallbackTypes(CALLBACK_TYPES);</span><br><span class="line"> <span class="keyword">return</span> enhancer.createClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å­ç±»å¢å¼º class åï¼Œå¦‚æœ Constructor å®ä¾‹ ctr ä¸ºç©ºï¼Œåˆ™è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼ˆ<code>BeanUtils.instantiateClass()</code>ï¼‰æ¥å®ä¾‹åŒ–ç±»ï¼Œå¦åˆ™åˆ™æ ¹æ®æ„é€ å‡½æ•°ç±»å‹è·å–å…·ä½“çš„æ„é€ å™¨ï¼Œè°ƒç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ç±»ã€‚åœ¨ <code>createEnhancedSubclass()</code> æˆ‘ä»¬æ³¨æ„ä¸¤è¡Œä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">enhancer.setCallbackFilter(<span class="keyword">new</span> MethodOverrideCallbackFilter(beanDefinition));</span><br><span class="line">enhancer.setCallbackTypes(CALLBACK_TYPES);</span><br></pre></td></tr></table></figure><p>é€šè¿‡ MethodOverrideCallbackFilter æ¥å®šä¹‰è°ƒç”¨ callback ç±»å‹ï¼ŒMethodOverrideCallbackFilter æ˜¯ç”¨æ¥å®šä¹‰ CGLIB å›è°ƒè¿‡æ»¤æ–¹æ³•çš„æ‹¦æˆªå™¨è¡Œä¸ºï¼Œå®ƒç»§æ‰¿ CglibIdentitySupport å®ç° CallbackFilter æ¥å£ï¼Œ CallbackFilter æ˜¯ CGLIB çš„ä¸€ä¸ªå›è°ƒè¿‡æ»¤å™¨ï¼ŒCglibIdentitySupport åˆ™ä¸º CGLIB æä¾› <code>hashCode()</code> å’Œ <code>equals()</code> æ–¹æ³•ï¼Œä»¥ç¡®ä¿ CGLIB ä¸ä¼šä¸ºæ¯ä¸ª bean ç”Ÿæˆä¸åŒçš„ç±»ã€‚MethodOverrideCallbackFilter å®ç° CallbackFilter <code>accept()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">  MethodOverride methodOverride = getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Override for &#x27;&quot;</span> + method.getName() + <span class="string">&quot;&#x27; is [&quot;</span> + methodOverride + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (methodOverride == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> PASSTHROUGH;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (methodOverride <span class="keyword">instanceof</span> LookupOverride) &#123;</span><br><span class="line">    <span class="keyword">return</span> LOOKUP_OVERRIDE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (methodOverride <span class="keyword">instanceof</span> ReplaceOverride) &#123;</span><br><span class="line">    <span class="keyword">return</span> METHOD_REPLACER;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Unexpected MethodOverride subclass: &quot;</span> +</span><br><span class="line">                                          methodOverride.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ® BeanDefinition ä¸­å®šä¹‰çš„ MethodOverride ä¸åŒï¼Œè¿”å›ä¸åŒçš„å€¼ï¼Œ è¿™é‡Œè¿”å›çš„ PASSTHROUGH ã€LOOKUP_OVERRIDEã€METHOD_REPLACER éƒ½æ˜¯ Callbak æ•°ç»„çš„ä¸‹æ ‡ï¼Œè¿™é‡Œå¯¹åº”çš„æ•°ç»„ä¸º CALLBACK_TYPES æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] CALLBACK_TYPES </span><br><span class="line">  = <span class="keyword">new</span> Class&lt;?&gt;[] &#123;NoOp.class, LookupOverrideMethodInterceptor.class, ReplaceOverrideMethodInterceptor.class&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆå®šä¹‰äº†ä¸¤ä¸ªç†Ÿæ‚‰çš„æ‹¦æˆªå™¨ ï¼šLookupOverrideMethodInterceptor å’Œ ReplaceOverrideMethodInterceptorï¼Œä¸¤ä¸ªæ‹¦æˆªå™¨åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ callback ä¸šåŠ¡ï¼š</p><p><strong>LookupOverrideMethodInterceptor</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupOverrideMethodInterceptor</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CglibIdentitySupport</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LookupOverrideMethodInterceptor</span><span class="params">(RootBeanDefinition beanDefinition, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(beanDefinition);</span><br><span class="line">    <span class="keyword">this</span>.owner = owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy mp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// Cast is safe, as CallbackFilter filters are used selectively.</span></span><br><span class="line">    LookupOverride lo = (LookupOverride) getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">    Assert.state(lo != <span class="keyword">null</span>, <span class="string">&quot;LookupOverride not found&quot;</span>);</span><br><span class="line">    Object[] argsToUse = (args.length &gt; <span class="number">0</span> ? args : <span class="keyword">null</span>); <span class="comment">// if no-arg, don&#x27;t insist on args at all</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(lo.getBeanName())) &#123;</span><br><span class="line">      <span class="keyword">return</span> (argsToUse != <span class="keyword">null</span> ? <span class="keyword">this</span>.owner.getBean(lo.getBeanName(), argsToUse) :</span><br><span class="line">              <span class="keyword">this</span>.owner.getBean(lo.getBeanName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (argsToUse != <span class="keyword">null</span> ? <span class="keyword">this</span>.owner.getBean(method.getReturnType(), argsToUse) :</span><br><span class="line">              <span class="keyword">this</span>.owner.getBean(method.getReturnType()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ReplaceOverrideMethodInterceptor</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplaceOverrideMethodInterceptor</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CglibIdentitySupport</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReplaceOverrideMethodInterceptor</span><span class="params">(RootBeanDefinition beanDefinition, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(beanDefinition);</span><br><span class="line">    <span class="keyword">this</span>.owner = owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy mp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    ReplaceOverride ro = (ReplaceOverride) getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">    Assert.state(ro != <span class="keyword">null</span>, <span class="string">&quot;ReplaceOverride not found&quot;</span>);</span><br><span class="line">    <span class="comment">// TODO could cache if a singleton for minor performance optimization</span></span><br><span class="line">    MethodReplacer mr = <span class="keyword">this</span>.owner.getBean(ro.getMethodReplacerBeanName(), MethodReplacer.class);</span><br><span class="line">    <span class="keyword">return</span> mr.reimplement(obj, method, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œå†åŠ ä¸Šè¿™ç¯‡åšå®¢ï¼š<a href="/2020/01/fa973ffe.html">IOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method</a>ï¼Œæ˜¯ä¸æ˜¯ä¸€é“ç»ä½³çš„ç¾é£Ÿã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹åˆ†æBeanWrapper</title>
      <link href="/blog/2020/01/24/fcc18cc7.html"/>
      <url>/blog/2020/01/24/fcc18cc7.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=4020">http://cmsblogs.com/?p=4020</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨å®ä¾‹åŒ– bean é˜¶æ®µï¼Œæˆ‘ä»¬ä» BeanDefinition å¾—åˆ°çš„å¹¶ä¸æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ Bean å®ä¾‹ï¼Œè€Œæ˜¯ BeanWrapper å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15393305208552_Zt9ZVl_ocP6l0.jpg" alt="img"></p><p>æ‰€ä»¥è¿™é‡Œ BeanWrapper æ˜¯ä¸€ä¸ªä» BeanDefinition åˆ° Bean ç›´æ¥çš„ä¸­é—´äº§ç‰©ï¼Œæˆ‘ä»¬å¯ä»¥ç§°å®ƒä¸ºâ€ä½çº§ beanâ€œï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨å®é™…é¡¹ç›®ä¸­ç”¨åˆ°å®ƒã€‚</p><p>BeanWrapper æ˜¯ Spring æ¡†æ¶ä¸­é‡è¦çš„ç»„ä»¶ç±»ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªä»£ç†ç±»ï¼ŒSpring å§”æ‰˜ BeanWrapper å®Œæˆ Bean å±æ€§çš„å¡«å……å·¥ä½œã€‚</p><p>åœ¨ bean å®ä¾‹è¢« InstantiatioonStrategy åˆ›å»ºå‡ºæ¥åï¼ŒSpring å®¹å™¨ä¼šå°† Bean å®ä¾‹é€šè¿‡ BeanWrapper åŒ…è£¹èµ·æ¥ï¼Œæ˜¯é€šè¿‡ <code>BeanWrapper.setWrappedInstance()</code> å®Œæˆçš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15393328767959-20200527205704408_oBMSK2.jpg" alt="img"></p><p>beanInstance å°±æ˜¯æˆ‘ä»¬å®ä¾‹å‡ºæ¥çš„ bean å®ä¾‹ï¼Œé€šè¿‡æ„é€ ä¸€ä¸ª BeanWrapper å®ä¾‹å¯¹è±¡è¿›è¡ŒåŒ…è£¹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BeanWrapperImpl</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>(object);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractNestablePropertyAccessor</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"> registerDefaultEditors();</span><br><span class="line"> setWrappedInstance(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°ç¼–å°± BeanWrapper æ¥è¿›è¡Œåˆ†æè¯´æ˜ï¼Œå…ˆçœ‹æ•´ä½“çš„ç»“æ„ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/2018101210001-20200527205754152_znKAqi.png" alt="2018101210001"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º BeanWrapper ä¸»è¦ç»§æ‰¿ä¸‰ä¸ªæ ¸å¿ƒæ¥å£ï¼šPropertyAccessorã€PropertyEditorRegistryã€TypeConverterã€‚</p><p><strong>PropertyAccessor</strong></p><blockquote><p>å¯ä»¥è®¿é—®å±æ€§çš„é€šç”¨å‹æ¥å£ï¼ˆä¾‹å¦‚å¯¹è±¡çš„ bean å±æ€§æˆ–è€…å¯¹è±¡ä¸­çš„å­—æ®µï¼‰ï¼Œä½œä¸º BeanWrapper çš„åŸºç¡€æ¥å£ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertyAccessor</span> </span>&#123;</span><br><span class="line"> String NESTED_PROPERTY_SEPARATOR = <span class="string">&quot;.&quot;</span>;</span><br><span class="line"> <span class="keyword">char</span> NESTED_PROPERTY_SEPARATOR_CHAR = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> String PROPERTY_KEY_PREFIX = <span class="string">&quot;[&quot;</span>;</span><br><span class="line"> <span class="keyword">char</span> PROPERTY_KEY_PREFIX_CHAR = <span class="string">&#x27;[&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> String PROPERTY_KEY_SUFFIX = <span class="string">&quot;]&quot;</span>;</span><br><span class="line"> <span class="keyword">char</span> PROPERTY_KEY_SUFFIX_CHAR = <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isReadableProperty</span><span class="params">(String propertyName)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isWritableProperty</span><span class="params">(String propertyName)</span></span>;</span><br><span class="line"></span><br><span class="line"> Class&lt;?&gt; getPropertyType(String propertyName) <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line"> <span class="function">TypeDescriptor <span class="title">getPropertyTypeDescriptor</span><span class="params">(String propertyName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function">Object <span class="title">getPropertyValue</span><span class="params">(String propertyName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(String propertyName, <span class="meta">@Nullable</span> Object value)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(PropertyValue pv)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(Map&lt;?, ?&gt; map)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs, <span class="keyword">boolean</span> ignoreUnknown)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs, <span class="keyword">boolean</span> ignoreUnknown, <span class="keyword">boolean</span> ignoreInvalid)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±ä¸Šé¢çš„æºç æˆ‘ä»¬å¯ä»¥åˆ†è§£ä¸ºå››ç±»æ–¹æ³•ï¼š</p><ul><li><code>isReadableProperty()</code>ï¼šåˆ¤æ–­æŒ‡å®š property æ˜¯å¦å¯è¯»ï¼Œæ˜¯å¦åŒ…å« getter æ–¹æ³•</li><li><code>isWritableProperty()</code>ï¼šåˆ¤æ–­æŒ‡å®š property æ˜¯å¦å¯å†™,æ˜¯å¦åŒ…å« setter æ–¹æ³•</li><li><code>getPropertyType()</code>ï¼šè·å–æŒ‡å®š propertyName çš„ç±»å‹</li><li><code>setPropertyValue()</code>ï¼šè®¾ç½®æŒ‡å®š propertyValue</li></ul><p><strong>PropertyEditorRegistry</strong></p><blockquote><p>ç”¨äºæ³¨å†Œ JavaBean çš„ PropertyEditorsï¼Œå¯¹ PropertyEditorRegistrar èµ·æ ¸å¿ƒä½œç”¨çš„ä¸­å¿ƒæ¥å£ã€‚ç”± BeanWrapper æ‰©å±•ï¼ŒBeanWrapperImpl å’Œ DataBinder å®ç°ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertyEditorRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerCustomEditor</span><span class="params">(Class&lt;?&gt; requiredType, PropertyEditor propertyEditor)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">registerCustomEditor</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;?&gt; requiredType, <span class="meta">@Nullable</span> String propertyPath, PropertyEditor propertyEditor)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function">PropertyEditor <span class="title">findCustomEditor</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;?&gt; requiredType, <span class="meta">@Nullable</span> String propertyPath)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ¥å£æä¾›çš„æ–¹æ³•ï¼ŒPropertyEditorRegistry å°±æ˜¯ç”¨äº PropertyEditor çš„æ³¨å†Œå’Œå‘ç°ï¼Œè€Œ PropertyEditor æ˜¯ Java å†…çœé‡Œé¢çš„æ¥å£ï¼Œç”¨äºæ”¹å˜æŒ‡å®š property å±æ€§çš„ç±»å‹ã€‚</p><p><strong>TypeConverter</strong></p><blockquote><p>å®šä¹‰ç±»å‹è½¬æ¢çš„æ¥å£ï¼Œé€šå¸¸ä¸ PropertyEditorRegistry æ¥å£ä¸€èµ·å®ç°ï¼ˆä½†ä¸æ˜¯å¿…é¡»ï¼‰ï¼Œä½†ç”±äº TypeConverter æ˜¯åŸºäºçº¿ç¨‹ä¸å®‰å…¨çš„ PropertyEditors ï¼Œå› æ­¤ TypeConverters æœ¬èº«ä¹Ÿä¸è¢«è§†ä¸ºçº¿ç¨‹å®‰å…¨ã€‚ è¿™é‡Œå°ç¼–è§£é‡Šä¸‹ï¼Œåœ¨ Spring 3 åï¼Œä¸åœ¨é‡‡ç”¨ PropertyEditors ç±»ä½œä¸º Spring é»˜è®¤çš„ç±»å‹è½¬æ¢æ¥å£ï¼Œè€Œæ˜¯é‡‡ç”¨ ConversionService ä½“ç³»ï¼Œä½† ConversionService æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åœ¨ Spring 3 åï¼Œå¦‚æœä½ æ‰€é€‰æ‹©çš„ç±»å‹è½¬æ¢å™¨æ˜¯ ConversionService è€Œä¸æ˜¯ PropertyEditors é‚£ä¹ˆ TypeConverters åˆ™æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(Object value, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> TypeMismatchException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(Object value, Class&lt;T&gt; requiredType, MethodParameter methodParam)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> TypeMismatchException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(Object value, Class&lt;T&gt; requiredType, Field field)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> TypeMismatchException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanWrapper ç»§æ‰¿ä¸Šè¿°ä¸‰ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå®ƒå°±å…·æœ‰ä¸‰é‡èº«ä»½ï¼š</p><ul><li>å±æ€§ç¼–è¾‘å™¨</li><li>å±æ€§ç¼–è¾‘å™¨æ³¨å†Œè¡¨</li><li>ç±»å‹è½¬æ¢å™¨</li></ul><p>BeanWrapper ç»§æ‰¿ ConfigurablePropertyAccessor æ¥å£ï¼Œè¯¥æ¥å£é™¤äº†ç»§æ‰¿ä¸Šé¢ä»‹ç»çš„ä¸‰ä¸ªæ¥å£å¤–è¿˜é›†æˆäº† Spring çš„ ConversionService ç±»å‹è½¬æ¢ä½“ç³»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurablePropertyAccessor</span> <span class="keyword">extends</span> <span class="title">PropertyAccessor</span>, <span class="title">PropertyEditorRegistry</span>, <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setConversionService</span><span class="params">(<span class="meta">@Nullable</span> ConversionService conversionService)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function">ConversionService <span class="title">getConversionService</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setExtractOldValueForEditor</span><span class="params">(<span class="keyword">boolean</span> extractOldValueForEditor)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isExtractOldValueForEditor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setAutoGrowNestedPaths</span><span class="params">(<span class="keyword">boolean</span> autoGrowNestedPaths)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isAutoGrowNestedPaths</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setConversionService()</code> å’Œ <code>getConversionService()</code> åˆ™æ˜¯ç”¨äºé›†æˆ Spring çš„ ConversionService ç±»å‹è½¬æ¢ä½“ç³»ã€‚</p><p><strong>BeanWrapper</strong></p><blockquote><p>Spring çš„ ä½çº§ JavaBean åŸºç¡€ç»“æ„çš„æ¥å£ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ BeanFactory æˆ–è€… DataBinder éšå¼ä½¿ç”¨ã€‚å®ƒæä¾›åˆ†æå’Œæ“ä½œæ ‡å‡† JavaBeans çš„æ“ä½œï¼šè·å–å’Œè®¾ç½®å±æ€§å€¼ã€è·å–å±æ€§æè¿°ç¬¦ä»¥åŠæŸ¥è¯¢å±æ€§çš„å¯è¯»æ€§/å¯å†™æ€§çš„èƒ½åŠ›ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanWrapper</span> <span class="keyword">extends</span> <span class="title">ConfigurablePropertyAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setAutoGrowCollectionLimit</span><span class="params">(<span class="keyword">int</span> autoGrowCollectionLimit)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">getAutoGrowCollectionLimit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="function">Object <span class="title">getWrappedInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> Class&lt;?&gt; getWrappedClass();</span><br><span class="line"></span><br><span class="line"> PropertyDescriptor[] getPropertyDescriptors();</span><br><span class="line"></span><br><span class="line"> <span class="function">PropertyDescriptor <span class="title">getPropertyDescriptor</span><span class="params">(String propertyName)</span> <span class="keyword">throws</span> InvalidPropertyException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ¯”è¾ƒé‡è¦ï¼š</p><p>ä¸ªå¯¹è±¡æœ‰4ä¸ªæ–¹æ³•æ¯”è¾ƒé‡è¦:</p><ul><li><code>getWrappedInstance()</code>ï¼šè·å–åŒ…è£…å¯¹è±¡çš„å®ä¾‹ã€‚</li><li><code>getWrappedClass()</code>ï¼šè·å–åŒ…è£…å¯¹è±¡çš„ç±»å‹ã€‚</li><li><code>getPropertyDescriptors()</code>ï¼šè·å–åŒ…è£…å¯¹è±¡æ‰€æœ‰å±æ€§çš„ PropertyDescriptor å°±æ˜¯è¿™ä¸ªå±æ€§çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>getPropertyDescriptor()</code>ï¼šè·å–åŒ…è£…å¯¹è±¡æŒ‡å®šå±æ€§çš„ä¸Šä¸‹æ–‡ã€‚</li></ul><p><strong>BeanWrapperImpl</strong></p><blockquote><p>BeanWrapper æ¥å£çš„é»˜è®¤å®ç°ï¼Œç”¨äºå¯¹Beançš„åŒ…è£…ï¼Œå®ç°ä¸Šé¢æ¥å£æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œè·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨</p></blockquote><p>BeanWrapper ä½“ç³»ç›¸æ¯”äº Spring ä¸­å…¶ä»–ä½“ç³»æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå®ƒä½œä¸º BeanDefinition å‘ Bean è½¬æ¢è¿‡ç¨‹ä¸­çš„ä¸­é—´äº§ç‰©ï¼Œæ‰¿è½½äº† bean å®ä¾‹çš„åŒ…è£…ã€ç±»å‹è½¬æ¢ã€å±æ€§çš„è®¾ç½®ä»¥åŠè®¿é—®ç­‰é‡è¦ä½œç”¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨</title>
      <link href="/blog/2020/01/24/10825e64.html"/>
      <url>/blog/2020/01/24/10825e64.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3985">http://cmsblogs.com/?p=3985</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­åˆ†æäº† Spring ConversionService ç±»å‹è½¬æ¢ä½“ç³»ï¼Œè¿™ç¯‡åšå®¢å°†åˆ©ç”¨ <code>ConversionService</code> ä½“ç³»æ¥å®ç°è‡ªå·±çš„ç±»å‹è½¬æ¢å™¨ã€‚</p><p><code>ConversionService</code> æ˜¯ Spring ç±»å‹è½¬æ¢å™¨ä½“ç³»ä¸­çš„æ ¸å¿ƒæ¥å£ï¼Œå®ƒå®šä¹‰äº†æ˜¯å¦å¯ä»¥å®Œæˆè½¬æ¢ï¼ˆ<code>canConvert()</code>ï¼‰ ä¸ ç±»å‹è½¬æ¢ï¼ˆ<code>convert()</code>ï¼‰ä¸¤ç±»æ¥å£ã€‚</p><p>ConversionService æœ‰ä¸‰ä¸ªå­ç±»ï¼Œæ¯ä¸ªå­ç±»é’ˆå¯¹ä¸åŒçš„ç±»å‹è½¬æ¢ï¼š</p><ul><li><p><code>Converter&lt;S,T&gt;</code>: å°† S ç±»å‹å¯¹è±¡è½¬ä¸º T ç±»å‹å¯¹è±¡ã€‚</p></li><li><p><code>GenericConverter</code>: ä¼šæ ¹æ®æºç±»å¯¹è±¡åŠç›®æ ‡ç±»å¯¹è±¡æ‰€åœ¨çš„å®¿ä¸»ç±»ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p></li><li><p><code>ConverterFactory</code>: å°†ç›¸åŒç³»åˆ—å¤šä¸ª â€œåŒè´¨â€ Converter å°è£…åœ¨ä¸€èµ·ã€‚</p><p>å¦‚æœå¸Œæœ›å°†ä¸€ç§ç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹åŠå…¶å­ç±»çš„å¯¹è±¡(ä¾‹å¦‚å°† String è½¬æ¢ä¸º Number åŠ Number å­ç±»(Integerã€Longã€Double ç­‰)å¯¹è±¡)å¯ä½¿ç”¨è¯¥è½¬æ¢å™¨å·¥å‚ç±»ã€‚</p></li></ul><p>å¦‚ä½•è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ï¼Ÿåˆ†ä¸¤æ­¥èµ°ï¼š</p><ol><li>å®ç° Converter / GenericConverter / ConverterFactory æ¥å£</li><li>å°†è¯¥ç±»æ³¨å†Œåˆ° ConversionServiceFactoryBean ä¸­ã€‚</li></ol><p>ConversionServiceFactoryBean å®ç°äº† InitializingBean æ¥å£å®ç° <code>afterPropertiesSet()</code> ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ Bean å®ä¾‹åŒ– bean é˜¶æ®µï¼ŒSpring å®¹å™¨ä¼šæ£€æŸ¥å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ï¼ˆå…³äº InitializingBean è¯¦æƒ…è¯·å‚è€ƒï¼š<a href="/2020/01/23/3af7524a.html"> IOC ä¹‹ æ·±å…¥åˆ†æ InitializingBean å’Œ init-method</a>ï¼‰ã€‚</p><p><code>afterPropertiesSet()</code> æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">this</span>.conversionService = createConversionService();</span><br><span class="line"> ConversionServiceFactory.registerConverters(<span class="keyword">this</span>.converters, <span class="keyword">this</span>.conversionService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆè°ƒç”¨ <code>createConversionService()</code> åˆå§‹åŒ– conversionService</li><li>ç„¶åè°ƒç”¨ <code>ConversionServiceFactory.registerConverters()</code> å°†å®šä¹‰çš„ converters æ³¨å…¥åˆ°ç±»å‹è½¬æ¢ä½“ç³»ä¸­ã€‚<code>createConversionService()</code> å…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ª DefaultConversionService å®ä¾‹å¯¹è±¡ï¼Œå¯¹äº DefaultConversionService åœ¨ä¸Šç¯‡åšå®¢å·²ç»åˆ†æäº†ï¼Œå¦‚æœ‰ä¸äº†è§£çš„è¯·ç§»æ­¥ä¸Šç¯‡åšæ–‡ã€‚è¿™é‡Œç›´æ¥åˆ†æ <code>ConversionServiceFactory.registerConverters()</code>ï¼Œè¯¥æ–¹æ³•æ˜¯å°†å®šä¹‰çš„ converter æ³¨å†Œåˆ°ç›®æ ‡ ConverterRegistry ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ ConverterRegistry æ˜¯ä¸€ä¸ª Converter æ³¨å†Œå™¨ï¼Œä»–å®šä¹‰äº†ä¸€ç³»åˆ—æ³¨å†Œæ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerConverters</span><span class="params">(<span class="meta">@Nullable</span> Set&lt;?&gt; converters, ConverterRegistry registry)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (converters != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (Object converter : converters) &#123;</span><br><span class="line">   <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> GenericConverter) &#123;</span><br><span class="line">    registry.addConverter((GenericConverter) converter);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> Converter&lt;?, ?&gt;) &#123;</span><br><span class="line">    registry.addConverter((Converter&lt;?, ?&gt;) converter);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> ConverterFactory&lt;?, ?&gt;) &#123;</span><br><span class="line">    registry.addConverterFactory((ConverterFactory&lt;?, ?&gt;) converter);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Each converter object must implement one of the &quot;</span> +</span><br><span class="line">      <span class="string">&quot;Converter, ConverterFactory, or GenericConverter interfaces&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ ConverterRegistry çš„ <code>addConverter()</code> æ–¹æ³•å°†è½¬æ¢å™¨æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬ä½¿ç”¨ Spring å®¹å™¨çš„æ—¶å€™ï¼ŒSpring å°†ä¼šè‡ªåŠ¨è¯†åˆ«å‡º IOC å®¹å™¨ä¸­æ³¨å†Œçš„ ConversionService å¹¶ä¸”åœ¨ bean å±æ€§æ³¨å…¥é˜¶æ®µä½¿ç”¨è‡ªå®šä¹‰çš„è½¬æ¢å™¨å®Œæˆå±æ€§çš„è½¬æ¢äº†ã€‚</p><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><p>å®šä¹‰ StudentConversionService è½¬æ¢å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentConversionService</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">String</span>,<span class="title">StudentService</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StudentService <span class="title">convert</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasLength(source))&#123;</span><br><span class="line">            String[] sources = source.split(<span class="string">&quot;#&quot;</span>);</span><br><span class="line"></span><br><span class="line">            StudentService studentService = <span class="keyword">new</span> StudentService();</span><br><span class="line">            studentService.setAge(Integer.parseInt(sources[<span class="number">0</span>]));</span><br><span class="line">            studentService.setName(sources[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> studentService;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;conversionService&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;converters&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;studentConversionService&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentConversionService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.conversion.StudentConversionService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.conversion.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18#chenssy&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æBeançš„ç±»å‹è½¬æ¢ä½“ç³»</title>
      <link href="/blog/2020/01/24/683bb448.html"/>
      <url>/blog/2020/01/24/683bb448.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3983">http://cmsblogs.com/?p=3983</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>æˆ‘ä»¬çŸ¥é“ä¸ç®¡ bean å¯¹è±¡é‡Œé¢çš„å±æ€§æ—¶ä»€ä¹ˆç±»å‹ï¼Œä»–ä»¬éƒ½æ˜¯é€šè¿‡ XML ã€Properties æˆ–è€…å…¶ä»–æ–¹å¼æ¥é…ç½®è¿™äº›å±æ€§å¯¹è±¡ç±»å‹çš„ã€‚åœ¨ Spring å®¹å™¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œè¿™äº›å±æ€§éƒ½æ˜¯ä»¥ String ç±»å‹åŠ è½½è¿›å®¹å™¨çš„ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½éœ€è¦å°†è¿™äº› String ç±»å‹çš„å±æ€§è½¬æ¢ Bean å¯¹è±¡å±æ€§æ‰€å¯¹åº”çœŸæ­£çš„ç±»å‹ï¼Œè¦æƒ³å®Œæˆè¿™ç§ç”±å­—ç¬¦ä¸²åˆ°å…·ä½“å¯¹è±¡çš„è½¬æ¢ï¼Œå°±éœ€è¦è¿™ç§è½¬æ¢è§„åˆ™ç›¸å…³çš„ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¿¡æ¯ä»¥åŠè½¬æ¢è¿‡ç¨‹ç”± Spring ç±»å‹è½¬æ¢ä½“ç³»æ¥å®Œæˆã€‚</p><p>æˆ‘ä»¬ä¾ç„¶ä»¥ xml ä¸ºä¾‹ï¼Œåœ¨ Spring å®¹å™¨åŠ è½½é˜¶æ®µï¼Œå®¹å™¨å°† xml æ–‡ä»¶ä¸­å®šä¹‰çš„ <code>&lt;bean&gt;</code> è§£æä¸º BeanDefinitionï¼ŒBeanDefinition ä¸­å­˜å‚¨ç€æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª bean éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å±æ€§ï¼Œè¿™äº›å±æ€§æ˜¯ä»¥ String ç±»å‹çš„å­˜å‚¨çš„ã€‚</p><p>å½“ç”¨æˆ·è§¦å‘ Bean å®ä¾‹åŒ–é˜¶æ®µæ—¶ï¼ŒSpring å®¹å™¨ä¼šå°†è¿™äº›å±æ€§è½¬æ¢ä¸ºè¿™äº›å±æ€§çœŸæ­£å¯¹åº”çš„ç±»å‹ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ bean å®ä¾‹åŒ–é˜¶æ®µï¼Œå±æ€§çš„æ³¨å…¥æ˜¯åœ¨å®ä¾‹åŒ– bean é˜¶æ®µçš„å±æ€§æ³¨å…¥é˜¶æ®µï¼Œå³ <code>populateBean()</code> æ–¹æ³•ã€‚åœ¨ <code>populateBean()</code> ä¸­ä¼šå°† BeanDefinition ä¸­å®šä¹‰çš„å±æ€§å€¼ç¿»è¯‘ä¸º PropertyValue ç„¶åè°ƒç”¨ <code>applyPropertyValues()</code> è¿›è¡Œå±æ€§åº”ç”¨ã€‚å…¶ä¸­ PropertyValue ç”¨äºä¿å­˜å•ä¸ª bean å±æ€§çš„ä¿¡æ¯å’Œå€¼çš„å¯¹è±¡ã€‚åœ¨ <code>applyPropertyValues()</code> ä¸­ä¼šè°ƒç”¨ <code>convertForProperty()</code> è¿›è¡Œå±æ€§è½¬æ¢ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">convertForProperty</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> Object value, String propertyName, BeanWrapper bw, TypeConverter converter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> BeanWrapperImpl) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((BeanWrapperImpl) converter).convertForProperty(value, propertyName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName);</span><br><span class="line">    MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd);</span><br><span class="line">    <span class="keyword">return</span> converter.convertIfNecessary(value, pd.getPropertyType(), methodParam);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥ TypeConverter ä¸º BeanWrapperImpl ç±»å‹ï¼Œåˆ™ä½¿ç”¨ BeanWrapperImpl æ¥è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™é‡Œä¸»è¦æ˜¯å› ä¸º BeanWrapperImpl å®ç°äº† PropertyEditorRegistry æ¥å£ã€‚å¦åˆ™åˆ™è°ƒç”¨ TypeConverter çš„ <code>convertIfNecessary()</code> è¿›è¡Œç±»å‹è½¬æ¢ã€‚TypeConverter æ˜¯å®šä¹‰ç±»å‹è½¬æ¢æ–¹æ³•çš„æ¥å£ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸ PropertyEditorRegistry é…åˆä½¿ç”¨å®ç°ç±»å‹è½¬æ¢ã€‚</p><p><code>convertIfNecessary()</code> çš„å®ç°è€…æœ‰ä¸¤ä¸ªï¼š<code>DataBinder</code> å’Œ <code>TypeConverterSupport</code> ï¼Œå…¶ä¸­ <code>DataBinder</code> ä¸»è¦ç”¨äºå‚æ•°ç»‘å®šï¼ˆç†Ÿæ‚‰ Spring MVC çš„éƒ½åº”è¯¥çŸ¥é“è¿™ä¸ªç±»ï¼‰ï¼Œ<code>TypeConverterSupport</code> åˆ™æ˜¯ <code>TypeConverter</code> çš„åŸºæœ¬å®ç°ï¼Œä½¿ç”¨çš„æ˜¯ <code>package-private</code> ç­–ç•¥ã€‚</p><p> æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ TypeConverterSupport çš„ <code>convertIfNecessary()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(<span class="meta">@Nullable</span> Object value, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="meta">@Nullable</span> MethodParameter methodParam)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> TypeMismatchException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> doConvert(value, requiredType, methodParam, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">doConvert</span><span class="params">(<span class="meta">@Nullable</span> Object value,<span class="meta">@Nullable</span> Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@Nullable</span> MethodParameter methodParam, <span class="meta">@Nullable</span> Field field)</span> <span class="keyword">throws</span> TypeMismatchException </span>&#123;</span><br><span class="line"></span><br><span class="line">  Assert.state(<span class="keyword">this</span>.typeConverterDelegate != <span class="keyword">null</span>, <span class="string">&quot;No TypeConverterDelegate&quot;</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (field != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.typeConverterDelegate.convertIfNecessary(value, requiredType, field);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.typeConverterDelegate.convertIfNecessary(value, requiredType, methodParam);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ConverterNotFoundException | IllegalStateException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConversionNotSupportedException(value, requiredType, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ConversionException | IllegalArgumentException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TypeMismatchException(value, requiredType, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸€ç›´å¾€ä¸‹è·Ÿä¼šè·Ÿè¸ªåˆ° TypeConverterDelegate çš„ <code>convertIfNecessary()</code> ï¼Œä¼šå‘ç°å¦‚ä¸‹ä»£ç æ®µï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15388823317115-20200527094430730_S7jNAq.jpg" alt="img"></p><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„ç¼–è¾‘å™¨åˆ™ä½¿ç”¨ ConversionService ã€‚ConversionService æ˜¯ Spring è‡ª 3 åæ¨å‡ºæ¥ç”¨æ¥æ›¿ä»£ PropertyEditor è½¬æ¢æ¨¡å¼çš„è½¬æ¢ä½“ç³»ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConversionService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canConvert</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;?&gt; sourceType, Class&lt;?&gt; targetType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canConvert</span><span class="params">(<span class="meta">@Nullable</span> TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, Class&lt;T&gt; targetType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, <span class="meta">@Nullable</span> TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ UML ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15388832533588_Cmgmcb_smrQ4E.jpg" alt="img"></p><ul><li><strong>ConfigurableConversionService</strong>ï¼šConversionService çš„é…ç½®æ¥å£ï¼Œç»§æ‰¿ ConversionService å’Œ ConverterRegistry ä¸¤ä¸ªæ¥å£ï¼Œç”¨äºåˆå¹¶ä»–ä»¬ä¸¤è€…çš„æ“ä½œï¼Œä»¥ä¾¿äºé€šè¿‡ add å’Œ remove çš„æ–¹å¼æ·»åŠ å’Œåˆ é™¤è½¬æ¢å™¨ã€‚</li><li><strong>GenericConversionService</strong>ï¼šConversionService æ¥å£çš„åŸºç¡€å®ç°ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†æ¡ä»¶ä¸‹çš„è½¬æ¢å·¥ä½œï¼Œé€šè¿‡ ConfigurableConversionService æ¥å£é—´æ¥åœ°å°† ConverterRegistry å®ç°ä¸ºæ³¨å†Œ API ã€‚</li><li><strong>DefaultConversionService</strong>ï¼šConversionService æ¥å£çš„é»˜è®¤å®ç°ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†æ¡ä»¶ä¸‹çš„è½¬æ¢å·¥ä½œã€‚</li></ul><p>å›å½’åˆ° <code>convertIfNecessary()</code>ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„å±æ€§ç¼–è¾‘å™¨åˆ™è°ƒç”¨ ConversionService æ¥å£çš„ <code>convert()</code>ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, <span class="meta">@Nullable</span> TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>sourceï¼šè¦è½¬æ¢çš„æºå¯¹è±¡ï¼Œå¯ä»¥ä¸º null</li><li>sourceTypeï¼šsource çš„ç±»å‹çš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœ source ä¸º nullï¼Œåˆ™å¯ä»¥ä¸º null</li><li>targetTypeï¼šsource è¦è½¬æ¢çš„ç±»å‹çš„ä¸Šä¸‹æ–‡ã€‚</li></ul><p><code>convert()</code> å°†ç»™å®šçš„æºå¯¹è±¡ source è½¬æ¢ä¸ºæŒ‡å®šçš„ targetTypeã€‚</p><p>TypeDescriptors æä¾›æœ‰å…³å‘ç”Ÿè½¬æ¢çš„æºä½ç½®å’Œç›®æ ‡ä½ç½®çš„é™„åŠ ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸æ˜¯å¯¹è±¡å­—æ®µæˆ–å±æ€§ä½ç½®ã€‚æ–¹æ³•ç”±å­ç±» GenericConversionService å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, <span class="meta">@Nullable</span> TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ æ‰ if ï¼Œå…¶å®å°±æ˜¯ä¸Šé¢çš„ null åˆ¤æ–­</span></span><br><span class="line">  GenericConverter converter = getConverter(sourceType, targetType);</span><br><span class="line">  <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Object result = ConversionUtils.invokeConverter(converter, source, sourceType, targetType);</span><br><span class="line">    <span class="keyword">return</span> handleResult(sourceType, targetType, result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> handleConverterNotFound(source, sourceType, targetType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ ¹æ® sourceType å’Œ targetType è°ƒç”¨ <code>getConverter()</code> è·å– GenericConverter å¯¹è±¡ converter ï¼Œå¦‚æœ converter ä¸º nullï¼Œåˆ™è°ƒç”¨ <code>handleConverterNotFound()</code>ï¼Œå¦åˆ™è°ƒç”¨ <code>handleResult()</code> æ–¹æ³•ã€‚<code>getConverter()</code> å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> GenericConverter <span class="title">getConverter</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">  ConverterCacheKey key = <span class="keyword">new</span> ConverterCacheKey(sourceType, targetType);</span><br><span class="line">  GenericConverter converter = <span class="keyword">this</span>.converterCache.get(key);</span><br><span class="line">  <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (converter != NO_MATCH ? converter : <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  converter = <span class="keyword">this</span>.converters.find(sourceType, targetType);</span><br><span class="line">  <span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</span><br><span class="line">    converter = getDefaultConverter(sourceType, targetType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.converterCache.put(key, converter);</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.converterCache.put(key, NO_MATCH);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ„å›¾éå¸¸æ˜ç¡®ï¼Œä» converterCache ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœå­˜åœ¨è¿”å›ï¼Œå¦åˆ™ä» converters ä¸­è·å–ï¼Œç„¶ååŠ å…¥åˆ° converterCache ç¼“å­˜ä¸­ã€‚converterCache å’Œ converters æ˜¯ GenericConversionService ç»´æŠ¤çš„ä¸¤ä¸ªå¾ˆé‡è¦çš„å¯¹è±¡ï¼Œå…¶ä¸­ converterCache ç”¨äºå­˜å‚¨ GenericConverter ï¼Œconverters å¯¹è±¡ä¸º GenericConversionService çš„å†…éƒ¨ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Converters converters = <span class="keyword">new</span> Converters();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ConverterCacheKey, GenericConverter&gt; converterCache = <span class="keyword">new</span> ConcurrentReferenceHashMap&lt;&gt;(<span class="number">64</span>);</span><br></pre></td></tr></table></figure><p>Converters ç”¨äºç®¡ç†æ‰€æœ‰æ³¨å†Œçš„è½¬æ¢å™¨ï¼Œå…¶å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Set å’Œ Map çš„æ•°æ®ç»“æ„ç”¨äºç®¡ç†è½¬æ¢å™¨ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;GenericConverter&gt; globalConverters = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ConvertiblePair, ConvertersForPair&gt; converters = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">36</span>);</span><br></pre></td></tr></table></figure><p>åŒæ—¶æä¾›äº†ç›¸åº”çš„æ–¹æ³•ï¼ˆå¦‚ addã€removeï¼‰æ“ä½œè¿™ä¸¤ä¸ªé›†åˆã€‚åœ¨ <code>getConverter()</code> ä¸­å¦‚æœç¼“å­˜ converterCache ä¸­ ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ Converters å¯¹è±¡çš„ <code>find()</code> æ–¹æ³•è·å–ç›¸åº”çš„ GenericConverterï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> GenericConverter <span class="title">find</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Search the full type hierarchy</span></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; sourceCandidates = getClassHierarchy(sourceType.getType());</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; targetCandidates = getClassHierarchy(targetType.getType());</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; sourceCandidate : sourceCandidates) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; targetCandidate : targetCandidates) &#123;</span><br><span class="line">            ConvertiblePair convertiblePair = <span class="keyword">new</span> ConvertiblePair(sourceCandidate, targetCandidate);</span><br><span class="line">            GenericConverter converter = getRegisteredConverter(sourceType, targetType, convertiblePair);</span><br><span class="line">            <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> converter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> GenericConverter <span class="title">getRegisteredConverter</span><span class="params">(TypeDescriptor sourceType,</span></span></span><br><span class="line"><span class="function"><span class="params">                TypeDescriptor targetType, ConvertiblePair convertiblePair)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check specifically registered converters</span></span><br><span class="line">    ConvertersForPair convertersForPair = <span class="keyword">this</span>.converters.get(convertiblePair);</span><br><span class="line">    <span class="keyword">if</span> (convertersForPair != <span class="keyword">null</span>) &#123;</span><br><span class="line">        GenericConverter converter = convertersForPair.getConverter(sourceType, targetType);</span><br><span class="line">        <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> converter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check ConditionalConverters for a dynamic match</span></span><br><span class="line">    <span class="keyword">for</span> (GenericConverter globalConverter : <span class="keyword">this</span>.globalConverters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((ConditionalConverter) globalConverter).matches(sourceType, targetType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> globalConverter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>find()</code> ä¸­ä¼šæ ¹æ® sourceType å’Œ targetType å»æŸ¥è¯¢ Converters ä¸­ç»´æŠ¤çš„ Map ä¸­æ˜¯å¦åŒ…æ‹¬æ”¯æŒçš„æ³¨å†Œç±»å‹ï¼Œå¦‚æœå­˜åœ¨è¿”å› GenericConverter ï¼Œå¦‚æœæ²¡æœ‰å­˜åœ¨è¿”å› nullã€‚</p><p>å½“å¾—åˆ° GenericConverter åï¼Œåˆ™è°ƒç”¨å…¶ <code>convert()</code> è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ° bean å±æ€§å®šä¹‰çš„çœŸæ­£ç±»å‹äº†ã€‚</p><p><strong>GenericConverter æ¥å£</strong></p><p>GenericConverter æ˜¯ä¸€ä¸ªè½¬æ¢æ¥å£ï¼Œä¸€ä¸ªç”¨äºåœ¨ä¸¤ç§æˆ–æ›´å¤šç§ç±»å‹ä¹‹é—´è½¬æ¢çš„é€šç”¨å‹è½¬æ¢å™¨æ¥å£ã€‚å®ƒæ˜¯ Converter SPI ä½“ç³»ä¸­æœ€çµæ´»çš„ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„æ¥å£ï¼Œçµæ´»æ€§åœ¨äº GenericConverter å¯ä»¥æ”¯æŒåœ¨å¤šä¸ªæº/ç›®æ ‡ç±»å‹å¯¹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­è®¿é—®æº/ç›®æ ‡å­—æ®µä¸Šä¸‹æ–‡ã€‚ç”±äºè¯¥æ¥å£è¶³å¤Ÿå¤æ‚ï¼Œæ‰€æœ‰å½“æ›´ç®€å•çš„ Converter æˆ– ConverterFactory æ¥å£è¶³å¤Ÿä½¿ç”¨æ—¶ï¼Œé€šå¸¸ä¸åº”ä½¿ç”¨æ­¤æ¥å£ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Set&lt;ConvertiblePair&gt; <span class="title">getConvertibleTypes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GenericConverter çš„å­ç±»æœ‰è¿™ä¹ˆå¤šï¼ˆçœ‹ç±»åå°±çŸ¥é“æ˜¯å¹²å˜›çš„äº†ï¼‰ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15388984648307_DEQ9BT_olp6Km.jpg" alt="img"></p><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªå­ç±»çš„å®ç° StringToArrayConverterï¼Œè¯¥å­ç±»å°†é€—å·åˆ†éš”çš„ String è½¬æ¢ä¸º Arrayã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (source == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  String string = (String) source;</span><br><span class="line">  String[] fields = StringUtils.commaDelimitedListToStringArray(string);</span><br><span class="line">  TypeDescriptor targetElementType = targetType.getElementTypeDescriptor();</span><br><span class="line">  Assert.state(targetElementType != <span class="keyword">null</span>, <span class="string">&quot;No target element type&quot;</span>);</span><br><span class="line">  Object target = Array.newInstance(targetElementType.getType(), fields.length);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">    String sourceElement = fields[i];</span><br><span class="line">    Object targetElement = <span class="keyword">this</span>.conversionService.convert(sourceElement.trim(), sourceType, targetElementType);</span><br><span class="line">    Array.set(target, i, targetElement);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç±»å‹è½¬æ¢ä½“ç³»ä¸­ï¼ŒSpring æä¾›äº†éå¸¸å¤šçš„ç±»å‹è½¬æ¢å™¨ï¼Œé™¤äº†ä¸Šé¢çš„ GenericConverterï¼Œè¿˜æœ‰ Converterã€ConditionalConverterã€ConverterFactoryã€‚</p><p><strong>Converter</strong></p><p>Converter æ˜¯ä¸€ä¸ªå°† S ç±»å‹çš„æºå¯¹è±¡è½¬æ¢ä¸º T ç±»å‹çš„ç›®æ ‡å¯¹è±¡çš„è½¬æ¢å™¨ã€‚è¯¥æ¥å£æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯ä»¥å…±äº«ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(S source)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­ç±»å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15389004851676-20200527094627489_1lakfm.jpg" alt="img"></p><p><strong>ConditionalConverter</strong></p><p>ConditionalConverter æ¥å£ç”¨äºè¡¨ç¤ºæœ‰æ¡ä»¶çš„ç±»å‹è½¬æ¢ï¼Œé€šè¿‡è½¬å…¥çš„sourceType ä¸ targetType åˆ¤æ–­è½¬æ¢èƒ½å¦åŒ¹é…ï¼Œåªæœ‰å¯åŒ¹é…çš„è½¬æ¢æ‰ä¼šè°ƒç”¨convert æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface ConditionalConverter &#123;</span><br><span class="line">    boolean matches(TypeDescriptor sourceType, TypeDescriptor targetType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConditionalConverter çš„å­ç±»å¦‚ä¸‹ï¼š</p><p><a href="https://gitee.com/chenssy/blog-home/raw/master/image/201811/15389064279138.jpg"><img src="https://gitee.com/chenssy/blog-home/raw/master/image/201811/15389064279138.jpg" alt="img"></a></p><p><strong>ConverterFactory</strong></p><p>ä¸€ä¸ªç”¨äºâ€œè¿œç¨‹â€è½¬æ¢çš„è½¬æ¢å·¥å‚ï¼Œå¯ä»¥å°†å¯¹è±¡ä» S è½¬æ¢ä¸º R çš„å­ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConverterFactory</span>&lt;<span class="title">S</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    &lt;T extends R&gt; <span class="function">Converter&lt;S, T&gt; <span class="title">getConverter</span><span class="params">(Class&lt;T&gt; targetType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­ç±»å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15389071818355_KBtf0I_MmL1Mp.jpg" alt="img"></p><p>å››ç§ä¸åŒçš„è½¬æ¢å™¨æ‰¿è½½ç€ä¸åŒçš„è½¬æ¢è¿‡ç¨‹ï¼š</p><ul><li>Converterï¼šç”¨äº 1:1 çš„ source -&gt; target ç±»å‹è½¬æ¢</li><li>ConverterFactoryï¼šç”¨äº 1:N çš„ source -&gt; target ç±»å‹è½¬æ¢</li><li>GenericConverterç”¨äº N:N çš„ source -&gt; target ç±»å‹è½¬æ¢</li><li>ConditionalConverterï¼šæœ‰æ¡ä»¶çš„ source -&gt; target ç±»å‹è½¬æ¢</li></ul><p><strong>GenericConversionService</strong></p><p>è½¬æ¢å™¨ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬å†æ¬¡å›å½’åˆ° ConversionService æ¥å£ä¸­å»ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸¤ç±»æ–¹æ³• <code>canConvert()</code> å’Œ <code>convert()</code>ï¼Œå…¶ä¸­ <code>canConvert()</code> ç”¨äºåˆ¤ sourceType èƒ½å¦è½¬æˆ targetType ,è€Œ <code>convert()</code> ç”¨äºå°† source è½¬æˆè½¬å…¥çš„ TargetType ç±»å‹å®ä¾‹ã€‚è¿™ä¸¤ç±»æ–¹æ³•éƒ½æ˜¯åœ¨ GenericConversionService ä¸­å®ç°ã€‚ç±» GenericConversionService å®ç° ConfigurableConversionService æ¥å£ï¼Œè€Œ ConfigurableConversionService æ¥å£ç»§æ‰¿ ConversionService å’Œ ConverterRegistryã€‚ConverterRegistry æä¾›äº†ç±»å‹è½¬æ¢å™¨çš„ç®¡ç†åŠŸèƒ½ï¼Œä»–æä¾›äº†å››ä¸ª add å’Œ ä¸€ä¸ª remove æ–¹æ³•ï¼Œæ”¯æŒæ³¨å†Œ/åˆ é™¤ç›¸åº”çš„ç±»å‹è½¬æ¢å™¨ã€‚GenericConversionService ä½œä¸ºä¸€ä¸ªåŸºç¡€å®ç°ç±»ï¼Œå®ƒå³æ”¯æŒäº†ä¸åŒç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¹Ÿå¯¹å„ç±»å‹è½¬æ¢å™¨è¿›è¡Œç®¡ç†ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ª Map ç±»å‹çš„ converterCache å’Œä¸€ä¸ªå†…éƒ¨ç±» Convertersã€‚åœ¨ä¸Šé¢å·²ç»åˆ†æäº† GenericConversionService æ‰§è¡Œç±»å‹è½¬æ¢çš„è¿‡ç¨‹ <code>cover()</code>ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä¸€ä¸ª <code>addConverter()</code> æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®Œæˆè½¬æ¢å™¨çš„æ³¨å…¥å·¥ä½œçš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConverter</span><span class="params">(Converter&lt;?, ?&gt; converter)</span> </span>&#123;</span><br><span class="line">  ResolvableType[] typeInfo = getRequiredTypeInfo(converter.getClass(), Converter.class);</span><br><span class="line">  <span class="keyword">if</span> (typeInfo == <span class="keyword">null</span> &amp;&amp; converter <span class="keyword">instanceof</span> DecoratingProxy) &#123;</span><br><span class="line">    typeInfo = getRequiredTypeInfo(((DecoratingProxy) converter).getDecoratedClass(), Converter.class);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (typeInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to determine source type &lt;S&gt; and target type &lt;T&gt; for your &quot;</span> +</span><br><span class="line">                                       <span class="string">&quot;Converter [&quot;</span> + converter.getClass().getName() + <span class="string">&quot;]; does the class parameterize those types?&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  addConverter(<span class="keyword">new</span> ConverterAdapter(converter, typeInfo[<span class="number">0</span>], typeInfo[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ ¹æ® converter è·å– ResolvableTypeï¼Œç„¶åå°†å…¶ä¸ converter å°è£…æˆä¸€ä¸ª ConverterAdapter å®ä¾‹ï¼Œæœ€åè°ƒç”¨ <code>addConverter()</code>ã€‚ResolvableType ç”¨äºå°è£… Java çš„ç±»å‹ã€‚ConverterAdapter åˆ™æ˜¯ Converter çš„ä¸€ä¸ªé€‚é…å™¨ï¼Œ å®ƒå®ç°äº† GenericConverter å’Œ ConditionalConverter ä¸¤ä¸ªç±»å‹è½¬æ¢å™¨ã€‚</p><p><code>addConverter()</code> å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConverter</span><span class="params">(GenericConverter converter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.converters.add(converter);</span><br><span class="line">    invalidateCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨å†…éƒ¨ç±» Converters çš„ <code>add()</code> æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(GenericConverter converter)</span> </span>&#123;</span><br><span class="line">  Set&lt;ConvertiblePair&gt; convertibleTypes = converter.getConvertibleTypes();</span><br><span class="line">  <span class="keyword">if</span> (convertibleTypes == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Assert.state(converter <span class="keyword">instanceof</span> ConditionalConverter,</span><br><span class="line">                 <span class="string">&quot;Only conditional converters may return null convertible types&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.globalConverters.add(converter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (ConvertiblePair convertiblePair : convertibleTypes) &#123;</span><br><span class="line">      ConvertersForPair convertersForPair = getMatchableConverters(convertiblePair);</span><br><span class="line">      convertersForPair.add(converter);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨ <code>getConvertibleTypes()</code> è·å– ConvertiblePair é›†åˆï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åŠ å…¥åˆ° globalConverters é›†åˆä¸­ï¼Œå¦åˆ™é€šè¿‡è¿­ä»£çš„æ–¹å¼ä¾æ¬¡æ·»åŠ ã€‚ConvertiblePair ä¸º source-to-targer çš„æŒæœ‰è€…ï¼Œå®ƒæŒæœ‰ source å’Œ target çš„ class ç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConvertiblePair</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; sourceType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶ä»–ä»£ç    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¼šæ ¹æ® ConvertiblePair è·å–ç›¸åº”çš„ ConvertersForPair ï¼Œç„¶å converter è½¬æ¢å™¨åŠ å…¥å…¶ä¸­ï¼ŒConvertiblePair ç”¨äºç®¡ç†ä½¿ç”¨ç‰¹å®šGenericConverter.ConvertiblePair æ³¨å†Œçš„è½¬æ¢å™¨ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConvertersForPair</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;GenericConverter&gt; converters = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(GenericConverter converter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.converters.addFirst(converter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> GenericConverter <span class="title">getConverter</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (GenericConverter converter : <span class="keyword">this</span>.converters) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(converter <span class="keyword">instanceof</span> ConditionalGenericConverter) ||</span><br><span class="line">          ((ConditionalGenericConverter) converter).matches(sourceType, targetType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å†…éƒ¨å°±æ˜¯ç»´æŠ¤ä¸€ä¸ª LinkedList é›†åˆã€‚ä»–å†…éƒ¨æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>add()</code> å’Œ <code>getConverter()</code>ï¼Œå®ç°è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚</p><p><strong>DefaultConversionService</strong></p><p>DefaultConversionService æ˜¯ ConversionService çš„é»˜è®¤å®ç°ï¼Œå®ƒç»§æ‰¿ GenericConversionServiceï¼ŒGenericConversionService ä¸»è¦ç”¨äºè½¬æ¢å™¨çš„æ³¨å†Œå’Œè°ƒç”¨ï¼ŒDefaultConversionService åˆ™æ˜¯ä¸º ConversionService ä½“ç³»æä¾›ä¸€äº›é»˜è®¤çš„è½¬æ¢å™¨ã€‚åœ¨ DefaultConversionService æ„é€ æ–¹æ³•ä¸­å°±ä¼šæ·»åŠ é»˜è®¤çš„ Converter ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultConversionService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  addDefaultConverters(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addDefaultConverters</span><span class="params">(ConverterRegistry converterRegistry)</span> </span>&#123;</span><br><span class="line">  addScalarConverters(converterRegistry);</span><br><span class="line">  addCollectionConverters(converterRegistry);</span><br><span class="line"></span><br><span class="line">  converterRegistry.addConverter(<span class="keyword">new</span> ByteBufferConverter((ConversionService) converterRegistry));</span><br><span class="line">  <span class="keyword">if</span> (jsr310Available) &#123;</span><br><span class="line">    Jsr310ConverterRegistrar.registerJsr310Converters(converterRegistry);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  converterRegistry.addConverter(<span class="keyword">new</span> ObjectToObjectConverter());</span><br><span class="line">  converterRegistry.addConverter(<span class="keyword">new</span> IdToEntityConverter((ConversionService) converterRegistry));</span><br><span class="line">  converterRegistry.addConverter(<span class="keyword">new</span> FallbackObjectToStringConverter());</span><br><span class="line">  <span class="keyword">if</span> (javaUtilOptionalClassAvailable) &#123;</span><br><span class="line">    converterRegistry.addConverter(<span class="keyword">new</span> ObjectToOptionalConverter((ConversionService) converterRegistry));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶å®ƒè¿˜æä¾›äº†ä¸€äº›å…¶ä»–çš„æ–¹æ³•å¦‚ <code>addCollectionConverters()</code>ã€<code>addScalarConverters()</code> ç”¨äºæ³¨å†Œå…¶ä»–ç±»å‹çš„è½¬æ¢å™¨ã€‚</p><p>è‡³æ­¤ï¼Œä» bean å±æ€§çš„è½¬æ¢ï¼Œåˆ° Spring ConversionService ä½“ç³»çš„è½¬æ¢å™¨ Converter ä»¥åŠè½¬æ¢å™¨çš„ç®¡ç†éƒ½ä»‹ç»å®Œæ¯•äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æPropertyOverrideConfigurer</title>
      <link href="/blog/2020/01/24/e5d90f02.html"/>
      <url>/blog/2020/01/24/e5d90f02.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3924">http://cmsblogs.com/?p=3924</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨æ–‡ç«  <a href="/2020/01/23/81b83a69.html">IOC ä¹‹ æ·±å…¥åˆ†æ BeanFactoryPostProcessor</a> ä¸­æåˆ°ï¼ŒBeanFactoryPostProcessor ä½œç”¨ä¸ bean å®ŒæˆåŠ è½½ä¹‹åä¸ bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ˜¯ Spring æä¾›çš„ä¸€ç§å¼ºå¤§çš„æ‰©å±•æœºåˆ¶ï¼Œä»–æœ‰ä¸¤ä¸ªé‡è¦çš„å­ç±»ï¼Œä¸€ä¸ªæ˜¯ PropertyPlaceholderConfigurerï¼Œå¦ä¸€ä¸ªæ˜¯ PropertyOverrideConfigurer ï¼Œå…¶ä¸­ PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬é€šè¿‡é…ç½® Properties çš„æ–¹å¼æ¥å–ä»£ bean ä¸­å®šä¹‰çš„å ä½ç¬¦ï¼Œè€Œ PropertyOverrideConfigurer å‘¢ï¼Ÿæ­£æ˜¯æˆ‘ä»¬è¿™ç¯‡åšå®¢ä»‹ç»çš„ã€‚</p><blockquote><p>PropertyOverrideConfigurer å…è®¸æˆ‘ä»¬å¯¹ Spring å®¹å™¨ä¸­é…ç½®çš„ä»»ä½•æˆ‘ä»¬æƒ³å¤„ç†çš„ bean å®šä¹‰çš„ property ä¿¡æ¯è¿›è¡Œè¦†ç›–æ›¿æ¢ã€‚</p></blockquote><p>è¿™ä¸ªå®šä¹‰å¬èµ·æ¥æœ‰ç‚¹å„¿ç„ä¹ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ PropertyOverrideConfigurer æ¥è¦†ç›–ä»»ä½• bean ä¸­çš„ä»»ä½•å±æ€§ï¼Œåªè¦æˆ‘ä»¬æƒ³ã€‚</p><p><u>PropertyOverrideConfigurer çš„ä½¿ç”¨è§„åˆ™æ˜¯ <code>beanName.propertyName=value</code>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ beanNameï¼ŒpropertyName åˆ™æ˜¯è¯¥ bean ä¸­å­˜åœ¨çš„å±æ€§ã€‚</u></p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>ä¾ç„¶ä½¿ç”¨ä»¥å‰çš„ä¾‹å­ï¼ŒStudent.classï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸‹é…ç½®æ–‡ä»¶ï¼Œå£°æ˜ä¸‹ PropertyOverrideConfigurer ä»¥åŠå…¶åŠ è½½çš„é…ç½®æ–‡ä»¶ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.PropertyOverrideConfigurer&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;locations&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:application.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;chenssy&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æŒ‡å®š student çš„ name å±æ€§å€¼ä¸º chenssyï¼Œå£°æ˜ PropertyOverrideConfigurer åŠ è½½çš„æ–‡ä»¶ä¸º application.propertiesï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">student.name</span> = <span class="string">chenssy-PropertyOverrideConfigurer</span></span><br></pre></td></tr></table></figure><p>æŒ‡å®š beanName ä¸º student çš„ bean çš„ name å±æ€§å€¼ä¸º chenssy-PropertyOverrideConfigurerã€‚</p><p>æµ‹è¯•æ‰“å° student ä¸­çš„ name å±æ€§å€¼ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">StudentService studentService = (StudentService) context.getBean(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;student name:&quot;</span> + studentService.getName());</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15377119278769_ti0Upp_WR3LqN.jpg" alt="img"></p><p>ä»ä¸­å¯ä»¥çœ‹å‡º PropertyOverrideConfigurer å®šä¹‰çš„æ–‡ä»¶å–ä»£äº† bean ä¸­é»˜è®¤çš„å€¼ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä¸€ä¸ª bean ä¸­ PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer éƒ½ä½¿ç”¨å‘¢ï¼Ÿé‚£æ˜¯æ˜¾ç¤ºè°å®šä¹‰çš„å€¼å‘¢ï¼Ÿ</p><p>è¿™é‡Œå…ˆç®€å•åˆ†æä¸‹ï¼šå¦‚æœ<code>PropertyOverrideConfigurer</code> å…ˆä½œç”¨ï¼Œé‚£ä¹ˆ <code>PropertyPlaceholderConfigurer</code> åœ¨åŒ¹é…å ä½ç¬¦çš„æ—¶å€™å°±æ‰¾ä¸åˆ°äº†ï¼Œå¦‚æœ <code>PropertyOverrideConfigurer</code> åä½œç”¨ï¼Œä¹Ÿä¼šç›´æ¥å–ä»£ <code>PropertyPlaceholderConfigurer</code> å®šä¹‰çš„å€¼ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½ä¼šæ˜¾ç¤º <code>PropertyOverrideConfigurer</code> å®šä¹‰çš„å€¼ã€‚</p><p>æ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿçœ‹å¦‚ä¸‹ä¾‹å­ï¼š</p><p>xml é…ç½®æ–‡ä»¶è°ƒæ•´å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.PropertyOverrideConfigurer&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;locations&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:application1.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;locations&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:application2.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;studentService.name&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æŒ‡å®š PropertyPlaceholderConfigurer åŠ è½½æ–‡ä»¶ä¸º application1.propertiesï¼ŒPropertyPlaceholderConfigurer åŠ è½½æ–‡ä»¶ä¸º application2.propertiesï¼Œstudent çš„ name å±æ€§ä½¿ç”¨å ä½ç¬¦ <code>$&#123;studentService.name&#125;</code>ã€‚é…ç½®æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application1.propertiesï¼š</span></span><br><span class="line"><span class="meta">student.name</span> = <span class="string">chenssy-PropertyOverrideConfigurer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># application2.propertiesï¼š</span></span><br><span class="line"><span class="meta">studentService.name</span> = <span class="string">chenssy-PropertyPlaceholderConfigurer</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åºä¾ç„¶æ˜¯æ‰“å° name å±æ€§å€¼ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/15377127284347_fDOIPu_94XAir.jpg" alt="img"></p><p>æ‰€ä»¥ï¼Œä¸Šé¢çš„åˆ†ææ²¡æœ‰é”™ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æ PropertyOverrideConfigurer å®ç°åŸç†ã€‚å…¶å®å¦‚æœäº†è§£ PropertyPlaceholderConfigurer çš„å®ç°æœºåˆ¶çš„è¯ï¼Œé‚£ä¹ˆ PropertyOverrideConfigurer ä¹Ÿä¸éš¾çŒœæµ‹ï¼šåŠ è½½æŒ‡å®š Propertiesï¼Œè¿­ä»£å…¶ä¸­çš„å±æ€§å€¼ï¼Œä¾æ® â€œ.â€ æ¥å¾—åˆ° beanNameï¼ˆsplit(â€œ.â€)[0]ï¼‰ï¼Œä»å®¹å™¨ä¸­è·å–æŒ‡å®šçš„ BeanDefinitionï¼Œç„¶åå¾—åˆ° name å±æ€§ï¼Œè¿›è¡Œæ›¿æ¢å³å¯ã€‚</p><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>UML ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/spring-201809231001-20200527093418095_v2NThs.png" alt="spring-201809231001"></p><p>ä¸ PropertyPlaceholderConfigurer ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç»§æ‰¿ PropertyResourceConfigurerï¼Œæˆ‘ä»¬çŸ¥é“ PropertyResourceConfigurer å¯¹ BeanFactoryPostProcessor çš„ <code>postProcessBeanFactory()</code> æä¾›äº†å®ç°ï¼Œåœ¨è¯¥å®ç°ä¸­å®ƒä¼šå»è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œç„¶å <code>processProperties()</code> ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°ç”±å­ç±»æ¥å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªéœ€è¦çœ‹ PropertyOverrideConfigurer ä¸­ <code>processProperties()</code> ä¸­çš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processProperties</span><span class="params">(ConfigurableListableBeanFactory beanFactory, Properties props)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="comment">// è¿­ä»£é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹</span></span><br><span class="line">  <span class="keyword">for</span> (Enumeration&lt;?&gt; names = props.propertyNames(); names.hasMoreElements();) &#123;</span><br><span class="line">    String key = (String) names.nextElement();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      processKey(beanFactory, key, props.getProperty(key));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      String msg = <span class="string">&quot;Could not process key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in PropertyOverrideConfigurer&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.ignoreInvalidKeys) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(msg, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(msg, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿­ä»£ props å†…å®¹ï¼Œä¾æ¬¡è°ƒç”¨ <code>processKey()</code>ï¼Œå¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processKey</span><span class="params">(ConfigurableListableBeanFactory factory, String key, String value)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ &quot;.&quot;</span></span><br><span class="line">  <span class="comment">// è·å–å…¶ç´¢å¼•ä½ç½®</span></span><br><span class="line">  <span class="keyword">int</span> separatorIndex = key.indexOf(<span class="keyword">this</span>.beanNameSeparator);</span><br><span class="line">  <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œ. åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">if</span> (separatorIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">&quot;Invalid key &#x27;&quot;</span> + key +</span><br><span class="line">                                          <span class="string">&quot;&#x27;: expected &#x27;beanName&quot;</span> + <span class="keyword">this</span>.beanNameSeparator + <span class="string">&quot;property&#x27;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¾—åˆ° beanName</span></span><br><span class="line">  String beanName = key.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">  <span class="comment">// å¾—åˆ°å±æ€§å€¼</span></span><br><span class="line">  String beanProperty = key.substring(separatorIndex+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">this</span>.beanNames.add(beanName);</span><br><span class="line">  <span class="comment">// æ›¿æ¢</span></span><br><span class="line">  applyPropertyValue(factory, beanName, beanProperty, value);</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Property &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; set to value [&quot;</span> + value + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–åˆ†å‰²ç¬¦ â€œ.â€ çš„ç´¢å¼•ä½ç½®ï¼Œå¾—åˆ° beanName ä»¥åŠç›¸åº”çš„å±æ€§ï¼Œç„¶åè°ƒç”¨ <code>applyPropertyValue()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyPropertyValue</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory factory, String beanName, String property, String value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  BeanDefinition bd = factory.getBeanDefinition(beanName);</span><br><span class="line">  BeanDefinition bdToUse = bd;</span><br><span class="line">  <span class="keyword">while</span> (bd != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bdToUse = bd;</span><br><span class="line">    bd = bd.getOriginatingBeanDefinition();</span><br><span class="line">  &#125;</span><br><span class="line">  PropertyValue pv = <span class="keyword">new</span> PropertyValue(property, value);</span><br><span class="line">  pv.setOptional(<span class="keyword">this</span>.ignoreInvalidKeys);</span><br><span class="line">  bdToUse.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å®¹å™¨ä¸­è·å– BeanDefinition ï¼Œç„¶åæ ¹æ®å±æ€§ property å’Œ å…¶å€¼ value æ„é€ æˆä¸€ä¸ª PropertyValue å¯¹è±¡ï¼Œæœ€åè°ƒç”¨ <code>addPropertyValue()</code> æ–¹æ³•ã€‚<strong>PropertyValue æ˜¯ç”¨äºä¿å­˜ä¸€ç»„beanå±æ€§çš„ä¿¡æ¯å’Œå€¼çš„å¯¹åƒã€‚</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MutablePropertyValues <span class="title">addPropertyValue</span><span class="params">(PropertyValue pv)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.propertyValueList.size(); i++) &#123;</span><br><span class="line">  PropertyValue currentPv = <span class="keyword">this</span>.propertyValueList.get(i);</span><br><span class="line">  <span class="keyword">if</span> (currentPv.getName().equals(pv.getName())) &#123;</span><br><span class="line">   pv = mergeIfRequired(pv, currentPv);</span><br><span class="line">   setPropertyValueAt(pv, i);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">this</span>.propertyValueList.add(pv);</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ  PropertyValue å¯¹è±¡ï¼Œæ›¿æ¢æˆ–è€…åˆå¹¶ç›¸åŒçš„å±æ€§å€¼ã€‚æ•´ä¸ªè¿‡ç¨‹å…¶å®ä¸ä¸Šé¢çŒœæµ‹ç›¸å·®ä¸æ˜¯å¾ˆå¤§ã€‚</p><p>è‡³æ­¤ï¼ŒPropertyOverrideConfigurer åˆ°è¿™é‡Œä¹Ÿå°±åˆ†æå®Œæ¯•äº†ã€‚æœ€åçœ‹ä¸‹ PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer æ•´ä½“çš„ç»“æ„å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/27/spring-201809231002_8yTF1l_7kG2Gt.png" alt="spring-201809231002"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹PropertyPlaceholderConfigurerçš„åº”ç”¨</title>
      <link href="/blog/2020/01/23/cd2eaad8.html"/>
      <url>/blog/2020/01/23/cd2eaad8.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3839">http://cmsblogs.com/?p=3839</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨åšå®¢ <a href="/2020/01/23/99d35216.html">IOC ä¹‹ æ·±å…¥åˆ†æ PropertyPlaceholderConfigurer</a> ä¸­äº†è§£äº† PropertyPlaceholderConfigurer å†…éƒ¨å®ç°åŸç†ï¼Œå¥¹<strong>å…è®¸æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å ä½ç¬¦å¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºå•ç‹¬é…ç½®åˆ°ç®€å•çš„ properties æ–‡ä»¶ä¸­æ¥åŠ è½½</strong>ã€‚</p><p>è¿™ä¸ªç‰¹æ€§éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒæˆ‘ä»¬å¯¹ Bean å®ä¾‹å±æ€§çš„é…ç½®å˜å¾—éå¸¸å®¹æ˜“æ§åˆ¶äº†ï¼Œä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ï¼š</p><ol><li>åŠ¨æ€åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¤šç¯å¢ƒåˆ‡æ¢</li><li>å±æ€§åŠ è§£å¯†</li></ol><p>ä¸‹é¢æˆ‘ä»¬å°±ç¬¬ä¸€ä¸ªåº”ç”¨åœºæ™¯æ¥åšè¯´æ˜ã€‚</p><p><strong>åˆ©ç”¨ PropertyPlaceholderConfigurer å®ç°å¤šç¯å¢ƒåˆ‡æ¢</strong></p><p>åœ¨æˆ‘ä»¬é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šå­˜åœ¨å¤šä¸ªç¯å¢ƒï¼Œå¦‚ dev ã€test ã€prod ç­‰ç­‰ï¼Œå„ä¸ªç¯å¢ƒçš„é…ç½®éƒ½ä¼šä¸ä¸€æ ·ï¼Œåœ¨ä¼ ç»Ÿçš„å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬éƒ½æ˜¯åœ¨è¿›è¡Œæ‰“åŒ…çš„æ—¶å€™è¿›è¡Œäººå·¥å¹²é¢„ï¼Œæˆ–è€…å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ç³»ç»Ÿå¤–éƒ¨ï¼ŒåŠ è½½çš„æ—¶å€™æŒ‡å®šåŠ è½½ç›®å½•ï¼Œè¿™ç§æ–¹å¼å®¹æ˜“å‡ºé”™ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒå¥½çš„æ–¹å¼æ¥è§£å†³è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p><p>æœ‰ï¼Œ<strong>åˆ©ç”¨ PropertyPlaceholderConfigurer çš„ç‰¹æ€§æ¥åŠ¨æ€åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå®ç°å¤šç¯å¢ƒåˆ‡æ¢</strong>ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰å››ä¸ª Properties æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://gitee.com/chenssy/blog-home/raw/master/image/201811/15374242055683.jpg"><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/26/15374242055683_YcHOyX.jpg" alt="img"></a></p><p>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application-dev.properties</span></span><br><span class="line"><span class="meta">student.name</span>=<span class="string">chenssy-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># application-test.properties</span></span><br><span class="line"><span class="meta">student.name</span>=<span class="string">chenssy-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># application-prod.properties</span></span><br><span class="line"><span class="meta">student.name</span>=<span class="string">chenssy-prod</span></span><br></pre></td></tr></table></figure><p>ç„¶åå®ç°ä¸€ä¸ªç±»ï¼Œè¯¥ç±»ç»§æ‰¿ PropertyPlaceholderConfigurerï¼Œå®ç° <code>loadProperties()</code>ï¼Œæ ¹æ®ç¯å¢ƒçš„ä¸åŒåŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPropertyConfig</span> <span class="keyword">extends</span> <span class="title">PropertyPlaceholderConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Resource[] locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PropertiesPersister propertiesPersister = <span class="keyword">new</span> DefaultPropertiesPersister();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocations</span><span class="params">(Resource[] locations)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.locations = locations;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocalOverride</span><span class="params">(<span class="keyword">boolean</span> localOverride)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.localOverride = localOverride;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œæ ¹æ®å¯åŠ¨å‚æ•°ï¼ŒåŠ¨æ€è¯»å–é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> props</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadProperties</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (locations != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// locations é‡Œé¢å°±å·²ç»åŒ…å«äº†é‚£ä¸‰ä¸ªå®šä¹‰çš„æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">for</span> (Resource location : <span class="keyword">this</span>.locations) &#123;</span><br><span class="line">                InputStream is = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String filename = location.getFilename();</span><br><span class="line">                    String env = <span class="string">&quot;application-&quot;</span> + System.getProperty(<span class="string">&quot;spring.profiles.active&quot;</span>, <span class="string">&quot;dev&quot;</span>) + <span class="string">&quot;.properties&quot;</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶ï¼ŒåŠ è½½</span></span><br><span class="line">                    <span class="keyword">if</span> (filename.contains(env)) &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;Loading properties file from &quot;</span> + location);</span><br><span class="line">                        is = location.getInputStream();</span><br><span class="line">                        <span class="keyword">this</span>.propertiesPersister.load(props, is);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥.....&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        is.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;PropertyPlaceholderConfigurer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.custom.CustomPropertyConfig&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;locations&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:config/application-dev.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:config/application-test.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:config/application-prod.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;student.name&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ idea çš„ VM options é‡Œé¢å¢åŠ  <code>-Dspring.profiles.active=dev</code>ï¼Œæ ‡å¿—å½“å‰ç¯å¢ƒä¸º dev ç¯å¢ƒã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">StudentService studentService = (StudentService) context.getBean(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;student name:&quot;</span> + studentService.getName());</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">student name:chenssy-dev</span><br></pre></td></tr></table></figure><p>å½“å°† <code>-Dspring.profiles.active</code> è°ƒæ•´ä¸º testï¼Œåˆ™æ‰“å°ç»“æœåˆ™æ˜¯ chenssy-testï¼Œè¿™æ ·å°±å®Œå…¨å®ç°äº†æ ¹æ®ä¸åŒçš„ç¯å¢ƒåŠ è½½ä¸åŒçš„é…ç½®ï¼Œå¦‚æœå„ä½ç”¨è¿‡ Spring Boot çš„è¯ï¼Œè¿™ä¸ªå°±å®Œå…¨æ˜¯ Spring Boot é‡Œé¢çš„ profiles.active ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒPropertyPlaceholderConfigurer å¯¹äºå±æ€§çš„é…ç½®éå¸¸çµæ´»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æPropertyPlaceholderConfigurer</title>
      <link href="/blog/2020/01/23/99d35216.html"/>
      <url>/blog/2020/01/23/99d35216.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3837">http://cmsblogs.com/?p=3837</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨ä¸Šæ–‡ <a href="/2020/01/23/81b83a69.html">IOC ä¹‹ æ·±å…¥åˆ†æ BeanFactoryPostProcessor</a> ä»‹ç»äº† BeanFactoryPostProcessorï¼ŒçŸ¥é“ BeanFactoryPostProcessor ä½œç”¨åŸŸå®¹å™¨å¯åŠ¨é˜¶æ®µï¼Œå¯ä»¥å¯¹è§£æå¥½çš„ BeanDefinition è¿›è¡Œå®šåˆ¶åŒ–å¤„ç†ï¼Œè€Œå…¶ä¸­ PropertyPlaceholderConfigurer æ˜¯å…¶ä¸€ä¸ªéå¸¸é‡è¦çš„åº”ç”¨ï¼Œä¹Ÿæ˜¯å…¶å­ç±»ï¼Œä»‹ç»å¦‚ä¸‹ï¼š</p><blockquote><p>PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬ç”¨ Properties æ–‡ä»¶ä¸­çš„å±æ€§æ¥å®šä¹‰åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆé…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£ï¼‰</p></blockquote><p>ä»€ä¹ˆæ„æ€ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ï¼ˆæˆ–è€…å…¶ä»–æ–¹å¼ï¼Œå¦‚æ³¨è§£æ–¹å¼ï¼‰ä¸­ä½¿ç”¨å ä½ç¬¦çš„æ–¹å¼æ¥å®šä¹‰ä¸€äº›èµ„æºï¼Œå¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºé…ç½®åˆ° Properties ä¸­ï¼Œè¿™æ ·åªéœ€è¦å¯¹ Properties æ–‡ä»¶è¿›è¡Œä¿®æ”¹å³å¯ï¼Œè¿™ä¸ªç‰¹æ€§éå¸¸ï¼Œåœ¨åé¢æ¥ä»‹ç»ä¸€ç§æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ç”¨åˆ°åœºæ™¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/26/201809161001_Jd3Eac_N7lPj5.png" alt="201809161001"></p><p>ä» PropertyPlaceholderConfigurer çš„ç»“æ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå®ƒé—´æ¥å®ç°äº† Aware å’Œ BeanFactoryPostProcessor ä¸¤å¤§æ‰©å±•æ¥å£ï¼Œè¿™é‡Œåªéœ€è¦å…³æ³¨ BeanFactoryPostProcessor å³å¯ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ BeanFactoryPostProcessor æä¾›äº† <code>postProcessBeanFactory()</code>ï¼Œåœ¨è¿™ä¸ªä½“ç³»ä¸­è¯¥æ–¹æ³•çš„æ˜¯åœ¨ PropertyResourceConfigurer ä¸­å®ç°ï¼Œè¯¥ç±»ä¸ºå±æ€§èµ„æºçš„é…ç½®ç±»ï¼Œä»–å®ç°äº† BeanFactoryPostProcessor æ¥å£ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">  Properties mergedProps = mergeProperties();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬æ¢åˆå¹¶å±æ€§</span></span><br><span class="line">  convertProperties(mergedProps);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å­ç±»å¤„ç†</span></span><br><span class="line">  processProperties(beanFactory, mergedProps);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">&quot;Could not load properties&quot;</span>, ex);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>mergeProperties()</code>ï¼šè¿”å›åˆå¹¶çš„ Properties å®ä¾‹ï¼ŒProperties å®ä¾‹ç»´æŠ¤è¿™ä¸€ç»„ key-value ï¼Œå…¶å®å°±æ˜¯ Properties é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</li><li><code>convertProperties()</code>ï¼šè½¬æ¢åˆå¹¶çš„å€¼ï¼Œå…¶å®å°±æ˜¯å°†åŸå§‹å€¼æ›¿æ¢ä¸ºçœŸæ­£çš„å€¼</li><li><code>processProperties()</code>ï¼šå‰é¢ä¸¤ä¸ªæ­¥éª¤å·²ç»å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼è¿›è¡Œäº†å¤„ç†ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±æ˜¯çœŸæ­£çš„æ›¿æ¢è¿‡ç¨‹ï¼Œè¯¥æ–¹æ³•ç”±å­ç±»å®ç°ã€‚</li></ul><p>åœ¨ PropertyPlaceholderConfigurer é‡å†™ <code>processProperties()</code>:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processProperties</span><span class="params">(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"> StringValueResolver valueResolver = <span class="keyword">new</span> PlaceholderResolvingStringValueResolver(props);</span><br><span class="line"> doProcessProperties(beanFactoryToProcess, valueResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ„é€ ä¸€ä¸ª PlaceholderResolvingStringValueResolver ç±»å‹çš„ StringValueResolver å®ä¾‹ã€‚StringValueResolver ä¸ºä¸€ä¸ªè§£æ String ç±»å‹å€¼çš„ç­–ç•¥æ¥å£ï¼Œè¯¥æ¥å£æä¾›äº† <code>resolveStringValue()</code> æ–¹æ³•ç”¨äºè§£æ String å€¼ã€‚PlaceholderResolvingStringValueResolver ä¸ºå…¶ä¸€ä¸ªè§£æç­–ç•¥ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PlaceholderResolvingStringValueResolver</span><span class="params">(Properties props)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">this</span>.helper = <span class="keyword">new</span> PropertyPlaceholderHelper(</span><br><span class="line">   placeholderPrefix, placeholderSuffix, valueSeparator, ignoreUnresolvablePlaceholders);</span><br><span class="line"> <span class="keyword">this</span>.resolver = <span class="keyword">new</span> PropertyPlaceholderConfigurerResolver(props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€  String å€¼è§£æå™¨ StringValueResolver æ—¶ï¼Œå°†å·²ç»è§£æçš„ Properties å®ä¾‹å¯¹è±¡å°è£…åœ¨ PlaceholderResolver å®ä¾‹ resolver ä¸­ã€‚PlaceholderResolver æ˜¯ä¸€ä¸ªç”¨äºè§£æå­—ç¬¦ä¸²ä¸­åŒ…å«å ä½ç¬¦çš„æ›¿æ¢å€¼çš„ç­–ç•¥æ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ª <code>resolvePlaceholder()</code> æ–¹æ³•ï¼Œç”¨äºè¿”å›å ä½ç¬¦çš„æ›¿æ¢å€¼ã€‚è¿˜æœ‰ä¸€ä¸ª PropertyPlaceholderHelper å·¥å…·ï¼Œä»åå­—ä¸Šé¢çœ‹åº”è¯¥æ˜¯è¿›è¡Œæ›¿æ¢çš„ã€‚</p><p>å¾—åˆ° String è§£æå™¨çš„å®ä¾‹ valueResolver åï¼Œåˆ™ä¼šè°ƒç”¨ <code>doProcessProperties()</code> æ–¹æ³•æ¥è¿›è¡Œè¯Šæ²»çš„æ›¿æ¢æ“ä½œï¼Œè¯¥æ–¹æ³•åœ¨çˆ¶ç±» PlaceholderConfigurerSupport ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doProcessProperties</span><span class="params">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  StringValueResolver valueResolver)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> BeanDefinitionVisitor visitor = <span class="keyword">new</span> BeanDefinitionVisitor(valueResolver);</span><br><span class="line"></span><br><span class="line"> String[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();</span><br><span class="line"> <span class="keyword">for</span> (String curName : beanNames) &#123;</span><br><span class="line">  <span class="comment">// æ ¡éªŒ</span></span><br><span class="line">  <span class="comment">// 1. å½“å‰å®ä¾‹ PlaceholderConfigurerSupport ä¸åœ¨è§£æèŒƒå›´å†…</span></span><br><span class="line">     <span class="comment">// 2. åŒä¸€ä¸ª Spring å®¹å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (!(curName.equals(<span class="keyword">this</span>.beanName) &amp;&amp; beanFactoryToProcess.equals(<span class="keyword">this</span>.beanFactory))) &#123;</span><br><span class="line">   BeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">    visitor.visitBeanDefinition(bd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// åˆ«åçš„å ä½ç¬¦</span></span><br><span class="line"> beanFactoryToProcess.resolveAliases(valueResolver);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è§£æåµŒå…¥å€¼çš„å ä½ç¬¦ï¼Œä¾‹å¦‚æ³¨é‡Šå±æ€§</span></span><br><span class="line">       beanFactoryToProcess.addEmbeddedValueResolver(valueResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ ¹æ® String å€¼è§£æç­–ç•¥ valueResolver å¾—åˆ° BeanDefinitionVisitor å®ä¾‹ã€‚BeanDefinitionVisitor æ˜¯ BeanDefinition çš„è®¿é—®è€…ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒå¯ä»¥å®ç°å¯¹ BeanDefinition å†…å®¹çš„è¿›è¡Œè®¿é—®ï¼Œå†…å®¹å¾ˆå¤šï¼Œä¾‹å¦‚Scopeã€PropertyValuesã€FactoryMethodName ç­‰ç­‰ã€‚</li><li>å¾—åˆ°è¯¥å®¹å™¨çš„æ‰€æœ‰ BeanNameï¼Œç„¶åå¯¹å…¶è¿›è¡Œè®¿é—®ï¼ˆ<code>visitBeanDefinition()</code>ï¼‰ã€‚</li><li>è§£æåˆ«åçš„å ä½ç¬¦</li><li>è§£æåµŒå…¥å€¼çš„å ä½ç¬¦ï¼Œä¾‹å¦‚æ³¨é‡Šå±æ€§</li></ol><p>è¿™ä¸ªæ–¹æ³•æ ¸å¿ƒåœ¨äº <code>visitBeanDefinition()</code> çš„è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitBeanDefinition</span><span class="params">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line"> visitParentName(beanDefinition);</span><br><span class="line"> visitBeanClassName(beanDefinition);</span><br><span class="line"> visitFactoryBeanName(beanDefinition);</span><br><span class="line"> visitFactoryMethodName(beanDefinition);</span><br><span class="line"> visitScope(beanDefinition);</span><br><span class="line"> <span class="keyword">if</span> (beanDefinition.hasPropertyValues()) &#123;</span><br><span class="line">  visitPropertyValues(beanDefinition.getPropertyValues());</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (beanDefinition.hasConstructorArgumentValues()) &#123;</span><br><span class="line">  ConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();</span><br><span class="line">  visitIndexedArgumentValues(cas.getIndexedArgumentValues());</span><br><span class="line">  visitGenericArgumentValues(cas.getGenericArgumentValues());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•åŸºæœ¬è®¿é—®äº† BeanDefinition ä¸­æ‰€æœ‰å€¼å¾—è®¿é—®çš„ä¸œè¥¿äº†ï¼ŒåŒ…æ‹¬ parent ã€class ã€factory-bean ã€factory-method ã€scope ã€property ã€constructor-arg ï¼Œæœ¬ç¯‡æ–‡ç« çš„ä¸»é¢˜æ˜¯ propertyï¼Œæ‰€ä»¥å…³æ³¨ <code>visitPropertyValues()</code> å³å¯ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">visitPropertyValues</span><span class="params">(MutablePropertyValues pvs)</span> </span>&#123;</span><br><span class="line"> PropertyValue[] pvArray = pvs.getPropertyValues();</span><br><span class="line"> <span class="keyword">for</span> (PropertyValue pv : pvArray) &#123;</span><br><span class="line">  Object newVal = resolveValue(pv.getValue());</span><br><span class="line">  <span class="keyword">if</span> (!ObjectUtils.nullSafeEquals(newVal, pv.getValue())) &#123;</span><br><span class="line">   pvs.add(pv.getName(), newVal);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡ç¨‹å°±æ˜¯å¯¹å±æ€§æ•°ç»„è¿›è¡Œéå†ï¼Œè°ƒç”¨ <code>resolveValue()</code> å¯¹å±æ€§è¿›è¡Œè§£æè·å–æœ€æ–°å€¼ï¼Œå¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸ç­‰ï¼Œåˆ™ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼ã€‚<code>resolveValue()</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">resolveValue</span><span class="params">(<span class="meta">@Nullable</span> Object value)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// ç”±äº Properties ä¸­çš„æ˜¯ Stringï¼Œæ‰€ä»¥æŠŠå‰é¢ä¸€å † if å»æ‰</span></span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">  <span class="keyword">return</span> resolveStringValue((String) value);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé…ç½®çš„æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹ String ç›¸å…³çš„ï¼Œ<code>resolveStringValue()</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> String <span class="title">resolveStringValue</span><span class="params">(String strVal)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.valueResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No StringValueResolver specified - pass a resolver &quot;</span> +</span><br><span class="line">    <span class="string">&quot;object into the constructor or override the &#x27;resolveStringValue&#x27; method&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> String resolvedValue = <span class="keyword">this</span>.valueResolver.resolveStringValue(strVal);</span><br><span class="line"> <span class="keyword">return</span> (strVal.equals(resolvedValue) ? strVal : resolvedValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>valueResolver æ˜¯æˆ‘ä»¬åœ¨æ„é€  BeanDefinitionVisitor å®ä¾‹æ—¶ä¼ å…¥çš„ String ç±»å‹è§£æå™¨ PlaceholderResolvingStringValueResolverï¼Œè°ƒç”¨å…¶ <code>resolveStringValue()</code> å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">resolveStringValue</span><span class="params">(String strVal)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"> String resolved = <span class="keyword">this</span>.helper.replacePlaceholders(strVal, <span class="keyword">this</span>.resolver);</span><br><span class="line"> <span class="keyword">if</span> (trimValues) &#123;</span><br><span class="line">  resolved = resolved.trim();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> (resolved.equals(nullValue) ? <span class="keyword">null</span> : resolved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>helper ä¸º PropertyPlaceholderHelper å®ä¾‹å¯¹è±¡ï¼Œè€Œ PropertyPlaceholderHelper åˆ™æ˜¯å¤„ç†åº”ç”¨ç¨‹åºä¸­åŒ…å«å ä½ç¬¦çš„å­—ç¬¦ä¸²å·¥å…·ç±»ã€‚åœ¨æ„é€  helper å®ä¾‹å¯¹è±¡æ—¶éœ€è¦ä¼ å…¥äº†å‡ ä¸ªå‚æ•°ï¼šplaceholderPrefixã€placeholderSuffixã€valueSeparatorï¼Œè¿™äº›å€¼åœ¨ PlaceholderConfigurerSupport ä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> String placeholderPrefix = <span class="string">&quot;$&#123;&quot;</span>;</span><br><span class="line"><span class="keyword">protected</span> String placeholderSuffix = <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">protected</span> String valueSeparator = <span class="string">&quot;:&quot;</span>;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>replacePlaceholders()</code> è¿›è¡Œå ä½ç¬¦æ›¿æ¢ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replacePlaceholders</span><span class="params">(String value, PlaceholderResolver placeholderResolver)</span> </span>&#123;</span><br><span class="line"> Assert.notNull(value, <span class="string">&quot;&#x27;value&#x27; must not be null&quot;</span>);</span><br><span class="line"> <span class="keyword">return</span> parseStringValue(value, placeholderResolver, <span class="keyword">new</span> HashSet&lt;&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>parseStringValue()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¿™ç¯‡åšå®¢æœ€æ ¸å¿ƒçš„åœ°æ–¹ï¼Œ<code>$&#123;&#125;</code> å ä½ç¬¦çš„æ›¿æ¢ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">parseStringValue</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String value, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  StringBuilder result = <span class="keyword">new</span> StringBuilder(value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å‰ç¼€ &quot;$&#123;&quot; çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">  <span class="keyword">int</span> startIndex = value.indexOf(<span class="keyword">this</span>.placeholderPrefix);</span><br><span class="line">  <span class="keyword">while</span> (startIndex != -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– åç¼€ &quot;&#125;&quot; çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">    <span class="keyword">int</span> endIndex = findPlaceholderEndIndex(result, startIndex);</span><br><span class="line">    <span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æˆªå– &quot;$&#123;&quot; å’Œ &quot;&#125;&quot; ä¸­é—´çš„å†…å®¹ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„å€¼</span></span><br><span class="line">      String placeholder = result.substring(startIndex + <span class="keyword">this</span>.placeholderPrefix.length(), endIndex);</span><br><span class="line">      String originalPlaceholder = placeholder;</span><br><span class="line">      <span class="keyword">if</span> (!visitedPlaceholders.add(originalPlaceholder)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">          <span class="string">&quot;Circular placeholder reference &#x27;&quot;</span> + originalPlaceholder + <span class="string">&quot;&#x27; in property definitions&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è§£æå ä½ç¬¦é”®ä¸­åŒ…å«çš„å ä½ç¬¦ï¼ŒçœŸæ­£çš„å€¼</span></span><br><span class="line">      placeholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);</span><br><span class="line">      <span class="comment">// ä» Properties ä¸­è·å– placeHolder å¯¹åº”çš„å€¼ propVal</span></span><br><span class="line">      String propVal = placeholderResolver.resolvePlaceholder(placeholder);</span><br><span class="line">      <span class="comment">// å¦‚æœä¸å­˜åœ¨</span></span><br><span class="line">      <span class="keyword">if</span> (propVal == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.valueSeparator != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ : çš„ä½ç½®</span></span><br><span class="line">        <span class="keyword">int</span> separatorIndex = placeholder.indexOf(<span class="keyword">this</span>.valueSeparator);</span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨ :</span></span><br><span class="line">        <span class="keyword">if</span> (separatorIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// è·å– : å‰é¢éƒ¨åˆ† actualPlaceholder</span></span><br><span class="line">          String actualPlaceholder = placeholder.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">          <span class="comment">// è·å– : åé¢éƒ¨åˆ† defaultValue</span></span><br><span class="line">          String defaultValue = placeholder.substring(separatorIndex + <span class="keyword">this</span>.valueSeparator.length());</span><br><span class="line"></span><br><span class="line">          <span class="comment">// ä» Properties ä¸­è·å– actualPlaceholder å¯¹åº”çš„å€¼</span></span><br><span class="line">          propVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);</span><br><span class="line">          <span class="comment">// å¦‚æœä¸å­˜åœ¨ åˆ™è¿”å› defaultValue</span></span><br><span class="line">          <span class="keyword">if</span> (propVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">            propVal = defaultValue;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (propVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">        propVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);</span><br><span class="line">        result.replace(startIndex, endIndex + <span class="keyword">this</span>.placeholderSuffix.length(), propVal);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">          logger.trace(<span class="string">&quot;Resolved placeholder &#x27;&quot;</span> + placeholder + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, startIndex + propVal.length());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.ignoreUnresolvablePlaceholders) &#123;</span><br><span class="line">        <span class="comment">// å¿½ç•¥å€¼</span></span><br><span class="line">        startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, endIndex + <span class="keyword">this</span>.placeholderSuffix.length());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Could not resolve placeholder &#x27;&quot;</span> +</span><br><span class="line">                                           placeholder + <span class="string">&quot;&#x27;&quot;</span> + <span class="string">&quot; in value \&quot;&quot;</span> + value + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      visitedPlaceholders.remove(originalPlaceholder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      startIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›propValï¼Œå°±æ˜¯æ›¿æ¢ä¹‹åçš„å€¼</span></span><br><span class="line">  <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹</p><ol><li>è·å–å ä½ç¬¦å‰ç¼€ â€œ${â€œ çš„ç´¢å¼•ä½ç½® startIndex</li><li>å¦‚æœå‰ç¼€ â€œ${â€œ å­˜åœ¨ï¼Œåˆ™ä» â€œ{â€ åé¢å¼€å§‹è·å–å ä½ç¬¦åç¼€ â€œ}â€ çš„ç´¢å¼•ä½ç½® endIndex</li><li>å¦‚æœå‰ç¼€ â€œ${â€ å’Œåç¼€ â€œ}â€ éƒ½å­˜åœ¨ï¼Œåˆ™æˆªå–ä¸­é—´éƒ¨åˆ† placeholder</li><li>ä» Properties ä¸­è·å– placeHolder å¯¹åº”çš„å€¼ propVal</li><li>å¦‚æœ propVal ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­å ä½ç¬¦ä¸­æ˜¯å¦å­˜åœ¨ â€œ:â€ï¼Œå¦‚æœå­˜åœ¨åˆ™å¯¹å ä½ç¬¦è¿›è¡Œåˆ†å‰²å¤„ç†ï¼Œå…¨é¢éƒ¨åˆ†ä¸º actualPlaceholderï¼Œåé¢éƒ¨åˆ† defaultValueï¼Œå°è¯•ä» Properties ä¸­è·å– actualPlaceholder å¯¹åº”çš„å€¼ propValï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°† defaultValue çš„å€¼èµ‹å€¼ç»™ propVal</li><li>è¿”å› propValï¼Œä¹Ÿå°±æ˜¯ Properties ä¸­å¯¹åº”çš„å€¼</li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æBeanFactoryPostProcessor</title>
      <link href="/blog/2020/01/23/81b83a69.html"/>
      <url>/blog/2020/01/23/81b83a69.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3342">http://cmsblogs.com/?p=3342</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p><p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨åšå®¢ <a href="/2020/01/22/aa8c9efa.html"> IOC ä¹‹ æ·±å…¥åˆ†æ BeanPostProcessor</a> æ·±å…¥ä»‹ç»äº† BeanPostProcessor çš„å®ç°æœºåˆ¶ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­æåˆ° BeanPostProcessor æ˜¯ Spring æä¾›ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸æˆ‘ä»¬åœ¨ Bean å®ä¾‹åŒ–ä¹‹ååˆå§‹åŒ–ä¹‹é™…å¯¹ Bean è¿›è¡Œå¢å¼ºå¤„ç†ï¼ˆå‰ã€åç½®å¤„ç†ï¼‰ã€‚</p><p>åŒæ ·åœ¨ Spring å®¹å™¨å¯åŠ¨é˜¶æ®µï¼ŒSpring ä¹Ÿæä¾›äº†ä¸€ç§å®¹å™¨æ‰©å±•æœºåˆ¶ï¼š<code>BeanFactoryPostProcessor</code>ï¼Œè¯¥æœºåˆ¶ä½œç”¨äºå®¹å™¨å¯åŠ¨é˜¶æ®µï¼Œå…è®¸æˆ‘ä»¬åœ¨å®¹å™¨å®ä¾‹åŒ– <code>Bean</code> ä¹‹å‰å¯¹æ³¨å†Œåˆ°è¯¥å®¹å™¨çš„ <code>BeanDefinition</code> åšå‡ºä¿®æ”¹ã€‚</p><h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>BeanFactoryPostProcessor çš„æœºåˆ¶å°±ç›¸å½“äºç»™äº†æˆ‘ä»¬åœ¨ bean å®ä¾‹åŒ–ä¹‹å‰æœ€åä¸€æ¬¡ä¿®æ”¹ BeanDefinition çš„æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºä¼šå¯¹ BeanDefinition æ¥è¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚æ›´æ”¹æŸäº› bean çš„ä¸€äº›å±æ€§ï¼Œç»™æŸäº› Bean å¢åŠ ä¸€äº›å…¶ä»–çš„ä¿¡æ¯ç­‰ç­‰æ“ä½œã€‚</p><p>å®šä¹‰å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 1ã€Modify the application context&#x27;s internal bean factory after its standard initialization.</span></span><br><span class="line"><span class="comment">  *  </span></span><br><span class="line"><span class="comment">  * 2ã€All bean definitions will have been loaded, but no beans will have been instantiated yet. This allows for overriding or adding properties even to eager-initializing beans.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> beanFactory the bean factory used by the application context</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanFactoryPostProcessor æ¥å£ä»…æœ‰ä¸€ä¸ª postProcessBeanFactory æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ª ConfigurableListableBeanFactory ç±»å‹çš„ beanFactory å‚æ•°ã€‚ä¸Šé¢æœ‰ä¸¤è¡Œæ³¨é‡Šï¼š</p><ul><li>1ã€è¡¨ç¤ºäº†è¯¥æ–¹æ³•çš„ä½œç”¨ï¼šåœ¨ standard initializationï¼ˆå®åœ¨æ˜¯ä¸çŸ¥é“è¿™ä¸ªæ€ä¹ˆç¿»è¯‘ï¼šæ ‡å‡†åˆå§‹åŒ–ï¼Ÿï¼‰ ä¹‹åï¼ˆå·²ç»å°±æ˜¯å·²ç»å®Œæˆäº† BeanDefinition çš„åŠ è½½ï¼‰å¯¹ bean factory å®¹å™¨è¿›è¡Œä¿®æ”¹ã€‚å…¶ä¸­å‚æ•° beanFactory åº”è¯¥å°±æ˜¯å·²ç»å®Œæˆäº† standard initialization çš„ BeanFactoryã€‚</li><li>2ã€è¡¨ç¤ºä½œç”¨æ—¶æœºï¼šæ‰€æœ‰çš„ BeanDefinition å·²ç»å®Œæˆäº†åŠ è½½å³åŠ è½½è‡³ BeanFactory ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚</li></ul><p>æ‰€ä»¥è¿™é‡Œæ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼š**<code>postProcessBeanFactory()</code> å·¥ä½œäºBeanDefinition åŠ è½½å®Œæˆä¹‹åï¼ŒBean å®ä¾‹åŒ–ä¹‹å‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¯¹åŠ è½½ BeanDefinition è¿›è¡Œä¿®æ”¹ã€‚**</p><p><u>æœ‰ä¸€ç‚¹éœ€è¦éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ <code>postProcessBeanFactory()</code> ä¸­åƒä¸‡ä¸èƒ½è¿›è¡Œ Bean çš„å®ä¾‹åŒ–å·¥ä½œï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´ bean è¿‡æ—©å®ä¾‹åŒ–ï¼Œä¼šäº§ç”Ÿä¸¥é‡åæœï¼Œæˆ‘ä»¬å§‹ç»ˆéœ€è¦æ³¨æ„çš„æ˜¯ BeanFactoryPostProcessor æ˜¯ä¸ BeanDefinition æ‰“äº¤é“çš„ï¼Œå¦‚æœæƒ³è¦ä¸ Bean æ‰“äº¤é“ï¼Œè¯·ä½¿ç”¨ BeanPostProcessorã€‚</u></p><p>ä¸ BeanPostProcessor ä¸€æ ·ï¼ŒBeanFactoryPostProcessor åŒæ ·æ”¯æŒæ’åºï¼Œä¸€ä¸ªå®¹å™¨å¯ä»¥åŒæ—¶æ‹¥æœ‰å¤šä¸ª BeanFactoryPostProcessorï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬æ¯”è¾ƒåœ¨ä¹ä»–ä»¬çš„é¡ºåºçš„è¯ï¼Œå¯ä»¥å®ç° Ordered æ¥å£ã€‚</p><p>å¦‚æœè¦è‡ªå®šä¹‰ BeanFactoryPostProcessor ç›´æ¥å®ç°è¯¥æ¥å£å³å¯ã€‚</p><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactoryPostProcessor_1</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span>,<span class="title">Ordered</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨ BeanFactoryPostProcessor_1 ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;å®¹å™¨ä¸­æœ‰ BeanDefinition çš„ä¸ªæ•°ï¼š&quot;</span> + beanFactory.getBeanDefinitionCount());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æŒ‡å®šçš„ BeanDefinition</span></span><br><span class="line">        BeanDefinition bd = beanFactory.getBeanDefinition(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MutablePropertyValues pvs = bd.getPropertyValues();</span><br><span class="line"></span><br><span class="line">        pvs.addPropertyValue(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;chenssy1&quot;</span>);</span><br><span class="line">        pvs.addPropertyValue(<span class="string">&quot;age&quot;</span>,<span class="number">15</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactoryPostProcessor_2</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> , <span class="title">Ordered</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨ BeanFactoryPostProcessor_2 ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æŒ‡å®šçš„ BeanDefinition</span></span><br><span class="line">        BeanDefinition bd = beanFactory.getBeanDefinition(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        MutablePropertyValues pvs = bd.getPropertyValues();</span><br><span class="line"></span><br><span class="line">        pvs.addPropertyValue(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æä¾›äº†ä¸¤ä¸ªè‡ªå®šä¹‰çš„ BeanFactoryPostProcessor ï¼Œéƒ½ç»§æ‰¿ BeanFactoryPostProcessor å’Œ Orderedï¼Œå…¶ä¸­ BeanFactoryPostProcessor_1 æ”¹å˜ name å’Œ age çš„å€¼ï¼ŒBeanFactoryPostProcessor_2 è¯¥å˜ age çš„å€¼ã€‚Ordered åˆ†åˆ«ä¸º 1 å’Œ 2ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;chenssy&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test.BeanFactoryPostProcessor_1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test.BeanFactoryPostProcessor_2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>studentService è®¾ç½® name å’Œ age åˆ†åˆ«ä¸º chenss å’Œ 10ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">StudentService studentService = (StudentService) context.getBean(<span class="string">&quot;studentService&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;student name:&quot;</span> + studentService.getName() + <span class="string">&quot;-- age:&quot;</span> + studentService.getAge());</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è°ƒç”¨ BeanFactoryPostProcessor_1 ...</span><br><span class="line">å®¹å™¨ä¸­æœ‰ BeanDefinition çš„ä¸ªæ•°ï¼š3</span><br><span class="line">è°ƒç”¨ BeanFactoryPostProcessor_2 ...</span><br><span class="line">student name:chenssy1-- age:18</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿è¡Œç»“æœï¼Œå…¶å®å¯¹ä¸Šé¢çš„è¿è¡Œæµç¨‹å°±å·²ç»ä¸€æ¸…äºŒæ¥šäº†ã€‚è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ã€‚</p><p>åœ¨ä¸Šé¢æµ‹è¯•æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ ApplicationContext ï¼Œå¯¹äº ApplicationContext æ¥è¯´ï¼Œä½¿ç”¨ BeanFactoryPostProcessor éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºä»–ä¼šè‡ªåŠ¨è¯†åˆ«é…ç½®æ–‡ä»¶ä¸­çš„ BeanFactoryPostProcessor å¹¶ä¸”å®Œæˆæ³¨å†Œå’Œè°ƒç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•çš„é…ç½®å£°æ˜å³å¯ã€‚</p><p>è€Œå¯¹äº BeanFactory å®¹å™¨æ¥è¯´åˆ™ä¸è¡Œï¼Œä»–å’Œ BeanPostProcessor ä¸€æ ·éœ€è¦å®¹å™¨ä¸»åŠ¨å»è¿›è¡Œæ³¨å†Œè°ƒç”¨ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanFactoryPostProcessor_1 beanFactoryPostProcessor1 = <span class="keyword">new</span> BeanFactoryPostProcessor_1();</span><br><span class="line">beanFactoryPostProcessor1.postProcessBeanFactory(factory);</span><br></pre></td></tr></table></figure><p>è‡³äº ApplicationContext æ˜¯å¦‚ä½•è‡ªåŠ¨è¯†åˆ«å’Œè°ƒç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­åœ¨åˆ†æ ApplicationContext æ—¶ä¼šåšè¯¦ç»†è¯´æ˜çš„ï¼Œå½“ç„¶ï¼Œå¦‚æœæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æå‰çœ‹ã€‚</p><p>è¯šç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯ä¸ä¼šä¸»åŠ¨å»è‡ªå®šä¹‰ BeanFactoryPostProcessor ï¼Œå…¶å® Spring ä¸ºæˆ‘ä»¬æä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„ BeanFactoryPostProcessorï¼Œä»–ä»¬æ˜¯PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer ï¼Œå…¶ä¸­ PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å ä½ç¬¦å¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºå•ç‹¬é…ç½®åˆ°ç®€å•çš„ properties æ–‡ä»¶ä¸­æ¥åŠ è½½ï¼ŒPropertyOverrideConfigurer åˆ™å…è®¸æˆ‘ä»¬ä½¿ç”¨å ä½ç¬¦æ¥æ˜ç¡®è¡¨æ˜bean å®šä¹‰ä¸­çš„ property ä¸ properties æ–‡ä»¶ä¸­çš„å„é…ç½®é¡¹ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œè¿™ä¸¤ä¸ªç±»åœ¨æˆ‘ä»¬å¤§å‹é¡¹ç›®ä¸­æœ‰éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æInitializingBeanå’Œinit-method</title>
      <link href="/blog/2020/01/23/3af7524a.html"/>
      <url>/blog/2020/01/23/3af7524a.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3340">http://cmsblogs.com/?p=3340</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>Spring åœ¨ bean åˆå§‹åŒ–æ—¶è¿›è¡Œä¸‰ä¸ªæ£€æµ‹æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å¯¹ bean è¿›è¡Œä¸‰ä¸ªä¸åŒçš„å®šåˆ¶åŒ–å¤„ç†ï¼Œå‰é¢ä¸¤ç¯‡åšå®¢ <a href="/2020/01/22/26a31db5.html">IOC ä¹‹ æ·±å…¥åˆ†æ Aware æ¥å£</a> å’Œ <a href="/2020/01/22/aa8c9efa.html">IOC ä¹‹ æ·±å…¥åˆ†æ BeanPostProcessor</a> å·²ç»åˆ†æäº† Aware æ¥å£æ— å’Œ BeanPostProcessor æ¥å£ï¼Œè¿™ç¯‡åˆ†æ InitializingBean æ¥å£å’Œ init-method æ–¹æ³•ã€‚</p><h2 id="InitializingBean"><a href="#InitializingBean" class="headerlink" title="InitializingBean"></a>InitializingBean</h2><p>Spring çš„ InitializingBean æ¥å£ä¸º bean æä¾›äº†å®šä¹‰åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒä»…åŒ…å«äº†ä¸€ä¸ªæ–¹æ³•ï¼š<code>afterPropertiesSet()</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¯¥æ–¹æ³•åœ¨ BeanFactory è®¾ç½®å®Œäº†æ‰€æœ‰å±æ€§ä¹‹åè¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment">    * è¯¥æ–¹æ³•å…è®¸ bean å®ä¾‹è®¾ç½®äº†æ‰€æœ‰ bean å±æ€§æ—¶æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå¦‚æœè¯¥è¿‡ç¨‹å‡ºç°äº†é”™è¯¯åˆ™éœ€è¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring åœ¨å®Œæˆå®ä¾‹åŒ–åï¼Œè®¾ç½®å®Œæ‰€æœ‰å±æ€§ï¼Œè¿›è¡Œ â€œAware æ¥å£â€ å’Œ â€œBeanPostProcessor å‰ç½®å¤„ç†â€ä¹‹åï¼Œä¼šæ¥ç€æ£€æµ‹å½“å‰ bean å¯¹è±¡æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè°ƒç”¨å…¶ <code>afterPropertiesSet()</code> è¿›ä¸€æ­¥è°ƒæ•´ bean å®ä¾‹å¯¹è±¡çš„çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializingBeanTest</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;InitializingBeanTest initializing...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">&quot;chenssy 2 å·&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®é¡¹</span></span><br><span class="line">&lt;bean id=<span class="string">&quot;initializingBeanTest&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;chenssy 1 å·&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line">InitializingBeanTest test = (InitializingBeanTest) factory.getBean(<span class="string">&quot;initializingBeanTest&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;name ï¼š&quot;</span> + test.getName());</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/26/15354197568939_ONaKC8_2DYPnU.jpg" alt="img"></p><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­æ”¹å˜äº† InitializingBeanTest ç¤ºä¾‹çš„ name å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ åœ¨ <code>afterPropertiesSet()</code> ä¸­æˆ‘ä»¬æ˜¯å¯ä»¥æ”¹å˜ bean çš„å±æ€§çš„ï¼Œè¿™ç›¸å½“äº Spring å®¹å™¨åˆç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§å¯ä»¥æ”¹å˜ bean å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ã€‚</p><p>ä¸Šé¢æåˆ° bean åˆå§‹åŒ–é˜¶æ®µï¼ˆ<code>initializeBean()</code> ï¼‰ Spring å®¹å™¨ä¼šä¸»åŠ¨æ£€æŸ¥å½“å‰ bean æ˜¯å¦å·²ç»å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™ä¼šè°ƒç”¨å…¶ <code>afterPropertiesSet()</code> ,è¿™ä¸ªä¸»åŠ¨æ£€æŸ¥ã€è°ƒç”¨çš„åŠ¨ä½œæ˜¯ç”± <code>invokeInitMethods()</code> æ¥å®Œæˆçš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeInitMethods</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å®ç° InitializingBean</span></span><br><span class="line">  <span class="comment">// å¦‚æœå®ç°äº† InitializingBean æ¥å£ï¼Œåˆ™åªæ‰è°ƒç”¨beançš„ afterPropertiesSet()</span></span><br><span class="line">  <span class="keyword">boolean</span> isInitializingBean = (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">  <span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="keyword">null</span> || </span><br><span class="line">                             !mbd.isExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">          ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;, getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> pae.getException();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç›´æ¥è°ƒç”¨ afterPropertiesSet()</span></span><br><span class="line">      ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mbd != <span class="keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº† init-method()ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¦‚æœæŒ‡å®šäº† init-method()ï¼Œåˆ™å†è°ƒç”¨åˆ¶å®šçš„init-method</span></span><br><span class="line">    String initMethodName = mbd.getInitMethodName();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">        !(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">        !mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">      <span class="comment">// åˆ©ç”¨åå°„æœºåˆ¶æ‰§è¡Œ</span></span><br><span class="line">      invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ£€æµ‹å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™è°ƒç”¨å…¶ <code>afterPropertiesSet()</code>ï¼Œç„¶åå†æ£€æŸ¥æ˜¯å¦ä¹ŸæŒ‡å®šäº† <code>init-method()</code>ï¼Œå¦‚æœæŒ‡å®šäº†åˆ™é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æŒ‡å®šçš„ <code>init-method()</code>ã€‚</p><p>è™½ç„¶è¯¥æ¥å£ä¸º Spring å®¹å™¨çš„æ‰©å±•æ€§ç«‹ä¸‹äº†æ±—é©¬åŠŸåŠ³ï¼Œä½†æ˜¯å¦‚æœçœŸçš„è®©æˆ‘ä»¬çš„ä¸šåŠ¡å¯¹è±¡æ¥å®ç°è¿™ä¸ªæ¥å£å°±æ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆçš„å‹å¥½äº†ï¼ŒSpring çš„ä¸€ä¸ªæ ¸å¿ƒç†å¿µå°±æ˜¯æ— ä¾µå…¥æ€§ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸šåŠ¡ç±»å®ç°è¿™ä¸ªæ¥å£å°±æ˜¾å¾— Spring å®¹å™¨å…·æœ‰ä¾µå…¥æ€§äº†ã€‚</p><p>æ‰€ä»¥ Spring è¿˜æä¾›äº†å¦å¤–ä¸€ç§å®ç°çš„æ–¹å¼ï¼šinit-method æ–¹æ³•</p><h2 id="init-method"><a href="#init-method" class="headerlink" title="init-method()"></a>init-method()</h2><p>åœ¨åˆ†æåˆ†æ <code>&lt;bean&gt;</code> æ ‡ç­¾è§£æè¿‡ç¨‹ä¸­æˆ‘ä»¬æåˆ°äº†æœ‰å…³äº <code>init-method</code> å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºåœ¨ bean åˆå§‹åŒ–æ—¶æŒ‡å®šæ‰§è¡Œæ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥æ›¿ä»£å®ç° InitializingBean æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializingBeanTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOtherName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;InitializingBeanTest setOtherName...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">&quot;chenssy 3 å·&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;initializingBeanTest&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">&quot;setOtherName&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;chenssy 1 å·&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ:</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/26/15354257803206_Yefysp_F6Dnx8.jpg" alt="img"></p><p>å®Œå…¨å¯ä»¥è¾¾åˆ°å’Œ InitializingBean ä¸€æ ·çš„æ•ˆæœï¼Œè€Œä¸”åœ¨ä»£ç ä¸­æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°ä¸æ¯« Spring ä¾µå…¥çš„ç°è±¡ã€‚</p><p>æ‰€ä»¥é€šè¿‡ init-method æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸šåŠ¡å¯¹è±¡ä¸­å®šä¹‰çš„ä»»ä½•æ–¹æ³•æ¥å®ç° bean å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–å®šåˆ¶åŒ–ï¼Œè€Œä¸å†å—åˆ¶äº InitializingBeançš„ <code>afterPropertiesSet()</code>ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>&lt;beans&gt;</code> æ ‡ç­¾çš„ <code>default-init-method</code> å±æ€§æ¥ç»Ÿä¸€æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™æ ·å°±çœäº†éœ€è¦åœ¨æ¯ä¸ª <code>&lt;bean&gt;</code> æ ‡ç­¾ä¸­éƒ½è®¾ç½® <code>init-method</code> è¿™æ ·çš„ç¹çå·¥ä½œäº†ã€‚</p><p>æ¯”å¦‚åœ¨ <code>default-init-method</code> è§„å®šæ‰€æœ‰åˆå§‹åŒ–æ“ä½œå…¨éƒ¨ä»¥ <code>initBean()</code> å‘½åã€‚å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/26/15354267698650_XG0QGi_5BPa8h.jpg" alt="img"></p><p>ä» <code>invokeInitMethods()</code> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ <code>init-method</code> æŒ‡å®šçš„æ–¹æ³•ä¼šåœ¨ <code>afterPropertiesSet()</code> ä¹‹åæ‰§è¡Œï¼Œå¦‚æœ <code>afterPropertiesSet()</code> ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™ <code>init-method</code> æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œè€Œä¸”ç”±äº <code>init-method</code> é‡‡ç”¨çš„æ˜¯åå°„æ‰§è¡Œçš„æ–¹å¼ï¼Œæ‰€ä»¥ <code>afterPropertiesSet()</code> çš„æ‰§è¡Œæ•ˆç‡ä¸€èˆ¬ä¼šé«˜äº›ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ’é™¤æˆ‘ä»¬è¦ä¼˜å…ˆä½¿ç”¨ <code>init-method</code>ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæ¶ˆé™¤äº† bean å¯¹ Spring çš„ä¾èµ–ï¼ŒSpring æ²¡æœ‰ä¾µå…¥åˆ°æˆ‘ä»¬ä¸šåŠ¡ä»£ç ï¼Œè¿™æ ·ä¼šæ›´åŠ ç¬¦åˆ Spring çš„ç†å¿µã€‚</p><p>è¯šç„¶ï¼Œ<code>init-method</code> æ˜¯åŸºäº xml é…ç½®æ–‡ä»¶çš„ï¼Œå°±ç›®å‰è€Œè¨€ï¼Œæˆ‘ä»¬çš„å·¥ç¨‹å‡ ä¹éƒ½æ‘’å¼ƒäº†é…ç½®ï¼Œè€Œé‡‡ç”¨æ³¨é‡Šçš„æ–¹å¼ï¼Œé‚£ä¹ˆ <code>@PreDestory</code> å¯èƒ½é€‚åˆä½ ï¼Œå½“ç„¶è¿™ä¸ªæ³¨è§£æˆ‘ä»¬åé¢åˆ†æã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æBeanPostProcessor</title>
      <link href="/blog/2020/01/22/aa8c9efa.html"/>
      <url>/blog/2020/01/22/aa8c9efa.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3338">http://cmsblogs.com/?p=3338</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>Spring ä½œä¸ºä¼˜ç§€çš„å¼€æºæ¡†æ¶ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸°å¯Œçš„å¯æ‰©å±•ç‚¹ï¼Œé™¤äº†å‰é¢æåˆ°çš„ Aware æ¥å£ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„å°±æ˜¯ BeanPostProcessorã€‚</p><p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» BeanPostProcessor çš„ä½¿ç”¨ä»¥åŠå…¶å®ç°åŸç†ã€‚æˆ‘ä»¬å…ˆçœ‹ BeanPostProcessor çš„å®šä½ï¼š</p><blockquote><p>BeanPostProcessor çš„ä½œç”¨ï¼šåœ¨ Bean å®Œæˆå®ä¾‹åŒ–åï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œä¸€äº›é…ç½®ã€å¢åŠ ä¸€äº›è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ BeanPostProcessorã€‚</p></blockquote><h2 id="BeanPostProcessor-å®ä¾‹"><a href="#BeanPostProcessor-å®ä¾‹" class="headerlink" title="BeanPostProcessor å®ä¾‹"></a>BeanPostProcessor å®ä¾‹</h2><p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªç±»ï¼Œè¯¥ç±»å®ç° BeanPostProcessor æ¥å£ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanPostProcessorTest</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bean [&quot;</span> + beanName + <span class="string">&quot;] å¼€å§‹åˆå§‹åŒ–&quot;</span>);</span><br><span class="line">        <span class="comment">// è¿™é‡Œä¸€å®šè¦è¿”å› beanï¼Œä¸èƒ½è¿”å› null</span></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bean [&quot;</span> + beanName + <span class="string">&quot;] å®Œæˆåˆå§‹åŒ–&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello BeanPostProcessor!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">reader.loadBeanDefinitions(resource);</span><br><span class="line"></span><br><span class="line">BeanPostProcessorTest test = (BeanPostProcessorTest) factory.getBean(<span class="string">&quot;beanPostProcessorTest&quot;</span>);</span><br><span class="line">test.display();</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808221005_JdCfC6.png" alt="201808221005"></p><p>è¿è¡Œç»“æœæ¯”è¾ƒå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡Œ <code>postProcessBeforeInitialization()</code> å’Œ <code>postProcessAfterInitialization()</code> å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ debug è·Ÿè¸ªä¸‹ä»£ç ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ <code>initializeBean()</code> æ–¹æ³•å¤„è°ƒç”¨ä¸‹ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808221006_MDs9T9_IIu6YA.png" alt="201808221006"></p><p>debugï¼Œåœ¨ <code>postProcessBeforeInitialization()</code>æ–¹æ³•ä¸­ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/15349468564658_aWOjeh_jNYP3X.jpg" alt="img"></p><p>è¿™æ®µä»£ç æ˜¯é€šè¿‡è¿­ä»£ <code>getBeanPostProcessors()</code> è¿”å›çš„ç»“æœé›†æ¥è°ƒç”¨ <code>postProcessBeforeInitialization()</code>ï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°è¯¥æ–¹æ³•è¿”å›çš„ç»“æœé›†ä¸ºç©ºï¼Œæ‰€ä»¥è‚¯å®šä¸ä¼šæ‰§è¡Œç›¸åº”çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•å’¯ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p>ç­”æ¡ˆä¸è¨€è€Œå–»ï¼šåªéœ€è¦ <code>getBeanPostProcessors()</code> è¿”å›çš„ç»“æœé›†ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªå…ƒç´ å³å¯ï¼Œè¯¥æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BeanPostProcessor&gt; <span class="title">getBeanPostProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">this</span>.beanPostProcessors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„ beanPostProcessors æ˜¯ä¸€ä¸ª private çš„ List ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦è¯¥ç±»ä¸­å­˜åœ¨ <code>beanPostProcessors.add()</code> çš„è°ƒç”¨æˆ‘ä»¬å°±æ‰¾åˆ°äº†å…¥å£ï¼Œåœ¨ç±» AbstractBeanFactory ä¸­æ‰¾åˆ°äº†å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBeanPostProcessor</span><span class="params">(BeanPostProcessor beanPostProcessor)</span> </span>&#123;</span><br><span class="line"> Assert.notNull(beanPostProcessor, <span class="string">&quot;BeanPostProcessor must not be null&quot;</span>);</span><br><span class="line"> <span class="keyword">this</span>.beanPostProcessors.remove(beanPostProcessor);</span><br><span class="line"> <span class="keyword">this</span>.beanPostProcessors.add(beanPostProcessor);</span><br><span class="line"> <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">  <span class="keyword">this</span>.hasInstantiationAwareBeanPostProcessors = <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> DestructionAwareBeanPostProcessor) &#123;</span><br><span class="line">  <span class="keyword">this</span>.hasDestructionAwareBeanPostProcessors = <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯ç”± AbstractBeanFactory çš„çˆ¶ç±» ConfigurableBeanFactory å®šä¹‰ï¼Œå®ƒçš„æ ¸å¿ƒæ„æ€å°±æ˜¯å°†æŒ‡å®š BeanPostProcessor æ³¨å†Œåˆ°è¯¥ BeanFactory åˆ›å»ºçš„ bean ä¸­ï¼ŒåŒæ—¶å®ƒæ˜¯æŒ‰ç…§æ’å…¥çš„é¡ºåºè¿›è¡Œæ³¨å†Œçš„ï¼Œå®Œå…¨å¿½ç•¥ Ordered æ¥å£æ‰€è¡¨è¾¾ä»»ä½•æ’åºè¯­ä¹‰ï¼ˆåœ¨ BeanPostProcessor ä¸­æˆ‘ä»¬æä¾›ä¸€ä¸ª Ordered é¡ºåºï¼Œè¿™ä¸ªåé¢è®²è§£ï¼‰ã€‚</p><p>åˆ°è¿™é‡Œåº”è¯¥å°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå…¶å®åªéœ€è¦æ˜¾ç¤ºè°ƒç”¨ <code>addBeanPostProcessor()</code> å°±å¯ä»¥äº†ï¼ŒåŠ å…¥å¦‚ä¸‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanPostProcessorTest beanPostProcessorTest = <span class="keyword">new</span> BeanPostProcessorTest();</span><br><span class="line">factory.addBeanPostProcessor(beanPostProcessorTest);</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/15349479459608_naPbOK_jwAf6w.jpg" alt="img"></p><p>å…¶å®è¿˜æœ‰ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢å†è¯´ï¼Œå…ˆçœ‹ BeanPostProcessor çš„åŸç†ã€‚</p><h2 id="BeanPostProcessor-åŸºæœ¬åŸç†"><a href="#BeanPostProcessor-åŸºæœ¬åŸç†" class="headerlink" title="BeanPostProcessor åŸºæœ¬åŸç†"></a>BeanPostProcessor åŸºæœ¬åŸç†</h2><p>BeanPostProcessor æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> </span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanPostProcessor å¯ä»¥ç†è§£ä¸ºæ˜¯ Spring çš„ä¸€ä¸ªå·¥å‚é’©å­ï¼ˆå…¶å® Spring æä¾›ä¸€ç³»åˆ—çš„é’©å­ï¼Œå¦‚ Aware ã€InitializingBeanã€DisposableBeanï¼‰ï¼Œå®ƒæ˜¯ Spring æä¾›çš„å¯¹è±¡å®ä¾‹åŒ–é˜¶æ®µå¼ºæœ‰åŠ›çš„æ‰©å±•ç‚¹ï¼Œå…è®¸ Spring åœ¨å®ä¾‹åŒ– bean é˜¶æ®µå¯¹å…¶è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œæ¯”è¾ƒå¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯å¤„ç†æ ‡è®°æ¥å£å®ç°ç±»æˆ–è€…ä¸ºå½“å‰å¯¹è±¡æä¾›ä»£ç†å®ç°ï¼ˆä¾‹å¦‚AOPï¼‰ã€‚</p><p>ä¸€èˆ¬æ™®é€šçš„ BeanFactory æ˜¯ä¸æ”¯æŒè‡ªåŠ¨æ³¨å†Œ BeanPostProcessor çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨ <code>addBeanPostProcessor()</code> è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œåçš„ BeanPostProcessor é€‚ç”¨äºæ‰€æœ‰è¯¥ BeanFactory åˆ›å»ºçš„ beanï¼Œä½†æ˜¯ ApplicationContext å¯ä»¥åœ¨å…¶ bean å®šä¹‰ä¸­è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰çš„ BeanPostProcessor å¹¶è‡ªåŠ¨å®Œæˆæ³¨å†Œï¼ŒåŒæ—¶å°†ä»–ä»¬åº”ç”¨åˆ°éšååˆ›å»ºçš„ä»»ä½• bean ä¸­ã€‚</p><p><code>postProcessBeforeInitialization()</code> å’Œ <code>postProcessAfterInitialization()</code> ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª Object ç±»å‹çš„ beanï¼Œä¸€ä¸ª String ç±»å‹çš„ beanNameï¼Œå…¶ä¸­ bean æ˜¯å·²ç»å®ä¾‹åŒ–äº†çš„ instanceBeanï¼Œèƒ½æ‹¿åˆ°è¿™ä¸ªä½ æ˜¯ä¸æ˜¯å¯ä»¥å¯¹å®ƒä¸ºæ‰€æ¬²ä¸ºäº†ï¼Ÿ è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯åˆå§‹åŒ– bean çš„å‰åç½®å¤„ç†å™¨ï¼Œä»–ä»¬åº”ç”¨ <code>invokeInitMethods()</code> å‰åã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808231001_GnvpHv_yyK7tM.png" alt="201808231001"></p><p>ä»£ç å±‚æ¬¡ä¸Šé¢å·²ç»è´´å‡ºæ¥ï¼Œè¿™é‡Œå†è´´ä¸€æ¬¡ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808221006_MDs9T9-20200525100713002_HB4JRD.png" alt="201808221006"></p><p>ä¸¤è€…æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"> Object result = existingBean;</span><br><span class="line"> <span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">  Object current = beanProcessor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">  <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  result = current;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"> Object result = existingBean;</span><br><span class="line"> <span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">  Object current = beanProcessor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">  <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  result = current;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getBeanPostProcessors()</code> è¿”å›çš„æ˜¯ beanPostProcessors é›†åˆï¼Œè¯¥é›†åˆé‡Œé¢å­˜æ”¾å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ BeanPostProcessorï¼Œå¦‚æœè¯¥é›†åˆä¸­å­˜åœ¨å…ƒç´ åˆ™è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ï¼Œå¦åˆ™å°±ç›´æ¥è¿”å› bean äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ BeanFactory å®¹å™¨æ˜¯æ— æ³•è¾“å‡ºè‡ªå®šä¹‰ BeanPostProcessor é‡Œé¢çš„å†…å®¹ï¼Œå› ä¸ºåœ¨ <code>BeanFactory.getBean()</code> çš„è¿‡ç¨‹ä¸­æ ¹æœ¬å°±æ²¡æœ‰å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ BeanPostProcessor æ³¨å…¥è¿›æ¥ï¼Œæ‰€ä»¥è¦æƒ³ BeanFactory å®¹å™¨ çš„ BeanPostProcessor ç”Ÿæ•ˆæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ <code>addBeanPostProcessor()</code> å°†å®šä¹‰çš„ BeanPostProcessor æ³¨å†Œåˆ°ç›¸åº”çš„ BeanFactory ä¸­ã€‚ä½†æ˜¯ ApplicationContext ä¸éœ€è¦æ‰‹åŠ¨ï¼Œå› ä¸º ApplicationContext ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å®Œæˆæ³¨å†Œã€‚</p><p>ApplicationContext å®ç°è‡ªåŠ¨æ³¨å†Œçš„åŸå› åœ¨äºæˆ‘ä»¬æ„é€ ä¸€ä¸ª ApplicationContext å®ä¾‹å¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨ <code>registerBeanPostProcessors()</code> æ–¹æ³•å°†æ£€æµ‹åˆ°çš„ BeanPostProcessor æ³¨å…¥åˆ° ApplicationContext å®¹å™¨ä¸­ï¼ŒåŒæ—¶åº”ç”¨åˆ°è¯¥å®¹å™¨åˆ›å»ºçš„ bean ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®ä¾‹åŒ–å¹¶è°ƒç”¨å·²ç»æ³¨å…¥çš„ BeanPostProcessor</span></span><br><span class="line"><span class="comment">     * å¿…é¡»åœ¨åº”ç”¨ä¸­ bean å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ‰€æœ‰çš„ BeanPostProcessor çš„ beanName</span></span><br><span class="line">  <span class="comment">// è¿™äº› beanName éƒ½å·²ç»å…¨éƒ¨åŠ è½½åˆ°å®¹å™¨ä¸­å»ï¼Œä½†æ˜¯æ²¡æœ‰å®ä¾‹åŒ–</span></span><br><span class="line">  String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•æ‰€æœ‰çš„beanProcessoræ•°é‡</span></span><br><span class="line">  <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œ BeanPostProcessorCheckerï¼Œå®ƒä¸»è¦æ˜¯ç”¨äºåœ¨ BeanPostProcessor å®ä¾‹åŒ–æœŸé—´è®°å½•æ—¥å¿—</span></span><br><span class="line">  <span class="comment">// å½“ Spring ä¸­é«˜é…ç½®çš„åç½®å¤„ç†å™¨è¿˜æ²¡æœ‰æ³¨å†Œå°±å·²ç»å¼€å§‹äº† bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ä¾¿ä¼šæ‰“å° BeanPostProcessorChecker ä¸­çš„å†…å®¹</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> PostProcessorRegistrationDelegate.BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PriorityOrdered ä¿è¯é¡ºåº</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// MergedBeanDefinitionPostProcessor</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ Ordered ä¿è¯é¡ºåº</span></span><br><span class="line">  List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// æ²¡æœ‰é¡ºåº</span></span><br><span class="line">  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="comment">// PriorityOrdered</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨ getBean è·å– bean å®ä¾‹å¯¹è±¡</span></span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      priorityOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">        internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ordered</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ— åº</span></span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€æ­¥æ³¨å†Œæ‰€æœ‰å®ç°äº† PriorityOrdered çš„BeanPostProcessor</span></span><br><span class="line">  <span class="comment">// å…ˆæ’åº</span></span><br><span class="line">  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">  <span class="comment">// åæ³¨å†Œ</span></span><br><span class="line">  registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬äºŒæ­¥æ³¨å†Œæ‰€æœ‰å®ç°äº† Ordered çš„ BeanPostProcessor</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    orderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸‰æ­¥æ³¨å†Œæ‰€æœ‰æ— åºçš„ BeanPostProcessor</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    nonOrderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åï¼Œæ³¨å†Œæ‰€æœ‰çš„ MergedBeanDefinitionPostProcessor ç±»å‹çš„ BeanPostProcessor</span></span><br><span class="line">  sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ å…¥ApplicationListenerDetectorï¼ˆæ¢æµ‹å™¨ï¼‰</span></span><br><span class="line">  <span class="comment">// é‡æ–°æ³¨å†Œ BeanPostProcessor ä»¥æ£€æµ‹å†…éƒ¨ beanï¼Œå› ä¸º ApplicationListeners å°†å…¶ç§»åŠ¨åˆ°å¤„ç†å™¨é“¾çš„æœ«å°¾</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•é¦–å…ˆ beanFactory è·å–æ³¨å†Œåˆ°è¯¥ BeanFactory ä¸­æ‰€æœ‰ BeanPostProcessor ç±»å‹çš„ beanNameï¼Œå…¶å®å°±æ˜¯æ‰¾æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ bean ï¼Œç„¶åè¿­ä»£è¿™äº› beanï¼Œå°†å…¶æŒ‰ç…§PriorityOrderedã€Orderedã€æ— åºçš„é¡ºåºæ·»åŠ è‡³ç›¸åº”çš„ List é›†åˆä¸­ï¼Œæœ€åä¾æ¬¡è°ƒç”¨ <code>sortPostProcessors()</code> è¿›è¡Œæ’åºå¤„ç†å’Œ <code>registerBeanPostProcessors()</code> å®Œæˆæ³¨å†Œã€‚æ’åºå¾ˆç®€å•ï¼Œå¦‚æœ beanFactory ä¸º DefaultListableBeanFactory åˆ™è¿”å› BeanFactory æ‰€ä¾èµ–çš„æ¯”è¾ƒå™¨ï¼Œå¦åˆ™åæ­£é»˜è®¤çš„æ¯”è¾ƒå™¨(OrderComparator)ï¼Œç„¶åè°ƒç”¨ <code>sort()</code> å³å¯ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sortPostProcessors</span><span class="params">(List&lt;?&gt; postProcessors, ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"> Comparator&lt;Object&gt; comparatorToUse = <span class="keyword">null</span>;</span><br><span class="line"> <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">  comparatorToUse = ((DefaultListableBeanFactory) beanFactory).getDependencyComparator();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (comparatorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">  comparatorToUse = OrderComparator.INSTANCE;</span><br><span class="line"> &#125;</span><br><span class="line"> postProcessors.sort(comparatorToUse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äºæ³¨å†ŒåŒæ ·æ˜¯è°ƒç”¨ <code>AbstractBeanFactory.addBeanPostProcessor()</code> æ–¹æ³•å®Œæˆæ³¨å†Œï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (BeanPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">  beanFactory.addBeanPostProcessor(postProcessor);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒBeanPostProcessor å·²ç»åˆ†æå®Œæ¯•äº†ï¼Œè¿™é‡Œç®€å•æ€»ç»“ä¸‹ï¼š</p><ol><li>BeanPostProcessor çš„ä½œç”¨åŸŸæ˜¯å®¹å™¨çº§åˆ«çš„ï¼Œå®ƒåªå’Œæ‰€åœ¨çš„å®¹å™¨ç›¸å…³ ï¼Œå½“ BeanPostProcessor å®Œæˆæ³¨å†Œåï¼Œå®ƒä¼šåº”ç”¨äºæ‰€æœ‰è·Ÿå®ƒåœ¨åŒä¸€ä¸ªå®¹å™¨å†…çš„ beanã€‚</li><li>BeanFactory å’Œ ApplicationContext å¯¹ BeanPostProcessor çš„å¤„ç†ä¸åŒï¼ŒApplicationContext ä¼šè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ beanï¼Œå¹¶å®Œæˆæ³¨å†Œï¼Œä½†æ˜¯ä½¿ç”¨ BeanFactory å®¹å™¨æ—¶åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>addBeanPostProcessor()</code> å®Œæˆæ³¨å†Œ</li><li>ApplicationContext çš„ BeanPostProcessor æ”¯æŒ Orderedï¼Œè€Œ BeanFactory çš„ BeanPostProcessor æ˜¯ä¸æ”¯æŒçš„ï¼ŒåŸå› åœ¨äºApplicationContext ä¼šå¯¹ BeanPostProcessor è¿›è¡Œ Ordered æ£€æµ‹å¹¶å®Œæˆæ’åºï¼Œè€Œ BeanFactory ä¸­çš„ BeanPostProcessor åªè·Ÿæ³¨å†Œçš„é¡ºåºæœ‰å…³ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥åˆ†æAwareæ¥å£</title>
      <link href="/blog/2020/01/22/26a31db5.html"/>
      <url>/blog/2020/01/22/26a31db5.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=3335">http://cmsblogs.com/?p=3335</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><code>doCreateBean()</code> æ–¹æ³•ä¸»è¦å¹²ä¸‰ä»¶äº‹æƒ…ï¼š</p><ol><li>å®ä¾‹åŒ– bean å¯¹è±¡ï¼š<code>createBeanInstance()</code></li><li>å±æ€§æ³¨å…¥ï¼š<code>populateBean()</code></li><li>åˆå§‹åŒ– bean å¯¹è±¡ï¼š<code>initializeBean()</code></li></ol><p>è€Œåˆå§‹åŒ– bean å¯¹è±¡æ—¶ä¹Ÿæ˜¯å¹²äº†ä¸‰ä»¶äº‹æƒ…ï¼š</p><ol><li>æ¿€æ´» Aware æ–¹æ³•</li><li>åç½®å¤„ç†å™¨çš„åº”ç”¨</li><li>æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³•</li></ol><p>æ¥ä¸‹æ¥å°†ä¼šè¯¦ç»†åˆ†æè¿™ä¸‰ä»¶äº‹æƒ…ï¼Œè¿™ç¯‡ä¸»è¦åˆ†æ Aware æ¥å£ã€‚</p><p>Aware æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Marker superinterface indicating that a bean is eligible to be</span></span><br><span class="line"><span class="comment"> * notified by the Spring container of a particular framework object</span></span><br><span class="line"><span class="comment"> * through a callback-style method. Actual method signature is</span></span><br><span class="line"><span class="comment"> * determined by individual subinterfaces, but should typically</span></span><br><span class="line"><span class="comment"> * consist of just one void-returning method that accepts a single</span></span><br><span class="line"><span class="comment"> * argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note that merely implementing &#123;<span class="doctag">@link</span> Aware&#125; provides no default</span></span><br><span class="line"><span class="comment"> * functionality. Rather, processing must be done explicitly, for example</span></span><br><span class="line"><span class="comment"> * in a &#123;<span class="doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor BeanPostProcessor&#125;.</span></span><br><span class="line"><span class="comment"> * Refer to &#123;<span class="doctag">@link</span> org.springframework.context.support.ApplicationContextAwareProcessor&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory&#125;</span></span><br><span class="line"><span class="comment"> * for examples of processing &#123;<span class="doctag">@code</span> *Aware&#125; interface callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Aware æ¥å£ä¸º Spring å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œæ˜¯ä¸€ä¸ªå…·æœ‰æ ‡è¯†ä½œç”¨çš„è¶…çº§æ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ bean æ˜¯å…·æœ‰è¢« Spring å®¹å™¨é€šçŸ¥çš„èƒ½åŠ›ï¼Œé€šçŸ¥çš„æ–¹å¼æ˜¯é‡‡ç”¨å›è°ƒçš„æ–¹å¼ã€‚</strong></p><p>Aware æ¥å£æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œå®é™…çš„æ–¹æ³•ç­¾åç”±å„ä¸ªå­æ¥å£æ¥ç¡®å®šï¼Œä¸”è¯¥æ¥å£é€šå¸¸åªä¼šæœ‰ä¸€ä¸ªæ¥æ”¶å•å‚æ•°çš„ set æ–¹æ³•ï¼Œè¯¥ set æ–¹æ³•çš„å‘½åæ–¹å¼ä¸º set + å»æ‰æ¥å£åä¸­çš„ Aware åç¼€ï¼Œå³ XxxAware æ¥å£ï¼Œåˆ™æ–¹æ³•å®šä¹‰ä¸º setXxx()ï¼Œä¾‹å¦‚ BeanNameAwareï¼ˆsetBeanNameï¼‰ï¼ŒApplicationContextAwareï¼ˆsetApplicationContextï¼‰ã€‚</p><p>Aware çš„å­æ¥å£éœ€è¦æä¾›ä¸€ä¸ª <code>setXxx</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ set æ˜¯è®¾ç½®å±æ€§å€¼çš„æ–¹æ³•ï¼Œå³ Aware ç±»æ¥å£çš„ <code>setXxx</code> æ–¹æ³•å…¶å®å°±æ˜¯è®¾ç½® xxx å±æ€§å€¼çš„ã€‚</p><p> Aware çš„å«ä¹‰æ˜¯æ„ŸçŸ¥çš„ã€æ„Ÿåº”çš„ï¼Œé‚£ä¹ˆåœ¨ Spring å®¹å™¨ä¸­æ˜¯å¦‚ä½•å®ç°æ„ŸçŸ¥å¹¶è®¾ç½®å±æ€§å€¼å¾—å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»åˆå§‹åŒ– bean ä¸­çš„æ¿€æ´» Aware çš„æ–¹æ³• <code>invokeAwareMethods()</code> ä¸­çœ‹åˆ°ä¸€ç‚¹ç‚¹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">      ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">      ClassLoader bcl = getBeanClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (bcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">      ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­ bean å®ä¾‹æ˜¯å¦å±äº Aware æ¥å£çš„èŒƒç•´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è°ƒç”¨å®ä¾‹çš„ <code>setXxx()</code> æ–¹æ³•ç»™å®ä¾‹è®¾ç½® xxx å±æ€§å€¼ï¼Œåœ¨ <code>invokeAwareMethods()</code> æ–¹æ³•ä¸»è¦æ˜¯è®¾ç½® beanNameï¼ŒbeanClassLoaderã€BeanFactory ä¸­ä¸‰ä¸ªå±æ€§å€¼ã€‚</p><p>Spring æä¾›äº†ä¸€ç³»åˆ—çš„ Aware æ¥å£ï¼Œå¦‚ä¸‹å›¾ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808210001-20200525092857844_al0UaW.png" alt="201808210001"></p><p>ä¸Šé¢åªæ˜¯ä¸€éƒ¨åˆ†å­ç±»ï¼Œä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Spring æä¾›çš„ Aware æ¥å£æ˜¯æ˜¯ä½•å…¶å¤šã€‚åŒæ—¶ä»ä¸Šå›¾æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†å‡ ä¸ªæ¯”è¾ƒç†Ÿæ‚‰çš„æ¥å£ï¼Œå¦‚ <code>BeanClassLoaderAware</code>ã€<code>BeanFactoryAware</code>ã€<code>BeanNameAware</code>ï¼Œä¸‹é¢å°±è¿™ä¸‰ä¸ªæ¥å£æ¥åšä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼Œå…ˆçœ‹å„è‡ªçš„å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanClassLoaderAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å°† BeanClassLoader æä¾›ç»™ bean å®ä¾‹å›è°ƒ</span></span><br><span class="line"><span class="comment">  * åœ¨ bean å±æ€§å¡«å……ä¹‹åã€åˆå§‹åŒ–å›è°ƒä¹‹å‰å›è°ƒï¼Œ</span></span><br><span class="line"><span class="comment">  * ä¾‹å¦‚InitializingBeançš„InitializingBean.afterPropertiesSetï¼ˆï¼‰æ–¹æ³•æˆ–è‡ªå®šä¹‰initæ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactoryAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å°† BeanFactory æä¾›ç»™ bean å®ä¾‹å›è°ƒ</span></span><br><span class="line"><span class="comment">  * è°ƒç”¨æ—¶æœºå’Œ setBeanClassLoader ä¸€æ ·</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanNameAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * åœ¨åˆ›å»ºæ­¤ bean çš„ beanå·¥å‚ä¸­è®¾ç½® beanName</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContextAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è®¾ç½®æ­¤ bean å¯¹è±¡çš„ ApplicationContextï¼Œé€šå¸¸ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç®€å•æ¼”ç¤ºä¸‹ä¸Šé¢å››ä¸ªæ¥å£çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationAware</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span>,<span class="title">BeanFactoryAware</span>,<span class="title">BeanClassLoaderAware</span>,<span class="title">ApplicationContextAware</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº† BeanClassLoaderAware çš„ setBeanClassLoader æ–¹æ³•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº† BeanFactoryAware çš„ setBeanFactory æ–¹æ³•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº† BeanNameAware çš„ setBeanName æ–¹æ³•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.beanName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº† ApplicationContextAware çš„ setApplicationContext æ–¹æ³•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beanName:&quot;</span> + beanName);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ˜¯å¦ä¸ºå•ä¾‹ï¼š&quot;</span> + beanFactory.isSingleton(beanName));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;ç³»ç»Ÿç¯å¢ƒä¸ºï¼š&quot;</span> + applicationContext.getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ–¹æ³•å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">  DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">  XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">  reader.loadBeanDefinitions(resource);</span><br><span class="line"></span><br><span class="line">  MyApplicationAware applicationAware = (MyApplicationAware) factory.getBean(<span class="string">&quot;myApplicationAware&quot;</span>);</span><br><span class="line">  applicationAware.display();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808210002-20200525093149590_fdZ67N.png" alt="201808210002"></p><p>ä»è¯¥è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œåªæ‰§è¡Œäº†ä¸‰ä¸ª Aware æ¥å£çš„ set æ–¹æ³•ï¼ŒåŸå› å°±æ˜¯ç—› <code>getBean()</code> è°ƒç”¨æ—¶åœ¨æ¿€æ´» Aware æ¥å£æ—¶åªæ£€æµ‹äº† BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAware ä¸‰ä¸ª Aware æ¥å£ã€‚å¦‚æœå°†æµ‹è¯•æ–¹æ³•è°ƒæ•´ä¸ºä¸‹é¢ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">  MyApplicationAware applicationAware = </span><br><span class="line">    (MyApplicationAware) applicationContext.getBean(<span class="string">&quot;myApplicationAware&quot;</span>);</span><br><span class="line">  applicationAware.display();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ™è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/25/201808210003-20200525093254904_40wEa7.png" alt="201808210003"></p><p>ä»è¿™äº†æˆ‘ä»¬åŸºæœ¬ä¸Šå°±å¯ä»¥ Aware çœŸæ­£çš„å«ä¹‰æ˜¯ä»€ä¹ˆäº†ï¼Ÿ</p><p>æ„ŸçŸ¥ï¼Œå…¶å®æ˜¯ Spring å®¹å™¨åœ¨åˆå§‹åŒ–ä¸»åŠ¨æ£€æµ‹å½“å‰ bean æ˜¯å¦å®ç°äº† Aware æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™å›è°ƒå…¶ set æ–¹æ³•å°†ç›¸åº”çš„å‚æ•°è®¾ç½®ç»™è¯¥ bean ï¼Œè¿™ä¸ªæ—¶å€™è¯¥ bean å°±ä» Spring å®¹å™¨ä¸­å–å¾—ç›¸åº”çš„èµ„æºã€‚</p><p>æœ€ååˆ—å‡ºéƒ¨åˆ†å¸¸ç”¨çš„ Aware å­æ¥å£ï¼Œä¾¿äºæ—¥åæŸ¥è¯¢ï¼š</p><ul><li>LoadTimeWeaverAwareï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ</li><li>BeanClassLoaderAwareï¼šåŠ è½½Spring Beançš„ç±»åŠ è½½å™¨</li><li>BootstrapContextAwareï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI</li><li>ResourceLoaderAwareï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨</li><li>BeanFactoryAwareï¼šå£°æ˜BeanFactory</li><li>PortletConfigAwareï¼šPortletConfig</li><li>PortletContextAwareï¼šPortletContext</li><li>ServletConfigAwareï¼šServletConfig</li><li>ServletContextAwareï¼šServletContext</li><li>MessageSourceAwareï¼šå›½é™…åŒ–</li><li>ApplicationEventPublisherAwareï¼šåº”ç”¨äº‹ä»¶</li><li>NotificationPublisherAwareï¼šJMXé€šçŸ¥</li><li>BeanNameAwareï¼šå£°æ˜Spring Beançš„åå­—</li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹åŠ è½½Beanâ€”â€”æ€»ç»“ç¯‡</title>
      <link href="/blog/2020/01/21/abeafe18.html"/>
      <url>/blog/2020/01/21/abeafe18.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2905">http://cmsblogs.com/?p=2905</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨<strong>Spring bean è§£æç¯‡</strong>æ·±å…¥åˆ†æäº†ä¸€ä¸ªé…ç½®æ–‡ä»¶ç»å†äº†å“ªäº›è¿‡ç¨‹è½¬å˜æˆäº† BeanDefinitionï¼Œä½†æ˜¯è¿™ä¸ª BeanDefinition å¹¶ä¸æ˜¯æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æƒ³è¦çš„ beanï¼Œå› ä¸ºå®ƒè¿˜ä»…ä»…åªæ˜¯æ‰¿è½½äº†æˆ‘ä»¬éœ€è¦çš„ç›®æ ‡ bean çš„ä¿¡æ¯ï¼Œä» BeanDefinition åˆ°æˆ‘ä»¬éœ€è¦çš„ç›®æ ‡è¿˜éœ€è¦ä¸€ä¸ªæ¼«é•¿çš„ bean çš„åˆå§‹åŒ–é˜¶æ®µã€‚</p><p>åœ¨ <strong>Spring bean åŠ è½½é˜¶æ®µ</strong>å·²ç»è¯¦ç»†åˆ†æäº†åˆå§‹åŒ– bean çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œåšä¸€ä¸ªæ¦‚æ‹¬æ€§çš„æ€»ç»“ã€‚ </p><p>bean çš„åˆå§‹åŒ–èŠ‚ç‚¹ç”±ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>getBean()</code>(æ˜¾å¼æˆ–è€…éšå¼)å¼€å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»è¿™ä¸ªæ–¹æ³•å¼€å§‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="meta">@Nullable</span> <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– beanNameï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªè½¬æ¢åŠ¨ä½œï¼Œå°† name è½¬æ¢Wie beanName</span></span><br><span class="line">  <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">  Object bean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­è·å– bean</span></span><br><span class="line">  <span class="comment">// *** è¿™é‡Œä¼šæ¶‰åŠåˆ°è§£å†³å¾ªç¯ä¾èµ– bean çš„é—®é¢˜</span></span><br><span class="line">  Object sharedInstance = getSingleton(beanName);</span><br><span class="line">  <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                     <span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å› ä¸º Spring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œåœ¨åŸå‹æ¨¡å¼ä¸‹å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// **å…³äºå¾ªç¯ä¾èµ–åç»­ä¼šå•ç‹¬å‡ºæ–‡è¯¦ç»†è¯´æ˜**</span></span><br><span class="line">    <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä»çˆ¶ç±»å®¹å™¨ä¸­åŠ è½½</span></span><br><span class="line">    BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      String nameToLookup = originalBeanName(name);</span><br><span class="line">      <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">          nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œè¿™é‡Œéœ€è¦è®°å½•</span></span><br><span class="line">    <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">      markBeanAsCreated(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ä»å®¹å™¨ä¸­è·å– beanName ç›¸åº”çš„ GenericBeanDefinitionï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º RootBeanDefinition</span></span><br><span class="line">      <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ£€æŸ¥ç»™å®šçš„åˆå¹¶çš„ BeanDefinition</span></span><br><span class="line">      checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤„ç†æ‰€ä¾èµ–çš„ bean</span></span><br><span class="line">      String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">      <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">          <span class="comment">// è‹¥ç»™å®šçš„ä¾èµ– bean å·²ç»æ³¨å†Œä¸ºä¾èµ–ç»™å®šçš„b ean</span></span><br><span class="line">          <span class="comment">// å¾ªç¯ä¾èµ–çš„æƒ…å†µ</span></span><br><span class="line">          <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                            <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ç¼“å­˜ä¾èµ–è°ƒç”¨</span></span><br><span class="line">          registerDependentBean(dep, beanName);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            getBean(dep);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                            <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bean å®ä¾‹åŒ–</span></span><br><span class="line">      <span class="comment">// å•ä¾‹æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="comment">// æ˜¾ç¤ºä»å•åˆ©ç¼“å­˜ä¸­åˆ é™¤ bean å®ä¾‹</span></span><br><span class="line">            <span class="comment">// å› ä¸ºå•ä¾‹æ¨¡å¼ä¸‹ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯èƒ½ä»–å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥é”€æ¯å®ƒ</span></span><br><span class="line">            destroySingleton(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åŸå‹æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">        Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          beforePrototypeCreation(beanName);</span><br><span class="line">          prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          afterPrototypeCreation(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä»æŒ‡å®šçš„ scope ä¸‹åˆ›å»º bean</span></span><br><span class="line">        String scopeName = mbd.getScope();</span><br><span class="line">        <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">        <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">            beforePrototypeCreation(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">              afterPrototypeCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">          bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                                          <span class="string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +</span><br><span class="line">                                          <span class="string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,</span><br><span class="line">                                          ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥éœ€è¦çš„ç±»å‹æ˜¯å¦ç¬¦åˆ bean çš„å®é™…ç±»å‹</span></span><br><span class="line">  <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">      <span class="keyword">if</span> (convertedBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> convertedBean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                     ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨è°ƒç”¨ <code>doGetBean()</code> æ–¹æ³•ï¼Œ<code>doGetBean()</code> çš„ä»£ç é‡æ¯”è¾ƒå¤šï¼Œä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡º bean çš„åŠ è½½è¿‡ç¨‹æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¿‡ç¨‹ï¼Œä¼šæ¶‰åŠåˆ°å„ç§å„æ ·çš„æƒ…å†µå¤„ç†ã€‚<code>doGetBean()</code> å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ã€‚</p><ol><li>è½¬æ¢ beanNameã€‚å› ä¸ºæˆ‘ä»¬è°ƒç”¨ <code>getBean()</code> æ–¹æ³•ä¼ å…¥çš„ name å¹¶ä¸ä¸€å®šå°±æ˜¯ beanNameï¼Œå¯ä»¥ä¼ å…¥ aliasNameï¼ŒFactoryBeanï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œç®€å•çš„è½¬æ¢è¿‡ç¨‹ã€‚</li><li>å°è¯•ä»ç¼“å­˜ä¸­åŠ è½½å•ä¾‹ beanã€‚</li><li>bean çš„å®ä¾‹åŒ–ã€‚</li><li>åŸå‹æ¨¡å¼çš„ä¾èµ–æ£€æŸ¥ã€‚å› ä¸º Spring åªä¼šè§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–éƒ½æ˜¯ç›´æ¥æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚</li><li>å°è¯•ä» parentBeanFactory è·å– bean å®ä¾‹ã€‚å¦‚æœ <code>parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)</code> åˆ™å°è¯•ä» parentBeanFactory ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå› ä¸º <code>!containsBeanDefinition(beanName)</code> å°±æ„å‘³ç€å®šä¹‰çš„ xml æ–‡ä»¶ä¸­æ²¡æœ‰ beanName ç›¸åº”çš„é…ç½®ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½ä» parentBeanFactory ä¸­è·å–ã€‚</li><li>è·å– RootBeanDefinitionï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆå¹¶æ£€æŸ¥ã€‚ä»ç¼“å­˜ä¸­è·å–å·²ç»è§£æçš„ RootBeanDefinitionï¼ŒåŒæ—¶å¦‚æœçˆ¶ç±»ä¸ä¸º null çš„è¯ï¼Œåˆ™ä¼šåˆå¹¶çˆ¶ç±»çš„å±æ€§ã€‚</li><li>ä¾èµ–æ£€æŸ¥ã€‚æŸä¸ª bean ä¾èµ–å…¶ä»– bean ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½ä¾èµ–çš„ beanã€‚</li><li>å¯¹ä¸åŒçš„ scope è¿›è¡Œå¤„ç†ã€‚</li><li>ç±»å‹è½¬æ¢å¤„ç†ã€‚å¦‚æœä¼ é€’çš„ requiredType ä¸ä¸º nullï¼Œåˆ™éœ€è¦æ£€æµ‹æ‰€å¾—åˆ° bean çš„ç±»å‹æ˜¯å¦ä¸è¯¥ requiredType ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™å°è¯•è½¬æ¢ï¼Œå½“ç„¶ä¹Ÿè¦èƒ½å¤Ÿè½¬æ¢æˆåŠŸï¼Œå¦åˆ™æŠ›å‡º BeanNotOfRequiredTypeException å¼‚å¸¸ã€‚</li></ol><p>ä¸‹é¢å°±ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œé˜è¿°ï¼Œè¯´æ˜ Spring bean çš„åŠ è½½è¿‡ç¨‹ã€‚</p><ol><li>ä»ç¼“å­˜ä¸­è·å– bean</li><li>åˆ›å»º bean å®ä¾‹å¯¹è±¡</li><li>ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡</li></ol><h2 id="ä»ç¼“å­˜ä¸­è·å–-bean"><a href="#ä»ç¼“å­˜ä¸­è·å–-bean" class="headerlink" title="ä»ç¼“å­˜ä¸­è·å– bean"></a>ä»ç¼“å­˜ä¸­è·å– bean</h2><p>Spring ä¸­æ ¹æ® scope å¯ä»¥å°† bean åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼šsingletonã€prototype å’Œ å…¶ä»–ï¼Œè¿™æ ·åˆ†çš„åŸå› åœ¨äº Spring åœ¨å¯¹ä¸åŒ scope å¤„ç†çš„æ—¶å€™æ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚</p><ul><li>singletonï¼šåœ¨ Spring çš„ IoC å®¹å™¨ä¸­åªå­˜åœ¨ä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼Œæ‰€æœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨éƒ½å…±äº«è¿™ä¸ªå®ä¾‹ã€‚Spring å®¹å™¨åªä¼šåˆ›å»ºè¯¥ bean å®šä¹‰çš„å”¯ä¸€å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ä¼šè¢«ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”å¯¹è¯¥beançš„æ‰€æœ‰åç»­è¯·æ±‚å’Œå¼•ç”¨éƒ½å°†è¿”å›è¯¥ç¼“å­˜ä¸­çš„å¯¹è±¡å®ä¾‹ã€‚</li><li>prototypeï¼šæ¯æ¬¡å¯¹è¯¥beançš„è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹</li><li>å…¶ä»–ï¼šå…¶ä»–åŒ…æ‹¬ requestã€sessionã€global sessionï¼š<ul><li>requestï¼šæ¯æ¬¡ http è¯·æ±‚å°†ä¼šæœ‰å„è‡ªçš„ bean å®ä¾‹ã€‚</li><li>sessionï¼šåœ¨ä¸€ä¸ª http session ä¸­ï¼Œä¸€ä¸ª bean å®šä¹‰å¯¹åº”ä¸€ä¸ª bean å®ä¾‹ã€‚</li><li>global sessionï¼šåœ¨ä¸€ä¸ªå…¨å±€çš„ http session ä¸­ï¼Œä¸€ä¸ª bean å®šä¹‰å¯¹åº”ä¸€ä¸ª bean å®ä¾‹ã€‚</li></ul></li></ul><p>æ‰€ä»¥ä»ç¼“å­˜ä¸­è·å–çš„ bean ä¸€å®šæ˜¯ singleton beanï¼Œè¿™ä¹Ÿæ˜¯ Spring ä¸ºä½•åªè§£å†³ singleton bean çš„å¾ªç¯ä¾èµ–ã€‚è°ƒç”¨ <code>getSingleton()</code> ä»ç¼“å­˜ä¸­è·å– singleton beanã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getSingleton()</code> å°±æ˜¯ä» singletonObjectsã€earlySingletonObjectsã€ singletonFactories ä¸‰ä¸ªç¼“å­˜ä¸­è·å–ï¼Œè¿™é‡Œä¹Ÿæ˜¯ Spring è§£å†³ bean å¾ªç¯ä¾èµ–çš„å…³é”®ä¹‹å¤„ã€‚è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹å¦‚ä¸‹å†…å®¹ï¼š</p><ul><li><a href="/2020/01/16/c9c155de.html">IOCä¹‹ä»å•ä¾‹ç¼“å­˜ä¸­è·å–å•ä¾‹ bean</a></li></ul><h2 id="åˆ›å»º-bean-å®ä¾‹å¯¹è±¡"><a href="#åˆ›å»º-bean-å®ä¾‹å¯¹è±¡" class="headerlink" title="åˆ›å»º bean å®ä¾‹å¯¹è±¡"></a>åˆ›å»º bean å®ä¾‹å¯¹è±¡</h2><p>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä¹Ÿæ²¡æœ‰ parentBeanFactory ï¼Œåˆ™ä¼šè°ƒç”¨ <code>createBean()</code> åˆ›å»º bean å®ä¾‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯åœ¨å¤„ç†ä¸åŒ scope çš„ bean çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException</span></span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯å®šä¹‰åœ¨ AbstractBeanFactory ä¸­çš„è™šæ‹Ÿæ–¹æ³•ï¼Œå…¶å«ä¹‰æ˜¯æ ¹æ®ç»™å®šçš„ BeanDefinition å’Œ argså®ä¾‹åŒ–ä¸€ä¸ª bean å¯¹è±¡ï¼Œå¦‚æœè¯¥ BeanDefinition å­˜åœ¨çˆ¶ç±»ï¼Œåˆ™è¯¥ BeanDefinition å·²ç»åˆå¹¶äº†çˆ¶ç±»çš„å±æ€§ã€‚æ‰€æœ‰ Bean å®ä¾‹çš„åˆ›å»ºéƒ½ä¼šå§”æ‰˜ç»™è¯¥æ–¹æ³•å®ç°ã€‚ æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>beanNameï¼šbean çš„åå­—</li><li>mbdï¼šå·²ç»åˆå¹¶äº†çˆ¶ç±»å±æ€§çš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰BeanDefinition</li><li>argsï¼šç”¨äºæ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•åˆ›å»º bean å®ä¾‹å¯¹è±¡çš„å‚æ•°</li></ul><p>è¯¥æŠ½è±¡æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯åœ¨ç±» AbstractAutowireCapableBeanFactory ä¸­å®ç°ï¼Œè¯¥æ–¹æ³•å…¶å®åªæ˜¯åšä¸€äº›æ£€æŸ¥å’ŒéªŒè¯å·¥ä½œï¼ŒçœŸæ­£çš„åˆå§‹åŒ–å·¥ä½œæ˜¯ç”± <code>doCreateBean()</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BeanWrapperæ˜¯å¯¹Beançš„åŒ…è£…ï¼Œå…¶æ¥å£ä¸­æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œè·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨</span></span><br><span class="line">  BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å•ä¾‹æ¨¡å‹ï¼Œåˆ™ä»æœªå®Œæˆçš„ FactoryBean ç¼“å­˜ä¸­åˆ é™¤</span></span><br><span class="line">  <span class="keyword">if</span> (mbd.isSingleton()) &#123;anceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨åˆé€‚çš„å®ä¾‹åŒ–ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ã€ç®€å•åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒ…è£…çš„å®ä¾‹å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">final</span> Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">  <span class="comment">// åŒ…è£…çš„å®ä¾‹å¯¹è±¡çš„ç±»å‹</span></span><br><span class="line">  Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">  <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">    mbd.resolvedTargetType = beanType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æµ‹æ˜¯å¦æœ‰åç½®å¤„ç†</span></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰åç½®å¤„ç†ï¼Œåˆ™å…è®¸åç½®å¤„ç†ä¿®æ”¹ BeanDefinition</span></span><br><span class="line">  <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// applyMergedBeanDefinitionPostProcessors</span></span><br><span class="line">        <span class="comment">// åç½®å¤„ç†ä¿®æ”¹ BeanDefinition</span></span><br><span class="line">        applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                        <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–</span></span><br><span class="line">  <span class="comment">// å•ä¾‹æ¨¡å¼ &amp; è¿è¡Œå¾ªç¯ä¾èµ–&amp;å½“å‰å•ä¾‹ bean æ˜¯å¦æ­£åœ¨è¢«åˆ›å»º</span></span><br><span class="line">  <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                                    isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æå‰å°†åˆ›å»ºçš„ bean å®ä¾‹åŠ å…¥åˆ°ectFactory ä¸­</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸ºäº†åæœŸé¿å…å¾ªç¯ä¾èµ–</span></span><br><span class="line">    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å¼€å§‹åˆå§‹åŒ– bean å®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  Object exposedObject = bean;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹ bean è¿›è¡Œå¡«å……ï¼Œå°†å„ä¸ªå±æ€§å€¼æ³¨å…¥ï¼Œå…¶ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»– bean çš„å±æ€§</span></span><br><span class="line">    <span class="comment">// åˆ™ä¼šé€’å½’åˆå§‹ä¾èµ– bean</span></span><br><span class="line">    populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">    <span class="comment">// è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¾ªç¯ä¾èµ–å¤„ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="comment">// è·å– earlySingletonReference</span></span><br><span class="line">    Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// åªæœ‰åœ¨å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼ŒearlySingletonReference æ‰ä¸ä¼šä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ exposedObject æ²¡æœ‰åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¢«æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«å¢å¼º</span></span><br><span class="line">      <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">        exposedObject = earlySingletonReference;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¤„ç†ä¾èµ–</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">        String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">        Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">        <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">            actualDependentBeans.add(dependentBean);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">                                                     <span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">                                                     StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                                                     <span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">                                                     <span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">                                                     <span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">                                                     <span class="string">&quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œ bean</span></span><br><span class="line">    registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doCreateBean()</code> æ˜¯åˆ›å»º bean å®ä¾‹çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå®ƒçš„æ•´ä½“æ€è·¯æ˜¯ï¼š</p><ol><li>å¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™æ¸…é™¤ factoryBeanInstanceCache ç¼“å­˜ï¼ŒåŒæ—¶è¿”å› BeanWrapper å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶å¦‚æœå­˜åœ¨ã€‚</li><li>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper æˆ–è€…ä¸æ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™è°ƒç”¨ <code>createBeanInstance()</code> å®ä¾‹åŒ– beanï¼Œä¸»è¦æ˜¯å°† BeanDefinition è½¬æ¢ä¸º BeanWrapper</li><li>MergedBeanDefinitionPostProcessor çš„åº”ç”¨</li><li>å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç†</li><li>è°ƒç”¨ <code>populateBean()</code> è¿›è¡Œå±æ€§å¡«å……ã€‚å°†æ‰€æœ‰å±æ€§å¡«å……è‡³ bean çš„å®ä¾‹ä¸­</li><li>è°ƒç”¨ <code>initializeBean()</code> åˆå§‹åŒ– bean</li><li>ä¾èµ–æ£€æŸ¥</li><li>æ³¨å†Œ DisposableBean</li></ol><h3 id="å®ä¾‹åŒ–-bean"><a href="#å®ä¾‹åŒ–-bean" class="headerlink" title="å®ä¾‹åŒ– bean"></a>å®ä¾‹åŒ– bean</h3><p>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper å®ä¾‹å¯¹è±¡æˆ–è€…è¯¥ bean ä¸æ˜¯ singletonï¼Œåˆ™è°ƒç”¨ <code>createBeanInstance()</code> åˆ›å»º bean å®ä¾‹ã€‚è¯¥æ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®å‚æ•° BeanDefinitionã€args[] æ¥è°ƒç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ– bean å¯¹è±¡ã€‚è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æ beanï¼Œå°† bean ç±»åè§£æä¸º class å¼•ç”¨</span></span><br><span class="line">  Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beanClass != <span class="keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                    <span class="string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„å›è°ƒæ–¹æ³•åˆå§‹åŒ–ç­–ç•¥</span></span><br><span class="line">  Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line">  <span class="keyword">if</span> (instanceSupplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•åˆå§‹åŒ–ç­–ç•¥</span></span><br><span class="line">  <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="keyword">null</span>)  &#123;</span><br><span class="line">    <span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// constructorArgumentLock æ„é€ å‡½æ•°çš„å¸¸ç”¨é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå·²ç¼“å­˜çš„è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ„é€ å‡½æ•°è§£æ</span></span><br><span class="line">      <span class="comment">// å› ä¸ºéœ€è¦æ ¹æ®å‚æ•°ç¡®è®¤åˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥è¿‡ç¨‹æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€æœ‰é‡‡ç”¨ç¼“å­˜æœºåˆ¶</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">        resolved = <span class="keyword">true</span>;</span><br><span class="line">        autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å·²ç»è§£æå¥½äº†ï¼Œç›´æ¥æ³¨å…¥å³å¯</span></span><br><span class="line">  <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">    <span class="comment">// è‡ªåŠ¨æ³¨å…¥ï¼Œè°ƒç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">      <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€ </span></span><br><span class="line">      <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¡®å®šè§£æçš„æ„é€ å‡½æ•°</span></span><br><span class="line">  <span class="comment">// ä¸»è¦æ˜¯æ£€æŸ¥å·²ç»æ³¨å†Œçš„ SmartInstantiationAwareBeanPostProcessor</span></span><br><span class="line">  Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">  <span class="keyword">if</span> (ctors != <span class="keyword">null</span> ||</span><br><span class="line">      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">      mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥</span></span><br><span class="line">  <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ– bean æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå…¶ä¸»è¦çš„é€»è¾‘ä¸ºï¼š</p><ul><li>å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> è¿›è¡Œåˆå§‹åŒ–</li><li>å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</li><li>é¦–å…ˆåˆ¤æ–­ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œå³å·²ç»è§£æè¿‡äº†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å·²ç»è§£æäº†çš„ï¼Œæ ¹æ® constructorArgumentsResolved å‚æ•°æ¥åˆ¤æ–­æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥è¿˜æ˜¯é»˜è®¤æ„é€ å‡½æ•°</li><li>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆç¡®å®šåˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°æ¥å®Œæˆè§£æå·¥ä½œï¼Œå› ä¸ºä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°éƒ½æœ‰ä¸åŒçš„æ„é€ å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®å‚æ•°æ¥é”å®šæ„é€ å‡½æ•°å¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¦‚æœå­˜åœ¨å‚æ•°åˆ™ä½¿ç”¨ç›¸åº”çš„å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚</li></ul><p>å…¶å®æ ¸å¿ƒæ€æƒ³è¿˜æ˜¯åœ¨äºæ ¹æ®ä¸åŒçš„æƒ…å†µæ‰§è¡Œä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œä¸»è¦æ˜¯åŒ…æ‹¬å¦‚ä¸‹å››ç§ç­–ç•¥ï¼š</p><ol><li>Supplier å›è°ƒ</li><li><code>instantiateUsingFactoryMethod()</code> å·¥å‚æ–¹æ³•åˆå§‹åŒ–</li><li><code>autowireConstructor()</code>ï¼Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–</li><li><code>instantiateBean()</code>ï¼Œé»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥</li></ol><p>å…¶å®æ— è®ºå“ªç§ç­–ç•¥ï¼Œä»–ä»¬çš„å®ç°é€»è¾‘éƒ½å·®ä¸å¤šï¼šç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ æ–¹æ³•ï¼Œç„¶åå®ä¾‹åŒ–ã€‚åªä¸è¿‡ç›¸å¯¹äº Supplier å›è°ƒå’Œé»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥è€Œè¨€ï¼Œå·¥å‚æ–¹æ³•åˆå§‹åŒ–å’Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ä¼šæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºä»–ä»¬æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°çš„ä¸ç¡®å®šæ€§ï¼ŒSpring éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›æ¥ç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°ï¼Œå¦‚æœç¡®å®šäº†åˆ™å¥½åŠï¼Œç›´æ¥é€‰æ‹©å®ä¾‹åŒ–ç­–ç•¥å³å¯ã€‚å½“ç„¶åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ ¹æ®æ˜¯å¦æœ‰éœ€è¦è¦†ç›–æˆ–è€…åŠ¨æ€æ›¿æ¢æ‰çš„æ–¹æ³•ï¼Œå› ä¸ºå­˜åœ¨è¦†ç›–æˆ–è€…ç»‡å…¥çš„è¯éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å°†æ–¹æ³•ç»‡å…¥ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½é€‰æ‹© CGLIB çš„æ–¹å¼æ¥å®ä¾‹åŒ–ï¼Œå¦åˆ™ç›´æ¥åˆ©ç”¨åå°„çš„æ–¹å¼å³å¯ã€‚</p><h3 id="å±æ€§å¡«å……"><a href="#å±æ€§å¡«å……" class="headerlink" title="å±æ€§å¡«å……"></a>å±æ€§å¡«å……</h3><p>å±æ€§å¡«å……å…¶å®å°±æ˜¯å°† BeanDefinition çš„å±æ€§å€¼èµ‹å€¼ç»™ BeanWrapper å®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ã€‚åœ¨å¡«å……çš„è¿‡ç¨‹éœ€è¦æ ¹æ®æ³¨å…¥çš„ç±»å‹ä¸åŒæ¥åŒºåˆ†æ˜¯æ ¹æ®ç±»å‹æ³¨å…¥è¿˜æ˜¯åå­—æ³¨å…¥ï¼Œå½“ç„¶åœ¨è¿™ä¸ªè¿‡ç¨‹è¿˜ä¼šæ¶‰åŠå¾ªç¯ä¾èµ–çš„é—®é¢˜çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> BeanWrapper bw)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (bw == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æœ‰å±æ€§æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.hasPropertyValues()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName, <span class="string">&quot;Cannot apply property values to null instance&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ²¡æœ‰å±æ€§ç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨è®¾ç½®å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼š</span></span><br><span class="line">  <span class="keyword">boolean</span> continueWithPropertyPopulation = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bena ä¸æ˜¯&quot;åˆæˆ&quot;çš„ï¼Œå³æœªç”±åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰</span></span><br><span class="line">  <span class="comment">// æ˜¯å¦æŒæœ‰ InstantiationAwareBeanPostProcessor</span></span><br><span class="line">  <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">    <span class="comment">// è¿­ä»£æ‰€æœ‰çš„ BeanPostProcessors</span></span><br><span class="line">    <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸º InstantiationAwareBeanPostProcessor</span></span><br><span class="line">      <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">        InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">        <span class="comment">// è¿”å›å€¼ä¸ºæ˜¯å¦ç»§ç»­å¡«å…… bean</span></span><br><span class="line">        <span class="comment">// postProcessAfterInstantiationï¼šå¦‚æœåº”è¯¥åœ¨ beanä¸Šé¢è®¾ç½®å±æ€§åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">        <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯è¿”å›trueï¼Œè¿”å› false çš„è¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// å°†ä¼šé˜»æ­¢åœ¨æ­¤ Bean å®ä¾‹ä¸Šè°ƒç”¨ä»»ä½•åç»­çš„ InstantiationAwareBeanPostProcessor å®ä¾‹ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">          continueWithPropertyPopulation = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœåç»­å¤„ç†å™¨å‘å‡ºåœæ­¢å¡«å……å‘½ä»¤ï¼Œåˆ™ç»ˆæ­¢åç»­æ“ä½œ</span></span><br><span class="line">  <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bean çš„å±æ€§å€¼</span></span><br><span class="line">  PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† PropertyValues å°è£…æˆ MutablePropertyValues å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// MutablePropertyValues å…è®¸å¯¹å±æ€§è¿›è¡Œç®€å•çš„æ“ä½œï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶æä¾›æ„é€ å‡½æ•°ä»¥æ”¯æŒMapçš„æ·±åº¦å¤åˆ¶å’Œæ„é€ ã€‚</span></span><br><span class="line">    MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">      autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç±»å‹è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">      autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pvs = newPvs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»æ³¨å†Œäº† InstantiationAwareBeanPostProcessors</span></span><br><span class="line">  <span class="keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">      pvs = mbd.getPropertyValues();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» bw å¯¹è±¡ä¸­æå– PropertyDescriptor ç»“æœé›†</span></span><br><span class="line">    <span class="comment">// PropertyDescriptorï¼šå¯ä»¥é€šè¿‡ä¸€å¯¹å­˜å–æ–¹æ³•æå–ä¸€ä¸ªå±æ€§</span></span><br><span class="line">    PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">    <span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">      <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">          InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">          <span class="comment">// å¯¹æ‰€æœ‰éœ€è¦ä¾èµ–æ£€æŸ¥çš„å±æ€§è¿›è¡Œåå¤„ç†</span></span><br><span class="line">          pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">          <span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">      <span class="comment">// ä¾èµ–æ£€æŸ¥ï¼Œå¯¹åº” depends-on å±æ€§</span></span><br><span class="line">      checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pvs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å°†å±æ€§åº”ç”¨åˆ° bean ä¸­</span></span><br><span class="line">    applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ ¹æ® hasInstantiationAwareBeanPostProcessors å±æ€§æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨æ³¨å…¥å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼šï¼Œæ­¤è¿‡ç¨‹å¯ä»¥æ§åˆ¶ Spring æ˜¯å¦ç»§ç»­è¿›è¡Œå±æ€§å¡«å……ã€‚</li><li>æ ¹æ®æ³¨å…¥ç±»å‹çš„ä¸åŒæ¥åˆ¤æ–­æ˜¯æ ¹æ®åç§°æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆ<code>autowireByName()</code>ï¼‰è¿˜æ˜¯æ ¹æ®ç±»å‹æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆ<code>autowireByType()</code>ï¼‰ï¼Œç»Ÿä¸€å­˜å…¥åˆ° PropertyValues ä¸­ï¼ŒPropertyValues ç”¨äºæè¿° bean çš„å±æ€§ã€‚</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ BeanPostProcessor å’Œ ä¾èµ–æ£€æµ‹ã€‚</li><li>å°†æ‰€æœ‰ PropertyValues ä¸­çš„å±æ€§å¡«å……åˆ° BeanWrapper ä¸­ã€‚</li></ol><h3 id="åˆå§‹åŒ–-bean"><a href="#åˆå§‹åŒ–-bean" class="headerlink" title="åˆå§‹åŒ– bean"></a>åˆå§‹åŒ– bean</h3><p>åˆå§‹åŒ– bean ä¸º <code>createBean()</code> çš„æœ€åä¸€ä¸ªè¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¸»è¦åšä¸‰ä»¶äº‹æƒ…ï¼š</p><ol><li>æ¿€æ´» Aware æ–¹æ³•</li><li>åç½®å¤„ç†å™¨çš„åº”ç”¨</li><li>æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³•</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">      <span class="comment">// æ¿€æ´» Aware æ–¹æ³•</span></span><br><span class="line">      invokeAwareMethods(beanName, bean);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;, getAccessControlContext());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹ç‰¹æ®Šçš„ bean å¤„ç†ï¼šAwareã€BeanClassLoaderAwareã€BeanFactoryAware</span></span><br><span class="line">    invokeAwareMethods(beanName, bean);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Object wrappedBean = bean;</span><br><span class="line">  <span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">    <span class="comment">// åå¤„ç†å™¨</span></span><br><span class="line">    wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ init æ–¹æ³•</span></span><br><span class="line">    invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      (mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">      beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">    <span class="comment">// åå¤„ç†å™¨</span></span><br><span class="line">    wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä»-bean-å®ä¾‹ä¸­è·å–å¯¹è±¡"><a href="#ä»-bean-å®ä¾‹ä¸­è·å–å¯¹è±¡" class="headerlink" title="ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡"></a>ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡</h2><p>æ— è®ºæ˜¯ä»å•ä¾‹ç¼“å­˜ä¸­è·å–çš„ bean å®ä¾‹ è¿˜æ˜¯é€šè¿‡ <code>createBean()</code> åˆ›å»ºçš„ bean å®ä¾‹ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <code>getObjectForBeanInstance()</code> ï¼Œè¯¥æ–¹æ³•æ˜¯æ ¹æ®ä¼ å…¥çš„ bean å®ä¾‹è·å–å¯¹è±¡ï¼ŒæŒ‰ç…§ Spring çš„ä¼ ç»Ÿï¼Œè¯¥æ–¹æ³•ä¹Ÿåªæ˜¯åšä¸€äº›æ£€æµ‹å·¥ä½œï¼ŒçœŸæ­£çš„å®ç°é€»è¾‘æ˜¯å§”æ‰˜ç»™ <code>getObjectFromFactoryBean()</code> å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸ºå•ä¾‹æ¨¡å¼ä¸”ç¼“å­˜ä¸­å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (getSingletonMutex()) &#123;</span><br><span class="line">      <span class="comment">// ä»ç¼“å­˜ä¸­è·å–æŒ‡å®šçš„ factoryBean</span></span><br><span class="line">      Object object = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸ºç©ºï¼Œåˆ™ä» FactoryBean ä¸­è·å–å¯¹è±¡</span></span><br><span class="line">        object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">        Object alreadyThere = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">        <span class="comment">// **æˆ‘å®åœ¨æ˜¯ä¸æ˜ç™½è¿™é‡Œè¿™ä¹ˆåšçš„åŸå› ï¼Œè¿™é‡Œæ˜¯å¹²å˜›ï¼Ÿï¼Ÿï¼Ÿ**</span></span><br><span class="line">        <span class="keyword">if</span> (alreadyThere != <span class="keyword">null</span>) &#123;</span><br><span class="line">          object = alreadyThere;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// éœ€è¦åç»­å¤„ç†</span></span><br><span class="line">          <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">            <span class="comment">// è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">              <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å‰ç½®å¤„ç†</span></span><br><span class="line">            beforeSingletonCreation(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// å¯¹ä» FactoryBean è·å–çš„å¯¹è±¡è¿›è¡Œåå¤„ç†</span></span><br><span class="line">              <span class="comment">// ç”Ÿæˆçš„å¯¹è±¡å°†æš´éœ²ç»™beanå¼•ç”¨</span></span><br><span class="line">              object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                                              <span class="string">&quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">              <span class="comment">// åç½®å¤„ç†</span></span><br><span class="line">              afterSingletonCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ç¼“å­˜</span></span><br><span class="line">          <span class="keyword">if</span> (containsSingleton(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.factoryBeanObjectCache.put(beanName, object);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// éå•ä¾‹</span></span><br><span class="line">    Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">    <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">&quot;Post-processing of FactoryBean&#x27;s object failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ä¸ºå•ä¾‹ä¸”å•ä¾‹ bean ç¼“å­˜ä¸­å­˜åœ¨ beanNameï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†ï¼ˆè·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼‰ï¼Œå¦åˆ™åˆ™ä» FactoryBean ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ¥å—åç½®å¤„ç†ï¼Œåˆ™è°ƒç”¨ <code>postProcessObjectFromFactoryBean()</code> è¿›è¡Œåç½®å¤„ç†ã€‚</li><li>é¦–å…ˆè·å–é”ï¼ˆå…¶å®æˆ‘ä»¬åœ¨å‰é¢ç¯‡å¹…ä¸­å‘ç°äº†å¤§é‡çš„åŒæ­¥é”ï¼Œé”ä½çš„å¯¹è±¡éƒ½æ˜¯ this.singletonObjectsï¼Œ ä¸»è¦æ˜¯å› ä¸ºåœ¨å•ä¾‹æ¨¡å¼ä¸­å¿…é¡»è¦ä¿è¯å…¨å±€å”¯ä¸€ï¼‰ï¼Œç„¶åä» factoryBeanObjectCache ç¼“å­˜ä¸­è·å–å®ä¾‹å¯¹è±¡ objectï¼Œè‹¥ object ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>doGetObjectFromFactoryBean()</code>æ–¹æ³•ä» FactoryBean è·å–å¯¹è±¡ï¼Œå…¶å®å†…éƒ¨å°±æ˜¯è°ƒç”¨ <code>FactoryBean.getObject()</code>ã€‚</li><li>å¦‚æœéœ€è¦åç»­å¤„ç†ï¼Œåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š<ul><li>è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼ˆisSingletonCurrentlyInCreationï¼‰ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ</li><li>è°ƒç”¨ <code>beforeSingletonCreation()</code> è¿›è¡Œåˆ›å»ºä¹‹å‰çš„å¤„ç†ã€‚é»˜è®¤å®ç°å°†è¯¥ bean æ ‡å¿—ä¸ºå½“å‰åˆ›å»ºçš„ã€‚</li><li>è°ƒç”¨ <code>postProcessObjectFromFactoryBean()</code> å¯¹ä» FactoryBean è·å–çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯æŒ‰ç…§åŸæ ·ç›´æ¥è¿”å›ï¼Œå…·ä½“å®ç°æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­å®ç°çš„ï¼Œå½“ç„¶å­ç±»ä¹Ÿå¯ä»¥é‡å†™å®ƒï¼Œæ¯”å¦‚åº”ç”¨åç½®å¤„ç†</li><li>è°ƒç”¨ <code>afterSingletonCreation()</code> è¿›è¡Œåˆ›å»º bean ä¹‹åçš„å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯å°†è¯¥ bean æ ‡è®°ä¸ºä¸å†åœ¨åˆ›å»ºä¸­ã€‚</li></ul></li><li>æœ€ååŠ å…¥åˆ° FactoryBeans ç¼“å­˜ä¸­ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹Beançš„åˆå§‹åŒ–</title>
      <link href="/blog/2020/01/21/e8e94997.html"/>
      <url>/blog/2020/01/21/e8e94997.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2890">http://cmsblogs.com/?p=2890</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>ä¸€ä¸ª bean ç»å†äº† <code>createBeanInstance()</code> è¢«åˆ›å»ºå‡ºæ¥ï¼Œç„¶ååˆç»è¿‡ä¸€ç•ªå±æ€§æ³¨å…¥ï¼Œä¾èµ–å¤„ç†ï¼Œå†ç»åƒè¾›ä¸‡è‹¦ï¼Œåƒé”¤ç™¾ç‚¼ï¼Œç»ˆäºæœ‰ç‚¹å„¿ bean å®ä¾‹çš„æ ·å­ï¼Œèƒ½å ªå¤§ä»»äº†ï¼Œåªéœ€è¦ç»å†æœ€åä¸€æ­¥å°±ç ´èŒ§æˆè¶äº†ã€‚</p><p>è¿™æœ€åä¸€æ­¥å°±æ˜¯åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ <code>initializeBean()</code>ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æˆ‘ä»¬åˆ†æ <code>doCreateBean()</code> ä¸­æœ€åä¸€æ­¥ï¼šåˆå§‹åŒ– beanã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">      <span class="comment">// æ¿€æ´» Aware æ–¹æ³•</span></span><br><span class="line">      invokeAwareMethods(beanName, bean);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;, getAccessControlContext());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹ç‰¹æ®Šçš„ bean å¤„ç†ï¼šAwareã€BeanClassLoaderAwareã€BeanFactoryAware</span></span><br><span class="line">    invokeAwareMethods(beanName, bean);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Object wrappedBean = bean;</span><br><span class="line">  <span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">    <span class="comment">// åå¤„ç†å™¨</span></span><br><span class="line">    wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ init æ–¹æ³•</span></span><br><span class="line">    invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      (mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">      beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">    <span class="comment">// åå¤„ç†å™¨</span></span><br><span class="line">    wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ– bean çš„æ–¹æ³•å…¶å®å°±æ˜¯ä¸‰ä¸ªæ­¥éª¤çš„å¤„ç†ï¼Œè€Œè¿™ä¸‰ä¸ªæ­¥éª¤ä¸»è¦è¿˜æ˜¯æ ¹æ®ç”¨æˆ·è®¾å®šçš„æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸‰ä¸ªè¿‡ç¨‹ä¸ºï¼š</p><ol><li>æ¿€æ´» Aware æ–¹æ³•</li><li>åç½®å¤„ç†å™¨çš„åº”ç”¨</li><li>æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³•</li></ol><p><strong>æ¿€æ´» Aware æ–¹æ³•</strong> Aware ,è‹±æ–‡ç¿»è¯‘æ˜¯æ„è¯†åˆ°çš„ï¼Œæ„ŸçŸ¥çš„ï¼ŒSpring æä¾›äº†è¯¸å¤šç±»ä¼¼<code>xxxxAware</code> çš„æ¥å£ç”¨äºè¾…åŠ© Spring Bean ä»¥ç¼–ç¨‹çš„æ–¹å¼è°ƒç”¨ Spring å®¹å™¨ï¼Œé€šè¿‡å®ç°è¿™äº›æ¥å£ï¼Œå¯ä»¥å¢å¼º Spring Bean çš„åŠŸèƒ½ã€‚ </p><p>Spring æä¾›äº†å¦‚ä¸‹ç³»åˆ—çš„ Aware æ¥å£ï¼š</p><ul><li><code>LoadTimeWeaverAware</code>ï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ</li><li><code>BeanClassLoaderAware</code>ï¼šåŠ è½½Spring Beançš„ç±»åŠ è½½å™¨</li><li><code>BootstrapContextAware</code>ï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI</li><li><code>ResourceLoaderAware</code>ï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨</li><li><code>BeanFactoryAware</code>ï¼šå£°æ˜BeanFactory</li><li><code>PortletConfigAware</code>ï¼šPortletConfig</li><li><code>PortletContextAware</code>ï¼šPortletContext</li><li><code>ServletConfigAware</code>ï¼šServletConfig</li><li><code>ServletContextAware</code>ï¼šServletContext</li><li><code>MessageSourceAware</code>ï¼šå›½é™…åŒ–</li><li><code>ApplicationEventPublisherAware</code>ï¼šåº”ç”¨äº‹ä»¶</li><li><code>NotificationPublisherAware</code>ï¼šJMXé€šçŸ¥</li><li><code>BeanNameAware</code>ï¼šå£°æ˜Spring Beançš„åå­—</li></ul><p><code>invokeAwareMethods()</code> æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">      ((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">      ClassLoader bcl = getBeanClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (bcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">      ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç å°±æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦æ˜¯å¤„ç† BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareã€‚</p><p><strong>åç½®å¤„ç†å™¨çš„åº”ç”¨</strong> BeanPostProcessor åœ¨å‰é¢ä»‹ç» bean åŠ è½½çš„è¿‡ç¨‹æ›¾å¤šæ¬¡é‡åˆ°ï¼Œè¿™æ˜¯ Spring ä¸­å¼€æ”¾å¼æ¡†æ¶ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªäº®ç‚¹ã€‚ </p><p>BeanPostProcessor çš„ä½œç”¨æ˜¯ï¼š<u>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ Spring å®¹å™¨å®Œæˆ Bean çš„å®ä¾‹åŒ–ï¼Œé…ç½®å’Œå…¶ä»–çš„åˆå§‹åŒ–åæ·»åŠ ä¸€äº›è‡ªå·±çš„é€»è¾‘å¤„ç†ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨è¯¥æ¥å£ï¼Œè¿™ä¸ªæ¥å£ç»™ä¸äº†ç”¨æˆ·å……è¶³çš„æƒé™å»æ›´æ”¹æˆ–è€…æ‰©å±• Springï¼Œæ˜¯æˆ‘ä»¬å¯¹ Spring è¿›è¡Œæ‰©å±•å’Œå¢å¼ºå¤„ç†ä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ¥å£ã€‚</u></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  Object result = existingBean;</span><br><span class="line">  <span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">    Object current = beanProcessor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    result = current;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  Object result = existingBean;</span><br><span class="line">  <span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">    Object current = beanProcessor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    result = current;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é€»è¾‘å°±æ˜¯é€šè¿‡ <code>getBeanPostProcessors()</code> è·å–å®šä¹‰çš„ BeanPostProcessor ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨å…¶ <code>postProcessBeforeInitialization()</code>ã€<code>postProcessAfterInitialization()</code> è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</p><p><strong>æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³•</strong> å¦‚æœç†Ÿæ‚‰ <code>&lt;bean&gt;</code> æ ‡ç­¾çš„é…ç½®ï¼Œä¸€å®šä¸ä¼šå¿˜è®° <code>init-method</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ‰§è¡Œå°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeInitMethods</span><span class="params">(String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  <span class="comment">// é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦æ˜¯ InitializingBean ï¼Œå¦‚æœæ˜¯çš„è¯éœ€è¦è°ƒç”¨ afterPropertiesSet()</span></span><br><span class="line">  <span class="keyword">boolean</span> isInitializingBean = (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">  <span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">          ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;, getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> pae.getException();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å±æ€§åˆå§‹åŒ–çš„å¤„ç†</span></span><br><span class="line">      ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mbd != <span class="keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">    String initMethodName = mbd.getInitMethodName();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">        !(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">        !mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">      <span class="comment">// æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">      invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¸º InitializingBean ï¼Œå¦‚æœæ˜¯çš„è¯éœ€è¦æ‰§è¡Œ <code>afterPropertiesSet()</code>ï¼Œå› ä¸ºæˆ‘ä»¬é™¤äº†å¯ä»¥ä½¿ç”¨ <code>init-method</code> æ¥è‡ªå®šåˆå§‹åŒ–æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥å®ç° InitializingBean æ¥å£ï¼Œè¯¥æ¥å£ä»…æœ‰ä¸€ä¸ª <code>afterPropertiesSet()</code> æ–¹æ³•ï¼Œè€Œä¸¤è€…çš„æ‰§è¡Œå…ˆåé¡ºåºæ˜¯å…ˆ <code>afterPropertiesSet()</code> å <code>init-method</code>ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹å¾ªç¯ä¾èµ–</title>
      <link href="/blog/2020/01/21/7ee1f554.html"/>
      <url>/blog/2020/01/21/7ee1f554.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2887">http://cmsblogs.com/?p=2887</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>è¿™ç¯‡åˆ†æ <code>doCreateBean()</code> ç¬¬ä¸‰ä¸ªè¿‡ç¨‹ï¼šå¾ªç¯ä¾èµ–å¤„ç†ã€‚</p><p>å…¶å®å¾ªç¯ä¾èµ–å¹¶ä¸ä»…ä»…åªæ˜¯åœ¨ <code>doCreateBean()</code> ä¸­å¤„ç†ï¼Œå…¶å®åœ¨æ•´ä¸ªåŠ è½½ bean çš„è¿‡ç¨‹ä¸­éƒ½æœ‰æ¶‰åŠï¼Œæ‰€ä»¥ä¸‹ç¯‡å†…å®¹å¹¶ä¸ä»…ä»…åªå±€é™äº <code>doCreateBean()</code>ï¼Œè€Œæ˜¯ä»æ•´ä¸ª Bean çš„åŠ è½½è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚</p><h2 id="ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"><a href="#ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" class="headerlink" title="ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"></a>ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–</h2><p>å¾ªç¯ä¾èµ–å…¶å®å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œå°±æ˜¯ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„ bean äº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªé—­ç¯ï¼Œå¦‚ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼ŒC ä¾èµ– Aï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://gitee.com/chenssy/blog-home/raw/master/image/201811/201808131001.png"><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/24/201808131001_mrtCpY.png" alt="201808131001"></a></p><p>å¾ªç¯ä¾èµ– å…¶å®å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯çš„è¿‡ç¨‹ï¼Œåœ¨åˆå§‹åŒ– A çš„æ—¶å€™å‘ç°å¼•ç”¨äº† Bï¼Œè¿™æ—¶å°±ä¼šå»åˆå§‹åŒ– Bï¼Œç„¶ååˆå‘ç° B å¼•ç”¨ Cï¼Œè·‘å»åˆå§‹åŒ– Cï¼Œåˆå§‹åŒ– C çš„æ—¶å€™å‘ç°å¼•ç”¨äº† Aï¼Œåˆ™åˆä¼šå»åˆå§‹åŒ– Aï¼Œä¾æ¬¡å¾ªç¯æ°¸ä¸é€€å‡ºï¼Œé™¤éæœ‰ç»ˆç»“æ¡ä»¶ã€‚ Spring å¾ªç¯ä¾èµ–çš„åœºæ™¯æœ‰ä¸¤ç§ï¼š</p><ol><li><u>æ„é€ å™¨çš„å¾ªç¯ä¾èµ–</u></li><li><u>field å±æ€§çš„å¾ªç¯ä¾èµ–</u></li></ol><p>å¯¹äº<strong>æ„é€ å™¨çš„å¾ªç¯ä¾èµ–</strong>ï¼ŒSpring æ˜¯æ— æ³•è§£å†³çš„ï¼Œåªèƒ½æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸è¡¨ç¤ºå¾ªç¯ä¾èµ–ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åˆ†æçš„éƒ½æ˜¯åŸºäº field å±æ€§çš„å¾ªç¯ä¾èµ–ã€‚</p><p> åœ¨åšå®¢ <a href="/2020/01/15/27d87789.html"> IOC ä¹‹å¼€å¯ bean çš„åŠ è½½</a> ä¸­æåˆ°ï¼ŒSpring åªè§£å†³ scope ä¸º singleton çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºscope ä¸º prototype çš„ bean Spring æ— æ³•è§£å†³ï¼Œç›´æ¥æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚</p><p>ä¸ºä»€ä¹ˆ Spring ä¸å¤„ç† prototype beanï¼Œå…¶å®å¦‚æœç†è§£ Spring æ˜¯å¦‚ä½•è§£å†³ singleton bean çš„å¾ªç¯ä¾èµ–å°±æ˜ç™½äº†ã€‚</p><h2 id="è§£å†³å¾ªç¯ä¾èµ–"><a href="#è§£å†³å¾ªç¯ä¾èµ–" class="headerlink" title="è§£å†³å¾ªç¯ä¾èµ–"></a>è§£å†³å¾ªç¯ä¾èµ–</h2><p>æˆ‘ä»¬å…ˆä»åŠ è½½ bean æœ€åˆå§‹çš„æ–¹æ³• <code>doGetBean()</code> å¼€å§‹ã€‚ åœ¨ <code>doGetBean()</code> ä¸­ï¼Œé¦–å…ˆä¼šæ ¹æ® beanName ä»å•ä¾‹ bean ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object sharedInstance = getSingleton(beanName);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>getSingleton()</code> æ–¹æ³•ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">  Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">  <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">      singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">      <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">        ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">          singletonObject = singletonFactory.getObject();</span><br><span class="line">          <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">          <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ä»ä¸‰ä¸ªç¼“å­˜ä¸­è·å–ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>singletonObjects</code>ã€<code>earlySingletonObjects</code>ã€<code>singletonFactories</code>ï¼Œä¸‰è€…å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name --&gt; bean instance */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name --&gt; bean instance */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></table></figure><p>æ„ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>singletonObjectsï¼šå•ä¾‹å¯¹è±¡çš„cache</li><li>singletonFactories ï¼š å•ä¾‹å¯¹è±¡å·¥å‚çš„cache</li><li>earlySingletonObjects ï¼šæå‰æš´å…‰çš„å•ä¾‹å¯¹è±¡çš„Cache</li></ul><p>ä»–ä»¬å°±æ˜¯ Spring è§£å†³ singleton bean å¾ªç¯ä¾èµ–çš„å…³é”®å› ç´ æ‰€åœ¨ï¼Œæˆ‘ç§°ä»–ä»¬ä¸ºä¸‰çº§ç¼“å­˜ï¼Œç¬¬ä¸€çº§ä¸º singletonObjectsï¼Œç¬¬äºŒçº§ä¸º earlySingletonObjectsï¼Œç¬¬ä¸‰çº§ä¸º singletonFactoriesã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>getSingleton()</code> çœ‹åˆ°ä»–ä»¬æ˜¯å¦‚ä½•é…åˆçš„ï¼Œè¿™åˆ†æè¯¥æ–¹æ³•ä¹‹å‰ï¼Œæä¸‹å…¶ä¸­çš„ <code>isSingletonCurrentlyInCreation()</code> å’Œ <code>allowEarlyReference</code>ã€‚</p><ul><li><code>isSingletonCurrentlyInCreation()</code>ï¼šåˆ¤æ–­å½“å‰ singleton bean æ˜¯å¦å¤„äºåˆ›å»ºä¸­ã€‚bean å¤„äºåˆ›å»ºä¸­ä¹Ÿå°±æ˜¯è¯´ bean åœ¨åˆå§‹åŒ–ä½†æ˜¯æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ï¼Œæœ‰ä¸€ä¸ªè¿™æ ·çš„è¿‡ç¨‹å…¶å®å’Œ Spring è§£å†³ bean å¾ªç¯ä¾èµ–çš„ç†å¿µç›¸è¾…ç›¸æˆï¼Œå› ä¸º Spring è§£å†³ singleton bean çš„æ ¸å¿ƒå°±åœ¨äºæå‰æ›å…‰ beanã€‚</li><li><code>allowEarlyReference</code>ï¼šä»å­—é¢æ„æ€ä¸Šé¢ç†è§£å°±æ˜¯å…è®¸æå‰æ‹¿åˆ°å¼•ç”¨ã€‚å…¶å®çœŸæ­£çš„æ„æ€æ˜¯æ˜¯å¦å…è®¸ä» singletonFactories ç¼“å­˜ä¸­é€šè¿‡ <code>getObject()</code> æ‹¿åˆ°å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·ä¸€ä¸ªå­—æ®µå‘¢ï¼ŸåŸå› å°±åœ¨äº singletonFactories æ‰æ˜¯ Spring è§£å†³ singleton bean çš„è¯€çªæ‰€åœ¨ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­åˆ†æã€‚</li></ul><p><code>getSingleton()</code> æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆä»ä¸€çº§ç¼“å­˜ singletonObjects è·å–</li><li>å¦‚æœæ²¡æœ‰ä¸”å½“å‰æŒ‡å®šçš„ beanName æ­£åœ¨åˆ›å»ºï¼Œå°±å†ä»äºŒçº§ç¼“å­˜ä¸­ earlySingletonObjects è·å–</li><li>å¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°ä¸”è¿è¡Œ singletonFactories é€šè¿‡ <code>getObject()</code> è·å–ï¼Œåˆ™ä»ä¸‰çº§ç¼“å­˜ singletonFactories è·å–</li><li>å¦‚æœè·å–åˆ°åˆ™ï¼Œé€šè¿‡å…¶ <code>getObject()</code> è·å–å¯¹è±¡ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­ ä»ä¸‰çº§ç¼“å­˜ singletonFactories åˆ é™¤ï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">singletonObject = singletonFactory.getObject();</span><br><span class="line"><span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line"><span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±ä»ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äºŒçº§ç¼“å­˜äº†ã€‚ ä¸Šé¢æ˜¯ä»ç¼“å­˜ä¸­è·å–ï¼Œä½†æ˜¯ç¼“å­˜ä¸­çš„æ•°æ®ä»å“ªé‡Œæ·»åŠ è¿›æ¥çš„å‘¢ï¼Ÿä¸€ç›´å¾€ä¸‹è·Ÿä¼šå‘ç°åœ¨ <code>doCreateBean()</code> ( AbstractAutowireCapableBeanFactory ) ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName));</span><br><span class="line"><span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                        <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>earlySingletonExposure == true</code> çš„è¯ï¼Œåˆ™è°ƒç”¨ <code>addSingletonFactory()</code> å°†ä»–ä»¬æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œä½†æ˜¯ä¸€ä¸ª bean è¦å…·å¤‡å¦‚ä¸‹æ¡ä»¶æ‰ä¼šæ·»åŠ è‡³ç¼“å­˜ä¸­ï¼š</p><ul><li>å•ä¾‹</li><li>è¿è¡Œæå‰æš´éœ² bean</li><li>å½“å‰ bean æ­£åœ¨åˆ›å»ºä¸­</li></ul><p><code>addSingletonFactory()</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(singletonFactory, <span class="string">&quot;Singleton factory must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">      <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">      <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡º singletonFactories è¿™ä¸ªä¸‰çº§ç¼“å­˜æ‰æ˜¯è§£å†³ Spring Bean å¾ªç¯ä¾èµ–çš„è¯€çªæ‰€åœ¨ã€‚</p><p><strong>åŒæ—¶è¿™æ®µä»£ç å‘ç”Ÿåœ¨ <code>createBeanInstance()</code> æ–¹æ³•ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª bean å…¶å®å·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†ï¼Œä½†æ˜¯å®ƒè¿˜ä¸æ˜¯å¾ˆå®Œç¾ï¼ˆæ²¡æœ‰è¿›è¡Œå±æ€§å¡«å……å’Œåˆå§‹åŒ–ï¼‰ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–ä¾èµ–å®ƒçš„å¯¹è±¡è€Œè¨€å·²ç»è¶³å¤Ÿäº†ï¼ˆå¯ä»¥æ ¹æ®å¯¹è±¡å¼•ç”¨å®šä½åˆ°å †ä¸­å¯¹è±¡ï¼‰ï¼Œèƒ½å¤Ÿè¢«è®¤å‡ºæ¥äº†ï¼Œæ‰€ä»¥ Spring åœ¨è¿™ä¸ªæ—¶å€™é€‰æ‹©å°†è¯¥å¯¹è±¡æå‰æ›å…‰å‡ºæ¥è®©å¤§å®¶è®¤è¯†è®¤è¯†ã€‚</strong> </p><p>ä»‹ç»åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ä¸‰çº§ç¼“å­˜ singletonFactories å’Œ äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­çš„å€¼éƒ½æœ‰å‡ºå¤„äº†ï¼Œé‚£ä¸€çº§ç¼“å­˜åœ¨å“ªé‡Œè®¾ç½®çš„å‘¢ï¼Ÿåœ¨ç±» DefaultSingletonBeanRegistry ä¸­å¯ä»¥å‘ç°è¿™ä¸ª <code>addSingleton()</code> æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">    <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">    <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ è‡³ä¸€çº§ç¼“å­˜ï¼ŒåŒæ—¶ä»äºŒçº§ã€ä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤ã€‚è¿™ä¸ªæ–¹æ³•åœ¨æˆ‘ä»¬åˆ›å»º bean çš„é“¾è·¯ä¸­æœ‰å“ªä¸ªåœ°æ–¹å¼•ç”¨å‘¢ï¼Ÿ</p><p>åœ¨ <code>doGetBean()</code> å¤„ç†ä¸åŒ scope æ—¶ï¼Œå¦‚æœæ˜¯ singletonï¼Œåˆ™è°ƒç”¨ <code>getSingleton()</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://gitee.com/chenssy/blog-home/raw/master/image/201811/15341402420152.jpg"><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/24/15341402420152_OJNpZi.jpg" alt="img"></a></p><p>å‰é¢å‡ ç¯‡åšå®¢å·²ç»åˆ†æäº† <code>createBean()</code>ï¼Œè¿™é‡Œå°±ä¸å†é˜è¿°äº†ï¼Œæˆ‘ä»¬å…³æ³¨æ–¹æ³• <code>getSingleton()</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(beanName, <span class="string">&quot;Bean name must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//....</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        singletonObject = singletonFactory.getObject();</span><br><span class="line">        newSingleton = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//.....</span></span><br><span class="line">      <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">        addSingleton(beanName, singletonObject);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒSpring å…³äº singleton bean å¾ªç¯ä¾èµ–å·²ç»åˆ†æå®Œæ¯•äº†ã€‚</p><p>æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥ç¡®å®š Spring è§£å†³å¾ªç¯ä¾èµ–çš„æ–¹æ¡ˆäº†ï¼š</p><p>Spring åœ¨åˆ›å»º bean çš„æ—¶å€™å¹¶ä¸æ˜¯ç­‰å®ƒå®Œå…¨å®Œæˆï¼Œè€Œæ˜¯åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å°†åˆ›å»ºä¸­çš„ bean çš„ ObjectFactory æå‰æ›å…‰ï¼ˆå³åŠ å…¥åˆ° singletonFactories ç¼“å­˜ä¸­ï¼‰ï¼Œè¿™æ ·ä¸€æ—¦ä¸‹ä¸€ä¸ª bean åˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ– bean ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ ObjectFactory çš„ <code>getObject()</code> è·å–äº†ï¼Œä¹Ÿå°±æ˜¯ <code>getSingleton()</code> ä¸­çš„ä»£ç ç‰‡æ®µäº†ã€‚ åˆ°è¿™é‡Œï¼Œå…³äº Spring è§£å†³ bean å¾ªç¯ä¾èµ–å°±å·²ç»åˆ†æå®Œæ¯•äº†ã€‚</p><p>æœ€åæ¥æè¿°ä¸‹å°±ä¸Šé¢é‚£ä¸ªå¾ªç¯ä¾èµ– Spring è§£å†³çš„è¿‡ç¨‹ï¼š</p><p>é¦–å…ˆ A å®Œæˆåˆå§‹åŒ–ç¬¬ä¸€æ­¥å¹¶å°†è‡ªå·±æå‰æ›å…‰å‡ºæ¥ï¼ˆé€šè¿‡ ObjectFactory å°†è‡ªå·±æå‰æ›å…‰ï¼‰ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±ä¾èµ–å¯¹è±¡ Bï¼Œæ­¤æ—¶å°±ä¼šå»å°è¯• get(B)ï¼Œè¿™ä¸ªæ—¶å€™å‘ç° B è¿˜æ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œç„¶å B å°±èµ°åˆ›å»ºæµç¨‹ï¼Œåœ¨ B åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒåŒæ ·å‘ç°è‡ªå·±ä¾èµ– Cï¼ŒC ä¹Ÿæ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™ C åˆå¼€å§‹åˆå§‹åŒ–è¿›ç¨‹ï¼Œä½†æ˜¯åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­å‘ç°è‡ªå·±ä¾èµ– Aï¼Œäºæ˜¯å°è¯• get(A)ï¼Œè¿™ä¸ªæ—¶å€™ç”±äº A å·²ç»æ·»åŠ è‡³ç¼“å­˜ä¸­ï¼ˆä¸€èˆ¬éƒ½æ˜¯æ·»åŠ è‡³ä¸‰çº§ç¼“å­˜ singletonFactories ï¼‰ï¼Œé€šè¿‡ ObjectFactory æå‰æ›å…‰ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ <code>ObjectFactory.getObject()</code> æ‹¿åˆ° A å¯¹è±¡ï¼ŒC æ‹¿åˆ° A å¯¹è±¡åé¡ºåˆ©å®Œæˆåˆå§‹åŒ–ï¼Œç„¶åå°†è‡ªå·±æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œå›åˆ° B ï¼ŒB ä¹Ÿå¯ä»¥æ‹¿åˆ° C å¯¹è±¡ï¼Œå®Œæˆåˆå§‹åŒ–ï¼ŒA å¯ä»¥é¡ºåˆ©æ‹¿åˆ° B å®Œæˆåˆå§‹åŒ–ã€‚åˆ°è¿™é‡Œæ•´ä¸ªé“¾è·¯å°±å·²ç»å®Œæˆäº†åˆå§‹åŒ–è¿‡ç¨‹äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹å±æ€§å¡«å……</title>
      <link href="/blog/2020/01/20/1293fb33.html"/>
      <url>/blog/2020/01/20/1293fb33.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2885">http://cmsblogs.com/?p=2885</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><code>doCreateBean()</code> ä¸»è¦ç”¨äºå®Œæˆ bean çš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸ºå››ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/23/image-20200523100857745_W6BGWx.png" alt="image-20200523100857745"></p><p>ç¬¬ä¸€ä¸ªè¿‡ç¨‹å®ä¾‹åŒ– bean å·²ç»åœ¨å‰é¢ä¸¤ç¯‡åšå®¢åˆ†æå®Œæ¯•äº†ï¼Œè¿™ç¯‡åšå®¢å¼€å§‹åˆ†æ å±æ€§å¡«å……ï¼Œä¹Ÿå°±æ˜¯ <code>populateBean()</code>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å°† BeanDefinition ä¸­çš„å±æ€§å€¼èµ‹å€¼ç»™ BeanWrapper å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ]String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> BeanWrapper bw)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (bw == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æœ‰å±æ€§æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.hasPropertyValues()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(),</span><br><span class="line">        beanName, <span class="string">&quot;Cannot apply property values to null instance&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ²¡æœ‰å±æ€§ç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨è®¾ç½®å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼š</span></span><br><span class="line">  <span class="keyword">boolean</span> continueWithPropertyPopulation = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bena ä¸æ˜¯&quot;åˆæˆ&quot;çš„ï¼Œå³æœªç”±åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰</span></span><br><span class="line">  <span class="comment">// æ˜¯å¦æŒæœ‰ InstantiationAwareBeanPostProcessor</span></span><br><span class="line">  <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">    <span class="comment">// è¿­ä»£æ‰€æœ‰çš„ BeanPostProcessors</span></span><br><span class="line">    <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸º InstantiationAwareBeanPostProcessor</span></span><br><span class="line">      <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">        InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">        <span class="comment">// è¿”å›å€¼ä¸ºæ˜¯å¦ç»§ç»­å¡«å…… bean</span></span><br><span class="line">        <span class="comment">// postProcessAfterInstantiationï¼šå¦‚æœåº”è¯¥åœ¨ beanä¸Šé¢è®¾ç½®å±æ€§åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">        <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯è¿”å›trueï¼Œè¿”å› false çš„è¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// å°†ä¼šé˜»æ­¢åœ¨æ­¤ Bean å®ä¾‹ä¸Šè°ƒç”¨ä»»ä½•åç»­çš„ InstantiationAwareBeanPostProcessor å®ä¾‹ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">          continueWithPropertyPopulation = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœåç»­å¤„ç†å™¨å‘å‡ºåœæ­¢å¡«å……å‘½ä»¤ï¼Œåˆ™ç»ˆæ­¢åç»­æ“ä½œ</span></span><br><span class="line">  <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bean çš„å±æ€§å€¼</span></span><br><span class="line">  PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† PropertyValues å°è£…æˆ MutablePropertyValues å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// MutablePropertyValues å…è®¸å¯¹å±æ€§è¿›è¡Œç®€å•çš„æ“ä½œï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶æä¾›æ„é€ å‡½æ•°ä»¥æ”¯æŒMapçš„æ·±åº¦å¤åˆ¶å’Œæ„é€ ã€‚</span></span><br><span class="line">    MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">      autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ç±»å‹è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">      autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pvs = newPvs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»æ³¨å†Œäº† InstantiationAwareBeanPostProcessors</span></span><br><span class="line">  <span class="keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">      pvs = mbd.getPropertyValues();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» bw å¯¹è±¡ä¸­æå– PropertyDescriptor ç»“æœé›†</span></span><br><span class="line">    <span class="comment">// PropertyDescriptorï¼šå¯ä»¥é€šè¿‡ä¸€å¯¹å­˜å–æ–¹æ³•æå–ä¸€ä¸ªå±æ€§</span></span><br><span class="line">    PropertyDescriptor[] filteredPds = </span><br><span class="line">      filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">    <span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">      <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">          InstantiationAwareBeanPostProcessor ibp = </span><br><span class="line">            (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">          <span class="comment">// å¯¹æ‰€æœ‰éœ€è¦ä¾èµ–æ£€æŸ¥çš„å±æ€§è¿›è¡Œåå¤„ç†</span></span><br><span class="line">          pvs = ibp.postProcessPropertyValues(</span><br><span class="line">            pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">          <span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">      <span class="comment">// ä¾èµ–æ£€æŸ¥ï¼Œå¯¹åº” depends-on å±æ€§</span></span><br><span class="line">      checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pvs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å°†å±æ€§åº”ç”¨åˆ° bean ä¸­</span></span><br><span class="line">    applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ ¹æ® hasInstantiationAwareBeanPostProcessors å±æ€§æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨æ³¨å…¥å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼šï¼Œæ­¤è¿‡ç¨‹å¯ä»¥æ§åˆ¶ Spring æ˜¯å¦ç»§ç»­è¿›è¡Œå±æ€§å¡«å……ã€‚</li><li>æ ¹æ®æ³¨å…¥ç±»å‹çš„ä¸åŒæ¥åˆ¤æ–­æ˜¯æ ¹æ®åç§°æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆ<code>autowireByName()</code>ï¼‰è¿˜æ˜¯æ ¹æ®ç±»å‹æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆ<code>autowireByType()</code>ï¼‰ï¼Œç»Ÿä¸€å­˜å…¥åˆ° PropertyValues ä¸­ï¼ŒPropertyValues ç”¨äºæè¿° bean çš„å±æ€§ã€‚</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ BeanPostProcessor å’Œ ä¾èµ–æ£€æµ‹ã€‚</li><li>å°†æ‰€æœ‰ PropertyValues ä¸­çš„å±æ€§å¡«å……åˆ° BeanWrapper ä¸­ã€‚</li></ol><h2 id="è‡ªåŠ¨æ³¨å…¥"><a href="#è‡ªåŠ¨æ³¨å…¥" class="headerlink" title="è‡ªåŠ¨æ³¨å…¥"></a>è‡ªåŠ¨æ³¨å…¥</h2><p>Spring ä¼šæ ¹æ®æ³¨å…¥ç±»å‹ï¼ˆ byName / byType ï¼‰çš„ä¸åŒï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼ˆ<code>autowireByName()</code> / <code>autowireByType()</code>ï¼‰æ¥æ³¨å…¥å±æ€§å€¼ã€‚</p><p><strong>autowireByName()</strong> æ–¹æ³• <code>autowireByName()</code> æ˜¯æ ¹æ®å±æ€§åç§°å®Œæˆè‡ªåŠ¨ä¾èµ–æ³¨å…¥çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">autowireByName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, AbstractBeanDefinition mbd, </span></span></span><br><span class="line"><span class="function"><span class="params">  BeanWrapper bw, MutablePropertyValues pvs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹ Bean å¯¹è±¡ä¸­éç®€å•å±æ€§</span></span><br><span class="line">  String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);</span><br><span class="line">  <span class="keyword">for</span> (String propertyName : propertyNames) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå®¹å™¨ä¸­åŒ…å«æŒ‡å®šåç§°çš„ beanï¼Œåˆ™å°†è¯¥ bean æ³¨å…¥åˆ° beanä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (containsBean(propertyName)) &#123;</span><br><span class="line">      <span class="comment">// é€’å½’åˆå§‹åŒ–ç›¸å…³ bean</span></span><br><span class="line">      Object bean = getBean(propertyName);</span><br><span class="line">      <span class="comment">// ä¸ºæŒ‡å®šåç§°çš„å±æ€§èµ‹äºˆå±æ€§å€¼  </span></span><br><span class="line">      pvs.add(propertyName, bean);</span><br><span class="line">      <span class="comment">// å±æ€§ä¾èµ–æ³¨å…¥</span></span><br><span class="line">      registerDependentBean(propertyName, beanName);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(</span><br><span class="line">          <span class="string">&quot;Added autowiring by name from bean name &#x27;&quot;</span> + beanName </span><br><span class="line">          + <span class="string">&quot;&#x27; via property &#x27;&quot;</span> + propertyName + <span class="string">&quot;&#x27; to bean named &#x27;&quot;</span> + propertyName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Not autowiring property &#x27;&quot;</span> + propertyName + <span class="string">&quot;&#x27; of bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                     <span class="string">&quot;&#x27; by name: no matching bean found&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•é€»è¾‘å¾ˆç®€å•ï¼Œè·å–è¯¥ bean çš„éç®€å•å±æ€§ï¼Œä»€ä¹ˆå«åšéç®€å•å±æ€§å‘¢ï¼Ÿå°±æ˜¯ç±»å‹ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸æ˜¯å°†æ‰€æœ‰çš„å¯¹è±¡ç±»å‹éƒ½éƒ½ä¼šæ‰¾åˆ°ï¼Œæ¯”å¦‚ 8 ä¸ªåŸå§‹ç±»å‹ï¼ŒString ç±»å‹ ï¼ŒNumberç±»å‹ã€Dateç±»å‹ã€URLç±»å‹ã€URIç±»å‹ç­‰éƒ½ä¼šè¢«å¿½ç•¥ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> String[] unsatisfiedNonSimpleProperties(</span><br><span class="line">  AbstractBeanDefinition mbd, BeanWrapper bw) &#123;</span><br><span class="line">  Set&lt;String&gt; result = <span class="keyword">new</span> TreeSet&lt;&gt;();</span><br><span class="line">  PropertyValues pvs = mbd.getPropertyValues();</span><br><span class="line">  PropertyDescriptor[] pds = bw.getPropertyDescriptors();</span><br><span class="line">  <span class="keyword">for</span> (PropertyDescriptor pd : pds) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pd.getWriteMethod() != <span class="keyword">null</span> </span><br><span class="line">        &amp;&amp; !isExcludedFromDependencyCheck(pd) </span><br><span class="line">        &amp;&amp; !pvs.contains(pd.getName()) </span><br><span class="line">        &amp;&amp; !BeanUtils.isSimpleProperty(pd.getPropertyType())) &#123;</span><br><span class="line">      result.add(pd.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> StringUtils.toStringArray(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤æ¡ä»¶ä¸ºï¼š<strong>æœ‰å¯å†™æ–¹æ³•</strong>ã€<strong>ä¾èµ–æ£€æµ‹ä¸­æ²¡æœ‰è¢«å¿½ç•¥</strong>ã€<strong>ä¸æ˜¯ç®€å•å±æ€§ç±»å‹</strong>ã€‚å…¶å®è¿™é‡Œè·å–çš„å°±æ˜¯éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§ã€‚ è·å–éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§åï¼Œé€šè¿‡è¿­ä»£ã€é€’å½’çš„æ–¹å¼åˆå§‹åŒ–ç›¸å…³çš„ beanï¼Œç„¶åè°ƒç”¨ <code>registerDependentBean()</code> å®Œæˆæ³¨å†Œä¾èµ–ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDependentBean</span><span class="params">(String beanName, String dependentBeanName)</span> </span>&#123;</span><br><span class="line">  String canonicalName = canonicalName(beanName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependentBeanMap) &#123;</span><br><span class="line">    Set&lt;String&gt; dependentBeans =</span><br><span class="line">      <span class="keyword">this</span>.dependentBeanMap.computeIfAbsent(canonicalName, k -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>));</span><br><span class="line">    <span class="keyword">if</span> (!dependentBeans.add(dependentBeanName)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependenciesForBeanMap) &#123;</span><br><span class="line">    Set&lt;String&gt; dependenciesForBean =</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">this</span>.dependenciesForBeanMap.computeIfAbsent(dependentBeanName, </span><br><span class="line">                                                  k -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>));</span><br><span class="line">    dependenciesForBean.add(canonicalName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>autowireByType()</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">autowireByType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, AbstractBeanDefinition mbd,</span></span></span><br><span class="line"><span class="function"><span class="params">  BeanWrapper bw, MutablePropertyValues pvs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– TypeConverter å®ä¾‹</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„ TypeConverterï¼Œç”¨äºå–ä»£é»˜è®¤çš„ PropertyEditor æœºåˆ¶</span></span><br><span class="line">  TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">  <span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</span><br><span class="line">    converter = bw;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Set&lt;String&gt; autowiredBeanNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">  <span class="comment">// è·å–éç®€å•å±æ€§</span></span><br><span class="line">  String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (String propertyName : propertyNames) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è·å– PropertyDescriptor å®ä¾‹</span></span><br><span class="line">      PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸è¦å°è¯•æŒ‰ç±»å‹</span></span><br><span class="line">      <span class="keyword">if</span> (Object.class != pd.getPropertyType()) &#123;</span><br><span class="line">        <span class="comment">// æ¢æµ‹æŒ‡å®šå±æ€§çš„ set æ–¹æ³•</span></span><br><span class="line">        MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> eager = !PriorityOrdered.class.isInstance(bw.getWrappedInstance());</span><br><span class="line">        DependencyDescriptor desc = </span><br><span class="line">          <span class="keyword">new</span> AbstractAutowireCapableBeanFactory</span><br><span class="line">          .AutowireByTypeDependencyDescriptor(methodParam, eager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£ææŒ‡å®š beanName çš„å±æ€§æ‰€åŒ¹é…çš„å€¼ï¼Œå¹¶æŠŠè§£æåˆ°çš„å±æ€§åç§°å­˜å‚¨åœ¨ autowiredBeanNames ä¸­</span></span><br><span class="line">        <span class="comment">// å½“å±æ€§å­˜åœ¨è¿‡ä¸ªå°è£… bean æ—¶å°†ä¼šæ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ bean å¹¶å°†å…¶æ³¨å…¥</span></span><br><span class="line">        Object autowiredArgument = </span><br><span class="line">          resolveDependency(desc, beanName, autowiredBeanNames, converter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (autowiredArgument != <span class="keyword">null</span>) &#123;</span><br><span class="line">          pvs.add(propertyName, autowiredArgument);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿­ä»£æ–¹å¼æ³¨å…¥ bean </span></span><br><span class="line">        <span class="keyword">for</span> (String autowiredBeanName : autowibeanredBeanNames) &#123;</span><br><span class="line">          registerDependentBean(autowiredBeanName, beanName);</span><br><span class="line">          <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Autowiring by type from bean name &#x27;&quot;</span> </span><br><span class="line">                         + beanName + <span class="string">&quot;&#x27; via property &#x27;&quot;</span> +</span><br><span class="line">                         propertyName + <span class="string">&quot;&#x27; to bean named &#x27;&quot;</span> + autowiredBeanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        autowiredBeanNames.clear();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsatisfiedDependencyException(</span><br><span class="line">        mbd.getResourceDescription(), beanName, propertyName, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¸»è¦è¿‡ç¨‹å’Œæ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥å·®ä¸å¤šéƒ½æ˜¯æ‰¾åˆ°éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§ï¼Œç„¶åé€šè¿‡è¿­ä»£çš„æ–¹å¼å¯»æ‰¾æ‰€åŒ¹é…çš„ beanï¼Œæœ€åè°ƒç”¨ <code>registerDependentBean()</code> æ³¨å†Œä¾èµ–ã€‚ä¸è¿‡ç›¸å¯¹äº <code>autowireByName()</code> è€Œè¨€ï¼Œæ ¹æ®ç±»å‹å¯»æ‰¾ç›¸åŒ¹é…çš„ bean è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢æˆ‘ä»¬å°±åˆ†æè¿™ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveDependency</span><span class="params">(DependencyDescriptor descriptor, <span class="meta">@Nullable</span> String requestingBeanName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, <span class="meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å‚æ•°åç§°å‘ç°å™¨ï¼Œè¯¥æ–¹æ³•å¹¶ä¸ä¼šåœ¨è¿™ä¸ªæ—¶å€™å°è¯•æ£€ç´¢å‚æ•°åç§°</span></span><br><span class="line">    <span class="comment">// getParameterNameDiscoverer è¿”å› parameterNameDiscoverer å®ä¾‹ï¼ŒparameterNameDiscoverer æ–¹æ³•å‚æ•°åç§°çš„è§£æå™¨</span></span><br><span class="line">    descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾èµ–ç±»å‹ä¸º Optional ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (Optional.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º Optional å®ä¾‹ä¾èµ–ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> createOptionalDependency(descriptor, requestingBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾èµ–ç±»å‹ä¸ºObjectFactoryã€ObjectProvider</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ObjectFactory.class == descriptor.getDependencyType() ||</span><br><span class="line">            ObjectProvider.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">        <span class="comment">// ObjectFactory / ObjectProvider ç”¨äº ç”¨äºå»¶è¿Ÿè§£æä¾èµ–é¡¹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultListableBeanFactory.DependencyObjectProvider(descriptor, requestingBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;</span><br><span class="line">        <span class="comment">// javaxInjectProviderClass ç±»æ³¨å…¥çš„ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultListableBeanFactory.Jsr330ProviderFactory().createDependencyProvider(descriptor, requestingBeanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸ºå®é™…ä¾èµ–å…³ç³»ç›®æ ‡çš„å»¶è¿Ÿè§£ææ„å»ºä»£ç†</span></span><br><span class="line">        <span class="comment">// é»˜è®¤å®ç°è¿”å› null</span></span><br><span class="line">        Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(</span><br><span class="line">                descriptor, requestingBeanName);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šç”¨å¤„ç†é€»è¾‘</span></span><br><span class="line">            result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…³æ³¨é€šç”¨å¤„ç†é€»è¾‘ï¼š<code>doResolveDependency()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doResolveDependency</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DependencyDescriptor descriptor, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> String beanName,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> Set&lt;String&gt; autowiredBeanNames, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> TypeConverter typeConverter)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å…¥ç‚¹</span></span><br><span class="line">  InjectionPoint previousInjectionPoint = </span><br><span class="line">    ConstructorResolver.setCurrentInjectionPoint(descriptor);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// é’ˆå¯¹ç»™å®šçš„å·¥å‚ç»™å®šä¸€ä¸ªå¿«æ·å®ç°çš„æ–¹å¼ï¼Œä¾‹å¦‚è€ƒè™‘ä¸€äº›é¢„å…ˆè§£æçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// åœ¨è¿›å…¥æ‰€æœ‰beançš„å¸¸è§„ç±»å‹åŒ¹é…ç®—æ³•ä¹‹å‰ï¼Œè§£æç®—æ³•å°†é¦–å…ˆå°è¯•é€šè¿‡æ­¤æ–¹æ³•è§£æå¿«æ·æ–¹å¼ã€‚</span></span><br><span class="line">    <span class="comment">// å­ç±»å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•</span></span><br><span class="line">    Object shortcut = descriptor.resolveShortcut(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (shortcut != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// è¿”å›å¿«æ·çš„è§£æä¿¡æ¯</span></span><br><span class="line">      <span class="keyword">return</span> shortcut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾èµ–çš„ç±»å‹</span></span><br><span class="line">    Class&lt;?&gt; type = descriptor.getDependencyType();</span><br><span class="line">    <span class="comment">// æ”¯æŒ Spring çš„æ³¨è§£ @value</span></span><br><span class="line">    Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        String strVal = resolveEmbeddedValue((String) value);</span><br><span class="line">        BeanDefinition bd = (beanName != <span class="keyword">null</span> &amp;&amp; containsBean(beanName) ? </span><br><span class="line">                             getMergedBeanDefinition(beanName) : <span class="keyword">null</span>);</span><br><span class="line">        value = evaluateBeanDefinitionString(strVal, bd);</span><br><span class="line">      &#125;</span><br><span class="line">      TypeConverter converter = </span><br><span class="line">        (typeConverter != <span class="keyword">null</span> ? typeConverter : getTypeConverter());</span><br><span class="line">      <span class="keyword">return</span> (descriptor.getField() != <span class="keyword">null</span> ?</span><br><span class="line">              converter.convertIfNecessary(value, type, descriptor.getField()) :</span><br><span class="line">              converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå¤åˆ beanï¼Œå…¶å®å°±æ˜¯å¯¹ bean çš„å±æ€§è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="comment">// åŒ…æ‹¬ï¼šæ•°ç»„ã€Collection ã€Map ç±»å‹</span></span><br><span class="line">    Object multipleBeans = </span><br><span class="line">      resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">    <span class="keyword">if</span> (multipleBeans != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> multipleBeans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ä¸ç±»å‹ç›¸åŒ¹é…çš„ bean</span></span><br><span class="line">    <span class="comment">// è¿”å›å€¼æ„æˆä¸ºï¼škey = åŒ¹é…çš„ beanNameï¼Œvalue = beanName å¯¹åº”çš„å®ä¾‹åŒ– bean</span></span><br><span class="line">    Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€éªŒ @autowire  çš„ require æ˜¯å¦ä¸º true</span></span><br><span class="line">    <span class="keyword">if</span> (matchingBeans.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ @autowire çš„ require å±æ€§ä¸º true ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„åŒ¹é…é¡¹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (isRequired(descriptor)) &#123;</span><br><span class="line">        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String autowiredBeanName;</span><br><span class="line">    Object instanceCandidate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (matchingBeans.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">//  ç¡®è®¤ç»™å®š bean autowire çš„å€™é€‰è€…</span></span><br><span class="line">      <span class="comment">// æŒ‰ç…§ @Primary å’Œ @Priority çš„é¡ºåº</span></span><br><span class="line">      autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);</span><br><span class="line">      <span class="keyword">if</span> (autowiredBeanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;</span><br><span class="line">          <span class="comment">// å”¯ä¸€æ€§å¤„ç†</span></span><br><span class="line">          <span class="keyword">return</span> descriptor.resolveNotUnique(type, matchingBeans);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// åœ¨å¯é€‰çš„Collection / Mapçš„æƒ…å†µä¸‹ï¼Œ</span></span><br><span class="line">          <span class="comment">// é»˜é»˜åœ°å¿½ç•¥ä¸€ä¸ªéå”¯ä¸€çš„æƒ…å†µï¼šå¯èƒ½å®ƒæ˜¯ä¸€ä¸ªå¤šä¸ªå¸¸è§„beançš„ç©ºé›†åˆ</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      instanceCandidate = matchingBeans.get(autowiredBeanName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// We have exactly one match.</span></span><br><span class="line">      Map.Entry&lt;Staring, Object&gt; entry = matchingBeans.entrySet().iterator().next();</span><br><span class="line">      autowiredBeanName = entry.getKey();</span><br><span class="line">      instanceCandidate = entry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (autowiredBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">      autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instanceCandidate <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">      instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object result = instanceCandidate;</span><br><span class="line">    <span class="keyword">if</span> (result <span class="keyword">instanceof</span> NullBean) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isRequired(descriptor)) &#123;</span><br><span class="line">        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ClassUtils.isAssignableValue(type, result)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(</span><br><span class="line">        autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±å·²ç»å®Œæˆäº†æ‰€æœ‰å±æ€§çš„æ³¨å…¥äº†ã€‚<code>populateBean()</code> è¯¥æ–¹æ³•å°±å·²ç»å®Œæˆäº†ä¸€å¤§åŠå·¥ä½œäº†ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯å¯¹ä¾èµ– bean çš„æ£€æµ‹å’Œ PostProcessor å¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢åˆ†æï¼Œä¸‹é¢åˆ†æè¯¥æ–¹æ³•çš„æœ€åä¸€æ­¥ï¼š<code>applyPropertyValues()</code></p><h2 id="applyPropertyValues"><a href="#applyPropertyValues" class="headerlink" title="applyPropertyValues"></a>applyPropertyValues</h2><p>å…¶å®ä¸Šé¢åªæ˜¯å®Œæˆäº†æ‰€æœ‰æ³¨å…¥å±æ€§çš„è·å–ï¼Œå°†è·å–çš„å±æ€§å°è£…åœ¨ PropertyValues çš„å®ä¾‹å¯¹è±¡ pvs ä¸­ï¼Œå¹¶æ²¡æœ‰åº”ç”¨åˆ°å·²ç»å®ä¾‹åŒ–çš„ bean ä¸­ï¼Œè€Œ <code>applyPropertyValues()</code> åˆ™æ˜¯å®Œæˆè¿™ä¸€æ­¥éª¤çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyPropertyValues</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (pvs.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; bw <span class="keyword">instanceof</span> BeanWrapperImpl) &#123;</span><br><span class="line">    ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MutablePropertyValues ç±»å‹å±æ€§</span></span><br><span class="line">  MutablePropertyValues mpvs = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// åŸå§‹ç±»å‹</span></span><br><span class="line">  List&lt;PropertyValue&gt; original;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pvs <span class="keyword">instanceof</span> MutablePropertyValues) &#123;</span><br><span class="line">    mpvs = (MutablePropertyValues) pvs;</span><br><span class="line">    <span class="keyword">if</span> (mpvs.isConverted()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®åˆ° BeanWrapper ä¸­å»</span></span><br><span class="line">        bw.setPropertyValues(mpvs);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          mbd.getResourceDescription(), beanName, <span class="string">&quot;Error setting property values&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    original = mpvs.getPropertyValueList();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ pvs ä¸æ˜¯ MutablePropertyValues ç±»å‹ï¼Œåˆ™ç›´æ¥ä½¿ç”¨åŸå§‹ç±»å‹</span></span><br><span class="line">    original = Arrays.asList(pvs.getPropertyValues());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– TypeConverter</span></span><br><span class="line">  TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">  <span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</span><br><span class="line">    converter = bw;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å¯¹åº”çš„è§£æå™¨</span></span><br><span class="line">  BeanDefinitionValueResolver valueResolver </span><br><span class="line">    = <span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>, beanName, mbd, converter);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a deep copy, resolving any references for values.</span></span><br><span class="line">  List&lt;PropertyValue&gt; deepCopy = <span class="keyword">new</span> ArrayList&lt;&gt;(original.size());</span><br><span class="line">  <span class="keyword">boolean</span> resolveNecessary = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">// éå†å±æ€§ï¼Œå°†å±æ€§è½¬æ¢ä¸ºå¯¹åº”ç±»çš„å¯¹åº”å±æ€§çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">for</span> (PropertyValue pv : original) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pv.isConverted()) &#123;</span><br><span class="line">      deepCopy.add(pv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      String propertyName = pv.getName();</span><br><span class="line">      Object originalValue = pv.getValue();</span><br><span class="line">      Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">      Object convertedValue = resolvedValue;</span><br><span class="line">      <span class="keyword">boolean</span> convertible = bw.isWritableProperty(propertyName) &amp;&amp;</span><br><span class="line">        !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</span><br><span class="line">      <span class="keyword">if</span> (convertible) &#123;</span><br><span class="line">        convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Possibly store converted value in merged bean definition,</span></span><br><span class="line">      <span class="comment">// in order to avoid re-conversion for every created bean instance.</span></span><br><span class="line">      <span class="keyword">if</span> (resolvedValue == originalValue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (convertible) &#123;</span><br><span class="line">          pv.setConvertedValue(convertedValue);</span><br><span class="line">        &#125;</span><br><span class="line">        deepCopy.add(pv);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (convertible &amp;&amp; originalValue <span class="keyword">instanceof</span> TypedStringValue &amp;&amp;</span><br><span class="line">               !((TypedStringValue) originalValue).isDynamic() &amp;&amp;</span><br><span class="line">               !(convertedValue <span class="keyword">instanceof</span> Collection || </span><br><span class="line">                 ObjectUtils.isArray(convertedValue))) &#123;</span><br><span class="line">        pv.setConvertedValue(convertedValue);</span><br><span class="line">        deepCopy.add(pv);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        resolveNecessary = <span class="keyword">true</span>;</span><br><span class="line">        deepCopy.add(<span class="keyword">new</span> PropertyValue(pv, convertedValue));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mpvs != <span class="keyword">null</span> &amp;&amp; !resolveNecessary) &#123;</span><br><span class="line">    mpvs.setConverted();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set our (possibly massaged) deep copy.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    bw.setPropertyValues(<span class="keyword">new</span> MutablePropertyValues(deepCopy));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">&quot;Error setting property values&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>doCreateBean()</code> ç¬¬äºŒä¸ªè¿‡ç¨‹ï¼šå±æ€§å¡«å…… å·²ç»åˆ†æå®Œæˆäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ„é€ å‡½æ•°å®ä¾‹åŒ–bean</title>
      <link href="/blog/2020/01/20/cdc6fa32.html"/>
      <url>/blog/2020/01/20/cdc6fa32.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2850">http://cmsblogs.com/?p=2850</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><code>createBeanInstance()</code> ç”¨äºå®ä¾‹åŒ– beanï¼Œå®ƒä¼šæ ¹æ®ä¸åŒæƒ…å†µé€‰æ‹©ä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥æ¥å®Œæˆ bean çš„åˆå§‹åŒ–ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>Supplier å›è°ƒï¼š<code>obtainFromSupplier()</code></li><li>å·¥å‚æ–¹æ³•åˆå§‹åŒ–ï¼š<code>instantiateUsingFactoryMethod()</code></li><li>æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ï¼š<code>autowireConstructor()</code></li><li>é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ï¼š<code>instantiateBean()</code></li></ul><p>åœ¨(<a href="/2020/01/19/6271d9d2.html"> IOC ä¹‹ Factory å®ä¾‹åŒ– bean</a>) ä¸­åˆ†æäº† Supplier å›è°ƒå’Œå·¥å‚æ–¹æ³•åˆå§‹åŒ–ï¼Œè¿™ç¯‡åˆ†æä¸¤ä¸ªæ„é€ å‡½æ•°æ³¨å…¥ã€‚</p><h2 id="autowireConstructor"><a href="#autowireConstructor" class="headerlink" title="autowireConstructor()"></a>autowireConstructor()</h2><p>è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•æˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸ºæ˜¯å¸¦æœ‰å‚æ•°çš„åˆå§‹åŒ– bean ã€‚ä»£ç æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanWrapper <span class="title">autowireConstructor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> String beanName, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> RootBeanDefinition mbd,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> Constructor&lt;?&gt;[] chosenCtors, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] explicitArgs)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å°è£… BeanWrapperImpl  å¹¶å®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">  BeanWrapperImpl bw = <span class="keyword">new</span> BeanWrapperImpl();</span><br><span class="line">  <span class="keyword">this</span>.beanFactory.initBeanWrapper(bw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">  Constructor&lt;?&gt; constructorToUse = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// æ„é€ å‚æ•°</span></span><br><span class="line">  ArgumentsHolder argsHolderToUse = <span class="keyword">null</span>;</span><br><span class="line">  Object[] argsToUse = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç¡®å®šæ„é€ å‚æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="comment">// å¦‚æœ getBean() å·²ç»ä¼ é€’ï¼Œåˆ™ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">  <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    argsToUse = explicitArgs;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  å°è¯•ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    Object[] argsToResolve = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">      <span class="comment">// ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•</span></span><br><span class="line">      constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">      <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­çš„æ„é€ å‚æ•°</span></span><br><span class="line">        argsToUse = mbd.resolvedConstructorArguments;</span><br><span class="line">        <span class="keyword">if</span> (argsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">          argsToResolve = mbd.preparedConstructorArguments;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­å­˜åœ¨,åˆ™è§£æå­˜å‚¨åœ¨ BeanDefinition ä¸­çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// å¦‚ç»™å®šæ–¹æ³•çš„æ„é€ å‡½æ•° A(int ,int )ï¼Œåˆ™é€šè¿‡æ­¤æ–¹æ³•åå°±ä¼šæŠŠé…ç½®æ–‡ä»¶ä¸­çš„(&quot;1&quot;,&quot;1&quot;)è½¬æ¢ä¸º (1,1)</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­çš„å€¼å¯èƒ½æ˜¯åŸå§‹å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (argsToResolve != <span class="keyword">null</span>) &#123;</span><br><span class="line">      argsToUse = </span><br><span class="line">        resolvePreparedArguments(beanName, mbd, bw, </span><br><span class="line">                                 constructorToUse, argsToResolve);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™å°è¯•ä»é…ç½®æ–‡ä»¶ä¸­è·å–</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦éœ€è¦è§£ææ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">boolean</span> autowiring = (</span><br><span class="line">      chosenCtors != <span class="keyword">null</span> ||</span><br><span class="line">      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºæ‰¿è½½è§£æåçš„æ„é€ å‡½æ•°å‚æ•°çš„å€¼</span></span><br><span class="line">    ConstructorArgumentValues resolvedValues = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> minNrOfArgs;</span><br><span class="line">    <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">      minNrOfArgs = explicitArgs.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä» BeanDefinition ä¸­è·å–æ„é€ å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä»é…ç½®æ–‡ä»¶ä¸­æå–æ„é€ å‚æ•°</span></span><br><span class="line">      ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();</span><br><span class="line"></span><br><span class="line">      resolvedValues = <span class="keyword">new</span> ConstructorArgumentValues();</span><br><span class="line">      <span class="comment">// è§£ææ„é€ å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">      <span class="comment">// å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean</span></span><br><span class="line">      minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * è·å–æŒ‡å®šçš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="comment">// æ ¹æ®å‰é¢çš„åˆ¤æ–­ï¼ŒchosenCtors åº”è¯¥ä¸º null</span></span><br><span class="line">    Constructor&lt;?&gt;[] candidates = chosenCtors;</span><br><span class="line">    <span class="keyword">if</span> (candidates == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// è·å– bean çš„ class</span></span><br><span class="line">      Class&lt;?&gt; beanClass = mbd.getBeanClass();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® class è·å–æ‰€æœ‰çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        candidates = (mbd.isNonPublicAccessAllowed() ?</span><br><span class="line">                      beanClass.getDeclaredConstructors() </span><br><span class="line">                      : beanClass.getConstructors());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          mbd.getResourceDescription(), beanName,</span><br><span class="line">          <span class="string">&quot;Resolution of declared constructors on bean Class [&quot;</span> </span><br><span class="line">          + beanClass.getName() +</span><br><span class="line">          <span class="string">&quot;] from ClassLoader [&quot;</span> + beanClass.getClassLoader() + <span class="string">&quot;] failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹æ„é€ å‡½æ•°è¿›è¡Œæ’åºå¤„ç†</span></span><br><span class="line">    <span class="comment">// public æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºï¼Œépublic æ„é€ å‡½æ•°å‚æ•°æ•°é‡é™åº</span></span><br><span class="line">    AutowireUtils.sortConstructors(candidates);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å°å‚æ•°ç±»å‹æƒé‡</span></span><br><span class="line">    <span class="keyword">int</span> minTypeDiffWeight = Integer.MAX_VALUE;</span><br><span class="line">    Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = <span class="keyword">null</span>;</span><br><span class="line">    LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿­ä»£æ‰€æœ‰æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; candidate : candidates) &#123;</span><br><span class="line">      <span class="comment">// è·å–è¯¥æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹</span></span><br><span class="line">      Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœå·²ç»æ‰¾åˆ°é€‰ç”¨çš„æ„é€ å‡½æ•°æˆ–è€…éœ€è¦çš„å‚æ•°ä¸ªæ•°å°äºå½“å‰çš„æ„é€ å‡½æ•°å‚æ•°ä¸ªæ•°ï¼Œåˆ™ç»ˆæ­¢</span></span><br><span class="line">      <span class="comment">// å› ä¸ºå·²ç»æŒ‰ç…§å‚æ•°ä¸ªæ•°é™åºæ’åˆ—äº†</span></span><br><span class="line">      <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; argsToUse.length &gt; paramTypes.length) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å‚æ•°ä¸ªæ•°ä¸ç­‰ï¼Œç»§ç»­</span></span><br><span class="line">      <span class="keyword">if</span> (paramTypes.length &lt; minNrOfArgs) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å‚æ•°æŒæœ‰è€…</span></span><br><span class="line">      ArgumentsHolder argsHolder;</span><br><span class="line">      <span class="comment">// æœ‰å‚æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (resolvedValues != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// æ³¨é‡Šä¸Šè·å–å‚æ•°åç§°</span></span><br><span class="line">          String[] paramNames = </span><br><span class="line">            ConstructorPropertiesChecker.evaluate(candidate, paramTypes.length);</span><br><span class="line">          <span class="keyword">if</span> (paramNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–æ„é€ å‡½æ•°ã€æ–¹æ³•å‚æ•°çš„æ¢æµ‹å™¨</span></span><br><span class="line">            ParameterNameDiscoverer pnd = <span class="keyword">this</span>.beanFactory.getParameterNameDiscoverer();</span><br><span class="line">            <span class="keyword">if</span> (pnd != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// é€šè¿‡æ¢æµ‹å™¨è·å–æ„é€ å‡½æ•°çš„å‚æ•°åç§°</span></span><br><span class="line">              paramNames = pnd.getParameterNames(candidate);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ ¹æ®æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°åˆ›å»ºå‚æ•°æŒæœ‰è€…</span></span><br><span class="line">          argsHolder = createArgumentArray(</span><br><span class="line">            beanName, mbd, resolvedValues, bw, paramTypes, paramNames,</span><br><span class="line">            getUserDeclaredConstructor(candidate), autowiring);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.beanFactory.logger.trace(</span><br><span class="line">              <span class="string">&quot;Ignoring constructor [&quot;</span> + candidate + <span class="string">&quot;] of bean &#x27;&quot;</span> </span><br><span class="line">              + beanName + <span class="string">&quot;&#x27;: &quot;</span> + ex);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Swallow and try next constructor.</span></span><br><span class="line">          <span class="keyword">if</span> (causes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            causes = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">          &#125;</span><br><span class="line">          causes.add(ex);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°æ²¡æœ‰å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        argsHolder = <span class="keyword">new</span> ArgumentsHolder(explicitArgs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// isLenientConstructorResolution åˆ¤æ–­è§£ææ„é€ å‡½æ•°çš„æ—¶å€™æ˜¯å¦ä»¥å®½æ¾æ¨¡å¼è¿˜æ˜¯ä¸¥æ ¼æ¨¡å¼</span></span><br><span class="line">      <span class="comment">// ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰çš„éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="comment">// å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰&quot;æœ€æ¥è¿‘çš„æ¨¡å¼&quot;è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">      <span class="comment">// typeDiffWeightï¼šç±»å‹å·®å¼‚æƒé‡</span></span><br><span class="line">      <span class="keyword">int</span> typeDiffWeight = (mbd.isLenientConstructorResolution() ?</span><br><span class="line">           argsHolder.getTypeDifferenceWeight(paramTypes) :</span><br><span class="line">                            argsHolder.getAssignabilityWeight(paramTypes));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœå®ƒä»£è¡¨ç€å½“å‰æœ€æ¥è¿‘çš„åŒ¹é…åˆ™é€‰æ‹©å…¶ä½œä¸ºæ„é€ å‡½æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;</span><br><span class="line">        constructorToUse = candidate;</span><br><span class="line">        argsHolderToUse = argsHolder;</span><br><span class="line">        argsToUse = argsHolder.arguments;</span><br><span class="line">        minTypeDiffWeight = typeDiffWeight;</span><br><span class="line">        ambiguousConstructors = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ambiguousConstructors == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ambiguousConstructors = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">          ambiguousConstructors.add(constructorToUse);</span><br><span class="line">        &#125;</span><br><span class="line">        ambiguousConstructors.add(candidate);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (causes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        UnsatisfiedDependencyException ex = causes.removeLast();</span><br><span class="line">        <span class="keyword">for</span> (Exception cause : causes) &#123;</span><br><span class="line">          <span class="keyword">this</span>.beanFactory.onSuppressedException(cause);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line">        <span class="string">&quot;Could not resolve matching constructor &quot;</span> +</span><br><span class="line">        <span class="string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ambiguousConstructors != <span class="keyword">null</span> &amp;&amp; !mbd.isLenientConstructorResolution()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line">        <span class="string">&quot;Ambiguous constructor matches found in bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; &quot;</span> +</span><br><span class="line">        <span class="string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot;</span> +</span><br><span class="line">        ambiguousConstructors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ä¿å­˜åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (explicitArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">      argsHolderToUse.storeCache(mbd, constructorToUse);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–åˆ›å»º bean çš„ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">final</span> InstantiationStrategy strategy = beanFactory.getInstantiationStrategy();</span><br><span class="line">    Object beanInstance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Constructor&lt;?&gt; ctorToUse = constructorToUse;</span><br><span class="line">      <span class="keyword">final</span> Object[] argumentsToUse = argsToUse;</span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ– bean</span></span><br><span class="line">      beanInstance = </span><br><span class="line">        AccessController.doPrivileged(</span><br><span class="line">        (PrivilegedAction&lt;Object&gt;) () -&gt;</span><br><span class="line">        strategy.instantiate(mbd, beanName, beanFactory, ctorToUse, argumentsToUse),</span><br><span class="line">        beanFactory.getAccessControlContext());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ–bean</span></span><br><span class="line">      beanInstance = strategy.instantiate(</span><br><span class="line">        mbd, beanName, <span class="keyword">this</span>.beanFactory, constructorToUse, argsToUse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ„é€ çš„ bean åŠ å…¥åˆ° BeanWrapper å®ä¾‹ä¸­</span></span><br><span class="line">    bw.setBeanInstance(beanInstance);</span><br><span class="line">    <span class="keyword">return</span> bw;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName,</span><br><span class="line">      <span class="string">&quot;Bean instantiation via constructor failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸ <code>instantiateUsingFactoryMethod()</code> ä¸€æ ·ï¼Œåˆé•¿åˆéš¾æ‡‚ï¼Œä½†æ˜¯å¦‚æœç†è§£äº† <code>instantiateUsingFactoryMethod()</code> åˆå§‹åŒ– bean çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆ <code>autowireConstructor()</code> ä¹Ÿä¸å­˜åœ¨ä»€ä¹ˆéš¾çš„åœ°æ–¹äº†ï¼Œä¸€å¥è¯æ¦‚æ‹¬ï¼šé¦–å…ˆç¡®å®šæ„é€ å‡½æ•°å‚æ•°ã€æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„åˆå§‹åŒ–ç­–ç•¥è¿›è¡Œ bean çš„åˆå§‹åŒ–ã€‚å…³äºå¦‚ä½•ç¡®å®šæ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ï¼Œè¯¥éƒ¨åˆ†é€»è¾‘å’Œ <code>instantiateUsingFactoryMethod()</code> åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†é‡å¤é˜è¿°äº†ï¼Œå…·ä½“è¿‡ç¨‹è¯·ç§»æ­¥<a href="/2020/01/19/6271d9d2.html">IOC ä¹‹ Factory å®ä¾‹åŒ– bean</a>ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹åˆ†æåˆå§‹åŒ–ç­–ç•¥ã€‚ å¯¹äºåˆå§‹åŒ–ç­–ç•¥ï¼Œé¦–å…ˆæ˜¯è·å–å®ä¾‹åŒ– bean çš„ç­–ç•¥ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> InstantiationStrategy strategy = beanFactory.getInstantiationStrategy();</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯è°ƒç”¨å…¶ <code>instantiate()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ SimpleInstantiationStrategy ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰è¦†ç›–</span></span><br><span class="line">  <span class="comment">// ç›´æ¥ä½¿ç”¨åå°„å®ä¾‹åŒ–å³å¯</span></span><br><span class="line">  <span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°æ£€æµ‹è·å–ä¸‹æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="comment">// è¯¥æ„é€ å‡½æ•°æ˜¯ç»è¿‡å‰é¢ N å¤šå¤æ‚è¿‡ç¨‹ç¡®è®¤çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">    <span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</span><br><span class="line">      <span class="comment">// è·å–å·²ç»è§£æçš„æ„é€ å‡½æ•°</span></span><br><span class="line">      constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸º nullï¼Œä» class ä¸­è§£æè·å–ï¼Œå¹¶è®¾ç½®</span></span><br><span class="line">      <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">        <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;Specified class is an interface&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            constructorToUse = AccessController.doPrivileged(</span><br><span class="line">              (PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            constructorToUse =  clazz.getDeclaredConstructor();</span><br><span class="line">          &#125;</span><br><span class="line">          bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;No default constructor found&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡BeanUtilsç›´æ¥ä½¿ç”¨æ„é€ å™¨å¯¹è±¡å®ä¾‹åŒ–bean</span></span><br><span class="line">    <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç”ŸæˆCGLIBåˆ›å»ºçš„å­ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¯¥ bean æ²¡æœ‰é…ç½® lookup-methodã€replaced-method æ ‡ç­¾æˆ–è€… @Lookup æ³¨è§£ï¼Œåˆ™ç›´æ¥é€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ– bean å³å¯ï¼Œæ–¹ä¾¿å¿«æ·ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨éœ€è¦è¦†ç›–çš„æ–¹æ³•æˆ–è€…åŠ¨æ€æ›¿æ¢çš„æ–¹æ³•åˆ™éœ€è¦ä½¿ç”¨ CGLIB è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå› ä¸ºå¯ä»¥åœ¨åˆ›å»ºä»£ç†çš„åŒæ—¶å°†åŠ¨æ€æ–¹æ³•ç»‡å…¥ç±»ä¸­ã€‚ <strong>åå°„</strong> è°ƒç”¨å·¥å…·ç±» BeanUtils çš„ <code>instantiateClass()</code> æ–¹æ³•å®Œæˆåå°„å·¥ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">instantiateClass</span><span class="params">(Constructor&lt;T&gt; ctor, Object... args)</span> <span class="keyword">throws</span> BeanInstantiationException </span>&#123;</span><br><span class="line">  Assert.notNull(ctor, <span class="string">&quot;Constructor must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ReflectionUtils.makeAccessible(ctor);</span><br><span class="line">    <span class="keyword">return</span> (KotlinDetector.isKotlinType(ctor.getDeclaringClass()) ?</span><br><span class="line">            KotlinDelegate.instantiateClass(ctor, args) : ctor.newInstance(args));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœç•¥ä¸€äº› catch </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CGLIB</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">    <span class="string">&quot;Method Injection not supported in SimpleInstantiationStrategy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•é»˜è®¤æ˜¯æ²¡æœ‰å®ç°çš„ï¼Œå…·ä½“è¿‡ç¨‹ç”±å…¶å­ç±» CglibSubclassingInstantiationStrategy å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object instantiateWithMethodInjection</span><br><span class="line">  (RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span><br><span class="line">   <span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šè¿‡CGLIBç”Ÿæˆä¸€ä¸ªå­ç±»å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CglibSubclassCreator(bd, owner).instantiate(ctor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª CglibSubclassCreator å¯¹è±¡ï¼Œè°ƒç”¨å…¶ <code>instantiate()</code> æ–¹æ³•ç”Ÿæˆå…¶å­ç±»å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(<span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡ Cglib åˆ›å»ºä¸€ä¸ªä»£ç†ç±»</span></span><br><span class="line">  Class&lt;?&gt; subclass = createEnhancedSubclass(<span class="keyword">this</span>.beanDefinition);</span><br><span class="line">  Object instance;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰æ„é€ å™¨ï¼Œé€šè¿‡ BeanUtils ä½¿ç”¨é»˜è®¤æ„é€ å™¨åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹</span></span><br><span class="line">  <span class="keyword">if</span> (ctor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instance = BeanUtils.instantiateClass(subclass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è·å–ä»£ç†ç±»å¯¹åº”çš„æ„é€ å™¨å¯¹è±¡ï¼Œå¹¶å®ä¾‹åŒ– bean</span></span><br><span class="line">      Constructor&lt;?&gt; enhancedSubclassConstructor = </span><br><span class="line">        subclass.getConstructor(ctor.getParameterTypes());</span><br><span class="line">      instance = enhancedSubclassConstructor.newInstance(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(</span><br><span class="line">        <span class="keyword">this</span>.beanDefinition.getBeanClass(),</span><br><span class="line">        <span class="string">&quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot;</span> </span><br><span class="line">        + subclass.getName() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸ºäº†é¿å…memory leakså¼‚å¸¸ï¼Œç›´æ¥åœ¨beanå®ä¾‹ä¸Šè®¾ç½®å›è°ƒå¯¹è±¡</span></span><br><span class="line">  Factory factory = (Factory) instance;</span><br><span class="line">  factory.setCallbacks(<span class="keyword">new</span> Callback[] &#123;</span><br><span class="line">    NoOp.INSTANCE,</span><br><span class="line">    <span class="keyword">new</span> CglibSubclassingInstantiationStrategy</span><br><span class="line">      .LookupOverrideMethodInterceptor(</span><br><span class="line">      <span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner),</span><br><span class="line">    <span class="keyword">new</span> CglibSubclassingInstantiationStrategy</span><br><span class="line">      .ReplaceOverrideMethodInterceptor(<span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner)&#125;);</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™ç±» CGLIB çš„æ–¹å¼åˆ†æå®Œæ¯•äº†ï¼Œå½“ç„¶è¿™é‡Œè¿˜æ²¡æœ‰å…·ä½“åˆ†æ CGLIB ç”Ÿæˆå­ç±»çš„è¯¦ç»†è¿‡ç¨‹ï¼Œå…·ä½“çš„è¿‡ç¨‹ç­‰åç»­åˆ†æ AOP çš„æ—¶å€™å†è¯¦ç»†åœ°ä»‹ç»ã€‚</p><h2 id="instantiateBean"><a href="#instantiateBean" class="headerlink" title="instantiateBean()"></a>instantiateBean()</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">instantiateBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Object beanInstance;</span><br><span class="line">    <span class="keyword">final</span> BeanFactory parent = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      beanInstance = AccessController</span><br><span class="line">        .doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt;</span><br><span class="line">                      getInstantiationStrategy()</span><br><span class="line">                      .instantiate(mbd, beanName, parent),</span><br><span class="line">                      getAccessControlContext());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">    &#125;</span><br><span class="line">    BeanWrapper bw = <span class="keyword">new</span> BeanWrapperImpl(beanInstance);</span><br><span class="line">    initBeanWrapper(bw);</span><br><span class="line">    <span class="keyword">return</span> bw;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">&quot;Instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ç›¸æ¯”äº <code>instantiateUsingFactoryMethod()</code> ã€ <code>autowireConstructor()</code> æ–¹æ³•å®åœ¨æ˜¯å¤ªç®€å•äº†ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥ä¸éœ€è¦ç¡®è®¤ç»è¿‡å¤æ‚çš„è¿‡æ¥æ¥ç¡®å®šæ„é€ å™¨ã€æ„é€ å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ã€‚ </p><p>å¯¹äº <code>createBeanInstance()</code> è€Œè¨€ï¼Œä»–å°±æ˜¯é€‰æ‹©åˆé€‚å®ä¾‹åŒ–ç­–ç•¥æ¥ä¸º bean åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œå…·ä½“çš„ç­–ç•¥æœ‰ï¼š<strong>Supplier å›è°ƒæ–¹å¼</strong>ã€<strong>å·¥å‚æ–¹æ³•åˆå§‹åŒ–</strong>ã€<strong>æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–</strong>ã€<strong>é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥</strong>ã€‚</p><p>å…¶ä¸­<u><em>å·¥å‚æ–¹æ³•åˆå§‹åŒ–</em></u>å’Œ<u><em>æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–</em></u>ä¸¤ç§æ–¹å¼æœ€ä¸ºå¤æ‚ï¼Œä¸»è¦æ˜¯å› ä¸ºæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°çš„ä¸ç¡®å®šæ€§ï¼Œ<strong>Spring éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›æ¥ç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°</strong>ï¼Œå¦‚æœç¡®å®šäº†åˆ™å¥½åŠï¼Œç›´æ¥é€‰æ‹©å®ä¾‹åŒ–ç­–ç•¥å³å¯ã€‚å½“ç„¶åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ ¹æ®æ˜¯å¦æœ‰éœ€è¦è¦†ç›–æˆ–è€…åŠ¨æ€æ›¿æ¢æ‰çš„æ–¹æ³•ï¼Œå› ä¸ºå­˜åœ¨è¦†ç›–æˆ–è€…ç»‡å…¥çš„è¯éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å°†æ–¹æ³•ç»‡å…¥ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½é€‰æ‹© CGLIB çš„æ–¹å¼æ¥å®ä¾‹åŒ–ï¼Œå¦åˆ™ç›´æ¥åˆ©ç”¨åå°„çš„æ–¹å¼å³å¯ï¼Œæ–¹ä¾¿å¿«æ·ã€‚ åˆ°è¿™é‡Œ <code>createBeanInstance()</code> çš„è¿‡ç¨‹å°±å·²ç»åˆ†æå®Œæ¯•äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹Factoryå®ä¾‹åŒ–bean</title>
      <link href="/blog/2020/01/19/6271d9d2.html"/>
      <url>/blog/2020/01/19/6271d9d2.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2848">http://cmsblogs.com/?p=2848</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>è¿™ç¯‡æˆ‘ä»¬å…³æ³¨åˆ›å»º bean è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼šå®ä¾‹åŒ– beanï¼Œå¯¹åº”çš„æ–¹æ³•ä¸ºï¼š<code>createBeanInstance()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">createBeanInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æ beanï¼Œå°† bean ç±»åè§£æä¸º class å¼•ç”¨</span></span><br><span class="line">  Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beanClass != <span class="keyword">null</span> &amp;&amp; </span><br><span class="line">      !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; </span><br><span class="line">      !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName,</span><br><span class="line">      <span class="string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> </span><br><span class="line">      + beanClass.getName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„å›è°ƒæ–¹æ³•åˆå§‹åŒ–ç­–ç•¥</span></span><br><span class="line">  Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line">  <span class="keyword">if</span> (instanceSupplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•åˆå§‹åŒ–ç­–ç•¥</span></span><br><span class="line">  <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="keyword">null</span>)  &#123;</span><br><span class="line">    <span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// constructorArgumentLock æ„é€ å‡½æ•°çš„å¸¸ç”¨é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå·²ç¼“å­˜çš„è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ„é€ å‡½æ•°è§£æ</span></span><br><span class="line">      <span class="comment">// å› ä¸ºéœ€è¦æ ¹æ®å‚æ•°ç¡®è®¤åˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥è¿‡ç¨‹æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€æœ‰é‡‡ç”¨ç¼“å­˜æœºåˆ¶</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">        resolved = <span class="keyword">true</span>;</span><br><span class="line">        autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å·²ç»è§£æå¥½äº†ï¼Œç›´æ¥æ³¨å…¥å³å¯</span></span><br><span class="line">  <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">    <span class="comment">// è‡ªåŠ¨æ³¨å…¥ï¼Œè°ƒç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">      <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€ </span></span><br><span class="line">      <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¡®å®šè§£æçš„æ„é€ å‡½æ•°</span></span><br><span class="line">  <span class="comment">// ä¸»è¦æ˜¯æ£€æŸ¥å·²ç»æ³¨å†Œçš„ SmartInstantiationAwareBeanPostProcessor</span></span><br><span class="line">  Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">  <span class="keyword">if</span> (ctors != <span class="keyword">null</span> ||</span><br><span class="line">      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">      mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥</span></span><br><span class="line">  <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ– bean æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå…¶ä¸»è¦çš„é€»è¾‘ä¸ºï¼š</p><ul><li>å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> è¿›è¡Œåˆå§‹åŒ–</li><li>å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</li><li>é¦–å…ˆåˆ¤æ–­ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œå³å·²ç»è§£æè¿‡äº†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å·²ç»è§£æäº†çš„ï¼Œæ ¹æ® constructorArgumentsResolved å‚æ•°æ¥åˆ¤æ–­æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥è¿˜æ˜¯é»˜è®¤æ„é€ å‡½æ•°</li><li>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆç¡®å®šåˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°æ¥å®Œæˆè§£æå·¥ä½œï¼Œå› ä¸ºä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°éƒ½æœ‰ä¸åŒçš„æ„é€ å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®å‚æ•°æ¥é”å®šæ„é€ å‡½æ•°å¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¦‚æœå­˜åœ¨å‚æ•°åˆ™ä½¿ç”¨ç›¸åº”çš„å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚</li></ul><p>ä¸‹é¢å°±ä¸Šé¢å››ç§æƒ…å†µåšåˆ†åˆ«è¯´æ˜ã€‚</p><h2 id="obtainFromSupplier"><a href="#obtainFromSupplier" class="headerlink" title="obtainFromSupplier()"></a>obtainFromSupplier()</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line"><span class="keyword">if</span> (instanceSupplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä» BeanDefinition ä¸­è·å– Supplierï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> ã€‚é‚£ä¹ˆ Supplier æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™ä¹‹å‰ä¹Ÿæ²¡æœ‰æåˆ°è¿‡è¿™ä¸ªå­—æ®µã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Supplier</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Supplier æ¥å£ä»…æœ‰ä¸€ä¸ªåŠŸèƒ½æ€§çš„ <code>get()</code>ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª T ç±»å‹çš„å¯¹è±¡ï¼Œæœ‰ç‚¹å„¿ç±»ä¼¼å·¥å‚æ–¹æ³•ã€‚è¿™ä¸ªæ¥å£æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿç”¨äºæŒ‡å®šåˆ›å»º bean çš„å›è°ƒï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†è¿™æ ·çš„å›è°ƒï¼Œé‚£ä¹ˆå…¶ä»–çš„æ„é€ å™¨æˆ–è€…å·¥å‚æ–¹æ³•éƒ½ä¼šæ²¡æœ‰ç”¨ã€‚åœ¨ä»€ä¹ˆè®¾ç½®è¯¥å‚æ•°å‘¢ï¼ŸSpring æä¾›äº†ç›¸åº”çš„ <code>setter</code> æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInstanceSupplier</span><span class="params">(<span class="meta">@Nullable</span> Supplier&lt;?&gt; instanceSupplier)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.instanceSupplier = instanceSupplier;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€  BeanDefinition çš„æ—¶å€™è®¾ç½®äº†è¯¥å€¼ï¼Œå¦‚ä¸‹ï¼ˆä»¥ RootBeanDefinition ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; RootBeanDefinition(<span class="meta">@Nullable</span> Class&lt;T&gt; beanClass, String scope, <span class="meta">@Nullable</span> Supplier&lt;T&gt; instanceSupplier) &#123;</span><br><span class="line">  <span class="keyword">super</span>();</span><br><span class="line">  setBeanClass(beanClass);</span><br><span class="line">  setScope(scope);</span><br><span class="line">  setInstanceSupplier(instanceSupplier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè®¾ç½®äº† instanceSupplier åˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> å®Œæˆ bean çš„åˆå§‹åŒ–ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">obtainFromSupplier</span><span class="params">(Supplier&lt;?&gt; instanceSupplier, String beanName)</span> </span>&#123;</span><br><span class="line">  String outerBean = <span class="keyword">this</span>.currentlyCreatedBean.get();</span><br><span class="line">  <span class="keyword">this</span>.currentlyCreatedBean.set(beanName);</span><br><span class="line">  Object instance;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ Supplier çš„ get()ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">    instance = instanceSupplier.get();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (outerBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyCreatedBean.set(outerBean);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyCreatedBean.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®å¯¹è±¡æ„é€  BeanWrapper å¯¹è±¡</span></span><br><span class="line">  BeanWrapper bw = <span class="keyword">new</span> BeanWrapperImpl(instance);</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– BeanWrapper</span></span><br><span class="line">  initBeanWrapper(bw);</span><br><span class="line">  <span class="keyword">return</span> bw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å¾ˆç®€å•ï¼Œè°ƒç”¨ è°ƒç”¨ Supplier çš„ <code>get()</code> æ–¹æ³•ï¼Œè·å¾—ä¸€ä¸ª bean å®ä¾‹å¯¹è±¡ï¼Œç„¶åæ ¹æ®è¯¥å®ä¾‹å¯¹è±¡æ„é€ ä¸€ä¸ª BeanWrapper å¯¹è±¡ bwï¼Œæœ€ååˆå§‹åŒ–è¯¥å¯¹è±¡ã€‚æœ‰å…³äº BeanWrapper åé¢ä¸“é—¨å‡ºæ–‡è®²è§£ã€‚</p><h2 id="instantiateUsingFactoryMethod"><a href="#instantiateUsingFactoryMethod" class="headerlink" title="instantiateUsingFactoryMethod()"></a>instantiateUsingFactoryMethod()</h2><p>å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ <code>instantiateUsingFactoryMethod()</code> å®Œæˆ bean çš„åˆå§‹åŒ–å·¥ä½œï¼ˆæ–¹æ³•å®ç°æ¯”è¾ƒé•¿ï¼Œç»†èŠ‚æ¯”è¾ƒå¤æ‚ï¼Œå„ä½å°±ç¡¬ç€å¤´çš®çœ‹å§ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">instantiateUsingFactoryMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] explicitArgs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ConstructorResolver(<span class="keyword">this</span>)</span><br><span class="line">    .instantiateUsingFactoryMethod(beanName, mbd, explicitArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ª ConstructorResolver å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ <code>instantiateUsingFactoryMethod()</code> æ–¹æ³•ã€‚ConstructorResolver æ˜¯æ„é€ æ–¹æ³•æˆ–è€…å·¥å‚ç±»åˆå§‹åŒ– bean çš„å§”æ‰˜ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanWrapper <span class="title">instantiateUsingFactoryMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] explicitArgs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€  BeanWrapperImpl å¯¹è±¡</span></span><br><span class="line">  BeanWrapperImpl bw = <span class="keyword">new</span> BeanWrapperImpl();</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– BeanWrapperImpl</span></span><br><span class="line">  <span class="comment">// å‘BeanWrapperå¯¹è±¡ä¸­æ·»åŠ  ConversionService å¯¹è±¡å’Œå±æ€§ç¼–è¾‘å™¨ PropertyEditor å¯¹è±¡</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">this</span>.beanFactory.initBeanWrapper(bw);</span><br><span class="line"></span><br><span class="line">  Object factoryBean;</span><br><span class="line">  Class&lt;?&gt; factoryClass;</span><br><span class="line">  <span class="keyword">boolean</span> isStatic;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å·¥å‚åä¸ä¸ºç©º</span></span><br><span class="line">  String factoryBeanName = mbd.getFactoryBeanName();</span><br><span class="line">  <span class="keyword">if</span> (factoryBeanName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (factoryBeanName.equals(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line"><span class="string">&quot;factory-bean reference points back to the same bean definition&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å·¥å‚å®ä¾‹</span></span><br><span class="line">    factoryBean = <span class="keyword">this</span>.beanFactory.getBean(factoryBeanName);</span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.beanFactory.containsSingleton(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ImplicitlyAppearedSingletonException();</span><br><span class="line">    &#125;</span><br><span class="line">    factoryClass = factoryBean.getClass();</span><br><span class="line">    isStatic = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å·¥å‚åä¸ºç©ºï¼Œåˆ™å…¶å¯èƒ½æ˜¯ä¸€ä¸ªé™æ€å·¥å‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€å·¥å‚åˆ›å»ºbeanï¼Œå¿…é¡»è¦æä¾›å·¥å‚çš„å…¨ç±»å</span></span><br><span class="line">    <span class="keyword">if</span> (!mbd.hasBeanClass()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line"><span class="string">&quot;bean definition declares neither a bean class nor a factory-bean reference&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    factoryBean = <span class="keyword">null</span>;</span><br><span class="line">    factoryClass = mbd.getBeanClass();</span><br><span class="line">    isStatic = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å·¥å‚æ–¹æ³•</span></span><br><span class="line">  Method factoryMethodToUse = <span class="keyword">null</span>;</span><br><span class="line">  ConstructorResolver.ArgumentsHolder argsHolderToUse = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å‚æ•°</span></span><br><span class="line">  Object[] argsToUse = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å·¥å‚æ–¹æ³•çš„å‚æ•°</span></span><br><span class="line">  <span class="comment">// å¦‚æœæŒ‡å®šäº†æ„é€ å‚æ•°åˆ™ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">  <span class="comment">// åœ¨è°ƒç”¨ getBean æ–¹æ³•çš„æ—¶å€™æŒ‡å®šäº†æ–¹æ³•å‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    argsToUse = explicitArgs;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æŒ‡å®šï¼Œåˆ™å°è¯•ä»é…ç½®æ–‡ä»¶ä¸­è§£æ</span></span><br><span class="line">    Object[] argsToResolve = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é¦–å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">      <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•</span></span><br><span class="line">      factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">      <span class="keyword">if</span> (factoryMethodToUse != <span class="keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;</span><br><span class="line">        <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‚æ•°</span></span><br><span class="line">        argsToUse = mbd.resolvedConstructorArguments;</span><br><span class="line">        <span class="keyword">if</span> (argsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°å‚æ•°çš„åŒ…å¯è§å­—æ®µ</span></span><br><span class="line">          argsToResolve = mbd.preparedConstructorArguments;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­å­˜åœ¨,åˆ™è§£æå­˜å‚¨åœ¨ BeanDefinition ä¸­çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// å¦‚ç»™å®šæ–¹æ³•çš„æ„é€ å‡½æ•° A(int ,int )ï¼Œåˆ™é€šè¿‡æ­¤æ–¹æ³•åå°±ä¼šæŠŠé…ç½®æ–‡ä»¶ä¸­çš„(&quot;1&quot;,&quot;1&quot;)è½¬æ¢ä¸º (1,1)</span></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­çš„å€¼å¯èƒ½æ˜¯åŸå§‹å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (argsToResolve != <span class="keyword">null</span>) &#123;</span><br><span class="line">      argsToUse = </span><br><span class="line">        resolvePreparedArguments(</span><br><span class="line">        beanName, mbd, bw, factoryMethodToUse, argsToResolve);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (factoryMethodToUse == <span class="keyword">null</span> || argsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–å·¥å‚æ–¹æ³•çš„ç±»å…¨åç§°</span></span><br><span class="line">    factoryClass = ClassUtils.getUserClass(factoryClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ‰€æœ‰å¾…å®šæ–¹æ³•</span></span><br><span class="line">    Method[] rawCandidates = getCandidateMethods(factoryClass, mbd);</span><br><span class="line">    <span class="comment">// æ£€ç´¢æ‰€æœ‰æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯å¯¹æ–¹æ³•è¿›è¡Œè¿‡æ»¤</span></span><br><span class="line">    List&lt;Method&gt; candidateSet = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Method candidate : rawCandidates) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæœ‰static ä¸”ä¸ºå·¥å‚æ–¹æ³•ï¼Œåˆ™æ·»åŠ åˆ° candidateSet ä¸­</span></span><br><span class="line">      <span class="keyword">if</span> (Modifier.isStatic(candidate.getModifiers()) == isStatic &amp;&amp; </span><br><span class="line">          mbd.isFactoryMethod(candidate)) &#123;</span><br><span class="line">        candidateSet.add(candidate);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method[] candidates = candidateSet.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// æ’åºæ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="comment">// public æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºï¼Œépublic æ„é€ å‡½æ•°å‚æ•°æ•°é‡é™åº</span></span><br><span class="line">    AutowireUtils.sortFactoryMethods(candidates);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºæ‰¿è½½è§£æåçš„æ„é€ å‡½æ•°å‚æ•°çš„å€¼</span></span><br><span class="line">    ConstructorArgumentValues resolvedValues = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> autowiring = (mbd.getResolvedAutowireMode() == </span><br><span class="line">                          RootBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">    <span class="keyword">int</span> minTypeDiffWeight = Integer.MAX_VALUE;</span><br><span class="line">    Set&lt;Method&gt; ambiguousFactoryMethods = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> minNrOfArgs;</span><br><span class="line">    <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">      minNrOfArgs = explicitArgs.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// getBean() æ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œåˆ™éœ€è¦è§£æä¿å­˜åœ¨ BeanDefinition æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„å‚æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.hasConstructorArgumentValues()) &#123;</span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();</span><br><span class="line">        resolvedValues = <span class="keyword">new</span> ConstructorArgumentValues();</span><br><span class="line">        <span class="comment">// è§£ææ„é€ å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        <span class="comment">// å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean</span></span><br><span class="line">        minNrOfArgs = </span><br><span class="line">          resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        minNrOfArgs = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Method candidate : candidates) &#123;</span><br><span class="line">      <span class="comment">// æ–¹æ³•ä½“çš„å‚æ•°</span></span><br><span class="line">      Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (paramTypes.length &gt;= minNrOfArgs) &#123;</span><br><span class="line">        <span class="comment">// ä¿å­˜å‚æ•°çš„å¯¹è±¡</span></span><br><span class="line">        ArgumentsHolder argsHolder;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getBean()ä¼ é€’äº†å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>)&#123;</span><br><span class="line">          <span class="comment">// æ˜¾ç¤ºç»™å®šå‚æ•°ï¼Œå‚æ•°é•¿åº¦å¿…é¡»å®Œå…¨åŒ¹é…</span></span><br><span class="line">          <span class="keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// æ ¹æ®å‚æ•°åˆ›å»ºå‚æ•°æŒæœ‰è€…</span></span><br><span class="line">          argsHolder = <span class="keyword">new</span> ArgumentsHolder(explicitArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// ä¸ºæä¾›å‚æ•°ï¼Œè§£ææ„é€ å‚æ•°</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] paramNames = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// è·å– ParameterNameDiscoverer å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// ParameterNameDiscoverer æ˜¯ç”¨äºè§£ææ–¹æ³•å’Œæ„é€ å‡½æ•°çš„å‚æ•°åç§°çš„æ¥å£ï¼Œä¸ºå‚æ•°åç§°æ¢æµ‹å™¨</span></span><br><span class="line">            ParameterNameDiscoverer pnd = <span class="keyword">this</span>.beanFactory.getParameterNameDiscoverer();</span><br><span class="line">            <span class="keyword">if</span> (pnd != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// è·å–æŒ‡å®šæ„é€ å‡½æ•°çš„å‚æ•°åç§°</span></span><br><span class="line">              paramNames = pnd.getParameterNames(candidate);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// åœ¨å·²ç»è§£æçš„æ„é€ å‡½æ•°å‚æ•°å€¼çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªå‚æ•°æŒæœ‰è€…å¯¹è±¡</span></span><br><span class="line">            argsHolder = createArgumentArray(</span><br><span class="line">              beanName, mbd, resolvedValues, bw, </span><br><span class="line">              paramTypes, paramNames, candidate, autowiring);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory.logger.isTraceEnabled()) &#123;</span><br><span class="line">              <span class="keyword">this</span>.beanFactory.logger.trace(</span><br><span class="line">                <span class="string">&quot;Ignoring factory method [&quot;</span> + candidate +</span><br><span class="line"><span class="string">&quot;] of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (causes == <span class="keyword">null</span>) &#123;</span><br><span class="line">              causes = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            causes.add(ex);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// isLenientConstructorResolution åˆ¤æ–­è§£ææ„é€ å‡½æ•°çš„æ—¶å€™æ˜¯å¦ä»¥å®½æ¾æ¨¡å¼è¿˜æ˜¯ä¸¥æ ¼æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰çš„éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰&quot;æœ€æ¥è¿‘çš„æ¨¡å¼&quot;è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">        <span class="comment">// typeDiffWeightï¼šç±»å‹å·®å¼‚æƒé‡</span></span><br><span class="line">        <span class="keyword">int</span> typeDiffWeight = </span><br><span class="line">          (mbd.isLenientConstructorResolution() ?                   </span><br><span class="line">           argsHolder.getTypeDifferenceWeight(paramTypes) </span><br><span class="line">           :argsHolder.getAssignabilityWeight(paramTypes));</span><br><span class="line">        <span class="comment">// ä»£è¡¨æœ€æ¥è¿‘çš„ç±»å‹åŒ¹é…ï¼Œåˆ™é€‰æ‹©ä½œä¸ºæ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;</span><br><span class="line">          factoryMethodToUse = candidate;</span><br><span class="line">          argsHolderToUse = argsHolder;</span><br><span class="line">          argsToUse = argsHolder.arguments;</span><br><span class="line">          minTypeDiffWeight = typeDiffWeight;</span><br><span class="line">          ambiguousFactoryMethods = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå…·æœ‰ç›¸åŒå‚æ•°æ•°é‡çš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„ç±»å‹å·®å¼‚æƒé‡ï¼Œåˆ™æ”¶é›†æ­¤ç±»å‹é€‰é¡¹</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯ï¼Œä»…åœ¨éå®½æ¾æ„é€ å‡½æ•°è§£ææ¨¡å¼ä¸‹æ‰§è¡Œè¯¥æ£€æŸ¥ï¼Œå¹¶æ˜¾å¼å¿½ç•¥é‡å†™æ–¹æ³•ï¼ˆå…·æœ‰ç›¸åŒçš„å‚æ•°ç­¾åï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (factoryMethodToUse != <span class="keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight &amp;&amp;</span><br><span class="line">                 !mbd.isLenientConstructorResolution() &amp;&amp;</span><br><span class="line">                 paramTypes.length == factoryMethodToUse.getParameterCount() &amp;&amp;</span><br><span class="line">                 !Arrays.equals(paramTypes, factoryMethodToUse.getParameterTypes())) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æŸ¥æ‰¾åˆ°å¤šä¸ªå¯åŒ¹é…çš„æ–¹æ³•</span></span><br><span class="line">          <span class="keyword">if</span> (ambiguousFactoryMethods == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ambiguousFactoryMethods = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">            ambiguousFactoryMethods.add(factoryMethodToUse);</span><br><span class="line">          &#125;</span><br><span class="line">          ambiguousFactoryMethods.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æœ‰å¯æ‰§è¡Œçš„å·¥å‚æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (factoryMethodToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (causes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        UnsatisfiedDependencyException ex = causes.removeLast();</span><br><span class="line">        <span class="keyword">for</span> (Exception cause : causes) &#123;</span><br><span class="line">          <span class="keyword">this</span>.beanFactory.onSuppressedException(cause);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">      List&lt;String&gt; argTypes = <span class="keyword">new</span> ArrayList&lt;&gt;(minNrOfArgs);</span><br><span class="line">      <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object arg : explicitArgs) &#123;</span><br><span class="line">          argTypes.add(arg != <span class="keyword">null</span> ? arg.getClass().getSimpleName() : <span class="string">&quot;null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (resolvedValues != <span class="keyword">null</span>)&#123;</span><br><span class="line">        Set&lt;ConstructorArgumentValues.ValueHolder&gt; valueHolders = </span><br><span class="line">          <span class="keyword">new</span> LinkedHashSet&lt;&gt;(resolvedValues.getArgumentCount());</span><br><span class="line">        valueHolders.addAll(resolvedValues.getIndexedArgumentValues().values());</span><br><span class="line">        valueHolders.addAll(resolvedValues.getGenericArgumentValues());</span><br><span class="line">        <span class="keyword">for</span> (ConstructorArgumentValues.ValueHolder value : valueHolders) &#123;</span><br><span class="line">          String argType = (value.getType() != <span class="keyword">null</span> ? </span><br><span class="line">                            ClassUtils.getShortName(value.getType()) :</span><br><span class="line">                            (value.getValue() != <span class="keyword">null</span> ? </span><br><span class="line">                             value.getValue().getClass().getSimpleName() : <span class="string">&quot;null&quot;</span>));</span><br><span class="line">          argTypes.add(argType);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      String argDesc = StringUtils.collectionToCommaDelimitedString(argTypes);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line"><span class="string">&quot;No matching factory method found: &quot;</span> +                              </span><br><span class="line">        (mbd.getFactoryBeanName() != <span class="keyword">null</span> ?</span><br><span class="line">         <span class="string">&quot;factory bean &#x27;&quot;</span> + mbd.getFactoryBeanName() + <span class="string">&quot;&#x27;; &quot;</span> : <span class="string">&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;factory method &#x27;&quot;</span> + mbd.getFactoryMethodName() + </span><br><span class="line">        <span class="string">&quot;(&quot;</span> + argDesc + <span class="string">&quot;)&#x27;. &quot;</span> +</span><br><span class="line">        <span class="string">&quot;Check that a method with the specified name &quot;</span> +</span><br><span class="line">(minNrOfArgs &gt; <span class="number">0</span> ? <span class="string">&quot;and arguments &quot;</span> : <span class="string">&quot;&quot;</span>) +                              </span><br><span class="line">        <span class="string">&quot;exists and that it is &quot;</span> +</span><br><span class="line">        (isStatic ? <span class="string">&quot;static&quot;</span> : <span class="string">&quot;non-static&quot;</span>) + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">void</span>.class == factoryMethodToUse.getReturnType()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line">        <span class="string">&quot;Invalid factory method &#x27;&quot;</span> + mbd.getFactoryMethodName() +</span><br><span class="line">        <span class="string">&quot;&#x27;: needs to have a non-void return type!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ambiguousFactoryMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName,</span><br><span class="line">        <span class="string">&quot;Ambiguous factory method matches found in bean &#x27;&quot;</span> </span><br><span class="line">        + beanName + <span class="string">&quot;&#x27; &quot;</span> +</span><br><span class="line">        <span class="string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot;</span> +</span><br><span class="line">        ambiguousFactoryMethods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (explicitArgs == <span class="keyword">null</span> &amp;&amp; argsHolderToUse != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å°†è§£æçš„æ„é€ å‡½æ•°åŠ å…¥ç¼“å­˜</span></span><br><span class="line">      argsHolderToUse.storeCache(mbd, factoryMethodToUse);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– bean</span></span><br><span class="line">    Object beanInstance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Object fb = factoryBean;</span><br><span class="line">      <span class="keyword">final</span> Method factoryMethod = factoryMethodToUse;</span><br><span class="line">      <span class="keyword">final</span> Object[] args = argsToUse;</span><br><span class="line">      <span class="comment">// é€šè¿‡æ‰§è¡Œå·¥å‚æ–¹æ³•æ¥åˆ›å»ºbeanç¤ºä¾‹</span></span><br><span class="line">      beanInstance = AccessController.doPrivileged(</span><br><span class="line">        (PrivilegedAction&lt;Object&gt;) () -&gt;      </span><br><span class="line">        beanFactory.getInstantiationStrategy()</span><br><span class="line">        .instantiate(</span><br><span class="line">          mbd, beanName, beanFactory, fb, factoryMethod, args),</span><br><span class="line">        beanFactory.getAccessControlContext());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// é€šè¿‡æ‰§è¡Œå·¥å‚æ–¹æ³•æ¥åˆ›å»ºbeanç¤ºä¾‹</span></span><br><span class="line">      beanInstance = <span class="keyword">this</span>.beanFactory.getInstantiationStrategy().instantiate(</span><br><span class="line">        mbd, beanName, <span class="keyword">this</span>.beanFactory, factoryBean, factoryMethodToUse, argsToUse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…è£…ä¸º BeanWraper å¯¹è±¡</span></span><br><span class="line">    bw.setBeanInstance(beanInstance);</span><br><span class="line">    <span class="keyword">return</span> bw;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName,</span><br><span class="line"><span class="string">&quot;Bean instantiation via factory method failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>instantiateUsingFactoryMethod()</code> æ–¹æ³•ä½“å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå¤„ç†ç»†èŠ‚æ„Ÿè§‰å¾ˆå¤æ‚ï¼Œä¸­é—´æ–­æ–­ç»­ç»­çš„ã€‚åæ§½è¿™é‡Œçš„ä»£ç é£æ ¼ï¼Œå®Œå…¨ä¸ç¬¦åˆæˆ‘ä»¬å‰é¢çœ‹çš„ Spring ä»£ç é£æ ¼ã€‚Spring çš„ä¸€è´¯åšæ³•æ˜¯å°†ä¸€ä¸ªå¤æ‚é€»è¾‘è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†ä¸ºå¤šä¸ªç»†å°çš„æ¨¡å—è¿›è¡ŒåµŒå¥—ï¼Œæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œæ¨¡å—ä¸æ¨¡å—ä¹‹é—´å±‚å±‚åµŒå¥—ï¼Œä¸Šä¸€å±‚ä¸€èˆ¬éƒ½æ˜¯å¯¹ä¸‹ä¸€å±‚çš„æ€»ç»“å’Œæ¦‚æ‹¬ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—æ¯ä¸€å±‚çš„é€»è¾‘å˜å¾—æ¸…æ™°æ˜“æ‡‚ã€‚ å›å½’åˆ°ä¸Šé¢çš„æ–¹æ³•ä½“ï¼Œè™½ç„¶ä»£ç ä½“é‡å¤§ï¼Œä½†æ˜¯æ€»ä½“æˆ‘ä»¬è¿˜æ˜¯å¯çœ‹æ¸…æ¥šè¿™ä¸ªæ–¹æ³•è¦åšçš„äº‹æƒ…ã€‚</p><blockquote><p>ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼šç¡®å®šå·¥å‚å¯¹è±¡ï¼Œç„¶åè·å–æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°ï¼Œæœ€åè°ƒç”¨ InstantiationStrategy å¯¹è±¡çš„ <code>instantiate()</code> æ¥åˆ›å»º bean å®ä¾‹ã€‚</p></blockquote><p>ä¸‹é¢æˆ‘ä»¬å°±è¿™ä¸ªå¥æ¦‚æ‹¬çš„è¯è¿›è¡Œæ‹†åˆ†å¹¶è¯¦ç»†è¯´æ˜ã€‚ </p><ul><li><p><strong>ç¡®å®šå·¥å‚å¯¹è±¡</strong>é¦–å…ˆè·å–å·¥å‚æ–¹æ³•åï¼Œè‹¥å·¥å‚æ–¹æ³•åä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>beanFactory.getBean()</code> è·å–å·¥å‚å¯¹è±¡ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™å¯èƒ½ä¸ºä¸€ä¸ªé™æ€å·¥å‚ï¼Œå¯¹äºé™æ€å·¥å‚åˆ™å¿…é¡»æä¾›å·¥å‚ç±»çš„å…¨ç±»åï¼ŒåŒæ—¶è®¾ç½® <code>factoryBean = null</code> </p></li><li><p><strong>æ„é€ å‚æ•°ç¡®è®¤</strong> å·¥å‚å¯¹è±¡ç¡®å®šåï¼Œåˆ™æ˜¯ç¡®è®¤æ„é€ å‚æ•°ã€‚æ„é€ å‚æ•°çš„ç¡®è®¤ä¸»è¦åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šexplicitArgs å‚æ•°ã€ç¼“å­˜ä¸­è·å–ã€é…ç½®æ–‡ä»¶ä¸­è§£æã€‚ </p><ul><li><p><strong>explicitArgs å‚æ•°</strong> explicitArgs å‚æ•°æ˜¯æˆ‘ä»¬è°ƒç”¨ <code>getBean()</code> æ—¶ä¼ é€’æ™¯æ¥ï¼Œä¸€èˆ¬è¯¥å‚æ•°ï¼Œè¯¥å‚æ•°å°±æ˜¯ç”¨äºåˆå§‹åŒ– bean æ—¶æ‰€ä¼ é€’çš„å‚æ•°ï¼Œå¦‚æœè¯¥å‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥ç¡®å®šæ„é€ å‡½æ•°çš„å‚æ•°å°±æ˜¯å®ƒäº†ã€‚</p></li><li><p> <strong>ç¼“å­˜ä¸­è·å–</strong> åœ¨è¯¥æ–¹æ³•çš„æœ€åï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™æ ·ä¸€æ®µä»£ç ï¼š<code>argsHolderToUse.storeCache(mbd, factoryMethodToUse)</code> ï¼Œè¿™æ®µä»£ç ä¸»è¦æ˜¯å°†æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚ä¸‹ï¼š</p></li></ul>  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">storeCache</span><span class="params">(RootBeanDefinition mbd, Executable constructorOrFactoryMethod)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">    mbd.resolvedConstructorOrFactoryMethod = constructorOrFactoryMethod;</span><br><span class="line">    mbd.constructorArgumentsResolved = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.resolveNecessary) &#123;</span><br><span class="line">      mbd.preparedConstructorArguments = <span class="keyword">this</span>.preparedArguments;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      mbd.resolvedConstructorArguments = <span class="keyword">this</span>.arguments;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  å…¶ä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªå‚æ•° constructorArgumentLockã€resolvedConstructorOrFactoryMethodã€constructorArgumentsResolvedã€resolvedConstructorArgumentsã€‚è¿™äº›å‚æ•°éƒ½æ˜¯è·Ÿæ„é€ å‡½æ•°ã€æ„é€ å‡½æ•°ç¼“å­˜æœ‰å…³çš„ã€‚</p><ul><li><p>constructorArgumentLockï¼šæ„é€ å‡½æ•°çš„ç¼“å­˜é”</p></li><li><p>resolvedConstructorOrFactoryMethodï¼šç¼“å­˜å·²ç»è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•</p></li><li><p>constructorArgumentsResolvedï¼šæ ‡è®°å­—æ®µï¼Œæ ‡è®°æ„é€ å‡½æ•°ã€å‚æ•°å·²ç»è§£æäº†ã€‚é»˜è®¤ä¸ºfalse</p></li><li><p>resolvedConstructorArgumentsï¼šç¼“å­˜å·²ç»è§£æçš„æ„é€ å‡½æ•°å‚æ•°ï¼ŒåŒ…å¯è§å­—æ®µ</p></li></ul><p>æ‰€ä»¥ä»ç¼“å­˜ä¸­è·å–å°±æ˜¯æå–è¿™å‡ ä¸ªå‚æ•°çš„å€¼ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">    <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•</span></span><br><span class="line">    factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">    <span class="keyword">if</span> (factoryMethodToUse != <span class="keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;</span><br><span class="line">      <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‚æ•°</span></span><br><span class="line">      argsToUse = mbd.resolvedConstructorArguments;</span><br><span class="line">      <span class="keyword">if</span> (argsToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°å‚æ•°çš„åŒ…å¯è§å­—æ®µ</span></span><br><span class="line">        argsToResolve = mbd.preparedConstructorArguments;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å¦‚æœç¼“å­˜ä¸­å­˜åœ¨æ„é€ å‚æ•°ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>resolvePreparedArguments()</code> æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œå› ä¸ºç¼“å­˜ä¸­çš„å€¼æœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯æœ€ç»ˆå€¼ï¼Œæ¯”å¦‚æˆ‘ä»¬æ„é€ å‡½æ•°ä¸­çš„ç±»å‹ä¸º Integer ç±»å‹çš„ 1 ï¼Œä½†æ˜¯åŸå§‹çš„å‚æ•°ç±»å‹æœ‰å¯èƒ½æ˜¯ String ç±»å‹çš„ 1 ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ä»ç¼“å­˜ä¸­å¾—åˆ°äº†æ„é€ å‚æ•°ä¹Ÿéœ€è¦ç»è¿‡ä¸€ç•ªçš„ç±»å‹è½¬æ¢ç¡®ä¿å‚æ•°ç±»å‹å®Œå…¨å¯¹åº”ã€‚ <strong>é…ç½®æ–‡ä»¶ä¸­è§£æ</strong> å³æ²¡æœ‰é€šè¿‡ä¼ é€’å‚æ•°çš„æ–¹å¼ä¼ é€’æ„é€ å‚æ•°ï¼Œç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ï¼Œé‚£å°±åªèƒ½é€šè¿‡è§£æé…ç½®æ–‡ä»¶è·å–æ„é€ å‚æ•°äº†ã€‚ åœ¨ bean è§£æç±»çš„åšæ–‡ä¸­æˆ‘ä»¬äº†è§£äº†ï¼Œé…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯éƒ½ä¼šè½¬æ¢åˆ° BeanDefinition å®ä¾‹å¯¹è±¡ä¸­ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°å¯ä»¥ç›´æ¥é€šè¿‡ BeanDefinition å¯¹è±¡è·å–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (mbd.hasConstructorArgumentValues()) &#123;</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">    ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();</span><br><span class="line">    resolvedValues = <span class="keyword">new</span> ConstructorArgumentValues();</span><br><span class="line">    <span class="comment">// è§£ææ„é€ å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean</span></span><br><span class="line">    minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ BeanDefinition çš„ <code>getConstructorArgumentValues()</code> å°±å¯ä»¥è·å–æ„é€ ä¿¡æ¯äº†ï¼Œæœ‰äº†æ„é€ ä¿¡æ¯å°±å¯ä»¥è·å–ç›¸å…³çš„å‚æ•°å€¼ä¿¡æ¯äº†ï¼Œè·å–çš„å‚æ•°ä¿¡æ¯åŒ…æ‹¬ç›´æ¥å€¼å’Œå¼•ç”¨ï¼Œè¿™ä¸€æ­¥éª¤çš„å¤„ç†äº¤ç”± <code>resolveConstructorArguments()</code> å®Œæˆï¼Œè¯¥æ–¹æ³•ä¼šå°†æ„é€ å‚æ•°ä¿¡æ¯è§£æä¸º resolvedValues å¯¹è±¡ å¹¶è¿”å›è§£æåˆ°çš„å‚æ•°ä¸ªæ•°ã€‚ </p><ul><li><p><strong>æ„é€ å‡½æ•°</strong> ç¡®å®šæ„é€ å‚æ•°åï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯ç¡®å®šæ„é€ å‡½æ•°ã€‚ç¬¬ä¸€æ­¥åˆ™æ˜¯é€šè¿‡ <code>getCandidateMethods()</code> è·å–æ‰€æœ‰çš„æ„é€ æ–¹æ³•ï¼ŒåŒæ—¶å¯¹æ„é€ æ–¹æ³•è¿›è¡Œåˆ·é€‰ï¼Œç„¶ååœ¨å¯¹å…¶è¿›è¡Œæ’åºå¤„ç†ï¼ˆ<code>AutowireUtils.sortFactoryMethods(candidates)</code>ï¼‰ï¼Œæ’åºçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿çš„æ‰¾åˆ°åŒ¹é…çš„æ„é€ å‡½æ•°ï¼Œå› ä¸ºæ„é€ å‡½æ•°çš„ç¡®è®¤æ˜¯æ ¹æ®å‚æ•°ä¸ªæ•°ç¡®è®¤çš„ã€‚</p><p>æ’åºçš„è§„åˆ™æ˜¯ï¼špublic æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºã€é public æ„é€ å‚æ•°æ•°é‡é™åºã€‚ é€šè¿‡è¿­ä»£ candidatesï¼ˆåŒ…å«äº†æ‰€æœ‰è¦åŒ¹é…çš„æ„é€ å‡½æ•°ï¼‰çš„æ–¹å¼ï¼Œä¸€æ¬¡æ¯”è¾ƒå…¶å‚æ•°ï¼Œå¦‚æœæ˜¾ç¤ºæä¾›äº†å‚æ•°ï¼ˆexplicitArgs != nullï¼‰ï¼Œåˆ™ç›´æ¥æ¯”è¾ƒä¸¤è€…æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™è¡¨ç¤ºæ‰¾åˆ°äº†ï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒã€‚</p><p>å¦‚æœæ²¡æœ‰æ˜¾ç¤ºæä¾›å‚æ•°ï¼Œåˆ™éœ€è¦è·å– ParameterNameDiscoverer å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸ºå‚æ•°åç§°æ¢æµ‹å™¨ï¼Œä¸»è¦ç”¨äºå‘ç°æ–¹æ³•å’Œæ„é€ å‡½æ•°çš„å‚æ•°åç§°ã€‚ å°†å‚æ•°åŒ…è£…æˆ ArgumentsHolder å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºä¿å­˜å‚æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‚æ•°æŒæœ‰è€…ã€‚å½“å°†å¯¹è±¡åŒ…è£…æˆ ArgumentsHolder å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œæ„é€ å‡½æ•°åŒ¹é…ï¼ŒåŒ¹é…åˆ†ä¸ºä¸¥æ ¼æ¨¡å¼å’Œå®½æ¾æ¨¡å¼ã€‚</p><ul><li>ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰å‚æ•°éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</li><li>å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰â€æœ€æ¥è¿‘çš„æ¨¡å¼â€è¿›è¡ŒåŒ¹é…</li></ul></li></ul><p>åˆ¤æ–­çš„ä¾æ®æ˜¯æ ¹æ® BeanDefinition çš„ isLenientConstructorResolution å±æ€§ï¼ˆè¯¥å‚æ•°æ˜¯æˆ‘ä»¬åœ¨æ„é€  AbstractBeanDefinition å¯¹è±¡æ˜¯ä¼ é€’çš„ï¼‰æ¥è·å–ç±»å‹å·®å¼‚æƒé‡ï¼ˆtypeDiffWeightï¼‰ çš„ã€‚å¦‚æœ <code>typeDiffWeight &lt; minTypeDiffWeight</code> ï¼Œåˆ™ä»£è¡¨â€œæœ€æ¥è¿‘çš„æ¨¡å¼â€ï¼Œé€‰æ‹©å…¶ä½œä¸ºæ„é€ å‡½æ•°ï¼Œå¦åˆ™åªæœ‰ä¸¤è€…å…·æœ‰ç›¸åŒçš„å‚æ•°æ•°é‡ä¸”ç±»å‹å·®å¼‚æƒé‡ç›¸ç­‰æ‰ä¼šçº³å…¥è€ƒè™‘èŒƒå›´ã€‚ è‡³æ­¤ï¼Œæ„é€ å‡½æ•°å·²ç»ç¡®è®¤äº†ã€‚ </p><ul><li><strong>åˆ›å»º bean å®ä¾‹</strong> å·¥å‚å¯¹è±¡ã€æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°éƒ½å·²ç»ç¡®è®¤äº†ï¼Œåˆ™æœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨ InstantiationStrategy å¯¹è±¡çš„ <code>instantiate()</code> æ¥åˆ›å»º bean å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> Object factoryBean, <span class="keyword">final</span> Method factoryMethod, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      currentlyInvokedFactoryMethod.set(factoryMethod);</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå·¥å‚æ–¹æ³•ï¼Œå¹¶è¿”å›å®ä¾‹</span></span><br><span class="line">      Object result = factoryMethod.invoke(factoryBean, args);</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> NullBean();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (priorInvokedFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.remove();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœç•¥ä¸€æ³¢ catch</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>instantiate()</code> æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯åˆ©ç”¨ Java åå°„æ‰§è¡Œå·¥å‚æ–¹æ³•å¹¶è¿”å›åˆ›å»ºå¥½çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¿™æ®µä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Object result &#x3D; factoryMethod.invoke(factoryBean, args);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ <code>instantiateUsingFactoryMethod()</code> å·²ç»åˆ†æå®Œæ¯•äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹å¼€å¯Beançš„å®ä¾‹åŒ–è¿›ç¨‹</title>
      <link href="/blog/2020/01/19/1ad7c22b.html"/>
      <url>/blog/2020/01/19/1ad7c22b.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2846">http://cmsblogs.com/?p=2846</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>åœ¨ä¸Šç¯‡åšå®¢<a href="/2020/01/18/13d2205c.html">IOC ä¹‹ åˆ†æå„ scope çš„ bean åˆ›å»º</a>ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•æ²¡æœ‰è®²åˆ° <code>createBean()</code> ï¼Œè¯¥æ–¹æ³•çš„å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException</span>;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å®šä¹‰åœ¨ AbstractBeanFactory ä¸­ã€‚å…¶å«ä¹‰æ˜¯æ ¹æ®ç»™å®šçš„ BeanDefinition å’Œ argså®ä¾‹åŒ–ä¸€ä¸ª bean å¯¹è±¡ï¼Œå¦‚æœè¯¥ BeanDefinition å­˜åœ¨çˆ¶ç±»ï¼Œåˆ™è¯¥ BeanDefinition å·²ç»åˆå¹¶äº†çˆ¶ç±»çš„å±æ€§ã€‚æ‰€æœ‰ Bean å®ä¾‹çš„åˆ›å»ºéƒ½ä¼šå§”æ‰˜ç»™è¯¥æ–¹æ³•å®ç°ã€‚ æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>beanNameï¼šbean çš„åå­—</li><li>mbdï¼šå·²ç»åˆå¹¶äº†çˆ¶ç±»å±æ€§çš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰BeanDefinition</li><li>argsï¼šç”¨äºæ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•åˆ›å»º bean å®ä¾‹å¯¹è±¡çš„å‚æ•°</li></ul><p>è¯¥æŠ½è±¡æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯åœ¨ç±» AbstractAutowireCapableBeanFactory ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String beanName, </span></span></span><br><span class="line"><span class="function"><span class="params">  RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¡®ä¿æ­¤æ—¶çš„ bean å·²ç»è¢«è§£æäº†</span></span><br><span class="line">  <span class="comment">// å¦‚æœè·å–çš„class å±æ€§ä¸ä¸ºnullï¼Œåˆ™å…‹éš†è¯¥ BeanDefinition</span></span><br><span class="line">  <span class="comment">// ä¸»è¦æ˜¯å› ä¸ºè¯¥åŠ¨æ€è§£æçš„ class æ— æ³•ä¿å­˜åˆ°åˆ°å…±äº«çš„ BeanDefinition</span></span><br><span class="line">  Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">  <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() </span><br><span class="line">      &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</span><br><span class="line">    mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// éªŒè¯å’Œå‡†å¤‡è¦†ç›–æ–¹æ³•</span></span><br><span class="line">    mbdToUse.prepareMethodOverrides();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">                                           beanName, <span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ç»™ BeanPostProcessors ä¸€ä¸ªæœºä¼šç”¨æ¥è¿”å›ä¸€ä¸ªä»£ç†ç±»è€Œä¸æ˜¯çœŸæ­£çš„ç±»å®ä¾‹</span></span><br><span class="line">    <span class="comment">// AOP çš„åŠŸèƒ½å°±æ˜¯åŸºäºè¿™ä¸ªåœ°æ–¹</span></span><br><span class="line">    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">                                    <span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡ŒçœŸæ­£åˆ›å»º bean çš„è¿‡ç¨‹</span></span><br><span class="line">    Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> beanInstance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbdToUse.getResourceDescription(), </span><br><span class="line">      beanName, <span class="string">&quot;Unexpected exception during bean creation&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è§£ææŒ‡å®š BeanDefinition çš„ class</li><li>å¤„ç† override å±æ€§</li><li>å®ä¾‹åŒ–çš„å‰ç½®å¤„ç†</li><li>åˆ›å»º bean</li></ul><p><strong>è§£ææŒ‡å®š BeanDefinition çš„ class</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è§£æ bean definition çš„ class ç±»ï¼Œå¹¶å°†å·²ç»è§£æçš„ Class å­˜å‚¨åœ¨ bean definition ä¸­ä»¥ä¾›åé¢ä½¿ç”¨ã€‚å¦‚æœè§£æçš„ class ä¸ä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯¥ BeanDefinition è¿›è¡Œå…‹éš†è‡³ mbdToUseï¼Œè¿™æ ·åšçš„ä¸»è¦ç›®çš„æ˜¯ä»¥ä¸ºåŠ¨æ€è§£æçš„ class æ˜¯æ— æ³•ä¿å­˜åˆ°å…±äº«çš„ BeanDefinition ä¸­ã€‚ <strong>å¤„ç† override å±æ€§</strong>å¤§å®¶è¿˜è®°å¾— lookup-method å’Œ replace-method è¿™ä¸¤ä¸ªé…ç½®åŠŸèƒ½ï¼Ÿåœ¨åšå®¢ <a href="http://cmsblogs.com/?p=2846">ã€æ­»ç£• Springã€‘â€”â€“ IOC ä¹‹è§£æBeanï¼šè§£æ bean æ ‡ç­¾ï¼ˆä¸‰ï¼‰</a> ä¸­å·²ç»è¯¦ç»†åˆ†æäº†è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç”¨æ³•å’Œè§£æè¿‡ç¨‹ï¼ŒçŸ¥é“è§£æè¿‡ç¨‹å…¶å®å°±æ˜¯è®²è¿™ä¸¤ä¸ªé…ç½®å­˜æ”¾åœ¨ BeanDefinition ä¸­çš„ methodOverrides å±æ€§ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ bean å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å¦‚æœæ£€æµ‹åˆ°å­˜åœ¨ methodOverridesï¼Œåˆ™ä¼šåŠ¨æ€åœ°ä½ä¸ºå½“å‰ bean ç”Ÿæˆä»£ç†å¹¶ä½¿ç”¨å¯¹åº”çš„æ‹¦æˆªå™¨ä¸º bean åšå¢å¼ºå¤„ç†ã€‚å…·ä½“çš„å®ç°æˆ‘ä»¬åç»­åˆ†æï¼Œç°åœ¨å…ˆçœ‹ <code>mbdToUse.prepareMethodOverrides()</code> éƒ½å¹²äº†äº›ä»€ä¹ˆäº‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareMethodOverrides</span><span class="params">()</span> <span class="keyword">throws</span> BeanDefinitionValidationException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hasMethodOverrides()) &#123;</span><br><span class="line">    Set&lt;MethodOverride&gt; overrides = getMethodOverrides().getOverrides();</span><br><span class="line">    <span class="keyword">synchronized</span> (overrides) &#123;</span><br><span class="line">      <span class="keyword">for</span> (MethodOverride mo : overrides) &#123;</span><br><span class="line">        prepareMethodOverride(mo);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨ methodOverrides åˆ™è·å–æ‰€æœ‰çš„ override method ï¼Œç„¶åé€šè¿‡è¿­ä»£çš„æ–¹æ³•ä¸€æ¬¡è°ƒç”¨ <code>prepareMethodOverride()</code> ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareMethodOverride</span><span class="params">(MethodOverride mo)</span> <span class="keyword">throws</span> BeanDefinitionValidationException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> count = ClassUtils.getMethodCountForName(getBeanClass(), mo.getMethodName());</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionValidationException(</span><br><span class="line">      <span class="string">&quot;Invalid method override: no method with name &#x27;&quot;</span> + mo.getMethodName() +</span><br><span class="line">      <span class="string">&quot;&#x27; on class [&quot;</span> + getBeanClassName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</span><br><span class="line">    mo.setOverloaded(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ–¹æ³•åç§°ä» class ä¸­è·å–è¯¥æ–¹æ³•åçš„ä¸ªæ•°ï¼Œå¦‚æœä¸º 0 åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœ ä¸º 1 åˆ™è®¾ç½®è¯¥é‡è½½æ–¹æ³•æ²¡æœ‰è¢«é‡è½½ã€‚è‹¥ä¸€ä¸ªç±»ä¸­å­˜åœ¨å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œåˆ™åœ¨æ–¹æ³•è°ƒç”¨çš„æ—¶å€™è¿˜éœ€è¦æ ¹æ®å‚æ•°ç±»å‹æ¥åˆ¤æ–­åˆ°åº•é‡è½½çš„æ˜¯å“ªä¸ªæ–¹æ³•ã€‚åœ¨è®¾ç½®é‡è½½çš„æ—¶å€™å…¶å®è¿™é‡Œåšäº†ä¸€ä¸ªå°å°ä¼˜åŒ–ï¼Œé‚£å°±æ˜¯å½“ <code>count == 1</code> æ—¶ï¼Œè®¾ç½® <code>overloaded = false</code>ï¼Œè¿™æ ·è¡¨ç¤ºè¯¥æ–¹æ³•æ²¡æœ‰é‡è½½ï¼Œè¿™æ ·åœ¨åç»­è°ƒç”¨çš„æ—¶å€™ä¾¿å¯ä»¥ç›´æ¥æ‰¾åˆ°æ–¹æ³•è€Œä¸éœ€è¦è¿›è¡Œæ–¹æ³•å‚æ•°çš„æ ¡éªŒã€‚ è¯šç„¶ï¼Œå…¶å® <code>mbdToUse.prepareMethodOverrides()</code> å¹¶æ²¡æœ‰åšä»€ä¹ˆå®è´¨æ€§çš„å·¥ä½œï¼Œåªæ˜¯å¯¹ methodOverrides å±æ€§åšäº†ä¸€äº›ç®€å•çš„æ ¡éªŒè€Œå·²ã€‚ <strong>å®ä¾‹åŒ–çš„å‰ç½®å¤„ç†</strong> <code>resolveBeforeInstantiation()</code> çš„ä½œç”¨æ˜¯ç»™ BeanPostProcessors åç½®å¤„ç†å™¨è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡çš„æœºä¼šï¼Œå…¶å®åœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰ Spring ä¸€ç›´éƒ½æ²¡æœ‰åˆ›å»º bean ï¼Œé‚£ä¹ˆè¿™é‡Œè¿”å›ä¸€ä¸ª bean çš„ä»£ç†ç±»æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿä½œç”¨ä½“ç°åœ¨åé¢çš„ <code>if</code> åˆ¤æ–­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä»£ç†å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ä»£ç†å¯¹è±¡ï¼Œè¿™ä¸€æ­¥éª¤æœ‰éå¸¸é‡è¦çš„ä½œç”¨ï¼ŒSpring åç»­å®ç° AOP å°±æ˜¯åŸºäºè¿™ä¸ªåœ°æ–¹åˆ¤æ–­çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">resolveBeforeInstantiation</span><span class="params">(String beanName, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">  Object bean = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">      Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);</span><br><span class="line">      <span class="keyword">if</span> (targetType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">          bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mbd.beforeInstantiationResolved = (bean != <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ ¸å¿ƒå°±åœ¨äº <code>applyBeanPostProcessorsBeforeInstantiation()</code> å’Œ <code>applyBeanPostProcessorsAfterInitialization()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œbefore ä¸ºå®ä¾‹åŒ–å‰çš„åå¤„ç†å™¨åº”ç”¨ï¼Œafter ä¸ºå®ä¾‹åŒ–åçš„åå¤„ç†å™¨åº”ç”¨ï¼Œç”±äºæœ¬æ–‡çš„ä¸»é¢˜æ˜¯åˆ›å»º beanï¼Œå…³äº Bean çš„å¢å¼ºå¤„ç†åç»­ LZ ä¼šå•ç‹¬å‡ºåšæ–‡æ¥åšè¯¦ç»†è¯´æ˜ã€‚ <strong>åˆ›å»º bean</strong> å¦‚æœæ²¡æœ‰ä»£ç†å¯¹è±¡ï¼Œå°±åªèƒ½èµ°å¸¸è§„çš„è·¯çº¿è¿›è¡Œ bean çš„åˆ›å»ºäº†ï¼Œè¯¥è¿‡ç¨‹æœ‰ <code>doCreateBean()</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BeanWrapperæ˜¯å¯¹Beançš„åŒ…è£…ï¼Œå…¶æ¥å£ä¸­æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œ</span></span><br><span class="line">  <span class="comment">// è·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨</span></span><br><span class="line">  BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å•ä¾‹æ¨¡å‹ï¼Œåˆ™ä»æœªå®Œæˆçš„ FactoryBean ç¼“å­˜ä¸­åˆ é™¤</span></span><br><span class="line">  <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">    anceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);   </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨åˆé€‚çš„å®ä¾‹åŒ–ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ã€ç®€å•åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒ…è£…çš„å®ä¾‹å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">final</span> Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">  <span class="comment">// åŒ…è£…çš„å®ä¾‹å¯¹è±¡çš„ç±»å‹</span></span><br><span class="line">  Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">  <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">    mbd.resolvedTargetType = beanType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æµ‹æ˜¯å¦æœ‰åç½®å¤„ç†</span></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰åç½®å¤„ç†ï¼Œåˆ™å…è®¸åç½®å¤„ç†ä¿®æ”¹ BeanDefinition</span></span><br><span class="line">  <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// applyMergedBeanDefinitionPostProcessors</span></span><br><span class="line">        <span class="comment">// åç½®å¤„ç†ä¿®æ”¹ BeanDefinition</span></span><br><span class="line">        applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          mbd.getResourceDescription(), </span><br><span class="line">          beanName,</span><br><span class="line">          <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–</span></span><br><span class="line">  <span class="comment">// å•ä¾‹æ¨¡å¼ &amp; è¿è¡Œå¾ªç¯ä¾èµ–&amp;å½“å‰å•ä¾‹ bean æ˜¯å¦æ­£åœ¨è¢«åˆ›å»º</span></span><br><span class="line">  <span class="keyword">boolean</span> earlySingletonExposure = </span><br><span class="line">    (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                                    isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æå‰å°†åˆ›å»ºçš„ bean å®ä¾‹åŠ å…¥åˆ°ectFactory ä¸­</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸ºäº†åæœŸé¿å…å¾ªç¯ä¾èµ–</span></span><br><span class="line">    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å¼€å§‹åˆå§‹åŒ– bean å®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  Object exposedObject = bean;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹ bean è¿›è¡Œå¡«å……ï¼Œå°†å„ä¸ªå±æ€§å€¼æ³¨å…¥ï¼Œå…¶ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»– bean çš„å±æ€§</span></span><br><span class="line">    <span class="comment">// åˆ™ä¼šé€’å½’åˆå§‹ä¾èµ– bean</span></span><br><span class="line">    populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">    <span class="comment">// è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¾ªç¯ä¾èµ–å¤„ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="comment">// è·å– earlySingletonReference</span></span><br><span class="line">    Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// åªæœ‰åœ¨å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼ŒearlySingletonReference æ‰ä¸ä¼šä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ exposedObject æ²¡æœ‰åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¢«æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«å¢å¼º</span></span><br><span class="line">      <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">        exposedObject = earlySingletonReference;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¤„ç†ä¾èµ–</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">        String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">        Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">        <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">            actualDependentBeans.add(dependentBean);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(</span><br><span class="line">            beanName,</span><br><span class="line">            <span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + </span><br><span class="line">            <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">            StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +                                         </span><br><span class="line">            <span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">            <span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œ bean</span></span><br><span class="line">    registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“çš„æ€è·¯ï¼š</p><ol><li>å¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™æ¸…é™¤ factoryBeanInstanceCache ç¼“å­˜ï¼ŒåŒæ—¶è¿”å› BeanWrapper å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶å¦‚æœå­˜åœ¨ã€‚</li><li>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper æˆ–è€…ä¸æ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™è°ƒç”¨ <code>createBeanInstance()</code> å®ä¾‹åŒ– beanï¼Œä¸»è¦æ˜¯å°† BeanDefinition è½¬æ¢ä¸º BeanWrapper</li></ol><ul><li>MergedBeanDefinitionPostProcessor çš„åº”ç”¨ </li><li>å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç† </li><li>è°ƒç”¨ <code>populateBean()</code> è¿›è¡Œå±æ€§å¡«å……ã€‚å°†æ‰€æœ‰å±æ€§å¡«å……è‡³ bean çš„å®ä¾‹ä¸­ </li><li>è°ƒç”¨ <code>initializeBean()</code> åˆå§‹åŒ– bean </li><li>ä¾èµ–æ£€æŸ¥ </li><li>æ³¨å†Œ DisposableBean <code>doCreateBean()</code> å®Œæˆ bean çš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œï¼Œå†…å®¹å¤ªå¤šï¼Œè¿™é‡Œå°±åªåˆ—å‡ºæ•´ä½“æ€è·¯ï¼Œä¸‹æ–‡å¼€å§‹å°†è¯¥æ–¹æ³•è¿›è¡Œæ‹†åˆ†è¿›è¡Œè¯¦ç»†è®²è§£ï¼Œåˆ†å¸ƒä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œé˜è¿°ï¼š<ul><li><code>createBeanInstance()</code> å®ä¾‹åŒ– bean</li><li><code>populateBean()</code> å±æ€§å¡«å……</li><li>å¾ªç¯ä¾èµ–çš„å¤„ç†</li><li><code>initializeBean()</code> åˆå§‹åŒ– bean</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹åˆ†æå„scopeçš„beanåˆ›å»º</title>
      <link href="/blog/2020/01/18/13d2205c.html"/>
      <url>/blog/2020/01/18/13d2205c.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2839">http://cmsblogs.com/?p=2839</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><strong>singleton</strong> Spring çš„ scope é»˜è®¤ä¸º singletonï¼Œå…¶åˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">  sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      destroySingleton(beanName);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€éƒ¨åˆ†åˆ†æäº†ä»ç¼“å­˜ä¸­è·å–å•ä¾‹æ¨¡å¼çš„ beanï¼Œä½†æ˜¯å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨å‘¢ï¼Ÿ</p><p>åˆ™éœ€è¦ä»å¤´å¼€å§‹åŠ è½½ beanï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± <code>getSingleton()</code> å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(beanName, <span class="string">&quot;Bean name must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…¨å±€åŠ é”</span></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­æ£€æŸ¥ä¸€é</span></span><br><span class="line">    <span class="comment">// å› ä¸º singleton æ¨¡å¼å…¶å®å°±æ˜¯å¤ç”¨å·²ç»åˆ›å»ºçš„ bean æ‰€ä»¥è¿™æ­¥éª¤å¿…é¡»æ£€æŸ¥</span></span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="comment">//  ä¸ºç©ºï¼Œå¼€å§‹åŠ è½½è¿‡ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// çœç•¥ éƒ¨åˆ†ä»£ç </span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// åŠ è½½å‰ç½®å¤„ç†</span></span><br><span class="line">      beforeSingletonCreation(beanName);</span><br><span class="line">      <span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// çœç•¥ä»£ç </span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– bean</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯è°ƒç”¨ createBean() æ–¹æ³•</span></span><br><span class="line">        singletonObject = singletonFactory.getObject();</span><br><span class="line">        newSingleton = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// çœç•¥ catch éƒ¨åˆ†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// åç½®å¤„ç†</span></span><br><span class="line">      afterSingletonCreation(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ å…¥ç¼“å­˜ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">      addSingleton(beanName, singletonObject);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»º beanï¼Œä»…ä»…åªæ˜¯åšäº†ä¸€éƒ¨åˆ†å‡†å¤‡å’Œé¢„å¤„ç†æ­¥éª¤ï¼ŒçœŸæ­£è·å–å•ä¾‹ bean çš„æ–¹æ³•å…¶å®æ˜¯ç”± <code>singletonFactory.getObject()</code> è¿™éƒ¨åˆ†å®ç°ï¼Œè€Œ singletonFactory ç”±å›è°ƒæ–¹æ³•äº§ç”Ÿã€‚</p><p><em>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†å“ªäº›å‡†å¤‡å‘¢ï¼Ÿ</em></p><ol><li>å†æ¬¡æ£€æŸ¥ç¼“å­˜æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»åŠ è½½äº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å¼€å§‹åŠ è½½è¿‡ç¨‹ã€‚</li><li>è°ƒç”¨ <code>beforeSingletonCreation()</code> è®°å½•åŠ è½½å•ä¾‹ bean ä¹‹å‰çš„åŠ è½½çŠ¶æ€ï¼Œå³å‰ç½®å¤„ç†ã€‚</li><li>è°ƒç”¨å‚æ•°ä¼ é€’çš„ ObjectFactory çš„ <code>getObject()</code> å®ä¾‹åŒ– beanã€‚</li><li>è°ƒç”¨ <code>afterSingletonCreation()</code> è¿›è¡ŒåŠ è½½å•ä¾‹åçš„åç½®å¤„ç†ã€‚</li><li>å°†ç»“æœè®°å½•å¹¶åŠ å…¥å€¼ç¼“å­˜ä¸­ï¼ŒåŒæ—¶åˆ é™¤åŠ è½½ bean è¿‡ç¨‹ä¸­æ‰€è®°å½•çš„ä¸€äº›è¾…åŠ©çŠ¶æ€ã€‚</li></ol><p>æµç¨‹ä¸­æ¶‰åŠçš„ä¸‰ä¸ªæ–¹æ³• <code>beforeSingletonCreation()</code> ä¸ <code>afterSingletonCreation()</code> åœ¨åšå®¢ <a href="/archives/c9c155de.html">IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean </a>ä¸­åˆ†æè¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†é˜è¿°äº†ï¼Œæˆ‘ä»¬çœ‹å¦å¤–ä¸€ä¸ªæ–¹æ³• <code>addSingleton()</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">    <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">    <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª putã€ä¸€ä¸ª addã€ä¸¤ä¸ª removeã€‚</p><ul><li><p><code>singletonObjects</code> å•ä¾‹ bean çš„ç¼“å­˜</p></li><li><p><code>singletonFactories</code> å•ä¾‹ bean Factory çš„ç¼“å­˜</p></li><li><p><code>earlySingletonObjects</code> â€œæ—©æœŸâ€åˆ›å»ºçš„å•ä¾‹ bean çš„ç¼“å­˜</p></li><li><p><code>registeredSingletons</code> å·²ç»æ³¨å†Œçš„å•ä¾‹ç¼“å­˜ã€‚ </p></li></ul><p>åŠ è½½äº†å•ä¾‹ bean åï¼Œè°ƒç”¨ <code>getObjectForBeanInstance()</code> ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡ã€‚è¯¥æ–¹æ³•å·²ç»åœ¨ <a href="/2020/01/16/c9c155de.html">IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean </a> è¯¦ç»†åˆ†æäº†ã€‚ </p><p><strong>åŸå‹æ¨¡å¼</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">  Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    beforePrototypeCreation(beanName);</span><br><span class="line">    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    afterPrototypeCreation(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸå‹æ¨¡å¼çš„åˆå§‹åŒ–è¿‡ç¨‹å¾ˆç®€å•ï¼š<strong>ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹å°±å¯ä»¥äº†ã€‚</strong></p><p>è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨ <code>beforeSingletonCreation()</code> è®°å½•åŠ è½½åŸå‹æ¨¡å¼ bean ä¹‹å‰çš„åŠ è½½çŠ¶æ€ï¼Œå³å‰ç½®å¤„ç†ã€‚</li><li>è°ƒç”¨ <code>createBean()</code> åˆ›å»ºä¸€ä¸ª bean å®ä¾‹å¯¹è±¡ã€‚</li><li>è°ƒç”¨ <code>afterSingletonCreation()</code> è¿›è¡ŒåŠ è½½åŸå‹æ¨¡å¼ bean åçš„åç½®å¤„ç†ã€‚</li><li>è°ƒç”¨ <code>getObjectForBeanInstance()</code> ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡ã€‚</li></ol><p><strong>å…¶ä»–ä½œç”¨åŸŸ</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String scopeName = mbd.getScope();</span><br><span class="line"><span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line"><span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">    <span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">    beforePrototypeCreation(beanName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      afterPrototypeCreation(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">    beanName,</span><br><span class="line">    <span class="string">&quot;Scope &#x27;&quot;</span> + scopeName + </span><br><span class="line">    <span class="string">&quot;&#x27; is not active for the current thread; consider &quot;</span> </span><br><span class="line">    + <span class="string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,</span><br><span class="line">     ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæµç¨‹å’ŒåŸå‹æ¨¡å¼ä¸€æ ·ï¼Œåªä¸è¿‡è·å– bean å®ä¾‹æ˜¯ç”± <code>scope.get()</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String name, ObjectFactory&lt;?&gt; objectFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å– scope ç¼“å­˜</span></span><br><span class="line">  Map&lt;String, Object&gt; scope = <span class="keyword">this</span>.threadScope.get();</span><br><span class="line">  Object scopedObject = scope.get(name);</span><br><span class="line">  <span class="keyword">if</span> (scopedObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">    scopedObject = objectFactory.getObject();</span><br><span class="line">    <span class="comment">// åŠ å…¥ç¼“å­˜</span></span><br><span class="line">    scope.put(name, scopedObject);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> scopedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šé¢ä¸‰ä¸ªæ¨¡å—ï¼Œå…¶ä¸­æœ€é‡è¦çš„æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š <code>createBean() </code>å’Œ<code>getObjectForBeanInstance()</code>ã€‚</p><p>è¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ä¸Šé¢ä¸‰ä¸ªæ¨¡å—éƒ½æœ‰è°ƒç”¨ï¼Œ<code>createBean()</code> åç»­è¯¦ç»†è¯´æ˜ï¼Œ<code>getObjectForBeanInstance()</code> åœ¨åšå®¢<a href="/archives/c9c155de.html">IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean </a> ä¸­æœ‰è¯¦ç»†è®²è§£ï¼Œè¿™é‡Œå†æ¬¡é˜è¿°ä¸‹ï¼ˆæ­¤æ®µå†…å®¹æ¥è‡ªã€ŠSpring æºç æ·±åº¦è§£æã€‹ï¼‰ï¼š<strong>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯éªŒè¯ä»¥ä¸‹æˆ‘ä»¬å¾—åˆ°çš„ bean çš„æ­£ç¡®æ€§ï¼Œå…¶å®å°±æ˜¯æ£€æµ‹å½“å‰ bean æ˜¯å¦æ˜¯ FactoryBean ç±»å‹çš„ beanï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨è¯¥ bean å¯¹åº”çš„ FactoryBean å®ä¾‹çš„ <code>getObject()</code> ä½œä¸ºè¿”å›å€¼ã€‚æ— è®ºæ˜¯ä»ç¼“å­˜ä¸­è·å¾—åˆ°çš„ bean è¿˜æ˜¯é€šè¿‡ä¸åŒçš„ scope ç­–ç•¥åŠ è½½çš„ bean éƒ½åªæ˜¯æœ€åŸå§‹çš„ bean çŠ¶æ€ï¼Œå¹¶ä¸ä¸€å®šå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ beanã€‚</strong></p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒåŠ å…¥æˆ‘ä»¬éœ€è¦å¯¹å·¥å‚ bean è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè¿™é‡Œå¾—åˆ°çš„å…¶å®æ˜¯å·¥å‚ bean çš„åˆå§‹çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ˜¯å·¥å‚ bean ä¸­å®šä¹‰ factory-method æ–¹æ³•ä¸­è¿”å›çš„ beanï¼Œè€Œ <code>getObjectForBeanInstance()</code> å°±æ˜¯å®Œæˆè¿™ä¸ªå·¥ä½œçš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹parentBeanFactoryä¸ä¾èµ–å¤„ç†</title>
      <link href="/blog/2020/01/17/c4a8e2a2.html"/>
      <url>/blog/2020/01/17/c4a8e2a2.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2810">http://cmsblogs.com/?p=2810</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>ç»§ä¸Šç¯‡åšå®¢ <a href="/2020/01/16/c9c155de.html"> åŠ è½½ bean ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean</a>,å¦‚æœä»å•ä¾‹ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°å•ä¾‹ beanï¼Œåˆ™è¯´æ˜ä¸¤ç§æƒ…å†µï¼š</p><ol><li>è¯¥ bean çš„ scope ä¸æ˜¯ singleton</li><li>è¯¥ bean çš„ scope æ˜¯ singleton ,ä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ</li></ol><p>é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µ Spring æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ<strong>ç»Ÿä¸€åŠ è½½å¹¶å®Œæˆåˆå§‹åŒ–ï¼</strong></p><p>è¿™éƒ¨åˆ†å†…å®¹çš„ç¯‡å¹…è¾ƒé•¿ï¼Œæ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><p>ç¬¬ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä¸€äº›æ£€æµ‹ã€parentBeanFactory ä»¥åŠä¾èµ–å¤„ç†ã€‚</p><p>ç¬¬äºŒéƒ¨åˆ†åˆ™æ˜¯å„ä¸ª scope çš„åˆå§‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if bean definition exists in this factory.</span></span><br><span class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">  <span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">  String nameToLookup = originalBeanName(name);</span><br><span class="line">  <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">      nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">    <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">    <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">  markBeanAsCreated(beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">  checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></span><br><span class="line">  String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">  <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          mbd.getResourceDescription(), </span><br><span class="line">          beanName,</span><br><span class="line">          <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> </span><br><span class="line">          + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      registerDependentBean(dep, beanName);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        getBean(dep);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          mbd.getResourceDescription(), </span><br><span class="line">          beanName,</span><br><span class="line">          <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çœç•¥å¾ˆå¤šä»£ç </span></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸»è¦å¤„ç†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æ£€æµ‹ã€‚è‹¥å½“å‰ bean åœ¨åˆ›å»ºï¼Œåˆ™æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚</li><li>å¦‚æœ beanDefinitionMap ä¸­ä¸å­˜åœ¨ beanName çš„ BeanDefinitionï¼ˆå³åœ¨ Spring bean åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ²¡æœ‰åŠ è½½ï¼‰ï¼Œåˆ™å°è¯•ä» parentBeanFactory ä¸­åŠ è½½ã€‚</li><li>åˆ¤æ–­æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥ã€‚</li><li>ä» mergedBeanDefinitions ä¸­è·å– beanName å¯¹åº”çš„ RootBeanDefinitionï¼Œå¦‚æœè¿™ä¸ª BeanDefinition æ˜¯å­ Bean çš„è¯ï¼Œåˆ™ä¼šåˆå¹¶çˆ¶ç±»çš„ç›¸å…³å±æ€§ã€‚</li><li>ä¾èµ–å¤„ç†ã€‚</li></ol><p><strong>æ£€æµ‹</strong> åœ¨å‰é¢å°±æè¿‡ï¼ŒSpring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–åˆ™æ˜¯æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ï¼Œæ‰€ä»¥é¦–å…ˆæ£€æŸ¥è¯¥ beanName æ˜¯å¦å¤„äºåŸå‹æ¨¡å¼ä¸‹çš„å¾ªç¯ä¾èµ–ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>isPrototypeCurrentlyInCreation()</code> åˆ¤æ–­å½“å‰ bean æ˜¯å¦æ­£åœ¨åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isPrototypeCurrentlyInCreation</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  Object curVal = <span class="keyword">this</span>.prototypesCurrentlyInCreation.get();</span><br><span class="line">  <span class="keyword">return</span> (curVal != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">          (curVal.equals(beanName) || </span><br><span class="line">           (curVal <span class="keyword">instanceof</span> Set &amp;&amp; ((Set&lt;?&gt;) curVal).contains(beanName))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®æ£€æµ‹é€»è¾‘å’Œå•ä¾‹æ¨¡å¼ä¸€æ ·ï¼Œä¸€ä¸ªâ€œé›†åˆâ€å­˜æ”¾ç€æ­£åœ¨åˆ›å»ºçš„ beanï¼Œä»è¯¥é›†åˆä¸­è¿›è¡Œåˆ¤æ–­å³å¯ï¼Œåªä¸è¿‡å•ä¾‹æ¨¡å¼çš„â€œé›†åˆâ€ä¸º Set ï¼Œè€ŒåŸå‹æ¨¡å¼çš„åˆ™æ˜¯ ThreadLocalï¼ŒprototypesCurrentlyInCreation å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation </span><br><span class="line">  = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">&quot;Prototype beans currently in creation&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>æ£€æŸ¥çˆ¶ç±» BeanFactory</strong> è‹¥ containsBeanDefinition ä¸­ä¸å­˜åœ¨ beanName ç›¸å¯¹åº”çš„ BeanDefinitionï¼Œåˆ™ä» parentBeanFactory ä¸­è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å– parentBeanFactory</span></span><br><span class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line"><span class="comment">// parentBeanFactory ä¸ä¸ºç©ºä¸” beanDefinitionMap ä¸­ä¸å­˜è¯¥ name çš„ BeanDefinition</span></span><br><span class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">  <span class="comment">// ç¡®å®šåŸå§‹ beanName</span></span><br><span class="line">  String nameToLookup = originalBeanName(name);</span><br><span class="line">  <span class="comment">// è‹¥ä¸º AbstractBeanFactory ç±»å‹ï¼Œå§”æ‰˜çˆ¶ç±»å¤„ç†</span></span><br><span class="line">  <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">      nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å§”æ‰˜ç»™æ„é€ å‡½æ•° getBean() å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ argsï¼Œå§”æ‰˜ç»™æ ‡å‡†çš„ getBean() å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè¿‡ç¨‹è¾ƒä¸ºç®€å•ï¼Œéƒ½æ˜¯å§”æ‰˜ parentBeanFactory çš„ <code>getBean()</code> è¿›è¡Œå¤„ç†ï¼Œåªä¸è¿‡åœ¨è·å–ä¹‹å‰å¯¹ name è¿›è¡Œç®€å•çš„å¤„ç†ï¼Œä¸»è¦æ˜¯æƒ³è·å–åŸå§‹çš„ beanNameï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">originalBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  String beanName = transformedBeanName(name);</span><br><span class="line">  <span class="keyword">if</span> (name.startsWith(FACTORY_BEAN_PREFIX)) &#123;</span><br><span class="line">    beanName = FACTORY_BEAN_PREFIX + beanName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> beanName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>transformedBeanName()</code> æ˜¯å¯¹ name è¿›è¡Œè½¬æ¢ï¼Œè·å–çœŸæ­£çš„ beanNameï¼Œå› ä¸ºæˆ‘ä»¬ä¼ é€’çš„å¯èƒ½æ˜¯ aliasNameï¼ˆè¿™ä¸ªè¿‡ç¨‹åœ¨åšå®¢ <a href="/2020/01/15/27d87789.html"> IOC ä¹‹ å¼€å¯ bean çš„åŠ è½½</a> ä¸­åˆ†æ <code>transformedBeanName()</code> æœ‰è¯¦ç»†è¯´æ˜ï¼‰ï¼Œå¦‚æœ name æ˜¯ä»¥ â€œ&amp;â€ å¼€å¤´çš„ï¼Œåˆ™åŠ ä¸Š â€œ&amp;â€ï¼Œå› ä¸ºåœ¨ <code>transformedBeanName()</code> å°† â€œ&amp;â€ å»æ‰äº†ï¼Œè¿™é‡Œè¡¥ä¸Šã€‚ <strong>ç±»å‹æ£€æŸ¥</strong> å‚æ•° typeCheckOnly æ˜¯ç”¨æ¥åˆ¤æ–­è°ƒç”¨ <code>getBean()</code> æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥è·å– beanã€‚å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>markBeanAsCreated()</code> è®°å½•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">markBeanAsCreated</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰åˆ›å»º</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.alreadyCreated.contains(beanName)) &#123;</span><br><span class="line">    <span class="comment">// åŠ ä¸Šå…¨å±€é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.mergedBeanDefinitions) &#123;</span><br><span class="line">      <span class="comment">// å†æ¬¡æ£€æŸ¥ä¸€æ¬¡ï¼šDCL åŒæ£€æŸ¥æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.alreadyCreated.contains(beanName)) &#123;</span><br><span class="line">        <span class="comment">// ä» mergedBeanDefinitions ä¸­åˆ é™¤ beanNameï¼Œ</span></span><br><span class="line">        <span class="comment">// å¹¶åœ¨ä¸‹æ¬¡è®¿é—®æ—¶é‡æ–°åˆ›å»ºå®ƒã€‚</span></span><br><span class="line">        clearMergedBeanDefinition(beanName);</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°å·²åˆ›å»ºbean é›†åˆä¸­</span></span><br><span class="line">        <span class="keyword">this</span>.alreadyCreated.add(beanName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å– RootBeanDefinition</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>getMergedLocalBeanDefinition()</code> è·å–ç›¸å¯¹åº”çš„ BeanDefinitionï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> RootBeanDefinition <span class="title">getMergedLocalBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="comment">// å¿«é€Ÿä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">  RootBeanDefinition mbd = <span class="keyword">this</span>.mergedBeanDefinitions.get(beanName);</span><br><span class="line">  <span class="keyword">if</span> (mbd != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mbd;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å– RootBeanDefinitionï¼Œ</span></span><br><span class="line">  <span class="comment">// å¦‚æœè¿”å›çš„ BeanDefinition æ˜¯å­ç±» bean çš„è¯ï¼Œåˆ™åˆå¹¶çˆ¶ç±»ç›¸å…³å±æ€§</span></span><br><span class="line">  <span class="keyword">return</span> getMergedBeanDefinition(beanName, getBeanDefinition(beanName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç›´æ¥ä» mergedBeanDefinitions ç¼“å­˜ä¸­è·å–ç›¸åº”çš„ RootBeanDefinitionï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›å¦åˆ™è°ƒç”¨ <code>getMergedBeanDefinition()</code> è·å– RootBeanDefinitionï¼Œè‹¥è·å–çš„ BeanDefinition ä¸ºå­ BeanDefinitionï¼Œåˆ™éœ€è¦åˆå¹¶çˆ¶ç±»çš„ç›¸å…³å±æ€§ã€‚ <strong>å¤„ç†ä¾èµ–</strong> å¦‚æœä¸€ä¸ª bean æœ‰ä¾èµ– bean çš„è¯ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ–è¯¥ bean æ—¶æ˜¯éœ€è¦å…ˆåˆå§‹åŒ–å®ƒæ‰€ä¾èµ–çš„ beanã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¾èµ–ã€‚</span></span><br><span class="line"><span class="comment">// åœ¨åˆå§‹åŒ– bean æ—¶è§£æ depends-on æ ‡ç­¾æ—¶è®¾ç½®</span></span><br><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line"><span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// è¿­ä»£ä¾èµ–</span></span><br><span class="line">  <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">    <span class="comment">// æ£€éªŒä¾èµ–çš„bean æ˜¯å¦å·²ç»æ³¨å†Œç»™å½“å‰ bean è·å–å…¶ä»–ä¼ é€’ä¾èµ–bean</span></span><br><span class="line">    <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                      <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨å†Œåˆ°ä¾èµ–beanä¸­</span></span><br><span class="line">    registerDependentBean(dep, beanName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨ getBean åˆå§‹åŒ–ä¾èµ–bean</span></span><br><span class="line">      getBean(dep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                      <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç é€»è¾‘æ˜¯ï¼šé€šè¿‡è¿­ä»£çš„æ–¹å¼ä¾æ¬¡å¯¹ä¾èµ– bean è¿›è¡Œæ£€æµ‹ã€æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è°ƒç”¨ <code>getBean()</code> å®ä¾‹åŒ–ä¾èµ– beanã€‚ <code>isDependent()</code> æ˜¯æ ¡éªŒè¯¥ä¾èµ–æ˜¯å¦å·²ç»æ³¨å†Œç»™å½“å‰ beanã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isDependent</span><span class="params">(String beanName, String dependentBeanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependentBeanMap) &#123;</span><br><span class="line">    <span class="keyword">return</span> isDependent(beanName, dependentBeanName, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ­¥åŠ é”ç»™ dependentBeanMap å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>isDependent()</code> æ ¡éªŒã€‚dependentBeanMap å¯¹è±¡ä¿å­˜çš„æ˜¯ä¾èµ– beanName ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼šbeanName - &gt; ä¾èµ– beanName çš„é›†åˆ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDependent</span><span class="params">(String beanName, </span></span></span><br><span class="line"><span class="function"><span class="params">                            String dependentBeanName, </span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="meta">@Nullable</span> Set&lt;String&gt; alreadySeen)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// alreadySeen å·²ç»æ£€æµ‹çš„ä¾èµ– bean</span></span><br><span class="line">  <span class="keyword">if</span> (alreadySeen != <span class="keyword">null</span> &amp;&amp; alreadySeen.contains(beanName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–åŸå§‹ beanName</span></span><br><span class="line">  String canonicalName = canonicalName(beanName);</span><br><span class="line">  <span class="comment">// è·å–å½“å‰ beanName çš„ä¾èµ–é›†åˆ</span></span><br><span class="line">  Set&lt;String&gt; dependentBeans = <span class="keyword">this</span>.dependentBeanMap.get(canonicalName);</span><br><span class="line">  <span class="comment">// ä¸å­˜åœ¨ä¾èµ–ï¼Œè¿”å›false</span></span><br><span class="line">  <span class="keyword">if</span> (dependentBeans == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å­˜åœ¨ï¼Œåˆ™è¯æ˜å­˜åœ¨å·²ç»æ³¨å†Œçš„ä¾èµ–</span></span><br><span class="line">  <span class="keyword">if</span> (dependentBeans.contains(dependentBeanName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é€’å½’æ£€æµ‹ä¾èµ–</span></span><br><span class="line">  <span class="keyword">for</span> (String transitiveDependency : dependentBeans) &#123;</span><br><span class="line">    <span class="keyword">if</span> (alreadySeen == <span class="keyword">null</span>) &#123;</span><br><span class="line">      alreadySeen = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    alreadySeen.add(beanName);</span><br><span class="line">    <span class="keyword">if</span> (isDependent(transitiveDependency, dependentBeanName, alreadySeen)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ ¡éªŒæˆåŠŸï¼Œåˆ™è°ƒç”¨ <code>registerDependentBean()</code> å°†è¯¥ä¾èµ–è¿›è¡Œæ³¨å†Œï¼Œä¾¿äºåœ¨é”€æ¯ bean ä¹‹å‰å¯¹å…¶è¿›è¡Œé”€æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDependentBean</span><span class="params">(String beanName, String dependentBeanName)</span> </span>&#123;</span><br><span class="line">  String canonicalName = canonicalName(beanName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependentBeanMap) &#123;</span><br><span class="line">    Set&lt;String&gt; dependentBeans =</span><br><span class="line">      <span class="keyword">this</span>.dependentBeanMap.computeIfAbsent(</span><br><span class="line">      canonicalName, k -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>));</span><br><span class="line">    <span class="keyword">if</span> (!dependentBeans.add(dependentBeanName)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependenciesForBeanMap) &#123;</span><br><span class="line">    Set&lt;String&gt; dependenciesForBean =</span><br><span class="line">      <span class="keyword">this</span>.dependenciesForBeanMap.computeIfAbsent(</span><br><span class="line">      dependentBeanName, k -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>));</span><br><span class="line">    dependenciesForBean.add(canonicalName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°†å°±æ˜¯è¯¥æ˜ å°„å…³ç³»ä¿å­˜åˆ°ä¸¤ä¸ªé›†åˆä¸­ï¼šdependentBeanMapã€dependenciesForBeanMapã€‚ æœ€åè°ƒç”¨ <code>getBean()</code> å®ä¾‹åŒ–ä¾èµ– beanã€‚ è‡³æ­¤ï¼ŒåŠ è½½ bean çš„ç¬¬äºŒä¸ªéƒ¨åˆ†ä¹Ÿåˆ†æå®Œæ¯•äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹ä»å•ä¾‹ç¼“å­˜ä¸­è·å–å•ä¾‹bean</title>
      <link href="/blog/2020/01/16/c9c155de.html"/>
      <url>/blog/2020/01/16/c9c155de.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2808">http://cmsblogs.com/?p=2808</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>ä»è¿™ç¯‡åšå®¢å¼€å§‹æˆ‘ä»¬å¼€å§‹åŠ è½½ bean çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼Œä»ç¼“å­˜ä¸­è·å– beanï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object sharedInstance = getSingleton(beanName);</span><br><span class="line"><span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> </span><br><span class="line">+ beanName +</span><br><span class="line"><span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨ <code>getSingleton()</code> ä»ç¼“å­˜ä¸­è·å– beanï¼Œåœ¨ä¸Šç¯‡åšå®¢ <a href="/2020/01/15/27d87789.html">IOC ä¹‹ å¼€å¯ bean çš„åŠ è½½</a> æåˆ°è¿‡ï¼ŒSpring å¯¹å•ä¾‹æ¨¡å¼çš„ bean åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œåç»­å¦‚æœå†è·å–è¯¥ bean åˆ™æ˜¯ç›´æ¥ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ï¼Œè¯¥è¿‡ç¨‹å°±ä½“ç°åœ¨ <code>getSingleton()</code> ä¸­ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä»å•ä¾‹ç¼“å†²ä¸­åŠ è½½ bean</span></span><br><span class="line">  Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼“å­˜ä¸­çš„ bean ä¸ºç©ºï¼Œä¸”å½“å‰ bean æ­£åœ¨åˆ›å»º</span></span><br><span class="line">  <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">      <span class="comment">// ä» earlySingletonObjects è·å–</span></span><br><span class="line">      singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">      <span class="comment">// earlySingletonObjects ä¸­æ²¡æœ‰ï¼Œä¸”å…è®¸æå‰åˆ›å»º</span></span><br><span class="line">      <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">        <span class="comment">// ä» singletonFactories ä¸­è·å–å¯¹åº”çš„ ObjectFactory</span></span><br><span class="line">        ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">        <span class="comment">// ObjectFactory ä¸ä¸ºç©ºï¼Œåˆ™åˆ›å»º bean</span></span><br><span class="line">        <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">          singletonObject = singletonFactory.getObject();</span><br><span class="line">          <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">          <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œé¦–å…ˆä» <code>singletonObjects</code> ä¸­è·å–ï¼Œè‹¥ä¸ºç©ºä¸”å½“å‰ <code>bean</code> æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™ä» <code>earlySingletonObjects</code> ä¸­è·å–ï¼Œè‹¥ä¸ºç©ºä¸”å…è®¸æå‰åˆ›å»ºåˆ™ä» <code>singletonFactories</code> ä¸­è·å–ç›¸åº”çš„ <code>ObjectFactory</code> ï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å…¶ <code>getObject()</code> åˆ›å»º <code>bean</code>ï¼Œç„¶åå°†å…¶åŠ å…¥åˆ° <code>earlySingletonObjects</code>ï¼Œç„¶åä» <code>singletonFactories</code> åˆ é™¤ã€‚</p><p>æ€»ä½“é€»è¾‘å°±æ˜¯æ ¹æ® <code>beanName</code> ä¾æ¬¡æ£€æµ‹è¿™ä¸‰ä¸ª <code>Map</code>ï¼Œè‹¥ä¸ºç©ºï¼Œä»ä¸‹ä¸€ä¸ªï¼Œå¦åˆ™è¿”å›ã€‚</p><p><strong>è¿™ä¸‰ä¸ª <code>Map</code> å­˜æ”¾çš„éƒ½æœ‰å„è‡ªçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š</strong></p><ul><li><strong>singletonObjects</strong> ï¼šå­˜æ”¾çš„æ˜¯å•ä¾‹ beanï¼Œå¯¹åº”å…³ç³»ä¸º <code>bean name --&gt; bean instance</code></li><li><strong>earlySingletonObjects</strong>ï¼šå­˜æ”¾çš„æ˜¯æ—©æœŸçš„ beanï¼Œå¯¹åº”å…³ç³»ä¹Ÿæ˜¯ <code>bean name --&gt; bean instance</code>ã€‚å®ƒä¸ singletonObjects åŒºåˆ«åœ¨äº earlySingletonObjects ä¸­å­˜æ”¾çš„ bean ä¸ä¸€å®šæ˜¯å®Œæ•´çš„ï¼Œä»ä¸Šé¢è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£ï¼Œbean åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å°±å·²ç»åŠ å…¥åˆ° earlySingletonObjects ä¸­äº†ï¼Œæ‰€ä»¥å½“åœ¨ bean çš„åˆ›å»ºè¿‡ç¨‹ä¸­å°±å¯ä»¥é€šè¿‡ <code>getBean()</code> æ–¹æ³•è·å–ã€‚è¿™ä¸ª Map ä¹Ÿæ˜¯è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®æ‰€åœ¨ã€‚</li><li><strong>singletonFactories</strong>ï¼šå­˜æ”¾çš„æ˜¯ ObjectFactoryï¼Œå¯ä»¥ç†è§£ä¸ºåˆ›å»ºå•ä¾‹ bean çš„ factoryï¼Œå¯¹åº”å…³ç³»æ˜¯ <code>bean name --&gt; ObjectFactory</code></li></ul><p>åœ¨ä¸Šé¢ä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ£€æµ‹æ–¹æ³• <code>isSingletonCurrentlyInCreation(beanName)</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­è¯¥ beanName å¯¹åº”çš„ bean æ˜¯å¦åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæ³¨æ„è¿™ä¸ªè¿‡ç¨‹è®²çš„æ˜¯æ•´ä¸ªå·¥å‚ä¸­ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingletonCurrentlyInCreation</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.singletonsCurrentlyInCreation.contains(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™æ®µä»£ç ä¸­æˆ‘ä»¬å¯ä»¥é¢„æµ‹ï¼Œåœ¨ <code>bean</code> åˆ›å»ºè¿‡ç¨‹ä¸­éƒ½ä¼šå°†å…¶åŠ å…¥åˆ° <code>singletonsCurrentlyInCreation</code> é›†åˆä¸­ï¼Œ<em>å…·ä½“æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŠ çš„ï¼Œæˆ‘ä»¬åé¢åˆ†æ</em>ã€‚ </p><p>åˆ°è¿™é‡Œä»ç¼“å­˜ä¸­è·å– <code>bean</code> çš„è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•äº†ï¼Œæˆ‘ä»¬å†çœ‹å¼€ç¯‡çš„ä»£ç æ®µï¼Œä»ç¼“å­˜ä¸­è·å– <code>bean</code> åï¼Œè‹¥å…¶ä¸ä¸º <code>null</code> ä¸” <code>args</code> ä¸ºç©ºï¼Œåˆ™ä¼šè°ƒç”¨ <code>getObjectForBeanInstance()</code> å¤„ç†ã€‚</p><p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆä¸€æ®µå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä»ç¼“å­˜ä¸­è·å–çš„ <code>bean</code> æ˜¯æœ€åŸå§‹çš„ <code>bean</code> å¹¶ä¸ä¸€å®šä½¿æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ <code>bean</code>ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè°ƒç”¨ <code>getObjectForBeanInstance()</code> è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•çš„å®šä¹‰ä¸ºè·å–ç»™å®š <code>bean</code> å®ä¾‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¦ä¹ˆæ˜¯ <code>bean</code> å®ä¾‹æœ¬èº«ï¼Œè¦ä¹ˆå°±æ˜¯ <code>FactoryBean</code> åˆ›å»ºçš„å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectForBeanInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Object beanInstance, String name, String beanName, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‹¥ä¸ºå·¥å‚ç±»å¼•ç”¨ï¼ˆname ä»¥ &amp; å¼€å¤´ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ NullBeanï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (beanInstance <span class="keyword">instanceof</span> NullBean) &#123;</span><br><span class="line">      <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ beanInstance ä¸æ˜¯ FactoryBean ç±»å‹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ°è¿™é‡Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ª bean å®ä¾‹ï¼Œå½“ç„¶è¯¥å®ä¾‹å¯èƒ½æ˜¯ä¼šæ˜¯æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ bean åˆæˆ–è€…æ˜¯ä¸€ä¸ª FactoryBean</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ FactoryBeanï¼Œæˆ‘æˆ‘ä»¬åˆ™åˆ›å»ºè¯¥ bean</span></span><br><span class="line">  <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beanInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½ FactoryBean</span></span><br><span class="line">  Object object = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// è‹¥ BeanDefinition ä¸º nullï¼Œåˆ™ä»ç¼“å­˜ä¸­åŠ è½½</span></span><br><span class="line">  <span class="keyword">if</span> (mbd == <span class="keyword">null</span>) &#123;</span><br><span class="line">    object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è‹¥ object ä¾ç„¶ä¸ºç©ºï¼Œåˆ™å¯ä»¥ç¡®è®¤ï¼ŒbeanInstance ä¸€å®šæ˜¯ FactoryBean</span></span><br><span class="line">  <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">    FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="keyword">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯ç”¨æˆ·å®šä¹‰çš„è€Œä¸æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰çš„</span></span><br><span class="line">    <span class="keyword">boolean</span> synthetic = (mbd != <span class="keyword">null</span> &amp;&amp; mbd.isSynthetic());</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒå¤„ç†ç±»</span></span><br><span class="line">    object = getObjectFromFactoryBean(factory, beanName, !synthetic);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯è¿›è¡Œæ£€æµ‹å·¥ä½œçš„ï¼Œä¸»è¦å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ name ä¸ºå·¥å‚ç›¸å…³çš„ï¼ˆä»¥ &amp; å¼€å¤´ï¼‰ï¼Œä¸” beanInstance ä¸º NullBean ç±»å‹åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœ beanInstance ä¸ä¸º FactoryBean ç±»å‹åˆ™æŠ›å‡º BeanIsNotAFactoryException å¼‚å¸¸ã€‚è¿™é‡Œä¸»è¦æ˜¯æ ¡éªŒ beanInstance çš„æ­£ç¡®æ€§ã€‚</li><li>å¦‚æœ beanInstance ä¸ä¸º FactoryBean ç±»å‹æˆ–è€… name ä¹Ÿä¸æ˜¯ä¸å·¥å‚ç›¸å…³çš„ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚è¿™é‡Œä¸»è¦æ˜¯å¯¹é FactoryBean ç±»å‹å¤„ç†ã€‚</li><li>å¦‚æœ BeanDefinition ä¸ºç©ºï¼Œåˆ™ä» factoryBeanObjectCache ä¸­åŠ è½½ï¼Œå¦‚æœè¿˜æ˜¯ç©ºï¼Œåˆ™å¯ä»¥æ–­å®š beanInstance ä¸€å®šæ˜¯ FactoryBean ç±»å‹ï¼Œåˆ™å§”æ‰˜ <code>getObjectFromFactoryBean()</code> æ–¹æ³•å¤„ç†</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡º <code>getObjectForBeanInstance()</code> ä¸»è¦æ˜¯è¿”å›ç»™å®šçš„ <code>bean</code> å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶è¯¥å®ä¾‹å¯¹è±¡ä¸ºé <code>FactoryBean</code> ç±»å‹ï¼Œå¯¹äº <code>FactoryBean</code> ç±»å‹çš„ <code>bean</code>ï¼Œåˆ™æ˜¯å§”æ‰˜ <code>getObjectFromFactoryBean()</code> ä» <code>FactoryBean</code> è·å– <code>bean</code> å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸ºå•ä¾‹æ¨¡å¼ä¸”ç¼“å­˜ä¸­å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (getSingletonMutex()) &#123;</span><br><span class="line">      <span class="comment">// ä»ç¼“å­˜ä¸­è·å–æŒ‡å®šçš„ factoryBean</span></span><br><span class="line">      Object object = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸ºç©ºï¼Œåˆ™ä» FactoryBean ä¸­è·å–å¯¹è±¡</span></span><br><span class="line">        object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">        Object alreadyThere = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">        <span class="comment">// **æˆ‘å®åœ¨æ˜¯ä¸æ˜ç™½è¿™é‡Œè¿™ä¹ˆåšçš„åŸå› ï¼Œè¿™é‡Œæ˜¯å¹²å˜›ï¼Ÿï¼Ÿï¼Ÿ**</span></span><br><span class="line">        <span class="keyword">if</span> (alreadyThere != <span class="keyword">null</span>) &#123;</span><br><span class="line">          object = alreadyThere;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// éœ€è¦åç»­å¤„ç†</span></span><br><span class="line">          <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">            <span class="comment">// è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">              <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å‰ç½®å¤„ç†</span></span><br><span class="line">            beforeSingletonCreation(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// å¯¹ä» FactoryBean è·å–çš„å¯¹è±¡è¿›è¡Œåå¤„ç†</span></span><br><span class="line">              <span class="comment">// ç”Ÿæˆçš„å¯¹è±¡å°†æš´éœ²ç»™beanå¼•ç”¨</span></span><br><span class="line">              object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                beanName,                 </span><br><span class="line">                <span class="string">&quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">              <span class="comment">// åç½®å¤„ç†</span></span><br><span class="line">              afterSingletonCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ç¼“å­˜</span></span><br><span class="line">          <span class="keyword">if</span> (containsSingleton(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.factoryBeanObjectCache.put(beanName, object);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// éå•ä¾‹</span></span><br><span class="line">    Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">    <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">          beanName, </span><br><span class="line">          <span class="string">&quot;Post-processing of FactoryBean&#x27;s object failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ä¸ºå•ä¾‹ä¸”å•ä¾‹ bean ç¼“å­˜ä¸­å­˜åœ¨ beanNameï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†ï¼ˆè·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼‰ï¼Œå¦åˆ™åˆ™ä» FactoryBean ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ¥å—åç½®å¤„ç†ï¼Œåˆ™è°ƒç”¨ <code>postProcessObjectFromFactoryBean()</code> è¿›è¡Œåç½®å¤„ç†ã€‚</li><li>é¦–å…ˆè·å–é”ï¼ˆå…¶å®æˆ‘ä»¬åœ¨å‰é¢ç¯‡å¹…ä¸­å‘ç°äº†å¤§é‡çš„åŒæ­¥é”ï¼Œé”ä½çš„å¯¹è±¡éƒ½æ˜¯ this.singletonObjectsï¼Œ ä¸»è¦æ˜¯å› ä¸ºåœ¨å•ä¾‹æ¨¡å¼ä¸­å¿…é¡»è¦ä¿è¯å…¨å±€å”¯ä¸€ï¼‰ï¼Œç„¶åä» factoryBeanObjectCache ç¼“å­˜ä¸­è·å–å®ä¾‹å¯¹è±¡ objectï¼Œè‹¥ object ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>doGetObjectFromFactoryBean()</code>æ–¹æ³•ä» FactoryBean è·å–å¯¹è±¡ï¼Œå…¶å®å†…éƒ¨å°±æ˜¯è°ƒç”¨ <code>FactoryBean.getObject()</code>ã€‚</li><li>å¦‚æœéœ€è¦åç»­å¤„ç†ï¼Œåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š<ul><li>è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼ˆisSingletonCurrentlyInCreationï¼‰ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ</li><li>è°ƒç”¨ <code>beforeSingletonCreation()</code> è¿›è¡Œåˆ›å»ºä¹‹å‰çš„å¤„ç†ã€‚é»˜è®¤å®ç°å°†è¯¥ bean æ ‡å¿—ä¸ºå½“å‰åˆ›å»ºçš„ã€‚</li><li>è°ƒç”¨ <code>postProcessObjectFromFactoryBean()</code> å¯¹ä» FactoryBean è·å–çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯æŒ‰ç…§åŸæ ·ç›´æ¥è¿”å›ï¼Œå…·ä½“å®ç°æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­å®ç°çš„ï¼Œå½“ç„¶å­ç±»ä¹Ÿå¯ä»¥é‡å†™å®ƒï¼Œæ¯”å¦‚åº”ç”¨åç½®å¤„ç†</li><li>è°ƒç”¨ <code>afterSingletonCreation()</code> è¿›è¡Œåˆ›å»º bean ä¹‹åçš„å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯å°†è¯¥ bean æ ‡è®°ä¸ºä¸å†åœ¨åˆ›å»ºä¸­ã€‚</li></ul></li><li>æœ€ååŠ å…¥åˆ° FactoryBeans ç¼“å­˜ä¸­ã€‚</li></ul><p>è¯¥æ–¹æ³•åº”è¯¥å°±æ˜¯åˆ›å»º bean å®ä¾‹å¯¹è±¡ä¸­çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€äº†ã€‚è¿™é‡Œæˆ‘ä»¬å…³æ³¨ä¸‰ä¸ªæ–¹æ³•ï¼š<code>beforeSingletonCreation()</code> ã€ <code>afterSingletonCreation()</code> ã€ <code>postProcessObjectFromFactoryBean()</code>ã€‚å¯èƒ½æœ‰å°ä¼™ä¼´è§‰å¾—å‰é¢ä¸¤ä¸ªæ–¹æ³•ä¸æ˜¯å¾ˆé‡è¦ï¼ŒLZ å¯ä»¥è‚¯å®šå‘Šè¯‰ä½ ï¼Œè¿™ä¸¤æ–¹æ³•æ˜¯éå¸¸é‡è¦çš„æ“ä½œï¼Œå› ä¸º<strong>ä»–ä»¬è®°å½•ç€ bean çš„åŠ è½½çŠ¶æ€ï¼Œæ˜¯æ£€æµ‹å½“å‰ bean æ˜¯å¦å¤„äºåˆ›å»ºä¸­çš„å…³é”®ä¹‹å¤„ï¼Œå¯¹è§£å†³ bean å¾ªç¯ä¾èµ–èµ·ç€å…³é”®ä½œç”¨</strong>ã€‚before æ–¹æ³•ç”¨äºæ ‡å¿—å½“å‰ bean å¤„äºåˆ›å»ºä¸­ï¼Œafter åˆ™æ˜¯ç§»é™¤ã€‚å…¶å®åœ¨è¿™ç¯‡åšå®¢åˆšåˆšå¼€å§‹å°±å·²ç»æåˆ°äº† <code>isSingletonCurrentlyInCreation()</code> æ˜¯ç”¨äºæ£€æµ‹å½“å‰ bean æ˜¯å¦å¤„äºåˆ›å»ºä¹‹ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingletonCurrentlyInCreation</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.singletonsCurrentlyInCreation.contains(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯æ ¹æ® singletonsCurrentlyInCreation é›†åˆä¸­æ˜¯å¦åŒ…å«äº† beanNameï¼Œé›†åˆçš„å…ƒç´ åˆ™ä¸€å®šæ˜¯åœ¨ <code>beforeSingletonCreation()</code> ä¸­æ·»åŠ çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeSingletonCreation</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="keyword">this</span>.singletonsCurrentlyInCreation.add(beanName)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>afterSingletonCreation()</code> ä¸ºç§»é™¤ï¼Œåˆ™ä¸€å®šå°±æ˜¯å¯¹ <code>singletonsCurrentlyInCreation</code> é›†åˆ <code>remove</code> äº†ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterSingletonCreation</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="keyword">this</span>.singletonsCurrentlyInCreation.remove(beanName)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Singleton &#x27;&quot;</span> </span><br><span class="line">                                    + beanName + <span class="string">&quot;&#x27; isn&#x27;t currently in creation&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>postProcessObjectFromFactoryBean()</code> æ˜¯å¯¹ä» <code>FactoryBean</code> å¤„è·å–çš„ <code>bean</code> å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œå…¶é»˜è®¤å®ç°æ˜¯ç›´æ¥è¿”å› <code>object</code> å¯¹è±¡ï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œå­ç±»å¯ä»¥é‡å†™ï¼Œä¾‹å¦‚åº”ç”¨åå¤„ç†å™¨ã€‚</p><p><code>AbstractAutowireCapableBeanFactory</code> å¯¹å…¶æä¾›äº†å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">postProcessObjectFromFactoryBean</span><span class="params">(Object object, String beanName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> applyBeanPostProcessorsAfterInitialization(object, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„å®šä¹‰ä¸ºï¼šå¯¹æ‰€æœ‰çš„ {@code postProcessAfterInitialization} è¿›è¡Œå›è°ƒæ³¨å†Œ BeanPostProcessorsï¼Œè®©ä»–ä»¬èƒ½å¤ŸåæœŸå¤„ç†ä» FactoryBean ä¸­è·å–çš„å¯¹è±¡ã€‚ä¸‹é¢æ˜¯å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  Object result = existingBean;</span><br><span class="line">  <span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">    Object current = beanProcessor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    result = current;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºåç½®å¤„ç†å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšè¿‡å¤šé˜è¿°ï¼Œåé¢ä¼šä¸“é—¨çš„åšæ–‡è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œ</p><p>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦è®°ä½ä¸€ç‚¹ï¼šå°½å¯èƒ½ä¿è¯æ‰€æœ‰ <code>bean</code> åˆå§‹åŒ–åéƒ½ä¼šè°ƒç”¨æ³¨å†Œçš„ <code>BeanPostProcessor.postProcessAfterInitialization()</code> æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¤§å¯ä»¥é’ˆå¯¹æ­¤ç‰¹æ€§è®¾è®¡è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚ è‡³æ­¤ï¼Œä»ç¼“å­˜ä¸­è·å– bean å¯¹è±¡è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•äº†ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹å¼€å¯beançš„åŠ è½½</title>
      <link href="/blog/2020/01/15/27d87789.html"/>
      <url>/blog/2020/01/15/27d87789.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2806">http://cmsblogs.com/?p=2806</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/10/gEeFMx.jpg" alt="img"></p><p>(æ­¤å›¾æ¥è‡ªã€ŠSpring æ­ç§˜ã€‹) <code>Spring IOC</code>å®¹å™¨æ‰€èµ·çš„ä½œç”¨å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒä¼šä»¥æŸç§æ–¹å¼åŠ è½½ <code>Configuration Metadata</code>ï¼Œå°†å…¶è§£ææ³¨å†Œåˆ°å®¹å™¨å†…éƒ¨ï¼Œç„¶åå›æ ¹æ®è¿™äº›ä¿¡æ¯ç»‘å®šæ•´ä¸ªç³»ç»Ÿçš„å¯¹è±¡ï¼Œæœ€ç»ˆç»„è£…æˆä¸€ä¸ªå¯ç”¨çš„åŸºäºè½»é‡çº§å®¹å™¨çš„åº”ç”¨ç³»ç»Ÿã€‚</p><p> <code>Spring</code> åœ¨å®ç°ä¸Šè¿°åŠŸèƒ½ä¸­ï¼Œå°†æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š<strong>å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ</strong>å’Œ<strong>åŠ è½½bean é˜¶æ®µ</strong>ã€‚</p><ul><li><strong>å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ</strong>ï¼šé¦–å…ˆé€šè¿‡æŸç§æ–¹å¼åŠ è½½ Configuration Metadata (ä¸»è¦æ˜¯ä¾æ® Resourceã€ResourceLoader ä¸¤ä¸ªä½“ç³»)ï¼Œç„¶åå®¹å™¨ä¼šå¯¹åŠ è½½çš„ Configuration MetaData è¿›è¡Œè§£æå’Œåˆ†æï¼Œå¹¶å°†åˆ†æçš„ä¿¡æ¯ç»„è£…æˆ BeanDefinitionï¼Œå¹¶å°†å…¶ä¿å­˜æ³¨å†Œåˆ°ç›¸åº”çš„ BeanDefinitionRegistry ä¸­ã€‚è‡³æ­¤ï¼ŒSpring IOC çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆã€‚</li><li><strong>åŠ è½½ bean é˜¶æ®µ</strong>ï¼šç»è¿‡å®¹å™¨åˆå§‹åŒ–é˜¶æ®µåï¼Œåº”ç”¨ç¨‹åºä¸­å®šä¹‰çš„ bean ä¿¡æ¯å·²ç»å…¨éƒ¨åŠ è½½åˆ°ç³»ç»Ÿä¸­äº†ï¼Œå½“æˆ‘ä»¬æ˜¾ç¤ºæˆ–è€…éšå¼åœ°è°ƒç”¨ <code>getBean()</code> æ—¶ï¼Œåˆ™ä¼šè§¦å‘åŠ è½½ bean é˜¶æ®µã€‚åœ¨è¿™é˜¶æ®µï¼Œå®¹å™¨ä¼šé¦–å…ˆæ£€æŸ¥æ‰€è¯·æ±‚çš„å¯¹è±¡æ˜¯å¦å·²ç»åˆå§‹åŒ–å®Œæˆäº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šæ ¹æ®æ³¨å†Œçš„ bean ä¿¡æ¯å®ä¾‹åŒ–è¯·æ±‚çš„å¯¹è±¡ï¼Œå¹¶ä¸ºå…¶æ³¨å†Œä¾èµ–ï¼Œç„¶åå°†å…¶è¿”å›ç»™è¯·æ±‚æ–¹ã€‚è‡³æ­¤ç¬¬äºŒä¸ªé˜¶æ®µä¹Ÿå·²ç»å®Œæˆã€‚</li></ul><p>å½“æˆ‘ä»¬æ˜¾ç¤ºæˆ–è€…éšå¼åœ°è°ƒç”¨ <code>getBean()</code> æ—¶ï¼Œåˆ™ä¼šè§¦å‘åŠ è½½ <code>bean</code> é˜¶æ®µã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨è°ƒç”¨ <code>doGetBean()</code> æ–¹æ³•ï¼Œå…¶æ¥å—å››ä¸ªå‚æ•°ï¼š</p><ul><li><strong>name</strong>ï¼šè¦è·å– bean çš„åå­—</li><li><strong>requiredType</strong>ï¼šè¦è·å– bean çš„ç±»å‹</li><li><strong>args</strong>ï¼šåˆ›å»º bean æ—¶ä¼ é€’çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°ä»…é™äºåˆ›å»º bean æ—¶ä½¿ç”¨</li><li><strong>typeCheckOnly</strong>ï¼šæ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥</li></ul><p>è¿™ä¸ªæ–¹æ³•çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå„ä½è€å¿ƒçœ‹ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> String name, <span class="meta">@Nullable</span> <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– beanNameï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªè½¬æ¢åŠ¨ä½œï¼Œå°† name è½¬æ¢Wie beanName</span></span><br><span class="line">  <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">  Object bean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­è·å– bean</span></span><br><span class="line">  <span class="comment">// *** è¿™é‡Œä¼šæ¶‰åŠåˆ°è§£å†³å¾ªç¯ä¾èµ– bean çš„é—®é¢˜</span></span><br><span class="line">  Object sharedInstance = getSingleton(beanName);</span><br><span class="line">  <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> </span><br><span class="line">         + beanName </span><br><span class="line">         +</span><br><span class="line">        <span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å› ä¸º Spring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œåœ¨åŸå‹æ¨¡å¼ä¸‹å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// **å…³äºå¾ªç¯ä¾èµ–åç»­ä¼šå•ç‹¬å‡ºæ–‡è¯¦ç»†è¯´æ˜**</span></span><br><span class="line">    <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä»çˆ¶ç±»å®¹å™¨ä¸­åŠ è½½</span></span><br><span class="line">    BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      String nameToLookup = originalBeanName(name);</span><br><span class="line">      <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">          nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œè¿™é‡Œéœ€è¦è®°å½•</span></span><br><span class="line">    <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">      markBeanAsCreated(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ä»å®¹å™¨ä¸­è·å– beanName ç›¸åº”çš„ GenericBeanDefinitionï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º RootBeanDefinition</span></span><br><span class="line">      <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ£€æŸ¥ç»™å®šçš„åˆå¹¶çš„ BeanDefinition</span></span><br><span class="line">      checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤„ç†æ‰€ä¾èµ–çš„ bean</span></span><br><span class="line">      String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">      <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">          <span class="comment">// è‹¥ç»™å®šçš„ä¾èµ– bean å·²ç»æ³¨å†Œä¸ºä¾èµ–ç»™å®šçš„b ean</span></span><br><span class="line">          <span class="comment">// å¾ªç¯ä¾èµ–çš„æƒ…å†µ</span></span><br><span class="line">          <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">              mbd.getResourceDescription(), </span><br><span class="line">              beanName,</span><br><span class="line">                                            </span><br><span class="line">              <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> </span><br><span class="line">              + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ç¼“å­˜ä¾èµ–è°ƒç”¨</span></span><br><span class="line">          registerDependentBean(dep, beanName);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            getBean(dep);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">              mbd.getResourceDescription(), </span><br><span class="line">              beanName,</span><br><span class="line">                                            </span><br><span class="line">              <span class="string">&quot;&#x27;&quot;</span> + beanName </span><br><span class="line">              + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bean å®ä¾‹åŒ–</span></span><br><span class="line">      <span class="comment">// å•ä¾‹æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="comment">// æ˜¾ç¤ºä»å•åˆ©ç¼“å­˜ä¸­åˆ é™¤ bean å®ä¾‹</span></span><br><span class="line">            <span class="comment">// å› ä¸ºå•ä¾‹æ¨¡å¼ä¸‹ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯èƒ½ä»–å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥é”€æ¯å®ƒ</span></span><br><span class="line">            destroySingleton(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åŸå‹æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">        Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          beforePrototypeCreation(beanName);</span><br><span class="line">          prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          afterPrototypeCreation(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä»æŒ‡å®šçš„ scope ä¸‹åˆ›å»º bean</span></span><br><span class="line">        String scopeName = mbd.getScope();</span><br><span class="line">        <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">        <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">            beforePrototypeCreation(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">              afterPrototypeCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">          bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">            beanName,</span><br><span class="line">                                          </span><br><span class="line">            <span class="string">&quot;Scope &#x27;&quot;</span> + scopeName </span><br><span class="line">            + <span class="string">&quot;&#x27; is not active for the current thread; consider &quot;</span> </span><br><span class="line">            + <span class="string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,</span><br><span class="line">                                          </span><br><span class="line">            ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥éœ€è¦çš„ç±»å‹æ˜¯å¦ç¬¦åˆ bean çš„å®é™…ç±»å‹</span></span><br><span class="line">  <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">      <span class="keyword">if</span> (convertedBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> convertedBean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                     ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ˜¯ç›¸å½“é•¿ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç›¸å½“å¤æ‚ï¼Œä¸‹é¢å°†å…¶è¿›è¡Œæ‹†åˆ†é˜è¿°ã€‚ </p><p><strong>1.è·å– beanName</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼ é€’çš„æ˜¯ nameï¼Œä¸ä¸€å®šå°±æ˜¯ beanNameï¼Œå¯èƒ½æ˜¯ aliasNameï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ FactoryBeanï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨ <code>transformedBeanName()</code> æ–¹æ³•å¯¹ name è¿›è¡Œä¸€ç•ªè½¬æ¢ï¼Œä¸»è¦å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">transformedBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> canonicalName(BeanFactoryUtils.transformedBeanName(name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»é™¤ FactoryBean çš„ä¿®é¥°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">transformedBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(name, <span class="string">&quot;&#x27;name&#x27; must not be null&quot;</span>);</span><br><span class="line">  String beanName = name;</span><br><span class="line">  <span class="keyword">while</span> (beanName.startsWith(BeanFactory.FACTORY_BEAN_PREFIX)) &#123;</span><br><span class="line">    beanName = beanName.substring(BeanFactory.FACTORY_BEAN_PREFIX.length());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> beanName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢ aliasName</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">canonicalName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  String canonicalName = name;</span><br><span class="line">  <span class="comment">// Handle aliasing...</span></span><br><span class="line">  String resolvedName;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    resolvedName = <span class="keyword">this</span>.aliasMap.get(canonicalName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedName != <span class="keyword">null</span>) &#123;</span><br><span class="line">      canonicalName = resolvedName;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (resolvedName != <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">return</span> canonicalName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å¤„ç†è¿‡ç¨‹åŒ…æ‹¬ä¸¤æ­¥ï¼š</p><ol><li>å»é™¤ FactoryBean çš„ä¿®é¥°ç¬¦ã€‚å¦‚æœ name ä»¥ â€œ&amp;â€ ä¸ºå‰ç¼€ï¼Œé‚£ä¹ˆä¼šå»æ‰è¯¥ â€œ&amp;â€ï¼Œä¾‹å¦‚ï¼Œ<code>name = &quot;&amp;studentService&quot;</code>ï¼Œåˆ™ä¼šæ˜¯ <code>name = &quot;studentService&quot;</code>ã€‚</li><li>å–æŒ‡å®šçš„ alias æ‰€è¡¨ç¤ºçš„æœ€ç»ˆ beanNameã€‚ä¸»è¦æ˜¯ä¸€ä¸ªå¾ªç¯è·å– beanName çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚åˆ«å A æŒ‡å‘åç§°ä¸º B çš„ bean åˆ™è¿”å› Bï¼Œè‹¥ åˆ«å A æŒ‡å‘åˆ«å Bï¼Œåˆ«å B æŒ‡å‘åç§°ä¸º C çš„ beanï¼Œåˆ™è¿”å› Cã€‚</li></ol><p><strong>2.ä»å•ä¾‹ bean ç¼“å­˜ä¸­è·å– bean</strong> å¯¹åº”ä»£ç æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object sharedInstance = getSingleton(beanName);</span><br><span class="line"><span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“å•ä¾‹æ¨¡å¼çš„ bean åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºåä¼šå°†è¯¥ bean åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œåé¢åœ¨è·å– bean å°±ä¼šç›´æ¥ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ã€‚å¦‚æœä»ç¼“å­˜ä¸­å¾—åˆ°äº† beanï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>getObjectForBeanInstance()</code> å¯¹ bean è¿›è¡Œå®ä¾‹åŒ–å¤„ç†ï¼Œå› ä¸ºç¼“å­˜ä¸­è®°å½•çš„æ˜¯æœ€åŸå§‹çš„ bean çŠ¶æ€ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ beanã€‚ </p><p><strong>3.åŸå‹æ¨¡å¼ä¾èµ–æ£€æŸ¥ä¸ parentBeanFactory</strong> å¯¹åº”ä»£ç æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if bean definition exists in this factory.</span></span><br><span class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">  <span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">  String nameToLookup = originalBeanName(name);</span><br><span class="line">  <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">      nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">    <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">    <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring åªå¤„ç†å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä¸»è¦åŸå› è¿˜æ˜¯åœ¨äº Spring è§£å†³å¾ªç¯ä¾èµ–çš„ç­–ç•¥æœ‰å…³ã€‚å¯¹äºå•ä¾‹æ¨¡å¼ Spring åœ¨åˆ›å»º bean çš„æ—¶å€™å¹¶ä¸æ˜¯ç­‰ bean å®Œå…¨åˆ›å»ºå®Œæˆåæ‰ä¼šå°† bean æ·»åŠ è‡³ç¼“å­˜ä¸­ï¼Œè€Œæ˜¯ä¸ç­‰ bean åˆ›å»ºå®Œæˆå°±ä¼šå°†åˆ›å»º bean çš„ ObjectFactory ææ—©åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œè¿™æ ·ä¸€æ—¦ä¸‹ä¸€ä¸ª bean åˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ– bean æ—¶åˆ™ç›´æ¥ä½¿ç”¨ ObjectFactroyã€‚ä½†æ˜¯åŸå‹æ¨¡å¼æˆ‘ä»¬çŸ¥é“æ˜¯æ²¡æ³•ä½¿ç”¨ç¼“å­˜çš„ï¼Œæ‰€ä»¥ Spring å¯¹åŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç†ç­–ç•¥åˆ™æ˜¯ä¸å¤„ç†ï¼ˆå…³äºå¾ªç¯ä¾èµ–åé¢ä¼šæœ‰å•ç‹¬æ–‡ç« è¯´æ˜ï¼‰ã€‚ å¦‚æœå®¹å™¨ç¼“å­˜ä¸­æ²¡æœ‰ç›¸å¯¹åº”çš„ BeanDefinition åˆ™ä¼šå°è¯•ä»çˆ¶ç±»å·¥å‚ï¼ˆparentBeanFactoryï¼‰ä¸­åŠ è½½ï¼Œç„¶åå†å»é€’å½’è°ƒç”¨ <code>getBean()</code>ã€‚ </p><p><strong>4. ä¾èµ–å¤„ç†</strong> å¯¹åº”æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line"><span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), </span><br><span class="line">        beanName,</span><br><span class="line">                                      </span><br><span class="line">        <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    registerDependentBean(dep, beanName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      getBean(dep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), </span><br><span class="line">        beanName,                  </span><br><span class="line">        <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª bean éƒ½ä¸æ˜¯å•ç‹¬å·¥ä½œçš„ï¼Œå®ƒä¼šä¾èµ–å…¶ä»– beanï¼Œå…¶ä»– bean ä¹Ÿä¼šä¾èµ–å®ƒï¼Œå¯¹äºä¾èµ–çš„ bean ï¼Œå®ƒä¼šä¼˜å…ˆåŠ è½½ï¼Œæ‰€ä»¥åœ¨ Spring çš„åŠ è½½é¡ºåºä¸­ï¼Œåœ¨åˆå§‹åŒ–æŸä¸€ä¸ª bean çš„æ—¶å€™é¦–å…ˆä¼šåˆå§‹åŒ–è¿™ä¸ª bean çš„ä¾èµ–ã€‚ </p><p><strong>ä½œç”¨åŸŸå¤„ç†</strong> Spring bean çš„ä½œç”¨åŸŸé»˜è®¤ä¸º singletonï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–ä½œç”¨åŸŸï¼Œå¦‚prototypeã€requestã€session ç­‰ï¼Œä¸åŒçš„ä½œç”¨åŸŸä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥ã€‚ </p><p><strong>ç±»å‹è½¬æ¢</strong> åœ¨è°ƒç”¨ <code>doGetBean()</code> æ–¹æ³•æ—¶ï¼Œæœ‰ä¸€ä¸ª requiredType å‚æ•°ï¼Œè¯¥å‚æ•°çš„åŠŸèƒ½å°±æ˜¯å°†è¿”å›çš„ bean è½¬æ¢ä¸º requiredType ç±»å‹ã€‚å½“ç„¶å°±ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬æ˜¯ä¸éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢çš„ï¼Œä¹Ÿå°±æ˜¯ requiredType ä¸ºç©ºï¼ˆæ¯”å¦‚ <code>getBean(String name)</code>ï¼‰ï¼Œä½†æœ‰å¯èƒ½ä¼šå­˜åœ¨è¿™ç§æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ä»¬è¿”å›çš„ bean ç±»å‹ä¸º Stringï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦å°†å…¶è½¬æ¢ä¸º Integerï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ requiredType å°±æœ‰ç”¨æ­¦ä¹‹åœ°äº†ã€‚å½“ç„¶æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä¸éœ€è¦è¿™æ ·åšçš„ã€‚ è‡³æ­¤ <code>getBean()</code> è¿‡ç¨‹è®²è§£å®Œäº†ã€‚åç»­å°†ä¼šå¯¹è¯¥è¿‡ç¨‹è¿›è¡Œæ‹†åˆ†ï¼Œæ›´åŠ è¯¦ç»†çš„è¯´æ˜ï¼Œå¼„æ¸…æ¥šå…¶ä¸­çš„æ¥é¾™å»è„‰ï¼Œæ‰€ä»¥è¿™ç¯‡åšå®¢åªèƒ½ç®—æ˜¯ Spring bean åŠ è½½è¿‡ç¨‹çš„ä¸€ä¸ªæ¦‚è§ˆã€‚</p><p>æ‹†åˆ†ä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>åˆ†æä»ç¼“å­˜ä¸­è·å–å•ä¾‹ beanï¼Œä»¥åŠå¯¹ bean çš„å®ä¾‹ä¸­è·å–å¯¹è±¡</li><li>å¦‚æœä»å•ä¾‹ç¼“å­˜ä¸­è·å– beanï¼ŒSpring æ˜¯æ€ä¹ˆåŠ è½½çš„å‘¢ï¼Ÿæ‰€ä»¥ç¬¬äºŒéƒ¨åˆ†æ˜¯åˆ†æ bean åŠ è½½ï¼Œä»¥åŠ bean çš„ä¾èµ–å¤„ç†</li><li>bean å·²ç»åŠ è½½äº†ï¼Œä¾èµ–ä¹Ÿå¤„ç†å®Œæ¯•äº†ï¼Œç¬¬ä¸‰éƒ¨åˆ†åˆ™åˆ†æå„ä¸ªä½œç”¨åŸŸçš„ bean åˆå§‹åŒ–è¿‡ç¨‹ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹è£…è½½BeanDefinitionsæ€»ç»“</title>
      <link href="/blog/2020/01/14/af13201.html"/>
      <url>/blog/2020/01/14/af13201.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=todo">http://cmsblogs.com/?p=todo</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>å‰é¢åˆ†æäº† <code>IoC BeanDefinition</code> è£…è½½çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™ç¯‡å°±è¿™äº›å†…å®¹åšä¸€ä¸ªæ€»ç»“å°†å…¶è¿è´¯èµ·æ¥ã€‚</p><p>åœ¨å‰æ–‡æè¿‡ï¼Œ<code>IoC</code> å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥éª¤ï¼š<code>Resource å®šä½</code>ã€<code>BeanDefinition çš„è½½å…¥</code>å’Œ<code>è§£æ</code>ï¼Œ<code>BeanDefinition æ³¨å†Œ</code>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/szYKeg.jpg" alt="szYKeg"></p><ul><li><p><strong>Resource å®šä½</strong>ã€‚æˆ‘ä»¬ä¸€èˆ¬ç”¨å¤–éƒ¨èµ„æºæ¥æè¿° Bean å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– IoC å®¹å™¨çš„ç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦å®šä½è¿™ä¸ªå¤–éƒ¨èµ„æºã€‚åœ¨ä¸Šä¸€ç¯‡åšå®¢ï¼ˆ<a href="/2020/01/02/8f7aa5ac.html">ã€ŠIoC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥ã€‹</a>ï¼‰å·²ç»è¯¦ç»†è¯´æ˜äº†èµ„æºåŠ è½½çš„è¿‡ç¨‹ã€‚</p></li><li><p><strong>BeanDefinition çš„è£…è½½å’Œè§£æ</strong></p><p><em>è£…è½½å°±æ˜¯ BeanDefinition çš„è½½å…¥ã€‚</em></p></li></ul><blockquote><p>è¯»å–ã€è§£æ Resource èµ„æºï¼Œä¹Ÿå°±æ˜¯å°†ç”¨æˆ·å®šä¹‰çš„ Bean è¡¨ç¤ºæˆ IoC å®¹å™¨çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼šBeanDefinition</p></blockquote><ul><li><p>åœ¨ IoC å®¹å™¨å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª BeanDefinition Map çš„æ•°æ®ç»“æ„</p></li><li><p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ª <bean> éƒ½å¯¹åº”ç€ä¸€ä¸ª BeanDefinition å¯¹è±¡ã€‚</p></li><li><p><strong>BeanDefinition æ³¨å†Œ</strong></p><p>å‘ <code>IoC</code> å®¹å™¨æ³¨å†Œåœ¨ç¬¬äºŒæ­¥è§£æå¥½çš„ <code>BeanDefinition</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ <code>BeanDefinitionRegistry</code> æ¥å£æ¥å®ç°çš„ã€‚</p><p><em>åœ¨ <code>IoC</code> å®¹å™¨å†…éƒ¨å…¶å®æ˜¯å°†ç¬¬äºŒä¸ªè¿‡ç¨‹è§£æå¾—åˆ°çš„ <code>BeanDefinition</code> æ³¨å…¥åˆ°ä¸€ä¸ª <code>HashMap</code> å®¹å™¨ä¸­ï¼Œ<code>IoC</code> å®¹å™¨å°±æ˜¯é€šè¿‡è¿™ä¸ª <code>HashMap</code> æ¥ç»´æŠ¤è¿™äº› <code>BeanDefinition</code> çš„ã€‚</em></p><ul><li>åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰å®Œæˆä¾èµ–æ³¨å…¥ï¼ˆBean åˆ›å»ºï¼‰ï¼Œ<code>Bean</code> åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>#getBean(...)</code> æ–¹æ³•ï¼Œå‘å®¹å™¨ç´¢è¦ <code>Bean</code> æ—¶ã€‚</li><li>å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®é¢„å¤„ç†ï¼Œå³å¯¹æŸä¸ª <code>Bean</code> è®¾ç½® <code>lazyinit = false</code> å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Bean</code> çš„ä¾èµ–æ³¨å…¥å°±ä¼šåœ¨å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å®Œæˆã€‚</li></ul></li></ul><p>åœ¨åšå®¢ <a href="/2020/01/03/a6d994a0.html">ã€Š IoC ä¹‹åŠ è½½ BeanDefinitionã€‹</a> ä¸­æä¾›è¿‡ä¸€æ®µä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ ·ä¹Ÿä»¥è¿™æ®µä»£ç ä½œä¸ºæˆ‘ä»¬ç ”ç©¶ <code>IoC</code> åˆå§‹åŒ–è¿‡ç¨‹çš„å¼€ç«¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;bean.xml&quot;</span>);</span><br><span class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">reader.loadBeanDefinitions(resource);</span><br></pre></td></tr></table></figure><p>åˆšåˆšå¼€å§‹çš„æ—¶å€™å¯èƒ½å¯¹ä¸Šé¢è¿™å‡ è¡Œä»£ç ä¸çŸ¥é“ä»€ä¹ˆæ„æ€ï¼Œç°åœ¨åº”è¯¥å°±ä¸€ç›®äº†ç„¶äº†ï¼š</p><ul><li><p><code>ClassPathResource resource = new ClassPathResource(&quot;bean.xml&quot;);</code> ï¼š æ ¹æ® <code>Xml</code> é…ç½®æ–‡ä»¶åˆ›å»º <code>Resource</code> èµ„æºå¯¹è±¡ã€‚</p><blockquote><p><code>ClassPathResource</code> æ˜¯ <code>Resource</code> æ¥å£çš„å­ç±»ï¼Œ<code>bean.xml</code> æ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯æˆ‘ä»¬å®šä¹‰çš„ <code>Bean</code> ä¿¡æ¯ã€‚</p></blockquote></li><li><p><code>DefaultListableBeanFactory factory = new DefaultListableBeanFactory();</code> ï¼šåˆ›å»ºä¸€ä¸ª BeanFactory ã€‚</p><p><code>DefaultListableBeanFactory</code> æ˜¯ <code>BeanFactory</code> çš„ä¸€ä¸ªå­ç±»ï¼Œ<code>BeanFactory</code> ä½œä¸ºä¸€ä¸ªæ¥å£ï¼Œå…¶å®å®ƒæœ¬èº«æ˜¯ä¸å…·æœ‰ç‹¬ç«‹ä½¿ç”¨çš„åŠŸèƒ½çš„ï¼Œè€Œ <code>DefaultListableBeanFactory</code> åˆ™æ˜¯çœŸæ­£å¯ä»¥ç‹¬ç«‹ä½¿ç”¨çš„ <code>IoC</code> å®¹å™¨ï¼Œå®ƒæ˜¯æ•´ä¸ª <code>Spring IoC</code> çš„<strong>å§‹ç¥–</strong>ï¼Œåœ¨åç»­ä¼šæœ‰ä¸“é—¨çš„æ–‡ç« æ¥åˆ†æå®ƒã€‚</p></li><li><p><code>XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);</code> ï¼šåˆ›å»º <code>XmlBeanDefinitionReader</code> è¯»å–å™¨ï¼Œç”¨äºè½½å…¥ <code>BeanDefinition</code> ã€‚</p></li><li><p><code>reader.loadBeanDefinitions(resource);</code>ï¼šå¼€å§‹ <code>BeanDefinition</code> çš„è½½å…¥å’Œæ³¨å†Œè¿›ç¨‹ï¼Œå®Œæˆåçš„ <code>BeanDefinition</code> æ”¾ç½®åœ¨ <code>IoC</code> å®¹å™¨ä¸­ã€‚</p></li></ul><h1 id="1-Resource-å®šä½"><a href="#1-Resource-å®šä½" class="headerlink" title="1. Resource å®šä½"></a>1. Resource å®šä½</h1><p>Spring ä¸ºäº†è§£å†³èµ„æºå®šä½çš„é—®é¢˜ï¼Œæä¾›äº†ä¸¤ä¸ªæ¥å£ï¼šResourceã€ResourceLoaderï¼Œå…¶ä¸­ï¼š</p><ul><li>Resource æ¥å£æ˜¯ Spring ç»Ÿä¸€èµ„æºçš„æŠ½è±¡æ¥å£</li><li>ResourceLoader åˆ™æ˜¯ Spring èµ„æºåŠ è½½çš„ç»Ÿä¸€æŠ½è±¡ã€‚</li><li>å…³äºResourceã€ResourceLoader çš„æ›´å¤šçŸ¥è¯†è¯·å…³æ³¨ <a href="/2020/01/02/8f7aa5ac.html">ã€ŠIoC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥ã€‹</a></li></ul><p>Resource èµ„æºçš„å®šä½éœ€è¦ Resource å’Œ ResourceLoader ä¸¤ä¸ªæ¥å£äº’ç›¸é…åˆï¼Œåœ¨ä¸Šé¢é‚£æ®µä»£ç ä¸­ <code>new ClassPathResource(&quot;bean.xml&quot;)</code> ä¸ºæˆ‘ä»¬å®šä¹‰äº†èµ„æºï¼Œé‚£ä¹ˆ <code>ResourceLoader</code> åˆ™æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿ</p><p>çœ‹ <code>XmlBeanDefinitionReader</code> æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">XmlBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>ç›´æ¥è°ƒç”¨çˆ¶ç±» <code>AbstractBeanDefinitionReader</code> æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractBeanDefinitionReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.registry = registry;</span><br><span class="line"><span class="comment">// Determine ResourceLoader to use.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.registry <span class="keyword">instanceof</span> ResourceLoader) &#123;</span><br><span class="line"><span class="keyword">this</span>.resourceLoader = (ResourceLoader) <span class="keyword">this</span>.registry;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.resourceLoader = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inherit Environment if possible</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.registry <span class="keyword">instanceof</span> EnvironmentCapable) &#123;</span><br><span class="line"><span class="keyword">this</span>.environment = ((EnvironmentCapable) <span class="keyword">this</span>.registry).getEnvironment();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.environment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ ¸å¿ƒåœ¨äºè®¾ç½® <code>resourceLoader</code> è¿™æ®µï¼Œå¦‚æœè®¾ç½®äº† <code>ResourceLoader</code> åˆ™ç”¨è®¾ç½®çš„ï¼Œå¦åˆ™ä½¿ç”¨ <code>PathMatchingResourcePatternResolver</code> ï¼Œè¯¥ç±»æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…çš„ <code>ResourceLoader</code>ã€‚</li></ul></li></ul><h1 id="2-BeanDefinition-çš„è½½å…¥å’Œè§£æ"><a href="#2-BeanDefinition-çš„è½½å…¥å’Œè§£æ" class="headerlink" title="2. BeanDefinition çš„è½½å…¥å’Œè§£æ"></a>2. BeanDefinition çš„è½½å…¥å’Œè§£æ</h1><p><code>reader.loadBeanDefinitions(resource);</code> ä»£ç æ®µï¼Œå¼€å¯ <code>BeanDefinition</code> çš„è§£æè¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¼šå°†èµ„æº <code>resource</code> åŒ…è£…æˆä¸€ä¸ª <code>EncodedResource</code> å®ä¾‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>#loadBeanDefinitions(EncodedResource encodedResource)</code> æ–¹æ³•ã€‚</p><p>è€Œå°† <code>Resource</code> å°è£…æˆ <code>EncodedResource</code> ä¸»è¦æ˜¯ä¸ºäº†å¯¹ <code>Resource</code> è¿›è¡Œç¼–ç ï¼Œä¿è¯å†…å®¹è¯»å–çš„æ­£ç¡®æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  <span class="comment">// ... çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// å°†èµ„æºæ–‡ä»¶è½¬ä¸º InputStream çš„ IO æµ</span></span><br><span class="line">  InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ä» InputStream ä¸­å¾—åˆ° XML çš„è§£ææº</span></span><br><span class="line">  InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">  <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">  inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... å…·ä½“çš„è¯»å–è¿‡ç¨‹</span></span><br><span class="line">  <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">  inputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>ä» <code>encodedResource</code> æºä¸­è·å– <code>xml</code> çš„è§£ææºï¼Œç„¶åè°ƒç”¨ <code>#doLoadBeanDefinitions(InputSource inputSource, Resource resource)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå…·ä½“çš„è§£æè¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// è·å– XML Document å®ä¾‹</span></span><br><span class="line">  Document doc = doLoadDocument(inputSource, resource);</span><br><span class="line">  <span class="comment">// æ ¹æ® Document å®ä¾‹ï¼Œæ³¨å†Œ Bean ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">int</span> count = registerBeanDefinitions(doc, resource);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... çœç•¥ä¸€å †é…ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨è¯¥æ–¹æ³•ä¸­ä¸»è¦åšä¸¤ä»¶äº‹ï¼š</li><li>1ã€æ ¹æ® <code>xml</code> è§£ææºè·å–ç›¸åº”çš„ <code>Document</code> å¯¹è±¡ã€‚</li><li>2ã€è°ƒç”¨ <code>#registerBeanDefinitions(Document doc, Resource resource)</code> æ–¹æ³•ï¼Œå¼€å¯ BeanDefinition çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚</li></ul></li></ul></li></ul><h2 id="2-1-è½¬æ¢ä¸º-Document-å¯¹è±¡"><a href="#2-1-è½¬æ¢ä¸º-Document-å¯¹è±¡" class="headerlink" title="2.1 è½¬æ¢ä¸º Document å¯¹è±¡"></a>2.1 è½¬æ¢ä¸º Document å¯¹è±¡</h2><p>è°ƒç”¨ <code>#doLoadDocument(InputSource inputSource, Resource resource)</code> æ–¹æ³•ï¼Œä¼šå°† <code>Bean</code> å®šä¹‰çš„èµ„æºè½¬æ¢ä¸º <code>Document</code> å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Document <span class="title">doLoadDocument</span><span class="params">(InputSource inputSource, Resource resource)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.documentLoader.loadDocument(inputSource, getEntityResolver(), <span class="keyword">this</span>.errorHandler,</span><br><span class="line">getValidationModeForResource(resource), isNamespaceAware());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¥å—äº”ä¸ªå‚æ•°ï¼š</p><ul><li><p><code>inputSource</code> ï¼šåŠ è½½ <code>Document</code> çš„ <code>Resource</code> æºã€‚</p></li><li><p><code>entityResolver</code>ï¼šè§£ææ–‡ä»¶çš„è§£æå™¨ã€‚</p><ul><li>ã€é‡è¦ã€‘è¯¦ç»†è§£æï¼Œè§ <a href="/2020/01/05/13336b20.html">ã€Š IoC ä¹‹è·å– Document å¯¹è±¡ã€‹</a> ã€‚</li></ul></li><li><p><code>errorHandler</code> ï¼šå¤„ç†åŠ è½½ <code>Document</code> å¯¹è±¡çš„è¿‡ç¨‹çš„é”™è¯¯ã€‚</p></li><li><p> <code>validationMode</code> ï¼šéªŒè¯æ¨¡å¼ã€‚</p></li><li><p>ã€é‡è¦ã€‘è¯¦ç»†è§£æï¼Œè§ <a href="/2020/01/04/4e0696ee.html">ã€Š IoC ä¹‹è·å–éªŒè¯æ¨¡å‹ã€‹</a> ã€‚</p></li><li><p><code>namespaceAware</code> ï¼šå‘½åç©ºé—´æ”¯æŒã€‚å¦‚æœè¦æä¾›å¯¹ XML åç§°ç©ºé—´çš„æ”¯æŒï¼Œåˆ™ä¸º <code>true</code> ã€‚</p></li></ul><hr><p><code>#loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware)</code> æ–¹æ³•ï¼Œåœ¨ç±» DefaultDocumentLoader ä¸­æä¾›äº†å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultDocumentLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">loadDocument</span><span class="params">(InputSource inputSource, EntityResolver entityResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">ErrorHandler errorHandler, <span class="keyword">int</span> validationMode, <span class="keyword">boolean</span> namespaceAware)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// åˆ›å»º DocumentBuilderFactory</span></span><br><span class="line">DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware);</span><br><span class="line"><span class="comment">// åˆ›å»º DocumentBuilder</span></span><br><span class="line">DocumentBuilder builder = </span><br><span class="line">    createDocumentBuilder(factory, entityResolver, errorHandler);</span><br><span class="line"><span class="comment">// è§£æ XML InputSource è¿”å› Document å¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> builder.parse(inputSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-æ³¨å†Œ-BeanDefinition-æµç¨‹"><a href="#2-2-æ³¨å†Œ-BeanDefinition-æµç¨‹" class="headerlink" title="2.2 æ³¨å†Œ BeanDefinition æµç¨‹"></a>2.2 æ³¨å†Œ BeanDefinition æµç¨‹</h2><p>è¿™åˆ°è¿™é‡Œï¼Œå°±å·²ç»å°†å®šä¹‰çš„ <code>Bean</code> èµ„æºæ–‡ä»¶ï¼Œè½½å…¥å¹¶è½¬æ¢ä¸º <code>Document</code> å¯¹è±¡äº†ã€‚</p><p>é‚£ä¹ˆï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¦‚ä½•å°†å…¶è§£æä¸º <code>SpringIoC</code> ç®¡ç†çš„ <code>BeanDefinition</code> å¯¹è±¡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹ç”±æ–¹æ³• <code>#registerBeanDefinitions(Document doc, Resource resource)</code> æ–¹æ³•æ¥å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"><span class="comment">// åˆ›å»º BeanDefinitionDocumentReader å¯¹è±¡</span></span><br><span class="line">BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line"><span class="comment">// è·å–å·²æ³¨å†Œçš„ BeanDefinition æ•°é‡</span></span><br><span class="line"><span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line"><span class="comment">// åˆ›å»º XmlReaderContext å¯¹è±¡</span></span><br><span class="line"><span class="comment">// æ³¨å†Œ BeanDefinition</span></span><br><span class="line">documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line"><span class="comment">// è®¡ç®—æ–°æ³¨å†Œçš„ BeanDefinition æ•°é‡</span></span><br><span class="line"><span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆï¼Œåˆ›å»º <code>BeanDefinition</code> çš„è§£æå™¨ <code>BeanDefinitionDocumentReader</code> ã€‚</p></li><li><p>ç„¶åï¼Œè°ƒç”¨è¯¥ <code>BeanDefinitionDocumentReader</code> çš„ <code>#registerBeanDefinitions(Document doc, XmlReaderContext readerContext)</code> æ–¹æ³•ï¼Œå¼€å¯è§£æè¿‡ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å§”æ´¾æ¨¡å¼ï¼Œå…·ä½“çš„å®ç°ç”±å­ç±» <code>DefaultBeanDefinitionDocumentReader</code> å®Œæˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readerContext = readerContext;</span><br><span class="line">    <span class="comment">// è·å¾— XML Document Root Element</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ³¨å†Œ BeanDefinition</span></span><br><span class="line">    doRegisterBeanDefinitions(doc.getDocumentElement());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-2-1-å¯¹-Document-å¯¹è±¡çš„è§£æ"><a href="#2-2-1-å¯¹-Document-å¯¹è±¡çš„è§£æ" class="headerlink" title="2.2.1 å¯¹ Document å¯¹è±¡çš„è§£æ"></a>2.2.1 å¯¹ Document å¯¹è±¡çš„è§£æ</h3><p>ä» <code>Document</code> å¯¹è±¡ä¸­è·å–æ ¹å…ƒç´  <code>root</code>ï¼Œç„¶åè°ƒç”¨ ``#doRegisterBeanDefinitions(Element root)` æ–¹æ³•ï¼Œå¼€å¯çœŸæ­£çš„è§£æè¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç ï¼ˆéæ ¸å¿ƒï¼‰</span></span><br><span class="line">    <span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå‰å¤„ç†</span></span><br><span class="line">    preProcessXml(root);</span><br><span class="line">    <span class="comment">// è§£æ</span></span><br><span class="line">    parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">    <span class="comment">// è§£æåå¤„ç†</span></span><br><span class="line">    postProcessXml(root);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>#preProcessXml(Element root)</code>ã€<code>#postProcessXml(Element root)</code> ä¸ºå‰ç½®ã€åç½®å¢å¼ºå¤„ç†ï¼Œç›®å‰ Spring ä¸­éƒ½æ˜¯ç©ºå®ç°ã€‚</p></li><li><p><code>#parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate)</code> æ˜¯å¯¹æ ¹å…ƒç´  root çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ ¹èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œé»˜è®¤è§£æ</span></span><br><span class="line">    <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">        <span class="comment">// éå†å­èŠ‚ç‚¹</span></span><br><span class="line">        NodeList nl = root.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            Node node = nl.item(i);</span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">                Element ele = (Element) node;</span><br><span class="line">                <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œé»˜è®¤è§£æ</span></span><br><span class="line">                <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                    parseDefaultElement(ele, delegate);</span><br><span class="line">                <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹éé»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œè‡ªå®šä¹‰è§£æ</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    delegate.parseCustomElement(ele);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ ¹èŠ‚ç‚¹éé»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œè‡ªå®šä¹‰è§£æ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        delegate.parseCustomElement(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿­ä»£ root å…ƒç´ çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼š<ul><li>è‹¥èŠ‚ç‚¹ä¸ºé»˜è®¤å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ <code>#parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate)</code> æ–¹æ³•ï¼Œå¼€å¯é»˜è®¤æ ‡ç­¾çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚</li><li>å¦åˆ™ï¼Œè°ƒç”¨ <code>BeanDefinitionParserDelegate#parseCustomElement(Element ele)</code> æ–¹æ³•ï¼Œå¼€å¯è‡ªå®šä¹‰æ ‡ç­¾çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚</li></ul></li></ul></li></ul><h4 id="2-2-1-1-é»˜è®¤æ ‡ç­¾è§£æ"><a href="#2-2-1-1-é»˜è®¤æ ‡ç­¾è§£æ" class="headerlink" title="2.2.1.1 é»˜è®¤æ ‡ç­¾è§£æ"></a>2.2.1.1 é»˜è®¤æ ‡ç­¾è§£æ</h4><p>è‹¥å®šä¹‰çš„å…ƒç´ èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯ <code>Spring</code> é»˜è®¤å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ <code>#parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate)</code> æ–¹æ³•ï¼Œè¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123; <span class="comment">// import</span></span><br><span class="line">importBeanDefinitionResource(ele);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123; <span class="comment">// alias</span></span><br><span class="line">processAliasRegistration(ele);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123; <span class="comment">// bean</span></span><br><span class="line">processBeanDefinition(ele, delegate);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123; <span class="comment">// beans</span></span><br><span class="line"><span class="comment">// recurse</span></span><br><span class="line">doRegisterBeanDefinitions(ele);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹å››å¤§æ ‡ç­¾ï¼š<code>import</code>ã€<code>alias</code>ã€<code>bean</code>ã€<code>beans</code>è¿›è¡Œè§£æã€‚<strong>å…¶ä¸­ <code>bean</code> æ ‡ç­¾çš„è§£æä¸ºæ ¸å¿ƒå·¥ä½œ</strong>ã€‚</p><h4 id="2-2-1-2-è‡ªå®šä¹‰æ ‡ç­¾è§£æ"><a href="#2-2-1-2-è‡ªå®šä¹‰æ ‡ç­¾è§£æ" class="headerlink" title="2.2.1.2 è‡ªå®šä¹‰æ ‡ç­¾è§£æ"></a>2.2.1.2 è‡ªå®šä¹‰æ ‡ç­¾è§£æ</h4><p>å¯¹äºé»˜è®¤æ ‡ç­¾åˆ™ç”± <code>parseCustomElement(Element ele)</code> æ–¹æ³•ï¼Œè´Ÿè´£è§£æã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parseCustomElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="meta">@Nullable</span> BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å– namespaceUri</span></span><br><span class="line">    String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">    <span class="keyword">if</span> (namespaceUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ® namespaceUri è·å–ç›¸åº”çš„ Handler</span></span><br><span class="line">    NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        error(<span class="string">&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot;</span> + namespaceUri + <span class="string">&quot;]&quot;</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒç”¨è‡ªå®šä¹‰çš„ Handler å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–èŠ‚ç‚¹çš„ <code>namespaceUri</code>ï¼Œç„¶åæ ¹æ®è¯¥ <code>namespaceUri</code> è·å–ç›¸å¯¹åº”çš„ <code>NamespaceHandler</code>ï¼Œæœ€åè°ƒç”¨ <code>NamespaceHandler</code> çš„ <code>#parse(Element element, ParserContext parserContext)</code> æ–¹æ³•ï¼Œ<code>å³å®Œæˆè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æå’Œæ³¨å…¥</code>ã€‚</p><h3 id="2-2-2-æ³¨å†Œ-BeanDefinition"><a href="#2-2-2-æ³¨å†Œ-BeanDefinition" class="headerlink" title="2.2.2 æ³¨å†Œ BeanDefinition"></a>2.2.2 æ³¨å†Œ BeanDefinition</h3><p>ç»è¿‡ä¸Šé¢çš„è§£æï¼Œåˆ™å°† <code>Document</code> å¯¹è±¡é‡Œé¢çš„ <code>Bean</code> æ ‡ç­¾è§£ææˆäº†ä¸€ä¸ªä¸ªçš„ <code>BeanDefinition</code> ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯å°†è¿™äº› <code>BeanDefinition</code> æ³¨å†Œåˆ° <code>IoC</code> å®¹å™¨ä¸­ã€‚åŠ¨ä½œçš„è§¦å‘æ˜¯åœ¨è§£æ <code>Bean</code> æ ‡ç­¾å®Œæˆåï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                     BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œ bean å…ƒç´ è§£æã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœè§£ææˆåŠŸï¼Œåˆ™è¿”å› BeanDefinitionHolder å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment">// è€Œ BeanDefinitionHolder ä¸º name å’Œ alias çš„ BeanDefinition å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™è¿”å› null ã€‚</span></span><br><span class="line">    BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">    <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾å¤„ç†</span></span><br><span class="line">        bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¿›è¡Œ BeanDefinition çš„æ³¨å†Œ</span></span><br><span class="line">            <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, </span><br><span class="line">                                                     getReaderContext().getRegistry());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +</span><br><span class="line">                    bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‘å‡ºå“åº”äº‹ä»¶ï¼Œé€šçŸ¥ç›¸å…³çš„ç›‘å¬å™¨ï¼Œå·²å®Œæˆè¯¥ Bean æ ‡ç­¾çš„è§£æã€‚</span></span><br><span class="line">        <span class="comment">// Send registration event.</span></span><br><span class="line">        getReaderContext().fireComponentRegistered(</span><br><span class="line">          <span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>BeanDefinitionReaderUtils.registerBeanDefinition()</code> æ–¹æ³•ï¼Œæ¥æ³¨å†Œã€‚</p><p>å…¶å®ï¼Œè¿™é‡Œé¢ä¹Ÿæ˜¯è°ƒç”¨ <code>BeanDefinitionRegistry</code> çš„ <code>#registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</code> æ–¹æ³•ï¼Œæ¥æ³¨å†Œ <code>BeanDefinition</code> ã€‚</p><p>ä¸è¿‡ï¼Œæœ€ç»ˆçš„å®ç°æ˜¯åœ¨ <code>DefaultListableBeanFactory</code> ä¸­å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultListableBeanFactory.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="comment">// ...çœç•¥æ ¡éªŒç›¸å…³çš„ä»£ç </span></span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­è·å–æŒ‡å®š beanName çš„ BeanDefinition</span></span><br><span class="line">    BeanDefinition existingDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨ä½†æ˜¯ä¸å…è®¸è¦†ç›–ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionOverrideException(beanName, </span><br><span class="line">                                              beanDefinition,existingDefinition);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// ...çœç•¥ logger æ‰“å°æ—¥å¿—ç›¸å…³çš„ä»£ç </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€é‡ç‚¹ã€‘å…è®¸è¦†ç›–ï¼Œç›´æ¥è¦†ç›–åŸæœ‰çš„ BeanDefinition åˆ° beanDefinitionMap ä¸­ã€‚</span></span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">    <span class="comment">// å¦‚æœæœªå­˜åœ¨</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ... çœç•¥éæ ¸å¿ƒçš„ä»£ç </span></span><br><span class="line">        <span class="comment">// ã€é‡ç‚¹ã€‘æ·»åŠ åˆ° BeanDefinition åˆ° beanDefinitionMap ä¸­ã€‚</span></span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½® beanName å¯¹åº”çš„ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">        resetBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™æ®µä»£ç æœ€æ ¸å¿ƒçš„éƒ¨åˆ†æ˜¯è¿™å¥ <code>this.beanDefinitionMap.put(beanName, beanDefinition)</code> ä»£ç æ®µã€‚æ‰€ä»¥ï¼Œæ³¨å†Œè¿‡ç¨‹ä¹Ÿä¸æ˜¯é‚£ä¹ˆçš„é«˜å¤§ä¸Šï¼Œå°±æ˜¯åˆ©ç”¨ä¸€ä¸ª Map çš„é›†åˆå¯¹è±¡æ¥å­˜æ”¾ï¼š<code>key</code> æ˜¯ <code>beanName</code>ï¼Œ<code>value</code> æ˜¯ <code>BeanDefinition</code> å¯¹è±¡ã€‚</li></ul></li></ul><h1 id="3-å°ç»“"><a href="#3-å°ç»“" class="headerlink" title="3. å°ç»“"></a>3. å°ç»“</h1><p>è‡³æ­¤ï¼Œæ•´ä¸ª <code>IoC</code> çš„åˆå§‹åŒ–è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†ï¼Œä» <code>Bean</code> èµ„æºçš„å®šä½ï¼Œè½¬æ¢ä¸º <code>Document</code> å¯¹è±¡ï¼Œæ¥ç€å¯¹å…¶è¿›è¡Œè§£æï¼Œæœ€åæ³¨å†Œåˆ° <code>IoC</code> å®¹å™¨ä¸­ï¼Œéƒ½å·²ç»å®Œç¾åœ°å®Œæˆäº†ã€‚</p><p>ç°åœ¨ <code>IoC</code> å®¹å™¨ä¸­å·²ç»å»ºç«‹äº†æ•´ä¸ª <code>Bean</code> çš„é…ç½®ä¿¡æ¯ï¼Œè¿™äº› <code>Bean</code> å¯ä»¥è¢«æ£€ç´¢ã€ä½¿ç”¨ã€ç»´æŠ¤ï¼Œä»–ä»¬æ˜¯æ§åˆ¶åè½¬çš„åŸºç¡€ï¼Œæ˜¯åé¢æ³¨å…¥ <code>Bean</code> çš„ä¾èµ–ã€‚æœ€åç”¨ä¸€å¼ æµç¨‹å›¾æ¥ç»“æŸè¿™ç¯‡æ€»ç»“ä¹‹æ–‡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/vRTCJi.jpg" alt="vRTCJi"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹æ³¨å†Œè§£æçš„BeanDefinitions</title>
      <link href="/blog/2020/01/13/a9bec556.html"/>
      <url>/blog/2020/01/13/a9bec556.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2763">http://cmsblogs.com/?p=2763</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p><code>DefaultBeanDefinitionDocumentReader.processBeanDefinition()</code> å®Œæˆ <code>Bean</code> æ ‡ç­¾è§£æçš„æ ¸å¿ƒå·¥ä½œï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                     BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder,</span><br><span class="line">                                                       getReaderContext().getRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> </span><br><span class="line">                               +</span><br><span class="line">                               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Send registration event.</span></span><br><span class="line">    getReaderContext().fireComponentRegistered(</span><br><span class="line">      <span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æå·¥ä½œåˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>è§£æé»˜è®¤æ ‡ç­¾ï¼›</li><li>è§£æé»˜è®¤æ ‡ç­¾åä¸‹å¾—è‡ªå®šä¹‰æ ‡ç­¾ï¼›</li><li>æ³¨å†Œè§£æåçš„ <code>BeanDefinition</code>ã€‚</li></ol><p>ç»è¿‡å‰é¢ä¸¤ä¸ªæ­¥éª¤çš„è§£æï¼Œè¿™æ—¶çš„ <code>BeanDefinition</code> å·²ç»å¯ä»¥æ»¡è¶³åç»­çš„ä½¿ç”¨è¦æ±‚äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„å·¥ä½œå°±æ˜¯å°†è¿™äº› <code>BeanDefinition</code> è¿›è¡Œæ³¨å†Œï¼Œä¹Ÿå°±æ˜¯å®Œæˆç¬¬ä¸‰æ­¥ã€‚ æ³¨å†Œ <code>BeanDefinition</code> ç”± <code>BeanDefinitionReaderUtils.registerBeanDefinition()</code> å®Œæˆã€‚</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œ beanName</span></span><br><span class="line">  String beanName = definitionHolder.getBeanName();</span><br><span class="line">  registry.registerBeanDefinition(beanName, </span><br><span class="line">                                  definitionHolder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œ alias </span></span><br><span class="line">  String[] aliases = definitionHolder.getAliases();</span><br><span class="line">  <span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String alias : aliases) &#123;</span><br><span class="line">      registry.registerAlias(beanName, alias);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆé€šè¿‡ <code>beanName</code> æ³¨å†Œ <code>BeanDefinition</code> ï¼Œ</li><li>ç„¶åå†æ³¨å†Œåˆ«å <code>alias</code>ã€‚</li></ul><blockquote><p><code>BeanDefinition</code> çš„æ³¨å†Œç”±æ¥å£ <code>BeanDefinitionRegistry</code> å®šä¹‰ã€‚ </p></blockquote><p><strong>é€šè¿‡ beanName æ³¨å†Œ</strong> <code>BeanDefinitionRegistry.registerBeanDefinition()</code> å®ç°é€šè¿‡ <code>beanName</code> æ³¨å†Œ <code>BeanDefinition</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, </span></span></span><br><span class="line"><span class="function"><span class="params">                                   BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¡éªŒ beanName ä¸ beanDefinition</span></span><br><span class="line">  Assert.hasText(beanName, <span class="string">&quot;Bean name must not be empty&quot;</span>);</span><br><span class="line">  Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ ¡éªŒ BeanDefinition</span></span><br><span class="line">      <span class="comment">// è¿™æ˜¯æ³¨å†Œå‰çš„æœ€åä¸€æ¬¡æ ¡éªŒäº†ï¼Œä¸»è¦æ˜¯å¯¹å±æ€§ methodOverrides è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">      ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">        beanDefinition.getResourceDescription(), </span><br><span class="line">        beanName,<span class="string">&quot;Validation of bean definition failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BeanDefinition oldBeanDefinition;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»ç¼“å­˜ä¸­è·å–æŒ‡å®š beanName çš„ BeanDefinition</span></span><br><span class="line">  oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœå­˜åœ¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ä½†æ˜¯ä¸å…è®¸è¦†ç›–ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">        beanDefinition.getResourceDescription(), </span><br><span class="line">        beanName,</span><br><span class="line">        <span class="string">&quot;Cannot register bean definition [&quot;</span> </span><br><span class="line">        + beanDefinition + <span class="string">&quot;] for bean &#x27;&quot;</span> </span><br><span class="line">        + beanName +</span><br><span class="line">        <span class="string">&quot;&#x27;: There is already [&quot;</span> + oldBeanDefinition + <span class="string">&quot;] bound.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">      <span class="comment">// e.g. was ROLE_APPLICATION, </span></span><br><span class="line">      <span class="comment">// now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.warn(</span><br><span class="line">          <span class="string">&quot;Overriding user-defined bean definition for bean &#x27;&quot;</span> </span><br><span class="line">          + beanName </span><br><span class="line">          + <span class="string">&quot;&#x27; with a framework-generated bean definition: replacing [&quot;</span> </span><br><span class="line">          + oldBeanDefinition + <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¦†ç›– beanDefinition ä¸ è¢«è¦†ç›–çš„ beanDefinition ä¸æ˜¯åŒç±»</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.info(</span><br><span class="line">          <span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> </span><br><span class="line">          + beanName </span><br><span class="line">          + <span class="string">&quot;&#x27; with a different definition: replacing [&quot;</span> </span><br><span class="line">          + oldBeanDefinition </span><br><span class="line">          + <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.debug(</span><br><span class="line">          <span class="string">&quot;Overriding bean definition for bean &#x27;&quot;</span> </span><br><span class="line">          + beanName </span><br><span class="line">          + <span class="string">&quot;&#x27; with an equivalent definition: replacing [&quot;</span> </span><br><span class="line">          + oldBeanDefinition </span><br><span class="line">          + <span class="string">&quot;] with [&quot;</span> + beanDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸è¦†ç›–ï¼Œç›´æ¥è¦†ç›–åŸæœ‰çš„ BeanDefinition</span></span><br><span class="line">    <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æµ‹åˆ›å»º Bean é˜¶æ®µæ˜¯å¦å·²ç»å¼€å¯ï¼Œå¦‚æœå¼€å¯äº†åˆ™éœ€è¦å¯¹ beanDefinitionMap è¿›è¡Œå¹¶å‘æ§åˆ¶</span></span><br><span class="line">    <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">      <span class="comment">// beanDefinitionMap ä¸ºå…¨å±€å˜é‡ï¼Œé¿å…å¹¶å‘æƒ…å†µ</span></span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">        List&lt;String&gt; updatedDefinitions = </span><br><span class="line">          <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">        updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">        updatedDefinitions.add(beanName);</span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">          Set&lt;String&gt; updatedSingletons = </span><br><span class="line">            <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.manualSingletonNames);</span><br><span class="line">          updatedSingletons.remove(beanName);</span><br><span class="line">          <span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸ä¼šå­˜åœ¨å¹¶å‘æƒ…å†µï¼Œç›´æ¥è®¾ç½®</span></span><br><span class="line">      <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">      <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">      <span class="keyword">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½® beanName å¯¹åº”çš„ç¼“å­˜</span></span><br><span class="line">    resetBeanDefinition(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆ <code>BeanDefinition</code> è¿›è¡Œæ ¡éªŒï¼Œè¯¥æ ¡éªŒä¹Ÿæ˜¯æ³¨å†Œè¿‡ç¨‹ä¸­çš„æœ€åä¸€æ¬¡æ ¡éªŒäº†ï¼Œä¸»è¦æ˜¯å¯¹ <code>AbstractBeanDefinition</code> çš„ <code>methodOverrides</code> å±æ€§è¿›è¡Œæ ¡éªŒ</li><li>æ ¹æ® <code>beanName</code> ä»ç¼“å­˜ä¸­è·å– <code>BeanDefinition</code>ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œåˆ™æ ¹æ® allowBeanDefinitionOverriding æ ‡å¿—æ¥åˆ¤æ–­æ˜¯å¦å…è®¸è¦†ç›–ï¼Œå¦‚æœå…è®¸åˆ™ç›´æ¥è¦†ç›–ï¼Œå¦åˆ™æŠ›å‡º BeanDefinitionStoreException å¼‚å¸¸</li><li>è‹¥ç¼“å­˜ä¸­æ²¡æœ‰æŒ‡å®š <code>beanName</code> çš„ <code>BeanDefinition</code>ï¼Œåˆ™åˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯å¦å·²ç»å¼€å§‹äº† <code>Bean</code> çš„åˆ›å»ºé˜¶æ®µ&lt;&gt;ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦å¯¹ <code>beanDefinitionMap</code> è¿›è¡ŒåŠ é”æ§åˆ¶å¹¶å‘é—®é¢˜ï¼Œå¦åˆ™ç›´æ¥è®¾ç½®å³å¯ã€‚å¯¹äº <code>hasBeanCreationStarted()</code> æ–¹æ³•åç»­åšè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œä¸è¿‡å¤šé˜è¿°ã€‚</li><li>è‹¥ç¼“å­˜ä¸­å­˜åœ¨è¯¥ <code>beanName</code> æˆ–è€… å•åˆ© <code>bean</code> é›†åˆä¸­å­˜åœ¨è¯¥ <code>beanName</code>ï¼Œåˆ™è°ƒç”¨ <code>resetBeanDefinition()</code> é‡ç½® <code>BeanDefinition</code> ç¼“å­˜ã€‚</li></ul><p>å…¶å®æ•´æ®µä»£ç çš„æ ¸å¿ƒå°±åœ¨äº <code>this.beanDefinitionMap.put(beanName, beanDefinition);</code> ã€‚</p><blockquote><p><code>BeanDefinition</code> çš„ç¼“å­˜ä¹Ÿä¸æ˜¯ç¥å¥‡çš„ä¸œè¥¿ï¼Œå°±æ˜¯å®šä¹‰ <code>map</code> ï¼Œ<code>key</code> ä¸º <code>beanName</code>ï¼Œ<code>value</code> ä¸º <code>BeanDefinition</code>ã€‚ </p></blockquote><p><strong>æ³¨å†Œ alias</strong> <code>BeanDefinitionRegistry.registerAlias</code> å®Œæˆ <code>alias</code> çš„æ³¨å†Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String name, String alias)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¡éªŒ name ã€ alias</span></span><br><span class="line">  Assert.hasText(name, <span class="string">&quot;&#x27;name&#x27; must not be empty&quot;</span>);</span><br><span class="line">  Assert.hasText(alias, <span class="string">&quot;&#x27;alias&#x27; must not be empty&quot;</span>);</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.aliasMap) &#123;</span><br><span class="line">    <span class="comment">// name == alias åˆ™å»æ‰alias</span></span><br><span class="line">    <span class="keyword">if</span> (alias.equals(name)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.aliasMap.remove(alias);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç¼“å­˜ç¼“å­˜è®°å½•</span></span><br><span class="line">      String registeredName = <span class="keyword">this</span>.aliasMap.get(alias);</span><br><span class="line">      <span class="keyword">if</span> (registeredName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸­çš„ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (registeredName.equals(name)) &#123;</span><br><span class="line">          <span class="comment">// An existing alias - no need to re-register</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸å…è®¸åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (!allowAliasOverriding()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;Cannot register alias &#x27;&quot;</span> + alias + <span class="string">&quot;&#x27; for name &#x27;&quot;</span> </span><br><span class="line">            + name + <span class="string">&quot;&#x27;: It is already registered for name &#x27;&quot;</span> </span><br><span class="line">            + registeredName + <span class="string">&quot;&#x27;.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å½“ A --&gt; B å­˜åœ¨æ—¶ï¼Œå¦‚æœå†æ¬¡å‡ºç° A --&gt; B --&gt; C åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      checkForAliasCircle(name, alias);</span><br><span class="line">      <span class="comment">// æ³¨å†Œ alias</span></span><br><span class="line">      <span class="keyword">this</span>.aliasMap.put(alias, name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œ <code>alias</code> å’Œæ³¨å†Œ <code>BeanDefinition</code> çš„è¿‡ç¨‹å·®ä¸å¤šã€‚åœ¨æœ€åè°ƒç”¨äº† <code>checkForAliasCircle()</code> æ¥å¯¹åˆ«åè¿›è¡Œäº†æ£€æµ‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasAlias</span><span class="params">(String name, String alias)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.aliasMap.entrySet()) &#123;</span><br><span class="line">    String registeredName = entry.getValue();</span><br><span class="line">    <span class="keyword">if</span> (registeredName.equals(name)) &#123;</span><br><span class="line">      String registeredAlias = entry.getKey();</span><br><span class="line">      <span class="keyword">return</span> (registeredAlias.equals(alias) || hasAlias(registeredAlias, alias));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>name</code> ã€ <code>alias</code> ä¸º <strong>1</strong> ã€<strong>3</strong> ï¼Œåˆ™æ„æˆ <strong>ï¼ˆ1,3ï¼‰</strong>ï¼ŒåŠ å…¥é›†åˆä¸­å­˜åœ¨<strong>ï¼ˆA,1ï¼‰</strong>ã€<strong>ï¼ˆ3,Aï¼‰</strong>çš„æƒ…å†µåˆ™ä¼šå‡ºé”™ã€‚ åˆ°è¿™é‡Œ <code>BeanDefinition</code>ã€<code>alias</code> éƒ½å·²ç»æ³¨å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯ç­‰å¾…åˆå§‹åŒ–ä½¿ç”¨äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹è§£æbeanæ ‡ç­¾ï¼šè§£æè‡ªå®šä¹‰æ ‡ç­¾</title>
      <link href="/blog/2020/01/12/61e43345.html"/>
      <url>/blog/2020/01/12/61e43345.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2841">http://cmsblogs.com/?p=2841</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>è·å– <code>Document</code> å¯¹è±¡åï¼Œä¼šæ ¹æ®è¯¥å¯¹è±¡å’Œ <code>Resource</code> èµ„æºå¯¹è±¡è°ƒç”¨ <code>registerBeanDefinitions()</code> æ–¹æ³•ï¼Œå¼€å§‹æ³¨å†Œ <code>BeanDefinitions</code> ä¹‹æ—…ã€‚åœ¨æ³¨å†Œ <code>BeanDefinitions</code> è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>parseBeanDefinitions()</code> å¼€å¯ <code>BeanDefinition</code> çš„è§£æè¿‡ç¨‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå®ƒä¼šæ ¹æ®å‘½åç©ºé—´çš„ä¸åŒè°ƒç”¨ä¸åŒçš„æ–¹æ³•è¿›è¡Œè§£æï¼Œå¦‚æœæ˜¯é»˜è®¤çš„å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ <code>parseDefaultElement()</code> è¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æï¼Œå¦åˆ™è°ƒç”¨ <code>parseCustomElement()</code> æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾è§£æã€‚</p><h2 id="ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾"><a href="#ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾"></a>ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾</h2><p>æ‰©å±• <code>Spring</code> è‡ªå®šä¹‰æ ‡ç­¾é…ç½®ä¸€èˆ¬éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªéœ€è¦æ‰©å±•çš„ç»„ä»¶</li><li>å®šä¹‰ä¸€ä¸ª <code>XSD</code> æ–‡ä»¶ï¼Œç”¨äºæè¿°ç»„ä»¶å†…å®¹</li><li>åˆ›å»ºä¸€ä¸ªå®ç° <code>AbstractSingleBeanDefinitionParser</code> æ¥å£çš„ç±»ï¼Œç”¨æ¥è§£æ <code>XSD</code> æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œç»„ä»¶å®šä¹‰</li><li>åˆ›å»ºä¸€ä¸ª <code>Handler</code>ï¼Œç»§æ‰¿ <code>NamespaceHandlerSupport</code> ï¼Œç”¨äºå°†ç»„ä»¶æ³¨å†Œåˆ° Spring å®¹å™¨</li><li>ç¼–å†™ <code>Spring.handlers</code> å’Œ <code>Spring.schemas</code> æ–‡ä»¶</li></ol><p>ä¸‹é¢å°±æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ ‡ç­¾ç»„ä»¶ã€‚ <strong>åˆ›å»ºç»„ä»¶</strong> è¯¥ç»„ä»¶å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ <code>JavaBean</code>ï¼Œæ²¡æœ‰ä»»ä½•ç‰¹åˆ«ä¹‹å¤„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰-XSD-æ–‡ä»¶"><a href="#å®šä¹‰-XSD-æ–‡ä»¶" class="headerlink" title="å®šä¹‰ XSD æ–‡ä»¶"></a>å®šä¹‰ XSD æ–‡ä»¶</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">xmlns</span>=<span class="string">&quot;http://www.cmsblogs.com/schema/user&quot;</span> <span class="attr">targetNamespace</span>=<span class="string">&quot;http://www.cmsblogs.com/schema/user&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">elementFormDefault</span>=<span class="string">&quot;qualified&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xsd:string&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xsd:string&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">type</span>=<span class="string">&quot;xsd:string&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢é™¤äº†å¯¹ <code>User</code> è¿™ä¸ª <code>JavaBean</code> è¿›è¡Œäº†æè¿°å¤–ï¼Œè¿˜å®šä¹‰äº† <code>xmlns=&quot;http://www.cmsblogs.com/schema/user&quot; targetNamespace=&quot;http://www.cmsblogs.com/schema/user&quot;</code> è¿™ä¸¤ä¸ªå€¼ï¼Œè¿™ä¸¤ä¸ªå€¼åœ¨åé¢æ˜¯æœ‰å¤§ä½œç”¨çš„ã€‚</p><h4 id="Parser-ç±»"><a href="#Parser-ç±»" class="headerlink" title="Parser ç±»"></a>Parser ç±»</h4><p>å®šä¹‰ä¸€ä¸ª <code>Parser</code> ç±»ï¼Œè¯¥ç±»ç»§æ‰¿ <code>AbstractSingleBeanDefinitionParser</code> ï¼Œå¹¶å®ç° <code>getBeanClass()</code> å’Œ <code>doParse()</code> ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸»è¦æ˜¯ç”¨äºè§£æ XSD æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œç»„ä»¶å®šä¹‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">        <span class="keyword">return</span> User.class;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        String id = element.getAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        String userName=element.getAttribute(<span class="string">&quot;userName&quot;</span>);</span><br><span class="line">        String email=element.getAttribute(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(id))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(userName))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;userName&quot;</span>, userName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(email))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;email&quot;</span>, email);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Handler-ç±»"><a href="#Handler-ç±»" class="headerlink" title="Handler ç±»"></a>Handler ç±»</h4><p>å®šä¹‰ Handler ç±»ï¼Œç»§æ‰¿ NamespaceHandlerSupport ,ä¸»è¦ç›®çš„æ˜¯å°†ç»„ä»¶æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">&quot;user&quot;</span>,<span class="keyword">new</span> UserDefinitionParser());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Spring-handlers"><a href="#Spring-handlers" class="headerlink" title="Spring.handlers"></a>Spring.handlers</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">http://www.cmsblogs.com/schema/user=org.springframework.core.customelement.UserNamespaceHandler</span><br></pre></td></tr></table></figure><h4 id="Spring-schemas"><a href="#Spring-schemas" class="headerlink" title="Spring.schemas"></a>Spring.schemas</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">http://www.cmsblogs.com/schema/user.xsd=user.xsd</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„æ ‡ç­¾äº†ã€‚åœ¨ <code>xml</code> é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:myTag</span>=<span class="string">&quot;http://www.cmsblogs.com/schema/user&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.cmsblogs.com/schema/user http://www.cmsblogs.com/schema/user.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">myTag:user</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">email</span>=<span class="string">&quot;12233445566@qq.com&quot;</span> <span class="attr">userName</span>=<span class="string">&quot;chenssy&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">  ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">  User user = (User) context.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">  System.out.println(user.getUserName() + <span class="string">&quot;----&quot;</span> + user.getEmail());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/OFykq0.jpg" alt="è¿è¡Œç»“æœ"></p><h2 id="è§£æè‡ªå®šä¹‰æ ‡ç­¾"><a href="#è§£æè‡ªå®šä¹‰æ ‡ç­¾" class="headerlink" title="è§£æè‡ªå®šä¹‰æ ‡ç­¾"></a>è§£æè‡ªå®šä¹‰æ ‡ç­¾</h2><p>ä¸Šé¢å·²ç»æ¼”ç¤ºäº† <code>Spring</code> è‡ªå®šä¹‰æ ‡ç­¾çš„ä½¿ç”¨ï¼Œä¸‹é¢å°±æ¥åˆ†æè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹ã€‚<code>DefaultBeanDefinitionDocumentReader.parseBeanDefinitions()</code> è´Ÿè´£æ ‡ç­¾çš„è§£æå·¥ä½œï¼Œå…¶ä¸­å®ƒæ ¹æ®å‘½åç©ºé—´çš„ä¸åŒè¿›è¡Œä¸åŒæ ‡ç­¾çš„è§£æï¼Œå…¶ä¸­è‡ªå®šä¹‰æ ‡ç­¾ç”± <code>delegate.parseCustomElement()</code> å®ç°ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> parseCustomElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>parseCustomElement()</code> æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="meta">@Nullable</span> BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å– namespaceUri</span></span><br><span class="line">  String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">  <span class="keyword">if</span> (namespaceUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ® namespaceUri è·å–ç›¸åº”çš„ Handler</span></span><br><span class="line">  NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">  <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">    error(<span class="string">&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot;</span> </span><br><span class="line">          + namespaceUri + <span class="string">&quot;]&quot;</span>, ele);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨è‡ªå®šä¹‰çš„ Handler å¤„ç†</span></span><br><span class="line">  <span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>è·å– <code>namespaceUri</code></li><li>æ ¹æ® <code>namespaceUri</code> è·å–ç›¸åº”çš„ <code>Handler</code></li><li>è°ƒç”¨è‡ªå®šä¹‰çš„ <code>Handler</code> å¤„ç†</li></ol><p>è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¾ˆç®€å•æ˜äº†ï¼Œæ ¹æ® namespaceUri è·å– Handlerï¼Œè¿™ä¸ªæ˜ å°„å…³ç³»æˆ‘ä»¬åœ¨ Spring.handlers ä¸­å·²ç»å®šä¹‰äº†ï¼Œæ‰€ä»¥åªéœ€è¦æ‰¾åˆ°è¯¥ç±»ï¼Œç„¶ååˆå§‹åŒ–è¿”å›ï¼Œæœ€åè°ƒç”¨è¯¥ Handler å¯¹è±¡çš„ <code>parse()</code> æ–¹æ³•å¤„ç†ï¼Œè¯¥æ–¹æ³•æˆ‘ä»¬ä¹Ÿæä¾›äº†å®ç°ã€‚æ‰€ä»¥ä¸Šé¢çš„æ ¸å¿ƒå°±åœ¨äºæ€ä¹ˆæ‰¾åˆ°è¯¥ Handler ç±»ã€‚è°ƒç”¨æ–¹æ³•ä¸ºï¼š<code>this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri)``getNamespaceHandlerResolver()</code> æ–¹æ³•è¿”å›çš„å‘½åç©ºé—´çš„è§£æå™¨ï¼Œè¯¥è§£æå®šä¹‰åœ¨ <code>XmlReaderContext</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> NamespaceHandlerResolver <span class="title">getNamespaceHandlerResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.namespaceHandlerResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç›´æ¥è¿”å›ï¼Œé‚£æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿ</p></blockquote><p>è¿™é‡Œéœ€è¦å›é€€åˆ°åšæ–‡ï¼š<a href="/2020/01/13/9de498cf.html">IoCä¹‹æ³¨å†ŒBeanDefinitions</a> ï¼Œåœ¨è¿™ç¯‡åšå®¢ä¸­æåˆ°åœ¨æ³¨å†Œ <code>BeanDefinition</code> æ—¶ï¼š</p><ul><li>é¦–å…ˆæ˜¯é€šè¿‡ <code>createBeanDefinitionDocumentReader()</code> è·å– <code>Document</code> è§£æå™¨ <code>BeanDefinitionDocumentReader</code> å®ä¾‹</li><li>ç„¶åè°ƒç”¨è¯¥å®ä¾‹ <code>registerBeanDefinitions()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œã€‚</li></ul><p><code>registerBeanDefinitions()</code>æ–¹æ³•éœ€è¦æä¾›ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯ <code>Document</code> å®ä¾‹ <code>doc</code></li><li>ä¸€ä¸ªæ˜¯ XmlReaderContext å®ä¾‹ readerContext</li></ul><p><code>readerContext</code> å®ä¾‹å¯¹è±¡ç”± <code>createReaderContext()</code> æ–¹æ³•æä¾›ã€‚<code>namespaceHandlerResolver</code> å®ä¾‹å¯¹è±¡å°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åˆå§‹åŒ–çš„ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> XmlReaderContext <span class="title">createReaderContext</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> XmlReaderContext(resource, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.eventListener,</span><br><span class="line">                              <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>, getNamespaceHandlerResolver());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>XmlReaderContext</code> æ„é€ å‡½æ•°ä¸­æœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯ <code>NamespaceHandlerResolver</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”± <code>getNamespaceHandlerResolver()</code> æä¾›ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> NamespaceHandlerResolver <span class="title">getNamespaceHandlerResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.namespaceHandlerResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.namespaceHandlerResolver = createDefaultNamespaceHandlerResolver();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.namespaceHandlerResolver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> NamespaceHandlerResolver <span class="title">createDefaultNamespaceHandlerResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ClassLoader cl = (getResourceLoader() != </span><br><span class="line">                    <span class="keyword">null</span> ? getResourceLoader().getClassLoader() : getBeanClassLoader());</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DefaultNamespaceHandlerResolver(cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>getNamespaceHandlerResolver().resolve(namespaceUri)</code> è°ƒç”¨çš„å°±æ˜¯ <code>DefaultNamespaceHandlerResolver</code> çš„ <code>resolve()</code>ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> NamespaceHandler <span class="title">resolve</span><span class="params">(String namespaceUri)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–æ‰€æœ‰å·²ç»é…ç½®çš„ Handler æ˜ å°„</span></span><br><span class="line">  Map&lt;String, Object&gt; handlerMappings = getHandlerMappings();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ® namespaceUri è·å– handlerçš„ä¿¡æ¯ï¼šè¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ç±»è·¯å¾„</span></span><br><span class="line">  Object handlerOrClassName = handlerMappings.get(namespaceUri);</span><br><span class="line">  <span class="keyword">if</span> (handlerOrClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (handlerOrClassName <span class="keyword">instanceof</span> NamespaceHandler) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»åšè¿‡è§£æï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> (NamespaceHandler) handlerOrClassName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    String className = (String) handlerOrClassName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">      Class&lt;?&gt; handlerClass = ClassUtils.forName(className, <span class="keyword">this</span>.classLoader);</span><br><span class="line">      <span class="keyword">if</span> (!NamespaceHandler.class.isAssignableFrom(handlerClass)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FatalBeanException(<span class="string">&quot;Class [&quot;</span> </span><br><span class="line">                                     + className + <span class="string">&quot;] for namespace [&quot;</span> + namespaceUri +</span><br><span class="line">                                     <span class="string">&quot;] does not implement the [&quot;</span> </span><br><span class="line">                                     + NamespaceHandler.class.getName() + <span class="string">&quot;] interface&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ç±»</span></span><br><span class="line">      NamespaceHandler namespaceHandler = </span><br><span class="line">        (NamespaceHandler) BeanUtils.instantiateClass(handlerClass);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è°ƒç”¨ init() æ–¹æ³•</span></span><br><span class="line">      namespaceHandler.init();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®°å½•åœ¨ç¼“å­˜</span></span><br><span class="line">      handlerMappings.put(namespaceUri, namespaceHandler);</span><br><span class="line">      <span class="keyword">return</span> namespaceHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FatalBeanException(<span class="string">&quot;Could not find NamespaceHandler class [&quot;</span> </span><br><span class="line">                                   + className +</span><br><span class="line">                                   <span class="string">&quot;] for namespace [&quot;</span> </span><br><span class="line">                                   + namespaceUri + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (LinkageError err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FatalBeanException(</span><br><span class="line">        <span class="string">&quot;Unresolvable class definition for NamespaceHandler class [&quot;</span> </span><br><span class="line">                                   +</span><br><span class="line">                                   className </span><br><span class="line">                                   + <span class="string">&quot;] for namespace [&quot;</span> </span><br><span class="line">                                   + namespaceUri + <span class="string">&quot;]&quot;</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨ <code>getHandlerMappings()</code> è·å–æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„æ˜ å°„å…³ç³» <code>handlerMappings</code> ï¼Œè¯¥å…³ç³»ä¸º &lt;å‘½åç©ºé—´,ç±»è·¯å¾„&gt;ï¼Œç„¶åæ ¹æ®å‘½åç©ºé—´ <code>namespaceUri</code> ä»æ˜ å°„å…³ç³»ä¸­è·å–ç›¸åº”çš„ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©ºæˆ–è€…å·²ç»åˆå§‹åŒ–äº†å°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ ¹æ®åå°„å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶è°ƒç”¨å…¶ <code>init()</code> æ–¹æ³•ï¼Œæœ€åå°†è¯¥ Handler å¯¹è±¡ç¼“å­˜ã€‚ <code>init()</code> æ–¹æ³•ä¸»è¦æ˜¯å°†è‡ªå®šä¹‰æ ‡ç­¾è§£æå™¨è¿›è¡Œæ³¨å†Œï¼Œå¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>init()</code> ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  registerBeanDefinitionParser(<span class="string">&quot;user&quot;</span>,<span class="keyword">new</span> UserDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„ <code>registerBeanDefinitionParser()</code> æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitionParser</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String elementName, BeanDefinitionParser parser)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.parsers.put(elementName, parser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯å°†æ˜ å°„å…³ç³»æ”¾åœ¨ä¸€ä¸ª <code>Map</code> ç»“æ„çš„ <code>parsers</code> å¯¹è±¡ä¸­ï¼š<code>private final Map parsers</code> ã€‚</p><p> å®Œæˆåè¿”å› <code>NamespaceHandler</code> å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ <code>parse()</code> æ–¹æ³•å¼€å§‹è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  BeanDefinitionParser parser = findParserForElement(element, parserContext);</span><br><span class="line">  <span class="keyword">return</span> (parser != <span class="keyword">null</span> ? parser.parse(element, parserContext) : <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>findParserForElement()</code> æ–¹æ³•è·å– <code>BeanDefinitionParser</code> å®ä¾‹ï¼Œå…¶å®å°±æ˜¯è·å–åœ¨ <code>init()</code> æ–¹æ³•é‡Œé¢æ³¨å†Œçš„å®ä¾‹å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BeanDefinitionParser <span class="title">findParserForElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  String localName = parserContext.getDelegate().getLocalName(element);</span><br><span class="line">  BeanDefinitionParser parser = <span class="keyword">this</span>.parsers.get(localName);</span><br><span class="line">  <span class="keyword">if</span> (parser == <span class="keyword">null</span>) &#123;</span><br><span class="line">    parserContext.getReaderContext().fatal(</span><br><span class="line">      <span class="string">&quot;Cannot locate BeanDefinitionParser for element [&quot;</span></span><br><span class="line">      + localName + <span class="string">&quot;]&quot;</span>, element);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> parser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è·å– <code>localName</code>ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å°±æ˜¯ ï¼š <code>user</code></li><li>ç„¶åä» <code>Map</code> å®ä¾‹ <code>parsers</code> ä¸­è·å– <code>BeanDefinitionParser</code> å¯¹è±¡ã€‚</li><li>è¿”å› <code>BeanDefinitionParser</code> å¯¹è±¡åï¼Œè°ƒç”¨å…¶ <code>parse()</code>ï¼Œè¯¥æ–¹æ³•åœ¨ <code>AbstractBeanDefinitionParser</code> ä¸­å®ç°ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> BeanDefinition <span class="title">parse</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  AbstractBeanDefinition definition = parseInternal(element, parserContext);</span><br><span class="line">  <span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String id = resolveId(element, definition, parserContext);</span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasText(id)) &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">          <span class="string">&quot;Id is required for element &#x27;&quot;</span> </span><br><span class="line">          + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">          + <span class="string">&quot;&#x27; when used as a top-level tag&quot;</span>, element);</span><br><span class="line">      &#125;</span><br><span class="line">      String[] aliases = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (shouldParseNameAsAliases()) &#123;</span><br><span class="line">        String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(name)) &#123;</span><br><span class="line">          aliases = StringUtils.trimArrayElements(</span><br><span class="line">            StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      BeanDefinitionHolder holder = <span class="keyword">new</span> BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">      registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">      <span class="keyword">if</span> (shouldFireEvents()) &#123;</span><br><span class="line">        BeanComponentDefinition componentDefinition = </span><br><span class="line">          <span class="keyword">new</span> BeanComponentDefinition(holder);</span><br><span class="line">        postProcessComponentDefinition(componentDefinition);</span><br><span class="line">        parserContext.registerComponent(componentDefinition);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      String msg = ex.getMessage();</span><br><span class="line">      parserContext.getReaderContext().error((msg != <span class="keyword">null</span> ? </span><br><span class="line">                                              msg : ex.toString()), element);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒåœ¨æ–¹æ³• <code>parseInternal()</code> ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œä»¥ä¸ºè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ <code>AbstractBeanDefinition</code> å¯¹è±¡ï¼Œä»å‰é¢é»˜è®¤æ ‡ç­¾çš„è§£æå·¥ä½œä¸­æˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­è¯¥æ–¹æ³•å°±æ˜¯å°†æ ‡ç­¾è§£æä¸º <code>AbstractBeanDefinition</code> ï¼Œä¸”åç»­ä»£ç éƒ½æ˜¯å°† <code>AbstractBeanDefinition</code> è½¬æ¢ä¸º <code>BeanDefinitionHolder</code>ï¼Œæ‰€ä»¥çœŸæ­£çš„è§£æå·¥ä½œéƒ½äº¤ç”± <code>parseInternal()</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> AbstractBeanDefinition <span class="title">parseInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–</span></span><br><span class="line">  BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–çˆ¶ç±»å…ƒç´ </span></span><br><span class="line">  String parentName = getParentName(element);</span><br><span class="line">  <span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–è‡ªå®šä¹‰æ ‡ç­¾ä¸­çš„ classï¼Œè¿™ä¸ªæ—¶å€™ä¼šå»è°ƒç”¨è‡ªå®šä¹‰è§£æä¸­çš„ getBeanClass()</span></span><br><span class="line">  Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">  <span class="keyword">if</span> (beanClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// beanClass ä¸º nullï¼Œæ„å‘³ç€å­ç±»å¹¶æ²¡æœ‰é‡å†™ getBeanClass() æ–¹æ³•ï¼Œ</span></span><br><span class="line">    <span class="comment">// åˆ™å°è¯•å»åˆ¤æ–­æ˜¯å¦é‡å†™äº† getBeanClassName()</span></span><br><span class="line">    String beanClassName = getBeanClassName(element);</span><br><span class="line">    <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span>) &#123;</span><br><span class="line">      builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">  BeanDefinition containingBd = parserContext.getContainingBeanDefinition();</span><br><span class="line">  <span class="keyword">if</span> (containingBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Inner bean definition must receive same scope as containing bean.</span></span><br><span class="line">    builder.setScope(containingBd.getScope());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">    <span class="comment">// Default-lazy-init applies to custom bean definitions as well.</span></span><br><span class="line">    builder.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨å­ç±»çš„ doParse() è¿›è¡Œè§£æ</span></span><br><span class="line">  doParse(element, parserContext, builder);</span><br><span class="line">  <span class="keyword">return</span> builder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥æ–¹æ³•ä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼š<code>getBeanClass()</code> ã€<code>doParse()</code>ã€‚å¯¹äº <code>getBeanClass()</code> æ–¹æ³•ï¼Œ<code>AbstractSingleBeanDefinitionParser</code> ç±»å¹¶æ²¡æœ‰æä¾›å…·ä½“å®ç°ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› <code>null</code>ï¼Œæ„å‘³ç€å®ƒå¸Œæœ›å­ç±»èƒ½å¤Ÿé‡å†™è¯¥æ–¹æ³•ï¼Œå½“ç„¶å¦‚æœæ²¡æœ‰é‡å†™è¯¥æ–¹æ³•ï¼Œè¿™ä¼šå»è°ƒç”¨ <code>getBeanClassName()</code> ï¼Œåˆ¤æ–­å­ç±»æ˜¯å¦å·²ç»é‡å†™äº†è¯¥æ–¹æ³•ã€‚å¯¹äº <code>doParse()</code> åˆ™æ˜¯ç›´æ¥ç©ºå®ç°ã€‚æ‰€ä»¥å¯¹äº <code>parseInternal()</code> è€Œè¨€å®ƒæ€»æ˜¯æœŸå¾…å®ƒçš„å­ç±»èƒ½å¤Ÿå®ç° <code>getBeanClass()</code>ã€<code>doParse()</code>ï¼Œå…¶ä¸­ <code>doParse()</code> å°¤ä¸ºé‡è¦ï¼Œå¦‚æœä½ ä¸æä¾›å®ç°ï¼Œæ€ä¹ˆæ¥è§£æè‡ªå®šä¹‰æ ‡ç­¾å‘¢ï¼Ÿæœ€åå°†è‡ªå®šä¹‰çš„è§£æå™¨ï¼š<code>UserDefinitionParser</code> å†æ¬¡å›è§‚ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">        <span class="keyword">return</span> User.class;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        String id = element.getAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        String userName=element.getAttribute(<span class="string">&quot;userName&quot;</span>);</span><br><span class="line">        String email=element.getAttribute(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(id))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(userName))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;userName&quot;</span>, userName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(email))&#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;email&quot;</span>, email);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹å·²ç»åˆ†æå®Œæˆäº†ã€‚å…¶å®æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯è¾ƒä¸ºç®€å•ï¼š</p><ol><li><p>é¦–å…ˆä¼šåŠ è½½ <code>handlers</code> æ–‡ä»¶ï¼Œå°†å…¶ä¸­å†…å®¹è¿›è¡Œä¸€ä¸ªè§£æï¼Œå½¢æˆ &lt;namespaceUri,ç±»è·¯å¾„&gt; è¿™æ ·çš„ä¸€ä¸ªæ˜ å°„</p></li><li><p>ç„¶åæ ¹æ®è·å–çš„ <code>namespaceUri</code> å°±å¯ä»¥å¾—åˆ°ç›¸åº”çš„ç±»è·¯å¾„ï¼Œå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ç­‰åˆ°ç›¸åº”çš„ Handler å¯¹è±¡</p></li><li><p>è°ƒç”¨ <code>parse()</code> æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ ¹æ®æ ‡ç­¾çš„ <code>localName</code> å¾—åˆ°ç›¸åº”çš„ <code>BeanDefinitionParser</code> å®ä¾‹å¯¹è±¡</p></li><li><p>è°ƒç”¨ <code>parse()</code> ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ AbstractBeanDefinitionParser æŠ½è±¡ç±»ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘å°è£…åœ¨å…¶ <code>parseInternal()</code> ä¸­ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª AbstractBeanDefinition å®ä¾‹å¯¹è±¡ï¼Œå…¶ä¸»è¦æ˜¯åœ¨ AbstractSingleBeanDefinitionParser ä¸­å®ç°ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ Parser ç±»ï¼Œå…¶éœ€è¦å®ç° <code>getBeanClass()</code> æˆ–è€… <code>getBeanClassName()</code> å’Œ <code>doParse()</code>ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/wyvMAV.jpg" alt="wyvMAV"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šconstructor-argã€propertyå­å…ƒç´ </title>
      <link href="/blog/2020/01/11/686a3d12.html"/>
      <url>/blog/2020/01/11/686a3d12.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2754">http://cmsblogs.com/?p=2754</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><h2 id="constructor-arg-å­å…ƒç´ "><a href="#constructor-arg-å­å…ƒç´ " class="headerlink" title="constructor-arg å­å…ƒç´ "></a>constructor-arg å­å…ƒç´ </h2><p>ä¸¾ä¸ªå°æ —å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    StudentService(String name, Integer age, BookService bookService)&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.bookService = bookService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.BookService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;chenssy&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;bookService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookService&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>StudentService</code> å®šä¹‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ <code>constructor-arg</code> å…ƒç´ å¯¹å…¶é…ç½®ï¼Œè¯¥å…ƒç´ å¯ä»¥å®ç°å¯¹ <code>StudentService</code> è‡ªåŠ¨å¯»æ‰¾å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¹¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°†å€¼å½“åšå‚æ•°è¿›è¡Œè®¾ç½®ã€‚<code>parseConstructorArgElements()</code> æ–¹æ³•å®Œæˆ <code>constructor-arg</code> å­å…ƒç´ çš„è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseConstructorArgElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  NodeList nl = beanEle.getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123;</span><br><span class="line">      parseConstructorArgElement((Element) node, bd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†æ‰€æœ‰å­å…ƒç´ ï¼Œå¦‚æœä¸º <code>constructor-arg</code> åˆ™è°ƒç”¨ <code>parseConstructorArgElement()</code> è¿›è¡Œè§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseConstructorArgElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æå– indexã€typeã€name å±æ€§å€¼</span></span><br><span class="line">  String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE);</span><br><span class="line">  String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">  String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰index</span></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.hasLength(indexAttr)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> index = Integer.parseInt(indexAttr);</span><br><span class="line">      <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error(<span class="string">&quot;&#x27;index&#x27; cannot be lower than 0&quot;</span>, ele);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// æ„é€ ä¸€ä¸ª ConstructorArgumentEntry å¹¶å°†å…¶åŠ å…¥åˆ° ParseState ä¸­</span></span><br><span class="line">          <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry(index));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// è§£æ ele å¯¹åº”å±æ€§å…ƒç´ </span></span><br><span class="line">          Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ ¹æ®è§£æçš„å±æ€§å…ƒç´ æ„é€ ä¸€ä¸ª valueHolder å¯¹è±¡</span></span><br><span class="line">          ConstructorArgumentValues.ValueHolder valueHolder = </span><br><span class="line">            <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">          <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">            valueHolder.setType(typeAttr);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">            valueHolder.setName(nameAttr);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          valueHolder.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// ä¸å…è®¸é‡å¤æŒ‡å®šç›¸åŒå‚æ•°</span></span><br><span class="line">          <span class="keyword">if</span> (bd.getConstructorArgumentValues()</span><br><span class="line">              .hasIndexedArgumentValue(index)) &#123;</span><br><span class="line">            error(<span class="string">&quot;Ambiguous constructor-arg entries for index &quot;</span> + index, ele);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åŠ å…¥åˆ° indexedArgumentValues ä¸­å›½</span></span><br><span class="line">            bd.getConstructorArgumentValues()</span><br><span class="line">              .addIndexedArgumentValue(index, valueHolder);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NumberFormatException ex) &#123;</span><br><span class="line">      error(<span class="string">&quot;Attribute &#x27;index&#x27; of tag &#x27;constructor-arg&#x27; must be an integer&quot;</span>, ele);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry());</span><br><span class="line">      Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">      ConstructorArgumentValues.ValueHolder valueHolder = </span><br><span class="line">        <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">        valueHolder.setType(typeAttr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">        valueHolder.setName(nameAttr);</span><br><span class="line">      &#125;</span><br><span class="line">      valueHolder.setSource(extractSource(ele));</span><br><span class="line">      bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å– <code>index</code>ã€<code>type</code>ã€<code>name</code> ä¸‰ä¸ªå±æ€§å€¼ï¼Œç„¶åæ ¹æ®æ˜¯å¦å­˜åœ¨ <code>index</code> æ¥åŒºåˆ†ã€‚</p><p>å…¶å®ä¸¤è€…é€»è¾‘éƒ½å·®ä¸å¤šï¼Œæ€»å…±åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ˆä»¥æœ‰ <code>index</code> ä¸ºä¾‹ï¼‰ï¼š</p><ol><li><p>æ„é€  <code>ConstructorArgumentEntry</code> å¯¹è±¡å¹¶å°†å…¶åŠ å…¥åˆ° <code>ParseState</code> é˜Ÿåˆ—ä¸­ã€‚</p><blockquote><p><code>ConstructorArgumentEntry</code> è¡¨ç¤ºæ„é€ å‡½æ•°çš„å‚æ•°ã€‚</p></blockquote></li><li><p>è°ƒç”¨ <code>parsePropertyValue()</code> è§£æ <code>constructor-arg</code> å­å…ƒç´ ï¼Œè¿”å›ç»“æœå€¼</p></li><li><p>æ ¹æ®è§£æçš„ç»“æœå€¼æ„é€  <code>ConstructorArgumentValues.ValueHolder</code> å®ä¾‹å¯¹è±¡</p></li><li><p>å°† <code>type</code>ã€<code>name</code> å°è£…åˆ° <code>ConstructorArgumentValues.ValueHolder</code> ä¸­ï¼Œç„¶åå°† <code>ValueHolder</code> å®ä¾‹å¯¹è±¡æ·»åŠ åˆ° <code>indexedArgumentValues</code> ä¸­ã€‚</p></li></ol><p>æ—  <code>index</code> çš„å¤„ç†é€»è¾‘å·®ä¸å¤šï¼Œåªæœ‰å‡ ç‚¹ä¸åŒï¼š</p><ul><li>æ„é€  ConstructorArgumentEntry å¯¹è±¡æ—¶æ˜¯è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼›</li><li>æœ€åæ˜¯å°† ValueHolder å®ä¾‹æ·»åŠ åˆ° genericArgumentValues ä¸­ã€‚</li><li> <code>parsePropertyValue()</code> å¯¹å­å…ƒç´ è¿›ä¸€æ­¥è§£æã€‚</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, <span class="meta">@Nullable</span> String propertyName)</span> </span>&#123;</span><br><span class="line">  String elementName = (propertyName != <span class="keyword">null</span>) ?</span><br><span class="line">    <span class="string">&quot;&lt;property&gt; element for property &#x27;&quot;</span> + propertyName + <span class="string">&quot;&#x27;&quot;</span> :</span><br><span class="line">  <span class="string">&quot;&lt;constructor-arg&gt; element&quot;</span>;</span><br><span class="line"></span><br><span class="line">  NodeList nl = ele.getChildNodes();</span><br><span class="line">  Element subElement = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="comment">// meta ã€description ä¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</span><br><span class="line">        !nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// Child element is what we&#x27;re looking for.</span></span><br><span class="line">      <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">        error(elementName + <span class="string">&quot; must not contain more than one sub-element&quot;</span>, ele);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        subElement = (Element) node;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ ref å…ƒç´ </span></span><br><span class="line">  <span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">  <span class="comment">// è§£æ value å…ƒç´ </span></span><br><span class="line">  <span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor-arg å­å…ƒç´ æœ‰ä¸¤ç§æƒ…å†µä¸å­˜åœ¨</span></span><br><span class="line">  <span class="comment">// 1. å³å­˜åœ¨ ref åˆå­˜åœ¨ value</span></span><br><span class="line">  <span class="comment">// 2. å­˜åœ¨ ref æˆ–è€… valueï¼Œä½†æ˜¯åˆæœ‰å­å…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</span><br><span class="line">      ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</span><br><span class="line">    error(elementName </span><br><span class="line">          +</span><br><span class="line">          <span class="string">&quot; is only allowed to contain either &#x27;ref&#x27; attribute OR &quot;</span> </span><br><span class="line">          + <span class="string">&quot; &#x27;value&#x27; attribute OR sub-element&quot;</span>, </span><br><span class="line">          ele);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">    <span class="comment">// è·å– ref å±æ€§å€¼</span></span><br><span class="line">    String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">      error(elementName + <span class="string">&quot; contains empty &#x27;ref&#x27; attribute&quot;</span>, ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°† ref å±æ€§å€¼æ„é€ ä¸º RuntimeBeanReference å®ä¾‹å¯¹è±¡</span></span><br><span class="line">    RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);</span><br><span class="line">    ref.setSource(extractSource(ele));</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (hasValueAttribute) &#123;</span><br><span class="line">    <span class="comment">// è§£æ value å±æ€§å€¼ï¼Œæ„é€  TypedStringValue å®ä¾‹å¯¹è±¡</span></span><br><span class="line">    TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(</span><br><span class="line">      ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">    valueHolder.setSource(extractSource(ele));</span><br><span class="line">    <span class="keyword">return</span> valueHolder;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è§£æå­å…ƒç´ </span></span><br><span class="line">    <span class="keyword">return</span> parsePropertySubElement(subElement, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Neither child element nor &quot;ref&quot; or &quot;value&quot; attribute found.</span></span><br><span class="line">    error(elementName + <span class="string">&quot; must specify a ref or value&quot;</span>, ele);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æå– <code>constructor-arg</code> å­å…ƒç´ çš„ <code>ref</code> å’Œ <code>value</code> çš„å±æ€§å€¼ï¼Œå¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»¥ä¸‹ä¸¤ç§æƒ…å†µæ˜¯ä¸å…è®¸å­˜åœ¨çš„<ul><li><code>ref</code> å’Œ <code>value</code> å±æ€§åŒæ—¶å­˜åœ¨</li><li>å­˜åœ¨ <code>ref</code> æˆ–è€… <code>value</code> ä¸”åˆæœ‰å­å…ƒç´ </li></ul></li><li>è‹¥å­˜åœ¨ <code>ref</code> å±æ€§ï¼Œåˆ™è·å–å…¶å€¼å¹¶å°†å…¶å°è£…è¿› <code>RuntimeBeanReference</code> å®ä¾‹å¯¹è±¡ä¸­</li><li>è‹¥å­˜åœ¨ <code>value</code> å±æ€§ï¼Œåˆ™è·å–å…¶å€¼å¹¶å°†å…¶å°è£…è¿› <code>TypedStringValue</code> å®ä¾‹å¯¹è±¡ä¸­</li><li>å¦‚æœå­å…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>parsePropertySubElement()</code> è¿›è¡Œå­å…ƒç´ è¿›ä¸€æ­¥å¤„ç†</li></ol><p>å¯¹äº <code>constructor-arg</code> å­å…ƒç´ çš„åµŒå¥—å­å…ƒç´ ï¼Œéœ€è¦è°ƒç”¨ <code>parsePropertySubElement()</code> è¿›ä¸€æ­¥å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, <span class="meta">@Nullable</span> BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> parsePropertySubElement(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element ele, <span class="meta">@Nullable</span> BeanDefinition bd, <span class="meta">@Nullable</span> String defaultValueType)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseNestedCustomElement(ele, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">    BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</span><br><span class="line">    <span class="keyword">if</span> (nestedBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">      nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nestedBd;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</span><br><span class="line">    <span class="comment">// A generic reference to any name of any bean.</span></span><br><span class="line">    String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">boolean</span> toParent = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">      <span class="comment">// A reference to the id of another bean in a parent context.</span></span><br><span class="line">      refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</span><br><span class="line">      toParent = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">        error(<span class="string">&quot;&#x27;bean&#x27; or &#x27;parent&#x27; is required for &lt;ref&gt; element&quot;</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">      error(<span class="string">&quot;&lt;ref&gt; element contains empty target attribute&quot;</span>, ele);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName, toParent);</span><br><span class="line">    ref.setSource(extractSource(ele));</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseIdRefElement(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseValueElement(ele, defaultValueType);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</span><br><span class="line">    <span class="comment">// It&#x27;s a distinguished null value. Let&#x27;s wrap it in a TypedStringValue</span></span><br><span class="line">    <span class="comment">// object in order to preserve the source location.</span></span><br><span class="line">    TypedStringValue nullHolder = <span class="keyword">new</span> TypedStringValue(<span class="keyword">null</span>);</span><br><span class="line">    nullHolder.setSource(extractSource(ele));</span><br><span class="line">    <span class="keyword">return</span> nullHolder;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseArrayElement(ele, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseListElement(ele, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseSetElement(ele, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseMapElement(ele, bd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</span><br><span class="line">    <span class="keyword">return</span> parsePropsElement(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    error(<span class="string">&quot;Unknown property sub-element: [&quot;</span> + ele.getNodeName() + <span class="string">&quot;]&quot;</span>, ele);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¯¹å„ä¸ªå­ç±»è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œè¯¦ç»†æƒ…å†µå¦‚æœå„ä½æœ‰å…´è¶£å¯ä»¥ç§»æ­¥æºç è¿›è¡Œæ·±ä¸€æ­¥çš„æ¢ç©¶ã€‚</p><h2 id="property-å­å…ƒç´ "><a href="#property-å­å…ƒç´ " class="headerlink" title="property å­å…ƒç´ "></a>property å­å…ƒç´ </h2><p>æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥ä½¿ç”¨ property å­å…ƒç´ ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;studentService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.service.StudentService&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;chenssy&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯¹äº <code>property</code> å­å…ƒç´ çš„è§£æï¼Œ<code>Spring</code> è°ƒç”¨ <code>parsePropertyElements()</code>ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  NodeList nl = beanEle.getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</span><br><span class="line">      parsePropertyElement((Element) node, bd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ <code>constructor-arg</code> å­å…ƒç´ å·®ä¸å¤šï¼ŒåŒæ ·æ˜¯æå–æ‰€æœ‰çš„ <code>property</code> çš„å­å…ƒç´ ï¼Œç„¶åè°ƒç”¨ <code>parsePropertyElement()</code> è¿›è¡Œåˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å– name å±æ€§</span></span><br><span class="line">  String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Tag &#x27;property&#x27; must have a &#x27;name&#x27; attribute&quot;</span>, ele);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ç›¸åŒçš„ name</span></span><br><span class="line">    <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Multiple &#x27;property&#x27; definitions for property &#x27;&quot;</span> </span><br><span class="line">            + propertyName + <span class="string">&quot;&#x27;&quot;</span>, ele);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå±æ€§å€¼</span></span><br><span class="line">    Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">    <span class="comment">// æ ¹æ®è§£æçš„å±æ€§å€¼æ„é€  PropertyValue å®ä¾‹å¯¹è±¡</span></span><br><span class="line">    PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">    parseMetaElements(ele, pv);</span><br><span class="line">    pv.setSource(extractSource(ele));</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ° MutablePropertyValues ä¸­</span></span><br><span class="line">    bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è§£æ <code>constructor-arg</code> å­å…ƒç´ æ­¥éª¤å·®ä¸å¤šã€‚è°ƒç”¨ <code>parsePropertyValue()</code> è§£æå­å…ƒç´ å±æ€§å€¼ï¼Œç„¶åæ ¹æ®è¯¥å€¼æ„é€  <code>PropertyValue</code> å®ä¾‹å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° <code>BeanDefinition</code> ä¸­çš„ <code>MutablePropertyValues</code> ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹è§£æbeanæ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method</title>
      <link href="/blog/2020/01/10/fa973ffe.html"/>
      <url>/blog/2020/01/10/fa973ffe.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2736">http://cmsblogs.com/?p=2736</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>åœ¨<a href="/2020/01/09/af1473fe.html"> IOC ä¹‹è§£æ Bean æ ‡ç­¾ï¼šBeanDefinition</a>ä¸­å·²ç»å®Œæˆäº†å¯¹ <code>Bean</code> æ ‡ç­¾å±æ€§çš„è§£æå·¥ä½œï¼Œè¿™ç¯‡åšæ–‡å¼€å§‹åˆ†æå­å…ƒç´ çš„è§£æã€‚</p><p>å®Œæˆ <code>Bean</code> æ ‡ç­¾åŸºæœ¬å±æ€§è§£æåï¼Œä¼šä¾æ¬¡è°ƒç”¨ <code>parseMetaElements()</code>ã€<code>parseLookupOverrideSubElements()</code>ã€<code>parseReplacedMethodSubElements()</code> å¯¹å­å…ƒç´  metaã€lookup-methodã€replace-method å®Œæˆè§£æã€‚ä¸‰ä¸ªå­å…ƒç´ çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><p><code>meta</code>ï¼šå…ƒæ•°æ®ã€‚</p></li><li><p><code>lookup-method</code>ï¼š<code>Spring</code> åŠ¨æ€æ”¹å˜ <code>bean</code> é‡Œæ–¹æ³•çš„å®ç°ã€‚</p><blockquote><p>æ–¹æ³•æ‰§è¡Œè¿”å›çš„å¯¹è±¡ï¼Œä½¿ç”¨ <code>Spring</code> å†…åŸæœ‰çš„è¿™ç±»å¯¹è±¡æ›¿æ¢ï¼Œé€šè¿‡æ”¹å˜æ–¹æ³•è¿”å›å€¼æ¥åŠ¨æ€æ”¹å˜æ–¹æ³•ã€‚å†…éƒ¨å®ç°ä¸ºä½¿ç”¨ <code>cglib</code> æ–¹æ³•ï¼Œé‡æ–°ç”Ÿæˆå­ç±»ï¼Œé‡å†™é…ç½®çš„æ–¹æ³•å’Œè¿”å›å¯¹è±¡ï¼Œè¾¾åˆ°åŠ¨æ€æ”¹å˜çš„æ•ˆæœã€‚</p></blockquote></li><li><p><code>replace-method</code>ï¼š<code>Spring</code> åŠ¨æ€æ”¹å˜ <code>bean</code> é‡Œæ–¹æ³•çš„å®ç°ã€‚</p><blockquote><p>éœ€è¦æ”¹å˜çš„æ–¹æ³•ï¼Œä½¿ç”¨ Spring å†…åŸæœ‰å…¶ä»–ç±»ï¼ˆéœ€è¦ç»§æ‰¿æ¥å£<code>org.springframework.beans.factory.support.MethodReplacer</code>ï¼‰çš„é€»è¾‘ï¼Œæ›¿æ¢è¿™ä¸ªæ–¹æ³•ã€‚é€šè¿‡æ”¹å˜æ–¹æ³•æ‰§è¡Œé€»è¾‘æ¥åŠ¨æ€æ”¹å˜æ–¹æ³•ã€‚</p></blockquote></li></ul><h2 id="meta-å­å…ƒç´ "><a href="#meta-å­å…ƒç´ " class="headerlink" title="meta å­å…ƒç´ "></a>meta å­å…ƒç´ </h2><blockquote><p> <strong>meta</strong> ï¼šå…ƒæ•°æ®ã€‚å½“éœ€è¦ä½¿ç”¨é‡Œé¢çš„ä¿¡æ¯æ—¶å¯ä»¥é€šè¿‡keyè·å–</p></blockquote><p><code>meta</code> æ‰€å£°æ˜çš„ <code>key</code> å¹¶ä¸ä¼šåœ¨ <code>Bean</code> ä¸­ä½“ç°ï¼Œåªæ˜¯ä¸€ä¸ªé¢å¤–çš„å£°æ˜ï¼Œå½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨é‡Œé¢çš„ä¿¡æ¯æ—¶ï¼Œé€šè¿‡ <code>BeanDefinition</code> çš„ <code>getAttribute()</code> è·å–ã€‚è¯¥å­å…ƒç´ çš„è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseMetaElements</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                              BeanMetadataAttributeAccessor attributeAccessor)</span> </span>&#123;</span><br><span class="line">  NodeList nl = ele.getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">      Element metaElement = (Element) node;</span><br><span class="line">      String key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">      String value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">      BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(key, value);</span><br><span class="line">      attribute.setSource(extractSource(metaElement));</span><br><span class="line">      attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æè¿‡ç¨‹è¾ƒä¸ºç®€å•ï¼Œè·å–ç›¸åº”çš„ <code>key - value</code> æ„å»º <code>BeanMetadataAttribute</code> å¯¹è±¡ï¼Œç„¶åé€šè¿‡ <code>addMetadataAttribute()</code> åŠ å…¥åˆ° <code>AbstractBeanDefinition</code> ä¸­ã€‚ ä»£ç  å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMetadataAttribute</span><span class="params">(BeanMetadataAttribute attribute)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.setAttribute(attribute.getName(), attribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å§”æ‰˜ <code>AttributeAccessorSupport</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, <span class="meta">@Nullable</span> Object value)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(name, <span class="string">&quot;Name must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes.put(name, value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    removeAttribute(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AttributeAccessorSupport</code> æ˜¯æ¥å£ <code>AttributeAccessor</code> çš„å®ç°è€…ã€‚ <code>AttributeAccessor</code> æ¥å£å®šä¹‰äº†ä¸å…¶ä»–å¯¹è±¡çš„å…ƒæ•°æ®è¿›è¡Œè¿æ¥å’Œè®¿é—®çš„çº¦å®šï¼Œå¯ä»¥é€šè¿‡è¯¥æ¥å£å¯¹å±æ€§è¿›è¡Œè·å–ã€è®¾ç½®ã€åˆ é™¤æ“ä½œã€‚ è®¾ç½®å…ƒæ•°æ®åï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>getAttribute()</code> è·å–,å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAttribute</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  BeanMetadataAttribute attribute = (BeanMetadataAttribute) <span class="keyword">super</span>.getAttribute(name);</span><br><span class="line">  <span class="keyword">return</span> (attribute != <span class="keyword">null</span> ? attribute.getValue() : <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="lookup-method-å­å…ƒç´ "><a href="#lookup-method-å­å…ƒç´ " class="headerlink" title="lookup-method å­å…ƒç´ "></a>lookup-method å­å…ƒç´ </h2><blockquote><p> <strong>lookup-method</strong> ï¼šè·å–å™¨æ³¨å…¥ï¼Œæ˜¯æŠŠä¸€ä¸ªæ–¹æ³•å£°æ˜ä¸ºè¿”å›æŸç§ç±»å‹çš„ bean ä½†å®é™…è¦è¿”å›çš„ bean æ˜¯åœ¨é…ç½®æ–‡ä»¶é‡Œé¢é…ç½®çš„ã€‚è¯¥æ–¹æ³•å¯ä»¥ç”¨äºè®¾è®¡ä¸€äº›å¯æ’æ‹”çš„åŠŸèƒ½ä¸Šï¼Œè§£é™¤ç¨‹åºä¾èµ–ã€‚</p></blockquote><p>ç›´æ¥ä¸Šä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bmw</span> <span class="keyword">implements</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯ BMW&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hongqi</span> <span class="keyword">implements</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯ hongqi&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Display</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;</span><br><span class="line">        getCar().display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Car <span class="title">getCar</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = </span><br><span class="line">          <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Display display = (Display) context.getBean(<span class="string">&quot;display&quot;</span>);</span><br><span class="line">        display.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;display&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test1.Display&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">&quot;getCar&quot;</span> <span class="attr">bean</span>=<span class="string">&quot;hongqi&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æˆ‘æ˜¯ hongqi</span><br></pre></td></tr></table></figure><p>å¦‚æœå°† <code>bean=&quot;hognqi&quot;</code> æ›¿æ¢ä¸º <code>bean=&quot;bmw&quot;</code>ï¼Œåˆ™è¿è¡Œç»“æœå˜æˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æˆ‘æ˜¯ BMW</span><br></pre></td></tr></table></figure><p>çœ‹äº†è¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬åˆæ­¥äº†è§£äº† <code>looku-method</code> å­å…ƒç´ æä¾›çš„åŠŸèƒ½äº†ï¼Œå…¶è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseLookupOverrideSubElements</span><span class="params">(Element beanEle, </span></span></span><br><span class="line"><span class="function"><span class="params">                                           MethodOverrides overrides)</span> </span>&#123;</span><br><span class="line">  NodeList nl = beanEle.getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) &#123;</span><br><span class="line">      Element ele = (Element) node;</span><br><span class="line">      String methodName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">      String beanRef = ele.getAttribute(BEAN_ELEMENT);</span><br><span class="line">      LookupOverride override = <span class="keyword">new</span> LookupOverride(methodName, beanRef);</span><br><span class="line">      override.setSource(extractSource(ele));</span><br><span class="line">      overrides.addOverride(override);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æè¿‡ç¨‹å’Œ <code>meta</code> å­å…ƒç´ æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼ŒåŒæ ·æ˜¯è§£æ <code>methodName</code>ã€<code>beanRef</code> æ„é€ ä¸€ä¸ª <code>LookupOverride</code> å¯¹è±¡ï¼Œç„¶åè¦†ç›–å³å¯ã€‚åœ¨å®ä¾‹åŒ– <code>Bean</code> çš„æ—¶å€™ï¼Œå†è¯¦ç»†é˜è¿°å…·ä½“çš„å®ç°è¿‡ç¨‹ï¼Œè¿™é‡Œä»…ä»…åªæ˜¯ä¸€ä¸ªæ ‡è®°ä½œç”¨ã€‚</p><h2 id="replace-method-å­å…ƒç´ "><a href="#replace-method-å­å…ƒç´ " class="headerlink" title="replace-method å­å…ƒç´ "></a>replace-method å­å…ƒç´ </h2><blockquote><p> <strong>replaced-method</strong> ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶è°ƒç”¨æ–°çš„æ–¹æ³•æ›¿æ¢ç°æœ‰çš„æ–¹æ³•ï¼Œè¿˜èƒ½åŠ¨æ€çš„æ›´æ–°åŸæœ‰æ–¹æ³•çš„é€»è¾‘</p></blockquote><p>è¯¥æ ‡ç­¾ä½¿ç”¨æ–¹æ³•å’Œ <code>lookup-method</code> æ ‡ç­¾å·®ä¸å¤šï¼Œåªä¸è¿‡æ›¿ä»£æ–¹æ³•çš„ç±»éœ€è¦å®ç° <code>MethodReplacer</code> æ¥å£ã€‚å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯åŸå§‹æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodReplace</span> <span class="keyword">implements</span> <span class="title">MethodReplacer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">reimplement</span><span class="params">(Object obj, Method method, Object[] args)</span> </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯æ›¿æ¢æ–¹æ³•&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ApplicationContext context = </span><br><span class="line">    <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;classpath:spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Method method = (Method) context.getBean(<span class="string">&quot;method&quot;</span>);</span><br><span class="line">  method.display();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ spring.xml æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;methodReplace&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test1.MethodReplace&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;method&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test1.Method&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ™è¿è¡Œç»“æœä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æˆ‘æ˜¯åŸå§‹æ–¹æ³•</span><br></pre></td></tr></table></figure><p>å¢åŠ  <code>replaced-method</code> å­å…ƒç´ ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;methodReplace&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test1.MethodReplace&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;method&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.core.test1.Method&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">&quot;display&quot;</span> <span class="attr">replacer</span>=<span class="string">&quot;methodReplace&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">æˆ‘æ˜¯æ›¿æ¢æ–¹æ³•</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç æ¼”ç¤ºäº† <code>replaced-method</code> å­å…ƒç´ çš„ç”¨æ³•ï¼Œä¸‹é¢å†çœ‹çœ‹è¯¥å­å…ƒç´ çš„è§£æè¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseReplacedMethodSubElements</span><span class="params">(Element beanEle, </span></span></span><br><span class="line"><span class="function"><span class="params">                                           MethodOverrides overrides)</span> </span>&#123;</span><br><span class="line">  NodeList nl = beanEle.getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">    Node node = nl.item(i);</span><br><span class="line">    <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) &#123;</span><br><span class="line">      Element replacedMethodEle = (Element) node;</span><br><span class="line">      String name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">      String callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE);</span><br><span class="line">      ReplaceOverride replaceOverride = <span class="keyword">new</span> ReplaceOverride(name, callback);</span><br><span class="line">      <span class="comment">// Look for arg-type match elements.</span></span><br><span class="line">      List&lt;Element&gt; argTypeEles = DomUtils</span><br><span class="line">        .getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT);</span><br><span class="line">      <span class="keyword">for</span> (Element argTypeEle : argTypeEles) &#123;</span><br><span class="line">        String match = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE);</span><br><span class="line">        match = (StringUtils.hasText(match) ? match : DomUtils.getTextValue(argTypeEle));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(match)) &#123;</span><br><span class="line">          replaceOverride.addTypeIdentifier(match);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      replaceOverride.setSource(extractSource(replacedMethodEle));</span><br><span class="line">      overrides.addOverride(replaceOverride);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å­å…ƒç´ å’Œ <code>lookup-method</code> èµ„æºçš„è§£æè¿‡ç¨‹å·®ä¸å¤šï¼ŒåŒæ ·æ˜¯æå– <code>name</code> å’Œ <code>replacer</code> å±æ€§æ„å»º <code>ReplaceOverride</code> å¯¹è±¡ï¼Œç„¶åè®°å½•åˆ° <code>AbstractBeanDefinition</code> ä¸­çš„ <code>methodOverrides</code> å±æ€§ä¸­ã€‚ </p><p>å¯¹äº <code>lookup-method</code> å’Œ <code>replaced-method</code> ä¸¤ä¸ªå­å…ƒç´ æ˜¯å¦‚ä½•ä½¿ç”¨ä»¥å®Œæˆä»–ä»¬æ‰€æä¾›çš„åŠŸèƒ½ï¼Œåœ¨åç»­å®ä¾‹åŒ– <code>Bean</code> çš„æ—¶å€™ä¼šåšè¯¦ç»†è¯´æ˜ã€‚</p><blockquote><p>è¿™ä¸¤ä¸ªæ ‡ç­¾å¾ˆå°‘ä½¿ç”¨</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šBeanDefinition</title>
      <link href="/blog/2020/01/09/af1473fe.html"/>
      <url>/blog/2020/01/09/af1473fe.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2736">http://cmsblogs.com/?p=2736</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><h2 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h2><p><code>BeanDefinition</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæè¿°äº†ä¸€ä¸ª <code>Bean</code> å®ä¾‹ï¼ŒåŒ…æ‹¬å±æ€§å€¼ã€æ„é€ æ–¹æ³•å€¼å’Œç»§æ‰¿è‡ªå®ƒçš„ç±»çš„æ›´å¤šä¿¡æ¯ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinition</span> <span class="keyword">extends</span> <span class="title">AttributeAccessor</span>, <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String SCOPE_SINGLETON = ConfigurableBeanFactory.SCOPE_SINGLETON;</span><br><span class="line"></span><br><span class="line">String SCOPE_PROTOTYPE = ConfigurableBeanFactory.SCOPE_PROTOTYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ROLE_APPLICATION = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ROLE_SUPPORT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ROLE_INFRASTRUCTURE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Modifiable attributes</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setParentName</span><span class="params">(<span class="meta">@Nullable</span> String parentName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getParentName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setBeanClassName</span><span class="params">(<span class="meta">@Nullable</span> String beanClassName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getBeanClassName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setScope</span><span class="params">(<span class="meta">@Nullable</span> String scope)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getScope</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setLazyInit</span><span class="params">(<span class="keyword">boolean</span> lazyInit)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isLazyInit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDependsOn</span><span class="params">(<span class="meta">@Nullable</span> String... dependsOn)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">String[] getDependsOn();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAutowireCandidate</span><span class="params">(<span class="keyword">boolean</span> autowireCandidate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAutowireCandidate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setPrimary</span><span class="params">(<span class="keyword">boolean</span> primary)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPrimary</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFactoryBeanName</span><span class="params">(<span class="meta">@Nullable</span> String factoryBeanName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getFactoryBeanName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFactoryMethodName</span><span class="params">(<span class="meta">@Nullable</span> String factoryMethodName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getFactoryMethodName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ConstructorArgumentValues <span class="title">getConstructorArgumentValues</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">hasConstructorArgumentValues</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> !getConstructorArgumentValues().isEmpty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MutablePropertyValues <span class="title">getPropertyValues</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">hasPropertyValues</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> !getPropertyValues().isEmpty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read-only attributes</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPrototype</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAbstract</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getRole</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getResourceDescription</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">BeanDefinition <span class="title">getOriginatingBeanDefinition</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çˆ¶ç±»"><a href="#çˆ¶ç±»" class="headerlink" title="çˆ¶ç±»"></a>çˆ¶ç±»</h3><p><code>BeanDefinition</code>ç»§æ‰¿ <code>AttributeAccessor</code> å’Œ <code>BeanMetadataElement</code> æ¥å£ã€‚ä¸¤ä¸ªæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><ul><li><p><code>AttributeAccessor</code> ï¼šå®šä¹‰äº†ä¸å…¶å®ƒå¯¹è±¡çš„ï¼ˆå…ƒæ•°æ®ï¼‰è¿›è¡Œè¿æ¥å’Œè®¿é—®çš„çº¦å®šï¼Œå³å¯¹å±æ€§çš„ä¿®æ”¹ï¼ŒåŒ…æ‹¬è·å–ã€è®¾ç½®ã€åˆ é™¤ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AttributeAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, <span class="meta">@Nullable</span> Object value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">getAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">removeAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">String[] attributeNames();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>BeanMetadataElement</code>ï¼š<code>Bean</code> å…ƒå¯¹è±¡æŒæœ‰çš„é…ç½®å…ƒç´ å¯ä»¥é€šè¿‡<code>getSource()</code> æ–¹æ³•æ¥è·å–ã€‚ </p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">getSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="å­ç±»"><a href="#å­ç±»" class="headerlink" title="å­ç±»"></a>å­ç±»</h3><p><code>BeanDefinition</code> æ•´ä¸ªç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/SIcYke.jpg" alt="SIcYke"></p><p>æˆ‘ä»¬å¸¸ç”¨çš„ä¸‰ä¸ªå®ç°ç±»æœ‰ï¼š<code>ChildBeanDefinition</code>ã€<code>GenericBeanDefinition</code>ã€<code>RootBeanDefinition</code>ï¼Œä¸‰è€…éƒ½ç»§æ‰¿ <code>AbstractBeanDefinition</code>ã€‚å¦‚æœé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†<code>çˆ¶</code>  å’Œ <code>å­</code>  ï¼Œåˆ™çˆ¶  ç”¨ <code>RootBeanDefinition</code>è¡¨ç¤ºï¼Œå­  ç”¨ <code>ChildBeanDefinition</code> è¡¨ç¤ºï¼Œè€Œæ²¡æœ‰çˆ¶çš„å°±ä½¿ç”¨<code>RootBeanDefinition</code> è¡¨ç¤ºã€‚<code>GenericBeanDefinition</code> ä¸ºä¸€ç«™å¼æœåŠ¡ç±»ã€‚<code>AbstractBeanDefinition</code>å¯¹ä¸‰ä¸ªå­ç±»å…±åŒçš„ç±»ä¿¡æ¯è¿›è¡ŒæŠ½è±¡ã€‚</p><h2 id="è§£æ-Bean-æ ‡ç­¾"><a href="#è§£æ-Bean-æ ‡ç­¾" class="headerlink" title="è§£æ Bean æ ‡ç­¾"></a>è§£æ Bean æ ‡ç­¾</h2><p>åœ¨ <code>BeanDefinitionParserDelegate.parseBeanDefinitionElement()</code> ä¸­å®Œæˆ <code>Bean</code> çš„è§£æï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå·²ç»å®Œæˆå¯¹  æ ‡ç­¾è§£æçš„ <code>BeanDefinition</code> å®ä¾‹ã€‚</p><h3 id="createBeanDefinition"><a href="#createBeanDefinition" class="headerlink" title="createBeanDefinition"></a>createBeanDefinition</h3><p>åœ¨è¯¥æ–¹æ³•å†…éƒ¨ï¼Œé¦–å…ˆè°ƒç”¨ <code>createBeanDefinition()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªç”¨äºæ‰¿è½½å±æ€§çš„ <code>GenericBeanDefinition</code> å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AbstractBeanDefinition <span class="title">createBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> String className, <span class="meta">@Nullable</span> String parentName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> BeanDefinitionReaderUtils.createBeanDefinition(</span><br><span class="line">    parentName, className, <span class="keyword">this</span>.readerContext.getBeanClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å§”æ‰˜ <code>BeanDefinitionReaderUtils</code> åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractBeanDefinition <span class="title">createBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> String parentName, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> String className, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">  GenericBeanDefinition bd = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">  bd.setParentName(parentName);</span><br><span class="line">  <span class="keyword">if</span> (className != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">      bd.setBeanClass(ClassUtils.forName(className, classLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      bd.setBeanClassName(className);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯è®¾ç½® <code>parentName</code> ã€<code>className</code>ã€<code>classLoader</code>ã€‚</p><h3 id="parseBeanDefinitionAttributes"><a href="#parseBeanDefinitionAttributes" class="headerlink" title="parseBeanDefinitionAttributes"></a>parseBeanDefinitionAttributes</h3><p>åˆ›å»ºå®Œ <code>GenericBeanDefinition</code> å®ä¾‹åï¼Œå†è°ƒç”¨ <code>parseBeanDefinitionAttributes()</code> ï¼Œè¯¥æ–¹æ³•å°†åˆ›å»ºå¥½çš„ <code>GenericBeanDefinition</code> å®ä¾‹å½“åšå‚æ•°ï¼Œå¯¹ <code>Bean</code> æ ‡ç­¾çš„æ‰€æœ‰å±æ€§è¿›è¡Œè§£æï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionAttributes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element ele, String beanName,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="meta">@Nullable</span> BeanDefinition containingBean,</span></span></span><br><span class="line"><span class="function"><span class="params">  AbstractBeanDefinition bd)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æ scope æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Old 1.x &#x27;singleton&#x27; attribute in use - upgrade to &#x27;scope&#x27; declaration&quot;</span>, ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;</span><br><span class="line">    bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Take default from containing bean in case of an inner bean definition.</span></span><br><span class="line">    bd.setScope(containingBean.getScope());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ abstract æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;</span><br><span class="line">    bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ lazy-init æ ‡ç­¾</span></span><br><span class="line">  String lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE);</span><br><span class="line">  <span class="keyword">if</span> (DEFAULT_VALUE.equals(lazyInit)) &#123;</span><br><span class="line">    lazyInit = <span class="keyword">this</span>.defaults.getLazyInit();</span><br><span class="line">  &#125;</span><br><span class="line">  bd.setLazyInit(TRUE_VALUE.equals(lazyInit));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ autowire æ ‡ç­¾</span></span><br><span class="line">  String autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE);</span><br><span class="line">  bd.setAutowireMode(getAutowireMode(autowire));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ depends-on æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;</span><br><span class="line">    String dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE);</span><br><span class="line">    bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ autowire-candidate æ ‡ç­¾</span></span><br><span class="line">  String autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(autowireCandidate) || DEFAULT_VALUE.equals(autowireCandidate)) &#123;</span><br><span class="line">    String candidatePattern = <span class="keyword">this</span>.defaults.getAutowireCandidates();</span><br><span class="line">    <span class="keyword">if</span> (candidatePattern != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern);</span><br><span class="line">      bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ primay æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;</span><br><span class="line">    bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ init-method æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">    String initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE);</span><br><span class="line">    bd.setInitMethodName(initMethodName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.defaults.getInitMethod() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bd.setInitMethodName(<span class="keyword">this</span>.defaults.getInitMethod());</span><br><span class="line">    bd.setEnforceInitMethod(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ destroy-mothod æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">    String destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE);</span><br><span class="line">    bd.setDestroyMethodName(destroyMethodName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.defaults.getDestroyMethod() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bd.setDestroyMethodName(<span class="keyword">this</span>.defaults.getDestroyMethod());</span><br><span class="line">    bd.setEnforceDestroyMethod(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ factory-method æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">    bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;</span><br><span class="line">    bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å¯¹ <code>Bean</code> æ ‡ç­¾å±æ€§çš„è§£æï¼Œè¿™äº›å±æ€§æˆ‘ä»¬åœ¨å·¥ä½œä¸­éƒ½æˆ–å¤šæˆ–å°‘ç”¨åˆ°è¿‡ã€‚ å®Œæˆ Bean æ ‡ç­¾åŸºæœ¬å±æ€§è§£æåï¼Œä¼šä¾æ¬¡è°ƒç”¨ <code>parseMetaElements()</code>ã€<code>parseLookupOverrideSubElements()</code>ã€<code>parseReplacedMethodSubElements()</code> å¯¹å­å…ƒç´  <code>meta</code>ã€<code>lookup-method</code>ã€<code>replace-method</code> å®Œæˆè§£æã€‚ä¸‹ç¯‡åšæ–‡å°†ä¼šå¯¹è¿™ä¸‰ä¸ªå­å…ƒç´ è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šå¼€å¯è§£æè¿›ç¨‹</title>
      <link href="/blog/2020/01/08/fb623179.html"/>
      <url>/blog/2020/01/08/fb623179.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2731">http://cmsblogs.com/?p=2731</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p><code>import</code> æ ‡ç­¾è§£æå®Œæ¯•äº†ï¼Œå†çœ‹ <code>Spring</code> ä¸­æœ€å¤æ‚ä¹Ÿæ˜¯æœ€é‡è¦çš„æ ‡ç­¾ <code>bean</code> æ ‡ç­¾çš„è§£æè¿‡ç¨‹ã€‚ åœ¨æ–¹æ³• <code>parseDefaultElement()</code> ä¸­ï¼Œå¦‚æœé‡åˆ°æ ‡ç­¾ ä¸º <code>bean</code> åˆ™è°ƒç”¨ <code>processBeanDefinition()</code> æ–¹æ³•è¿›è¡Œ bean æ ‡ç­¾è§£æï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                     BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, </span><br><span class="line">                                                       getReaderContext().getRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> </span><br><span class="line">                               +</span><br><span class="line">                               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Send registration event.</span></span><br><span class="line">    getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤</p><ol><li>è°ƒç”¨ <code>BeanDefinitionParserDelegate.parseBeanDefinitionElement()</code> è¿›è¡Œå…ƒç´ è§£æï¼Œè§£æè¿‡ç¨‹ä¸­å¦‚æœå¤±è´¥ï¼Œè¿”å› <strong>null</strong>ï¼Œé”™è¯¯ç”± <code>ProblemReporter</code> å¤„ç†ã€‚å¦‚æœè§£ææˆåŠŸåˆ™è¿”å› <code>BeanDefinitionHolder</code> å®ä¾‹ <code>bdHolder</code>ã€‚<code>BeanDefinitionHolder</code> ä¸ºæŒæœ‰ <code>name</code> å’Œ <code>alias</code> çš„ <code>BeanDefinition</code>ã€‚</li><li>è‹¥å®ä¾‹ <code>bdHolder</code> ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>BeanDefinitionParserDelegate.decorateBeanDefinitionIfRequired()</code> è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾å¤„ç†</li><li>è§£æå®Œæˆåï¼Œåˆ™è°ƒç”¨ <code>BeanDefinitionReaderUtils.registerBeanDefinition()</code> å¯¹ <code>bdHolder</code> è¿›è¡Œæ³¨å†Œ</li><li>å‘å‡ºå“åº”äº‹ä»¶ï¼Œé€šçŸ¥ç›¸å…³çš„ç›‘å¬å™¨ï¼Œå®Œæˆ <code>Bean</code> æ ‡ç­¾è§£æ</li></ol><p>å…ˆçœ‹æ–¹æ³• <code>parseBeanDefinitionElement()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                       <span class="meta">@Nullable</span> BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æ ID å±æ€§</span></span><br><span class="line">  String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">  <span class="comment">// è§£æ name å±æ€§</span></span><br><span class="line">  String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ†å‰² name å±æ€§</span></span><br><span class="line">  List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">    String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">    aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String beanName = id;</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">    beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;No XML &#x27;id&#x27; specified - using &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; as bean name and &quot;</span> + aliases + <span class="string">&quot; as aliases&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥ name çš„å”¯ä¸€æ€§</span></span><br><span class="line">  <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">    checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ å±æ€§ï¼Œæ„é€  AbstractBeanDefinition</span></span><br><span class="line">  AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">  <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ beanName ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ®æ¡ä»¶æ„é€ ä¸€ä¸ª beanName</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">          beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">            beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">          String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">          <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">              beanName.startsWith(beanClassName) &amp;&amp; beanName.length() </span><br><span class="line">              &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">              !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">            aliases.add(beanClassName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Neither XML &#x27;id&#x27; nor &#x27;name&#x27; specified - &quot;</span> +</span><br><span class="line">                       <span class="string">&quot;using generated bean name [&quot;</span> + beanName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        error(ex.getMessage(), ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è£… BeanDefinitionHolder</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•è¿˜æ²¡æœ‰å¯¹ <code>Bean</code> æ ‡ç­¾è¿›è¡Œè§£æï¼Œåªæ˜¯åœ¨è§£æåŠ¨ä½œä¹‹å‰åšäº†ä¸€äº›åŠŸèƒ½æ¶æ„ï¼Œä¸»è¦çš„å·¥ä½œæœ‰ï¼š</p><ul><li>è§£æ <code>id</code>ã€<code>name</code> å±æ€§ï¼Œç¡®å®š <code>alias</code> é›†åˆï¼Œæ£€æµ‹ <code>beanName</code> æ˜¯å¦å”¯ä¸€</li><li>è°ƒç”¨æ–¹æ³• <code>parseBeanDefinitionElement()</code> å¯¹å±æ€§è¿›è¡Œè§£æå¹¶å°è£…æˆ <code>GenericBeanDefinition</code> å®ä¾‹ <code>beanDefinition</code></li><li>æ ¹æ®æ‰€è·å–çš„ä¿¡æ¯ï¼ˆ<code>beanName</code>ã€<code>aliases</code>ã€<code>beanDefinition</code>ï¼‰æ„é€  <code>BeanDefinitionHolder</code> å®ä¾‹å¯¹è±¡å¹¶è¿”å›ã€‚</li></ul><p>è¿™é‡Œæœ‰å¿…è¦è¯´ä¸‹ <code>beanName</code> çš„å‘½åè§„åˆ™ï¼šå¦‚æœ <code>id</code> ä¸ä¸ºç©ºï¼Œåˆ™ <code>beanName = id</code>ï¼›å¦‚æœ <code>id</code> ä¸ºç©ºï¼Œä½†æ˜¯ <code>alias</code> ä¸ç©ºï¼Œåˆ™ <code>beanName</code> ä¸º <code>alias</code> çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœä¸¤è€…éƒ½ä¸ºç©ºï¼Œåˆ™æ ¹æ®é»˜è®¤è§„åˆ™æ¥è®¾ç½® <code>beanName</code>ã€‚ ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤ç¬¬äºŒä¸ªæ­¥éª¤ä¸ºæ ¸å¿ƒæ–¹æ³•ï¼Œå®ƒä¸»è¦æ‰¿æ‹…è§£æ Bean æ ‡ç­¾ä¸­æ‰€æœ‰çš„å±æ€§å€¼ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Element ele, String beanName, <span class="meta">@Nullable</span> BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">  String className = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// è§£æ class å±æ€§</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">    className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">  &#125;</span><br><span class="line">  String parent = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ parent å±æ€§</span></span><br><span class="line">  <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">    parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç”¨äºæ‰¿è½½å±æ€§çš„ GenericBeanDefinition å®ä¾‹</span></span><br><span class="line">    AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æé»˜è®¤ bean çš„å„ç§å±æ€§</span></span><br><span class="line">    parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå– description</span></span><br><span class="line">    bd.setDescription(DomUtils.getChildElementValueByTagName(ele, </span><br><span class="line">                                                             DESCRIPTION_ELEMENT));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå…ƒæ•°æ®</span></span><br><span class="line">    parseMetaElements(ele, bd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ lookup-method å±æ€§</span></span><br><span class="line">    parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ replaced-method å±æ€§</span></span><br><span class="line">    parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ææ„é€ å‡½æ•°å‚æ•°</span></span><br><span class="line">    parseConstructorArgElements(ele, bd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ property å­å…ƒç´ </span></span><br><span class="line">    parsePropertyElements(ele, bd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ qualifier å­å…ƒç´ </span></span><br><span class="line">    parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">    bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">    bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bd;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">    error(<span class="string">&quot;Bean class [&quot;</span> + className + <span class="string">&quot;] not found&quot;</span>, ele, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">    error(<span class="string">&quot;Class that bean class [&quot;</span> + className </span><br><span class="line">          + <span class="string">&quot;] depends on not found&quot;</span>, ele, err);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    error(<span class="string">&quot;Unexpected failure during bean definition parsing&quot;</span>,</span><br><span class="line">          ele, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œ<code>Bean</code> æ ‡ç­¾çš„æ‰€æœ‰å±æ€§æˆ‘ä»¬éƒ½å¯ä»¥çœ‹åˆ°å…¶è§£æçš„è¿‡ç¨‹ï¼Œä¹Ÿå°±è¯´åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»è§£æä¸€ä¸ªåŸºæœ¬å¯ç”¨çš„ <code>BeanDefinition</code>ã€‚ ç”±äºè§£æè¿‡ç¨‹è¾ƒä¸ºæ¼«é•¿ï¼Œç¯‡å¹…è¾ƒå¤§ï¼Œä¸ºäº†æ›´å¥½çš„è§‚çœ‹ä½“éªŒï¼Œå°†è¿™ç¯‡åšæ–‡è¿›è¡Œæ‹†åˆ†ã€‚ä¸‹ç¯‡åšå®¢ä¸»è¦ä»‹ç» <code>BeanDefinition</code>ï¼Œä»¥åŠè§£æé»˜è®¤ <code>Bean</code> çš„è¿‡ç¨‹ï¼ˆ<code>parseBeanDefinitionAttributes()</code>ï¼‰ â€“ - <a href="/2020/01/07/3f8e0ea3.html">IOC ä¹‹è§£æBeanï¼šè§£æ import æ ‡ç­¾</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹è§£æBeanï¼šè§£æimportæ ‡ç­¾</title>
      <link href="/blog/2020/01/07/3f8e0ea3.html"/>
      <url>/blog/2020/01/07/3f8e0ea3.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2724">http://cmsblogs.com/?p=2724</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>åœ¨<a href="/2020/01/06/9de498cf.html">IOC ä¹‹ æ³¨å†Œ BeanDefinition</a>ä¸­åˆ†æåˆ°ï¼Œ<code>Spring</code> ä¸­æœ‰ä¸¤ç§è§£æ <code>Bean</code> çš„æ–¹å¼ã€‚å¦‚æœæ ¹èŠ‚ç‚¹æˆ–è€…å­èŠ‚ç‚¹é‡‡ç”¨é»˜è®¤å‘½åç©ºé—´çš„è¯ï¼Œåˆ™è°ƒç”¨ <code>parseDefaultElement()</code> è¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æï¼Œå¦åˆ™è°ƒç”¨ <code>delegate.parseCustomElement()</code> æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰è§£æã€‚æ‰€ä»¥ï¼Œä»¥ä¸‹åšå®¢å°±è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œè¯¦ç»†åˆ†æè¯´æ˜ï¼Œå…ˆä»é»˜è®¤æ ‡ç­¾è§£æè¿‡ç¨‹å¼€å§‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line"><span class="comment">// å¯¹ import æ ‡ç­¾çš„è§£æ</span></span><br><span class="line">  <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">    importBeanDefinitionResource(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹ alias æ ‡ç­¾çš„è§£æ</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">    processAliasRegistration(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹ bean æ ‡ç­¾çš„è§£æ</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">    processBeanDefinition(ele, delegate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹ beans æ ‡ç­¾çš„è§£æ</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">  <span class="comment">// recurse</span></span><br><span class="line">    doRegisterBeanDefinitions(ele);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•çš„åŠŸèƒ½ä¸€ç›®äº†ç„¶ï¼Œåˆ†åˆ«æ˜¯å¯¹å››ç§ä¸åŒçš„æ ‡ç­¾è¿›è¡Œè§£æï¼Œåˆ†åˆ«æ˜¯ <code>import</code>ã€<code>alias</code>ã€<code>bean</code>ã€<code>beans</code>ã€‚å’±é—¨ä»ç¬¬ä¸€ä¸ªæ ‡ç­¾ <code>import</code> å¼€å§‹ã€‚</p><h2 id="import-æ ‡ç­¾çš„å¤„ç†"><a href="#import-æ ‡ç­¾çš„å¤„ç†" class="headerlink" title="import æ ‡ç­¾çš„å¤„ç†"></a>import æ ‡ç­¾çš„å¤„ç†</h2><p>ç»å†è¿‡ <code>Spring</code> é…ç½®æ–‡ä»¶çš„å°ä¼™ä¼´éƒ½çŸ¥é“ï¼Œå¦‚æœå·¥ç¨‹æ¯”è¾ƒå¤§ï¼Œé…ç½®æ–‡ä»¶çš„ç»´æŠ¤ä¼šè®©äººè§‰å¾—ææ€–ï¼Œæ–‡ä»¶å¤ªå¤šäº†ï¼Œæƒ³è±¡å°†æ‰€æœ‰çš„é…ç½®éƒ½æ”¾åœ¨ä¸€ä¸ª <code>spring.xml</code> é…ç½®æ–‡ä»¶ä¸­ï¼Œå“ªç§åæ€•æ„Ÿæ˜¯ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Ÿæ‰€æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µ <code>Spring</code> æä¾›äº†ä¸€ä¸ªåˆ†æ¨¡å—çš„æ€è·¯ï¼Œåˆ©ç”¨ <code>import</code> æ ‡ç­¾ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªè¿™æ ·çš„ <code>spring.xml</code>ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-student.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-student-dtd.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>spring.xml</code> é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ <code>import</code> æ ‡ç­¾çš„æ–¹å¼å¯¼å…¥å…¶ä»–æ¨¡å—çš„é…ç½®æ–‡ä»¶ã€‚</p><ul><li>å¦‚æœæœ‰é…ç½®éœ€è¦ä¿®æ”¹ç›´æ¥ä¿®æ”¹ç›¸åº”é…ç½®æ–‡ä»¶å³å¯ã€‚</li><li>è‹¥æœ‰æ–°çš„æ¨¡å—éœ€è¦å¼•å…¥ç›´æ¥å¢åŠ  <code>import</code> å³å¯ã€‚</li></ul><p>è¿™æ ·å¤§å¤§ç®€åŒ–äº†é…ç½®åæœŸç»´æŠ¤çš„å¤æ‚åº¦ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºç®¡ç†ã€‚ </p><h2 id="importBeanDefinitionResource"><a href="#importBeanDefinitionResource" class="headerlink" title="importBeanDefinitionResource"></a>importBeanDefinitionResource</h2><p><code>Spring</code> åˆ©ç”¨ <code>importBeanDefinitionResource()</code> æ–¹æ³•å®Œæˆå¯¹ <code>import</code> æ ‡ç­¾çš„è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">importBeanDefinitionResource</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å– resource çš„å±æ€§å€¼ </span></span><br><span class="line">  String location = ele.getAttribute(RESOURCE_ATTRIBUTE);</span><br><span class="line">  <span class="comment">// ä¸ºç©ºï¼Œç›´æ¥é€€å‡º</span></span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.hasText(location)) &#123;</span><br><span class="line">    getReaderContext().error(<span class="string">&quot;Resource location must not be empty&quot;</span>, ele);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æç³»ç»Ÿå±æ€§ï¼Œæ ¼å¼å¦‚ ï¼š&quot;$&#123;user.dir&#125;&quot;</span></span><br><span class="line">  location = getReaderContext().getEnvironment().resolveRequiredPlaceholders(location);</span><br><span class="line"></span><br><span class="line">  Set&lt;Resource&gt; actualResources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­ location æ˜¯ç›¸å¯¹è·¯å¾„è¿˜æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">  <span class="keyword">boolean</span> absoluteLocation = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">    <span class="comment">// cannot convert to an URI, considering the location relative</span></span><br><span class="line">    <span class="comment">// unless it is the well-known Spring prefix &quot;classpath*:&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»å¯¹è·¯å¾„</span></span><br><span class="line">  <span class="keyword">if</span> (absoluteLocation) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ç›´æ¥æ ¹æ®åœ°è´¨åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">      <span class="keyword">int</span> importCount = getReaderContext()</span><br><span class="line">        .getReader().loadBeanDefinitions(location, actualResources);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Imported &quot;</span> </span><br><span class="line">                     + importCount </span><br><span class="line">                     + <span class="string">&quot; bean definitions from URL location [&quot;</span> </span><br><span class="line">                     + location + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(</span><br><span class="line">        <span class="string">&quot;Failed to import bean definitions from URL location [&quot;</span> </span><br><span class="line">        + location + <span class="string">&quot;]&quot;</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç›¸å¯¹è·¯å¾„åˆ™æ ¹æ®ç›¸åº”çš„åœ°è´¨è®¡ç®—å‡ºç»å¯¹è·¯å¾„åœ°å€</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> importCount;</span><br><span class="line">      Resource relativeResource = getReaderContext()</span><br><span class="line">        .getResource().createRelative(location);</span><br><span class="line">      <span class="keyword">if</span> (relativeResource.exists()) &#123;</span><br><span class="line">        importCount = getReaderContext()</span><br><span class="line">          .getReader().loadBeanDefinitions(relativeResource);</span><br><span class="line">        actualResources.add(relativeResource);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        String baseLocation = getReaderContext()</span><br><span class="line">          .getResource().getURL().toString();</span><br><span class="line">        importCount = getReaderContext().getReader()</span><br><span class="line">          .loadBeanDefinitions(</span><br><span class="line">          StringUtils.applyRelativePath(baseLocation, location), </span><br><span class="line">          actualResources);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Imported &quot;</span> + importCount </span><br><span class="line">                     + <span class="string">&quot; bean definitions from relative location [&quot;</span> </span><br><span class="line">                     + location + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">&quot;Failed to resolve current resource location&quot;</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext()</span><br><span class="line">        .error(<span class="string">&quot;Failed to import bean definitions from relative location [&quot;</span> </span><br><span class="line">               + location + <span class="string">&quot;]&quot;</span>,</span><br><span class="line">                               ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è§£ææˆåŠŸåï¼Œè¿›è¡Œç›‘å¬å™¨æ¿€æ´»å¤„ç†</span></span><br><span class="line">  Resource[] actResArray = actualResources.toArray(<span class="keyword">new</span> Resource[<span class="number">0</span>]);</span><br><span class="line">  getReaderContext().fireImportProcessed(location, actResArray, extractSource(ele));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£æ import è¿‡ç¨‹è¾ƒä¸ºæ¸…æ™°ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</strong></p><ol><li>è·å– <code>source</code> å±æ€§çš„å€¼ï¼Œè¯¥å€¼è¡¨ç¤ºèµ„æºçš„è·¯å¾„</li><li>è§£æè·¯å¾„ä¸­çš„ç³»ç»Ÿå±æ€§ï¼Œå¦‚â€<code>$&#123;user.dir&#125;</code>â€œ</li><li>åˆ¤æ–­èµ„æºè·¯å¾„ <code>location</code> æ˜¯ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„</li><li>å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œåˆ™è°ƒé€’å½’è°ƒç”¨ <code>Bean</code> çš„è§£æè¿‡ç¨‹ï¼Œè¿›è¡Œå¦ä¸€æ¬¡çš„è§£æ</li><li>å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™å…ˆè®¡ç®—å‡ºç»å¯¹è·¯å¾„å¾—åˆ° <code>Resource</code>ï¼Œç„¶åè¿›è¡Œè§£æ</li><li>é€šçŸ¥ç›‘å¬å™¨ï¼Œå®Œæˆè§£æ</li></ol><p><strong>åˆ¤æ–­è·¯å¾„</strong> æ–¹æ³•é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥åˆ¤æ–­ <code>location</code> æ˜¯ä¸ºç›¸å¯¹è·¯å¾„è¿˜æ˜¯ç»å¯¹è·¯å¾„ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">absoluteLocation = ResourcePatternUtils.isUrl(location) || </span><br><span class="line">ResourceUtils.toURI(location).isAbsolute();</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ç»å¯¹è·¯å¾„çš„è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>ä»¥ <strong>classpath*:</strong> æˆ–è€… <strong>classpath:</strong> å¼€å¤´ä¸ºç»å¯¹è·¯å¾„</li><li>èƒ½å¤Ÿé€šè¿‡è¯¥ <code>location</code> æ„å»ºå‡º <code>java.net.URL</code>ä¸ºç»å¯¹è·¯å¾„</li><li>æ ¹æ® <code>location</code> æ„é€  <code>java.net.URI</code> åˆ¤æ–­è°ƒç”¨ <code>isAbsolute()</code> åˆ¤æ–­æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„</li></ul><p><strong>ç»å¯¹è·¯å¾„</strong> å¦‚æœ <code>location</code> ä¸ºç»å¯¹è·¯å¾„åˆ™è°ƒç”¨ <code>loadBeanDefinitions()</code>ï¼Œè¯¥æ–¹æ³•åœ¨ <code>AbstractBeanDefinitionReader</code> ä¸­å®šä¹‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location, <span class="meta">@Nullable</span> Set&lt;Resource&gt; actualResources)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">  <span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;Cannot import bean definitions from location [&quot;</span> </span><br><span class="line">      + location + <span class="string">&quot;]: no ResourceLoader available&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</span><br><span class="line">    <span class="comment">// Resource pattern matching available.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Resource[] resources = ((ResourcePatternResolver) resourceLoader)</span><br><span class="line">        .getResources(location);</span><br><span class="line">      <span class="keyword">int</span> loadCount = loadBeanDefinitions(resources);</span><br><span class="line">      <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">          actualResources.add(resource);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Loaded &quot;</span> + loadCount </span><br><span class="line">                     + <span class="string">&quot; bean definitions from location pattern [&quot;</span> </span><br><span class="line">                     + location + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> loadCount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">        <span class="string">&quot;Could not resolve bean definition resource pattern [&quot;</span> </span><br><span class="line">        + location + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Can only load single resources by absolute URL.</span></span><br><span class="line">    Resource resource = resourceLoader.getResource(location);</span><br><span class="line">    <span class="keyword">int</span> loadCount = loadBeanDefinitions(resource);</span><br><span class="line">    <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">      actualResources.add(resource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Loaded &quot;</span> </span><br><span class="line">                   + loadCount </span><br><span class="line">                   + <span class="string">&quot; bean definitions from location [&quot;</span> </span><br><span class="line">                   + location + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loadCount;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªé€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ol><li>é¦–å…ˆè·å– ResourceLoader</li><li>ç„¶åæ ¹æ®ä¸åŒçš„ ResourceLoader æ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œä¸»è¦æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ª Resource</li><li>æœ€ç»ˆéƒ½ä¼šå›å½’åˆ° <code>XmlBeanDefinitionReader.loadBeanDefinitions()</code> ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚ </li><li>è·å¾—åˆ°çš„ Resource çš„å¯¹è±¡æˆ–æ•°ç»„ï¼Œéƒ½ä¼šæ·»åŠ åˆ° <code>actualResources</code> ä¸­ã€‚</li></ol><h3 id="ç›¸å¯¹è·¯å¾„"><a href="#ç›¸å¯¹è·¯å¾„" class="headerlink" title="ç›¸å¯¹è·¯å¾„"></a>ç›¸å¯¹è·¯å¾„</h3><p>å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™ä¼šæ ¹æ®ç›¸åº”çš„ <code>Resource</code> è®¡ç®—å‡ºç›¸åº”çš„ç»å¯¹è·¯å¾„ï¼Œç„¶å</p><ol><li>æ ¹æ®è¯¥è·¯å¾„æ„é€ ä¸€ä¸ª <code>Resource</code>ï¼Œè‹¥è¯¥ <code>Resource</code> å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ <code>XmlBeanDefinitionReader.loadBeanDefinitions()</code> è¿›è¡Œ BeanDefinition åŠ è½½</li><li>å¦åˆ™æ„é€ ä¸€ä¸ªç»å¯¹ <code>location</code> ï¼Œè°ƒç”¨ <code>AbstractBeanDefinitionReader.loadBeanDefinitions()</code> æ–¹æ³•ï¼Œä¸ç»å¯¹è·¯å¾„è¿‡ç¨‹ä¸€æ ·ã€‚ </li></ol><p>è‡³æ­¤ï¼Œ<code>import</code> æ ‡ç­¾è§£æå®Œæ¯•ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒæ¸…æ™°æ˜äº†ï¼š<strong>è·å– source å±æ€§å€¼ï¼Œå¾—åˆ°æ­£ç¡®çš„èµ„æºè·¯å¾„ï¼Œç„¶åè°ƒç”¨ <code>loadBeanDefinitions()</code> æ–¹æ³•è¿›è¡Œé€’å½’çš„ BeanDefinition åŠ è½½</strong></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹æ³¨å†ŒBeanDefinitions</title>
      <link href="/blog/2020/01/06/9de498cf.html"/>
      <url>/blog/2020/01/06/9de498cf.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2697">http://cmsblogs.com/?p=2697</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>è·å– <code>Document</code> å¯¹è±¡åï¼Œä¼šæ ¹æ®è¯¥å¯¹è±¡å’Œ <code>Resource</code> èµ„æºå¯¹è±¡è°ƒç”¨ <code>registerBeanDefinitions()</code> æ–¹æ³•ï¼Œå¼€å§‹æ³¨å†Œ <code>BeanDefinitions</code> ä¹‹æ—…ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">  <span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">  documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">  <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨ <code>createBeanDefinitionDocumentReader()</code> æ–¹æ³•å®ä¾‹åŒ– <code>BeanDefinitionDocumentReader</code> å¯¹è±¡ï¼Œç„¶åè·å–ç»Ÿè®¡å‰ <code>BeanDefinition</code> çš„ä¸ªæ•°ï¼Œæœ€åè°ƒç”¨ <code>registerBeanDefinitions()</code> æ³¨å†Œ <code>BeanDefinition</code>ã€‚ å®ä¾‹åŒ– <code>BeanDefinitionDocumentReader</code> å¯¹è±¡æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanDefinitionDocumentReader <span class="title">createBeanDefinitionDocumentReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> BeanDefinitionDocumentReader.class.cast(BeanUtils</span><br><span class="line">                                  .instantiateClass(<span class="keyword">this</span>.documentReaderClass));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œ <code>BeanDefinition</code> çš„æ–¹æ³• <code>registerBeanDefinitions()</code> æ˜¯åœ¨æ¥å£ <code>BeanDefinitionDocumentReader</code> ä¸­å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>ä»ç»™å®šçš„ Document å¯¹è±¡ä¸­è§£æå®šä¹‰çš„ BeanDefinition å¹¶å°†ä»–ä»¬æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­</strong>ã€‚</p></blockquote><p>æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œå¾…è§£æçš„ <code>Document</code> å¯¹è±¡ï¼Œä»¥åŠè§£æå™¨çš„å½“å‰ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç›®æ ‡æ³¨å†Œè¡¨å’Œè¢«è§£æçš„èµ„æºã€‚å…¶ä¸­ <code>readerContext</code> æ˜¯æ ¹æ® <code>Resource</code> æ¥åˆ›å»ºçš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> XmlReaderContext <span class="title">createReaderContext</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> XmlReaderContext(resource, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.eventListener,</span><br><span class="line">                              <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>, getNamespaceHandlerResolver());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DefaultBeanDefinitionDocumentReader</code> å¯¹è¯¥æ–¹æ³•æä¾›äº†å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readerContext = readerContext;</span><br><span class="line">  logger.debug(<span class="string">&quot;Loading bean definitions&quot;</span>);</span><br><span class="line">  Element root = doc.getDocumentElement();</span><br><span class="line">  doRegisterBeanDefinitions(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>doRegisterBeanDefinitions()</code> å¼€å¯æ³¨å†Œ <code>BeanDefinition</code> ä¹‹æ—…ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">  BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">  <span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç† profile</span></span><br><span class="line">    String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">      String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">        profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">      <span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">          logger.info(</span><br><span class="line">            <span class="string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> </span><br><span class="line">            + profileSpec +</span><br><span class="line">                      <span class="string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æå‰å¤„ç†</span></span><br><span class="line">  preProcessXml(root);</span><br><span class="line">  <span class="comment">// è§£æ</span></span><br><span class="line">  parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">  <span class="comment">// è§£æåå¤„ç†</span></span><br><span class="line">  postProcessXml(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºé¦–å…ˆå¤„ç† <code>profile</code>å±æ€§ï¼Œ<code>profile</code>ä¸»è¦ç”¨äºæˆ‘ä»¬åˆ‡æ¢ç¯å¢ƒï¼Œæ¯”å¦‚åˆ‡æ¢å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒï¼Œéå¸¸æ–¹ä¾¿ã€‚ç„¶åè°ƒç”¨ <code>parseBeanDefinitions()</code> è¿›è¡Œè§£æåŠ¨ä½œï¼Œä¸è¿‡åœ¨è¯¥æ–¹æ³•ä¹‹å‰ä¹‹ååˆ†åˆ«è°ƒç”¨ <code>preProcessXml()</code> å’Œ <code>postProcessXml()</code> æ–¹æ³•æ¥è¿›è¡Œå‰ã€åå¤„ç†ï¼Œç›®å‰è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ç©ºå®ç°ï¼Œäº¤ç”±å­ç±»æ¥å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">preProcessXml</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessXml</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parseBeanDefinitions()</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">    NodeList nl = root.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">        Element ele = (Element) node;</span><br><span class="line">        <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">          parseDefaultElement(ele, delegate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          delegate.parseCustomElement(ele);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    delegate.parseCustomElement(root);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè§£æåŠ¨ä½œè½åœ°åœ¨ä¸¤ä¸ªæ–¹æ³•å¤„ï¼š<code>parseDefaultElement(ele, delegate)</code> å’Œ <code>delegate.parseCustomElement(root)</code>ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Spring æœ‰ä¸¤ç§ Bean å£°æ˜æ–¹å¼ï¼š</p><ul><li>é…ç½®æ–‡ä»¶å¼å£°æ˜ï¼š<code>&lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.StudentService&quot;/&gt;</code></li><li>è‡ªå®šä¹‰æ³¨è§£æ–¹å¼ï¼š<code>&lt;tx:annotation-driven&gt;</code></li></ul><p>ä¸¤ç§æ–¹å¼çš„è¯»å–å’Œè§£æéƒ½å­˜åœ¨è¾ƒå¤§çš„å·®å¼‚ï¼Œæ‰€ä»¥é‡‡ç”¨ä¸åŒçš„è§£ææ–¹æ³•ï¼Œå¦‚æœæ ¹èŠ‚ç‚¹æˆ–è€…å­èŠ‚ç‚¹é‡‡ç”¨é»˜è®¤å‘½åç©ºé—´çš„è¯ï¼Œåˆ™è°ƒç”¨ <code>parseDefaultElement()</code> è¿›è¡Œè§£æï¼Œå¦åˆ™è°ƒç”¨ <code>delegate.parseCustomElement()</code> æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰è§£æã€‚ è‡³æ­¤ï¼Œ<code>doLoadBeanDefinitions()</code> ä¸­åšçš„ä¸‰ä»¶äº‹æƒ…å·²ç»å…¨éƒ¨åˆ†æå®Œæ¯•ï¼Œä¸‹é¢å°†å¯¹ <code>Bean</code> çš„è§£æè¿‡ç¨‹åšè¯¦ç»†åˆ†æè¯´æ˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è·å–Documentå¯¹è±¡</title>
      <link href="/blog/2020/01/05/13336b20.html"/>
      <url>/blog/2020/01/05/13336b20.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨ <code>XmlBeanDefinitionReader.doLoadDocument()</code> æ–¹æ³•ä¸­åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯è°ƒç”¨ <code>getValidationModeForResource()</code> è·å– <code>XML</code> çš„éªŒè¯æ¨¡å¼ï¼ŒäºŒæ˜¯è°ƒç”¨ <code>DocumentLoader.loadDocument()</code> è·å– <code>Document</code> å¯¹è±¡ã€‚ä¸Šç¯‡åšå®¢å·²ç»åˆ†æäº†è·å– <code>XML</code> éªŒè¯æ¨¡å¼ï¼ˆ<a href="/2020/01/04/4e0696ee.html">IOC ä¹‹ è·å–éªŒè¯æ¨¡å‹</a>ï¼‰ï¼Œè¿™ç¯‡æˆ‘ä»¬åˆ†æè·å– <code>Document</code> å¯¹è±¡ã€‚ </p><h2 id="DocumentLoader"><a href="#DocumentLoader" class="headerlink" title="DocumentLoader"></a>DocumentLoader</h2><p>è·å– <code>Document</code> çš„ç­–ç•¥ç”±æ¥å£ <code>DocumentLoader</code> å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DocumentLoader</span> </span>&#123;</span><br><span class="line">    <span class="function">Document <span class="title">loadDocument</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            InputSource inputSource, EntityResolver entityResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">            ErrorHandler errorHandler, <span class="keyword">int</span> validationMode, <span class="keyword">boolean</span> namespaceAware)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DocumentLoader</code> ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•</p><p><code>loadDocument()</code> ï¼Œè¯¥æ–¹æ³•æ¥æ”¶äº”ä¸ªå‚æ•°ï¼š </p><ol><li><strong>inputSource</strong>ï¼šåŠ è½½ Document çš„ Resource æº </li><li><strong>entityResolver</strong>ï¼šè§£ææ–‡ä»¶çš„è§£æå™¨ </li><li><strong>errorHandler</strong>ï¼šå¤„ç†åŠ è½½ Document å¯¹è±¡çš„è¿‡ç¨‹çš„é”™è¯¯ </li><li><strong>validationMode</strong>ï¼šéªŒè¯æ¨¡å¼ </li><li><strong>namespaceAware</strong>ï¼šå‘½åç©ºé—´æ”¯æŒã€‚</li></ol><p>å¦‚æœè¦æä¾›å¯¹ <code>XML</code> åç§°ç©ºé—´çš„æ”¯æŒï¼Œåˆ™ä¸º<code>true</code> è¯¥æ–¹æ³•ç”± <code>DocumentLoader</code> çš„é»˜è®¤å®ç°ç±» <code>DefaultDocumentLoader</code> å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">loadDocument</span><span class="params">(InputSource inputSource, </span></span></span><br><span class="line"><span class="function"><span class="params">                             EntityResolver entityResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ErrorHandler errorHandler, </span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> validationMode, </span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> namespaceAware)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">  DocumentBuilderFactory factory = </span><br><span class="line">    createDocumentBuilderFactory(validationMode, namespaceAware);</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Using JAXP provider [&quot;</span> </span><br><span class="line">                 + factory.getClass().getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DocumentBuilder builder = </span><br><span class="line">    createDocumentBuilder(factory, entityResolver, errorHandler);</span><br><span class="line">  <span class="keyword">return</span> builder.parse(inputSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨</p><p><code>createDocumentBuilderFactory()</code> åˆ›å»º <code>DocumentBuilderFactory</code> ï¼Œå†é€šè¿‡è¯¥ <code>factory</code> åˆ›å»º <code>DocumentBuilder</code>ï¼Œæœ€åè§£æ <code>InputSource</code> è¿”å› <code>Document</code> å¯¹è±¡ã€‚</p><h2 id="EntityResolver"><a href="#EntityResolver" class="headerlink" title="EntityResolver"></a>EntityResolver</h2><p><code>loadDocument()</code> è·å– <code>Document</code> å¯¹è±¡æ—¶ï¼Œæœ‰ä¸€ä¸ªå‚æ•° <code>entityResolver</code> ï¼Œè¯¥å‚æ•°æ˜¯é€šè¿‡ <code>getEntityResolver()</code> è·å–çš„ã€‚</p><blockquote><p><code>getEntityResolver()</code> è¿”å›æŒ‡å®šçš„è§£æå™¨ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ„é€ ä¸€ä¸ªæœªæŒ‡å®šçš„é»˜è®¤è§£æå™¨ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> EntityResolver <span class="title">getEntityResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.entityResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">    ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">    <span class="keyword">if</span> (resourceLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.entityResolver = <span class="keyword">new</span> ResourceEntityResolver(resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.entityResolver = <span class="keyword">new</span> DelegatingEntityResolver(getBeanClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.entityResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ ResourceLoader ä¸ä¸º <strong>null</strong>ï¼Œåˆ™æ ¹æ®æŒ‡å®šçš„ ResourceLoader åˆ›å»ºä¸€ä¸ª ResourceEntityResolverã€‚</li><li>å¦‚æœ ResourceLoader ä¸º<strong>null</strong>ï¼Œåˆ™åˆ›å»º ä¸€ä¸ª DelegatingEntityResolverï¼Œè¯¥ Resolver å§”æ‰˜ç»™é»˜è®¤çš„ BeansDtdResolver å’Œ PluggableSchemaResolver ã€‚</li></ul><h3 id="æ¶‰åŠå­ç±»"><a href="#æ¶‰åŠå­ç±»" class="headerlink" title="æ¶‰åŠå­ç±»"></a>æ¶‰åŠå­ç±»</h3><ul><li>ResourceEntityResolverï¼šç»§æ‰¿è‡ª EntityResolver ï¼Œé€šè¿‡ ResourceLoader æ¥è§£æå®ä½“çš„å¼•ç”¨ã€‚</li><li>DelegatingEntityResolverï¼šEntityResolver çš„å®ç°ï¼Œåˆ†åˆ«ä»£ç†äº† dtd çš„ BeansDtdResolver å’Œ xml schemas çš„ PluggableSchemaResolverã€‚</li><li>BeansDtdResolver ï¼š spring bean dtd è§£æå™¨ã€‚EntityResolver çš„å®ç°ï¼Œç”¨æ¥ä» classpath æˆ–è€… jar æ–‡ä»¶åŠ è½½ dtdã€‚</li><li>PluggableSchemaResolverï¼šä½¿ç”¨ä¸€ç³»åˆ— Map æ–‡ä»¶å°† schema url è§£æåˆ°æœ¬åœ° classpath èµ„æº</li></ul><p><code>getEntityResolver()</code> è¿”å› EntityResolver ï¼Œé‚£è¿™ä¸ª EntityResolver åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>If a SAX application needs to implement customized handling for external entities, it must implement this interface and register an instance with the SAX driver using the setEntityResolver method.<br>å°±æ˜¯è¯´ï¼šå¦‚æœ SAX åº”ç”¨ç¨‹åºéœ€è¦å®ç°è‡ªå®šä¹‰å¤„ç†å¤–éƒ¨å®ä½“ï¼Œåˆ™å¿…é¡»å®ç°æ­¤æ¥å£å¹¶ä½¿ç”¨ <code>setEntityResolver()</code> å‘ SAX é©±åŠ¨å™¨æ³¨å†Œä¸€ä¸ªå®ä¾‹ã€‚ å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyResolver</span> <span class="keyword">implements</span> <span class="title">EntityResolver</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span> <span class="params">(String publicId, String systemId)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (systemId.equals(<span class="string">&quot;http://www.myhost.com/today&quot;</span>))&#123;</span><br><span class="line">      MyReader reader = <span class="keyword">new</span> MyReader();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> InputSource(reader);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// use the default behaviour</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é¦–å…ˆå°†</p><p><code>spring-student.xml</code> æ–‡ä»¶ä¸­çš„ XSD å£°æ˜çš„åœ°å€æ”¹æ‰ï¼Œå¦‚ä¸‹ï¼š</p><p> <img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/MdkyLc.jpg" alt="MdkyLc"></p><p>å¦‚æœæˆ‘ä»¬å†æ¬¡è¿è¡Œï¼Œåˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/xpMUPz.jpg" alt="xpMUPz"></p><p>ä»ä¸Šé¢çš„é”™è¯¯å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨è¿›è¡Œæ–‡æ¡£éªŒè¯æ—¶ï¼Œæ— æ³•æ ¹æ®å£°æ˜æ‰¾åˆ° XSD éªŒè¯æ–‡ä»¶è€Œå¯¼è‡´æ— æ³•è¿›è¡Œ XML æ–‡ä»¶éªŒè¯ã€‚åœ¨(<a href="/archives/4e0696ee.html">IOC ä¹‹ è·å–éªŒè¯æ¨¡å‹</a>)ä¸­è®²åˆ°ï¼Œå¦‚æœè¦è§£æä¸€ä¸ª XML æ–‡ä»¶ï¼ŒSAX é¦–å…ˆä¼šè¯»å–è¯¥ XML æ–‡æ¡£ä¸Šçš„å£°æ˜ï¼Œç„¶åæ ¹æ®å£°æ˜å»å¯»æ‰¾ç›¸åº”çš„ DTD å®šä¹‰ï¼Œä»¥ä¾¿å¯¹æ–‡æ¡£è¿›è¡ŒéªŒè¯ã€‚é»˜è®¤çš„åŠ è½½è§„åˆ™æ˜¯é€šè¿‡ç½‘ç»œæ–¹å¼ä¸‹è½½éªŒè¯æ–‡ä»¶ï¼Œè€Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¼šé‡åˆ°ç½‘ç»œä¸­æ–­æˆ–è€…ä¸å¯ç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆå°±åº”ç”¨å°±ä¼šå› ä¸ºæ— æ³•ä¸‹è½½éªŒè¯æ–‡ä»¶è€ŒæŠ¥é”™ã€‚</p><blockquote><p>EntityResolver çš„ä½œç”¨å°±æ˜¯åº”ç”¨æœ¬èº«å¯ä»¥æä¾›ä¸€ä¸ªå¦‚ä½•å¯»æ‰¾éªŒè¯æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³è‡ªå®šä¹‰å®ç°ã€‚ æ¥å£å£°æ˜å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EntityResolver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> InputSource <span class="title">resolveEntity</span> <span class="params">(String publicId,String systemId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SAXException, IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•° publicId å’Œ systemIdï¼Œå¹¶è¿”å› InputSource å¯¹è±¡ã€‚ä¸¤ä¸ªå‚æ•°å£°æ˜å¦‚ä¸‹ï¼š</p><ul><li><p>publicIdï¼šè¢«å¼•ç”¨çš„å¤–éƒ¨å®ä½“çš„å…¬å…±æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æä¾›ï¼Œåˆ™è¿”å›null</p></li><li><p>systemIdï¼šè¢«å¼•ç”¨çš„å¤–éƒ¨å®ä½“çš„ç³»ç»Ÿæ ‡è¯†ç¬¦ è¿™ä¸¤ä¸ªå‚æ•°çš„å®é™…å†…å®¹å’Œå…·ä½“çš„éªŒè¯æ¨¡å¼æœ‰å…³ç³»ã€‚å¦‚ä¸‹</p></li><li><p>XSD éªŒè¯æ¨¡å¼</p><ul><li>publicIdï¼šnull</li><li>systemIdï¼š<a href="http://www.springframework.org/schema/beans/spring-beans.xsd">http://www.springframework.org/schema/beans/spring-beans.xsd</a></li></ul></li><li><p>DTD éªŒè¯æ¨¡å¼ </p><ul><li>publicIdï¼š-//SPRING//DTD BEAN 2.0//EN</li></ul></li><li><p>systemIdï¼š<a href="http://www.springframework.org/dtd/spring-beans.dtd">http://www.springframework.org/dtd/spring-beans.dtd</a> å¦‚ä¸‹ï¼š </p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/7nooAW.jpg" alt="7nooAW"><a href="https://gitee.com/chenssy/blog-home/raw/master/image/201811/spring-201806071003.png"><img src="https://gitee.com/chenssy/blog-home/raw/master/image/201811/spring-201806071003.png" alt="spring-201806071003"></a>æˆ‘ä»¬çŸ¥é“åœ¨ Spring ä¸­ä½¿ç”¨ DelegatingEntityResolver ä¸º EntityResolver çš„å®ç°ç±»ï¼Œ<code>resolveEntity()</code> å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span><span class="params">(String publicId, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Nullable</span> String systemId)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> SAXException, IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (systemId != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (systemId.endsWith(DTD_SUFFIX)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.dtdResolver.resolveEntity(publicId, systemId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (systemId.endsWith(XSD_SUFFIX)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.schemaResolver.resolveEntity(publicId, systemId);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„éªŒè¯æ¨¡å¼ä½¿ç”¨ä¸åŒçš„è§£æå™¨è§£æï¼Œå¦‚æœæ˜¯ DTD éªŒè¯æ¨¡å¼åˆ™ä½¿ç”¨ BeansDtdResolver æ¥è¿›è¡Œè§£æï¼Œå¦‚æœæ˜¯ XSD åˆ™ä½¿ç”¨ PluggableSchemaResolver æ¥è¿›è¡Œè§£æã€‚ BeansDtdResolver çš„è§£æè¿‡ç¨‹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span><span class="params">(String publicId,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Nullable</span> String systemId)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Trying to resolve XML entity with public ID [&quot;</span> </span><br><span class="line">                 + publicId +</span><br><span class="line">                 <span class="string">&quot;] and system ID [&quot;</span> </span><br><span class="line">                 + systemId + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (systemId != <span class="keyword">null</span> &amp;&amp; systemId.endsWith(DTD_EXTENSION)) &#123;</span><br><span class="line">    <span class="keyword">int</span> lastPathSeparator = systemId.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">int</span> dtdNameStart = systemId.indexOf(DTD_NAME, lastPathSeparator);</span><br><span class="line">    <span class="keyword">if</span> (dtdNameStart != -<span class="number">1</span>) &#123;</span><br><span class="line">      String dtdFile = DTD_NAME + DTD_EXTENSION;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Trying to locate [&quot;</span> + dtdFile + <span class="string">&quot;] in Spring jar on classpath&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(dtdFile, getClass());</span><br><span class="line">        InputSource source = <span class="keyword">new</span> InputSource(resource.getInputStream());</span><br><span class="line">        source.setPublicId(publicId);</span><br><span class="line">        source.setSystemId(systemId);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Found beans DTD [&quot;</span> + systemId + <span class="string">&quot;] in classpath: &quot;</span> + dtdFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Could not resolve beans DTD [&quot;</span> </span><br><span class="line">                       + systemId + <span class="string">&quot;]: not found in classpath&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  or wherever.</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŠ è½½ DTD ç±»å‹çš„</p><p><code>BeansDtdResolver.resolveEntity()</code> åªæ˜¯å¯¹ systemId è¿›è¡Œäº†ç®€å•çš„æ ¡éªŒï¼ˆä»æœ€åä¸€ä¸ª / å¼€å§‹ï¼Œå†…å®¹ä¸­æ˜¯å¦åŒ…å« <code>spring-beans</code>ï¼‰ï¼Œç„¶åæ„é€ ä¸€ä¸ª InputSource å¹¶è®¾ç½® publicIdã€systemIdï¼Œç„¶åè¿”å›ã€‚ PluggableSchemaResolver çš„è§£æè¿‡ç¨‹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span><span class="params">(String publicId, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Nullable</span> String systemId)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Trying to resolve XML entity with public id [&quot;</span> </span><br><span class="line">                 + publicId +</span><br><span class="line">                 <span class="string">&quot;] and system id [&quot;</span> </span><br><span class="line">                 + systemId + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (systemId != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String resourceLocation = getSchemaMappings().get(systemId);</span><br><span class="line">    <span class="keyword">if</span> (resourceLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Resource resource = <span class="keyword">new</span> ClassPathResource(resourceLocation, </span><br><span class="line">                                                <span class="keyword">this</span>.classLoader);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        InputSource source = <span class="keyword">new</span> InputSource(resource.getInputStream());</span><br><span class="line">        source.setPublicId(publicId);</span><br><span class="line">        source.setSystemId(systemId);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Found XML schema [&quot;</span> </span><br><span class="line">                       + systemId + <span class="string">&quot;] in classpath: &quot;</span> </span><br><span class="line">                       + resourceLocation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (FileNotFoundException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Couldn&#x27;t find XML schema [&quot;</span></span><br><span class="line">                       + systemId + <span class="string">&quot;]: &quot;</span> + resource, ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨ getSchemaMappings() è·å–ä¸€ä¸ªæ˜ å°„è¡¨(systemId ä¸å…¶åœ¨æœ¬åœ°çš„å¯¹ç…§å…³ç³»)ï¼Œç„¶åæ ¹æ®ä¼ å…¥çš„ systemId è·å–è¯¥ systemId åœ¨æœ¬åœ°çš„è·¯å¾„ resourceLocationï¼Œæœ€åæ ¹æ® resourceLocation æ„é€  InputSource å¯¹è±¡ã€‚ æ˜ å°„è¡¨å¦‚ä¸‹ï¼ˆéƒ¨åˆ†ï¼‰:</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/c1mMOc.jpg" alt="c1mMOc"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹è·å–éªŒè¯æ¨¡å‹</title>
      <link href="/blog/2020/01/04/4e0696ee.html"/>
      <url>/blog/2020/01/04/4e0696ee.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2658">http://cmsblogs.com/?p=2658</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>åœ¨ä¸Šç¯‡åšå®¢<a href="/2020/01/03/a6d994a0.html">IOC ä¹‹ åŠ è½½ BeanDefinition</a> ä¸­æåˆ°ï¼Œåœ¨æ ¸å¿ƒé€»è¾‘æ–¹æ³• <code>doLoadBeanDefinitions()</code>ä¸­ä¸»è¦æ˜¯åšä¸‰ä»¶äº‹æƒ…ã€‚</p><ol><li>è°ƒç”¨ <code>getValidationModeForResource()</code> è·å– xml æ–‡ä»¶çš„éªŒè¯æ¨¡å¼</li><li>è°ƒç”¨ <code>loadDocument()</code> æ ¹æ® xml æ–‡ä»¶è·å–ç›¸åº”çš„ Document å®ä¾‹ã€‚</li><li>è°ƒç”¨ <code>registerBeanDefinitions()</code> æ³¨å†Œ Bean å®ä¾‹ã€‚</li></ol><p>è¿™ç¯‡åšå®¢ä¸»è¦åˆ†æè·å– <code>xml</code> æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ã€‚</p><blockquote><p>XML æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ä¿è¯äº† XML æ–‡ä»¶çš„æ­£ç¡®æ€§</p></blockquote><h2 id="DTD-ä¸-XSD-çš„åŒºåˆ«"><a href="#DTD-ä¸-XSD-çš„åŒºåˆ«" class="headerlink" title="DTD ä¸ XSD çš„åŒºåˆ«"></a>DTD ä¸ XSD çš„åŒºåˆ«</h2><p><strong>DTD</strong>(<em>Document Type Definition</em>)ï¼Œå³æ–‡æ¡£ç±»å‹å®šä¹‰ï¼Œä¸º <code>XML</code> æ–‡ä»¶çš„éªŒè¯æœºåˆ¶ï¼Œå±äº <code>XML</code> æ–‡ä»¶ä¸­ç»„æˆçš„ä¸€éƒ¨åˆ†ã€‚<code>DTD</code> æ˜¯ä¸€ç§ä¿è¯ <code>XML</code> æ–‡æ¡£æ ¼å¼æ­£ç¡®çš„æœ‰æ•ˆéªŒè¯æ–¹å¼ï¼Œå®ƒå®šä¹‰äº†ç›¸å…³ <code>XML</code> æ–‡æ¡£çš„å…ƒç´ ã€å±æ€§ã€æ’åˆ—æ–¹å¼ã€å…ƒç´ çš„å†…å®¹ç±»å‹ä»¥åŠå…ƒç´ çš„å±‚æ¬¡ç»“æ„ã€‚å…¶å® <code>DTD</code> å°±ç›¸å½“äº <code>XML</code> ä¸­çš„ â€œè¯æ±‡â€å’Œâ€œè¯­æ³•â€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”è¾ƒ <code>XML</code> æ–‡ä»¶å’Œ <code>DTD</code> æ–‡ä»¶ æ¥çœ‹æ–‡æ¡£æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œå…ƒç´ å’Œæ ‡ç­¾ä½¿ç”¨æ˜¯å¦æ­£ç¡®ã€‚ è¦åœ¨ <code>Spring</code> ä¸­ä½¿ç”¨ <code>DTD</code>ï¼Œéœ€è¦åœ¨ <code>Spring XML</code> æ–‡ä»¶å¤´éƒ¨å£°æ˜ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">beans</span> <span class="meta-keyword">PUBLIC</span>  <span class="meta-string">&quot;-//SPRING//DTD BEAN//EN&quot;</span> <span class="meta-string">&quot;http://www.springframework.org/dtd/spring-beans.dtd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>DTD</code> åœ¨ä¸€å®šçš„é˜¶æ®µæ¨åŠ¨äº† <code>XML</code> çš„å‘å±•ï¼Œä½†æ˜¯å®ƒæœ¬èº«å­˜åœ¨ç€ä¸€äº›ç¼ºé™·ï¼š</p><ol><li>å®ƒæ²¡æœ‰ä½¿ç”¨ <code>XML</code> æ ¼å¼ï¼Œè€Œæ˜¯è‡ªå·±å®šä¹‰äº†ä¸€å¥—æ ¼å¼ï¼Œç›¸å¯¹è§£æå™¨çš„é‡ç”¨æ€§è¾ƒå·®ï¼›è€Œä¸” <code>DTD</code> çš„æ„å»ºå’Œè®¿é—®æ²¡æœ‰æ ‡å‡†çš„ç¼–ç¨‹æ¥å£ï¼Œå› è€Œè§£æå™¨å¾ˆéš¾ç®€å•çš„è§£æ <code>DTD</code> æ–‡æ¡£ã€‚</li><li><code>DTD</code> å¯¹å…ƒç´ çš„ç±»å‹é™åˆ¶è¾ƒå°‘ï¼›åŒæ—¶å…¶ä»–çš„çº¦æŸåŠ›ä¹Ÿå«å¼±ã€‚</li><li><code>DTD</code> æ‰©å±•èƒ½åŠ›è¾ƒå·®ã€‚</li><li>åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„ <code>DTD</code> æ–‡æ¡£çš„æè¿°èƒ½åŠ›æœ‰é™ã€‚</li></ol><p>é’ˆå¯¹ DTD çš„ç¼ºé™·ï¼ŒW3C åœ¨ 2001 å¹´æ¨å‡º XSDã€‚XSDï¼ˆXML Schemas Definitionï¼‰å³ XML Schema è¯­è¨€ã€‚XML Schema æœ¬èº«å°±æ˜¯ä¸€ä¸ª XMLæ–‡æ¡£ï¼Œä½¿ç”¨çš„æ˜¯ XML è¯­æ³•ï¼Œå› æ­¤å¯ä»¥å¾ˆæ–¹ä¾¿çš„è§£æ XSD æ–‡æ¡£ã€‚</p><p><strong>ç›¸å¯¹äº DTDï¼ŒXSD å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</strong></p><ul><li>XML SchemaåŸºäºXML,æ²¡æœ‰ä¸“é—¨çš„è¯­æ³•</li><li>XML Schemaå¯ä»¥è±¡å…¶ä»–XMLæ–‡ä»¶ä¸€æ ·è§£æå’Œå¤„ç†</li><li>XML Schemaæ¯”DTDæä¾›äº†æ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹.</li><li>XML Schemaæä¾›å¯æ‰©å……çš„æ•°æ®æ¨¡å‹ã€‚</li><li>XML Schemaæ”¯æŒç»¼åˆå‘½åç©ºé—´</li><li>XML Schemaæ”¯æŒå±æ€§ç»„ã€‚</li></ul><h2 id="getValidationModeForResource-åˆ†æ"><a href="#getValidationModeForResource-åˆ†æ" class="headerlink" title="getValidationModeForResource() åˆ†æ"></a>getValidationModeForResource() åˆ†æ</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getValidationModeForResource</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–æŒ‡å®šçš„éªŒè¯æ¨¡å¼</span></span><br><span class="line">  <span class="keyword">int</span> validationModeToUse = getValidationMode();</span><br><span class="line">  <span class="comment">// å¦‚æœæ‰‹åŠ¨æŒ‡å®šï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (validationModeToUse != VALIDATION_AUTO) &#123;</span><br><span class="line">    <span class="keyword">return</span> validationModeToUse;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é€šè¿‡ç¨‹åºæ£€æµ‹</span></span><br><span class="line">  <span class="keyword">int</span> detectedMode = detectValidationMode(resource);</span><br><span class="line">  <span class="keyword">if</span> (detectedMode != VALIDATION_AUTO) &#123;</span><br><span class="line">    <span class="keyword">return</span> detectedMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œè¿”å› XSD</span></span><br><span class="line">  <span class="keyword">return</span> VALIDATION_XSD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæŒ‡å®šäº† XML æ–‡ä»¶çš„çš„éªŒè¯æ¨¡å¼ï¼ˆè°ƒç”¨<code>XmlBeanDefinitionReader.setValidating(boolean validating)</code>ï¼‰åˆ™ç›´æ¥è¿”å›æŒ‡å®šçš„éªŒè¯æ¨¡å¼ï¼Œå¦åˆ™è°ƒç”¨ <code>detectValidationMode()</code> è·å–ç›¸åº”çš„éªŒè¯æ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">detectValidationMode</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (resource.isOpen()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;Passed-in Resource [&quot;</span> + resource + <span class="string">&quot;] contains an open stream: &quot;</span> </span><br><span class="line">      +</span><br><span class="line">      <span class="string">&quot;cannot determine validation mode automatically. Either pass in a Resource &quot;</span> </span><br><span class="line">      +</span><br><span class="line">      <span class="string">&quot;that is able to create fresh streams, or explicitly specify the validationMode &quot;</span> </span><br><span class="line">      +</span><br><span class="line">      <span class="string">&quot;on your XmlBeanDefinitionReader instance.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  InputStream inputStream;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    inputStream = resource.getInputStream();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;Unable to determine validation mode for [&quot;</span> </span><br><span class="line">      + resource </span><br><span class="line">      + <span class="string">&quot;]: cannot open InputStream. &quot;</span> </span><br><span class="line">      +</span><br><span class="line">      <span class="string">&quot;Did you attempt to load directly from a SAX InputSource without specifying the &quot;</span> </span><br><span class="line">      +</span><br><span class="line">      <span class="string">&quot;validationMode on your XmlBeanDefinitionReader instance?&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.validationModeDetector.detectValidationMode(inputStream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;Unable to determine validation mode for [&quot;</span> </span><br><span class="line">      + resource </span><br><span class="line">      + <span class="string">&quot;]: an error occurred whilst reading from the InputStream.&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢ä¸€å¤§å †çš„ä»£ç ï¼Œæ ¸å¿ƒåœ¨äº <code>this.validationModeDetector.detectValidationMode(inputStream)</code>ï¼Œ<code>validationModeDetector</code> å®šä¹‰ä¸º <code>XmlValidationModeDetector</code>,æ‰€ä»¥éªŒè¯æ¨¡å¼çš„è·å–å§”æ‰˜ç»™ <code>XmlValidationModeDetector</code> çš„ <code>detectValidationMode()</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">detectValidationMode</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">boolean</span> isDtdValidated = <span class="keyword">false</span>;</span><br><span class="line">    String content;</span><br><span class="line">    <span class="comment">// ä¸€è¡Œä¸€è¡Œè¯»å– xml æ–‡ä»¶çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">while</span> ((content = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      content = consumeCommentTokens(content);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.inComment || !StringUtils.hasText(content)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åŒ…å« DOCTYPE ä¸º DTD æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">if</span> (hasDoctype(content)) &#123;</span><br><span class="line">        isDtdValidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¯»å– &lt; å¼€å§‹ç¬¦å·ï¼ŒéªŒè¯æ¨¡å¼ä¸€å®šä¼šåœ¨ &lt; ç¬¦å·ä¹‹å‰</span></span><br><span class="line">      <span class="keyword">if</span> (hasOpeningTag(content)) &#123;</span><br><span class="line">        <span class="comment">// End of meaningful data...</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸º true è¿”å› DTDï¼Œå¦åˆ™è¿”å› XSD</span></span><br><span class="line">    <span class="keyword">return</span> (isDtdValidated ? VALIDATION_DTD : VALIDATION_XSD);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (CharConversionException ex) &#123;</span><br><span class="line">    <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œä¸º XSD</span></span><br><span class="line">    <span class="keyword">return</span> VALIDATION_AUTO;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    reader.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­çœ‹ï¼Œä¸»è¦æ˜¯é€šè¿‡è¯»å– <code>XML</code> æ–‡ä»¶çš„å†…å®¹ï¼Œåˆ¤æ–­å†…å®¹ä¸­æ˜¯å¦åŒ…å«æœ‰ <code>DOCTYPE</code> ï¼Œå¦‚æœæ˜¯ åˆ™ä¸º <code>DTD</code>ï¼Œå¦åˆ™ä¸º <code>XSD</code>ï¼Œå½“ç„¶åªä¼šè¯»å–åˆ° ç¬¬ä¸€ä¸ª â€œ<code>&lt;</code>â€œ å¤„ï¼Œå› ä¸º éªŒè¯æ¨¡å¼ä¸€å®šä¼šåœ¨ç¬¬ä¸€ä¸ª â€œ<code>&lt;</code>â€ ä¹‹å‰ã€‚å¦‚æœå½“ä¸­å‡ºç°äº† <code>CharConversionException</code> å¼‚å¸¸ï¼Œåˆ™ä¸º <code>XSD</code>æ¨¡å¼ã€‚ å¥½äº†ï¼Œ<code>XML</code> æ–‡ä»¶çš„éªŒè¯æ¨¡å¼åˆ†æå®Œæ¯•ï¼Œä¸‹ç¯‡åˆ†æ <code>doLoadBeanDefinitions()</code> çš„ç¬¬äºŒä¸ªæ­¥éª¤ï¼šè·å– <code>Document</code> å®ä¾‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IoCä¹‹åŠ è½½BeanDefinition</title>
      <link href="/blog/2020/01/03/a6d994a0.html"/>
      <url>/blog/2020/01/03/a6d994a0.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2658">http://cmsblogs.com/?p=2658</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><hr><p>å¼€å±€å…ˆçœ‹ä¸€æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;bean.xml&quot;</span>);</span><br><span class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">reader.loadBeanDefinitions(resource);</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯ <code>Spring</code> ä¸­ç¼–ç¨‹å¼ä½¿ç”¨ <code>IOC</code> å®¹å™¨ï¼Œé€šè¿‡è¿™å››æ®µç®€å•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆæ­¥åˆ¤æ–­ <code>IOC</code> å®¹å™¨çš„ä½¿ç”¨è¿‡ç¨‹ã€‚</p><ul><li><p>è·å–èµ„æº</p></li><li><p>è·å– <code>BeanFactory</code></p></li><li><p>æ ¹æ®æ–°å»ºçš„ <code>BeanFactory</code> åˆ›å»ºä¸€ä¸ª<code>BeanDefinitionReader</code>å¯¹è±¡ï¼Œè¯¥<code>Reader</code> å¯¹è±¡ä¸ºèµ„æºçš„è§£æå™¨</p></li><li><p>è£…è½½èµ„æº æ•´ä¸ªè¿‡ç¨‹å°±åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šèµ„æºå®šä½ã€è£…è½½ã€æ³¨å†Œï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/H2Cvub.jpg" alt="H2Cvub"></p></li></ul><ul><li><p><strong>èµ„æºå®šä½</strong>ã€‚æˆ‘ä»¬ä¸€èˆ¬ç”¨å¤–éƒ¨èµ„æºæ¥æè¿° <code>Bean</code> å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– <code>IOC</code> å®¹å™¨çš„ç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦å®šä½è¿™ä¸ªå¤–éƒ¨èµ„æºã€‚åœ¨ï¼ˆ<a href="/2020/01/02/8f7aa5ac.html"> IOC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥</a>ï¼‰å·²ç»è¯¦ç»†è¯´æ˜äº†èµ„æºåŠ è½½çš„è¿‡ç¨‹ã€‚ </p></li><li><p><strong>è£…è½½</strong>ã€‚è£…è½½å°±æ˜¯ <code>BeanDefinition</code> çš„è½½å…¥ã€‚<code>BeanDefinitionReader</code> è¯»å–ã€è§£æ <code>Resource</code> èµ„æºï¼Œä¹Ÿå°±æ˜¯å°†ç”¨æˆ·å®šä¹‰çš„ <code>Bean</code> è¡¨ç¤ºæˆ <code>IOC</code> å®¹å™¨çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼š<code>BeanDefinition</code>ã€‚åœ¨ <code>IOC</code> å®¹å™¨å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª <code>BeanDefinition Map</code> çš„æ•°æ®ç»“æ„ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ª éƒ½å¯¹åº”ç€ä¸€ä¸ª<code>BeanDefinition</code>å¯¹è±¡ã€‚</p></li><li><p><strong>æ³¨å†Œ</strong>ã€‚å‘<code>IOC</code>å®¹å™¨æ³¨å†Œåœ¨ç¬¬äºŒæ­¥è§£æå¥½çš„ <code>BeanDefinition</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ <code>BeanDefinitionRegistry</code> æ¥å£æ¥å®ç°çš„ã€‚åœ¨ <code>IOC</code> å®¹å™¨å†…éƒ¨å…¶å®æ˜¯å°†ç¬¬äºŒä¸ªè¿‡ç¨‹è§£æå¾—åˆ°çš„ <code>BeanDefinition</code> æ³¨å…¥åˆ°ä¸€ä¸ª <code>HashMap</code> å®¹å™¨ä¸­ï¼Œ<code>IOC</code> å®¹å™¨å°±æ˜¯é€šè¿‡è¿™ä¸ª <code>HashMap</code> æ¥ç»´æŠ¤è¿™äº› <code>BeanDefinition</code> çš„ã€‚åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰å®Œæˆä¾èµ–æ³¨å…¥ï¼Œä¾èµ–æ³¨å†Œæ˜¯å‘ç”Ÿåœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>getBean()</code> å‘å®¹å™¨ç´¢è¦ <code>Bean</code> æ—¶ã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®é¢„å¤„ç†ï¼Œå³å¯¹æŸä¸ª <code>Bean</code> è®¾ç½® <code>lazyinit</code> å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Bean</code> çš„ä¾èµ–æ³¨å…¥å°±ä¼šåœ¨å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å®Œæˆã€‚ </p></li></ul><blockquote><p>XML Resource =&gt; XML Document =&gt; Bean Definition ã€‚</p></blockquote><p>èµ„æºå®šä½åœ¨å‰é¢å·²ç»åˆ†æäº†ï¼Œä¸‹é¢æˆ‘ä»¬ç›´æ¥åˆ†æåŠ è½½ï¼Œä¸Šé¢æè¿‡<code>reader.loadBeanDefinitions(resource)</code> æ‰æ˜¯åŠ è½½èµ„æºçš„çœŸæ­£å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä»è¯¥æ–¹æ³•å…¥æ‰‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æŒ‡å®šçš„ <code>xml</code> æ–‡ä»¶åŠ è½½ <code>BeanDefinition</code>ï¼Œè¿™é‡Œä¼šå…ˆå¯¹ <code>Resource</code> èµ„æºå°è£…æˆ <code>EncodedResource</code>ã€‚è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦å°† <code>Resource</code> å°è£…æˆ <code>EncodedResource</code>å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†å¯¹ <code>Resource</code> è¿›è¡Œç¼–ç ï¼Œä¿è¯å†…å®¹è¯»å–çš„æ­£ç¡®æ€§ã€‚å°è£…æˆ <code>EncodedResource</code> åï¼Œè°ƒç”¨<code>loadBeanDefinitions()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„é€»è¾‘å®ç°ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  Assert.notNull(encodedResource, <span class="string">&quot;EncodedResource must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Loading XML bean definitions from &quot;</span> </span><br><span class="line">                + encodedResource.getResource());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å·²ç»åŠ è½½è¿‡çš„èµ„æº</span></span><br><span class="line">  Set&lt;EncodedResource&gt; currentResources = </span><br><span class="line">    <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">  <span class="keyword">if</span> (currentResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">    currentResources = <span class="keyword">new</span> HashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†å½“å‰èµ„æºåŠ å…¥è®°å½•ä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;Detected cyclic loading of &quot;</span> </span><br><span class="line">      + encodedResource + <span class="string">&quot; - check your import definitions!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä» EncodedResource è·å–å°è£…çš„ Resource å¹¶ä» Resource ä¸­è·å–å…¶ä¸­çš„ InputStream</span></span><br><span class="line">    InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">      <span class="comment">// è®¾ç½®ç¼–ç </span></span><br><span class="line">      <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†</span></span><br><span class="line">      <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, </span><br><span class="line">                                   encodedResource.getResource());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      inputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">      <span class="string">&quot;IOException parsing XML document from &quot;</span> </span><br><span class="line">      + encodedResource.getResource(), ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­å‰”é™¤è¯¥èµ„æº</span></span><br><span class="line">    currentResources.remove(encodedResource);</span><br><span class="line">    <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡</p><p><code>resourcesCurrentlyBeingLoaded.get()</code> æ¥è·å–å·²ç»åŠ è½½è¿‡çš„èµ„æºï¼Œç„¶åå°† <code>encodedResource</code> åŠ å…¥å…¶ä¸­ï¼Œå¦‚æœ <code>resourcesCurrentlyBeingLoaded</code> ä¸­å·²ç»å­˜åœ¨è¯¥èµ„æºï¼Œåˆ™æŠ›å‡º <code>BeanDefinitionStoreException</code> å¼‚å¸¸ã€‚å®Œæˆåä» <code>encodedResource</code> è·å–å°è£…çš„ <code>Resource</code> èµ„æºå¹¶ä» <code>Resource</code> ä¸­è·å–ç›¸åº”çš„ <code>InputStream</code> ï¼Œæœ€åå°† <code>InputStream</code> å°è£…ä¸º <code>InputSource</code> è°ƒç”¨ <code>doLoadBeanDefinitions()</code>ã€‚</p><p>æ–¹æ³• <code>doLoadBeanDefinitions()</code> ä¸ºä» <code>xml</code> æ–‡ä»¶ä¸­åŠ è½½ <code>BeanDefinition</code> çš„çœŸæ­£é€»è¾‘ï¼Œå¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– Document å®ä¾‹</span></span><br><span class="line">    Document doc = doLoadDocument(inputSource, resource);</span><br><span class="line">    <span class="comment">// æ ¹æ® Document å®ä¾‹****æ³¨å†Œ Beanä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> registerBeanDefinitions(doc, resource);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (SAXParseException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                                              <span class="string">&quot;Line &quot;</span> + ex.getLineNumber() </span><br><span class="line">                                              + <span class="string">&quot; in XML document from &quot;</span> </span><br><span class="line">                                              + resource + <span class="string">&quot; is invalid&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (SAXException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                                    <span class="string">&quot;XML document from &quot;</span> </span><br><span class="line">                                              + resource + <span class="string">&quot; is invalid&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ParserConfigurationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                                   <span class="string">&quot;Parser configuration exception parsing XML from &quot;</span> </span><br><span class="line">                                           + resource, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                                           <span class="string">&quot;IOException parsing XML document from &quot;</span> </span><br><span class="line">                                           + resource, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                               <span class="string">&quot;Unexpected exception parsing XML document from &quot;</span> </span><br><span class="line">                                           + resource, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯ <code>try</code> å—çš„ä¸¤è¡Œä»£ç ã€‚</p><ol><li>è°ƒç”¨ <code>doLoadDocument()</code> æ–¹æ³•ï¼Œæ ¹æ® <code>xml</code> æ–‡ä»¶è·å– <code>Document</code> å®ä¾‹ã€‚</li><li>æ ¹æ®è·å–çš„ <code>Document</code> å®ä¾‹æ³¨å†Œ <code>Bean</code> ä¿¡æ¯ã€‚ å…¶å®åœ¨ </li></ol><p><code>doLoadDocument()</code>æ–¹æ³•å†…éƒ¨è¿˜è·å–äº† <code>xml</code> æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ã€‚å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Document <span class="title">doLoadDocument</span><span class="params">(InputSource inputSource, Resource resource)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.documentLoader.loadDocument(inputSource,</span><br><span class="line">                                          getEntityResolver(), <span class="keyword">this</span>.errorHandler,</span><br><span class="line">                                          getValidationModeForResource(resource), </span><br><span class="line">                                          isNamespaceAware());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>getValidationModeForResource()</code> è·å–æŒ‡å®šèµ„æºï¼ˆ<code>xml</code>ï¼‰çš„éªŒè¯æ¨¡å¼ã€‚</p><p><strong>æ‰€ä»¥ <code>doLoadBeanDefinitions()</code>ä¸»è¦å°±æ˜¯åšäº†ä¸‰ä»¶äº‹æƒ…ã€‚</strong> </p><ol><li>è°ƒç”¨ <code>getValidationModeForResource()</code> è·å– <code>xml</code> æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ </li><li>è°ƒç”¨ <code>loadDocument()</code> æ ¹æ® <code>xml</code> æ–‡ä»¶è·å–ç›¸åº”çš„ <code>Document</code> å®ä¾‹ã€‚ </li><li>è°ƒç”¨ <code>registerBeanDefinitions()</code> æ³¨å†Œ <code>Bean</code> å®ä¾‹ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹Springç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥</title>
      <link href="/blog/2020/01/02/8f7aa5ac.html"/>
      <url>/blog/2020/01/02/8f7aa5ac.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2656">http://cmsblogs.com/?p=2656</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><p>èµ„æºåŠ è½½ç­–ç•¥éœ€è¦æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š</p><ol><li>èŒèƒ½åˆ’åˆ†æ¸…æ¥šã€‚èµ„æºçš„å®šä¹‰å’Œèµ„æºçš„åŠ è½½åº”è¯¥è¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç•Œé™ï¼›</li><li>ç»Ÿä¸€çš„æŠ½è±¡ã€‚ç»Ÿä¸€çš„èµ„æºå®šä¹‰å’Œèµ„æºåŠ è½½ç­–ç•¥ã€‚èµ„æºåŠ è½½åè¦è¿”å›ç»Ÿä¸€çš„æŠ½è±¡ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦å¯¹èµ„æºè¿›è¡Œæ€æ ·çš„å¤„ç†ï¼Œåº”è¯¥ç”±æŠ½è±¡èµ„æºæ¥å£æ¥ç•Œå®šã€‚</li></ol><h2 id="ç»Ÿä¸€èµ„æºï¼šResource"><a href="#ç»Ÿä¸€èµ„æºï¼šResource" class="headerlink" title="ç»Ÿä¸€èµ„æºï¼šResource"></a>ç»Ÿä¸€èµ„æºï¼šResource</h2><p><code>org.springframework.core.io.Resource</code> ä¸º Spring æ¡†æ¶æ‰€æœ‰èµ„æºçš„æŠ½è±¡å’Œè®¿é—®æ¥å£ï¼Œå®ƒç»§æ‰¿ <code>org.springframework.core.io.InputStreamSource</code>æ¥å£ã€‚ä½œä¸ºæ‰€æœ‰èµ„æºçš„ç»Ÿä¸€æŠ½è±¡ï¼ŒSource å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œç”±å­ç±» <code>AbstractResource</code> æä¾›ç»Ÿä¸€çš„é»˜è®¤å®ç°ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> <span class="keyword">extends</span> <span class="title">InputStreamSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºæ˜¯å¦å¯è¯»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºæ‰€ä»£è¡¨çš„å¥æŸ„æ˜¯å¦è¢«ä¸€ä¸ªstreamæ‰“å¼€äº†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦ä¸º File</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›èµ„æºçš„URLçš„å¥æŸ„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">URL <span class="title">getURL</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›èµ„æºçš„URIçš„å¥æŸ„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">URI <span class="title">getURI</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›èµ„æºçš„Fileçš„å¥æŸ„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">File <span class="title">getFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å› ReadableByteChannel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> ReadableByteChannel <span class="title">readableChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Channels.newChannel(getInputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºå†…å®¹çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®èµ„æºçš„ç›¸å¯¹è·¯å¾„åˆ›å»ºæ–°èµ„æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºçš„æ–‡ä»¶å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getFilename</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºçš„æè¿°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/aN4Hdx.jpg" alt="aN4Hdx"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œ<code>Resource</code> æ ¹æ®èµ„æºçš„ä¸åŒç±»å‹æä¾›ä¸åŒçš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><strong>FileSystemResource</strong>ï¼šå¯¹ <code>java.io.File</code> ç±»å‹èµ„æºçš„å°è£…ï¼Œåªè¦æ˜¯è·Ÿ File æ‰“äº¤é“çš„ï¼ŒåŸºæœ¬ä¸Šä¸ <code>FileSystemResource</code> ä¹Ÿå¯ä»¥æ‰“äº¤é“ã€‚æ”¯æŒæ–‡ä»¶å’Œ <code>URL</code> çš„å½¢å¼ï¼Œå®ç° <code>WritableResource</code> æ¥å£ï¼Œä¸”ä» <em><code>Spring Framework 5.0</code> å¼€å§‹ï¼Œ<code>FileSystemResource</code> ä½¿ç”¨<code>NIO.2 API</code>è¿›è¡Œè¯»/å†™äº¤äº’</em></li><li><strong>ByteArrayResource</strong>ï¼šå¯¹å­—èŠ‚æ•°ç»„æä¾›çš„æ•°æ®çš„å°è£…ã€‚å¦‚æœé€šè¿‡ <code>InputStream</code> å½¢å¼è®¿é—®è¯¥ç±»å‹çš„èµ„æºï¼Œè¯¥å®ç°ä¼šæ ¹æ®å­—èŠ‚æ•°ç»„çš„æ•°æ®æ„é€ ä¸€ä¸ªç›¸åº”çš„ <code>ByteArrayInputStream</code>ã€‚</li><li><strong>UrlResource</strong>ï¼šå¯¹ <code>java.net.URL</code>ç±»å‹èµ„æºçš„å°è£…ã€‚å†…éƒ¨å§”æ´¾ URL è¿›è¡Œå…·ä½“çš„èµ„æºæ“ä½œã€‚</li><li><strong>ClassPathResource</strong>ï¼š<code>class path</code> ç±»å‹èµ„æºçš„å®ç°ã€‚ä½¿ç”¨ç»™å®šçš„ <code>ClassLoader</code> æˆ–è€…ç»™å®šçš„ <code>Class</code> æ¥åŠ è½½èµ„æºã€‚</li><li><strong>InputStreamResource</strong>ï¼šå°†ç»™å®šçš„ <code>InputStream</code> ä½œä¸ºä¸€ç§èµ„æºçš„ <code>Resource</code> çš„å®ç°ç±»ã€‚</li></ul><p><code>AbstractResource</code> ä¸º <code>Resource</code> æ¥å£çš„é»˜è®¤å®ç°ï¼Œå®ƒå®ç°äº† Resource æ¥å£çš„å¤§éƒ¨åˆ†çš„å…¬å…±å®ç°ï¼Œä½œä¸º <code>Resource</code> æ¥å£ä¸­çš„é‡ä¸­ä¹‹é‡ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractResource</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè‹¥åˆ¤æ–­è¿‡ç¨‹äº§ç”Ÿå¼‚å¸¸ï¼ˆå› ä¸ºä¼šè°ƒç”¨SecurityManageræ¥åˆ¤æ–­ï¼‰ï¼Œå°±å…³é—­å¯¹åº”çš„æµ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getFile().exists();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="comment">// Fall back to stream existence: can we open the stream?</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InputStream is = getInputStream();</span><br><span class="line">                is.close();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable isEx) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›´æ¥è¿”å›trueï¼Œè¡¨ç¤ºå¯è¯»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªè¢«æ‰“å¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç›´æ¥è¿”å›falseï¼Œè¡¨ç¤ºä¸ä¸º File</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŠ›å‡º FileNotFoundException å¼‚å¸¸ï¼Œäº¤ç»™å­ç±»å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">getURL</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(getDescription() + <span class="string">&quot; cannot be resolved to URL&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸºäº getURL() è¿”å›çš„ URL æ„å»º URI</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URI <span class="title">getURI</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        URL url = getURL();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ResourceUtils.toURI(url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NestedIOException(<span class="string">&quot;Invalid URI [&quot;</span> + url + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŠ›å‡º FileNotFoundException å¼‚å¸¸ï¼Œäº¤ç»™å­ç±»å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> File <span class="title">getFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(getDescription() </span><br><span class="line">                                        + <span class="string">&quot; cannot be resolved to absolute file path&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ® getInputStream() çš„è¿”å›ç»“æœæ„å»º ReadableByteChannel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReadableByteChannel <span class="title">readableChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Channels.newChannel(getInputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–èµ„æºçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ªèµ„æºå†…å®¹é•¿åº¦å®é™…å°±æ˜¯èµ„æºçš„å­—èŠ‚é•¿åº¦ï¼Œé€šè¿‡å…¨éƒ¨è¯»å–ä¸€éæ¥åˆ¤æ–­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = getInputStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> size = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">255</span>];</span><br><span class="line">            <span class="keyword">int</span> read;</span><br><span class="line">            <span class="keyword">while</span> ((read = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                size += read;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> lastModified = getFileForLastModifiedCheck().lastModified();</span><br><span class="line">        <span class="keyword">if</span> (lastModified == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(</span><br><span class="line">              getDescription()</span><br><span class="line">              +</span><br><span class="line">              <span class="string">&quot; cannot be resolved in the file system for resolving its last-modified timestamp&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastModified;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> File <span class="title">getFileForLastModifiedCheck</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº¤ç»™å­ç±»å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(</span><br><span class="line">          <span class="string">&quot;Cannot create a relative resource for &quot;</span> </span><br><span class="line">          + getDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–èµ„æºåç§°ï¼Œé»˜è®¤è¿”å› null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFilename</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›èµ„æºçš„æè¿°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDescription();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (obj == <span class="keyword">this</span> ||</span><br><span class="line">            (obj <span class="keyword">instanceof</span> Resource &amp;&amp; ((Resource) obj)</span><br><span class="line">             .getDescription().equals(getDescription())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDescription().hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°è‡ªå®šä¹‰çš„ <code>Resource</code>ï¼Œè®°ä½ä¸è¦å®ç° <code>Resource</code> æ¥å£ï¼Œè€Œåº”è¯¥ç»§æ‰¿ <code>AbstractResource</code> æŠ½è±¡ç±»ï¼Œç„¶åæ ¹æ®å½“å‰çš„å…·ä½“èµ„æºç‰¹æ€§è¦†ç›–ç›¸åº”çš„æ–¹æ³•å³å¯ã€‚</p><h2 id="ç»Ÿä¸€èµ„æºå®šä½-ResourceLoader"><a href="#ç»Ÿä¸€èµ„æºå®šä½-ResourceLoader" class="headerlink" title="ç»Ÿä¸€èµ„æºå®šä½(ResourceLoader)"></a>ç»Ÿä¸€èµ„æºå®šä½(ResourceLoader)</h2><p>ä¸€å¼€å§‹å°±è¯´äº† <code>Spring</code> å°†èµ„æºçš„å®šä¹‰å’Œèµ„æºçš„åŠ è½½åŒºåˆ†å¼€äº†ï¼Œ<code>Resource</code> å®šä¹‰äº†ç»Ÿä¸€çš„èµ„æºï¼Œé‚£èµ„æºçš„åŠ è½½åˆ™ç”± <code>ResourceLoader</code> æ¥ç»Ÿä¸€å®šä¹‰ã€‚</p><p><code>org.springframework.core.io.ResourceLoader</code> ä¸º <code>Spring</code> èµ„æºåŠ è½½çš„ç»Ÿä¸€æŠ½è±¡ï¼Œå…·ä½“çš„èµ„æºåŠ è½½åˆ™ç”±ç›¸åº”çš„å®ç°ç±»æ¥å®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°† <code>ResourceLoader</code> ç§°ä½œä¸ºç»Ÿä¸€èµ„æºå®šä½å™¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceLoader</span> </span>&#123;</span><br><span class="line">    String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;</span><br><span class="line"></span><br><span class="line">    <span class="function">Resource <span class="title">getResource</span><span class="params">(String location)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ResourceLoader</code> æ¥å£æä¾›ä¸¤ä¸ªæ–¹æ³•ï¼š<code>getResource()</code>ã€<code>getClassLoader()</code>ã€‚</p><p><code>getResource()</code>æ ¹æ®æ‰€æä¾›èµ„æºçš„è·¯å¾„ <code>location</code> è¿”å› <code>Resource</code> å®ä¾‹ï¼Œä½†æ˜¯å®ƒä¸ç¡®ä¿è¯¥ <code>Resource</code> ä¸€å®šå­˜åœ¨ï¼Œéœ€è¦è°ƒç”¨ <code>Resource.exist()</code>æ–¹æ³•åˆ¤æ–­ã€‚è¯¥æ–¹æ³•æ”¯æŒä»¥ä¸‹æ¨¡å¼çš„èµ„æºåŠ è½½ï¼š</p><ul><li>URLä½ç½®èµ„æºï¼Œå¦‚â€file:C:/test.datâ€</li><li>ClassPathä½ç½®èµ„æºï¼Œå¦‚â€classpath:test.datâ€</li><li>ç›¸å¯¹è·¯å¾„èµ„æºï¼Œå¦‚â€WEB-INF/test.datâ€ï¼Œæ­¤æ—¶è¿”å›çš„Resourceå®ä¾‹æ ¹æ®å®ç°ä¸åŒè€Œä¸åŒ</li></ul><p>è¯¥æ–¹æ³•çš„ä¸»è¦å®ç°æ˜¯åœ¨å…¶å­ç±» <code>DefaultResourceLoader</code> ä¸­å®ç°ï¼Œå…·ä½“è¿‡ç¨‹æˆ‘ä»¬åœ¨åˆ†æ <code>DefaultResourceLoader</code> æ—¶åšè¯¦ç»†è¯´æ˜ã€‚</p><p><code>getClassLoader()</code> è¿”å› <code>ClassLoader</code> å®ä¾‹ï¼Œå¯¹äºæƒ³è¦è·å– <code>ResourceLoader</code> ä½¿ç”¨çš„ <code>ClassLoader</code> ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•æ¥è·å–ï¼Œ</p><p>åœ¨åˆ†æ <code>Resource</code> æ—¶ï¼Œæåˆ°äº†ä¸€ä¸ªç±» <code>ClassPathResource</code> ï¼Œè¿™ä¸ªç±»æ˜¯å¯ä»¥æ ¹æ®æŒ‡å®šçš„ <code>ClassLoader</code> æ¥åŠ è½½èµ„æºçš„ã€‚</p><p>ä½œä¸º <code>Spring</code> ç»Ÿä¸€çš„èµ„æºåŠ è½½å™¨ï¼Œå®ƒæä¾›äº†ç»Ÿä¸€çš„æŠ½è±¡ï¼Œå…·ä½“çš„å®ç°åˆ™ç”±ç›¸åº”çš„å­ç±»æ¥è´Ÿè´£å®ç°ï¼Œå…¶ç±»çš„ç±»ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/R8Oaa0.jpg" alt="R8Oaa0"></p><h3 id="DefaultResourceLoader"><a href="#DefaultResourceLoader" class="headerlink" title="DefaultResourceLoader"></a>DefaultResourceLoader</h3><p><code>DefaultResourceLoader</code> æ˜¯ <code>ResourceLoader</code> çš„é»˜è®¤å®ç°ï¼Œå®ƒæ¥æ”¶ <code>ClassLoader</code> ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°æˆ–è€…ä½¿ç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œåœ¨ä½¿ç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°æ—¶ï¼Œä½¿ç”¨çš„ <code>ClassLoader</code> ä¸ºé»˜è®¤çš„ <code>ClassLoader</code>ï¼ˆä¸€èˆ¬ä¸º<code>Thread.currentThread().getContextClassLoader()</code>ï¼‰ï¼Œå¯ä»¥é€šè¿‡ <code>ClassUtils.getDefaultClassLoader()</code>è·å–ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è°ƒç”¨ <code>setClassLoader()</code>æ–¹æ³•è¿›è¡Œåç»­è®¾ç½®ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultResourceLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.classLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultResourceLoader</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassLoader</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">this</span>.classLoader != <span class="keyword">null</span> ? <span class="keyword">this</span>.classLoader : </span><br><span class="line">          ClassUtils.getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ResourceLoader</code> ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ä¸º <code>getResource()</code>,å®ƒæ ¹æ®æä¾›çš„ <code>location</code> è¿”å›ç›¸åº”çš„ <code>Resource</code>ï¼Œè€Œ <code>DefaultResourceLoader</code> å¯¹è¯¥æ–¹æ³•æä¾›äº†æ ¸å¿ƒå®ç°(å®ƒçš„ä¸¤ä¸ªå­ç±»éƒ½æ²¡æœ‰æä¾›è¦†ç›–è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®š<code>ResourceLoader</code> çš„èµ„æºåŠ è½½ç­–ç•¥å°±å°è£… <code>DefaultResourceLoader</code>ä¸­)ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(location, <span class="string">&quot;Location must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (ProtocolResolver protocolResolver : <span class="keyword">this</span>.protocolResolvers) &#123;</span><br><span class="line">    Resource resource = protocolResolver.resolve(location, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> resource;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (location.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> getResourceByPath(location);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ClassPathResource(location.substring(</span><br><span class="line">      CLASSPATH_URL_PREFIX.length()), getClassLoader());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Try to parse the location as a URL...</span></span><br><span class="line">      URL url = <span class="keyword">new</span> URL(location);</span><br><span class="line">      <span class="keyword">return</span> (ResourceUtils.isFileURL(url) ? </span><br><span class="line">              <span class="keyword">new</span> FileUrlResource(url) : <span class="keyword">new</span> UrlResource(url));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (MalformedURLException ex) &#123;</span><br><span class="line">      <span class="comment">// No URL -&gt; resolve as resource path.</span></span><br><span class="line">      <span class="keyword">return</span> getResourceByPath(location);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡ <code>ProtocolResolver</code> æ¥åŠ è½½èµ„æºï¼ŒæˆåŠŸè¿”å› <code>Resource</code>ï¼Œå¦åˆ™è°ƒç”¨å¦‚ä¸‹é€»è¾‘ï¼š</p><ul><li>è‹¥ <code>location</code> ä»¥ / å¼€å¤´ï¼Œåˆ™è°ƒç”¨ <code>getResourceByPath()</code>æ„é€  <code>ClassPathContextResource</code> ç±»å‹èµ„æºå¹¶è¿”å›ã€‚</li><li>è‹¥ <code>location</code> ä»¥ <code>classpath</code>: å¼€å¤´ï¼Œåˆ™æ„é€  <code>ClassPathResource</code> ç±»å‹èµ„æºå¹¶è¿”å›ï¼Œåœ¨æ„é€ è¯¥èµ„æºæ—¶ï¼Œé€šè¿‡ <code>getClassLoader()</code>è·å–å½“å‰çš„ <code>ClassLoader</code>ã€‚</li><li>æ„é€  <code>URL</code> ï¼Œå°è¯•é€šè¿‡å®ƒè¿›è¡Œèµ„æºå®šä½ï¼Œè‹¥æ²¡æœ‰æŠ›å‡º <code>MalformedURLException</code> å¼‚å¸¸ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ä¸º <code>FileURL</code> , å¦‚æœæ˜¯åˆ™æ„é€  <code>FileUrlResource</code> ç±»å‹èµ„æºï¼Œå¦åˆ™æ„é€  <code>UrlResource</code>ã€‚è‹¥åœ¨åŠ è½½è¿‡ç¨‹ä¸­æŠ›å‡º <code>MalformedURLException</code> å¼‚å¸¸ï¼Œåˆ™å§”æ´¾ <code>getResourceByPath()</code> å®ç°èµ„æºå®šä½åŠ è½½ã€‚</li></ul><p><code>ProtocolResolver</code> ï¼Œç”¨æˆ·è‡ªå®šä¹‰åè®®èµ„æºè§£å†³ç­–ç•¥ï¼Œä½œä¸º <code>DefaultResourceLoader</code> çš„ <strong>SPI</strong>ï¼Œå®ƒå…è®¸ç”¨æˆ·è‡ªå®šä¹‰èµ„æºåŠ è½½åè®®ï¼Œè€Œä¸éœ€è¦ç»§æ‰¿ <code>ResourceLoader</code> çš„å­ç±»ã€‚åœ¨ä»‹ç» <code>Resource</code> æ—¶ï¼Œæåˆ°å¦‚æœè¦å®ç°è‡ªå®šä¹‰ <code>Resource</code>ï¼Œæˆ‘ä»¬åªéœ€è¦ç»§æ‰¿ <code>DefaultResource</code> å³å¯ï¼Œä½†æ˜¯æœ‰äº† <code>ProtocolResolver</code> åï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç»§æ‰¿ <code>DefaultResourceLoader</code>ï¼Œæ”¹ä¸ºå®ç° <code>ProtocolResolver</code> æ¥å£ä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ <code>ResourceLoader</code>ã€‚ <code>ProtocolResolver</code> æ¥å£ï¼Œä»…æœ‰ä¸€ä¸ªæ–¹æ³• <code>Resource resolve(String location, ResourceLoader resourceLoader)</code>ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šèµ„æºè·¯å¾„<code>location</code>ï¼ŒæŒ‡å®šçš„åŠ è½½å™¨ <code>ResourceLoader</code>ï¼Œè¿”å›ä¸ºç›¸åº”çš„ <code>Resource</code> ã€‚åœ¨ <code>Spring</code> ä¸­ä½ ä¼šå‘ç°è¯¥æ¥å£å¹¶æ²¡æœ‰å®ç°ç±»ï¼Œå®ƒéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œè‡ªå®šä¹‰çš„ <code>Resolver</code> å¦‚ä½•åŠ å…¥ Spring ä½“ç³»å‘¢ï¼Ÿè°ƒç”¨ <code>DefaultResourceLoader.addProtocolResolver()</code> å³å¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProtocolResolver</span><span class="params">(ProtocolResolver resolver)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(resolver, <span class="string">&quot;ProtocolResolver must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.protocolResolvers.add(resolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç¤ºä¾‹æ˜¯æ¼”ç¤º <code>DefaultResourceLoader</code> åŠ è½½èµ„æºçš„å…·ä½“ç­–ç•¥ï¼Œä»£ç å¦‚ä¸‹ï¼ˆ<em>è¯¥ç¤ºä¾‹å‚è€ƒã€ŠSpring è§£å¯†ã€‹ P89</em>ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ResourceLoader resourceLoader = <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line"></span><br><span class="line">Resource fileResource1 = resourceLoader.getResource(<span class="string">&quot;D:/Users/chenming673/Documents/spark.txt&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;fileResource1 is FileSystemResource:&quot;</span> </span><br><span class="line">                   + (fileResource1 <span class="keyword">instanceof</span> FileSystemResource));</span><br><span class="line"></span><br><span class="line">Resource fileResource2 = resourceLoader.getResource(<span class="string">&quot;/Users/chenming673/Documents/spark.txt&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;fileResource2 is ClassPathResource:&quot;</span> </span><br><span class="line">                   + (fileResource2 <span class="keyword">instanceof</span> ClassPathResource));</span><br><span class="line"></span><br><span class="line">Resource urlResource1 = resourceLoader.getResource(<span class="string">&quot;file:/Users/chenming673/Documents/spark.txt&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;urlResource1 is UrlResource:&quot;</span> </span><br><span class="line">                   + (urlResource1 <span class="keyword">instanceof</span> UrlResource));</span><br><span class="line"></span><br><span class="line">Resource urlResource2 = resourceLoader.getResource(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;urlResource1 is urlResource:&quot;</span> </span><br><span class="line">                   + (urlResource2 <span class="keyword">instanceof</span>  UrlResource));</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">fileResource1 is FileSystemResource:<span class="keyword">false</span></span><br><span class="line">fileResource2 is ClassPathResource:<span class="keyword">true</span></span><br><span class="line">urlResource1 is UrlResource:<span class="keyword">true</span></span><br><span class="line">urlResource1 is urlResource:<span class="keyword">true</span></span><br></pre></td></tr></table></figure><p>å…¶å®å¯¹äº fileResource1 æˆ‘ä»¬æ›´åŠ å¸Œæœ›æ˜¯ FileSystemResource èµ„æºç±»å‹ï¼Œä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œå®ƒæ˜¯ ClassPathResource ç±»å‹ã€‚åœ¨<code>getResource()</code>èµ„æºåŠ è½½ç­–ç•¥ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ <code>D:/Users/chenming673/Documents/spark.txt</code>èµ„æºå…¶å®åœ¨è¯¥æ–¹æ³•ä¸­æ²¡æœ‰ç›¸åº”çš„èµ„æºç±»å‹ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåœ¨æŠ›å‡º <code>MalformedURLException</code> å¼‚å¸¸æ—¶é€šè¿‡ <code>getResourceByPath()</code> æ„é€ ä¸€ä¸ª <code>ClassPathResource</code> ç±»å‹çš„èµ„æºã€‚è€ŒæŒ‡å®šæœ‰åè®®å‰ç¼€çš„èµ„æºè·¯å¾„ï¼Œåˆ™é€šè¿‡ <code>URL</code> å°±å¯ä»¥å®šä¹‰ï¼Œæ‰€ä»¥è¿”å›çš„éƒ½æ˜¯<code>UrlResource</code>ç±»å‹ã€‚</p><h3 id="FileSystemResourceLoader"><a href="#FileSystemResourceLoader" class="headerlink" title="FileSystemResourceLoader"></a>FileSystemResourceLoader</h3><p>ä»ä¸Šé¢çš„ç¤ºä¾‹æˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å® <code>DefaultResourceLoader</code> å¯¹<code>getResourceByPath(String)</code>æ–¹æ³•å¤„ç†å…¶å®ä¸æ˜¯å¾ˆæ°å½“ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>FileSystemResourceLoader</code> ï¼Œå®ƒç»§æ‰¿ <code>DefaultResourceLoader</code> ä¸”è¦†å†™äº† <code>getResourceByPath(String)</code>ï¼Œä½¿ä¹‹ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºå¹¶ä»¥ <code>FileSystemResource</code> ç±»å‹è¿”å›ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æƒ³è¦çš„èµ„æºç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">    path = path.substring(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileSystemContextResource(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileSystemContextResource</code> ä¸º <code>FileSystemResourceLoader</code> çš„å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿ <code>FileSystemResource</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemContextResource</span> <span class="keyword">extends</span> <span class="title">FileSystemResource</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">ContextResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FileSystemContextResource</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(path);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getPathWithinContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getPath();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€ å™¨ä¸­ä¹Ÿæ˜¯è°ƒç”¨ <code>FileSystemResource</code> çš„æ„é€ æ–¹æ³•æ¥æ„é€  <code>FileSystemContextResource</code> çš„ã€‚</p><p>å¦‚æœå°†ä¸Šé¢çš„ç¤ºä¾‹å°† <code>DefaultResourceLoader</code> æ”¹ä¸º <code>FileSystemContextResource</code> ï¼Œåˆ™ <code>fileResource1</code> åˆ™ä¸º <code>FileSystemResource</code>ã€‚</p><h3 id="ResourcePatternResolver"><a href="#ResourcePatternResolver" class="headerlink" title="ResourcePatternResolver"></a>ResourcePatternResolver</h3><p><code>ResourceLoader</code> çš„ <code>Resource getResource(String location)</code> æ¯æ¬¡åªèƒ½æ ¹æ® <code>location</code> è¿”å›ä¸€ä¸ª Resourceï¼Œå½“éœ€è¦åŠ è½½å¤šä¸ªèµ„æºæ—¶ï¼Œæˆ‘ä»¬é™¤äº†å¤šæ¬¡è°ƒç”¨ <code>getResource()</code> å¤–åˆ«æ— ä»–æ³•ã€‚<code>ResourcePatternResolver</code> æ˜¯ <code>ResourceLoader</code> çš„æ‰©å±•ï¼Œå®ƒæ”¯æŒæ ¹æ®æŒ‡å®šçš„èµ„æºè·¯å¾„åŒ¹é…æ¨¡å¼æ¯æ¬¡è¿”å›å¤šä¸ª <code>Resource</code> å®ä¾‹ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourcePatternResolver</span> <span class="keyword">extends</span> <span class="title">ResourceLoader</span> </span>&#123;</span><br><span class="line">    String CLASSPATH_ALL_URL_PREFIX = <span class="string">&quot;classpath*:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ResourcePatternResolver</code> åœ¨ <code>ResourceLoader</code> çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>getResources(String locationPattern)</code>ï¼Œä»¥æ”¯æŒæ ¹æ®è·¯å¾„åŒ¹é…æ¨¡å¼è¿”å›å¤šä¸ª <code>Resource</code> å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿæ–°å¢äº†ä¸€ç§æ–°çš„åè®®å‰ç¼€ <code>classpath*:</code>ï¼Œè¯¥åè®®å‰ç¼€ç”±å…¶å­ç±»è´Ÿè´£å®ç°ã€‚</p><p><code>PathMatchingResourcePatternResolver</code> ä¸º <code>ResourcePatternResolver</code> æœ€å¸¸ç”¨çš„å­ç±»ï¼Œå®ƒé™¤äº†æ”¯æŒ <code>ResourceLoader</code> å’Œ <code>ResourcePatternResolver</code> æ–°å¢çš„ <em><em>classpath</em>:</em>* å‰ç¼€å¤–ï¼Œè¿˜æ”¯æŒ <code>Ant</code> é£æ ¼çš„è·¯å¾„åŒ¹é…æ¨¡å¼ï¼ˆç±»ä¼¼äº <code>**/*.xml</code>ï¼‰ã€‚</p><p><code>PathMatchingResourcePatternResolver</code> æä¾›äº†ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(resourceLoader, <span class="string">&quot;ResourceLoader must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = <span class="keyword">new</span> DefaultResourceLoader(classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PathMatchingResourcePatternResolver</code> åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª <code>ResourceLoader</code>ï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯ï¼Œå®ƒä¼šåœ¨å†…éƒ¨æ„é€ ä¸€ä¸ª <code>DefaultResourceLoader</code>ã€‚</p><h4 id="Resource-getResource-String-location"><a href="#Resource-getResource-String-location" class="headerlink" title="Resource getResource(String location)"></a>Resource getResource(String location)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getResourceLoader().getResource(location);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getResource()</code> æ–¹æ³•ç›´æ¥å§”æ‰˜ç»™ç›¸åº”çš„ <code>ResourceLoader</code> æ¥å®ç°ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åœ¨å®ä¾‹åŒ–çš„ <code>PathMatchingResourcePatternResolver</code> çš„æ—¶å€™ï¼Œå¦‚æœä¸çŸ¥é“ <code>ResourceLoader</code> ï¼Œé‚£ä¹ˆåœ¨åŠ è½½èµ„æºæ—¶ï¼Œå…¶å®å°±æ˜¯ <code>DefaultResourceLoader</code> çš„è¿‡ç¨‹ã€‚å…¶å®åœ¨ä¸‹é¢ä»‹ç»çš„ <code>Resource[] getResources(String locationPattern)</code> ä¹Ÿç›¸åŒï¼Œåªä¸è¿‡è¿”å›çš„èµ„æºæ—¶å¤šä¸ªè€Œå·²ã€‚</p><h4 id="Resource-getResources-String-locationPattern"><a href="#Resource-getResources-String-locationPattern" class="headerlink" title="Resource[] getResources(String locationPattern)"></a>Resource[] getResources(String locationPattern)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  Assert.notNull(locationPattern, <span class="string">&quot;Location pattern must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»¥ classpath*: å¼€å¤´</span></span><br><span class="line">  <span class="keyword">if</span> (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123;</span><br><span class="line">    <span class="comment">// è·¯å¾„åŒ…å«é€šé…ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (getPathMatcher()</span><br><span class="line">        .isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123;</span><br><span class="line">      <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è·¯å¾„ä¸åŒ…å«é€šé…ç¬¦</span></span><br><span class="line">      <span class="keyword">return</span> findAllClassPathResources(</span><br><span class="line">        locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> prefixEnd = (</span><br><span class="line">      locationPattern.startsWith(<span class="string">&quot;war:&quot;</span>) ? locationPattern.indexOf(<span class="string">&quot;*/&quot;</span>) + <span class="number">1</span> :</span><br><span class="line">                     locationPattern.indexOf(<span class="string">&#x27;:&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è·¯å¾„åŒ…å«é€šé…ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123;</span><br><span class="line">      <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/UnSrsV.jpg" alt="UnSrsV"></p><p>ä¸‹é¢å°± <code>findAllClassPathResources()</code>åšè¯¦ç»†åˆ†æã€‚</p><h4 id="findAllClassPathResources"><a href="#findAllClassPathResources" class="headerlink" title="findAllClassPathResources()"></a>findAllClassPathResources()</h4><p>å½“ <code>locationPattern</code> ä»¥ <em><em>classpath</em>:</em>* å¼€å¤´ä½†æ˜¯ä¸åŒ…å«é€šé…ç¬¦ï¼Œåˆ™è°ƒç”¨<code>findAllClassPathResources()</code> æ–¹æ³•åŠ è½½èµ„æºã€‚è¯¥æ–¹æ³•è¿”å› <code>classes</code> è·¯å¾„ä¸‹å’Œæ‰€æœ‰ <code>jar</code> åŒ…ä¸­çš„æ‰€æœ‰ç›¸åŒ¹é…çš„èµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Resource[] findAllClassPathResources(String location) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  String path = location;</span><br><span class="line">  <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">    path = path.substring(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Set&lt;Resource&gt; result = doFindAllClassPathResources(path);</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Resolved classpath location [&quot;</span> </span><br><span class="line">                 + location + <span class="string">&quot;] to resources &quot;</span> + result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.toArray(<span class="keyword">new</span> Resource[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£æ‰§è¡ŒåŠ è½½çš„æ˜¯åœ¨ <code>doFindAllClassPathResources()</code>æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Set&lt;Resource&gt; <span class="title">doFindAllClassPathResources</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Set&lt;Resource&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">  ClassLoader cl = getClassLoader();</span><br><span class="line">  Enumeration&lt;URL&gt; resourceUrls = (cl != <span class="keyword">null</span> ? cl.getResources(path) : </span><br><span class="line">                                   ClassLoader.getSystemResources(path));</span><br><span class="line">  <span class="keyword">while</span> (resourceUrls.hasMoreElements()) &#123;</span><br><span class="line">    URL url = resourceUrls.nextElement();</span><br><span class="line">    result.add(convertClassLoaderURL(url));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(path)) &#123;</span><br><span class="line">    addAllClassLoaderJarRoots(cl, result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doFindAllClassPathResources()</code> æ ¹æ® <code>ClassLoader</code> åŠ è½½è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æºã€‚åœ¨åŠ è½½èµ„æºè¿‡ç¨‹ä¸­å¦‚æœï¼Œåœ¨æ„é€  <code>PathMatchingResourcePatternResolver</code> å®ä¾‹çš„æ—¶å€™å¦‚æœä¼ å…¥äº† <code>ClassLoader</code>ï¼Œåˆ™è°ƒç”¨å…¶ <code>getResources()</code>ï¼Œå¦åˆ™è°ƒç”¨<code>ClassLoader.getSystemResources(path)</code>ã€‚ <code>ClassLoader.getResources()</code>å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">getResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Enumeration&lt;URL&gt;[] tmp = (Enumeration&lt;URL&gt;[]) <span class="keyword">new</span> Enumeration&lt;?&gt;[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    tmp[<span class="number">0</span>] = parent.getResources(name);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tmp[<span class="number">0</span>] = getBootstrapResources(name);</span><br><span class="line">  &#125;</span><br><span class="line">  tmp[<span class="number">1</span>] = findResources(name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CompoundEnumeration&lt;&gt;(tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å°±å·²ç»ä¸€ç›®äº†ç„¶äº†ï¼Ÿå¦‚æœå½“å‰çˆ¶ç±»åŠ è½½å™¨ä¸ä¸º nullï¼Œåˆ™é€šè¿‡çˆ¶ç±»å‘ä¸Šè¿­ä»£è·å–èµ„æºï¼Œå¦åˆ™è°ƒç”¨ <code>getBootstrapResources()</code>ã€‚è¿™é‡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œ(<em>^â–½^</em>)ã€‚</p><p>è‹¥ path ä¸º ç©ºï¼ˆâ€œâ€ï¼‰æ—¶ï¼Œåˆ™è°ƒç”¨ <code>addAllClassLoaderJarRoots()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸»è¦æ˜¯åŠ è½½è·¯å¾„ä¸‹å¾—æ‰€æœ‰ jar åŒ…ï¼Œæ–¹æ³•è¾ƒé•¿ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å°±ä¸è´´å‡ºæ¥äº†ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ <code>findAllClassPathResources()</code> å…¶å®å°±æ˜¯åˆ©ç”¨ ClassLoader æ¥åŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„èµ„æºï¼Œä¸ç®¡å®ƒæ˜¯åœ¨ class è·¯å¾„ä¸‹è¿˜æ˜¯åœ¨ jar åŒ…ä¸­ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„ä¸ºç©ºæˆ–è€… <code>/</code>ï¼Œåˆ™ä¼šè°ƒç”¨ <code>addAllClassLoaderJarRoots()</code> æ–¹æ³•åŠ è½½æ‰€æœ‰çš„ jar åŒ…ã€‚</p><h4 id="findAllClassPathResources-1"><a href="#findAllClassPathResources-1" class="headerlink" title="findAllClassPathResources()"></a>findAllClassPathResources()</h4><p>å½“ <code>locationPattern</code> ä»¥ <em><em>classpath</em>:</em>* å¼€å¤´ä¸”å½“ä¸­åŒ…å«äº†é€šé…ç¬¦ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œèµ„æºåŠ è½½ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Resource[] findPathMatchingResources(String locationPattern) </span><br><span class="line">  <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="comment">// ç¡®å®šè·Ÿè·¯å¾„</span></span><br><span class="line">  String rootDirPath = determineRootDir(locationPattern);</span><br><span class="line">  String subPattern = locationPattern.substring(rootDirPath.length());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ ¹æ®è·¯å¾„ä¸‹å¾—èµ„æº</span></span><br><span class="line">  Resource[] rootDirResources = getResources(rootDirPath);</span><br><span class="line"></span><br><span class="line">  Set&lt;Resource&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (Resource rootDirResource : rootDirResources) &#123;</span><br><span class="line">    rootDirResource = resolveRootDirResource(rootDirResource);</span><br><span class="line">    URL rootDirUrl = rootDirResource.getURL();</span><br><span class="line">    <span class="comment">// bundle èµ„æºç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (equinoxResolveMethod != <span class="keyword">null</span> </span><br><span class="line">        &amp;&amp; rootDirUrl.getProtocol().startsWith(<span class="string">&quot;bundle&quot;</span>)) &#123;</span><br><span class="line">      URL resolvedUrl = (URL) ReflectionUtils</span><br><span class="line">        .invokeMethod(equinoxResolveMethod, <span class="keyword">null</span>, rootDirUrl);</span><br><span class="line">      <span class="keyword">if</span> (resolvedUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        rootDirUrl = resolvedUrl;</span><br><span class="line">      &#125;</span><br><span class="line">      rootDirResource = <span class="keyword">new</span> UrlResource(rootDirUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// VFS èµ„æº</span></span><br><span class="line">    <span class="keyword">if</span> (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) &#123;</span><br><span class="line">      result.addAll(VfsResourceMatchingDelegate</span><br><span class="line">                    .findMatchingResources(rootDirUrl,</span><br><span class="line">                                           subPattern, getPathMatcher()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Jar</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ResourceUtils.isJarURL(rootDirUrl) </span><br><span class="line">             || isJarResource(rootDirResource)) &#123;</span><br><span class="line">      result</span><br><span class="line">        .addAll(doFindPathMatchingJarResources</span><br><span class="line">                (rootDirResource, rootDirUrl, subPattern));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      result</span><br><span class="line">        .addAll(doFindPathMatchingFileResources(</span><br><span class="line">          rootDirResource, subPattern));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Resolved location pattern [&quot;</span> </span><br><span class="line">                 + locationPattern + <span class="string">&quot;] to resources &quot;</span> </span><br><span class="line">                 + result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.toArray(<span class="keyword">new</span> Resource[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•æœ‰ç‚¹å„¿é•¿ï¼Œä½†æ˜¯æ€è·¯è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œä¸»è¦åˆ†ä¸¤æ­¥ï¼š</p><ol><li>ç¡®å®šç›®å½•ï¼Œè·å–è¯¥ç›®å½•ä¸‹å¾—æ‰€æœ‰èµ„æº</li><li>åœ¨æ‰€è·å¾—çš„æ‰€æœ‰èµ„æºä¸­è¿›è¡Œè¿­ä»£åŒ¹é…è·å–æˆ‘ä»¬æƒ³è¦çš„èµ„æºã€‚</li></ol><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æˆ‘ä»¬è¦å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ <code>determineRootDir()</code>,ä¸€ä¸ªæ˜¯ <code>doFindPathMatchingFileResources()</code>ã€‚</p><p><code>determineRootDir()</code>ä¸»è¦æ˜¯ç”¨äºç¡®å®šæ ¹è·¯å¾„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">determineRootDir</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> prefixEnd = location.indexOf(<span class="string">&#x27;:&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> rootDirEnd = location.length();</span><br><span class="line">  <span class="keyword">while</span> (rootDirEnd &gt; prefixEnd &amp;&amp; getPathMatcher()</span><br><span class="line">         .isPattern(location.substring(prefixEnd, rootDirEnd))) &#123;</span><br><span class="line">    rootDirEnd = location.lastIndexOf(<span class="string">&#x27;/&#x27;</span>, rootDirEnd - <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (rootDirEnd == <span class="number">0</span>) &#123;</span><br><span class="line">    rootDirEnd = prefixEnd;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> location.substring(<span class="number">0</span>, rootDirEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸€å®šè¦ç»™å‡ºä¸€ä¸ªç¡®å®šçš„æ ¹ç›®å½•ã€‚è¯¥æ ¹ç›®å½•ç”¨äºç¡®å®šæ–‡ä»¶çš„åŒ¹é…çš„èµ·å§‹ç‚¹ï¼Œå°†æ ¹ç›®å½•ä½ç½®çš„èµ„æºè§£æä¸º <code>java.io.File</code> å¹¶å°†å…¶ä¼ é€’åˆ° <code>retrieveMatchingFiles()</code>ï¼Œå…¶ä½™ä¸ºçŸ¥ç”¨äºæ¨¡å¼åŒ¹é…ï¼Œæ‰¾å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„èµ„æºã€‚</p><p>ç¡®å®šæ ¹è·¯å¾„å¦‚ä¸‹:</p><table><thead><tr><th align="center">åŸè·¯å¾„</th><th align="center">ç¡®å®šæ ¹è·¯å¾„</th></tr></thead><tbody><tr><td align="center"><code>classpath*:test/cc*/spring-*.xml</code></td><td align="center"><code>classpath*:test/</code></td></tr><tr><td align="center"><code>classpath*:test/aa/spring-*.xml</code></td><td align="center"><code>classpath*:test/aa/</code></td></tr></tbody></table><p>ç¡®å®šæ ¹è·¯å¾„åï¼Œåˆ™è°ƒç”¨ <code>getResources()</code> æ–¹æ³•è·å–è¯¥è·¯å¾„ä¸‹å¾—æ‰€æœ‰èµ„æºï¼Œç„¶åè¿­ä»£èµ„æºè·å–ç¬¦åˆæ¡ä»¶çš„èµ„æºã€‚</p><p>è‡³æ­¤ <code>Spring</code> æ•´ä¸ªèµ„æºè®°è½½è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•ã€‚ä¸‹é¢ç®€è¦æ€»ç»“ä¸‹ï¼š</p><ul><li><code>Spring</code> æä¾›äº† <code>Resource</code> å’Œ <code>ResourceLoader</code> æ¥ç»Ÿä¸€æŠ½è±¡æ•´ä¸ªèµ„æºåŠå…¶å®šä½ã€‚ä½¿å¾—èµ„æºä¸èµ„æºçš„å®šä½æœ‰äº†ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„ç•Œé™ï¼Œå¹¶ä¸”æä¾›äº†åˆé€‚çš„ <code>Default</code> ç±»ï¼Œä½¿å¾—è‡ªå®šä¹‰å®ç°æ›´åŠ æ–¹ä¾¿å’Œæ¸…æ™°ã€‚</li><li><code>AbstractResource</code> ä¸º <code>Resource</code> çš„é»˜è®¤å®ç°ï¼Œå®ƒå¯¹ <code>Resource</code> æ¥å£åšäº†ä¸€ä¸ªç»Ÿä¸€çš„å®ç°ï¼Œå­ç±»ç»§æ‰¿è¯¥ç±»ååªéœ€è¦è¦†ç›–ç›¸åº”çš„æ–¹æ³•å³å¯ï¼ŒåŒæ—¶å¯¹äºè‡ªå®šä¹‰çš„ <code>Resource</code> æˆ‘ä»¬ä¹Ÿæ˜¯ç»§æ‰¿è¯¥ç±»ã€‚</li><li><code>DefaultResourceLoader</code> åŒæ ·ä¹Ÿæ˜¯ <code>ResourceLoader</code> çš„é»˜è®¤å®ç°ï¼Œåœ¨è‡ªå®š <code>ResourceLoader</code> çš„æ—¶å€™æˆ‘ä»¬é™¤äº†å¯ä»¥ç»§æ‰¿è¯¥ç±»å¤–è¿˜å¯ä»¥å®ç° <code>ProtocolResolver</code> æ¥å£æ¥å®ç°è‡ªå®šèµ„æºåŠ è½½åè®®ã€‚</li><li><code>DefaultResourceLoader</code> æ¯æ¬¡åªèƒ½è¿”å›å•ä¸€çš„èµ„æºï¼Œæ‰€ä»¥ <code>Spring</code> é’ˆå¯¹è¿™ä¸ªæä¾›äº†å¦å¤–ä¸€ä¸ªæ¥å£ <code>ResourcePatternResolver</code> ï¼Œè¯¥æ¥å£æä¾›äº†æ ¹æ®æŒ‡å®šçš„ <code>locationPattern</code> è¿”å›å¤šä¸ªèµ„æºçš„ç­–ç•¥ã€‚å…¶å­ç±» <code>PathMatchingResourcePatternResolver</code> æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…çš„ <code>ResourceLoader</code> ï¼Œå› ä¸ºå®ƒå³å®ç°äº† <code>Resource getResource(String location)</code> ä¹Ÿå®ç°äº† <code>Resource[] getResources(String locationPattern)</code>ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOCä¹‹æ·±å…¥ç†è§£SpringIoC</title>
      <link href="/blog/2020/01/01/a426e6ea.html"/>
      <url>/blog/2020/01/01/a426e6ea.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><blockquote><p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p><p>å‡ºå¤„ï¼š<a href="http://cmsblogs.com/?p=2652">http://cmsblogs.com/?p=2652</a></p><p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p></blockquote><h2 id="IOC-ç†è®º"><a href="#IOC-ç†è®º" class="headerlink" title="IOC ç†è®º"></a>IOC ç†è®º</h2><p>IoC å…¨ç§°ä¸º <code>Inversion of Control</code>ï¼Œç¿»è¯‘ä¸º â€œæ§åˆ¶åè½¬â€ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªåˆ«åä¸º DIï¼ˆ<code>Dependency Injection</code>ï¼‰,å³ä¾èµ–æ³¨å…¥ã€‚</p><p>å¦‚ä½•ç†è§£â€œæ§åˆ¶åè½¬â€å¥½å‘¢ï¼Ÿç†è§£å¥½å®ƒçš„å…³é”®åœ¨äºæˆ‘ä»¬éœ€è¦å›ç­”å¦‚ä¸‹å››ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>è°æ§åˆ¶è°</strong></li><li><strong>æ§åˆ¶ä»€ä¹ˆ</strong></li><li><strong>ä¸ºä½•æ˜¯åè½¬</strong></li><li><strong>å“ªäº›æ–¹é¢åè½¬äº†</strong></li></ol><p>åœ¨å›ç­”è¿™å››ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ IOC çš„å®šä¹‰ï¼š</p><blockquote><p><strong>æ‰€è°“ IOC ï¼Œå°±æ˜¯ç”± Spring IOC å®¹å™¨æ¥è´Ÿè´£å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹è±¡ä¹‹é—´çš„å…³ç³»</strong></p></blockquote><p>ä¸Šé¢è¿™å¥è¯æ˜¯æ•´ä¸ª IoC ç†è®ºçš„æ ¸å¿ƒã€‚å¦‚ä½•æ¥ç†è§£è¿™å¥è¯ï¼Ÿæˆ‘ä»¬å¼•ç”¨ä¸€ä¸ªä¾‹å­æ¥èµ°é˜è¿°ï¼ˆçœ‹å®Œè¯¥ä¾‹å­ä¸Šé¢å››ä¸ªé—®é¢˜ä¹Ÿå°±ä¸æ˜¯é—®é¢˜äº†ï¼‰ã€‚</p><p>ä»¥æ‰¾å¥³æœ‹å‹ä¸ºä¾‹ï¼ˆå¯¹äºç¨‹åºçŒ¿æ¥è¯´è¿™ä¸ªå€¼å¾—æ¢ç©¶çš„é—®é¢˜ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•æ¥æ‰¾å¥³æœ‹å‹çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼ˆæ¼‚äº®ã€èº«æå¥½ã€æ€§æ ¼å¥½ï¼‰æ‰¾ä¸€ä¸ªå¦¹å­ï¼Œç„¶ååˆ°å¤„æ‰“å¬å¥¹çš„å…´è¶£çˆ±å¥½ã€å¾®ä¿¡ã€ç”µè¯å·ç ï¼Œç„¶åå„ç§æŠ•å…¶æ‰€å¥½é€å…¶æ‰€è¦ï¼Œæœ€åè¿½åˆ°æ‰‹ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¹´è½»å°ä¼™å­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YoungMan</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BeautifulGirl beautifulGirl;</span><br><span class="line"></span><br><span class="line">    YoungMan()&#123;</span><br><span class="line">        <span class="comment">// å¯èƒ½ä½ æ¯”è¾ƒç‰›é€¼ï¼ŒæŒ‡è…¹ä¸ºå©š</span></span><br><span class="line">        <span class="comment">// beautifulGirl = new BeautifulGirl();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeautifulGirl</span><span class="params">(BeautifulGirl beautifulGirl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beautifulGirl = beautifulGirl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        YoungMan you = <span class="keyword">new</span> YoungMan();</span><br><span class="line">        BeautifulGirl beautifulGirl = <span class="keyword">new</span> BeautifulGirl(<span class="string">&quot;ä½ çš„å„ç§æ¡ä»¶&quot;</span>);</span><br><span class="line">        beautifulGirl.setxxx(<span class="string">&quot;å„ç§æŠ•å…¶æ‰€å¥½&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç„¶åä½ æœ‰å¥³ç¥¨äº†</span></span><br><span class="line">        you.setBeautifulGirl(beautifulGirl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æˆ‘ä»¬é€šå¸¸åšäº‹çš„æ–¹å¼ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŸä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨è¿™ç§ç›´æ¥åˆ›å»ºçš„æ–¹å¼(<code>new BeautifulGirl()</code>)ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤æ‚è€Œåˆç¹çï¼Œè€Œä¸”æˆ‘ä»¬å¿…é¡»è¦é¢å¯¹æ¯ä¸ªç¯èŠ‚ï¼ŒåŒæ—¶ä½¿ç”¨å®Œæˆä¹‹åæˆ‘ä»¬è¿˜è¦è´Ÿè´£é”€æ¯å®ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬çš„å¯¹è±¡ä¸å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡è€¦åˆåœ¨ä¸€èµ·ã€‚</p><p>å…¶å®æˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Ÿæˆ‘ä»¬æ¯æ¬¡ç”¨åˆ°è‡ªå·±ä¾èµ–çš„å¯¹è±¡çœŸçš„éœ€è¦è‡ªå·±å»åˆ›å»ºå—ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬ä¾èµ–å¯¹è±¡å…¶å®å¹¶ä¸æ˜¯ä¾èµ–è¯¥å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯ä¾èµ–å®ƒæ‰€æä¾›çš„æœåŠ¡ï¼Œåªè¦åœ¨æˆ‘ä»¬éœ€è¦å®ƒçš„æ—¶å€™ï¼Œå®ƒèƒ½å¤ŸåŠæ—¶æä¾›æœåŠ¡å³å¯ï¼Œè‡³äºå®ƒæ˜¯æˆ‘ä»¬ä¸»åŠ¨å»åˆ›å»ºçš„è¿˜æ˜¯åˆ«äººé€ç»™æˆ‘ä»¬çš„ï¼Œå…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚å†è¯´äº†ï¼Œç›¸æ¯”äºè‡ªå·±åƒè¾›ä¸‡è‹¦å»åˆ›å»ºå®ƒè¿˜è¦ç®¡ç†ã€å–„åè€Œè¨€ï¼Œç›´æ¥æœ‰äººé€è¿‡æ¥æ˜¯ä¸æ˜¯æ˜¾å¾—æ›´åŠ å¥½å‘¢ï¼Ÿ</p><p>è¿™ä¸ªç»™æˆ‘ä»¬é€ä¸œè¥¿çš„â€œäººâ€ å°±æ˜¯ IoCï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªå©šä»‹å…¬å¸ï¼Œä½œä¸ºä¸€ä¸ªå©šä»‹å…¬å¸å®ƒç®¡ç†ç€å¾ˆå¤šç”·ç”·å¥³å¥³çš„èµ„æ–™ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¥³æœ‹å‹çš„æ—¶å€™ï¼Œç›´æ¥è·Ÿå©šä»‹å…¬å¸æå‡ºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå©šä»‹å…¬å¸åˆ™ä¼šæ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚æä¾›ä¸€ä¸ªå¦¹å­ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬åªéœ€è¦è´Ÿè´£è°ˆæ‹çˆ±ï¼Œç”ŸçŒ´å­å°±è¡Œäº†ã€‚ä½ çœ‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¾ˆç®€å•æ˜äº†ã€‚</p><p>è¯šç„¶ï¼Œä½œä¸ºå©šä»‹å…¬å¸çš„ IoC å¸®æˆ‘ä»¬çœç•¥äº†æ‰¾å¥³æœ‹å‹çš„ç¹æ‚è¿‡ç¨‹ï¼Œå°†åŸæ¥çš„ä¸»åŠ¨å¯»æ‰¾å˜æˆäº†ç°åœ¨çš„è¢«åŠ¨æ¥å—ï¼ˆç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼‰ï¼Œæ›´åŠ ç®€æ´è½»ä¾¿ã€‚ä½ æƒ³å•Šï¼ŒåŸæ¥ä½ è¿˜å¾—éé©¬å‰åï¼Œå„ç§å·´ç»“ï¼Œä»€ä¹ˆä¸œè¥¿éƒ½éœ€è¦è‡ªå·±å»äº²åŠ›äº²ä¸ºï¼Œç°åœ¨å¥½äº†ï¼Œç›´æ¥æœ‰äººæŠŠç°æˆçš„é€è¿‡æ¥ï¼Œå¤šä¹ˆç¾å¦™çš„äº‹æƒ…å•Šã€‚æ‰€ä»¥ï¼Œç®€å•ç‚¹è¯´ï¼ŒIoC çš„ç†å¿µå°±æ˜¯<strong>è®©åˆ«äººä¸ºä½ æœåŠ¡</strong>ï¼Œå¦‚ä¸‹å›¾ï¼ˆ<strong>æ‘˜è‡ªSpringæ­ç§˜</strong>ï¼‰ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/kJbaSJ.jpg" alt="kJbaSJ"></p><p>åœ¨æ²¡æœ‰å¼•å…¥ IoC çš„æ—¶å€™ï¼Œè¢«æ³¨å…¥çš„å¯¹è±¡ç›´æ¥ä¾èµ–äºè¢«ä¾èµ–çš„å¯¹è±¡ï¼Œæœ‰äº† IoC åï¼Œä¸¤è€…åŠå…¶ä»–ä»¬çš„å…³ç³»éƒ½æ˜¯é€šè¿‡ Ioc Service Provider æ¥ç»Ÿä¸€ç®¡ç†ç»´æŠ¤çš„ã€‚è¢«æ³¨å…¥çš„å¯¹è±¡éœ€è¦ä»€ä¹ˆï¼Œç›´æ¥è·Ÿ IoC Service Provider æ‰“å£°æ‹›å‘¼ï¼Œåè€…å°±ä¼šæŠŠç›¸åº”çš„è¢«ä¾èµ–å¯¹è±¡æ³¨å…¥åˆ°è¢«æ³¨å…¥çš„å¯¹è±¡ä¸­ï¼Œä»è€Œè¾¾åˆ° IOC Service Provider ä¸ºè¢«æ³¨å…¥å¯¹è±¡æœåŠ¡çš„ç›®çš„ã€‚<strong>æ‰€ä»¥ IoC å°±æ˜¯è¿™ä¹ˆç®€å•ï¼åŸæ¥æ˜¯éœ€è¦ä»€ä¹ˆä¸œè¥¿è‡ªå·±å»æ‹¿ï¼Œç°åœ¨æ˜¯éœ€è¦ä»€ä¹ˆä¸œè¥¿è®©åˆ«äººï¼ˆIOC Service Providerï¼‰é€è¿‡æ¥</strong></p><p>ç°åœ¨åœ¨çœ‹ä¸Šé¢é‚£å››ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆå°±æ˜¾å¾—éå¸¸æ˜æ˜¾äº†:</p><ol><li><strong>è°æ§åˆ¶è°</strong>ï¼šåœ¨ä¼ ç»Ÿçš„å¼€å‘æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯é‡‡ç”¨ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡çš„æ–¹å¼æ¥åˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¾èµ–çš„å¯¹è±¡ç›´æ¥ç”±ä½ è‡ªå·±æ§åˆ¶ï¼Œä½†æ˜¯æœ‰äº† IOC å®¹å™¨åï¼Œåˆ™ç›´æ¥ç”± IoC å®¹å™¨æ¥æ§åˆ¶ã€‚æ‰€ä»¥â€œè°æ§åˆ¶è°â€ï¼Œå½“ç„¶æ˜¯ IoC å®¹å™¨æ§åˆ¶å¯¹è±¡ã€‚</li><li><strong>æ§åˆ¶ä»€ä¹ˆ</strong>ï¼šæ§åˆ¶å¯¹è±¡ã€‚</li><li><strong>ä¸ºä½•æ˜¯åè½¬</strong>ï¼šæ²¡æœ‰ IoC çš„æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯åœ¨è‡ªå·±å¯¹è±¡ä¸­ä¸»åŠ¨å»åˆ›å»ºè¢«ä¾èµ–çš„å¯¹è±¡ï¼Œè¿™æ˜¯æ­£è½¬ã€‚ä½†æ˜¯æœ‰äº† IoC åï¼Œæ‰€ä¾èµ–çš„å¯¹è±¡ç›´æ¥ç”± IoC å®¹å™¨åˆ›å»ºåæ³¨å…¥åˆ°è¢«æ³¨å…¥çš„å¯¹è±¡ä¸­ï¼Œä¾èµ–çš„å¯¹è±¡ç”±åŸæ¥çš„ä¸»åŠ¨è·å–å˜æˆè¢«åŠ¨æ¥å—ï¼Œæ‰€ä»¥æ˜¯åè½¬ã€‚</li><li><strong>å“ªäº›æ–¹é¢åè½¬äº†</strong>ï¼šæ‰€ä¾èµ–å¯¹è±¡çš„è·å–è¢«åè½¬äº†ã€‚</li></ol><p>å¦¹å­æœ‰äº†ï¼Œä½†æ˜¯å¦‚ä½•æ‹¥æœ‰å¦¹å­å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯ä¸€é—¨å­¦é—®ã€‚</p><ol><li>å¯èƒ½ä½ æ¯”è¾ƒç‰›é€¼ï¼Œåˆšåˆšå‡ºç”Ÿçš„æ—¶å€™å°±æŒ‡è…¹ä¸ºå©šäº†ã€‚</li><li>å¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬è¿˜æ˜¯ä¼šè€ƒè™‘è‡ªå·±æƒ³è¦ä»€ä¹ˆæ ·çš„å¦¹å­ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦å‘å©šä»‹å…¬å¸æ‰“æ‹›å‘¼çš„ã€‚</li><li>è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œä½ æ ¹æœ¬å°±ä¸çŸ¥é“è‡ªå·±æƒ³è¦ä»€ä¹ˆæ ·çš„å¦¹å­ï¼Œç›´æ¥è·Ÿå©šä»‹å…¬å¸è¯´ï¼Œæˆ‘å°±è¦ä¸€ä¸ªè¿™æ ·çš„å¦¹å­ã€‚</li></ol><p>æ‰€ä»¥ï¼Œ<code>IOC Service Provider</code> ä¸ºè¢«æ³¨å…¥å¯¹è±¡æä¾›è¢«ä¾èµ–å¯¹è±¡ä¹Ÿæœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š<code>æ„é€ æ–¹æ³•æ³¨å…¥</code>ã€<code>setteræ–¹æ³•æ³¨å…¥</code>ã€<code>æ¥å£æ³¨å…¥</code>ã€‚</p><h3 id="æ„é€ å™¨æ³¨å…¥"><a href="#æ„é€ å™¨æ³¨å…¥" class="headerlink" title="æ„é€ å™¨æ³¨å…¥"></a>æ„é€ å™¨æ³¨å…¥</h3><p>æ„é€ å™¨æ³¨å…¥ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯è¢«æ³¨å…¥çš„å¯¹è±¡é€šè¿‡åœ¨å…¶æ„é€ æ–¹æ³•ä¸­å£°æ˜ä¾èµ–å¯¹è±¡çš„å‚æ•°åˆ—è¡¨ï¼Œè®©å¤–éƒ¨çŸ¥é“å®ƒéœ€è¦å“ªäº›ä¾èµ–å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">YoungMan(BeautifulGirl beautifulGirl)&#123;</span><br><span class="line">        <span class="keyword">this</span>.beautifulGirl = beautifulGirl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å™¨æ³¨å…¥æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œå¯¹è±¡æ„é€ å®Œæ¯•åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè¿™å°±å¥½æ¯”ä½ å‡ºç”Ÿä½ å®¶é‡Œå°±ç»™ä½ æŒ‡å®šäº†ä½ åª³å¦‡ã€‚</p><h3 id="setter-æ–¹æ³•æ³¨å…¥"><a href="#setter-æ–¹æ³•æ³¨å…¥" class="headerlink" title="setter æ–¹æ³•æ³¨å…¥"></a>setter æ–¹æ³•æ³¨å…¥</h3><p>å¯¹äº JavaBean å¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ getter å’Œ setter æ–¹æ³•æ¥è®¿é—®å’Œè®¾ç½®å¯¹è±¡çš„å±æ€§ã€‚æ‰€ä»¥ï¼Œå½“å‰å¯¹è±¡åªéœ€è¦ä¸ºå…¶æ‰€ä¾èµ–çš„å¯¹è±¡æä¾›ç›¸å¯¹åº”çš„ setter æ–¹æ³•ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•å°†ç›¸åº”çš„ä¾èµ–å¯¹è±¡è®¾ç½®åˆ°è¢«æ³¨å…¥å¯¹è±¡ä¸­ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YoungMan</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BeautifulGirl beautifulGirl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeautifulGirl</span><span class="params">(BeautifulGirl beautifulGirl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beautifulGirl = beautifulGirl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”äºæ„é€ å™¨æ³¨å…¥ï¼Œsetter æ–¹å¼æ³¨å…¥ä¼šæ˜¾å¾—æ¯”è¾ƒå®½æ¾çµæ´»äº›ï¼Œå®ƒå¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¿›è¡Œæ³¨å…¥ï¼ˆå½“ç„¶æ˜¯åœ¨ä½¿ç”¨ä¾èµ–å¯¹è±¡ä¹‹å‰ï¼‰ï¼Œè¿™å°±å¥½æ¯”ä½ å¯ä»¥å…ˆæŠŠè‡ªå·±æƒ³è¦çš„å¦¹å­æƒ³å¥½äº†ï¼Œç„¶åå†è·Ÿå©šä»‹å…¬å¸æ‰“æ‹›å‘¼ï¼Œä½ å¯ä»¥è¦æ—å¿—ç²æ¬¾å¼çš„ï¼Œèµµä¸½é¢–æ¬¾å¼çš„ï¼Œç”šè‡³å‡¤å§å“ªæ¬¾çš„ï¼Œéšæ„æ€§è¾ƒå¼ºã€‚</p><h3 id="æ¥å£æ–¹å¼æ³¨å…¥"><a href="#æ¥å£æ–¹å¼æ³¨å…¥" class="headerlink" title="æ¥å£æ–¹å¼æ³¨å…¥"></a>æ¥å£æ–¹å¼æ³¨å…¥</h3><p>æ¥å£æ–¹å¼æ³¨å…¥æ˜¾å¾—æ¯”è¾ƒéœ¸é“ï¼Œå› ä¸ºå®ƒéœ€è¦è¢«ä¾èµ–çš„å¯¹è±¡å®ç°ä¸å¿…è¦çš„æ¥å£ï¼Œå¸¦æœ‰ä¾µå…¥æ€§ã€‚ä¸€èˆ¬éƒ½ä¸æ¨èè¿™ç§æ–¹å¼ã€‚</p><hr><p>å…³äº IOC ç†è®ºéƒ¨åˆ†ï¼Œç¬”è€…ä¸åœ¨é˜è¿°ï¼Œè¿™é‡Œæ¨èå‡ ç¯‡åšå®¢é˜…è¯»ï¼š</p><ul><li><a href="http://www.cnblogs.com/xdp-gacl/p/4249939.html">è°ˆè°ˆå¯¹Spring IOCçš„ç†è§£</a>ï¼š<a href="http://www.cnblogs.com/xdp-gacl/p/4249939.html">http://www.cnblogs.com/xdp-gacl/p/4249939.html</a></li><li>[Springçš„IOCåŸç†<a href="https://blog.csdn.net/m13666368773/article/details/7802126">é€šä¿—è§£é‡Šä¸€ä¸‹]</a>ï¼š<a href="https://blog.csdn.net/m13666368773/article/details/7802126">https://blog.csdn.net/m13666368773/article/details/7802126</a></li><li><a href="https://blog.csdn.net/it_man/article/details/4402245">spring iocåŸç†ï¼ˆçœ‹å®Œåå¤§å®¶å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªspringï¼‰</a>ï¼š<a href="https://blog.csdn.net/it_man/article/details/4402245">https://blog.csdn.net/it_man/article/details/4402245</a></li></ul><h2 id="å„ä¸ªç»„ä»¶"><a href="#å„ä¸ªç»„ä»¶" class="headerlink" title="å„ä¸ªç»„ä»¶"></a>å„ä¸ªç»„ä»¶</h2><p>å…ˆçœ‹ä¸‹å›¾ï¼ˆæ‘˜è‡ª:<a href="http://singleant.iteye.com/blog/1177358%EF%BC%89">http://singleant.iteye.com/blog/1177358ï¼‰</a></p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/KyiN5i.jpg" alt="KyiN5i"></p><p>è¯¥å›¾ä¸º <code>ClassPathXmlApplicationContext</code> çš„ç±»ç»§æ‰¿ä½“ç³»ç»“æ„ï¼Œè™½ç„¶åªæœ‰ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒåŸºæœ¬ä¸ŠåŒ…å«äº† IOC ä½“ç³»ä¸­å¤§éƒ¨åˆ†çš„æ ¸å¿ƒç±»å’Œæ¥å£ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹è¿™ä¸ªå›¾è¿›è¡Œç®€å•çš„æ‹†åˆ†å’Œè¡¥å……è¯´æ˜ã€‚</p><h3 id="Resourceä½“ç³»"><a href="#Resourceä½“ç³»" class="headerlink" title="Resourceä½“ç³»"></a>Resourceä½“ç³»</h3><p><code>Resource</code>ï¼Œå¯¹èµ„æºçš„æŠ½è±¡ï¼Œå®ƒçš„æ¯ä¸€ä¸ªå®ç°ç±»éƒ½ä»£è¡¨äº†ä¸€ç§èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œå¦‚<code>ClasspathResource</code> ã€ <code>URLResource</code> ï¼Œ<code>FileSystemResource</code> ç­‰ã€‚</p><p>[<img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/gUeoM5.jpg" alt="gUeoM5"></p><p>æœ‰äº†èµ„æºï¼Œå°±åº”è¯¥æœ‰èµ„æºåŠ è½½ï¼Œ<code>Spring</code> åˆ©ç”¨ <code>ResourceLoader</code> æ¥è¿›è¡Œç»Ÿä¸€èµ„æºåŠ è½½ï¼Œç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/FKcAl6.jpg" alt="FKcAl6"></p><h3 id="BeanFactory-ä½“ç³»"><a href="#BeanFactory-ä½“ç³»" class="headerlink" title="BeanFactory ä½“ç³»"></a>BeanFactory ä½“ç³»</h3><p><code>BeanFactory</code> æ˜¯ä¸€ä¸ªéå¸¸çº¯ç²¹çš„ <code>bean</code> å®¹å™¨ï¼Œå®ƒæ˜¯ <code>IOC</code> å¿…å¤‡çš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ <code>BeanDefinition</code> æ˜¯å¥¹çš„åŸºæœ¬ç»“æ„ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª <code>BeanDefinition map</code> ï¼Œå¹¶å¯æ ¹æ® <code>BeanDefinition</code> çš„æè¿°è¿›è¡Œ <code>bean</code> çš„åˆ›å»ºå’Œç®¡ç†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/EXiivT.jpg" alt="EXiivT"></p><p><code>BeanFacoty</code> æœ‰ä¸‰ä¸ªç›´æ¥å­ç±» <code>ListableBeanFactory</code>ã€<code>HierarchicalBeanFactory</code> å’Œ <code>AutowireCapableBeanFactory</code>ï¼Œ<code>DefaultListableBeanFactory</code> ä¸ºæœ€ç»ˆé»˜è®¤å®ç°ï¼Œå®ƒå®ç°äº†æ‰€æœ‰æ¥å£ã€‚</p><h3 id="Beandefinition-ä½“ç³»"><a href="#Beandefinition-ä½“ç³»" class="headerlink" title="Beandefinition ä½“ç³»"></a>Beandefinition ä½“ç³»</h3><p><code>BeanDefinition</code> ç”¨æ¥æè¿° <code>Spring</code> ä¸­çš„ <code>Bean</code> å¯¹è±¡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/ROyten.jpg" alt="ROyten"></p><h3 id="BeandefinitionReaderä½“ç³»"><a href="#BeandefinitionReaderä½“ç³»" class="headerlink" title="BeandefinitionReaderä½“ç³»"></a>BeandefinitionReaderä½“ç³»</h3><p><code>BeanDefinitionReader</code> çš„ä½œç”¨æ˜¯è¯»å– <code>Spring</code> çš„é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ <code>Ioc</code> å®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼š<code>BeanDefinition</code>ã€‚</p><p>[<img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/le62Sh.jpg" alt="le62Sh"></p><h3 id="ApplicationContextä½“ç³»"><a href="#ApplicationContextä½“ç³»" class="headerlink" title="ApplicationContextä½“ç³»"></a>ApplicationContextä½“ç³»</h3><p>è¿™ä¸ªå°±æ˜¯å¤§åé¼é¼çš„ <code>Spring</code> å®¹å™¨ï¼Œå®ƒå«åšåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œä¸æˆ‘ä»¬åº”ç”¨æ¯æ¯ç›¸å…³ï¼Œå¥¹ç»§æ‰¿ <code>BeanFactory</code>ï¼Œæ‰€ä»¥å®ƒæ˜¯ <code>BeanFactory</code> çš„æ‰©å±•å‡çº§ç‰ˆï¼Œå¦‚æœ<code>BeanFactory</code> æ˜¯å±Œä¸çš„è¯ï¼Œé‚£ä¹ˆ <code>ApplicationContext</code> åˆ™æ˜¯åå‰¯å…¶å®çš„é«˜å¯Œå¸…ã€‚ç”±äº <code>ApplicationContext</code> çš„ç»“æ„å°±å†³å®šäº†å®ƒä¸ <code>BeanFactory</code> çš„ä¸åŒï¼Œå…¶ä¸»è¦åŒºåˆ«æœ‰ï¼š</p><ol><li>ç»§æ‰¿ <code>MessageSource</code>ï¼Œæä¾›å›½é™…åŒ–çš„æ ‡å‡†è®¿é—®ç­–ç•¥ã€‚</li><li>ç»§æ‰¿ <code>ApplicationEventPublisher</code> ï¼Œæä¾›å¼ºå¤§çš„äº‹ä»¶æœºåˆ¶ã€‚</li><li>æ‰©å±• <code>ResourceLoader</code>ï¼Œå¯ä»¥ç”¨æ¥åŠ è½½å¤šä¸ª <code>Resource</code>ï¼Œå¯ä»¥çµæ´»è®¿é—®ä¸åŒçš„èµ„æºã€‚</li><li>å¯¹ <code>Web</code> åº”ç”¨çš„æ”¯æŒã€‚</li></ol><p>ä¸‹å›¾æ¥æºï¼š<a href="https://blog.csdn.net/yujin753/article/details/47043143">https://blog.csdn.net/yujin753/article/details/47043143</a></p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/NFNQp8.jpg" alt="NFNQp8"></p><p>ä¸Šé¢äº”ä¸ªä½“ç³»å¯ä»¥è¯´æ˜¯<code>Spring IoC</code>ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œåé¢åšæ–‡ä¹Ÿæ˜¯é’ˆå¯¹è¿™äº”ä¸ªéƒ¨åˆ†è¿›è¡Œæºç åˆ†æã€‚å…¶å® <code>IoC</code> å’‹ä¸€çœ‹è¿˜æ˜¯æŒºç®€å•çš„ï¼Œæ— éå°±æ˜¯å°†é…ç½®æ–‡ä»¶ï¼ˆæš‚ä¸”è®¤ä¸ºæ˜¯ <code>xml</code> æ–‡ä»¶ï¼‰è¿›è¡Œè§£æï¼ˆåˆ†æ <code>xml</code> è°ä¸ä¼šå•Šï¼‰ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ª <code>Map</code> é‡Œé¢å°±å·®ä¸å¤šäº†ï¼Œåˆçœ‹æœ‰é“ç†ï¼Œå…¶å®è¦é¢ä¸´çš„é—®é¢˜è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ï¼Œä¸‹é¢å°±åŠ³çƒ¦å„ä½çœ‹å®¢è·Ÿç€ LZ åšå®¢æ¥ä¸€æ­¥ä¸€æ­¥æ­å¼€ <code>Spring IoC</code> çš„ç¥ç§˜é¢çº±ã€‚</p><blockquote><p><strong>æ­¤ç³»åˆ—åšæ–‡ä¸º LZ å­¦ä¹ ã€ç ”ç©¶ Spring æœºåˆ¶å’Œæºç çš„å­¦ä¹ ç¬”è®°ï¼Œä¼šæ¶‰åŠå‚è€ƒåˆ«äººçš„åšæ–‡å’Œä¹¦ç±å†…å®¹ï¼Œå¦‚æœ‰é›·åŒï¼Œçº¯å±å€Ÿé‰´ï¼Œå½“ç„¶ LZ ä¼šæ ‡æ˜å‚è€ƒæ¥æºã€‚åŒæ—¶ç”±äºçŸ¥è¯†é¢å’Œèƒ½åŠ›çš„é—®é¢˜ï¼Œæ–‡ç« ä¸­éš¾å…ä¼šå‡ºç°é”™è¯¯ä¹‹å¤„ï¼Œå¦‚æœ‰ï¼Œæœ›å„ä½å¤§ä½¬æŒ‡å‡ºï¼Œä¸èƒœæ„Ÿæ¿€</strong>ã€‚ <strong>LZ å†™æ­¤ç³»åˆ—åšå®¢æ—¶ï¼ŒSpring æœ€æ–°ç‰ˆæœ¬ä¸º 5.0.6.RELEASE ï¼Œæ‰€ä»¥æ­¤ç³»åˆ—åšå®¢æ‰€æœ‰æºç æ¥æºå‡ä¸º 5.0.6.RELEASE</strong>ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> ã€ŠSpringæºç åˆ†æã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> æ­»ç£•Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”ç¼“å­˜æ¨¡å—</title>
      <link href="/blog/2019/10/31/fce458a9.html"/>
      <url>/blog/2019/10/31/fce458a9.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm_zgJEGC.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„<strong>ç¼“å­˜æ¨¡å—</strong></p></blockquote><p><code>MyBatis</code>ä½œä¸º ä¸€ä¸ª å¼ºå¤§çš„æŒä¹…å±‚ æ¡† æ¶ï¼Œç¼“ å­˜æ˜¯å…¶å¿…ä¸å¯å°‘çš„åŠŸèƒ½ä¹‹ä¸€ã€‚MyBatisä¸­çš„ç¼“ å­˜ æ˜¯ä¸¤ å±‚ ç»“ æ„ çš„ï¼Œåˆ†ä¸º <strong>ä¸€çº§ ç¼“ å­˜</strong>ã€<strong>äºŒçº§ ç¼“ å­˜</strong>ï¼Œä½†åœ¨æœ¬è´¨ ä¸Šæ˜¯ç›¸åŒçš„ï¼Œå®ƒ ä»¬ ä½¿ç”¨çš„éƒ½æ˜¯<code>Cache</code>æ¥ å£çš„å® ç° ã€‚</p><p>åœ¨ MyBatisç¼“ å­˜æ¨¡å— ä¸­æ¶‰åŠäº†è£… é¥° å™¨æ¨¡å¼çš„ç›¸å…³ çŸ¥è¯† ã€‚</p><h2 id="è£…é¥°å™¨æ¨¡å¼"><a href="#è£…é¥°å™¨æ¨¡å¼" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼"></a>è£…é¥°å™¨æ¨¡å¼</h2><p>åœ¨å®è·µç”Ÿäº§ä¸­ï¼Œæ–°éœ€æ±‚åœ¨è½¯ä»¶çš„æ•´ä¸ªç”Ÿå‘½è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸æ–­å‡ºç°çš„ã€‚å½“æœ‰æ–°éœ€æ±‚å‡ºç°æ—¶ï¼Œå°±éœ€è¦ä¸ºæŸäº›ç»„ä»¶æ·»åŠ æ–°çš„åŠŸèƒ½æ¥æ»¡è¶³è¿™äº›éœ€æ±‚ã€‚</p><p>æ·»åŠ æ–°åŠŸèƒ½çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹å·±æœ‰ç»„ä»¶çš„ä»£ç å¹¶æ·»åŠ ç›¸åº”çš„æ–°åŠŸèƒ½ï¼Œè¿™æ˜¾ç„¶ä¼šç ´åå·±æœ‰ç»„ä»¶çš„ç¨³å®šæ€§ï¼Œä¿®æ”¹å®Œæˆåï¼Œæ•´ä¸ªç»„ä»¶éœ€è¦é‡æ–°è¿›è¡Œæµ‹è¯•ï¼Œæ‰èƒ½ä¸Šçº¿ä½¿ç”¨ã€‚è¿™ç§æ–¹å¼æ˜¾ç„¶è¿åäº†â€œ<strong>å¼€æ”¾-å°é—­</strong>â€åŸåˆ™ã€‚</p><p><u>å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ç»§æ‰¿æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå­ç±»å¹¶åœ¨å­ç±»ä¸­æ·»åŠ æ–°åŠŸèƒ½å®ç°æ‰©å±•ã€‚</u>*è¿™ç§æ–¹æ³•æ˜¯é™æ€çš„ï¼Œç”¨æˆ·ä¸èƒ½æ§åˆ¶å¢åŠ è¡Œä¸ºçš„æ–¹å¼å’Œæ—¶æœºã€‚è€Œä¸”æœ‰äº›æƒ…å†µä¸‹ç»§æ‰¿æ˜¯ä¸å¯è¡Œçš„ã€‚</p><ul><li><p>ä¾‹å¦‚å·±æœ‰ç»„ä»¶æ˜¯è¢«<code>final</code>å…³é”®å­—ä¿®é¥°çš„ç±»ã€‚</p></li><li><p>å¦å¤–ï¼Œå¦‚æœå¾…æ·»åŠ çš„æ–°åŠŸèƒ½å­˜åœ¨å¤šç§ç»„åˆï¼Œä½¿ç”¨ç»§æ‰¿æ–¹å¼å¯èƒ½ä¼šå¯¼è‡´å¤§é‡å­ç±»çš„å‡ºç°ã€‚</p><p>ä¾‹å¦‚ï¼Œæœ‰4ä¸ªå¾…æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œç³»ç»Ÿéœ€è¦åŠ¨æ€ä½¿ç”¨ä»»æ„å¤šä¸ªåŠŸèƒ½çš„ç»„åˆï¼Œåˆ™éœ€è¦æ·»åŠ 15ä¸ªå­ç±»æ‰èƒ½æ»¡è¶³å…¨éƒ¨éœ€æ±‚ã€‚</p></li></ul><p>è£…é¥°å™¨æ¨¡å¼èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè£…é¥°å™¨å¯ä»¥åŠ¨æ€åœ°ä¸ºå¯¹è±¡æ·»åŠ åŠŸèƒ½ï¼Œå®ƒæ˜¯åŸºäºç»„åˆçš„æ–¹å¼å®ç°è¯¥åŠŸèƒ½çš„ã€‚</p><p><strong>åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨ç»„åˆçš„æ–¹å¼æ¥æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œè€Œéä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼ã€‚</strong><u>è®¾è®¡æ¨¡å¼ä¸­å¸¸è§çš„ä¸€å¥è¯:ç»„åˆä¼˜äºç»§æ‰¿ã€‚</u></p><p>è£…é¥°å™¨æ¨¡å¼çš„ç±»å›¾ï¼Œä»¥åŠå…¶ä¸­çš„æ ¸å¿ƒè§’è‰²ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/11/image-20200611103644916_Rw2GMv.png" alt="image-20200611103644916"></p><ul><li><p><strong>Componentï¼ˆç»„ä»¶ï¼‰</strong></p><p>ç»„ä»¶æ¥å£å®šä¹‰äº†å…¨éƒ¨ç»„ä»¶å®ç°ç±»ä»¥åŠæ‰€æœ‰è£…é¥°å™¨å®ç°çš„è¡Œä¸ºã€‚</p></li><li><p><strong>ConcreteComponent (å…·ä½“ ç»„ ä»¶å® ç° ç±» )</strong></p><p>å…·ä½“ç»„ä»¶å®ç°ç±»å®ç°äº†<code>Component</code>æ¥å£ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå…·ä½“ç»„ä»¶å®ç°ç±»å°±æ˜¯è¢«è£…é¥°å™¨è£…é¥°çš„åŸå§‹å¯¹è±¡ï¼Œè¯¥ç±»æä¾›äº†<code>Component</code>æ¥å£ä¸­å®šä¹‰çš„æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå…¶ä»–é«˜çº§åŠŸèƒ½æˆ–åç»­æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œéƒ½æ˜¯é€šè¿‡è£…é¥°å™¨çš„æ–¹å¼æ·»åŠ åˆ°è¯¥ç±»çš„å¯¹è±¡ä¹‹ä¸Šçš„ã€‚</p></li><li><p><strong>Decorator(è£…é¥°å™¨)</strong></p><p>æ‰€æœ‰è£…é¥°å™¨çš„çˆ¶ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº†<code>Component</code>æ¥å£çš„æŠ½è±¡ç±»ï¼Œå¹¶åœ¨å…¶ä¸­å°è£…äº†ä¸€ä¸ª<code>Component</code>å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¢«è£…é¥°çš„å¯¹è±¡ã€‚</p><p>è€Œè¿™ä¸ªè¢«è£…é¥°çš„å¯¹è±¡åªè¦æ˜¯<code>Component</code>ç±»å‹å³å¯ï¼Œè¿™å°±å®ç°äº†è£…é¥°å™¨çš„ç»„åˆå’Œå¤ç”¨ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œè£…é¥°å™¨**C(ConcreteDecoratorlç±»å‹)<strong>ä¿®é¥°äº†è£…é¥°å™¨</strong>B(ConcreteDecorator2ç±»å‹)**å¹¶ä¸ºå…¶æ·»åŠ åŠŸèƒ½<code>W</code>ï¼Œè€Œè£…é¥°å™¨<code>B(ConcreteDecorator2ç±»å‹)</code>åˆä¿®é¥°äº†ç»„ä»¶<code>A(ConcreteComponentç±»å‹)</code>å¹¶ä¸ºå…¶æ·»åŠ åŠŸèƒ½<code>V</code>ã€‚</p><p>å…¶ä¸­ï¼Œç»„ä»¶å¯¹è±¡Aæä¾›çš„æ˜¯æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œè£…é¥°å™¨Bå’Œè£…é¥°å™¨Cä¼šä¸ºç»„ä»¶å¯¹è±¡Aæ·»åŠ æ–°çš„åŠŸèƒ½ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/11/image-20200611105658387_IJSXLa.png" alt="image-20200611105658387"></p></li><li><p><strong>ConcreteDecorator</strong></p><p>å…·ä½“çš„è£…é¥°å™¨å®ç°ç±»ï¼Œè¯¥å®ç°ç±»è¦å‘è¢«è£…é¥°å¯¹è±¡æ·»åŠ æŸäº›åŠŸèƒ½ã€‚å¦‚ä¸Šå›¾ï¼Œè£…é¥°å™¨Bã€Cå°±æ˜¯è¯¥è§’è‰²ï¼Œè¢«è£…é¥°çš„å¯¹è±¡åªè¦æ˜¯<code>Component</code>ç±»å‹å³å¯ã€‚<br>åœ¨<code>JavaIO</code>åŒ…ä¸­ï¼Œå¤§é‡åº”ç”¨äº†è£…é¥°å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨<code>JavaIO</code>åŒ…è¯»å–æ–‡ä»¶æ—¶ï¼Œç»å¸¸ä¼šçœ‹åˆ°å¦‚ä¸‹ä»£ç :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BufferedlnputStream bis = </span><br><span class="line">  <span class="keyword">new</span> BufferedlnputStream( <span class="keyword">new</span> FilelnputStream(<span class="keyword">new</span> File(<span class="string">&quot;D:/test.txt&quot;</span>)));</span><br></pre></td></tr></table></figure></li></ul><p><code>FilelnputStream</code>å¹¶æ²¡æœ‰ç¼“å†²åŠŸèƒ½ï¼Œæ¯æ¬¡è°ƒç”¨å…¶<code>read()</code>æ–¹æ³•æ—¶éƒ½ä¼šå‘æ“ä½œç³»ç»Ÿå‘èµ·ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå½“è¯»å–å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿåœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´é¢‘ç¹åˆ‡æ¢ï¼Œæ€§èƒ½è¾ƒä½ã€‚</p><p><code>BufferedlnputStream</code>æ˜¯æä¾›äº†ç¼“å†²åŠŸèƒ½çš„è£…é¥°å™¨ï¼Œæ¯æ¬¡è°ƒç”¨å…¶<code>read()</code>æ–¹æ³•æ—¶ï¼Œä¼šé¢„å…ˆä»æ–‡ä»¶ä¸­è·å–ä¸€éƒ¨åˆ†æ•°æ®å¹¶ç¼“å­˜åˆ°<code>BufferedlnputStream</code>çš„ç¼“å†²åŒºä¸­ï¼Œåé¢è¿ç»­çš„å‡ æ¬¡è¯»å–å¯ä»¥ç›´æ¥ä»ç¼“å†²åŒºä¸­è·å–æ•°æ®ï¼Œç›´åˆ°ç¼“å†²åŒºæ•°æ®è€—å°½æ‰ä¼šé‡æ–°ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæé«˜äº†è¯»å–çš„æ€§èƒ½ã€‚</p><p>åœ¨<code>MyBatis</code>çš„ç¼“å­˜æ¨¡å—ä¸­ï¼Œä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼çš„å˜ä½“ï¼Œå…¶ä¸­å°†<code>Decorator</code>æ¥å£å’Œ<code>Component</code>æ¥å£åˆå¹¶ä¸ºä¸€ä¸ª<code>Component</code>æ¥å£</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/11/image-20200611114247838_a3jRci.png" alt="image-20200611114247838"></p><p>ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p><ul><li>ç›¸è¾ƒäºç»§æ‰¿æ¥è¯´ï¼Œè£…é¥°å™¨æ¨¡å¼çš„çµæ´»æ€§æ›´å¼ºï¼Œå¯æ‰©å±•æ€§ä¹Ÿå¼ºã€‚æ­£å¦‚å‰é¢æ‰€è¯´ï¼Œç»§æ‰¿æ–¹å¼ä¼šå¯¼è‡´å¤§é‡å­ç±»çš„æƒ…å†µã€‚<strong>è€Œè£…é¥°è€…æ¨¡å¼å¯ä»¥å°†å¤æ‚çš„åŠŸèƒ½åˆ‡åˆ†æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„è£…é¥°å™¨ï¼Œé€šè¿‡å¤šä¸ªç‹¬ç«‹è£…é¥°å™¨çš„åŠ¨æ€ç»„åˆï¼Œåˆ›å»ºä¸åŒåŠŸèƒ½çš„ç»„ä»¶ï¼Œä»è€Œæ»¡è¶³å¤šç§ä¸åŒéœ€æ±‚ã€‚</strong></li><li>å½“æœ‰æ–°åŠŸèƒ½éœ€è¦æ·»åŠ æ—¶ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„è£…é¥°å™¨å®ç°ç±»ï¼Œç„¶åé€šè¿‡ç»„åˆæ–¹å¼æ·»åŠ è¿™ä¸ªæ–°è£…é¥°å™¨å³å¯ï¼Œæ— é¡»ä¿®æ”¹å·±æœ‰ç±»çš„ä»£ç ï¼Œç¬¦åˆâ€œ<strong>å¼€æ”¾-å°é—­</strong>â€åŸåˆ™ã€‚</li></ul><p>ä½†æ˜¯ï¼Œéšç€æ·»åŠ çš„æ–°éœ€æ±‚è¶Šæ¥è¶Šå¤šï¼Œå¯èƒ½ä¼šåˆ›å»ºå‡ºåµŒå¥—å¤šå±‚è£…é¥°å™¨çš„å¯¹è±¡ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œä¹Ÿå¢åŠ äº†ç†è§£çš„éš¾åº¦å’Œå®šä½é”™è¯¯çš„éš¾åº¦ã€‚</p><h2 id="Cacheæ¥å£åŠå…¶å®ç°"><a href="#Cacheæ¥å£åŠå…¶å®ç°" class="headerlink" title="Cacheæ¥å£åŠå…¶å®ç°"></a>Cacheæ¥å£åŠå…¶å®ç°</h2><p><code>MyBatis</code>çš„ç¼“å­˜æ¨¡å—åœ¨<code>org.apache.ibatis.cache</code>åŒ…ä¸‹ï¼Œå…¶ä¸­<code>Cache</code>æ¥å£æ˜¯ç¼“å­˜æ¨¡å—çš„ä¸­æœ€æ ¸å¿ƒçš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰ç¼“å­˜çš„åŸºæœ¬è¡Œä¸ºã€‚</p><p><strong>Cache</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è¿”å›è¯¥ç¼“å­˜å¯¹åº”çš„id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The identifier of this cache</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å‘ç¼“å­˜ä¸­æ·»åŠ æ•°æ®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Keyæ˜¯CacheKeyï¼Œvalueæ˜¯æŸ¥è¯¢ç»“æœ</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key Can be any object but usually it is a &#123;<span class="doctag">@link</span> CacheKey&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value The result of a select.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä»ç¼“å­˜ä¸­è·å–æ•°æ®</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key The key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The object stored in the cache.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">getObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åˆ é™¤Keyå¯¹åº”çš„ç¼“å­˜</span></span><br><span class="line"><span class="comment">   * As of 3.3.0 this method is only called during a rollback </span></span><br><span class="line"><span class="comment">   * for any previous value that was missing in the cache.</span></span><br><span class="line"><span class="comment">   * This lets any blocking cache to release the lock that </span></span><br><span class="line"><span class="comment">   * may have previously put on the key.</span></span><br><span class="line"><span class="comment">   * A blocking cache puts a lock when a value is null </span></span><br><span class="line"><span class="comment">   * and releases it when the value is back again.</span></span><br><span class="line"><span class="comment">   * This way other threads will wait for the value to be </span></span><br><span class="line"><span class="comment">   * available instead of hitting the database.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key The key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> Not used</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">removeObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ¸…ç©ºç¼“å­˜</span></span><br><span class="line"><span class="comment">   * Clears this cache instance</span></span><br><span class="line"><span class="comment">   */</span>  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ç¼“å­˜é¡¹çš„ä¸ªæ•°ï¼Œä¸ä¼šè¢«MyBatisæ ¸å¿ƒä»£ç è°ƒç”¨</span></span><br><span class="line"><span class="comment">   * Optional. This method is not called by the core.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The number of elements stored in the cache (not its capacity).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * è·å–è¯»å†™é”ï¼Œä¸ä¼šè¢«MyBatisæ ¸å¿ƒä»£ç è°ƒç”¨</span></span><br><span class="line"><span class="comment">   * Optional. As of 3.2.6 this method is no longer called by the core.</span></span><br><span class="line"><span class="comment">   *  </span></span><br><span class="line"><span class="comment">   * Any locking needed by the cache must be provided internally by the cache provider.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A ReadWriteLock </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">ReadWriteLock <span class="title">getReadWriteLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Cache</code>æ¥å£çš„å®ç°ç±»æœ‰å¤šä¸ªï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯è£…é¥°å™¨ï¼Œåªæœ‰<code>PerpetualCache</code>æä¾›äº†Cacheæ¥å£çš„åŸºæœ¬å®ç°ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/11/image-20200611120028350_RNaWIP.png" alt="image-20200611120028350"></p><h3 id="PerpetualCache"><a href="#PerpetualCache" class="headerlink" title="PerpetualCache"></a>PerpetualCache</h3><p><code>**PerpetualCache</code>åœ¨ç¼“å­˜æ¨¡å—ä¸­æ‰®æ¼”ç€<code>ConcreteComponent</code>çš„è§’è‰²**ï¼Œå…¶å®ç°æ¯”è¾ƒç®€å•ï¼Œåº•å±‚ä½¿ç”¨<code>HashMap</code>è®°å½•ç¼“å­˜é¡¹ï¼Œä¹Ÿæ˜¯é€šè¿‡è¯¥<code>HashMap</code>å¯¹è±¡çš„æ–¹æ³•å®ç°çš„<code>Cache</code>æ¥å£ä¸­å®šä¹‰çš„ç›¸åº”æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerpetualCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PerpetualCache</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cache.size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    cache.put(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cache.get(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">removeObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cache.remove(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cache.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ReadWriteLock <span class="title">getReadWriteLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Cache)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Cache otherCache = (Cache) o;</span><br><span class="line">    <span class="keyword">return</span> getId().equals(otherCache.getId());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getId().hashCode();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ¥ä»‹ç»<code>org.apache.ibatis.cache.decorators</code>åŒ…ä¸‹æä¾›çš„è£…é¥°å™¨ï¼Œå®ƒä»¬éƒ½ç›´æ¥å®ç°äº†<code>Cache</code>æ¥å£ï¼Œæ‰®æ¼”ç€<code>ConcreteDecorator</code>çš„è§’è‰²ã€‚</p><p>è¿™äº›è£…é¥°å™¨ä¼šåœ¨<code>PerpetualCache</code>çš„åŸºç¡€ä¸Šæä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œé€šè¿‡å¤šä¸ªç»„åˆåæ»¡è¶³ä¸€ä¸ªç‰¹å®šçš„éœ€æ±‚ï¼Œåé¢ä»‹ç»äºŒçº§ç¼“å­˜æ—¶ï¼Œä¼šè§åˆ°è¿™äº›è£…é¥°å™¨æ˜¯å¦‚ä½•å®ŒæˆåŠ¨æ€ç»„åˆçš„ã€‚</p><h3 id="BlockingCache"><a href="#BlockingCache" class="headerlink" title="BlockingCache"></a>BlockingCache</h3><p><code>BlockingCache</code>æ˜¯é˜»å¡ç‰ˆæœ¬çš„ç¼“å­˜è£…é¥°å™¨ï¼Œå®ƒä¼šä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾æŒ‡å®š<code>key</code>å¯¹åº”çš„æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é˜»å¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> timeout;</span><br><span class="line"><span class="comment">// è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">// æ¯ä¸ªKeyéƒ½æœ‰å¯¹åº”çš„ReentrantLockå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;Object, ReentrantLock&gt; locks;</span><br></pre></td></tr></table></figure><p>å‡è®¾<code>çº¿ç¨‹A</code>åœ¨<code>BlockingCache</code>ä¸­æœªæŸ¥æ‰¾åˆ°<code>keyA</code>å¯¹åº”çš„ç¼“å­˜é¡¹æ—¶ï¼Œ<code>çº¿ç¨‹A</code>ä¼šè·å–<code>keyA</code>å¯¹åº”çš„é”ï¼Œè¿™æ ·åç»­çº¿ç¨‹åœ¨æŸ¥æ‰¾<code>keyA</code>æ—¶ä¼šå‘ç”Ÿé˜»å¡</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/16/image-20200616092820328_4agKqU.png" alt="image-20200616092820328"></p><p><strong>BlockingCache.getObject(Object key)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–keyå¯¹åº”çš„é”</span></span><br><span class="line">  acquireLock(key);</span><br><span class="line">  Object value = delegate.getObject(key);</span><br><span class="line">  <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç¼“å­˜æœ‰keyå¯¹åº”çš„ç¼“å­˜é¡¹ï¼Œåˆ™é‡Šæ”¾é”</span></span><br><span class="line">    releaseLock(key);</span><br><span class="line">  &#125;        </span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>acquireLock(Object key)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">acquireLock</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–ReentrantLockå¯¹è±¡</span></span><br><span class="line">  Lock lock = getLockForKey(key);</span><br><span class="line">  <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è·å–é”ï¼Œå¸¦è¶…æ—¶æ—¶é—´çš„é‚£ç§</span></span><br><span class="line">      <span class="keyword">boolean</span> acquired = lock.tryLock(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">      <span class="keyword">if</span> (!acquired) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¶…æ—¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>);  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹<code>getLockForKey</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ReentrantLock <span class="title">getLockForKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(); <span class="comment">// åˆ›å»ºReentrantLockå¯¹è±¡</span></span><br><span class="line">  <span class="comment">// è¯•æ·»åŠ åˆ°locksé›†åˆä¸­ï¼Œå¦‚æœlocksé›†åˆä¸­å·²ç»æœ‰äº†ç›¸åº”çš„ReentrantLockå¯¹è±¡ï¼Œåˆ™ä½¿ç”¨locksé›†åˆ</span></span><br><span class="line">  <span class="comment">// ä¸­çš„ReentrantLockå¯¹è±¡</span></span><br><span class="line">  ReentrantLock previous = locks.putIfAbsent(key, lock);</span><br><span class="line">  <span class="keyword">return</span> previous == <span class="keyword">null</span> ? lock : previous;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾çº¿ç¨‹Aä»æ•°æ®åº“ä¸­æŸ¥æ‰¾åˆ°keyAå¯¹åº”çš„ç»“æœå¯¹è±¡åï¼Œå°†ç»“æœå¯¹è±¡æ”¾å…¥åˆ°<code>BlockingCache</code>ä¸­ï¼Œæ­¤æ—¶çº¿ç¨‹Aä¼šé‡Šæ”¾keyAå¯¹åº”çš„é”ï¼Œå”¤é†’é˜»å¡åœ¨è¯¥é”ä¸Šçš„çº¿ç¨‹ã€‚</p><p>å…¶ä»–çº¿ç¨‹å³å¯ä»<code>BlockingCache</code>ä¸­è·å–keyAå¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸æ˜¯å†æ¬¡è®¿é—®æ•°æ®åº“ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/18/image-20200618093048912_N2ifEV.png" alt="image-20200618093048912"></p><p><strong>BlockingCache.putObject()</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹</span></span><br><span class="line">    delegate.putObject(key, value);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    releaseLock(key);<span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>BlockingCache.releaseLock(Object key)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseLock</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  ReentrantLock lock = locks.get(key);</span><br><span class="line">  <span class="keyword">if</span> (lock.isHeldByCurrentThread()) &#123; <span class="comment">// åˆ¤æ–­é”æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æŒæœ‰</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FifoCache-amp-LruCache"><a href="#FifoCache-amp-LruCache" class="headerlink" title="FifoCache&amp;LruCache"></a>FifoCache&amp;LruCache</h3><p>åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œä¸ºäº†æ§åˆ¶ç¼“å­˜çš„å¤§å°ï¼Œç³»ç»Ÿéœ€è¦æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ¸…ç†ç¼“å­˜ã€‚</p><p><code>FifoCache</code>æ˜¯å…ˆå…¥å…ˆå‡ºç‰ˆæœ¬çš„è£…é¥°å™¨ï¼Œ**<u>å½“å‘ç¼“å­˜æ·»åŠ æ•°æ®æ—¶ï¼Œå¦‚æœç¼“å­˜é¡¹çš„ä¸ªæ•°å·±ç»è¾¾åˆ°ä¸Šé™ï¼Œåˆ™ä¼šå°†ç¼“å­˜ä¸­æœ€è€(å³æœ€æ—©è¿›å…¥ç¼“å­˜)çš„ç¼“å­˜é¡¹åˆ é™¤ã€‚</u>**</p><p><code>FifoCache</code>ä¸­å­—æ®µçš„å«ä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">// ç”¨äºè®°å½•keyè¿›å…¥ç¼“å­˜çš„å…ˆåé¡ºåºï¼Œä½¿ç”¨çš„æ˜¯LinkedList&lt;Object&gt;ç±»å‹çš„å‡ ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; keyList;</span><br><span class="line"><span class="comment">// è®°å½•ç¼“å­˜é¡¹çš„ä¸Šé™ï¼Œå¦‚æœè¶…è¿‡ï¼Œåˆ™æ¸…ç†æœ€è€çš„ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</span><br></pre></td></tr></table></figure><p><u><code>FifoCache.getObject()</code>å’Œ<code>removeObject()</code>æ–¹æ³•çš„å®ç°éƒ½æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚<code>Cache</code>å¯¹è±¡çš„å¯¹åº”æ–¹æ³•ã€‚</u></p><p>åœ¨<code>FifoCache.putObject()</code>æ–¹æ³•ä¸­ä¼šå®Œæˆç¼“å­˜é¡¹ä¸ªæ•°çš„æ£€æµ‹ä»¥åŠç¼“å­˜çš„æ¸…ç†æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ£€æµ‹å¹¶æ¸…ç†ç¼“å­˜</span></span><br><span class="line">  cycleKeyList(key);</span><br><span class="line">  <span class="comment">// æ·»åŠ ç¼“å­˜é¡¹</span></span><br><span class="line">  delegate.putObject(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleKeyList</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®°å½•key</span></span><br><span class="line">  keyList.addLast(key);</span><br><span class="line">  <span class="keyword">if</span> (keyList.size() &gt; size) &#123; <span class="comment">// å¦‚æœè¾¾åˆ°ç¼“å­˜ä¸Šé™ï¼Œåˆ™æ¸…ç†æœ€è€çš„ç¼“å­˜é¡¹</span></span><br><span class="line">    Object oldestKey = keyList.removeFirst();</span><br><span class="line">    delegate.removeObject(oldestKey);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LruCache</code>æ˜¯æŒ‰ç…§è¿‘æœŸæœ€å°‘ä½¿ç”¨ç®—æ³•**(LeastRecentlyUsedï¼ŒLRU)**è¿›è¡Œç¼“å­˜æ¸…ç†çš„è£…é¥°å™¨ï¼Œåœ¨éœ€è¦æ¸…ç†ç¼“å­˜æ—¶,å®ƒä¼šæ¸…é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜é¡¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">// LinkedHashMap&lt;Object,Object&gt;ç±»å‹å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åºçš„HashMapï¼Œç”¨äºè®°å½•keyæœ€è¿‘çš„ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Object, Object&gt; keyMap;</span><br><span class="line"><span class="comment">// è®°å½•æœ€å°‘è¢«ä½¿ç”¨çš„ç¼“å­˜é¡¹çš„key</span></span><br><span class="line"><span class="keyword">private</span> Object eldestKey;</span><br></pre></td></tr></table></figure><p><code>LruCache</code>çš„æ„é€ å‡½æ•°ä¸­é»˜è®¤è®¾ç½®çš„ç¼“å­˜å¤§å°æ˜¯<strong>1024</strong>,æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶<code>setSize()</code>æ–¹æ³•é‡æ–°è®¾ç½®ç¼“å­˜å¤§å°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// é‡æ–°è®¾ç½®ç¼“å­˜å¤§å°çš„æ—¶å€™ï¼Œ ä¼šå……å€¼keyMapå­—æ®µ</span></span><br><span class="line">  <span class="comment">// LinkedHashMapæ„é€ å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œtrueè¡¨ç¤ºè¯¥LinkedHashMapè®°å½•çš„é¡ºåºæ˜¯</span></span><br><span class="line">  <span class="comment">// access-order,ä¹Ÿå°±æ˜¯è¯´LinkedHashMap.get()æ–¹æ³•ä¼šæ”¹å˜å…¶è®°å½•çš„é¡ºåº</span></span><br><span class="line">  keyMap = <span class="keyword">new</span> LinkedHashMap&lt;Object, Object&gt;(size, <span class="number">.75F</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4267176411845948333L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“è°ƒç”¨LinkedHashMap.put()æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, Object&gt; eldest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> tooBig = size() &gt; size;</span><br><span class="line">      <span class="keyword">if</span> (tooBig) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²åˆ°è¾¾ç¼“å­˜ä¸Šé™ï¼Œåˆ™æ›´æ–°eldestKeyå­—æ®µï¼Œåé¢ä¼šåˆ é™¤è¯¥é¡¹</span></span><br><span class="line">        eldestKey = eldest.getKey();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> tooBig;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LruCache.getObject()</code>æ–¹æ³•é™¤äº†è¿”å›ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šè°ƒç”¨<code>keyMap.get()</code>æ–¹æ³•ä¿®æ”¹<code>key</code>çš„é¡ºåºï¼Œè¡¨ç¤ºæŒ‡å®šçš„keyæœ€è¿‘è¢«ä½¿ç”¨ã€‚</p><p><code>LruCache.putObject()</code>æ–¹æ³•é™¤äº†æ·»åŠ ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šå°†<code>eldestKey</code>å­—æ®µæŒ‡å®šçš„ç¼“å­˜é¡¹æ¸…é™¤æ‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¿®æ”¹LinkedHashMapä¸­è®°å½•çš„é¡ºåº</span></span><br><span class="line">  delegate.putObject(key, value);</span><br><span class="line">  cycleKeyList(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  keyMap.get(key); <span class="comment">//touch</span></span><br><span class="line">  <span class="comment">// åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ç¼“å­˜é¡¹</span></span><br><span class="line">  <span class="keyword">return</span> delegate.getObject(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleKeyList</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  keyMap.put(key, key);</span><br><span class="line">  <span class="keyword">if</span> (eldestKey != <span class="keyword">null</span>) &#123; <span class="comment">// eldestKeyä¸ä¸ºç©ºï¼Œå³ç¼“å­˜å·²è¾¾åˆ°ä¸Šé™</span></span><br><span class="line">    <span class="comment">// åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ç¼“å­˜</span></span><br><span class="line">    delegate.removeObject(eldestKey);</span><br><span class="line">    eldestKey = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SoftCache-amp-WeakCache"><a href="#SoftCache-amp-WeakCache" class="headerlink" title="SoftCache&amp;WeakCache"></a>SoftCache&amp;WeakCache</h3><p>å…ˆäº†è§£ä¸€ä¸‹<a href="/2020/06/18/ae9388fa.html">Javaæä¾›çš„4ç§å¼•ç”¨ç±»å‹</a>ã€‚</p><p><code>SoftCache</code>ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ReferenceQueueï¼Œå¼•ç”¨é˜Ÿåˆ—ï¼Œç”¨äºè®°å½•å·²ç»è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹æ‰€å¯¹åº”çš„SoftEntryå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;</span><br><span class="line"><span class="comment">// åœ¨SoftCacheä¸­ï¼Œæœ€è¿‘ä½¿ç”¨çš„ä¸€éƒ¨åˆ†ç¼“å­˜é¡¹ä¸ä¼šè¢«GCå›æ”¶ï¼Œè¿™å°±æ˜¯é€šè¿‡å°†å…¶valueæ·»åŠ åˆ°</span></span><br><span class="line"><span class="comment">// hardLinksToAvoidGarbageCollectioné›†åˆä¸­å®ç°çš„(å³æœ‰å¼ºå¼•ç”¨æŒ‡å‘å…¶value)</span></span><br><span class="line"><span class="comment">// hardLinksToAvoidGarbageCollectioné›†åˆæ˜¯LinkedList&lt;Object&gt;ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;</span><br><span class="line"><span class="comment">// åº•å±‚è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">// å¼ºè¿æ¥çš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯256</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> numberOfHardLinks;</span><br></pre></td></tr></table></figure><p><code>SoftCache</code>ä¸­ç¼“å­˜é¡¹çš„<code>value</code>æ˜¯<code>SoftEntry</code>å¯¹è±¡ï¼Œ<code>SoftEntry</code>ç»§æ‰¿äº†<code>SoftReference</code>ï¼Œå…¶ä¸­æŒ‡å‘<code>key</code>çš„å¼•ç”¨æ˜¯å¼ºå¼•ç”¨ï¼Œè€ŒæŒ‡å‘<code>value</code>çš„å¼•ç”¨æ˜¯è½¯å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftEntry</span> <span class="keyword">extends</span> <span class="title">SoftReference</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">  SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123;</span><br><span class="line">    <span class="keyword">super</span>(value, garbageCollectionQueue); <span class="comment">// æŒ‡å‘valueçš„å¼•ç”¨æ˜¯è½¯å¼•ç”¨ï¼Œä¸”å…³è”äº†å¼•ç”¨é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">this</span>.key = key; <span class="comment">// å¼ºå¼•ç”¨</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SoftCache.putObject()</code>æ–¹æ³•é™¤äº†å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šæ¸…é™¤å·±ç»è¢«<code>GC</code>å›æ”¶çš„ç¼“å­˜é¡¹,å…¶å…·ä½“å®ç°å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ¸…é™¤å·²è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹</span></span><br><span class="line">  removeGarbageCollectedItems();</span><br><span class="line">  <span class="comment">// å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹</span></span><br><span class="line">  delegate.putObject(key, <span class="keyword">new</span> SoftEntry(key, value, queueOfGarbageCollectedEntries));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeGarbageCollectedItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  SoftEntry sv;</span><br><span class="line">  <span class="comment">// éå†queueOfGarbageCollectedEntriesé›†åˆ</span></span><br><span class="line">  <span class="keyword">while</span> ((sv = (SoftEntry) queueOfGarbageCollectedEntries.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å°†å·²ç»è¢«GCå›æ”¶çš„valueå¯¹è±¡å¯¹åº”çš„ç¼“å­˜é¡¹æ¸…é™¤</span></span><br><span class="line">    delegate.removeObject(sv.key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SoftCache.getObject()</code>æ–¹æ³•é™¤äº†ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„<code>value</code>,å¤„ç†è¢«<code>GC</code>å›æ”¶çš„<code>value</code>å¯¹åº”çš„ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šæ›´æ–°<code>hardLinksToAvoidGarbageCollection</code>é›†åˆ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  Object result = <span class="keyword">null</span>;</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="comment">// assumed delegate cache is totally managed by this cache</span></span><br><span class="line">  <span class="comment">// ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç¼“å­˜é¡¹</span></span><br><span class="line">  SoftReference&lt;Object&gt; softReference = (SoftReference&lt;Object&gt;) delegate.getObject(key);</span><br><span class="line">  <span class="keyword">if</span> (softReference != <span class="keyword">null</span>) &#123; <span class="comment">// æ£€æµ‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„ç¼“å­˜é¡¹</span></span><br><span class="line">    result = softReference.get(); <span class="comment">// è·å–SoftReferenceå¼•ç”¨çš„value</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;<span class="comment">// å·²ç»è¢«GCå›æ”¶</span></span><br><span class="line">      delegate.removeObject(key); <span class="comment">// ä»ç¼“å­˜ä¸­æ¸…é™¤å¯¹åº”çš„ç¼“å­˜é¡¹</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªè¢«GCå›æ”¶</span></span><br><span class="line">      <span class="comment">// See #586 (and #335) modifications need more than a read lock </span></span><br><span class="line">      <span class="keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜é¡¹çš„valueæ·»åŠ åˆ°hardLinksToAvoidGarbageCollectioné›†åˆä¸­ä¿å­˜</span></span><br><span class="line">        hardLinksToAvoidGarbageCollection.addFirst(result);</span><br><span class="line">        <span class="keyword">if</span> (hardLinksToAvoidGarbageCollection.size() &gt; numberOfHardLinks) &#123;</span><br><span class="line">          <span class="comment">// è¶…è¿‡numberOfHardLinksï¼Œåˆ™å°†æœ€è€çš„ç¼“å­˜é¡¹ä»hardLinksToAvoidGarbageCollectioné›†åˆä¸­æ¸…é™¤ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—</span></span><br><span class="line">          hardLinksToAvoidGarbageCollection.removeLast();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><u><code>SoftCache.removeObject()</code>æ–¹æ³•åœ¨æ¸…é™¤ç¼“å­˜é¡¹ä¹‹å‰ï¼Œä¹Ÿä¼šè°ƒç”¨<code>removeGarbageCollectedItems()</code>æ–¹æ³•æ¸…ç†è¢«<code>GC</code>å›æ”¶çš„ç¼“å­˜é¡¹ã€‚</u></p><p><code>SoftCache.clear()</code>æ–¹æ³•é¦–å…ˆæ¸…ç†<code>hardLinksToAvoidGarbageCollection</code>é›†åˆï¼Œç„¶åæ¸…ç†è¢«<code>GC</code>å›æ”¶çš„ç¼“å­˜é¡¹ï¼Œæœ€åæ¸…ç†åº•å±‚<code>delegate</code>ç¼“å­˜ä¸­çš„ç¼“å­˜é¡¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;</span><br><span class="line">    hardLinksToAvoidGarbageCollection.clear(); <span class="comment">// æ¸…ç†å¼ºå¼•ç”¨é›†åˆ</span></span><br><span class="line">  &#125;</span><br><span class="line">  removeGarbageCollectedItems(); <span class="comment">// æ¸…ç†è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹</span></span><br><span class="line">  delegate.clear(); <span class="comment">// æ¸…ç†åº•å±‚delegateç¼“å­˜ä¸­çš„ç¼“å­˜é¡¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>WeakCache</code>çš„å®ç°ä¸<code>SoftCache</code>åŸºæœ¬ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºå…¶ä¸­ä½¿ç”¨<code>WeakEntry</code>(ç»§æ‰¿è‡ª<code>WeakReference</code>)å°è£…çœŸæ­£çš„<code>value</code>å¯¹è±¡ï¼Œå…¶ä»–å®ç°å®Œå…¨ä¸€æ ·ã€‚</p></blockquote><h3 id="others"><a href="#others" class="headerlink" title="others"></a>others</h3><p><code>ScheduledCache</code>æ˜¯å‘¨æœŸæ€§æ¸…ç†ç¼“å­˜çš„è£…é¥°å™¨ï¼Œå®ƒçš„<code>clearlnterval</code>å­—æ®µè®°å½•äº†ä¸¤æ¬¡ç¼“å­˜æ¸…ç†ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯ä¸€å°æ—¶ï¼Œ<code>lastClear</code>å­—æ®µè®°å½•äº†æœ€è¿‘ä¸€æ¬¡æ¸…ç†çš„æ—¶é—´æˆ³ã€‚</p><p><code>ScheduledCache</code>çš„<code>getObject()</code>ã€<code>putObject()</code>ã€<code>removeObject()</code>ç­‰æ ¸å¿ƒæ–¹æ³•åœ¨æ‰§è¡Œæ—¶ï¼Œéƒ½ä¼šæ ¹æ®è¿™ä¸¤ä¸ªå­—æ®µæ£€æµ‹æ˜¯å¦éœ€è¦è¿›è¡Œæ¸…ç†æ“ä½œï¼Œæ¸…ç†æ“ä½œä¼šæ¸…ç©ºç¼“å­˜ä¸­æ‰€æœ‰ç¼“å­˜é¡¹ã€‚</p><p><code>LoggingCache</code>åœ¨<code>Cache</code>çš„åŸºç¡€ä¸Šæä¾›äº†æ—¥å¿—åŠŸèƒ½ï¼Œå®ƒé€šè¿‡<code>hit</code>å­—æ®µå’Œ<code>request</code>å­—æ®µè®°å½•äº†<code>Cache</code>çš„å‘½ä¸­æ¬¡æ•°å’Œè®¿é—®æ¬¡æ•°ã€‚</p><p>åœ¨<code>LoggingCache.getObject()</code>æ–¹æ³•ä¸­ä¼šç»Ÿè®¡å‘½ä¸­æ¬¡æ•°å’Œè®¿é—®æ¬¡æ•°è¿™ä¸¤ä¸ªæŒ‡æ ‡ï¼Œå¹¶æŒ‰ç…§æŒ‡å®šçš„æ—¥å¿—è¾“å‡ºæ–¹å¼è¾“å‡ºå‘½ä¸­ç‡ã€‚</p><p><code>SynchronizedCache</code>é€šè¿‡åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šæ·»åŠ <code>synchronized</code>å…³é”®å­—ï¼Œä¸º<code>Cache</code>æ·»åŠ äº†åŒæ­¥åŠŸèƒ½ï¼Œæœ‰ç‚¹ç±»ä¼¼äº<code>JDK</code>ä¸­<code>Collections</code>ä¸­çš„<code>SynchronizedCollection</code>å†…éƒ¨ç±»çš„å®ç°ã€‚</p><p><code>SerializedCache</code>æä¾›äº†å°†<code>value</code>å¯¹è±¡åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚</p><p><code>SerializedCache</code>åœ¨æ·»åŠ ç¼“å­˜é¡¹æ—¶ï¼Œä¼šå°†<code>value</code>å¯¹åº”çš„<code>Java</code>å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œå¹¶å°†åºåˆ—åŒ–åçš„<code>byte[]</code>æ•°ç»„ä½œä¸º<code>value</code>å­˜å…¥ç¼“å­˜ã€‚</p><p><code>SerializedCache</code>åœ¨è·å–ç¼“å­˜é¡¹æ—¶ï¼Œä¼šå°†ç¼“å­˜é¡¹ä¸­çš„<code>byte[]</code>æ•°ç»„ååºåˆ—åŒ–æˆ<code>Java</code>å¯¹è±¡ã€‚</p><p>ä½¿ç”¨å‰é¢ä»‹ç»çš„<code>Cache</code>è£…é¥°å™¨å®ç°è¿›è¡Œè£…é¥°ä¹‹åï¼Œæ¯æ¬¡ä»ç¼“å­˜ä¸­è·å–åŒä¸€<code>key</code>å¯¹åº”çš„å¯¹è±¡æ—¶ï¼Œå¾—åˆ°çš„éƒ½æ˜¯åŒä¸€å¯¹è±¡ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹è¯¥å¯¹è±¡éƒ½ä¼šå½±å“åˆ°å…¶ä»–çº¿ç¨‹ä»¥åŠç¼“å­˜ä¸­çš„å¯¹è±¡ï¼›è€Œ<code>SerializedCache</code>æ¯æ¬¡ä»ç¼“å­˜ä¸­è·å–æ•°æ®æ—¶ï¼Œéƒ½ä¼šé€šè¿‡ååºåˆ—åŒ–å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ã€‚**<code>SerializedCache</code>ä½¿ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯<code>Java</code>åŸç”Ÿåºåˆ—åŒ–ã€‚**</p><h2 id="CacheKey"><a href="#CacheKey" class="headerlink" title="CacheKey"></a>CacheKey</h2><p>åœ¨<code>Cache</code>ä¸­å”¯ä¸€ç¡®å®šä¸€ä¸ªç¼“å­˜é¡¹éœ€è¦ä½¿ç”¨ç¼“å­˜é¡¹çš„<code>key</code>,<code>MyBatis</code>ä¸­å› ä¸ºæ¶‰åŠåŠ¨æ€<code>SQL</code>ç­‰å¤šæ–¹é¢å› ç´ ï¼Œå…¶ç¼“å­˜é¡¹çš„<code>key</code>ä¸èƒ½ä»…ä»…é€šè¿‡ä¸€ä¸ª<code>String</code>è¡¨ç¤ºï¼Œæ‰€ä»¥<code>MyBatis</code>æä¾›äº†<code>CacheKey</code>ç±»æ¥è¡¨ç¤ºç¼“å­˜é¡¹çš„<code>key</code>ï¼Œåœ¨ä¸€ä¸ª<code>CacheKey</code>å¯¹è±¡ä¸­å¯ä»¥å°è£…å¤šä¸ªå½±å“ç¼“å­˜é¡¹çš„å› ç´ ã€‚</p><p><code>CacheKey</code>ä¸­å¯ä»¥æ·»åŠ å¤šä¸ªå¯¹è±¡ï¼Œç”±è¿™äº›å¯¹è±¡å…±åŒç¡®å®šä¸¤ä¸ª<code>CacheKey</code>å¯¹è±¡æ˜¯å¦ç›¸åŒã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‚ä¸è®¡ç®—hashcodeï¼Œé»˜è®¤å€¼37</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> multiplier;</span><br><span class="line"><span class="comment">// CacheKeyçš„hashcodeï¼Œåˆå§‹å€¼æ˜¯37</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hashcode;</span><br><span class="line"><span class="comment">// æ ¡éªŒå’Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> checksum;</span><br><span class="line"><span class="comment">// updateListé›†åˆçš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"><span class="comment">// ç”±è¯¥é›†åˆä¸­çš„æ‰€æœ‰å¯¹è±¡å…±åŒå†³å®šä¸¤ä¸ªCacheKeyæ˜¯å¦ç›¸åŒ</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Object&gt; updateList;</span><br></pre></td></tr></table></figure><p>åœ¨å‘<code>CacheKey.updateList</code>é›†åˆä¸­æ·»åŠ å¯¹ è±¡æ—¶ ï¼Œä½¿ç”¨çš„æ˜¯<code>CacheKey.update()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> baseHashCode = object == <span class="keyword">null</span> ? <span class="number">1</span> : ArrayUtil.hashCode(object); </span><br><span class="line">  <span class="comment">// é‡æ–°è®¡ç®—countã€checksumå’Œhashcodeçš„å€¼</span></span><br><span class="line">  count++;</span><br><span class="line">  checksum += baseHashCode;</span><br><span class="line">  baseHashCode *= count;</span><br><span class="line"></span><br><span class="line">  hashcode = multiplier * hashcode + baseHashCode;</span><br><span class="line"><span class="comment">// å°†objectæ·»åŠ åˆ°updateListé›†åˆä¸­</span></span><br><span class="line">  updateList.add(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”bindingæ¨¡å—</title>
      <link href="/blog/2019/10/30/e275ec7f.html"/>
      <url>/blog/2019/10/30/e275ec7f.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm_zgJEGC.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„bindingæ¨¡å—</p></blockquote><p>åœ¨ <code>iBatis</code> (MyBatis çš„å‰èº«)ä¸­ï¼ŒæŸ¥ è¯¢ ä¸€ä¸ª <code>Blog</code> å¯¹ è±¡æ—¶ éœ€è¦è°ƒ ç”¨ <code>SqlSession.queryForObject (&quot;selectBlog&quot;, blogld)</code>æ–¹æ³•ã€‚</p><p>å…¶ä¸­ï¼Œ<code>SqlSession.queryForObject()</code>æ–¹æ³•ä¼š æ‰§ è¡ŒæŒ‡å®šçš„ <code>SQL</code> è¯­ å¥è¿› è¡Œ æŸ¥ è¯¢ å¹¶ è¿”å›ä¸€ä¸ª ç»“ æœå¯¹ è±¡ï¼Œç¬¬ä¸€ä¸ª å‚ æ•° <code>selectBlog</code>æŒ‡æ˜äº†å…·ä½“ æ‰§ è¡Œçš„<code>SQL</code>è¯­ å¥çš„<code>id</code>,è¯¥ <code>SQL</code> è¯­ å¥å®šä¹‰ åœ¨ç›¸åº” çš„æ˜ å°„é…ç½®æ–‡ä»¶ä¸­ã€‚</p><p>å¦‚æœæˆ‘ä»¬ é”™ å°† <code>selectBlog</code>å†™ æˆäº† <code>selectBlogl</code>ï¼Œåœ¨åˆå§‹ åŒ–è¿‡ ç¨‹ä¸­ï¼Œ<code>MyBatis</code>æ˜¯æ— æ³•æç¤ºè¯¥ é”™ è¯¯ çš„ï¼Œè€Œåœ¨å® é™… è°ƒ ç”¨<code>queryForObject(selectBlog1ï¼Œblogld)</code> æ–¹æ³•æ—¶æ‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼€å‘äººå‘˜æ‰èƒ½çŸ¥é“è¯¥é”™è¯¯ã€‚</p><p><code>MyBatis</code>æä¾›äº† <code>binding</code>æ¨¡å— ç”¨äºè§£å†³ ä¸Šè¿°é—® é¢˜ ï¼Œæˆ‘ä»¬ å¯ä»¥å®šä¹‰ ä¸€ä¸ª  <code>Mapper</code>æ¥å£ï¼Œè¯¥ ç¤ºä¾‹ä¸­ä¸º <code>BlogMapper</code>æ¥å£ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><em>è¿™ é‡Œçš„ <code>BlogMapper</code>æ¥å£å¹¶ ä¸éœ€è¦ç»§ æ‰¿ä»»ä½•å…¶ä»–æ¥å£ï¼Œè€Œä¸”å¼€ å‘ äººå‘˜ ä¸éœ€è¦æä¾›è¯¥ æ¥å£çš„å® ç° ã€‚</em></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BlogMapper</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åœ¨æ˜ å°„æ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ª&lt;select&gt;æ¥å£ï¼Œidä¸º selectById</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Blog <span class="title">selectById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ <code>Mapper</code>æ¥å£ä¸­å®šä¹‰ äº† <code>SQL</code>è¯­ å¥å¯¹ åº” çš„æ–¹æ³•ï¼Œè¿™ äº›æ–¹æ³•åœ¨<code>MyBatis</code>åˆå§‹åŒ–è¿‡ ç¨‹ä¸­ä¼š ä¸ æ˜  å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ çš„<code>SQL</code>è¯­ å¥ç›¸å…³ è” ã€‚å¦‚æœå­˜åœ¨æ— æ³•å…³ è” çš„<code>SQL</code>è¯­ å¥ï¼Œåœ¨ <code>MyBatis</code>çš„åˆå§‹åŒ– èŠ‚ ç‚¹å°±ä¼š æŠ›å‡ºå¼‚ å¸¸ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è°ƒ ç”¨<code>Mapper</code>æ¥å£ä¸­çš„æ–¹æ³•æ‰§ è¡Œç›¸åº” çš„<code>SQL</code>è¯­ å¥ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬ææ—©å‘ç°ä¸Šè¿°é—®é¢˜ ã€‚</p><p>æŸ¥è¯¢blogï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">blogMapper mapp = session.getMapper(BlogMapper.class);</span><br><span class="line">Blog blog = mapp.selectById(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><strong>bindingæ¨¡å—æ ¸å¿ƒç»„ä»¶</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/10/image-20200610142911476_529HtN.png" alt="image-20200610142911476"></p><h2 id="MapperRegistry-amp-MapperProxyFactory"><a href="#MapperRegistry-amp-MapperProxyFactory" class="headerlink" title="MapperRegistry&amp;MapperProxyFactory"></a>MapperRegistry&amp;MapperProxyFactory</h2><h3 id="MapperRegistry"><a href="#MapperRegistry" class="headerlink" title="MapperRegistry"></a>MapperRegistry</h3><p><u><code>MapperRegistry</code>æ˜¯ <code>Mapper</code>æ¥å£åŠå…¶å¯¹ åº” çš„ä»£ç†å¯¹ è±¡å·¥å‚ çš„æ³¨å†Œ ä¸­å¿ƒã€‚</u><code>Configuration</code>æ˜¯ <code>MyBatis</code>å…¨å±€æ€§çš„é…ç½®å¯¹ è±¡ï¼Œåœ¨ <code>MyBatis</code>åˆå§‹åŒ–çš„è¿‡ ç¨‹ä¸­ï¼Œæ‰€æœ‰é…ç½®ä¿¡æ¯ä¼š è¢«è§£ææˆç›¸åº” çš„å¯¹ è±¡å¹¶ è®° å½• åˆ°<code>Configuration</code>å¯¹ è±¡ä¸­ã€‚è¿™ é‡Œ å…³ æ³¨ <code>Configuration.mapperRegistry</code>å­— æ®µ ï¼Œ å®ƒ è®° å½• å½“ å‰ ä½¿ ç”¨ çš„ <code>MapperRegistry</code>å¯¹ è±¡ ã€‚</p><p><strong>MapperRegistryä¸­å­—æ®µåŠå«ä¹‰</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationå¯¹è±¡ï¼ŒMyBatisä¸­å…¨å±€å”¯ä¸€çš„é…ç½®å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Configuration config;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•Mapperæ¥å£ä¸å¯¹åº”MapperRegistryä¹‹é—´çš„å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers </span><br><span class="line">  = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure><p>åœ¨ <code>MyBatis</code>åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¯»å–<strong>æ˜ å°„é…ç½®æ–‡ä»¶</strong>ä»¥åŠ<code>Mapper</code>æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ï¼Œå¹¶ è°ƒ ç”¨ <code>MapperRegistry.addMapper()</code>æ–¹ æ³• å¡« å…… <code>MapperRegistry.knownMappers</code> é›† åˆ ï¼Œ è¯¥ é›† åˆ çš„ key æ˜¯ <code>Mapper</code>æ¥å£å¯¹ åº” çš„<code>Class</code>å¯¹ è±¡ï¼Œ<code>value</code>ä¸º <code>MapperProxyFactory</code>å·¥å‚ å¯¹ è±¡ï¼Œå¯ä»¥ä¸º <code>Mapper</code>æ¥å£åˆ› å»ºä»£ç†å¯¹ è±¡ã€‚<code>MapperRegistry.addMapper()</code>æ–¹æ³•çš„ éƒ¨åˆ†å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type.isInterface()) &#123;<span class="comment">// æ£€æµ‹typeæ˜¯å¦ä¸ºæ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå·²ç»æ·»åŠ æœè¯¥æ¥å£ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Mapperæ¥å£å¯¹åº”çš„Classå¯¹è±¡å’ŒMapperProxyFactoryå¯¹è±¡æ·»åŠ åˆ°knownMappersé›†åˆ</span></span><br><span class="line">      knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;T&gt;(type));</span><br><span class="line">      <span class="comment">// It&#x27;s important that the type is added before the parser is run</span></span><br><span class="line">      <span class="comment">// otherwise the binding may automatically be attempted by the</span></span><br><span class="line">      <span class="comment">// mapper parser. If the type is already known, it won&#x27;t try.</span></span><br><span class="line">      <span class="comment">// XMLè§£æå’Œæ³¨è§£å¤„ç†</span></span><br><span class="line">      MapperAnnotationBuilder parser = <span class="keyword">new</span> MapperAnnotationBuilder(config, type);</span><br><span class="line">      parser.parse();</span><br><span class="line">      loadCompleted = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">        knownMappers.remove(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éœ€è¦æ‰§ è¡ŒæŸ<code>SQL</code>è¯­ å¥æ—¶ ï¼Œ<strong>ä¼š å…ˆè°ƒ ç”¨<code>MapperRegistry.getMapper()</code>æ–¹æ³•è· å–å® ç° äº† <code>Mapper</code> æ¥å£çš„ä»£ç†å¯¹ è±¡</strong>ï¼Œä¾‹å¦‚æœ¬èŠ‚ å¼€ å§‹çš„ç¤ºä¾‹ä¸­ï¼Œ<code>session.getMapper(BlogMapper.class)</code>æ–¹æ³•å¾—åˆ°çš„å® é™… ä¸Š æ˜¯ <code>MyBatis</code>é€š è¿‡ <strong>JDKåŠ¨ æ€ ä»£ ç†</strong> ä¸º <code>BlogMapper</code>æ¥ å£ ç”Ÿ æˆ çš„ ä»£ ç† å¯¹ è±¡ ã€‚<code>MapperRegistry.getMapper()</code> æ–¹æ³•çš„ä»£ç  å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾æŒ‡å®štypeçš„MapperProxyFactoryå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory </span><br><span class="line">    = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">  <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå®ç°äº†typeæ¥å£çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MapperProxyFactory"><a href="#MapperProxyFactory" class="headerlink" title="MapperProxyFactory"></a>MapperProxyFactory</h3><p><code>MapperProxyFactory</code>ä¸»è¦è´Ÿ è´£ åˆ› å»ºä»£ç†å¯¹ è±¡ï¼Œå…¶ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å’ŒåŠŸèƒ½å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰MapperProxyFactoryå¯¹è±¡å¯ä»¥åˆ›å»ºå®ç°äº†mapperlnterfaceæ¥å£çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å­˜ï¼Œkeyæ˜¯mapperlnterfaceæ¥å£ä¸­æŸæ–¹æ³•å¯¹åº”çš„Methodå¯¹è±¡ï¼Œvalueæ˜¯å¯¹åº”çš„MapperMethodå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache </span><br><span class="line">  = <span class="keyword">new</span> ConcurrentHashMap&lt;Method, MapperMethod&gt;();</span><br></pre></td></tr></table></figure><p><code>MapperProxyFactory.newInstance()</code>æ–¹æ³•å®ç°äº†åˆ›å»ºå®ç°äº†<code>mapperlnterface</code> æ¥å£çš„ä»£ç†å¯¹è±¡çš„åŠŸèƒ½ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line"><span class="comment">//  åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºMapperProxyå¯¹è±¡ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°çš„MapperProxyå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy </span><br><span class="line">    = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">  <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MapperProxy"><a href="#MapperProxy" class="headerlink" title="MapperProxy"></a>MapperProxy</h2><p><code>MapperProxy</code>å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œ<code>InvocationHandler</code>æ˜¯å®ç°<code>JDK</code>ä»£ç†å¯¹è±¡çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><p><code>MappProxy</code>ä¸­æ ¸å¿ƒå­—æ®µå«ä¹‰å’ŒåŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•äº†å…³è”çš„SqlSessionå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapperæ¥å£å¯¹åº”çš„classå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºç¼“å­˜MapperMethodå¯¹è±¡ï¼Œå…¶ä¸­keyæ˜¯Mapperæ¥å£ä¸­æ–¹æ³•å¯¹åº”çš„Methodå¯¹è±¡ï¼Œvalueæ˜¯å¯¹åº”çš„MapperMethodå¯¹è±¡</span></span><br><span class="line"><span class="comment">// MapperMethodå¯¹è±¡ä¼šå®Œæˆå‚æ•°è½¬æ¢ä»¥åŠSQLè¯­å¥çš„æ‰§è¡ŒåŠŸèƒ½</span></span><br><span class="line"><span class="comment">// MapperMethodä¸­å¹¶ä¸è®°å½•ä»»ä½•çŠ¶æ€ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å¤šä¸ªä»£ç†å¯¹è±¡ä¹‹é—´å…±äº«</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br></pre></td></tr></table></figure><p><code>MapperProxy.invoke()</code>æ–¹æ³•æ˜¯ä»£ç†å¯¹è±¡æ‰§è¡Œçš„ä¸»è¦é€»è¾‘ï¼Œå®ç°å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç›®æ ‡æ–¹æ³•ç»§æ‰¿è‡ªObjectï¼Œåˆ™ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œæ˜¯é’ˆå¯¹java7ä»¥ä¸Šç‰ˆæœ¬åŠ¨æ€ç±»å‹è¯­è¨€çš„æ”¯æŒ</span></span><br><span class="line">      <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä»ç¼“å­˜ä¸­è·å–MapperMethodå¯¹è±¡ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºæ–°çš„MapperMethodå¯¹è±¡å¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">  <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">  <span class="comment">// æ‰§è¡ŒSQLè¯­å¥</span></span><br><span class="line">  <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MapperProxy.cachedMapperMethod()</code>æ–¹æ³•ä¸»è¦è´Ÿè´£ç»´æŠ¤<code>methodCache</code>è¿™ä¸ªç¼“å­˜é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> MapperMethod <span class="title">cachedMapperMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆä»ç¼“å­˜ä¸­è·å–MapperMethodå¯¹è±¡</span></span><br><span class="line">  MapperMethod mapperMethod = methodCache.get(method);</span><br><span class="line">  <span class="keyword">if</span> (mapperMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜å°±çˆ±ä½ mapperMethodå¯¹è±¡å¹¶æ”¾åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">    mapperMethod = <span class="keyword">new</span> MapperMethod(mapperInterface, method, sqlSession.getConfiguration());</span><br><span class="line">    methodCache.put(method, mapperMethod);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mapperMethod;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MapperMethod"><a href="#MapperMethod" class="headerlink" title="MapperMethod"></a>MapperMethod</h2><p><code>MapperMethod</code>ä¸­å°è£…äº† <code>Mapper</code>æ¥å£ä¸­å¯¹åº”æ–¹æ³•çš„ä¿¡æ¯ï¼Œä»¥åŠå¯¹åº” <code>SQL</code>è¯­å¥çš„ä¿¡æ¯ã€‚</p><p> <strong>å¯ä»¥å°† <code>MapperMethod</code>çœ‹ä½œè¿æ¥ <code>Mapper</code>æ¥å£ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>SQL</code>è¯­å¥çš„æ¡¥æ¢ã€‚</strong> </p><p><code>MapperMethod</code>ä¸­å„ä¸ªå­—æ®µçš„ä¿¡æ¯å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•SQLè¯­å¥å’Œç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlCommand command;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mapperæ¥å£å¯¹åº”æ–¹æ³•çš„ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MethodSignature method;</span><br></pre></td></tr></table></figure><h3 id="SqlCommand"><a href="#SqlCommand" class="headerlink" title="SqlCommand"></a>SqlCommand</h3><p><code>SqlCommand</code>æ˜¯ <code>MapperMethod</code>ä¸­å®šä¹‰ çš„å†… éƒ¨ç±» ,å®ƒ ä½¿ç”¨<code>name</code>å­—æ®µè®° å½• äº† <code>SQL</code>è¯­ å¥çš„åç§° , ä½¿ç”¨<code>type</code>å­— æ®µ (<code>SqlCommandType</code>ç±» å‹)è®° å½• äº† <code>SQL</code>è¯­ å¥çš„ç±» å‹ã€‚</p><p><strong><code>SqlCommandType</code>æ˜¯æšä¸¾ç±»å‹ ï¼Œæœ‰æ•ˆå–å€¼ä¸º<code>UNKNOWN</code>ã€<code>INSERT</code>ã€<code>UPDATE</code>ã€<code>DELETE</code>ã€<code>SELECT</code>ã€<code>FLUSH</code>ã€‚</strong></p><p><code>SqlCommand</code>çš„æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–<code>name</code>å­—æ®µå’Œ<code>type</code>å­—æ®µï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SqlCommand</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String methodName = method.getName();</span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">  MappedStatement ms </span><br><span class="line">    = resolveMappedStatement(mapperInterface, methodName, declaringClass,</span><br><span class="line">                                              configuration);</span><br><span class="line">  <span class="keyword">if</span> (ms == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getAnnotation(Flush.class) != <span class="keyword">null</span>) &#123; <span class="comment">// @Flushå¤„ç†</span></span><br><span class="line">      name = <span class="keyword">null</span>;</span><br><span class="line">      type = SqlCommandType.FLUSH;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    name = ms.getId();</span><br><span class="line">    type = ms.getSqlCommandType();</span><br><span class="line">    <span class="keyword">if</span> (type == SqlCommandType.UNKNOWN) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Unknown execution method for: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MappedStatement <span class="title">resolveMappedStatement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; mapperInterface, String methodName,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; declaringClass, Configuration configuration)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// SQLè¯­å¥çš„åç§°æ˜¯ç”±Mapperæ¥å£çš„åç§°ä¸å¯¹åº”çš„æ–¹æ³•åç§°ç»„æˆçš„</span></span><br><span class="line">  String statementId = mapperInterface.getName() + <span class="string">&quot;.&quot;</span> + methodName;</span><br><span class="line">  <span class="keyword">if</span> (configuration.hasStatement(statementId)) &#123; <span class="comment">// æ£€æµ‹æ˜¯å¦æœ‰è¯¥åç§°çš„SQLè¯­å¥</span></span><br><span class="line">    <span class="comment">// ä»Configuration.mappedStatementsé›†åˆä¸­æŸ¥æ‰¾å¯¹åº”çš„MappedStatementå¯¹è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">// MappedStatementå¯¹è±¡ä¸­å°è£…äº†SQLè¯­å¥ç›¸å…³çš„ä¿¡æ¯ï¼Œåœ¨MyBatisåˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œåé¢è¯¦ç»†æè¿°</span></span><br><span class="line">    <span class="keyword">return</span> configuration.getMappedStatement(statementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mapperInterface.equals(declaringClass)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (Class&lt;?&gt; superInterface : mapperInterface.getInterfaces()) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæŒ‡å®šæ–¹æ³•æ˜¯åœ¨çˆ¶æ¥å£ä¸­å®šä¹‰çš„ï¼Œåˆ™åœ¨æ­¤è¿›è¡Œç»§æ‰¿ç»“æ„çš„å¤„ç†</span></span><br><span class="line">      <span class="keyword">if</span> (declaringClass.isAssignableFrom(superInterface)) &#123;</span><br><span class="line">        <span class="comment">// é€’å½’å¤„ç†</span></span><br><span class="line">        MappedStatement ms = </span><br><span class="line">          resolveMappedStatement(superInterface,methodName,declaringClass, configuration);</span><br><span class="line">        <span class="keyword">if</span> (ms != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> ms;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ParamNameResolver"><a href="#ParamNameResolver" class="headerlink" title="ParamNameResolver"></a>ParamNameResolver</h3><p>åœ¨ <code>MethodSignature</code>ä¸­ ï¼Œä¼š ä½¿ ç”¨ <code>ParamNameResolver</code>å¤„ ç† <code>Mapper</code>æ¥ å£ ä¸­ å®š ä¹‰ çš„ æ–¹ æ³• çš„ å‚ æ•° åˆ— è¡¨ ã€‚</p><p><code>ParamNameResolver</code> ä½¿ç”¨ <code>name</code> å­— æ®µ (<code>SortedMap&lt;Integer, String&gt;</code>ç±» å‹ )è®° å½• äº† å‚ æ•° åœ¨ å‚<br> æ•° åˆ—è¡¨ä¸­çš„ä½ç½®ç´¢å¼•ä¸ å‚ æ•° åç§° ä¹‹é—´ çš„å¯¹ åº” å…³ ç³»ï¼Œå…¶ä¸­<code>key</code>è¡¨ç¤ºå‚ æ•° åœ¨å‚ æ•° åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œ <code>value</code>è¡¨ç¤ºå‚ æ•° åç§° ï¼Œå‚ æ•° åç§° å¯ä»¥é€šè¿‡ <code>@Param</code>æ³¨è§£æŒ‡å®šï¼Œå¦‚æœæ²¡ æœ‰æŒ‡å®š<code>@Param</code>æ³¨è§£ï¼Œåˆ™ ä½¿ ç”¨å‚ æ•° ç´¢å¼•ä½œä¸º å…¶åç§° ã€‚</p><p>å¦‚æœå‚ æ•° åˆ—è¡¨ä¸­åŒ…å«<code>RowBounds</code>ç±» å‹ æˆ– <code>ResultHandler</code>ç±» å‹çš„å‚ æ•° ï¼Œ åˆ™ è¿™ ä¸¤ ç§ ç±» å‹çš„å‚ æ•° å¹¶ ä¸ä¼š è¢«è®° å½• åˆ°<code>name</code>é›†åˆä¸­ï¼Œè¿™ å°±ä¼š å¯¼ è‡´å‚ æ•° çš„ç´¢å¼•ä¸ åç§° ä¸ä¸€è‡´ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/10/image-20200610153922096_DqRtVF.png" alt="image-20200610153922096"></p><p><code>ParamNameResolver</code>çš„ <code>hasParamAnnotation</code>å­— æ®µ (<code>boolean</code>ç±» å‹ )è®° å½• å¯¹ åº” æ–¹ æ³• çš„ å‚ æ•° åˆ— è¡¨ ä¸­æ˜¯å¦ä½¿ç”¨äº† <code>@Param</code>æ³¨ è§£ ã€‚</p><p>åœ¨ <code>ParamNameResolver</code>çš„æ„ é€ æ–¹æ³•ä¸­ï¼Œä¼š é€šè¿‡ åå°„çš„æ–¹å¼è¯» å–<code>Mapper</code>æ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¹¶åˆå§‹åŒ–ä»¥ä¸Šå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ParamNameResolver</span><span class="params">(Configuration config, Method method)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å‚æ•°åˆ—è¡¨ä¸­æ¯ä¸ªå‚æ•°çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line">  <span class="comment">// è·å–å‚æ•°åˆ—è¡¨ä¸Šçš„æ³¨è§£</span></span><br><span class="line">  <span class="keyword">final</span> Annotation[][] paramAnnotations = method.getParameterAnnotations();</span><br><span class="line">  <span class="comment">// è®°å½•å‚æ•°ç´¢å¼•ä¸å‚æ•°åç§°çš„å¯¹åº”å…³ç³»</span></span><br><span class="line">  <span class="keyword">final</span> SortedMap&lt;Integer, String&gt; map = <span class="keyword">new</span> TreeMap&lt;Integer, String&gt;();</span><br><span class="line">  <span class="keyword">int</span> paramCount = paramAnnotations.length;</span><br><span class="line">  <span class="comment">// get names from @Param annotations</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> paramIndex = <span class="number">0</span>; paramIndex &lt; paramCount; paramIndex++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSpecialParameter(paramTypes[paramIndex])) &#123;</span><br><span class="line">      <span class="comment">// skip special parameters</span></span><br><span class="line">      <span class="comment">// å¦‚æœå‚æ•°æ˜¯RowBoundsç±»å‹æˆ–ResultHandlerç±»å‹ï¼Œåˆ™è·³è¿‡å¯¹è¯¥å‚æ•°çš„åˆ†æ</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// éå†å‚æ•°å¯¹åº”çš„æ³¨è§£é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (Annotation annotation : paramAnnotations[paramIndex]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Param) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå‡ºç°è¿‡@Paramå°±æŠŠhasParamAnnotationåˆå§‹åŒ–ä¸ºtrue</span></span><br><span class="line">        hasParamAnnotation = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// è·å–@Paramæ³¨è§£æŒ‡å®šçš„å‚æ•°åç§°</span></span><br><span class="line">        name = ((Param) annotation).value();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// @Param was not specified.</span></span><br><span class="line">      <span class="keyword">if</span> (config.isUseActualParamName()) &#123;</span><br><span class="line">        name = getActualParamName(method, paramIndex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// use the parameter index as the name (&quot;0&quot;, &quot;1&quot;, ...)</span></span><br><span class="line">        <span class="comment">// gcode issue #71</span></span><br><span class="line">        name = String.valueOf(map.size());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    map.put(paramIndex, name);</span><br><span class="line">  &#125;</span><br><span class="line">  names = Collections.unmodifiableSortedMap(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>names</code>é›†åˆä¸»è¦åœ¨<code>ParamNameResolver.getNamedParams()</code>æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œè¯¥ æ–¹æ³•æ¥æ”¶çš„å‚ æ•° æ˜¯ ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨ï¼Œå¹¶å°†å®å‚ä¸å…¶å¯¹åº”åç§°è¿›è¡Œå…³è”ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getNamedParams</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> paramCount = names.size();</span><br><span class="line">  <span class="keyword">if</span> (args == <span class="keyword">null</span> || paramCount == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasParamAnnotation &amp;&amp; paramCount == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> args[names.firstKey()];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, Object&gt; param = <span class="keyword">new</span> ParamMap&lt;Object&gt;();</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Integer, String&gt; entry : names.entrySet()) &#123;</span><br><span class="line">      param.put(entry.getValue(), args[entry.getKey()]);</span><br><span class="line">      <span class="comment">// add generic param names (param1, param2, ...)</span></span><br><span class="line">      <span class="keyword">final</span> String genericParamName = GENERIC_NAME_PREFIX + String.valueOf(i + <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// ensure not to overwrite parameter named with @Param</span></span><br><span class="line">      <span class="keyword">if</span> (!names.containsValue(genericParamName)) &#123;</span><br><span class="line">        param.put(genericParamName, args[entry.getKey()]);</span><br><span class="line">      &#125;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> param;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MethodSignature"><a href="#MethodSignature" class="headerlink" title="MethodSignature"></a>MethodSignature</h3><p><code>MethodSignature</code> ä¹Ÿ æ˜¯ <code>MapperMethod</code>ä¸­å®šä¹‰ çš„å†… éƒ¨ç±» ï¼Œå…¶ä¸­å°è£… äº† <code>Mapper</code>æ¥å£ä¸­å®šä¹‰ çš„æ–¹æ³•çš„ç›¸å…³ ä¿¡æ¯ï¼Œ <code>MethodSignature</code>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸º Collectionç±»å‹æˆ–æ˜¯æ•°ç»„ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsMany;</span><br><span class="line"><span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºMapç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsMap;</span><br><span class="line"><span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºVoidç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsVoid;</span><br><span class="line"><span class="comment">// è¿”å›ç±»å‹æ˜¯å¦ä¸ºCursorç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsCursor;</span><br><span class="line"><span class="comment">// è¿”å›å€¼ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; returnType;</span><br><span class="line"><span class="comment">// å¦‚æœè¿”å›å€¼ç±»å‹æ˜¯Mapï¼Œåˆ™è¯¥å­—æ®µè®°å½•äº†ä½œä¸ºkeyçš„åˆ—å</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String mapKey;</span><br><span class="line"><span class="comment">// ç”¨æ¥æ ‡è®°è¯¥æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­ResultHandlerç±»å‹å‚æ•°çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer resultHandlerIndex;</span><br><span class="line"><span class="comment">// ç”¨æ¥æ ‡è®°è¯¥æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­RowBoundsç±»å‹å‚æ•°çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Integer rowBoundsIndex;</span><br><span class="line"><span class="comment">//  æ–¹æ³•å¯¹åº”çš„ParamNameResolverå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ParamNameResolver paramNameResolver;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>MethodSignature</code>çš„æ„ é€ å‡½æ•° ä¸­ä¼š è§£æç›¸åº” çš„<code>Method</code>å¯¹ è±¡ï¼Œå¹¶ åˆå§‹åŒ–ä¸Šè¿°å­—æ®µï¼Œå…·ä½“ ä»£ ç  å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> MethodSignature</span><br><span class="line">  (Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;</span><br><span class="line">  Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface);</span><br><span class="line">  <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> Class&lt;?&gt;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.returnType = (Class&lt;?&gt;) resolvedReturnType;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">    <span class="keyword">this</span>.returnType = (Class&lt;?&gt;) ((ParameterizedType) resolvedReturnType).getRawType();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.returnType = method.getReturnType();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.returnsVoid = <span class="keyword">void</span>.class.equals(<span class="keyword">this</span>.returnType);</span><br><span class="line">  <span class="keyword">this</span>.returnsMany = </span><br><span class="line">    configuration.getObjectFactory().isCollection(<span class="keyword">this</span>.returnType) </span><br><span class="line">    || <span class="keyword">this</span>.returnType.isArray();</span><br><span class="line">  <span class="keyword">this</span>.returnsCursor = Cursor.class.equals(<span class="keyword">this</span>.returnType);</span><br><span class="line">  <span class="comment">// è‹¥MethodSignatureå¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ æ˜¯Mapä¸”æŒ‡å®šäº†@MapKeyæ³¨è§£ï¼Œåˆ™ ä½¿ç”¨getMapKey()æ–¹æ³•å¤„ ç†</span></span><br><span class="line">  <span class="keyword">this</span>.mapKey = getMapKey(method);</span><br><span class="line">  <span class="keyword">this</span>.returnsMap = <span class="keyword">this</span>.mapKey != <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.rowBoundsIndex = getUniqueParamIndex(method, RowBounds.class);</span><br><span class="line">  <span class="keyword">this</span>.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler.class);</span><br><span class="line">  <span class="keyword">this</span>.paramNameResolver = <span class="keyword">new</span> ParamNameResolver(configuration, method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getUniqueParamIndex()</code>æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯æŸ¥æ‰¾æŒ‡å®šç±»å‹çš„å‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Integer <span class="title">getUniqueParamIndex</span><span class="params">(Method method, Class&lt;?&gt; paramType)</span> </span>&#123;</span><br><span class="line">  Integer index = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt;[] argTypes = method.getParameterTypes();</span><br><span class="line">  <span class="comment">// éå†MethodSignatureå¯¹åº”æ–¹æ³•çš„å‚æ•°åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (paramType.isAssignableFrom(argTypes[i])) &#123;</span><br><span class="line">      <span class="keyword">if</span> (index == <span class="keyword">null</span>) &#123; <span class="comment">// è®°å½•paramTypeç±»å‹å‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®ç´¢å¼•</span></span><br><span class="line">        index = i;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// RowBoundså’ŒResultHandlerç±»å‹çš„å‚æ•°åªèƒ½æœ‰ä¸€ä¸ªï¼Œä¸èƒ½é‡å¤å‡ºç°</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>convertArgsToSqlCommandParam()</code>è¾…åŠ©æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è´Ÿè´£å°†args[]æ•°ç»„(ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨)è½¬æ¢æˆSQLè¯­å¥å¯¹åº”çš„å‚æ•°åˆ—è¡¨ï¼Œå®ƒæ˜¯é€šè¿‡ä¸Šé¢ä»‹ç»çš„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">convertArgsToSqlCommandParam</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> paramNameResolver.getNamedParams(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MapperMethod-execute"><a href="#MapperMethod-execute" class="headerlink" title="MapperMethod.execute()"></a>MapperMethod.execute()</h3><p><code>MapperMethod</code>ä¸­ æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯<code>execute()</code>æ–¹æ³•ï¼Œå®ƒ ä¼š æ ¹æ®<code>SQL</code>è¯­ å¥çš„ç±» å‹è°ƒ ç”¨<code>SqlSession</code>å¯¹ åº” çš„æ–¹æ³•å®Œæˆæ•° æ® åº“ æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">  Object result;</span><br><span class="line">  <span class="keyword">switch</span> (command.getType()) &#123;<span class="comment">// æ ¹æ®SQLè¯­å¥çš„ç±»å‹è°ƒç”¨SqlSessionå¯¹åº”çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨ParamNameResolverå¤„ç†args[]æ•°ç»„(ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨)ï¼Œå°†ç”¨æˆ·ä¼ å…¥çš„å®å‚ä¸</span></span><br><span class="line">      <span class="comment">// æŒ‡å®šå‚æ•°åç§°å…³è”èµ·æ¥</span></span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line"><span class="comment">//  ç”¨SqlSession.insert()æ–¹æ³•ï¼ŒrowCountResult()æ–¹æ³•ä¼šæ ¹æ®methodå­—æ®µä¸­è®°å½•çš„æ–¹æ³•çš„</span></span><br><span class="line">      result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SELECT:</span><br><span class="line">      <span class="comment">// å¤„ç†è¿”å›å€¼ä¸ºVoidä¸”ResultSeté€šè¿‡ResultHandlerå¤„ç†çš„æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">        executeWithResultHandler(sqlSession, args);</span><br><span class="line">        result = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123; <span class="comment">// å¤„ç†è¿”å›å€¼ä¸ºé›†åˆæˆ–æ•°ç»„çš„ç±»å‹</span></span><br><span class="line">        result = executeForMany(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;<span class="comment">// å¤„ç†è¿”å›å€¼ä¸ºMapçš„æ–¹æ³•</span></span><br><span class="line">        result = executeForMap(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123; <span class="comment">// ...</span></span><br><span class="line">        result = executeForCursor(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¤„ç†è¿”å›å€¼ä¸ºå•ä¸€å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FLUSH:</span><br><span class="line">      result = sqlSession.flushStatements();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Unknown execution method for: &quot;</span> + command.getName());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æ‰§ è¡Œ <code>INSERT</code>ã€<code>UPDATE</code>ã€<code>DELETE</code>ç±» å‹ çš„ <code>SQL</code>è¯­ å¥æ—¶ ï¼Œå…¶æ‰§ è¡Œç»“ æœéƒ½éœ€è¦ç» è¿‡<code>MapperMethod.rowCountResult()</code>æ–¹ æ³• å¤„ ç† ã€‚ </p><p><code>SqlSession</code> ä¸­ çš„ <code>insert()</code>ç­‰ æ–¹ æ³• è¿” å› çš„ æ˜¯ <code>int</code> å€¼ ï¼Œ <code>rowCountResult()</code>æ–¹æ³•ä¼š å°† è¯¥ <code>int</code>å€¼ è½¬ æ¢ æˆ<code>Mapper</code>æ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">rowCountResult</span><span class="params">(<span class="keyword">int</span> rowCount)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Object result;</span><br><span class="line">  <span class="keyword">if</span> (method.returnsVoid()) &#123;</span><br><span class="line">    result = <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Integer.class.equals(method.getReturnType()) </span><br><span class="line">             || Integer.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">    result = rowCount;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Long.class.equals(method.getReturnType()) </span><br><span class="line">             || Long.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">    result = (<span class="keyword">long</span>)rowCount;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Boolean.class.equals(method.getReturnType()) </span><br><span class="line">             || Boolean.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">    result = rowCount &gt; <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ æœ <code>Mapper</code>æ¥å£ä¸­å®šä¹‰ çš„æ–¹æ³•å‡†å¤‡ ä½¿ç”¨<code>ResultHandler</code>å¤„ ç†æŸ¥ è¯¢ ç»“ æœé›†ï¼Œåˆ™ é€šè¿‡ <code>MapperMethod.executeWithResultHandler()</code>æ–¹æ³•å¤„ ç†ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeWithResultHandler</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è· å–SQLè¯­ å¥å¯¹ åº” çš„MappedStatementå¯¹è±¡</span></span><br><span class="line">  MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(command.getName());</span><br><span class="line">  <span class="keyword">if</span> (!StatementType.CALLABLE.equals(ms.getStatementType())</span><br><span class="line">      &amp;&amp; <span class="keyword">void</span>.class.equals(ms.getResultMaps().get(<span class="number">0</span>).getType())) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">  <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">    RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">    sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨SqlSession.select()æ–¹æ³•ï¼Œæ‰§è¡ŒæŸ¥è¯¢ ï¼Œå¹¶ç”±æŒ‡å®šçš„ResultHandlerå¤„ç†ç»“æœå¯¹è±¡</span></span><br><span class="line">    sqlSession.select(command.getName(), param, method.extractResultHandler(args));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ æœ <code>Mapper</code>æ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ä¸º æ•° ç»„ æˆ–æ˜¯<code>Collection</code>æ¥å£å® ç° ç±» ï¼Œåˆ™ é€šè¿‡ <code>MapperMethod.executeForMany()</code>æ–¹ æ³• å¤„ ç† ï¼Œå…· ä½“ å® ç° å¦‚ ä¸‹ :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">executeForMany</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">  List&lt;E&gt; result;</span><br><span class="line">  Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">  <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">    RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">    <span class="comment">// è°ƒç”¨SqlSession.selectList()æ–¹æ³•å®ŒæˆæŸ¥è¯¢</span></span><br><span class="line">    result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result = sqlSession.&lt;E&gt;selectList(command.getName(), param);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// issue #510 Collections &amp; arrays support</span></span><br><span class="line">  <span class="keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getReturnType().isArray()) &#123;</span><br><span class="line">      <span class="keyword">return</span> convertToArray(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>convertToDeclaredCollection()</code>æ–¹ æ³• å’Œ <code>convertToArray()</code>æ–¹ æ³• çš„ åŠŸ èƒ½ ç±» ä¼¼ ï¼Œä¸» è¦ è´Ÿ è´£ å°† ç»“ æœ å¯¹ è±¡è½¬ æ¢ æˆ<code>Collection</code>é›†åˆå¯¹ è±¡å’Œæ•° ç»„ å¯¹ è±¡ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToDeclaredCollection</span><span class="params">(Configuration config, List&lt;E&gt; list)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é€šè¿‡åå°„åˆ›å»ºé›†åˆå¯¹è±¡</span></span><br><span class="line">  Object collection = config.getObjectFactory().create(method.getReturnType());</span><br><span class="line">  <span class="comment">// åˆ›å»ºMetaObjectå¯¹è±¡</span></span><br><span class="line">  MetaObject metaObject = config.newMetaObject(collection);</span><br><span class="line">  metaObject.addAll(list);</span><br><span class="line">  <span class="keyword">return</span> collection;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToArray</span><span class="params">(List&lt;E&gt; list)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; arrayComponentType = method.getReturnType().getComponentType();</span><br><span class="line">  Object array = Array.newInstance(arrayComponentType, list.size());</span><br><span class="line">  <span class="keyword">if</span> (arrayComponentType.isPrimitive()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">      Array.set(array, i, list.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> list.toArray((E[])array);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>Mapper</code>æ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ä¸º <code>Map</code>ç±» å‹,åˆ™ é€šè¿‡ <code>MapperMethod.executeForMap()</code> æ–¹æ³•å¤„ç†ï¼Œå…·ä½“å®ç°å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;K, V&gt; <span class="function">Map&lt;K, V&gt; <span class="title">executeForMap</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">  Map&lt;K, V&gt; result;</span><br><span class="line">  Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">  <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">    RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">    result = sqlSession.&lt;K, V&gt;selectMap(</span><br><span class="line">      command.getName(), param, method.getMapKey(), rowBounds);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>executeForCursor()</code>æ–¹æ³•ä¸ <code>executeForMap()</code>æ–¹æ³•ç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«å°±æ˜¯è°ƒ <code>selectCursor()</code>æ–¹æ³•ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”Transaction</title>
      <link href="/blog/2019/10/29/e275ec7f.html"/>
      <url>/blog/2019/10/29/e275ec7f.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm_zgJEGC.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„Transactionæ¨¡å—</p></blockquote><p>åœ¨å® è·µ å¼€ å‘ ä¸­ï¼Œæ§åˆ¶æ•° æ®åº“ äº‹åŠ¡ æ˜¯ä¸€ä»¶éå¸¸é‡è¦çš„å·¥ä½œï¼Œ<code>MyBatis</code>ä½¿ ç”¨ <code>Transaction</code>æ¥å£å¯¹æ•°æ®åº“äº‹åŠ¡è¿› è¡Œäº†æŠ½è±¡ï¼Œ<code>Transaction</code>æ¥å£çš„å®šä¹‰ å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è·å–å¯¹åº”çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å›æ»šäº‹åŠ¡</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å…³é—­æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è·å–äº‹åŠ¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Transaction</code> æ¥ å£ æœ‰ <code>JdbcTransaction</code>ã€ <code>ManagedTransaction</code> ä¸¤ ä¸ª å® ç° ï¼Œ å…¶ å¯¹ è±¡ åˆ† åˆ« ç”±</p><p><code>JdbcTransactionFactory</code>å’Œ <code>ManagedTransactionFactory</code>è´Ÿ è´£ åˆ› å»ºã€‚<strong>è¿™ é‡Œä¹Ÿä½¿ç”¨ å·¥å‚ æ–¹æ³•æ¨¡å¼ã€‚</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/image-20200609173458476_DrG0nO.png" alt="image-20200609173458476"></p><h3 id="JdbcTransaction"><a href="#JdbcTransaction" class="headerlink" title="JdbcTransaction"></a>JdbcTransaction</h3><p><code>JdbcTransaction</code>ä¾èµ–äº <code>JDBC Connection</code>æ§åˆ¶äº‹åŠ¡çš„æäº¤å’Œå› æ»š ã€‚<code>JdbcTransaction</code>ä¸­ å­— æ®µ çš„ å«ä¹‰ å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="keyword">protected</span> Connection connection;</span><br><span class="line"><span class="comment">// æ•°æ®åº“è¿æ¥æ‰€å±çš„DataSource</span></span><br><span class="line"><span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line"><span class="comment">// äº‹åŠ¡éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">protected</span> TransactionIsolationLevel level;</span><br><span class="line"><span class="comment">// æ˜¯å¦è‡ªåŠ¨æäº¤</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">boolean</span> autoCommmit;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>JdbcTransaction</code>çš„æ„ é€ å‡½æ•° ä¸­ä¼š åˆå§‹åŒ–é™¤<code>connection</code>å­—æ®µä¹‹å¤–çš„å…¶ä»–ä¸‰ä¸ª å­—æ®µï¼Œè€Œ <code>connection</code>å­—æ®µä¼š å»¶è¿Ÿ åˆå§‹åŒ–ï¼Œå®ƒ ä¼š åœ¨è°ƒ ç”¨<code>getConnection()</code>æ–¹æ³•æ—¶ é€šè¿‡ <code>dataSource.getConnection()</code> æ–¹æ³•åˆå§‹åŒ–ï¼Œå¹¶ ä¸”åŒæ—¶ è®¾ ç½®<code>autoCommit</code>å’Œäº‹åŠ¡ éš”ç¦» çº§ åˆ« ã€‚</p><blockquote><p>JdbcTransactionçš„ commit()æ–¹æ³•å’Œ rollback()æ–¹æ³•éƒ½ä¼š è°ƒ ç”¨Connectionå¯¹ åº” æ–¹æ³•å® ç° çš„ã€‚</p></blockquote><h3 id="ManagedTransaction"><a href="#ManagedTransaction" class="headerlink" title="ManagedTransaction"></a>ManagedTransaction</h3><p><code>ManagedTransaction</code>çš„å® ç° æ›´åŠ ç®€ å• ï¼Œå®ƒ åŒæ · ä¾èµ– å…¶ä¸­çš„<code>dataSource</code>å­—æ®µè· å–è¿ æ¥ï¼Œä½†å…¶ <code>commit()</code>ã€<code>rollback()</code>æ–¹æ³•éƒ½æ˜¯ç©ºå® ç° ï¼Œäº‹åŠ¡ çš„æäº¤å’Œå›æ»š éƒ½æ˜¯ä¾é  å®¹å™¨ç®¡ç†çš„ã€‚</p><blockquote><p><code>ManagedTransaction</code>ä¸­é€šè¿‡ <code>closeConnection</code>å­—æ®µçš„å€¼ æ§åˆ¶æ•° æ®åº“ è¿ æ¥çš„å…³ é—­ è¡Œä¸º ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.closeConnection &amp;&amp; <span class="keyword">this</span>.connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">&quot;Closing JDBC Connection [&quot;</span> + <span class="keyword">this</span>.connection + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.connection.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TransactionFactory"><a href="#TransactionFactory" class="headerlink" title="TransactionFactory"></a>TransactionFactory</h3><p><code>TransactionFactory</code>æ¥ å£ å®š ä¹‰ äº† é… ç½® æ–° å»º <code>TransactionFactory</code>å¯¹ è±¡ çš„ æ–¹ æ³• ï¼Œ ä»¥ åŠ åˆ› å»º <code>Transaction</code>å¯¹ è±¡çš„æ–¹æ³•ï¼Œä»£ç  å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * é…ç½®TransactionFactoryå¯¹ è±¡ï¼Œä¸€èˆ¬ç´§ è·Ÿ åœ¨åˆ› å»ºå®Œæˆä¹‹åï¼Œå®Œæˆå¯¹ TransactionFactoryçš„è‡ªå®šä¹‰ é…ç½®</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åœ¨æŒ‡å®šçš„è¿ æ¥ä¸Šåˆ› å»ºTransactionå¯¹ è±¡</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä» æŒ‡å®šæ•° æ®æºä¸­è· å–æ•° æ®åº“ è¿ æ¥ï¼Œå¹¶ åœ¨æ­¤è¿ æ¥ä¹‹ä¸Šåˆ› å»ºTransactionå¯¹ è±¡</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(DataSource dataSource, </span></span></span><br><span class="line"><span class="function"><span class="params">                             TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>JdbcTransactionFactory</code> å’Œ <code>ManagedTransactionFactory</code> è´Ÿ è´£ åˆ› å»º <code>JdbcTransaction</code> å’Œ <code>ManagedTransaction</code>ï¼Œè¿™ ä¸€éƒ¨åˆ†çš„ä»£ç  æ¯”è¾ƒ ç®€ å• ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”DataSource</title>
      <link href="/blog/2019/10/28/899df03d.html"/>
      <url>/blog/2019/10/28/899df03d.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm_zgJEGC.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„DataSourceæ¨¡å—</p></blockquote><p>åœ¨æ•° æ®æŒä¹…å±‚ ä¸­ï¼Œæ•° æ®æºæ˜¯ä¸€ä¸ª éå¸¸é‡è¦çš„ç»„ ä»¶ï¼Œå…¶æ€§èƒ½ç›´æ¥å…³ ç³»åˆ°æ•´ä¸ª æ•° æ®æŒä¹…å±‚ çš„æ€§èƒ½ã€‚</p><p>åœ¨å® è·µ ä¸­æ¯”è¾ƒ å¸¸è§ çš„ç¬¬ä¸‰æ–¹æ•° æ®æºç»„ ä»¶æœ‰<code>ApacheCommonDBCP</code>ã€<code>C3P0</code>ã€<code>Proxool</code>ç­‰ï¼ŒMyBatisä¸ä»… å¯ä»¥é›†æˆç¬¬ä¸‰æ–¹æ•° æ®æºç»„ ä»¶ï¼Œè¿˜ æä¾›äº†è‡ªå·±çš„æ•° æ®æºå® ç° ã€‚</p><p>å¸¸è§ çš„æ•° æ®æºç»„ ä»¶éƒ½å® ç° äº† <code>javax.sql.DataSource</code>æ¥å£ï¼ŒMyBatisè‡ªèº«å® ç° çš„æ•° æ®æºå® ç° ä¹Ÿ ä¸ ä¾‹ å¤– ã€‚</p><p>MyBatis æ ä¾› äº† ä¸¤ ä¸ª <code>javax.sql.DataSource</code> æ¥ å£ å® ç° ï¼Œ åˆ† åˆ« æ˜¯ <code>PooledDataSource</code> å’Œ <code>UnpooledDataSource</code>ã€‚ </p><p>Mybatisä½¿ ç”¨ ä¸ åŒ çš„ DataSourceFactoryæ¥ å£ å® ç° åˆ› å»º ä¸ åŒ ç±» å‹ çš„ DataSource,å¦‚å›¾æ‰€ç¤ºï¼Œè¿™ æ˜¯å·¥å‚ æ–¹æ³•æ¨¡å¼çš„ä¸€ä¸ª å…¸å‹åº” ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608220639013_wB5yIb.png" alt="image-20200608220639013"></p><h3 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h3><blockquote><p>åœ¨å·¥å‚ æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå®šä¹‰ äº†ä¸€ä¸ª ç”¨äºåˆ› å»ºå¯¹ è±¡çš„å·¥å‚ æ¥å£ï¼Œå¹¶ æ ¹æ®å·¥å‚ æ¥å£çš„å…·ä½“ å® ç° ç±» å†³å®šå…·ä½“å®ä¾‹åŒ–å“ªä¸€ä¸ªå…·ä½“äº§å“ç±»ã€‚é¦–å…ˆæ¥çœ‹å·¥å‚æ–¹æ³•æ¨¡å¼çš„UMLå›¾ï¼Œä»æ•´ä½“ä¸Šäº†è§£è¯¥æ¨¡å¼ çš„ç»“ æ„ ã€‚</p></blockquote><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608221034019_4Qx2xe.png" alt="image-20200608221034019"></p><p>å·¥å‚æ–¹æ³•æœ‰å››ä¸ªè§’è‰²æ„æˆï¼š</p><ul><li><p>å·¥å‚æ¥å£ï¼ˆFactoryï¼‰</p><p>å·¥å‚ æ¥å£æ˜¯å·¥å‚ æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒæ¥å£ï¼Œè°ƒ ç”¨è€…ä¼š ç›´æ¥ä¸ å·¥å‚ æ¥ å£äº¤äº’ç”¨äºè·å–å…·ä½“çš„äº§å“å®ç°ç±»</p></li><li><p>å…·ä½“å·¥å‚ç±»ï¼ˆConcreteFactoryï¼‰</p><p>å…·ä½“ å·¥å‚ ç±» æ˜¯å·¥å‚ æ¥å£çš„å® ç° ç±» ï¼Œç”¨äºå® ä¾‹åŒ–äº§ å“ å¯¹è±¡ï¼Œä¸åŒçš„å…·ä½“å·¥å‚ç±»ä¼šæ ¹æ®éœ€æ±‚å®ä¾‹åŒ–ä¸åŒçš„äº§å“å®ç°ç±»ã€‚</p></li><li><p>äº§å“æ¥å£ï¼ˆProductï¼‰</p><p> å“æ¥å£ç”¨äºå®šä¹‰ äº§ å“ç±» çš„åŠŸèƒ½ï¼Œå…·ä½“ å·¥å‚ ç±» äº§ ç”Ÿçš„æ‰€æœ‰äº§ å“å¯¹è±¡éƒ½å¿…é¡»å®ç°è¯¥æ¥å£ã€‚è°ƒç”¨è€…ä¸€èˆ¬ä¼šé¢å‘äº§å“æ¥å£è¿›è¡Œç¼–ç¨‹ï¼Œæ‰€ä»¥äº§å“æ¥å£ä¼šä¸è°ƒç”¨è€…ç›´æ¥äº¤äº’ï¼Œä¹Ÿæ˜¯è°ƒ ç”¨è€…æœ€ä¸º å…³ å¿ƒçš„æ¥å£ã€‚</p></li><li><p>å…·ä½“ äº§ å“ç±» ï¼ˆConcreteProductï¼‰</p><p> ç° äº§ å“æ¥å£çš„å® ç° ç±» ï¼Œå…·ä½“ äº§ å“ç±» ä¸­å®šä¹‰ äº†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘</p></li></ul><p>å¦‚æœéœ€è¦äº§ ç”Ÿæ–°çš„äº§ å“ï¼Œä¾‹å¦‚å¯¹ äºMyBatisçš„æ•° æ®æºæ¨¡å— æ¥ è¯´ ï¼Œå°±æ˜¯æ·»åŠ æ–°çš„ç¬¬ä¸‰æ–¹æ•° æ® æºç»„ ä»¶ï¼Œåªéœ€è¦æ·»åŠ å¯¹ åº” çš„å·¥å‚ å® ç° ç±» ï¼Œæ–°æ•° æ®æºå°±å¯ä»¥è¢«MyBatisä½¿ç”¨ï¼Œè€Œä¸å¿…ä¿®æ”¹å·±æœ‰çš„ ä»£ç  ã€‚æ˜¾ ç„¶ï¼Œå·¥å‚ æ–¹æ³•æ¨¡å¼ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå·¥å‚ æ–¹æ³•ä¼š å‘è°ƒ ç”¨è€…éš è—å…·ä½“ äº§ å“ç±» çš„å® ä¾‹åŒ–ç»† èŠ‚ ï¼Œè°ƒ ç”¨è€…åªéœ€è¦äº†è§£å·¥å‚ æ¥å£å’Œäº§ å“æ¥å£ï¼Œé¢å‘è¿™ ä¸¤ ä¸ª æ¥å£ç¼– ç¨‹å³ å¯ã€‚</p><blockquote><p>å·¥å‚ æ–¹æ³•æ¨¡å¼ä¹Ÿæ˜¯å­˜åœ¨ç¼ºç‚¹çš„ã€‚åœ¨å¢åŠ æ–°äº§ å“å® ç° ç±» æ—¶ ï¼Œè¿˜ è¦æä¾›ä¸€ä¸ª ä¸ ä¹‹å¯¹ åº” çš„å·¥å‚ å® ç° ç±» ï¼Œæ‰€ä»¥å® é™… æ–°å¢çš„ç±» æ˜¯æˆå¯¹ å‡ºç° çš„ï¼Œè¿™ å¢åŠ äº†ç³»ç»Ÿ çš„å¤ æ‚ åº¦ã€‚å¦ å¤–ï¼Œå·¥å‚ æ–¹æ³•æ¨¡å¼å¼•å…¥äº† å·¥å‚ æ¥å£å’Œäº§ å“æ¥å£è¿™ ä¸€å±‚ æŠ½è±¡ï¼Œè°ƒ ç”¨è€…é¢å‘è¯¥ æŠ½è±¡å±‚ ç¼– ç¨‹,å¢åŠ äº†ç¨‹åºçš„æŠ½è±¡æ€§å’Œç†è§£éš¾ åº¦ã€‚</p></blockquote><h3 id="DataSourceFactory"><a href="#DataSourceFactory" class="headerlink" title="DataSourceFactory"></a>DataSourceFactory</h3><p>åœ¨æ•° æ®æºæ¨¡å— ä¸­ï¼Œ<code>DataSourceFactory</code>æ¥å£æ‰®æ¼”å·¥å‚ æ¥å£çš„è§’è‰²ã€‚</p><p><code>UnpooledDataSourceFactory</code> å’Œ <code>PooledDataSourceFactory</code>åˆ™ æ‰®æ¼”ç€å…·ä½“ å·¥å‚ ç±» çš„è§’è‰²ã€‚</p><p>æˆ‘ä»¬ ä» <code>DataSourceFactory</code>æ¥å£å¼€ å§‹åˆ† æï¼Œå…¶å®šä¹‰ å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®DataSourceçš„ç›¸å…³å±æ€§ï¼Œä¸€èˆ¬ç´§è·Ÿåœ¨åˆå§‹åŒ–å®Œæˆä¹‹å</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–DataSourceå¯¹è±¡</span></span><br><span class="line">  <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>UnpooledDataSourceFactory</code>çš„ æ„ é€  å‡½ æ•° ä¸­ ä¼š ç›´ æ¥ åˆ› å»º <code>UnpooledDataSource</code>å¯¹ è±¡ ï¼Œå¹¶ åˆå§‹ åŒ– <code>UnpooledDataSourceFactory.dataSource</code> å­— æ®µ ã€‚<code>UnpooledDataSourceFactory.setProperties()</code>æ–¹æ³•ä¼š å®Œæˆå¯¹ <code>UnpooledDataSource</code>å¯¹ è±¡çš„é…ç½®ï¼Œä»£ç  å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">  Properties driverProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">  <span class="comment">// åˆ›å»ºDataSourceå¯¹åº”çš„MetaObject</span></span><br><span class="line">  MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);</span><br><span class="line">  <span class="comment">// éå†propertiesé›†åˆï¼Œè¯¥é›†åˆä¸­é…ç½®äº†æ•°æ®æºéœ€è¦çš„ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">for</span> (Object key : properties.keySet()) &#123;</span><br><span class="line">    String propertyName = (String) key;</span><br><span class="line">    <span class="comment">// ä»¥&quot;driver.&quot;å¼€å¤´çš„é…ç½®é¡¹æ˜¯å¯¹DateSourceçš„é…ç½®ï¼Œè®°å½•åˆ°driverPropertiesä¸­ä¿å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123;</span><br><span class="line">      String value = properties.getProperty(propertyName);</span><br><span class="line">      driverProperties.setProperty(</span><br><span class="line">        propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metaDataSource.hasSetter(propertyName)) &#123;</span><br><span class="line">      String value = (String) properties.get(propertyName);</span><br><span class="line">      Object convertedValue = convertValue(metaDataSource, propertyName, value);</span><br><span class="line">      metaDataSource.setValue(propertyName, convertedValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (driverProperties.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    metaDataSource.setValue(<span class="string">&quot;driverProperties&quot;</span>, driverProperties);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UnpooledDataSourceFactory.getDataSource()</code>æ–¹æ³•å® ç° æ¯”è¾ƒ ç®€ å• ï¼Œå®ƒ ç›´æ¥è¿”å› <code>dataSource</code>å­—æ®µ è®° å½• çš„ <code>UnpooledDataSource</code> å¯¹ è±¡ ã€‚</p><p><code>PooledDataSourceFactory</code> ç»§ æ‰¿ äº† <code>UnpooledDataSourceFactory</code>, ä½† å¹¶ æ²¡ æœ‰ è¦† ç›– <code>setProperties()</code> æ–¹æ³•å’Œ<code>getDataSource()</code>æ–¹æ³•ã€‚ä¸¤ è€…å”¯ä¸€çš„åŒº åˆ« æ˜¯<code>PooledDataSourceFactory</code>çš„æ„ é€ å‡½æ•° ä¼š å°† å…¶ <code>dataSource</code> å­— æ®µ åˆ å§‹ åŒ– ä¸º <code>PooledDataSource</code> å¯¹ è±¡ ã€‚</p><p><code>JndiDataSourceFactory</code>æ˜¯ä¾èµ– JNDIæœåŠ¡ ä» å®¹å™¨ä¸­è· å–ç”¨æˆ· é…ç½®çš„<code>DataSource</code>ï¼Œå…¶é€» è¾‘ å¹¶ ä¸ å¤ æ‚ ã€‚</p><h3 id="UnpooledDataSource"><a href="#UnpooledDataSource" class="headerlink" title="UnpooledDataSource"></a>UnpooledDataSource</h3><p><code>javax.sql.DataSource</code>æ¥å£åœ¨æ•° æ®æºæ¨¡å— ä¸­æ‰®æ¼”äº†äº§ å“æ¥å£çš„è§’è‰²ï¼Œ<code>MyBatis</code>æä¾›äº†ä¸¤ ä¸ª <code>DataSource</code>æ¥ å£ çš„ å® ç° ç±» ï¼Œåˆ† åˆ« æ˜¯ <code>UnpooledDataSource</code>å’Œ <code>PooledDataSource</code>ï¼Œå®ƒ ä»¬ æ‰® æ¼” ç€ å…· ä½“ äº§ å“ç±» çš„è§’è‰²ã€‚</p><p><code>UnpooledDataSource</code> å® ç° äº† <code>javax.sql.DataSource</code> æ¥ å£ ä¸­ å®š ä¹‰ çš„ <code>getConnection()</code>æ–¹ æ³• åŠ å…¶ é‡ è½½æ–¹æ³•ï¼Œç”¨äºè· å–æ•° æ®åº“ è¿ æ¥ã€‚</p><p>æ¯æ¬¡é€šè¿‡ <code>UnpooledDataSource.getConnection()</code>æ–¹æ³•è· å–æ•° æ®åº“ è¿ æ¥ æ—¶ éƒ½ä¼š åˆ› å»ºä¸€ä¸ª æ–°è¿ æ¥ã€‚</p><p><code>UnpooledDataSource</code>ä¸­çš„å­—æ®µå¦‚ä¸‹ï¼Œæ¯ä¸ª å­—æ®µéƒ½æœ‰å¯¹ åº” çš„getter/setter æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnpooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> ClassLoader driverClassLoader;</span><br><span class="line">  <span class="keyword">private</span> Properties driverProperties;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Driver&gt; registeredDrivers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Driver&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String driver;</span><br><span class="line">  <span class="keyword">private</span> String url;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Boolean autoCommit;</span><br><span class="line">  <span class="keyword">private</span> Integer defaultTransactionIsolationLevel;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers();</span><br><span class="line">    <span class="keyword">while</span> (drivers.hasMoreElements()) &#123;</span><br><span class="line">      Driver driver = drivers.nextElement();</span><br><span class="line">      registeredDrivers.put(driver.getClass().getName(), driver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Pooled-DataSource"><a href="#Pooled-DataSource" class="headerlink" title="Pooled DataSource"></a>Pooled DataSource</h3><p>äº†è§£JDBCç¼– ç¨‹çš„è¯» è€…çŸ¥é“ï¼Œæ•° æ®åº“ è¿ æ¥çš„åˆ› å»ºè¿‡ ç¨‹æ˜¯éå¸¸è€—æ—¶ çš„ï¼Œæ•° æ®åº“ èƒ½å¤Ÿ å»ºç«‹çš„è¿ æ¥æ•° ä¹Ÿéå¸¸æœ‰é™ï¼Œæ‰€ä»¥åœ¨ç» å¤§å¤šæ•° ç³»ç»Ÿ ä¸­ï¼Œæ•° æ®åº“ è¿ æ¥æ˜¯éå¸¸çè´µ çš„èµ„ æºï¼Œä½¿ç”¨æ•° æ®åº“ è¿ æ¥æ± å°±æ˜¾å¾—å°¤ä¸ºå¿…è¦ã€‚</p><p>ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ä¼šå¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œä¾‹å¦‚ï¼Œ<strong>å¯ä»¥å®ç°æ•°æ®åº“è¿æ¥çš„é‡ç”¨ã€æé«˜å“ åº” é€Ÿåº¦ã€é˜²æ­¢æ•° æ®åº“ è¿ æ¥è¿‡ å¤šé€ æˆæ•° æ®åº“ å‡æ­»ã€é¿å…æ•° æ®åº“ è¿ æ¥æ³„éœ²ç­‰ã€‚</strong></p><blockquote><p>æ•°æ®åº“è¿æ¥æ± åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¸€èˆ¬ä¼šåˆ›å»ºä¸€å®šæ•°é‡çš„æ•°æ®åº“è¿æ¥å¹¶æ·»åŠ åˆ°è¿æ¥æ± ä¸­å¤‡ç”¨ã€‚</p><p>å½“ ç¨‹åºéœ€è¦ä½¿ç”¨æ•° æ®åº“ è¿ æ¥æ—¶ ï¼Œä» æ± ä¸­è¯· æ±‚è¿ æ¥;å½“ ç¨‹åºä¸å†ä½¿ç”¨è¯¥ è¿ æ¥æ—¶ ï¼Œä¼š å°† å…¶è¿”å›åˆ°æ± ä¸­ ç¼“ å­˜ï¼Œç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³ é—­ ã€‚</p><p>å½“ ç„¶ï¼Œæ•° æ®åº“ è¿ æ¥æ± ä¼š æ§åˆ¶è¿ æ¥æ€» æ•° çš„ä¸Šé™ä»¥åŠç©ºé—² è¿ æ¥æ•° çš„ä¸Šé™ï¼Œå¦‚æœè¿ æ¥æ± åˆ› å»ºçš„æ€» è¿ æ¥æ•° å·±è¾¾ åˆ°ä¸Šé™ï¼Œä¸”éƒ½å·²è¢«å ç”¨ï¼Œåˆ™ åç»­ è¯· æ±‚è¿ æ¥çš„çº¿ ç¨‹ä¼š è¿› å…¥é˜»å¡é˜Ÿ åˆ—ç­‰å¾…ï¼Œç›´åˆ°æœ‰çº¿ ç¨‹é‡Š æ”¾å‡ºå¯ç”¨çš„è¿ æ¥ã€‚</p><p>å¦‚æœè¿ æ¥æ± ä¸­ç©ºé—² è¿ æ¥æ•° è¾ƒ å¤šï¼Œè¾¾ åˆ° å…¶ä¸Šé™ï¼Œåˆ™ åç»­ è¿”å›çš„ç©ºé—² è¿ æ¥ä¸ä¼š æ”¾å…¥æ± ä¸­ï¼Œè€Œæ˜¯ç›´æ¥å…³ é—­ ï¼Œè¿™ æ · å¯ä»¥å‡ å°‘ç³»ç»Ÿ ç»´ æŠ¤ å¤šä½™æ•° æ®åº“è¿æ¥çš„å¼€é”€ã€‚</p></blockquote><ul><li>å¦‚æœå°†æ€»è¿æ¥æ•°çš„ä¸Šé™è®¾ç½®å¾—è¿‡å¤§ï¼Œå¯èƒ½å› è¿æ¥æ•°è¿‡å¤šè€Œå¯¼è‡´æ•°æ®åº“åƒµæ­»ï¼Œç³»ç»Ÿæ•´ä½“æ€§èƒ½ ä¸‹é™;</li><li>å¦‚æœæ€»è¿æ¥æ•°ä¸Šé™è¿‡å°ï¼Œåˆ™æ— æ³•å®Œå…¨å‘æŒ¥æ•°æ®åº“çš„æ€§èƒ½ï¼Œæµªè´¹æ•°æ®åº“èµ„æºã€‚å¦‚æœå°†ç©ºé—² è¿æ¥çš„ä¸Šé™è®¾ç½®å¾—è¿‡å¤§ï¼Œåˆ™ä¼šæµªè´¹ç³»ç»Ÿèµ„æºæ¥ç»´æŠ¤è¿™äº›ç©ºé—²è¿æ¥;</li><li>å¦‚æœç©ºé—²è¿æ¥ä¸Šé™è¿‡å°ï¼Œå½“ å‡ºç° ç¬é—´ çš„å³°å€¼ è¯· æ±‚æ—¶ ï¼Œç³»ç»Ÿ çš„å¿«é€Ÿå“ åº” èƒ½åŠ›å°±æ¯”è¾ƒ å¼±ã€‚</li></ul><p><em>æ‰€ä»¥åœ¨è®¾ ç½®æ•° æ®åº“ è¿ æ¥æ± çš„è¿™ ä¸¤ ä¸ª å€¼ æ—¶ï¼Œéœ€è¦è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€æƒè¡¡ä»¥åŠä¸€äº›ç»éªŒã€‚</em></p><p><code>PooledDataSource</code>å® ç° äº†ç®€ æ˜“æ•° æ®åº“ è¿ æ¥æ± çš„åŠŸèƒ½ï¼Œå®ƒ ä¾èµ– çš„ç»„ ä»¶å¦‚å›¾ æ‰€ç¤ºï¼Œå…¶ä¸­éœ€ è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>PooledDataSource</code>åˆ› å»ºæ–°æ•° æ®åº“ è¿ æ¥çš„åŠŸèƒ½æ˜¯ä¾èµ– å…¶ä¸­å°è£… çš„<code>UnpooledDataSource</code> å¯¹è±¡å®ç°çš„ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/image-20200609115725188_8mgoXg.png" alt="image-20200609115725188"></p><h4 id="PooledConnection"><a href="#PooledConnection" class="headerlink" title="PooledConnection"></a>PooledConnection</h4><p><code>PooledDataSource</code>å¹¶ ä¸ä¼š ç›´æ¥ç®¡ç†<code>java.sql.Connection</code>å¯¹ è±¡ï¼Œè€Œæ˜¯ç®¡ç† <code>PooledConnection</code>å¯¹ è±¡ã€‚</p><p>åœ¨ <code>PooledConnection</code>ä¸­å°è£… äº†çœŸ æ­£çš„æ•° æ®åº“ è¿ æ¥å¯¹ è±¡(<code>java.sql.Connection</code>) ä»¥åŠå…¶ä»£ç†å¯¹ è±¡ï¼Œè¿™ é‡Œçš„ä»£ç†å¯¹ è±¡æ˜¯é€šè¿‡ JDKåŠ¨ æ€ ä»£ç†äº§ ç”Ÿçš„ã€‚<code>PooledConnection</code>ç»§ æ‰¿äº† <code>InvocationHandler</code> æ¥å£ã€‚</p><p>æ ¸å¿ƒå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•å½“å‰PooledConnectionå¯¹ è±¡æ‰€åœ¨çš„ PooledDataSourceå¯¹ è±¡ã€‚</span></span><br><span class="line"><span class="comment">// è¯¥ PooledConnectionæ˜¯ä»è¯¥ PooledDataSourceä¸­è· å–çš„;</span></span><br><span class="line"><span class="comment">// å½“ è°ƒ ç”¨close() æ–¹æ³•æ—¶ ä¼š å°† PooledConnectionæ”¾å›è¯¥PooledDataSource ä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PooledDataSource dataSource;</span><br><span class="line"><span class="comment">// çœŸæ­£çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Connection realConnection;</span><br><span class="line"><span class="comment">// æ•°æ®åº“è¿æ¥ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Connection proxyConnection;</span><br><span class="line"><span class="comment">// ä»è¿æ¥æ± ä¸­å–å‡ºè¯¥è¿æ¥çš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> checkoutTimestamp;</span><br><span class="line"><span class="comment">// åˆ›å»ºè¯¥è¿æ¥çš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> createdTimestamp;</span><br><span class="line"><span class="comment">// æœ€åä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastUsedTimestamp;</span><br><span class="line"><span class="comment">// ç”±æ•°æ®åº“URLã€ç”¨æˆ·åå’Œå¯†ç è®¡ç®—å‡ºæ¥çš„hashå€¼ï¼Œå¯ç”¨äºæ ‡è¯†è¯¥è¿æ¥æ‰€åœ¨çš„è¿æ¥æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> connectionTypeCode;</span><br><span class="line"><span class="comment">// æ£€æµ‹å½“å‰PooledConnectionæ˜¯å¦æœ‰æ•ˆï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç¨‹åºé€šè¿‡close()æ–¹æ³•å°†è¿æ¥è¿˜ç»™è¿æ¥æ± ä¹‹å</span></span><br><span class="line"><span class="comment">// ä¾ç„¶é€šè¿‡è¯¥è¿æ¥æ“ä½œæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> valid;</span><br></pre></td></tr></table></figure><p><code>PooledConnection.invoke()</code>æ–¹æ³•çš„å® ç° ï¼Œè¯¥ æ–¹æ³•æ˜¯<code>proxyConnection</code>è¿™ ä¸ª è¿ æ¥ä»£ç†å¯¹ è±¡çš„çœŸ æ­£ä»£ç† é€» è¾‘ ï¼Œå®ƒ ä¼š å¯¹ <code>close()</code>æ–¹æ³•çš„è°ƒ ç”¨è¿› è¡Œä»£ç†ï¼Œå¹¶ ä¸”åœ¨è°ƒ ç”¨çœŸ æ­£æ•° æ®åº“ è¿ æ¥çš„æ–¹æ³•ä¹‹å‰è¿› è¡Œæ£€ æµ‹ ï¼Œ ä»£ç  å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  String methodName = method.getName();</span><br><span class="line">  <span class="comment">// å¦‚æœè°ƒç”¨close()æ–¹æ³•ï¼Œåˆ™å°†å…¶é‡æ–°æ”¾å…¥è¿æ¥æ± ï¼Œè€Œä¸æ˜¯çœŸæ­£å…³é—­æ•°æ®åº“è¿æ¥</span></span><br><span class="line">  <span class="keyword">if</span> (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123;</span><br><span class="line">    dataSource.pushConnection(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        <span class="comment">// issue #579 toString() should never fail</span></span><br><span class="line">        <span class="comment">// throw an SQLException instead of a Runtime</span></span><br><span class="line">        <span class="comment">// é€šè¿‡validå­—æ®µæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        checkConnection();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è°ƒç”¨çœŸæ­£æ•°æ®åº“è¿æ¥å¯¹è±¡å¯¹åº”çš„æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">return</span> method.invoke(realConnection, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="PoolState"><a href="#PoolState" class="headerlink" title="PoolState"></a>PoolState</h4><p><code>PoolState</code>æ˜¯ ç”¨ äº ç®¡ ç† <code>PooledConnection</code>å¯¹ è±¡ çŠ¶ æ€ çš„ ç»„ ä»¶ ï¼Œå®ƒ é€š è¿‡ ä¸¤ ä¸ª <code>ArrayList &lt;PooledConnection&gt;</code>é›†åˆåˆ†åˆ« ç®¡ç†ç©ºé—² çŠ¶ æ€ çš„è¿ æ¥å’Œæ´»è·ƒ çŠ¶ æ€ çš„è¿ æ¥ï¼Œå®šä¹‰ å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç©ºé—²çš„PooledConnectionå¯¹è±¡é›†åˆ</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; idleConnections = </span><br><span class="line">  <span class="keyword">new</span> ArrayList&lt;PooledConnection&gt;();</span><br><span class="line"><span class="comment">// æ´»è·ƒçš„PooledConnectioné›†åˆ</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; activeConnections = </span><br><span class="line">  <span class="keyword">new</span> ArrayList&lt;PooledConnection&gt;();</span><br><span class="line"><span class="comment">// è¯·æ±‚æ•°æ®åº“è¿æ¥çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> requestCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// è·å–è¿æ¥çš„ç´¯ç§¯æ—¶é—´</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> accumulatedRequestTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// checkoutTimeè¡¨ç¤ºåº”ç”¨ä»è¿æ¥æ± ä¸­å–å‡ºè¿æ¥ï¼Œåˆ°å½’è¿˜çš„è¿™æ®µæ—¶é•¿</span></span><br><span class="line"><span class="comment">// accumulatedCheckoutTimeè®°å½•äº†æ‰€æœ‰è¿æ¥ç´¯ç§¯çš„checkoutTimeæ—¶é•¿</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å½“è¿æ¥é•¿æ—¶é—´æœªå½’è¿˜ç»™è¿æ¥æ± çš„æ—¶å€™ï¼Œä¼šè¢«è®¤è¯¥è¿æ¥è¶…æ—¶</span></span><br><span class="line"><span class="comment">// claimedOverdueConnectionCountè®°å½•äº†è¶…æ—¶è¿æ¥ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> claimedOverdueConnectionCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ç´¯ç§¯è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTimeOfOverdueConnections = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ç´¯ç§¯ç­‰å¾…æ—¶é—´</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> accumulatedWaitTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ç´¯ç§¯ç­‰å¾…æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> hadToWaitCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æ— æ•ˆçš„è¿æ¥æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> badConnectionCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h4 id="PooledDataSource"><a href="#PooledDataSource" class="headerlink" title="PooledDataSource"></a>PooledDataSource</h4><p><code>PooledDataSource</code>ä¸­ ç®¡ ç† çš„ çœŸ æ­£ çš„ æ•° æ® åº“ è¿ æ¥ å¯¹ è±¡ æ˜¯ ç”± <code>PooledDataSource</code>ä¸­å°è£… çš„<code>UnpooledDataSource</code>å¯¹ è±¡ åˆ› å»º çš„ ï¼Œå¹¶ ç”± <code>PoolState</code>ç®¡ ç† æ‰€ æœ‰ è¿ æ¥ çš„ çŠ¶ æ€ ã€‚</p><p><code>PooledDataSource</code>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å’ŒåŠŸèƒ½å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡ PoolStateç®¡ç†è¿æ¥æ± çš„çŠ¶æ€å¹¶è®°å½•ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolState state = <span class="keyword">new</span> PoolState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•UnpooledDataSourceå¯¹è±¡ï¼Œç”¨äºç”ŸæˆçœŸå®çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–è¯¥å­—æ®µ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> UnpooledDataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€å¤§æ´»è·ƒè¿æ¥æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumActiveConnections = <span class="number">10</span>;</span><br><span class="line"><span class="comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumIdleConnections = <span class="number">5</span>;</span><br><span class="line"><span class="comment">// æœ€å¤§checkoutæ—¶é•¿</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumCheckoutTime = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">// æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolTimeToWait = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">// æœ€å¤§æ— æ•ˆè¿æ¥æ•°é‡</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumLocalBadConnectionTolerance = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// åœ¨æ£€æµ‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ˜¯å¦å¯ç”¨çš„æ—¶å€™ï¼Œä¼šç»™æ•°æ®åº“å‘é€ä¸€ä¸ªæµ‹è¯•SQLè¯­å¥</span></span><br><span class="line"><span class="keyword">protected</span> String poolPingQuery = <span class="string">&quot;NO PING QUERY SET&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">boolean</span> poolPingEnabled;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“è¿æ¥è¶…è¿‡ poolPingConnectionsNotUsedForæ¯«ç§’æœªä½¿ç”¨æ—¶ ï¼Œä¼šå‘é€ä¸€æ¬¡æµ‹è¯•SQLè¯­å¥ï¼Œæ£€æµ‹è¿æ¥æ˜¯å¦æ­£å¸¸</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> poolPingConnectionsNotUsedFor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æ•°æ®åº“çš„URLã€ç”¨æˆ·åå’Œå¯†ç ç”Ÿæˆçš„ä¸€ä¸ªhashå€¼ï¼Œè¯¥å“ˆå¸Œå€¼ç”¨äºæ ‡å¿—ç€å½“å‰çš„è¿æ¥æ± ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> expectedConnectionTypeCode;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>PooledDataSource.getConnection()</code>æ–¹ æ³• é¦– å…ˆ ä¼š è°ƒ ç”¨ <code>PooledDataSource.popConnection()</code>æ–¹ æ³• è· å– <code>PooledConnection</code> å¯¹ è±¡ï¼Œç„¶åé€šè¿‡ <code>PooledConnection.getProxyConnection()</code>æ–¹æ³•è· å–æ•° æ®åº“ è¿ æ¥çš„ä»£ç†å¯¹ è±¡ã€‚<code>popConnection()</code>æ–¹æ³•æ˜¯<code>PooledDataSource</code>çš„æ ¸å¿ƒé€» è¾‘ ä¹‹ä¸€ï¼Œå…¶å…·ä½“ é€» è¾‘ å¦‚å›¾ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/image-20200609150810073_QLmTH2.png" alt="image-20200609150810073"></p><p><code>PooledDataSource.popConnection()</code>æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">popConnection</span><span class="params">(String username, String password)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> countedWait = <span class="keyword">false</span>;</span><br><span class="line">  PooledConnection conn = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">long</span> t = System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">int</span> localBadConnectionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (state) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!state.idleConnections.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// Pool has available connection</span></span><br><span class="line">        conn = state.idleConnections.remove(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Pool does not have available connection</span></span><br><span class="line">        <span class="keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</span><br><span class="line">          <span class="comment">// Can create new connection</span></span><br><span class="line">          conn = <span class="keyword">new</span> PooledConnection(dataSource.getConnection(), <span class="keyword">this</span>);</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Cannot create new connection</span></span><br><span class="line">          PooledConnection oldestActiveConnection = state.activeConnections.get(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">long</span> longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</span><br><span class="line">          <span class="keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</span><br><span class="line">            <span class="comment">// Can claim overdue connection</span></span><br><span class="line">            state.claimedOverdueConnectionCount++;</span><br><span class="line">            state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</span><br><span class="line">            state.accumulatedCheckoutTime += longestCheckoutTime;</span><br><span class="line">            state.activeConnections.remove(oldestActiveConnection);</span><br><span class="line">            <span class="keyword">if</span> (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                oldestActiveConnection.getRealConnection().rollback();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Bad connection. Could not roll back&quot;</span>);</span><br><span class="line">              &#125;  </span><br><span class="line">            &#125;</span><br><span class="line">            conn = <span class="keyword">new</span> PooledConnection(oldestActiveConnection.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">            conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp());</span><br><span class="line">            conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());</span><br><span class="line">            oldestActiveConnection.invalidate();</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">&quot;....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Must wait</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (!countedWait) &#123;</span><br><span class="line">                state.hadToWaitCount++;</span><br><span class="line">                countedWait = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">long</span> wt = System.currentTimeMillis();</span><br><span class="line">              state.wait(poolTimeToWait);</span><br><span class="line">              state.accumulatedWaitTime += System.currentTimeMillis() - wt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ping to server and check the connection is valid or not</span></span><br><span class="line">        <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">            conn.getRealConnection().rollback();</span><br><span class="line">          &#125;</span><br><span class="line">          conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));</span><br><span class="line">          conn.setCheckoutTimestamp(System.currentTimeMillis());</span><br><span class="line">          conn.setLastUsedTimestamp(System.currentTimeMillis());</span><br><span class="line">          state.activeConnections.add(conn);</span><br><span class="line">          state.requestCount++;</span><br><span class="line">          state.accumulatedRequestTime += System.currentTimeMillis() - t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          state.badConnectionCount++;</span><br><span class="line">          localBadConnectionCount++;</span><br><span class="line">          conn = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (localBadConnectionCount &gt; (poolMaximumIdleConnections + poolMaximumLocalBadConnectionTolerance)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€š è¿‡ å‰ é¢ å¯¹ <code>PooledConnection.invoke()</code>æ–¹æ³•çš„åˆ†ææˆ‘ä»¬ çŸ¥é“ï¼Œå½“ è°ƒ ç”¨è¿ æ¥çš„ä»£ç†å¯¹ è±¡çš„ <code>close()</code>æ–¹ æ³• æ—¶ ï¼Œå¹¶æœªå…³é—­çœŸæ­£çš„æ•°æ®è¿æ¥ ï¼Œè€Œæ˜¯è°ƒç”¨<code>PooledDataSource.pushConnection()</code>æ–¹æ³•å°† <code>PooledConnection</code>å¯¹ è±¡å½’ è¿˜ ç»™ è¿ æ¥æ± ï¼Œä¾›ä¹‹åé‡ç”¨ã€‚</p><p><code>PooledDataSource.pushConnection()</code>æ–¹æ³•ä¹Ÿæ˜¯ <code>PooledDataSource</code>çš„æ ¸å¿ƒé€» è¾‘ ä¹‹ä¸€ï¼Œå…¶é€» è¾‘ å¦‚å›¾ </p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/image-20200609151224380_AWh8ao.png" alt="image-20200609151224380"></p><p><code>PooledDataSource.pushConnection()</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pushConnection</span><span class="params">(PooledConnection conn)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (state) &#123;</span><br><span class="line">    state.activeConnections.remove(conn);</span><br><span class="line">    <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (state.idleConnections.size() &lt; poolMaximumIdleConnections </span><br><span class="line">          &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123;</span><br><span class="line">        state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">        <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">          <span class="comment">// å›æ»šæœªæäº¤çš„äº‹åŠ¡</span></span><br><span class="line">          conn.getRealConnection().rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        PooledConnection newConn = <span class="keyword">new</span> PooledConnection(conn.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">        state.idleConnections.add(newConn);</span><br><span class="line">        newConn.setCreatedTimestamp(conn.getCreatedTimestamp());</span><br><span class="line">        newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());</span><br><span class="line">        conn.invalidate();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        state.notifyAll();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// ç©ºé—²è¿æ¥æ•°å·²è¾¾åˆ°ä¸Šé™æˆ–PooledConnectionå¯¹è±¡å¹¶ä¸å±äºè¯¥è¿æ¥æ± </span></span><br><span class="line">        state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">        <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">          conn.getRealConnection().rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        conn.getRealConnection().close();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        conn.invalidate();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç»Ÿè®¡æ— æ•ˆPooledConnectionå¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">      state.badConnectionCount++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>PooledDataSource.pushConnection()</code>æ–¹æ³•å’Œ<code>popConnection()</code>æ–¹æ³•ä¸­éƒ½è°ƒ ç”¨äº† <code>PooledConnection.isValid()</code>æ–¹ æ³• æ¥ æ£€ æµ‹ <code>PooledConnection</code>çš„ æœ‰ æ•ˆ æ€§ ï¼Œ è¯¥ æ–¹ æ³• é™¤ äº† æ£€ æµ‹ <code>PooledConnection.valid</code> å­—æ®µçš„å€¼ ï¼Œè¿˜ ä¼š è°ƒ ç”¨ <code>PooledDataSource.pingConnection()</code>æ–¹æ³•å° è¯• è®© æ•° æ® åº“ æ‰§ è¡Œ<code>podPingQuery</code>å­—æ®µä¸­è®° å½• çš„æµ‹ è¯• SQLè¯­ å¥ï¼Œä» è€Œæ£€ æµ‹ çœŸ æ­£çš„æ•° æ®åº“ è¿ æ¥å¯¹ è±¡æ˜¯å¦ä¾ç„¶ å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> valid &amp;&amp; realConnection != <span class="keyword">null</span> &amp;&amp; dataSource.pingConnection(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">pingConnection</span><span class="params">(PooledConnection conn)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = !conn.getRealConnection().isClosed();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="keyword">if</span> (poolPingEnabled) &#123;</span><br><span class="line">      <span class="comment">// æ£€æµ‹poolPingEnabledè®¾ç½®ï¼Œæ˜¯å¦è¿è¡Œæ‰§è¡Œæµ‹è¯•SQLè¯­ å¥</span></span><br><span class="line">      <span class="comment">// é•¿æ—¶é—´(è¶…è¿‡ poolPingConnectionsNotUsedForæŒ‡å®šçš„æ—¶é•¿)æœªä½¿ç”¨çš„è¿æ¥ï¼Œæ‰éœ€è¦ping</span></span><br><span class="line">      <span class="comment">// æ“ä½œæ¥æ£€æµ‹æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (poolPingConnectionsNotUsedFor &gt;= <span class="number">0</span> </span><br><span class="line">          &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          Connection realConn = conn.getRealConnection();</span><br><span class="line">          Statement statement = realConn.createStatement();</span><br><span class="line">          ResultSet rs = statement.executeQuery(poolPingQuery);</span><br><span class="line">          rs.close();</span><br><span class="line">          statement.close();</span><br><span class="line">          <span class="keyword">if</span> (!realConn.getAutoCommit()) &#123;</span><br><span class="line">            realConn.rollback();</span><br><span class="line">          &#125;</span><br><span class="line">          result = <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          log.warn(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            conn.getRealConnection().close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">            <span class="comment">//ignore</span></span><br><span class="line">          &#125;</span><br><span class="line">          result = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯<code>PooledDataSource.forceCloseAll()</code>æ–¹æ³•ï¼Œå½“ ä¿®æ”¹<code>PooledDataSource</code>çš„å­—æ®µ æ—¶ ï¼Œä¾‹å¦‚æ•° <strong>æ®åº“ URL</strong>ã€<strong>ç”¨æˆ·å</strong>ã€<strong>å¯†ç </strong> ã€<strong>autoCommité…ç½®</strong>ç­‰ï¼Œéƒ½ä¼š è°ƒ ç”¨<code>forceCloseAll()</code>æ–¹æ³•å°† æ‰€ æœ‰æ•° æ®åº“ è¿ æ¥å…³ é—­ ï¼ŒåŒæ—¶ ä¹Ÿä¼š å°† æ‰€æœ‰ç›¸åº” çš„<code>PooledConnectiori</code>å¯¹ è±¡éƒ½è®¾ ç½®ä¸º æ— æ•ˆï¼Œæ¸… ç©º <code>activeConnections</code> é›† åˆ å’Œ <code>idleConnections</code> é›† åˆ ã€‚</p><p>åº”ç”¨ç³»ç»Ÿä¹‹åé€šè¿‡<code>PooledDataSource.getConnection()</code>è·å–è¿æ¥æ—¶ï¼Œä¼šæŒ‰ç…§æ–°çš„é…ç½®é‡æ–°é…ç½®æ–°çš„æ•°æ®åº“è¿æ¥ä»¥åŠç›¸åº”çš„<code>PooledConnection</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceCloseAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (state) &#123;</span><br><span class="line">    expectedConnectionTypeCode = assembleConnectionTypeCode(</span><br><span class="line">      dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = state.activeConnections.size(); i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        PooledConnection conn = state.activeConnections.remove(i - <span class="number">1</span>);</span><br><span class="line">        conn.invalidate();</span><br><span class="line"></span><br><span class="line">        Connection realConn = conn.getRealConnection();</span><br><span class="line">        <span class="keyword">if</span> (!realConn.getAutoCommit()) &#123;</span><br><span class="line">          realConn.rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        realConn.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = state.idleConnections.size(); i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        PooledConnection conn = state.idleConnections.remove(i - <span class="number">1</span>);</span><br><span class="line">        conn.invalidate();</span><br><span class="line"></span><br><span class="line">        Connection realConn = conn.getRealConnection();</span><br><span class="line">        <span class="keyword">if</span> (!realConn.getAutoCommit()) &#123;</span><br><span class="line">          realConn.rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        realConn.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;PooledDataSource forcefully closed/removed all connections.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”èµ„æºåŠ è½½</title>
      <link href="/blog/2019/10/27/899df03d.html"/>
      <url>/blog/2019/10/27/899df03d.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/21/2_c5SKkm.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„èµ„æºåŠ è½½æ¨¡å—</p></blockquote><h3 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h3><p>Javaè™š æ‹Ÿ æœºä¸­çš„ç±» åŠ è½½ å™¨(ClassLoader)è´Ÿ è´£ åŠ è½½ æ¥ è‡ªæ–‡ä»¶ç³»ç»Ÿ ã€ç½‘ ç»œ æˆ–å…¶ä»–æ¥ æºçš„ç±» æ–‡ ä»¶ã€‚Javaè™š æ‹Ÿ æœºä¸­çš„ç±» åŠ è½½ å™¨é»˜è®¤ ä½¿ç”¨çš„æ˜¯<strong>åŒ äº² å§”æ´¾æ¨¡å¼</strong>ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œå…¶ä¸­æœ‰ä¸‰ç§ é»˜è®¤ ä½¿ ç”¨ çš„ ç±» åŠ  è½½ å™¨ ï¼Œåˆ† åˆ« æ˜¯ <code>Bootstrap ClassLoader</code>ã€<code>Extension ClassLoader</code> å’Œ <code>System ClassLoader</code> (ä¹Ÿ è¢«ç§° ä¸º <code>ApplicationClassLoader</code>)ï¼Œæ¯ç§ ç±» åŠ è½½ å™¨éƒ½å·±ç» ç¡® å®šä» å“ª ä¸ª ä½ç½®åŠ è½½ ç±» æ–‡ä»¶ã€‚</p><p><code>BootstrapClassLoader</code>è´Ÿ è´£ åŠ è½½ JDKè‡ªå¸¦ çš„<code>rt.jar</code>åŒ…ä¸­çš„ç±» æ–‡ä»¶ï¼Œå®ƒ æ˜¯æ‰€æœ‰ç±» åŠ è½½ å™¨çš„çˆ¶åŠ è½½ å™¨ï¼Œ<code>Bootstrap ClassLoader</code>æ²¡ æœ‰ä»»ä½•çˆ¶ç±» åŠ è½½ å™¨ã€‚<code>Extension ClassLoader</code>è´Ÿ è´£ åŠ  è½½ Javaçš„æ‰© å±•ç±» åº“ ï¼Œä¹Ÿå°±æ˜¯ä» <code>jre/lib/ext</code>ç›®å½• ä¸‹æˆ–è€…<code>java.ext.dirs</code>ç³»ç»Ÿ å± æ€§æŒ‡å®šçš„ç›®å½• ä¸‹åŠ è½½ ç±» ã€‚</p><p><code>SystemClassLoader</code>è´Ÿ è´£ ä» <code>classpath</code>ç¯ å¢ƒå˜ é‡ä¸­åŠ è½½ ç±» æ–‡ä»¶ï¼Œ<code>classpath</code>ç¯ å¢ƒå˜ é‡é€šå¸¸ç”±<code>-classpath</code>æˆ– <code>-cp</code>å‘½ä»¤è¡Œé€‰ é¡¹ æ¥ å®šä¹‰ ï¼Œæˆ– æ˜¯ ç”± JARä¸­ Manifestæ–‡ ä»¶ çš„ classpathå± æ€§æŒ‡å®šã€‚<code>System ClassLoader</code>æ˜¯<code>ExtensionClassLoader</code>çš„å­åŠ è½½ å™¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608173325045_78JEcv.png" alt="image-20200608173325045"></p><p>æ ¹æ®åŒäº²å§”æ´¾æ¨¡å¼ï¼Œåœ¨åŠ è½½ç±»æ–‡ä»¶æ—¶ï¼Œå­åŠ è½½å™¨é¦–å…ˆä¼šå°†åŠ è½½è¯·æ±‚å§”æ‰˜ç»™å®ƒçš„çˆ¶åŠ è½½å™¨ã€‚</p><p>çˆ¶åŠ è½½å™¨ä¼šæ£€æµ‹è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥ç±»ï¼Œå¦‚æœå·±åŠ è½½åˆ™åŠ è½½è¿‡ç¨‹ç»“æŸ;å¦‚æœæœªåŠ è½½åˆ™è¯·æ±‚ç»§ ç»­ å‘ä¸Šä¼  é€’ ï¼Œç›´åˆ°BootstrapClassLoaderã€‚</p><p>å¦‚æœåœ¨è¯· æ±‚å‘ä¸Šå§”æ‰˜çš„è¿‡ ç¨‹ä¸­ï¼Œå§‹ç»ˆ æœªæ£€ æµ‹ åˆ°è¯¥ ç±» å·± åŠ è½½ ï¼Œåˆ™ ä» BootstrapClassLoaderå¼€ å§‹å° è¯• ä» å…¶å¯¹ åº” è·¯å¾„ ä¸­åŠ è½½ è¯¥ ç±» æ–‡ä»¶ï¼Œå¦‚æœåŠ è½½ å¤±è´¥ åˆ™ ç”± å­åŠ è½½å™¨ç»§ç»­å°è¯•åŠ è½½ï¼Œç›´è‡³å‘èµ·åŠ è½½è¯·æ±‚çš„å­åŠ è½½å™¨ä½ä¸ºæ­¢ã€‚</p><blockquote><p>åŒ äº² å§”æ´¾æ¨¡å¼å¯ä»¥ä¿è¯ ä¸¤ ç‚¹:</p><p>ä¸€æ˜¯å­åŠ è½½ å™¨å¯ä»¥ä½¿ç”¨çˆ¶åŠ è½½ å™¨å·±åŠ è½½ çš„ç±» ï¼Œè€Œçˆ¶åŠ è½½ å™¨æ—  æ³•ä½¿ç”¨å­åŠ è½½ å™¨å·²åŠ è½½ çš„ç±» ;</p><p>äºŒæ˜¯çˆ¶åŠ è½½ å™¨å·²åŠ è½½ è¿‡ çš„ç±» æ— æ³•è¢«å­åŠ è½½ å™¨å†æ¬¡åŠ è½½ ã€‚</p><p>è¿™ æ · å°±å¯ä»¥ä¿è¯ JVMçš„å®‰å…¨æ€§å’Œç¨³ å®šæ€§ã€‚</p></blockquote><h3 id="ClassLoaderWrapper"><a href="#ClassLoaderWrapper" class="headerlink" title="ClassLoaderWrapper"></a>ClassLoaderWrapper</h3><p>ä¸Šä¸Šä¸€å°èŠ‚ä¸­äº†è§£äº†ç±» åŠ è½½ å™¨çš„å¸¸è§ ä½¿ç”¨æ–¹å¼ã€‚åœ¨ MyBatisçš„ <code>IO</code> åŒ…ä¸­å°è£… äº† ClassLoaderä»¥åŠè¯» å–èµ„ æºæ–‡ä»¶çš„ç›¸å…³ APIã€‚</p><p>åœ¨ <code>IO</code>åŒ… ä¸­ æ ä¾› çš„ <code>ClassLoaderWrapper</code>æ˜¯ ä¸€ ä¸ª <code>ClassLoader</code>çš„åŒ…è£… å™¨ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ª<code>ClassLoader</code>å¯¹ è±¡ã€‚</p><p>é€šè¿‡ è°ƒ æ•´å¤šä¸ª ç±» åŠ è½½ å™¨çš„ä½¿ç”¨é¡º åºï¼Œ<code>ClassLoaderWrapper</code>å¯ä»¥ç¡® ä¿è¿”å›ç»™ ç³» ç»Ÿ ä½¿ç”¨çš„æ˜¯æ­£ç¡® çš„ç±» åŠ è½½ å™¨ã€‚</p><p>ä½¿ ç”¨ <code>ClassLoaderWrapper</code>å°±å¦‚åŒä½¿ç”¨ä¸€ä¸ª <code>ClassLoader</code>å¯¹ è±¡ï¼Œ <code>ClassLoaderWrapper</code>ä¼š æŒ‰ç…§æŒ‡å®šçš„é¡º åºä¾æ¬¡æ£€ æµ‹ å…¶ä¸­å°è£… çš„<code>ClassLoader</code>å¯¹ è±¡ï¼Œå¹¶ ä» ä¸­é€‰ å–ç¬¬ä¸€ ä¸ª å¯ç”¨çš„<code>ClassLoader</code>å®Œæˆç›¸å…³ åŠŸèƒ½ã€‚</p><p><code>ClassLoaderWrapper</code>çš„ ä¸» è¦ åŠŸ èƒ½ å¯ ä»¥ åˆ† ä¸º ä¸‰ ç±» ï¼Œ åˆ† åˆ« æ˜¯ <code>getResourceAsURL()æ–¹ æ³•</code> ã€ <code>classForName()æ–¹æ³•</code>ã€<code>getResourceAsStream()æ–¹æ³•</code>ï¼Œè¿™ ä¸‰ä¸ª æ–¹æ³•éƒ½æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ ä¸‰ç±» æ–¹æ³•æœ€ç»ˆ éƒ½ä¼š è°ƒ ç”¨å‚ æ•° ä¸º <code>String</code>å’Œ<code>ClassLoader[]</code>çš„é‡è½½ ã€‚</p><p><code>getResourceAsURL()</code>ä»£ç å¦‚ä¸‹ï¼Œå…¶ä»–çš„ç±»ä¼¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> URL <span class="title">getResourceAsURL</span><span class="params">(String resource, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getResourceAsURL(resource, getClassLoaders(classLoader));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›ClassLoader[], è¯¥æ–¹æ³•æŒ‡æ˜ç±»åŠ è½½å™¨çš„ä½¿ç”¨é¡ºåº</span></span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ClassLoader[]&#123;</span><br><span class="line">    classLoader,</span><br><span class="line">    defaultClassLoader,</span><br><span class="line">    Thread.currentThread().getContextClassLoader(),</span><br><span class="line">    getClass().getClassLoader(),</span><br><span class="line">    systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">URL <span class="title">getResourceAsURL</span><span class="params">(String resource, ClassLoader[] classLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  URL url;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// look for the resource as passed in...</span></span><br><span class="line">      url = cl.getResource(resource);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ...but some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it</span></span><br><span class="line">      <span class="comment">// and try again if we didn&#x27;t find the resource</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == url) &#123;</span><br><span class="line">        url = cl.getResource(<span class="string">&quot;/&quot;</span> + resource);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// &quot;It&#x27;s always in the last place I look for it!&quot;</span></span><br><span class="line">      <span class="comment">// ... because only an idiot would keep looking for it after finding it, so stop looking already.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != url) &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// didn&#x27;t find it anywhere.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Resourcesæ˜¯ä¸€ä¸ª æä¾›äº†å¤šä¸ª é™ æ€ æ–¹æ³•çš„å·¥å…·ç±» ï¼Œå…¶ä¸­å°è£… äº†ä¸€ä¸ª ClassLoaderWrapperç±» å‹ çš„é™ æ€ å­—æ®µï¼ŒResourcesæä¾›çš„è¿™ äº›é™ æ€ å·¥å…·éƒ½æ˜¯é€šè¿‡ è°ƒ ç”¨è¯¥ ClassLoaderWrapperå¯¹ è±¡çš„ç›¸åº” æ–¹ æ³•å® ç° çš„ã€‚</p><h3 id="ResolverUtil"><a href="#ResolverUtil" class="headerlink" title="ResolverUtil"></a>ResolverUtil</h3><p><code>ResolverUtil</code>å¯ä»¥æ ¹æ®æŒ‡å®šçš„æ¡ä»¶æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„ç±» ï¼Œå…¶ä¸­ä½¿ç”¨çš„æ¡ä»¶ç”±Testæ¥å£è¡¨ç¤ºã€‚ </p><p><code>ResolverUtil</code>ä¸­ä½¿ç”¨<code>classLoader</code>å­— æ®µ (<code>ClassLoader</code>ç±» å‹)è®° å½• äº†å½“ å‰ä½¿ç”¨çš„ç±» åŠ è½½ å™¨ï¼Œé»˜è®¤ æƒ… å†µ ä¸‹ï¼Œä½¿ç”¨çš„æ˜¯å½“ å‰çº¿ ç¨‹ä¸Šä¸‹æ–‡ç»‘ å®šçš„<code>ClassLoader</code>ï¼Œæˆ‘ä»¬ å¯ä»¥é€šè¿‡ <code>setClassLoader()</code>æ–¹æ³•ä¿®æ”¹ä½¿ ç”¨ç±»åŠ è½½å™¨ã€‚</p><p>MyBatisæä¾›äº†ä¸¤ ä¸ª å¸¸ç”¨çš„<code>Test</code>æ¥å£å® ç° ï¼Œåˆ†åˆ« æ˜¯<code>IsA</code>å’Œ<code>AnnotatedWith</code>,å¦‚å›¾ æ‰€ç¤ºã€‚ <code>IsA</code>ç”¨äºæ£€ æµ‹ ç±» æ˜¯å¦ç»§ æ‰¿äº†æŒ‡å®šçš„ç±» æˆ–æ¥å£ï¼Œ<code>AnnotatedWith</code>ç”¨äºæ£€ æµ‹ ç±» æ˜¯å¦æ·»åŠ äº†æŒ‡å®šçš„æ³¨è§£ã€‚ å¼€ å‘ äººå‘˜ ä¹Ÿå¯ä»¥è‡ªå·±å® ç° <code>Test</code>æ¥å£ï¼Œå® ç° æŒ‡å®šæ¡ ä»¶çš„æ£€ æµ‹ ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608175854576_mu9XKh.png" alt="image-20200608175854576"></p><p>Testæ¥å£ä¸­å®šä¹‰ äº† matches()æ–¹æ³•ï¼Œå®ƒ ç”¨äºæ£€ æµ‹ æŒ‡å®šç±» æ˜¯å¦ç¬¦åˆæ¡ ä»¶:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Will be called repeatedly with candidate classes. Must return True if a class</span></span><br><span class="line"><span class="comment">     * is to be included in the results, false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>IsA</code>å’Œ <code>AnnotatedWith</code>çš„å…·ä½“ å® ç° å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IsA</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; parent;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Constructs an IsA test using the supplied Class as the parent class/interface. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IsA</span><span class="params">(Class&lt;?&gt; parentType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.parent = parentType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns true if type is assignable to the parent type supplied in the constructor. */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; parent.isAssignableFrom(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;is assignable to &quot;</span> + parent.getSimpleName();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedWith</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Class&lt;? extends Annotation&gt; annotation;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Constructs an AnnotatedWith test for the specified annotation type. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AnnotatedWith</span><span class="params">(Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.annotation = annotation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns true if the type is annotated with the class provided to the constructor. */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; type.isAnnotationPresent(annotation);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;annotated with @&quot;</span> + annotation.getSimpleName();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é»˜è®¤ æƒ…å†µ ä¸‹ï¼Œä½¿ç”¨<code>Thread.currentThread().getContextClassLoader()</code>è¿™ ä¸ª ç±» åŠ è½½ å™¨åŠ è½½ ç¬¦åˆæ¡ ä»¶çš„ç±» ï¼Œæˆ‘ä»¬ å¯ä»¥åœ¨è°ƒ ç”¨<code>find()</code>æ–¹æ³•ä¹‹å‰ï¼Œè°ƒ ç”¨ <code>setClassLoader(ClassLoader)</code>è®¾ ç½®éœ€è¦ä½¿ç”¨çš„ <code>ClassLoader</code>ï¼Œè¿™ ä¸ª <code>ClassLoader</code>å¯ ä»¥ ä» <code>ClassLoaderWrapper</code>ä¸­ è· å– åˆ é€‚ çš„ ç±» åŠ  è½½ å™¨ ã€‚</p></blockquote><p>ResolverUtilçš„ä½¿ç”¨æ¡ˆä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ResolverUtil&lt;ActionBean&gt; resolver = <span class="keyword">new</span> ResolverUtil&lt;ActionBean&gt;();</span><br><span class="line"><span class="comment">// åœ¨pkg1å’Œpkg2è¿™ä¸ªåŒ…ä¸‹æŸ¥æ‰¾å®ç°äº†ActionBeanè¿™ä¸ªæ¥å£çš„ç±»</span></span><br><span class="line">resolver.findImplementation(ActionBean.class,  pkg1, pkg2);</span><br><span class="line"><span class="comment">// åœ¨pkg1åŒ…ä¸‹æŸ¥æ‰¾ç¬¦åˆCustomerTestæ¡ä»¶çš„ç±»</span></span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg1);</span><br><span class="line"><span class="comment">// åœ¨pkg2åŒ…ä¸‹æŸ¥æ‰¾ç¬¦åˆCustomerTestæ¡ä»¶çš„ç±»</span></span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg2);</span><br><span class="line"><span class="comment">// è·å–ä¸Šé¢ä¸‰æ¬¡æŸ¥æ‰¾çš„ç»“æœ</span></span><br><span class="line">Collection&lt;ActionBean&gt; beans = resolver.getClasses();</span><br></pre></td></tr></table></figure><p><code>ResolverUtil.findImplementations()</code>æ–¹æ³•å’Œ<code>ResolverUtil.findAnnotated()</code>æ–¹æ³•éƒ½æ˜¯ä¾èµ–<code>RescolverUtil.find()</code>æ–¹æ³•å®ç°çš„ï¼Œ<code>findImplementations()</code>æ–¹æ³•ä¼šåˆ›å»º<code>IsA</code>å¯¹è±¡ä½œä¸ºæ£€æµ‹æ¡ä»¶ï¼Œ<code>findAnnotated()</code>æ–¹æ³•ä¼šåˆ›å»º<code>AnnotatedWith</code>å¯¹è±¡ä½œä¸ºæ£€æµ‹æ¡ä»¶ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608214416619_RmQAqH.png" alt="image-20200608214416619"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResolverUtil&lt;T&gt; <span class="title">find</span><span class="params">(Test test, String packageName)</span> </span>&#123;</span><br><span class="line">  String path = getPackagePath(packageName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    List&lt;String&gt; children = VFS.getInstance().list(path);</span><br><span class="line">    <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">        addIfMatching(test, child);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;Could not read package: &quot;</span> + packageName, ioe);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addIfMatching</span><span class="params">(Test test, String fqn)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// fqnæ˜¯ç±»æ‰€åœ¨å®Œå…¨é™å®šåï¼Œå³åŒ…æ‹¬å…¶æ‰€åœ¨åŒ…çš„åŒ…å</span></span><br><span class="line">    String externalName = fqn.substring(<span class="number">0</span>, fqn.indexOf(<span class="string">&#x27;.&#x27;</span>)).replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    ClassLoader loader = getClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; type = loader.loadClass(externalName);</span><br><span class="line">    <span class="keyword">if</span> (test.matches(type)) &#123;</span><br><span class="line">      matches.add((Class&lt;T&gt;) type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    log.warn(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a>VFS</h3><p>VFSè¡¨ç¤ºè™š æ‹Ÿ æ–‡ä»¶ç³»ç»Ÿ (VirtualFileSystem),å®ƒ ç”¨æ¥ æŸ»æ‰¾ æŒ‡å®šè·¯å¾„ ä¸‹çš„èµ„ æºã€‚VFSæ˜¯ä¸€ä¸ª æŠ½è±¡ç±» ï¼ŒMyBatisä¸­æä¾›äº† JBoss6VFSå’Œ DefaultVFSä¸¤ ä¸ª VFSçš„å® ç° ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ç”¨æˆ· ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰ çš„VFSå® ç° ç±» ã€‚</p><blockquote><p>VFSé‡‡ç”¨å•ä¾‹æ¨¡å¼å®ç°</p></blockquote><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608220219508_W9RlCv.png" alt="image-20200608220219508"></p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”æ—¥å¿—æ¨¡å—</title>
      <link href="/blog/2019/10/26/899df03d.html"/>
      <url>/blog/2019/10/26/899df03d.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm-20200609155948653_2YZD6l.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„æ—¥å¿—æ¨¡å—</p></blockquote><p>åœ¨ Java å¼€ å‘ ä¸­å¸¸ç”¨çš„æ—¥å¿—æ¡† æ¶æœ‰ <code>Log4j</code>ã€<code>Log4j2</code>ã€<code>Apache Commons Log</code>ã€<code>java.util.logging</code>ã€ <code>slf4j</code>ç­‰ï¼Œè¿™ äº›å·¥å…·å¯¹ å¤–çš„æ¥å£ä¸å°½ ç›¸åŒã€‚</p><p>ä¸º äº†ç»Ÿ ä¸€è¿™ äº›å·¥å…·çš„æ¥å£ï¼ŒMyBatiså®šä¹‰ äº†ä¸€å¥—ç»Ÿ ä¸€ çš„æ—¥å¿—æ¥å£ä¾›ä¸Šå±‚ ä½¿ç”¨ï¼Œå¹¶ ä¸º ä¸Šè¿°å¸¸ç”¨çš„æ—¥å¿—æ¡† æ¶æä¾›äº†ç›¸åº” çš„é€‚é…å™¨ã€‚</p><h3 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h3><p>å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è®¾è®¡æ¨¡å¼ä¸­çš„å…­å¤§åŸåˆ™</p><ul><li><p>å•ä¸€èŒè´£åŸåˆ™</p><p>ä¸è¦å­˜åœ¨å¤šäºä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŸå› ï¼Œç®€å•æ¥è¯´ï¼Œä¸€ä¸ªç±»åªè´Ÿè´£å”¯ä¸€ é¡¹èŒè´£ã€‚</p></li><li><p>é‡Œæ°æ›¿æ¢åŸåˆ™</p><p>å¦‚æœå¯¹ æ¯ä¸€ä¸ª ç±» å‹ä¸º T1çš„å¯¹ è±¡tlï¼Œéƒ½æœ‰ç±» å‹ä¸º T2çš„å¯¹ è±¡ä½¿å¾—ä»¥ T1å®šä¹‰ çš„æ‰€æœ‰ç¨‹åºPåœ¨æ‰€æœ‰çš„å¯¹ è±¡tléƒ½ä»£æ¢ æˆt2æ—¶ ï¼Œç¨‹åºP çš„è¡Œä¸º æ²¡ æœ‰å‘ ç”Ÿå˜ åŒ–ï¼Œ é‚£ä¹ˆ ç±» å‹T2æ˜¯ç±» å‹T1çš„å­ç±» å‹ã€‚éµå®ˆé‡Œæ°æ›¿æ¢ åŸåˆ™ ï¼Œå¯ä»¥å¸® åŠ©æˆ‘ä»¬ è®¾ è®¡ å‡ºæ›´ä¸º åˆ ç†çš„ç»§ æ‰¿ä½“ ç³»ã€‚</p></li><li><p>ä¾èµ–å€’ç½®åŸåˆ™</p><p>ç³»ç»Ÿçš„é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—çš„å…·ä½“å®ç°ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–å…¶ æŠ½è±¡ç±» æˆ–æ¥å£ï¼ŒæŠ½è±¡æ¥å£ä¸åº” è¯¥ ä¾èµ– å…·ä½“ å® ç° ç±» ï¼Œè€Œå…·ä½“ å® ç° ç±» åº” è¯¥ äºä¾èµ– æŠ½è±¡ã€‚ç®€ å• æ¥ è¯´ ï¼Œæˆ‘ä»¬ è¦é¢å‘æ¥å£ç¼– ç¨‹ã€‚å½“ éœ€æ±‚å‘ ç”Ÿå˜ åŒ–æ—¶ å¯¹ å¤–æ¥å£ä¸å˜ ï¼Œåªè¦æä¾›æ–°çš„å® ç° ç±» å³ å¯ã€‚</p></li><li><p>æ¥å£éš”ç¦»åŸåˆ™</p><p>ä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šã€‚ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬ åœ¨è®¾ è®¡ æ¥å£æ—¶ ï¼Œä¸è¦è®¾ è®¡ å‡ºåº å¤§è‡ƒ è‚¿ çš„æ¥å£ï¼Œå› ä¸º å® ç° è¿™ ç§ æ¥å£æ—¶ éœ€è¦å® ç° å¾ˆ å¤šä¸å¿… è¦çš„æ–¹æ³•ã€‚æˆ‘ä»¬ è¦å°½ é‡è®¾ è®¡ å‡ºåŠŸèƒ½å• ä¸€çš„æ¥å£ï¼Œè¿™ æ · ä¹Ÿèƒ½ä¿è¯ å® ç° ç±» çš„èŒ è´£ å• ä¸€ã€‚</p></li><li><p>è¿ªç±³ç‰¹æ³•åˆ™</p><p>ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°‘çš„äº†è§£ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¦æ±‚æˆ‘ä»¬å‡ ä½ç±» é—´ è€¦ åˆã€‚</p></li><li><p>å¼€æ”¾-å°é—­åŸåˆ™</p><p>ç¨‹åºè¦å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ç®€å•æ¥è¯´ï¼Œå½“éœ€æ±‚å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ ä»¬ å¯ä»¥é€šè¿‡ æ·»åŠ æ–°çš„æ¨¡å— æ»¡ è¶³æ–°éœ€æ±‚ï¼Œè€Œä¸æ˜¯é€šè¿‡ ä¿®æ”¹åŸæ¥ çš„å® ç° ä»£ç  æ¥ æ»¡ è¶³æ–°éœ€æ±‚ã€‚</p></li></ul><p><strong>åœ¨è¿™ å…­æ¡ åŸåˆ™ ä¸­ï¼Œå¼€ æ”¾-å°é—­ åŸåˆ™ æ˜¯æœ€åŸºç¡€ çš„åŸåˆ™ ï¼Œä¹Ÿæ˜¯å…¶ä»–åŸåˆ™ ä»¥åŠåæ–‡ä»‹ç» çš„æ‰€æœ‰è®¾ è®¡ æ¨¡å¼çš„æœ€ç»ˆ ç›®æ ‡ ã€‚</strong></p><p>é€‚é…å™¨æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯è§£å†³ ç”±äºæ¥å£ä¸èƒ½å…¼å®¹è€Œå¯¼ è‡´ç±» æ—  æ³•ä½¿ç”¨çš„é—® é¢˜ ï¼Œé€‚é…å™¨æ¨¡å¼ä¼š å°† éœ€è¦é€‚é…çš„ç±» è½¬ æ¢ æˆè°ƒ ç”¨è€…èƒ½å¤Ÿ ä½¿ç”¨çš„ç›®æ ‡ æ¥å£ã€‚è¿™ é‡Œå…ˆä»‹ç» é€‚é…å™¨æ¨¡å¼ä¸­æ¶‰åŠçš„å‡  ä¸ª è§’è‰²ï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚</p><ul><li><p>ç›®æ ‡æ¥å£</p><p> ç”¨è€…èƒ½å¤Ÿ ç›´æ¥ä½¿ç”¨çš„æ¥å£ã€‚</p></li><li><p>éœ€è¦é€‚é…çš„ç±»ï¼ˆAdapteeï¼‰</p><p>â€”èˆ¬æƒ…å†µä¸‹ï¼ŒAdapteeç±»ä¸­æœ‰çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å…¶æ¥å£ ä¸èƒ½è¢«è°ƒ ç”¨è€…ç›´æ¥ä½¿ç”¨ã€‚</p></li><li><p>é€‚é…å™¨ï¼ˆAdapterï¼‰</p><p>Adapter å® ç° äº† Target æ¥å£ï¼Œå¹¶ åŒ…è£… äº†ä¸€ä¸ª Adaptee å¯¹ è±¡ã€‚Adapter åœ¨å® ç° Targetæ¥å£ä¸­çš„æ–¹æ³•æ—¶ ï¼Œä¼š å°† è°ƒ ç”¨å§”æ‰˜ç»™ Adapteeå¯¹ è±¡çš„ç›¸å…³ æ–¹æ³•ï¼Œç”±Adaptee å®Œæˆå…·ä½“ çš„ä¸š åŠ¡ ã€‚</p></li></ul><p>é€‚é…å™¨æ¨¡å¼ç±»å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608165414581_Ty7boQ.png" alt="image-20200608165414581"></p><blockquote><p>ä½¿ç”¨é€‚é…å™¨æ¨¡å¼çš„å¥½å¤„ å°±æ˜¯å¤ ç”¨ç° æœ‰ç»„ ä»¶ã€‚</p><p>åº” ç”¨ç¨‹åºéœ€è¦å¤ ç”¨ç° æœ‰çš„ç±» ï¼Œä½†æ¥å£ä¸èƒ½è¢«è¯¥ åº” ç”¨ç¨‹åºå…¼å®¹ï¼Œåˆ™ æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚</p><p>è¿™ ç§ åœº æ™¯ä¸‹å°±é€‚åˆä½¿ç”¨é€‚é…å™¨æ¨¡å¼å® ç° æ¥å£çš„é€‚é…ï¼Œä» è€Œå®Œ æˆç»„ ä»¶çš„å¤ ç”¨ã€‚</p><p>å¾ˆ æ˜æ˜¾ ï¼Œé€‚é…å™¨æ¨¡å¼é€šè¿‡ æä¾›Adapterçš„æ–¹å¼å®Œæˆæ¥å£é€‚é…ï¼Œå® ç° äº†ç¨‹åºå¤ ç”¨ Adapteeçš„éœ€æ±‚ï¼Œé¿å…äº†ä¿®æ”¹Adapteeå® ç° æ¥å£ï¼Œè¿™ ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ ã€‚</p><p>å½“ æœ‰æ–°çš„Adaptee éœ€è¦è¢«å¤ ç”¨æ—¶ ï¼Œåªè¦æ·»åŠ æ–°çš„Adapterå³ å¯ï¼Œè¿™ ä¹Ÿæ˜¯ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ çš„ã€‚</p></blockquote><p>åœ¨ MyBatisçš„æ—¥å¿—æ¨¡å— ä¸­ï¼Œå°±ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ã€‚</p><p>MyBatiså†… éƒ¨è°ƒ ç”¨å…¶æ—¥å¿—æ¨¡å— æ—¶ ï¼Œä½¿ç”¨ äº†å…¶å†… éƒ¨æ¥å£(ä¹Ÿå°±æ˜¯åé¢è¦ä»‹ç» çš„<code>org.apache.ibatis.loggingLog</code> æ¥å£)ã€‚ä½†æ˜¯ <code>Log4j</code>ã€<code>Log4j2</code> ç­‰ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶å¯¹ å¤–æä¾›çš„æ¥å£å„ä¸ç›¸åŒï¼ŒMyBatisä¸º äº†é›†æˆå’Œå¤ ç”¨è¿™ äº›ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶ï¼Œ</p><p>åœ¨å…¶æ—¥å¿—æ¨¡å— ä¸­æä¾›äº†å¤šç§ <code>Adapter</code>, å°† è¿™ äº›ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶å¯¹ å¤–çš„æ¥å£é€‚é…æˆäº† <code>org.apache.ibatis.logging.Log</code> æ¥å£ï¼Œè¿™ æ · MyBatis å†… éƒ¨å°±å¯ä»¥ç»Ÿ ä¸€é€šè¿‡ <code>org.apache.ibatis.logging.Log</code>æ¥å£è°ƒ ç”¨ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶çš„åŠŸèƒ½äº†ã€‚</p><h3 id="æ—¥å¿—é€‚é…å™¨"><a href="#æ—¥å¿—é€‚é…å™¨" class="headerlink" title="æ—¥å¿—é€‚é…å™¨"></a>æ—¥å¿—é€‚é…å™¨</h3><p>MyBatis ç»Ÿ ä¸€æä¾›äº† <code>trace</code>ã€<code>debug</code>ã€ <code>warn</code>ã€<code>error</code>å››ä¸ª çº§ åˆ« ç”¨äºå¯¹åº”ä¸Šè¯‰çš„å„ç§ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶çš„çº§åˆ«ï¼Œè¿™ åŸºæœ¬ä¸ ä¸»æµæ—¥å¿—æ¡† æ¶çš„æ›°å¿—çº§ åˆ« ç±» ä¼¼ï¼Œå¯ä»¥æ»¡ è¶³ç» å¤§å¤šæ•° åœº æ™¯çš„æ—¥å¿— éœ€æ±‚ã€‚</p><p>MyBatisçš„æ—¥å¿—æ¨¡å— ä½äº<code>org.apache.ibatis.logging</code>åŒ…ä¸­ï¼Œè¯¥ æ¨¡å— ä¸­é€šè¿‡ Logæ¥å£å®šä¹‰ äº†æ—¥å¿— æ¨¡å— çš„åŠŸèƒ½ï¼Œå½“ ç„¶æ—¥å¿—é€‚é…å™¨ä¹Ÿä¼š å® ç° æ­¤æ¥å£ã€‚LogFactoryå·¥å‚ ç±» è´Ÿ è´£ åˆ› å»ºå¯¹ åº” çš„æ—¥å¿—ç»„ ä»¶é€‚ é…å™¨ã€‚</p><p>åœ¨LogFactoryç±» åŠ è½½ æ—¶ ä¼š æ‰§ è¡Œå…¶é™ æ€ ä»£ç  å— ï¼Œå…¶é€» è¾‘ æ˜¯æŒ‰åºåŠ è½½ å¹¶ å® ä¾‹åŒ–å¯¹ åº” æ—¥å¿—ç»„ ä»¶çš„ é€‚é…å™¨ï¼Œç„¶åä½¿ç”¨<code>LogFactory. logConstructor</code>è¿™ ä¸ª é™ æ€ å­—æ®µï¼Œè®° å½• å½“ å‰ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶çš„ é€‚é…å™¨ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Log&gt; logConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useSlf4jLogging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useCommonsLogging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useLog4J2Logging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useLog4JLogging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useJdkLogging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  tryImplementation(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      useNoLogging();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LogFactory.tryImplementation()</code>æ–¹ æ³• é¦– å…ˆ ä¼š æ£€ æµ‹ <code>logConstructor</code>å­— æ®µ ï¼Œ è‹¥ ä¸º ç©º åˆ™ è°ƒ ç”¨ <code>Runnable.run()</code>æ–¹æ³•(æ³¨æ„ï¼Œä¸æ˜¯***start()***æ–¹æ³•)ï¼Œå¦‚ä¸Šè¿°ä»£ç  æ‰€ç¤ºï¼Œå…¶ä¸­ä¼š è°ƒ ç”¨<code>use*Logging()</code>æ–¹æ³•ã€‚ è¿™ é‡Œä»¥<code>useJdkLogging()</code>ä¸º ä¾‹è¿› è¡Œä»‹ç» ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">useJdkLogging</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImplementation</span><span class="params">(Class&lt;? extends Log&gt; implClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šé€‚é…å™¨çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">    Constructor&lt;? extends Log&gt; candidate = implClass.getConstructor(String.class);</span><br><span class="line">    Log log = candidate.newInstance(LogFactory.class.getName());</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(<span class="string">&quot;Logging initialized using &#x27;&quot;</span> + implClass + <span class="string">&quot;&#x27; adapter.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–logConstructorå­—æ®µ</span></span><br><span class="line">    logConstructor = candidate;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LogException(<span class="string">&quot;Error setting Log implementation.  Cause: &quot;</span> + t, t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸åº”çš„å®ç°ç±»éƒ½åœ¨<code>org.apache.ibatis.logging</code>çš„å­åŒ…ä¸‹ã€‚ä¸”éƒ½å® ç° äº† <code>org.apache.ibatis.logging.Log</code> æ¥å£ï¼Œå¹¶ å°è£… äº† <code>java.util.logging. Logger</code> å¯¹ è±¡ ï¼Œ<code>org.apache.ibatis.logging.Log</code> æ¥å£ çš„åŠŸèƒ½å…¨éƒ¨é€šè¿‡ è°ƒ ç”¨ <code>java.util.logging.Logger</code> å¯¹ è±¡ å® ç° ï¼Œè¿™ ä¸ å‰é¢ä»‹ç» çš„é€‚é…å™¨æ¨¡å¼å®Œå…¨ä¸€è‡´ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608171903948_fKzybU.png" alt="image-20200608171903948"></p><h3 id="JDBCè°ƒè¯•"><a href="#JDBCè°ƒè¯•" class="headerlink" title="JDBCè°ƒè¯•"></a>JDBCè°ƒè¯•</h3><p>åœ¨MyBatisçš„æ—¥å¿—æ¨¡å— ä¸­æœ‰ä¸€ä¸ª JdbcåŒ…ï¼Œå®ƒ å¹¶ ä¸æ˜¯å°† æ—¥å¿—ä¿¡æ¯é€šè¿‡ JDBCä¿å­˜åˆ°æ•° æ®åº“ ä¸­ï¼Œ è€Œæ˜¯é€šè¿‡ JDKåŠ¨ æ€ ä»£ç†çš„æ–¹å¼ï¼Œå°† JDBCæ“ä½œé€šè¿‡ æŒ‡å®šçš„æ—¥å¿—æ¡† æ¶æ‰“å°å‡ºæ¥ ã€‚è¿™ ä¸ª åŠŸèƒ½é€šå¸¸åœ¨ å¼€ å‘ é˜¶ æ®µä½¿ç”¨ï¼Œå®ƒ å¯ä»¥è¾“ å‡ºSQLè¯­ å¥ã€ç”¨æˆ· ä¼  å…¥çš„ç»‘ å®šå‚ æ•° ã€SQLè¯­ å¥å½±å“ è¡Œæ•° ç­‰ç­‰ä¿¡æ¯ï¼Œå¯¹ è°ƒ è¯• ç¨‹åºæ¥ è¯´ æ˜¯éå¸¸é‡è¦çš„ã€‚</p><p>BaseJdbcLoggeræ˜¯ä¸€ä¸ª æŠ½è±¡ç±» ï¼Œå®ƒ æ˜¯JdbcåŒ…ä¸‹å…¶ä»–Loggerç±» çš„çˆ¶ç±» ï¼Œç»§ æ‰¿å…³ ç³»å¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608172259632_8cistF.png" alt="image-20200608172259632"></p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”åå°„æ¨¡å—</title>
      <link href="/blog/2019/10/25/899df03d.html"/>
      <url>/blog/2019/10/25/899df03d.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/2_c5SKkm-20200609160003190_wDXqrk.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡ä»‹ç»MyBatisçš„åå°„æ¨¡å—</p></blockquote><h3 id="åå°„å·¥å…·ç®±"><a href="#åå°„å·¥å…·ç®±" class="headerlink" title="åå°„å·¥å…·ç®±"></a>åå°„å·¥å…·ç®±</h3><p>Mybatis åœ¨è¿›è¡Œå‚æ•°å¤„ç†ã€ç»“æœæ˜ å°„ç­‰æ“ä½œæ—¶ï¼Œä¼šæ¶‰åŠå¤§é‡çš„åå°„æ“ä½œã€‚Java ä¸­çš„åå°„è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯ä»£ç ç¼–å†™èµ·æ¥æ¯”è¾ƒå¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼Œä¸ºäº†ç®€åŒ–åå°„æ“ä½œçš„ç›¸å…³ä»£ç ï¼ŒMybatis æä¾›äº†ä¸“é—¨çš„åå°„æ¨¡å—ï¼Œè¯¥æ¨¡å—ä½äº <code>org.apache.ibatis.reflection</code> åŒ…ä¸­ï¼Œå®ƒå¯¹å¸¸è§çš„åå°„æ“ä½œåšäº†è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´åŠ ç®€æ´æ–¹ä¾¿çš„åå°„ APIã€‚</p><h4 id="Reflector-amp-ReflectorFactory"><a href="#Reflector-amp-ReflectorFactory" class="headerlink" title="Reflector &amp; ReflectorFactory"></a>Reflector &amp; ReflectorFactory</h4><p>Reflectoræ˜¯MyBatisä¸­åå°„æ¨¡å—çš„åŸºç¡€ï¼Œæ¯éš”Reflectorå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªç±»ï¼Œåœ¨Reflectorä¸­ç¼“å­˜äº†åå°„æ“ä½œéœ€è¦ä½¿ç”¨çš„ç´¯çš„å…ƒä¿¡æ¯ã€‚</p><p>Reflectorä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Private Class &lt;?&gt; type; <span class="comment">//å¯¹åº”çš„ C1 ass ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯è¯»å±æ€§çš„åç§°é›†åˆï¼Œå¯è¯»å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” getter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> String I readablepropertynames= EMPTY STRING ARRAY</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯å†™å±æ€§çš„åç§°é›†åˆï¼Œå¯å†™å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” setter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> String  [writeablepropertynames EMPTY STRING ARRAY;</span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ Invoker å¯¹è±¡ï¼Œå®ƒæ˜¯å¯¹ setter æ–¹æ³•å¯¹åº” </span></span><br><span class="line"><span class="comment">// Me thod å¯¹è±¡çš„å°è£…ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Invoker&gt; setmethods =<span class="keyword">new</span> Hashmap &lt;String, Invoker&gt;  ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å±æ€§ç›¸åº”çš„ getter æ–¹æ³•é›†åˆï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue ä¹Ÿæ˜¯ Invoker å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Invoker&gt; getmethods =<span class="keyword">new</span> Hashmap &lt;String, Invoker&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ setter æ–¹æ³•çš„å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;String, Class &lt;?&gt;&gt; settypes =<span class="keyword">new</span> Hashmap &lt;string, Class &lt;?&gt;&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†å±æ€§ç›¸åº”çš„ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ </span></span><br><span class="line"><span class="keyword">private</span> Map &lt;string, Class &lt;?&gt;&gt; gettypes=<span class="keyword">new</span> Hashmap &lt;string, Class &lt;?&gt;&gt; ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Constructor &lt;?&gt; <span class="keyword">default</span> Constructor; <span class="comment">//è®°å½•äº†é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•äº†æ‰€æœ‰å±æ€§åç§°çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Map &lt;string, String&gt; caseinsensitivepropertymap-<span class="keyword">new</span> Hashmap &lt;String, String&gt; ();</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨Reflectorçš„æ„é€ æ–¹æ³•ä¸­ä¼šè§£æåˆ¶å®šçš„Classå¯¹è±¡ï¼Œå¹¶å¡«å……ä¸Šè¿°é›†åˆã€‚å…·ä½“å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reflector</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">  type = clazz; <span class="comment">// åˆå§‹åŒ–typeå­—æ®µ</span></span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾clazzçš„é»˜è®¤æ„é€ æ–¹æ³•ï¼Œå…·ä½“å®ç°æ˜¯é€šè¿‡åå°„éå†æ‰€æœ‰æ„é€ æ–¹æ³•</span></span><br><span class="line">  addDefaultConstructor(clazz);</span><br><span class="line">  addGetMethods(clazz); <span class="comment">// å¤„ç†clazzä¸­çš„getteræ–¹æ³•ï¼Œå¡«å……getMethodsé›†åˆå’ŒgetTypesé›†åˆ</span></span><br><span class="line">  addSetMethods(clazz); <span class="comment">// å¤„ç†clazzä¸­çš„setteræ–¹æ³•ï¼Œå¡«å……setMethodsé›†åˆå’ŒsetTypesé›†åˆ</span></span><br><span class="line">  addFields(clazz); <span class="comment">// å¤„ç†æ²¡æœ‰getter/setteræ–¹æ³•çš„å­—æ®µ</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®getMethods/setMethodsé›†åˆï¼Œåˆå§‹åŒ–å¯è¯»/å†™å±æ€§çš„åç§°é›†åˆ</span></span><br><span class="line">  readablePropertyNames = getMethods.keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">  writablePropertyNames = setMethods.keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–caseInsensitivePropertyMapé›†åˆï¼Œå…¶ä¸­è®°å½•äº†æ‰€æœ‰å¤§å†™æ ¼å¼çš„å±æ€§åç§°</span></span><br><span class="line">  <span class="keyword">for</span> (String propName : readablePropertyNames) &#123;</span><br><span class="line">    caseInsensitivePropertyMap.put(</span><br><span class="line">      propName.toUpperCase(Locale.ENGLISH), propName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (String propName : writablePropertyNames) &#123;</span><br><span class="line">    caseInsensitivePropertyMap.put(</span><br><span class="line">      propName.toUpperCase(Locale.ENGLISH), propName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Reflector.Addgetmethodso()</code>æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ <code>getter</code> æ–¹æ³•ï¼Œ<code>Reflector. addSetMethods()</code>æ–¹æ³•è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ <code>setter</code> æ–¹æ³•ï¼Œä¸¤è€…çš„é€»è¾‘ç±»ä¼¼ã€‚</p><p><code>Reflector. Addgetmethods()</code> æ–¹æ³•æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ã€‚</p><ol><li><p>é¦–å…ˆï¼Œè°ƒç”¨Reflector.getClassMethods()æ–¹æ³•è·å–å½“å‰ç±»åŠå…¶çˆ¶ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå“åº”çš„Methodå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Method[] getClassMethods(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">  <span class="comment">// ç”¨äºè®°å½•åˆ¶å®šç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå¯¹åº”çš„Methodå¯¹è±¡</span></span><br><span class="line">  Map&lt;String, Method&gt; uniqueMethods = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  Class&lt;?&gt; currentClass = clazz;</span><br><span class="line">  <span class="keyword">while</span> (currentClass != <span class="keyword">null</span> &amp;&amp; currentClass != Object.class) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•currentClassè¿™ä¸ªç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³•</span></span><br><span class="line">    addUniqueMethods(uniqueMethods, currentClass.getDeclaredMethods());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we also need to look for interface methods -</span></span><br><span class="line">    <span class="comment">// because the class may be abstract</span></span><br><span class="line">    <span class="comment">// è®°å½•æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•</span></span><br><span class="line">    Class&lt;?&gt;[] interfaces = currentClass.getInterfaces();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; anInterface : interfaces) &#123;</span><br><span class="line">      addUniqueMethods(uniqueMethods, anInterface.getMethods());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–çˆ¶ç±»ï¼Œç»§ç»­whileå¾ªç¯</span></span><br><span class="line">    currentClass = currentClass.getSuperclass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Collection&lt;Method&gt; methods = uniqueMethods.values();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]);<span class="comment">// è½¬æ¢æˆMethodsæ•°ç»„è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åï¼ŒæŒ‰ç…§JavaBeançš„è§„èŒƒï¼Œä»Reflector.getClassMethods()æ–¹æ³•è¿”å›çš„Methodæ•°ç»„ä¸­æŸ¥æ‰¾è¯¥ç±»ä¸­å®šä¹‰çš„getteræ–¹æ³•ï¼Œå°†å…¶è®°å½•åˆ°<code>conflictingGetters</code>é›†åˆä¸­ã€‚<code>conflictingGetters</code>é›†åˆçš„keyä¸ºå±æ€§åç§°ï¼Œvalueæ˜¯è¯¥å±æ€§å¯¹åº”çš„getteræ–¹æ³•çš„é›†åˆã€‚</p></li><li><p>å½“å­ç±»è¦†ç›–äº†çˆ¶ç±»çš„getteræ–¹æ³•ä¸”è¿”å›å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨æ­¥éª¤1ä¸­å°±ä¼šäº§ç”Ÿä¸¤ä¸ªç­¾åä¸åŒçš„æ–¹æ³•ã€‚</p></li></ol><h4 id="TypeParameterResolver"><a href="#TypeParameterResolver" class="headerlink" title="TypeParameterResolver"></a>TypeParameterResolver</h4><p>åœ¨å¼€ å§‹ä»‹ç» TypeParameterResolverä¹‹å‰ï¼Œå…ˆç®€ å• ä»‹ç» ä¸€ä¸‹Typeæ¥å£çš„åŸºç¡€ çŸ¥è¯† ã€‚Typeæ˜¯æ‰€æœ‰ç±» å‹çš„çˆ¶æ¥å£ï¼Œå®ƒ æœ‰å››ä¸ª å­æ¥å£å’Œä¸€ä¸ª å® ç° ç±» ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/image-20200606160310736_88u4tj.png" alt="image-20200606160310736"></p><p>ä¸‹é¢æ¥ çœ‹è¿™ äº›å­æ¥å£å’Œå­ç±» æ‰€ä»£è¡¨çš„ç±» å‹ã€‚</p><ul><li><p><strong>Class</strong>æ¯”è¾ƒ å¸¸è§ ï¼Œå®ƒ è¡¨ç¤ºçš„æ˜¯åŸå§‹ç±» å‹ã€‚</p><p>Classç±» çš„å¯¹ è±¡è¡¨ç¤ºJVMä¸­çš„ä¸€ä¸ª ç±» æˆ–æ¥å£ï¼Œ æ¯ä¸ª Javaç±» åœ¨JVMé‡Œéƒ½è¡¨ç° ä¸º ä¸€ä¸ª Classå¯¹ è±¡ã€‚</p><p>åœ¨ç¨‹åºä¸­å¯ä»¥é€šè¿‡ â€œ<strong>ç±»å.class</strong>â€ã€â€œ**å¯¹è±¡.getClass()<strong>â€æˆ–æ˜¯â€œ</strong>Class.forName(â€œç±» åâ€)**â€ç­‰æ–¹å¼è· å–Classå¯¹ è±¡ã€‚</p><p>æ•° ç»„ ä¹Ÿè¢«æ˜ å°„ä¸º Classå¯¹ è±¡ï¼Œæ‰€æœ‰å…ƒç´ ç±» å‹ç›¸åŒä¸”ç»´ æ•° ç›¸åŒçš„æ•° ç»„ éƒ½å…±äº«åŒä¸€ä¸ª Classå¯¹ è±¡ã€‚</p></li><li><p><strong>ParameterizedType</strong> è¡¨ç¤ºçš„æ˜¯å‚ æ•° åŒ–ç±» å‹ï¼Œä¾‹å¦‚ List<String>ã€ Map&lt;Integerï¼ŒString&gt;ã€ Service<User>è¿™ ç§ å¸¦ æœ‰æ³›å‹çš„ç±» å‹ã€‚</p><p>ParameterizedTypeæ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯:</p><ul><li><code>Type getRawType()</code>â€”â€“è¿”å›å‚ æ•° åŒ–ç±» å‹ä¸­çš„åŸå§‹ç±» å‹ï¼Œä¾‹å¦‚List<Strin>çš„åŸå§‹ç±» å‹ä¸º Listã€‚</li><li><code>Type[] getActualTypeArguments()</code>â€”â€“è· å–å‚ æ•° åŒ–ç±» å‹çš„ç±» å‹å˜ é‡æˆ–æ˜¯å® é™… ç±» å‹åˆ— è¡¨ï¼Œä¾‹å¦‚Map&lt;Integerï¼ŒString&gt;çš„å® é™… æ³›å‹åˆ—è¡¨Integerå’Œ Stringã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ è¯¥ åˆ—è¡¨çš„å…ƒç´ ç±» å‹éƒ½æ˜¯Type,ä¹Ÿå°±æ˜¯è¯´ ï¼Œå¯èƒ½å­˜åœ¨å¤šå±‚ åµŒå¥—çš„æƒ…å†µ ã€‚</li><li><code>Type getOwnerType()</code>â€”â€“è¿”å›æ˜¯ç±» å‹æ‰€å± çš„ç±» å‹ï¼Œä¾‹å¦‚å­˜åœ¨A<T>ç±» ï¼Œå…¶ä¸­å®šä¹‰ äº† å†… éƒ¨ç±» InnerA<I>ï¼Œåˆ™ InnerA<I>å± çš„ç±» å‹ä¸º A<T>ï¼Œå¦‚æœæ˜¯é¡¶ å±‚ ç±» å‹åˆ™ è¿”å›nullã€‚ è¿™ ç§ å…³ ç³»æ¯”è¾ƒ å¸¸è§ çš„ç¤ºä¾‹æ˜¯Map&lt;Kï¼ŒV&gt;æ¥å£ä¸ Map.Entry&lt;Kï¼ŒV&gt;æ¥å£ï¼ŒMap&lt;Kï¼ŒV&gt; æ¥ å£ æ˜¯Map&lt;K,V&gt;æ¥å£çš„æ‰€æœ‰è€…ã€‚</li></ul></li><li><p><code>TypeVariable</code>è¡¨ç¤ºçš„æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ ç”¨æ¥ åæ˜ åœ¨JVMç¼– è¯‘ è¯¥ æ³›å‹å‰çš„ä¿¡æ¯ã€‚</p><p>ä¾‹å¦‚List<T> ä¸­çš„Tå°±æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ åœ¨ç¼– è¯‘ æ—¶ éœ€è¢«è½¬ æ¢ ä¸º ä¸€ä¸ª å…·ä½“ çš„ç±» å‹åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p><p>è¯¥ æ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯:</p><ul><li><p><code>Type[] getBounds()</code>â€”â€“è· å–ç±» å‹å˜ é‡çš„ä¸Šè¾¹ ç•Œï¼Œå¦‚æœæœªæ˜ç¡® å£° æ˜ä¸Šè¾¹ ç•Œåˆ™ é»˜è®¤ ä¸º Objectã€‚ </p><p>ä¾‹å¦‚ class Test<K extends Person>ä¸­ K çš„ä¸Šç•Œå°±æ˜¯ Personã€‚</p></li><li><p> <code>D getGenericDeclaration()</code>â€”â€“è· å–å£° æ˜è¯¥ ç±» å‹å˜ é‡çš„åŸå§‹ç±» å‹ï¼Œä¾‹ å¦‚ class Test<K extends Person> ä¸­ çš„åŸå§‹ç±» å‹æ˜¯ Testã€‚</p></li><li><p><code>String getName()</code>â€” è· å–åœ¨æºç  ä¸­å®šä¹‰ æ—¶ çš„åå­—ï¼Œä¸Šä¾‹ä¸­ä¸º Kã€‚</p></li></ul></li><li><p><code>GenericArrayType</code> è¡¨ç¤ºçš„æ˜¯æ•° ç»„ ç±» å‹ä¸”ç»„ æˆå…ƒç´ æ˜¯ ParameterizedType æˆ– TypeVariableã€‚ </p><p>ä¾‹å¦‚ List<String>æˆ–T[]ã€‚è¯¥ æ¥å£åªæœ‰ Type getGenericComponentType()â€”ä¸ª æ–¹æ³•ï¼Œå®ƒ è¿”å›æ•° ç»„ çš„ç»„ æˆå…ƒç´ ã€‚</p></li><li><p><code>WildcardType</code> è¡¨ç¤ºçš„æ˜¯é€šé…ç¬¦æ³›å‹ï¼Œä¾‹å¦‚<code>? extends Number</code> å’Œ<code>? uper Integer</code>ã€‚</p><p>WildcardTypeæ¥å£æœ‰ä¸¤ ä¸ª æ–¹æ³•ï¼Œåˆ†åˆ« æ˜¯:</p><ul><li><code>Type[] getUpperBounds()</code>â€”-è¿”å›æ³›å‹å˜ é‡çš„ä¸Šç•Œã€‚ </li><li> <code>Type[] getLowerBounds()</code>â€”- è¿”å›æ³›å‹å˜ é‡çš„ä¸‹ç•Œã€‚</li></ul></li></ul><p> å›åˆ°å¯¹ <code>TypeParameterResolve</code>ï¼Œå®ƒ æ˜¯ä¸€ä¸ª å·¥å…·ç±» ï¼Œæä¾›äº†ä¸€ç³»åˆ—é™ æ€ æ–¹æ³•æ¥ è§£ææŒ‡å®šç±» ä¸­çš„å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ã€‚TypeParameterResolverä¸­å„ä¸ª é™ æ€ æ–¹æ³•ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¤§è‡´å¦‚ä¸‹å›¾ æ‰€ç¤ºï¼Œä¸º ä¿æŒæ¸… æ™° ï¼Œå…¶ä¸­é€’ å½’ è°ƒ ç”¨æ²¡ æœ‰è¡¨ç° å‡ºæ¥ ï¼Œåœ¨åé¢ çš„ä»£ç  åˆ†æè¿‡ ç¨‹ä¸­ä¼š è¿› è¡Œå¼ºè°ƒ ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/image-20200606162023961_yxCRz4.png" alt="image-20200606162023961"></p><p><code>TypeParameterResolver</code> ä¸­ é€š è¿‡ <code>resolveFieldType()</code>æ–¹ æ³• ã€ <code>resolveRetumType()</code>æ–¹ æ³• ã€ <code>resolveParamTypes()</code>æ–¹æ³•åˆ†åˆ« è§£æå­—æ®µç±» å‹ã€æ–¹æ³•è¿”å›å€¼ ç±» å‹å’Œæ–¹æ³•å‚ æ•° åˆ—è¡¨ä¸­å„ä¸ª å‚ æ•° çš„ç±» å‹ã€‚ è¿™ ä¸‰ä¸ª æ–¹æ³•çš„é€» è¾‘ åŸºæœ¬ç±» ä¼¼ï¼Œè¿™ é‡Œä»¥resolveFieldType()æ–¹æ³•ä¸º ä¾‹è¿› è¡Œä»‹ç» ï¼Œ<code>TypeParameterResolver.resolveFieldType()</code>æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The field type as &#123;<span class="doctag">@link</span> Type&#125;. If it has type parameters in the declaration,</span></span><br><span class="line"><span class="comment">   *         they will be resolved to the actual runtime &#123;<span class="doctag">@link</span> Type&#125;s.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Type <span class="title">resolveFieldType</span><span class="params">(Field field, Type srcType)</span> </span>&#123;</span><br><span class="line">  Type fieldType = field.getGenericType();</span><br><span class="line">  Class&lt;?&gt; declaringClass = field.getDeclaringClass();</span><br><span class="line">  <span class="keyword">return</span> resolveType(fieldType, srcType, declaringClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸‰ä¸ª æ–¹æ³•éƒ½ä¼š è°ƒ ç”¨<code>resolveType()</code>æ–¹æ³•ï¼Œè¯¥ æ–¹æ³•ä¼š æ ¹æ®å…¶ç¬¬ä¸€ä¸ª å‚ æ•° çš„ ç±» å‹ï¼Œå³ å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ï¼Œé€‰ æ‹© åˆé€‚çš„æ–¹æ³•è¿› è¡Œè§£æã€‚<code>resolveType()</code>æ–¹æ³•çš„ ç¬¬äºŒä¸ª å‚ æ•° è¡¨ç¤ºæŸ¥ æ‰¾ è¯¥ å­—æ®µã€è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„èµ·å§‹ä½ç½®ã€‚ç¬¬ä¸‰ä¸ª å‚ æ•° åˆ™ è¡¨ç¤ºè¯¥ å­—æ®µã€æ–¹æ³• å®šä¹‰ æ‰€åœ¨çš„ç±» ã€‚<code>TypeParameterResolver.resolveType()</code>æ–¹æ³•ä»£ç  å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Type <span class="title">resolveType</span><span class="params">(Type type, Type srcType, Class&lt;?&gt; declaringClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">    <span class="comment">// è§£æTypeVariableç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveTypeVar((TypeVariable&lt;?&gt;) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">    <span class="comment">// è§£æParameterizedTypeç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveParameterizedType((ParameterizedType) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType) &#123;</span><br><span class="line">    <span class="comment">// è§£ægenericArrayTypeç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> resolveGenericArrayType((GenericArrayType) type, srcType, declaringClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> type; <span class="comment">// classç±»å‹</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å­—æ®µã€è¿”å›å€¼ ã€å‚ æ•° ä¸å¯èƒ½ç›´æ¥å®šä¹‰ æˆWildcardTypeç±» å‹ï¼Œä½†å¯ä»¥åµŒå¥—åœ¨åˆ« çš„ç±» å‹ä¸­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œé€šè¿‡ä¸€ä¸ªç¤ºä¾‹åˆ†æ<code>resolveType</code>æ–¹æ³•ï¼Œ å‡è®¾æœ‰ä¸‰ä¸ªç±» ClassAã€SubClassAã€TestTypeï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><code>ClassA</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassA</span> &lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123; </span><br><span class="line">  <span class="keyword">protected</span> Map&lt;K, V&gt; map;</span><br><span class="line"><span class="comment">// â€¢â€¢â€¢ map çš„ getter/setter æ–¹ æ³• (ç•¥ )</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SubClassA</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubClassA</span> &lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ClassA</span>&lt;<span class="title">T</span>,<span class="title">T</span>&gt; </span>&#123; </span><br><span class="line">  <span class="comment">// ...... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TestType</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  SubClassA&lt;Long&gt; sa = <span class="keyword">new</span> SubClassA();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">    Field f = ClassA.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    System.out.println(f.getGenericType());</span><br><span class="line">    System.out.println(f.getGenericType() <span class="keyword">instanceof</span> ParameterizedType);</span><br><span class="line">    <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">    <span class="comment">// java.util.Map&lt;K, V&gt;</span></span><br><span class="line">    <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æSubA&lt;Long&gt;(ParameterizedTypeç±» å‹)ä¸­çš„mapå­—æ®µï¼Œæ³¨æ„:ParameterizedTypelmplæ˜¯</span></span><br><span class="line">    <span class="comment">// åœ¨ sun.reflect.generics.reflectiveObjects åŒ…ä¸‹çš„ ParameterizedTypeæ¥å£å® ç°</span></span><br><span class="line"></span><br><span class="line">    Type type = TypeParameterResolver.resolveFieldType(</span><br><span class="line">      f, ParameterizedTypelmpl.make(SubClassA.class, </span><br><span class="line">                                    <span class="keyword">new</span> Type[]&#123;Long.class&#125;, TestType.class));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ç”Ÿæˆä¸Šè¿°ParameterizedTypeå¯¹ è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ è°ƒ ç”¨ TypeParameterResolver.resolveFieldType ()æ–¹ æ³• :</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// TypeParameterResolver.resolveFieldType(f,</span></span><br><span class="line">    <span class="comment">// TestType.class.getDeclaredField(&quot;sa&quot;).getGenericType());</span></span><br><span class="line">    System.out.println(type.getClass());</span><br><span class="line">    <span class="comment">// è¾“ å‡º :class TypeParameterResolver$ParameterizedTypelmpl</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼ŒTypeParameterResolver$ParameterizedTypeImplæ˜¯ParameterizedTypeæ¥å£çš„å® ç° </span></span><br><span class="line">    ParameterizedType p = (ParameterizedType) type; </span><br><span class="line">    System.out.println(p.getRawType());</span><br><span class="line">    <span class="comment">// è¾“ å‡º :interface java.util.Map</span></span><br><span class="line"></span><br><span class="line">    System.out.println(p.getOwnerType());</span><br><span class="line">    <span class="comment">// è¾“ å‡º:null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Type t : p .getActualTypeArguments()) &#123;</span><br><span class="line">      System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“ å‡º:</span></span><br><span class="line">    <span class="comment">// class java.lang.Long</span></span><br><span class="line">    <span class="comment">// class java.lang.Long</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‰é¢çš„Typeæ¥å£çš„ä»‹ç»ï¼Œä¸Šä¾‹ä¸­ClassA.mapå­—æ®µå£°æ˜çš„ç±»å‹Map&lt;K,V&gt;æ˜¯ParamelerizedTypeç±»å‹ï¼ŒresolveType()æ–¹æ³•å›è°ƒç”¨resolvParameterizedType()æ–¹æ³•è¿›è¡Œè§£æã€‚</p><p>é¦–å…ˆä»‹ç»resolveParameterizedType()æ–¹æ³•çš„å‚æ•°ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¾…è§£æçš„ParameterizedTypeç±»å‹</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯è§£ææ“ä½œçš„èµ·å§‹ç±»å‹</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå®šä¹‰è¯¥å­—æ®µæˆ–æ–¹æ³•çš„ç±»çš„Classå¯¹è±¡</li></ul><p>åœ¨è¯¥ç¤ºä¾‹ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Map&lt;K,V&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeTest.SubA<Long>å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰ç›¸åº”çš„Classå¯¹è±¡ã€‚</p><p><strong>ç»§ç»­åˆ†æ<code>scanSuperTypes()</code>æ–¹æ³•</strong>ï¼Œè¯¥æ–¹æ³•å›é€’å½’æ•´ä¸ªç»§æ‰¿ç»“æ„å¹¶å®Œæˆç±»å‹å˜é‡çš„è§£æã€‚åœ¨è¯¥ç¤ºä¾‹ä¹‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°Kå¯¹åº”çš„TypeVariableå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeText.SubA<Long>å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰å¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯SubClassAå¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯Class&lt;T,T&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ã€‚</p><p><code>scanSuperTypes()</code>æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Type <span class="title">scanSuperTypes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TypeVariable&lt;?&gt; typeVar, Type srcType, </span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; declaringClass, Class&lt;?&gt; clazz, Type superclass)</span> </span>&#123;</span><br><span class="line">    Type result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (superclass <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">      ParameterizedType parentAsType = (ParameterizedType) superclass;</span><br><span class="line">      Class&lt;?&gt; parentAsClass = (Class&lt;?&gt;) parentAsType.getRawType();</span><br><span class="line">      <span class="keyword">if</span> (declaringClass == parentAsClass) &#123;</span><br><span class="line">        Type[] typeArgs = parentAsType.getActualTypeArguments();</span><br><span class="line">        TypeVariable&lt;?&gt;[] declaredTypeVars = </span><br><span class="line">          declaringClass.getTypeParameters();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; declaredTypeVars.length; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (declaredTypeVars[i] == typeVar) &#123;</span><br><span class="line">            <span class="keyword">if</span> (typeArgs[i] <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">              TypeVariable&lt;?&gt;[] typeParams = clazz.getTypeParameters();</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; typeParams.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (typeParams[j] == typeArgs[i]) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (srcType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                    result = ((ParameterizedType) srcType).getActualTypeArguments()[j];</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              result = typeArgs[i];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (declaringClass.isAssignableFrom(parentAsClass)) &#123;</span><br><span class="line">        result = resolveTypeVar(typeVar, parentAsType, declaringClass);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (superclass <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">      <span class="keyword">if</span> (declaringClass.isAssignableFrom((Class&lt;?&gt;) superclass)) &#123;</span><br><span class="line">        result = resolveTypeVar(typeVar, superclass, declaringClass);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å±•ç¤ºäº†scanSuperTypes()æ–¹æ³•è§£æç±»å‹å˜é‡çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607094904927_ZT0Sxt.png" alt="image-20200607094904927"></p><h4 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h4><p>MyBatisä¸­å¾ˆå¤šæ¨¡å—ä¼šä½¿ç”¨åˆ°ObjectFactoryæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº†å¤šä¸ªcreate()æ–¹æ³•çš„é‡è½½ï¼Œé€šè¿‡è¿™äº›create()æ–¹æ³•å¯ä»¥åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚ObjectFactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets configuration properties.</span></span><br><span class="line"><span class="comment">   * è®¾ç½®é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> properties configuration properties</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a new object with default constructor. </span></span><br><span class="line"><span class="comment">   * é€šè¿‡æ— å‚æ„é€ å™¨åˆ›å»ºæŒ‡å®šç±»çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a new object with the specified constructor and params.</span></span><br><span class="line"><span class="comment">   * æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œä»æŒ‡å®šç±»å‹ä¸­é€‰æ‹©åˆé€‚çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> constructorArgTypes Constructor argument types</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> constructorArgs Constructor argument values</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns true if this object can have a set of other objects.</span></span><br><span class="line"><span class="comment">   * It&#x27;s main purpose is to support non-java.util.Collection objects like Scala collections.</span></span><br><span class="line"><span class="comment">   * æ£€æµ‹æŒ‡å®šç±»å‹æ˜¯å¦ä¸ºé›†åˆç±»å‹ï¼Œä¸»è¦å¤„ç†java.util.CollectiopnåŠå…¶å­ç±»</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type Object type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> whether it is a collection or not</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 3.1.0</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DefaultObjectFactory</code>æ˜¯<code>MyBatis</code>æä¾›çš„<code>ObjectFactory</code>æ¥å£çš„å”¯ä¸€å® ç° ï¼Œå®ƒ æ˜¯ä¸€ä¸ª åå°„å·¥å‚ ï¼Œ å…¶ <code>create()</code>æ–¹æ³•é€šè¿‡ è°ƒ ç”¨ <code>instantiateClass()</code>æ–¹æ³•å® ç° ã€‚</p><p><code>DefaultObjectFactory.instantiateClass()</code>æ–¹æ³•ä¼š æ ¹æ®ä¼  å…¥çš„å‚ æ•° åˆ—è¡¨é€‰ æ‹© åˆé€‚çš„æ„ é€ å‡½æ•° å® ä¾‹åŒ–å¯¹ è±¡ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span>  &lt;T&gt; <span class="function">T <span class="title">instantiateClass</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;T&gt; constructor;</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes == <span class="keyword">null</span> || constructorArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        constructor = type.getDeclaredConstructor();</span><br><span class="line">        <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">          constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">      &#125;</span><br><span class="line">      constructor = type.getDeclaredConstructor(constructorArgTypes.toArray(<span class="keyword">new</span> Class[constructorArgTypes.size()]));</span><br><span class="line">      <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> constructor.newInstance(constructorArgs.toArray(<span class="keyword">new</span> Object[constructorArgs.size()]));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      StringBuilder argTypes = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; argType : constructorArgTypes) &#123;</span><br><span class="line">          argTypes.append(argType.getSimpleName());</span><br><span class="line">          argTypes.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argTypes.deleteCharAt(argTypes.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      StringBuilder argValues = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgs != <span class="keyword">null</span> &amp;&amp; !constructorArgs.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object argValue : constructorArgs) &#123;</span><br><span class="line">          argValues.append(String.valueOf(argValue));</span><br><span class="line">          argValues.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argValues.deleteCharAt(argValues.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">&quot;Error instantiating &quot;</span> + type + <span class="string">&quot; with invalid types (&quot;</span> + argTypes + <span class="string">&quot;) or values (&quot;</span> + argValues + <span class="string">&quot;). Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä½¿ç”¨MyBatisæä¾›çš„<code>DefaultObjectFactory</code>å®ç°ï¼Œè¿˜å¯ä»¥åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè‡ªå®šä¹‰çš„ObjectFactoryæ¥å£å®ç°ç´¯ï¼Œ ä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ã€‚</p><h4 id="Propertyå·¥å…·ç±»"><a href="#Propertyå·¥å…·ç±»" class="headerlink" title="Propertyå·¥å…·ç±»"></a>Propertyå·¥å…·ç±»</h4><p><code>org.apache.ibatis.reflection.property</code> åŒ…ä¸‹ï¼Œæä¾›äº† PropertyCopierã€PropertyNamerã€PropertyTokenizer ä¸‰ä¸ªå±æ€§ç›¸å…³çš„å·¥å…·ç±»ã€‚</p><p><strong>PropertyTokenizer</strong></p><p>åœ¨ä½¿ç”¨MyBatisçš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°ä¸€äº›å±æ€§è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼Œåœ¨æŸ¥è¯¢ç”¨æˆ·ï¼ˆUserï¼‰çš„è®¢å•ï¼ˆOrderï¼‰çš„ç»“æœé›†å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>user_name</th><th>order</th><th>item1</th><th>item2</th><th>â€¦</th></tr></thead><tbody><tr><td>Mary</td><td>124640</td><td>iPhone 8 plus</td><td>MacBook Pro</td><td>â€¦</td></tr><tr><td>Lisa</td><td>46546</td><td>iPhone 11 Pro</td><td>Mac Pro</td><td>â€¦</td></tr><tr><td>â€¦</td><td>â€¦</td><td>â€¦</td><td>â€¦</td><td>â€¦</td></tr></tbody></table><p>å¯¹è±¡æ¨¡å‹å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607100948201_0zx3nS.png" alt="image-20200607100948201"></p><p>å‡è®¾ç°åœ¨éœ€è¦å°†ç»“æœé›†ä¸­çš„<code>item1</code>åˆ—é›¨ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•ï¼ˆOrderï¼‰çš„ç¬¬ä¸€æ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼Œ<code>item2</code>ä¸ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•çš„ï¼ˆOrderï¼‰çš„ç¬¬äºŒæ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼ˆè¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­å¾ˆå°‘è¿™æ ·çš„è®¾è®¡ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ˜ å°„è§„åˆ™ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;rm4testProTool&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orders[0].items[0].name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;iteml&quot;</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orders[0].items[1].name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;item2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>orders[0].items[0].name</code>è¿™ç§ç”±<code> .</code>å’Œ<code>[]</code>ç»„æˆçš„è¡¨è¾¾å¼æ˜¯ç”±<code>PropertyTokenizer</code>è¿›è¡Œè§£æçš„ã€‚ä»¥ä¸‹æ˜¯æ­¤ç±»çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyTokenizer</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">PropertyTokenizer</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// å½“å‰è¡¨è¾¾å¼çš„åç§°</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å½“å‰è¡¨è¾¾å¼çš„ç´¢å¼•å</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String indexedName;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç´¢å¼•ä¸‹æ ‡</span></span><br><span class="line">  <span class="keyword">private</span> String index;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å­è¡¨è¾¾å¼</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String children;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PropertyTokenizer</span><span class="params">(String fullname)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ . çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">int</span> delim = fullname.indexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ– name</span></span><br><span class="line">      name = fullname.substring(<span class="number">0</span>, delim);</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–children</span></span><br><span class="line">      children = fullname.substring(delim + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      name = fullname;</span><br><span class="line">      children = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–indexname</span></span><br><span class="line">    indexedName = name;</span><br><span class="line">    delim = name.indexOf(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (delim &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–index</span></span><br><span class="line">      index = name.substring(delim + <span class="number">1</span>, name.length() - <span class="number">1</span>);</span><br><span class="line">      name = name.substring(<span class="number">0</span>, delim);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getIndexedName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> indexedName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> children != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nextæ–¹æ³•ä¸­ä¼šåˆ›å»ºPropertyTokenizerå¯¹è±¡å¹¶è§£æchildrenå­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PropertyTokenizer <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PropertyTokenizer(children);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Remove is not supported, as it has no meaning in the context of properties.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PropertyTokenizer</code>ç»§æ‰¿äº†<code>Iterator</code>æ¥å£ï¼Œå®ƒå¯ä»¥è¿­ä»£å¤„ç†åµŒå¥—å¤šå±‚è¡¨è¾¾å¼ã€‚</p><p><code>next()</code>æ–¹æ³•ä¸­ä¼šåˆ›å»º<code>PropertyTokenizer</code>å¯¹è±¡å¹¶è§£æ<code>children</code>å­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼ã€‚</p><p>ç»§ç»­ä½¿ç”¨è®¢å•ç¤ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæè¿°è§£æå±æ€§è¡¨è¾¾å¼<code>orders[0].items[0].name</code>çš„è¿­ä»£è¿‡ç¨‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607102830771_hVgxny.png" alt="image-20200607102830771"></p><p><strong>PropertyNamer</strong></p><p><code>PropertyNamer</code>æ˜¯å¦ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†ä¸‹åˆ—é™æ€æ–¹æ³•å¸®åŠ©å®Œæˆæ–¹æ³•ååˆ°å±æ€§åçš„è½¬æ¢ï¼Œä»¥åŠå¤šç§æ£€æµ‹æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyNamer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PropertyNamer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prevent Instantiation of Static Class</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†æ–¹æ³•åè½¬æ¢æˆå±æ€§å</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">methodToProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;is&quot;</span>)) &#123;</span><br><span class="line">      name = name.substring(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">      name = name.substring(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">&quot;Error parsing property name &#x27;&quot;</span> + name + <span class="string">&quot;&#x27;.  Didn&#x27;t start with &#x27;is&#x27;, &#x27;get&#x27; or &#x27;set&#x27;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name.length() == <span class="number">1</span> || (name.length() &gt; <span class="number">1</span> &amp;&amp; !Character.isUpperCase(name.charAt(<span class="number">1</span>)))) &#123;</span><br><span class="line">      name = name.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(Locale.ENGLISH) + name.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;set&quot;</span>) || name.startsWith(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isGetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;get&quot;</span>) || name.startsWith(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name.startsWith(<span class="string">&quot;set&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>PropertyCopier</strong></p><p><code>PropertyCopier</code>æ˜¯ä¸€ä¸ªå±æ€§æ‹·è´çš„å·¥å…·ç±»ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<code>copyBeanProperties()</code>æ–¹æ³•ï¼Œä¸»è¦å®ç°ç›¸åŒç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å±æ€§å€¼æ‹·è´ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyCopier</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PropertyCopier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prevent Instantiation of Static Class</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyBeanProperties</span><span class="params">(Class&lt;?&gt; type, Object sourceBean, Object destinationBean)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; parent = type;</span><br><span class="line">    <span class="keyword">while</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Field[] fields = parent.getDeclaredFields();</span><br><span class="line">      <span class="keyword">for</span>(Field field : fields) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">          field.set(destinationBean, field.get(sourceBean));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">// Nothing useful to do, will only fail on final fields, which will be ignored.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç»§ç»­æ‹·è´çˆ¶ç±»ä¸­å®šä¹‰çš„å­—æ®µ</span></span><br><span class="line">      parent = parent.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MetaClass"><a href="#MetaClass" class="headerlink" title="MetaClass"></a>MetaClass</h4><p><code>org.apache.ibatis.reflection.MetaClass</code> ï¼Œç±»çš„å…ƒæ•°æ®ï¼ŒåŸºäº Reflector å’Œ PropertyTokenizer ï¼Œæä¾›å¯¹æŒ‡å®šç±»çš„å„ç§éªšæ“ä½œã€‚å®ç°äº†å¯¹å¤æ‚çš„å±æ€§è¡¨è¾¾å¼çš„è§£æï¼Œå¹¶å®ç°äº†è·å–æŒ‡å®šå±æ€§æè¿°ä¿¡æ¯çš„åŠŸèƒ½ã€‚</p><p>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºç¼“å­˜Reflectorå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory reflectorFactory;</span><br><span class="line">  <span class="comment">// åˆ›å»ºMetaClassæ—¶ä¼šæŒ‡å®šä¸€ä¸ªç±»ï¼Œè¯¥Reflectorå¯¹è±¡ä¼šç”¨äºè®°å½•è¯¥ç±»ç›¸å…³çš„å…ƒä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Reflector reflector;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MetaClassçš„æ„é€ æ–¹æ³•æ˜¯ä½¿ç”¨privateä¿®é¥°çš„</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MetaClass</span><span class="params">(Class&lt;?&gt; type, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.reflectorFactory = reflectorFactory;</span><br><span class="line">    <span class="comment">// åˆ›å»ºReflectorå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">this</span>.reflector = reflectorFactory.findForClass(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºMetaClasså¯¹è±¡</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MetaClass <span class="title">forClass</span><span class="params">(Class&lt;?&gt; type, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MetaClass(type, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MetaClass <span class="title">metaClassForProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; propType = reflector.getGetterType(name);</span><br><span class="line">    <span class="keyword">return</span> MetaClass.forClass(propType, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å§”æ‰˜ç»™buildProperty()æ–¹æ³•å®ç°</span></span><br><span class="line">    StringBuilder prop = buildProperty(name, <span class="keyword">new</span> StringBuilder());</span><br><span class="line">    <span class="keyword">return</span> prop.length() &gt; <span class="number">0</span> ? prop.toString() : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findProperty</span><span class="params">(String name, <span class="keyword">boolean</span> useCamelCaseMapping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (useCamelCaseMapping) &#123;</span><br><span class="line">      name = name.replace(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> findProperty(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getGetterNames() &#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getGetablePropertyNames();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getSetterNames() &#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getSetablePropertyNames();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      MetaClass metaProp = metaClassForProperty(prop.getName());</span><br><span class="line">      <span class="keyword">return</span> metaProp.getSetterType(prop.getChildren());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.getSetterType(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      MetaClass metaProp = metaClassForProperty(prop);</span><br><span class="line">      <span class="keyword">return</span> metaProp.getGetterType(prop.getChildren());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// issue #506. Resolve the type inside a Collection Object</span></span><br><span class="line">    <span class="keyword">return</span> getGetterType(prop);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> MetaClass <span class="title">metaClassForProperty</span><span class="params">(PropertyTokenizer prop)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; propType = getGetterType(prop);</span><br><span class="line">    <span class="keyword">return</span> MetaClass.forClass(propType, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; getGetterType(PropertyTokenizer prop) &#123;</span><br><span class="line">    Class&lt;?&gt; type = reflector.getGetterType(prop.getName());</span><br><span class="line">    <span class="keyword">if</span> (prop.getIndex() != <span class="keyword">null</span> &amp;&amp; Collection.class.isAssignableFrom(type)) &#123;</span><br><span class="line">      Type returnType = getGenericGetterType(prop.getName());</span><br><span class="line">      <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type[] actualTypeArguments = ((ParameterizedType) returnType).getActualTypeArguments();</span><br><span class="line">        <span class="keyword">if</span> (actualTypeArguments != <span class="keyword">null</span> &amp;&amp; actualTypeArguments.length == <span class="number">1</span>) &#123;</span><br><span class="line">          returnType = actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            type = (Class&lt;?&gt;) returnType;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            type = (Class&lt;?&gt;) ((ParameterizedType) returnType).getRawType();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Type <span class="title">getGenericGetterType</span><span class="params">(String propertyName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Invoker invoker = reflector.getGetInvoker(propertyName);</span><br><span class="line">      <span class="keyword">if</span> (invoker <span class="keyword">instanceof</span> MethodInvoker) &#123;</span><br><span class="line">        Field _method = MethodInvoker.class.getDeclaredField(<span class="string">&quot;method&quot;</span>);</span><br><span class="line">        _method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Method method = (Method) _method.get(invoker);</span><br><span class="line">        <span class="keyword">return</span> TypeParameterResolver.resolveReturnType(method, reflector.getType());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (invoker <span class="keyword">instanceof</span> GetFieldInvoker) &#123;</span><br><span class="line">        Field _field = GetFieldInvoker.class.getDeclaredField(<span class="string">&quot;field&quot;</span>);</span><br><span class="line">        _field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Field field = (Field) _field.get(invoker);</span><br><span class="line">        <span class="keyword">return</span> TypeParameterResolver.resolveFieldType(field, reflector.getType());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (reflector.hasSetter(prop.getName())) &#123;</span><br><span class="line">        MetaClass metaProp = metaClassForProperty(prop.getName());</span><br><span class="line">        <span class="keyword">return</span> metaProp.hasSetter(prop.getChildren());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.hasSetter(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æŒ‡å®šå±æ€§æ˜¯å¦æœ‰ getting æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasGetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (reflector.hasGetter(prop.getName())) &#123;</span><br><span class="line">        MetaClass metaProp = metaClassForProperty(prop);</span><br><span class="line">        <span class="keyword">return</span> metaProp.hasGetter(prop.getChildren());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reflector.hasGetter(prop.getName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Invoker <span class="title">getGetInvoker</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getGetInvoker(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Invoker <span class="title">getSetInvoker</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.getSetInvoker(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> StringBuilder <span class="title">buildProperty</span><span class="params">(String name, StringBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è§£æå±æ€§è¡¨è¾¾å¼</span></span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123; <span class="comment">// æ˜¯å¦è¿˜æœ‰å­è¡¨è¾¾å¼</span></span><br><span class="line">      <span class="comment">// æŸ¥æ‰¾Propertytokenizer.nameå¯¹åº”çš„å±æ€§</span></span><br><span class="line">      String propertyName = reflector.findPropertyName(prop.getName());</span><br><span class="line">      <span class="keyword">if</span> (propertyName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.append(propertyName);</span><br><span class="line">        builder.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸ºè¯¥å±æ€§åˆ›å»ºå¯¹åº”çš„MetaClasså¯¹è±¡</span></span><br><span class="line">        MetaClass metaProp = metaClassForProperty(propertyName);</span><br><span class="line">        <span class="comment">// é€’å½’è§£æchildrenå­—æ®µï¼Œå°†è§£æç»“æœæ·»åŠ åˆ°builderä¸­ä¿å­˜</span></span><br><span class="line">        metaProp.buildProperty(prop.getChildren(), builder);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// é€’å½’å‡ºå£</span></span><br><span class="line">      String propertyName = reflector.findPropertyName(name);</span><br><span class="line">      <span class="keyword">if</span> (propertyName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.append(propertyName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasDefaultConstructor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reflector.hasDefaultConstructor();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>MetaClassä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯findProperty()ï¼Œå®ƒæ˜¯é€šè¿‡è°ƒç”¨MetaClass.buildProperty()æ–¹æ³•å®ç°çš„ï¼Œ äºŒbuildProperty()æ–¹æ³•ä¼šé€šè¿‡PropertyTokenizerè§£æå¤æ‚çš„å±æ€§è¡¨è¾¾å¼</strong></li></ul><h4 id="ObjectWrapper"><a href="#ObjectWrapper" class="headerlink" title="ObjectWrapper"></a>ObjectWrapper</h4><p><code>MetaClass</code>æ˜¯Mybatiså¯¹ç±»çº§åˆ«çš„å…ƒä¿¡æ¯çš„å°è£…å’Œå¤„ç†ï¼Œä¸‹é¢æ¥çœ‹MyBatiså¯¹å¯¹è±¡çº§åˆ«çš„å…ƒä¿¡æ¯çš„å¤„ç†ã€‚<code>ObjectWrapper</code>æ¥å£æ˜¯å¯¹å¯¹è±¡çš„åŒ…è£…ï¼ŒæŠ½è±¡äº†å¯¹è±¡çš„å±æ€§ä¿¡æ¯ï¼Œå®ƒå®šä¹‰äº†ä¸€ç³»åˆ—æŸ¥è¯¢å¯¹è±¡å±æ€§ä¿¡æ¯çš„æ–¹æ³•ï¼Œä»¥åŠæ›´æ–°å±æ€§çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”å±æ€§çš„ç›¸åº”getteræ–¹æ³•ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è·å–æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼</span></span><br><span class="line">  <span class="function">Object <span class="title">get</span><span class="params">(PropertyTokenizer prop)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”çš„setteræ–¹æ³•</span></span><br><span class="line">  <span class="comment">// å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è®¾ç½®æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(PropertyTokenizer prop, Object value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾å±æ€§è¡¨è¾¾å¼æŒ‡å®šçš„å±æ€§ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦å¿½ç•¥å±æ€§è¡¨è¾¾å¼ä¸­çš„ä¸‹åˆ’çº¿</span></span><br><span class="line">  <span class="function">String <span class="title">findProperty</span><span class="params">(String name, <span class="keyword">boolean</span> useCamelCaseMapping)</span></span>;</span><br><span class="line"></span><br><span class="line">  String[] getGetterNames();</span><br><span class="line"></span><br><span class="line">  String[] getSetterNames();</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; getSetterType(String name);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; getGetterType(String name);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">hasSetter</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">hasGetter</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸ºå±æ€§è¡¨è¾¾å¼çš„å±æ€§åˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡</span></span><br><span class="line">  <span class="function">MetaObject <span class="title">instantiatePropertyValue</span><span class="params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Object element)</span></span>;</span><br><span class="line">  </span><br><span class="line">  &lt;E&gt; <span class="function"><span class="keyword">void</span> <span class="title">addAll</span><span class="params">(List&lt;E&gt; element)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ObjectWrapperFactoryè´Ÿè´£åˆ›å»ºObjectWrapperå¯¹è±¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607105809062_CxBOIT.png" alt="image-20200607105809062"></p><p><code>DefaultObjectWrapperFactory</code>å® ç° äº† <code>ObjectWrapperFactory</code>æ¥å£ï¼Œä½†å®ƒ å® ç° çš„ <code>getWrapperFor()</code> æ–¹æ³•å§‹ç»ˆ æŠ›å‡ºå¼‚ å¸¸ï¼Œ<code>hasWrapperFor()</code>æ–¹æ³•å§‹ç»ˆ è¿”å›falseï¼Œæ‰€ä»¥è¯¥ å® ç° å® é™… ä¸Šæ˜¯ä¸å¯ç”¨çš„ã€‚ä½†æ˜¯ ä¸ ObjectFactory ç±» ä¼¼ï¼Œæˆ‘ä»¬ å¯ä»¥åœ¨ mybatis-config.xml ä¸­é…ç½®è‡ªå®šä¹‰ çš„ ObjectWrapperFactory å® ç° ç±» è¿› è¡Œæ‰© å±•ï¼Œåœ¨åé¢ä»‹ç» MyBatisåˆå§‹åŒ–æ—¶ è¿˜ ä¼š æåˆ°è¯¥ æ‰© å±•ç‚¹ã€‚</p><p><code>BaseWrapper</code>æ˜¯ä¸€ä¸ªå®ç°äº†<code>ObjectWrapper</code>æ¥å£çš„æŠ½è±¡ç±»ï¼Œå…¶ä¸­å°è£…äº†<code>MetaObject</code>å¯¹è±¡ï¼Œå¹¶æä¾›äº†ä¸‰ä¸ªæ–¹å‹‡çš„æ–¹æ³•æä¾›å…¶å­ç±»ä½¿ç”¨ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607110710849_oIM782.png" alt="image-20200607110710849"></p><p>BaseWrapper,resolveCollection()æ–¹æ³•ä¼š è°ƒ ç”¨ MetaObject.get Value()æ–¹æ³•ï¼Œå®ƒ ä¼š è§£æå± æ€§è¡¨è¾¾ å¼å¹¶ è· å–æŒ‡å®šçš„å± æ€§ã€‚</p><p>BaseWrapper.getCollectionValue()æ–¹æ³•å’Œ setCollectionValue()æ–¹æ³•ä¼š è§£æå± æ€§è¡¨è¾¾ å¼çš„ç´¢å¼• ä¿¡æ¯ï¼Œç„¶åè· å–/è®¾ ç½®å¯¹ åº” é¡¹ ã€‚</p><h4 id="MetaObject"><a href="#MetaObject" class="headerlink" title="MetaObject"></a>MetaObject</h4><p><code>org.apache.ibatis.reflection.MetaObject</code> ï¼Œå¯¹è±¡å…ƒæ•°æ®ï¼Œæä¾›äº†å¯¹è±¡çš„å±æ€§å€¼çš„è·å¾—å’Œè®¾ç½®ç­‰ç­‰æ–¹æ³•ã€‚ å¯ä»¥ç†è§£æˆï¼Œå¯¹ BaseWrapper æ“ä½œçš„è¿›ä¸€æ­¥<strong>å¢å¼º</strong>ã€‚</p><blockquote><p>ObjectWrapperæä¾›äº†è·å–/è®¾ç½®å¯¹è±¡ä¸­æŒ‡å®šçš„å±æ€§å€¼ã€æ£€æµ‹getter/setterç­‰å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ˜¯ObjectWrapperåªæ˜¯è¿™äº›åŠŸèƒ½çš„æœ€åä¸€ç«™ï¼Œæˆ‘ä»¬çœç•¥äº†å¯¹å±æ€§è¡¨è¾¾å¼è§£æè¿‡ç¨‹çš„ä»‹ç»ï¼Œè€Œè¯¥è§£æè¿‡ç¨‹æ˜¯åœ¨MetaObjectä¸­å®ç°çš„ã€‚</p></blockquote><p><strong>MetaObject</strong>ä¸­å­—æ®µçš„å«ä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹JavaBeanå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object originalObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šæ–‡ä»‹ç»çš„ObjectWrapperå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†originalObjectå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectWrapper objectWrapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£å®ä¾‹åŒ–originalObjectçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectFactory objectFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£åˆ›å»ºObjectWrapperçš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectWrapperFactory objectWrapperFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºåˆ›å»ºå¹¶ç¼“å­˜Reflectorå¯¹è±¡çš„å·¥å‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory reflectorFactory;</span><br></pre></td></tr></table></figure><p><strong>MetaObjectçš„æ„é€ æ–¹æ³•</strong>ä¼šæ ¹æ®ä¼ å…¥çš„åŸå§‹å¯¹è±¡çš„ç±»å‹ä»¥åŠObjectFactoryå·¥å‚çš„å®ç°ï¼Œ åˆ›å»ºç›¸åº”çš„ObjectWrapperå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">MetaObject</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory, ReflectorFactory reflectorFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.originalObject = object;</span><br><span class="line">    <span class="keyword">this</span>.objectFactory = objectFactory;</span><br><span class="line">    <span class="keyword">this</span>.objectWrapperFactory = objectWrapperFactory;</span><br><span class="line">    <span class="keyword">this</span>.reflectorFactory = reflectorFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> ObjectWrapper) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = (ObjectWrapper) object;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objectWrapperFactory.hasWrapperFor(object)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = objectWrapperFactory.getWrapperFor(<span class="keyword">this</span>, object);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> MapWrapper(<span class="keyword">this</span>, (Map) object);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> CollectionWrapper(<span class="keyword">this</span>, (Collection) object);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.objectWrapper = <span class="keyword">new</span> BeanWrapper(<span class="keyword">this</span>, object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>MetaObjectå’ŒObjectWrapperä¸­å…³äºç±»çº§åˆ«çš„æ–¹æ³•ï¼Œä¾‹å¦‚hasGetter()ã€hasSetter()ã€findProperty()ç­‰æ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨MetaClassçš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</p><p>å…¶ä»–æ–¹æ³•éƒ½æ˜¯å…³äºå¯¹è±¡çº§åˆ«çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ä¸ObjectWrapperé…åˆå®ç°ï¼Œä¾‹å¦‚MetaObject.getValue()/setValue()æ–¹æ³•ã€‚</p><p>ä»¥ä¸‹æ˜¯getValue()çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) &#123;</span><br><span class="line">      <span class="comment">// æ ¹æ®PropertyTokenizerè§£æåæŒ‡å®šçš„å±æ€§ï¼Œåˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡</span></span><br><span class="line">      MetaObject metaValue = metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">      <span class="keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> metaValue.getValue(prop.getChildren());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> objectWrapper.get(prop);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h3><p>JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨PreparedStatementä¸ºSQLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œéœ€è¦ä»Javaç±»å‹è½¬æ¢æˆJDBCç±»å‹ï¼Œè€Œä»ç»“æœé›†è·å–æ•°æ®çš„æ—¶å€™ï¼Œåˆ™éœ€è¦ä»JDBCç±»å‹è½¬æ¢æˆJavaç±»å‹ã€‚</p><p>MyBatisä½¿ç”¨ç±»å‹è½¬æ¢å¤„ç†å™¨å®Œè½¦è¿‡äº†ä¸Šè¿°ä¸¤ç§è½¬æ¢ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607224820211_lIdG1a.png" alt="image-20200607224820211"></p><blockquote><p>åœ¨ MyBatisä¸­ä½¿ç”¨JdbcTypeè¿™ ä¸ª æšä¸¾ ç±» å‹ä»£è¡¨JDBCä¸­çš„æ•° æ®ç±» å‹ï¼Œè¯¥ æšä¸¾ ç±» å‹ä¸­å®šä¹‰ äº† TYPE_CODEå­—æ®µï¼Œè®° å½• äº† JDBCç±» å‹åœ¨java.sql.Typesä¸­ç›¸åº” çš„å¸¸é‡ ç¼– ç  ï¼Œå¹¶ é€šè¿‡ ä¸€ä¸ª é™ æ€ é›†åˆcodeLookup (HashMap&lt;Integerï¼ŒJdbcType&gt;ç±» å‹)ç»´ æŠ¤ äº†å¸¸é‡ç¼– ç  ä¸JdbcTypeä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p></blockquote><h4 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h4><p>MyBatisä¸­æ‰€æœ‰çš„ç±» å‹è½¬ æ¢ å™¨éƒ½ç»§ æ‰¿äº† TypeHandleræ¥å£ï¼Œåœ¨ TypeHandleræ¥å£ä¸­å®šä¹‰ äº†å¦‚ ä¸‹å››ä¸ª æ–¹æ³•ï¼Œè¿™ å››ä¸ª æ–¹æ³•åˆ†ä¸º ä¸¤ ç±» :setParameter()æ–¹æ³•è´Ÿ è´£ å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJava ç±» å‹:<code>getResult()</code>æ–¹æ³•åŠå…¶é‡è½½ è´Ÿ è´£ å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åœ¨é€šè¿‡ PreparedStatementä¸º SQLè¯­ å¥ç»‘ å®šå‚ æ•° æ—¶ ï¼Œä¼š å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJavaç±» å‹</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//ä» ResultSetä¸­è· å–æ•° æ®æ—¶ ä¼š è°ƒ ç”¨æ­¤æ–¹æ³•ï¼Œä¼š å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹</span></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰TypeHandlerå®ç°ï¼ŒMyBatisæä¾›äº†BaseTypeHandlerè¿™ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†TypeHandleræ¥å£ï¼Œå¹¶ç»§æ‰¿äº†TypeReferenceæŠ½è±¡ç±»ï¼Œå…¶ç»§æ‰¿ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607225857225_4Xvffn.png" alt="image-20200607225857225"></p><p>åœ¨BaseTypeHandlerä¸­å®ç°äº†<code>TypeHandler.setParameter()</code>æ–¹æ³•å’Œ<code>TypeHandler.getResult()</code>æ–¹æ³•ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å¯¹äºéç©ºæ•°æ®çš„å¤„ç†éƒ½äº¤ç»™äº†å­ç±»å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TypeReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfiguration</span><span class="params">(Configuration c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.configuration = c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (jdbcType == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;JDBC requires that the JdbcType must be specified for all nullable parameters.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        ps.setNull(i, jdbcType.TYPE_CODE);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;Error setting null for parameter #&quot;</span> + i + <span class="string">&quot; with JdbcType &quot;</span> + jdbcType + <span class="string">&quot; . &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Cause: &quot;</span> + e, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        setNonNullParameter(ps, i, parameter, jdbcType);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;Error setting non null for parameter #&quot;</span> + i + <span class="string">&quot; with JdbcType &quot;</span> + jdbcType + <span class="string">&quot; . &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Try setting a different JdbcType for this parameter or a different configuration property. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Cause: &quot;</span> + e, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(rs, columnName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column &#x27;&quot;</span> + columnName + <span class="string">&quot;&#x27; from result set.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(rs, columnIndex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column #&quot;</span> + columnIndex+ <span class="string">&quot; from result set.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    T result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = getNullableResult(cs, columnIndex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">&quot;Error attempting to get column #&quot;</span> + columnIndex+ <span class="string">&quot; from callable statement.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cs.wasNull()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ TypeHandlerç”¨äºå®Œæˆå•ä¸ªå‚æ•°ä»¥åŠå•ä¸ªåˆ—å€¼çš„ç±»å‹è½¬æ¢ï¼Œ å¦‚æœå­˜åœ¨å¤šåˆ—å€¼è½¬æ¢æˆä¸€ä¸ªJavaå¯¹è±¡çš„éœ€æ±‚ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘åœ¨ä½¿ç”¨æ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰åˆé€‚çš„æ˜ å°„è§„åˆ™ï¼ˆ<resultMap>ï¼‰å®Œæˆæ˜ å°„ã€‚</p><h4 id="TypeHandlerRegistry"><a href="#TypeHandlerRegistry" class="headerlink" title="TypeHandlerRegistry"></a>TypeHandlerRegistry</h4><p>ä»‹ç»å®ŒTypeHandleræ¥å£åŠå…¶åŠŸèƒ½ä¹‹åï¼ŒMyBatiså¦‚ä½•ç®¡ç†ä¼—å¤šçš„TypeHanlderæ¥å£å®ç°ï¼Œå¦‚ä½•çŸ¥é“ä½•æ—¶ä½¿ç”¨å“ªä¸ªTypeHandleræ¥å£å®ç°å®Œæˆè½¬æ¢å‘¢ï¼Ÿ</p><p>è¿™ä¸ªå·¥ä½œæ˜¯ç”±TypeHandlerRegistryå®Œæˆçš„ï¼Œåœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šä¸ºæ‰€æœ‰å·²çŸ¥çš„TypeHanlderåˆ›å»ºå¯¹è±¡ï¼Œå¹¶å®ç°æ³¨å†Œåˆ°TypeHandlerRegistryä¸­ï¼Œ ç”±TypeHandlerRegistryè´Ÿè´£ç®¡ç†è¿™äº›TypeHandlerå¯¹è±¡ã€‚</p><p><strong>TypeHandlerRegistry</strong>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•JdbcTypeä¸TypeHandlerä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­JdbcTypeæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå®šä¹‰å¯¹åº”çš„JDBCç±»å‹</span></span><br><span class="line"><span class="comment">// è¯¥é›†åˆä¸»è¦ç”¨äºä»ç»“æœé›†è¯»å–æ•°æ®æ—¶ï¼Œå°†æ•°æ®ä»Jdbcç±»å‹è½¬æ¢æˆJavaç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = </span><br><span class="line">  <span class="keyword">new</span> EnumMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•äº†Javaç±»å‹å‘æŒ‡å®šJdbcTypeè½¬æ¢æ—¶ï¼Œéœ€è¦ä½¿ç”¨çš„TypeHandlerå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚Javaç±»å‹ä¸­çš„Stringå¯èƒ½è½¬æ¢æˆæ•°æ®åº“çš„charã€varcharç­‰å¤šç§ç±»å‹ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = </span><br><span class="line">  <span class="keyword">new</span> ConcurrentHashMap&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•äº†å…¨éƒ¨TypeHandlerçš„ç±»å‹ä»¥åŠè¯¥ç±»å‹ç›¸åº”çš„TypeHandlerå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeHandler&lt;Object&gt; UNKNOWN_TYPE_HANDLER = </span><br><span class="line">  <span class="keyword">new</span> UnknownTypeHandler(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©ºTypeHandleré›†åˆçš„æ ‡è¯†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; ALL_TYPE_HANDLERS_MAP = </span><br><span class="line">  <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure><p><strong>1. æ³¨å†ŒTypeHandlerå¯¹è±¡</strong></p><p>TypeHandlerRegistry.register()æ–¹æ³•å® ç° äº†æ³¨å†Œ TypeHandlerå¯¹ è±¡çš„åŠŸèƒ½ï¼Œè¯¥ æ³¨å†Œ è¿‡ ç¨‹ä¼š å‘ä¸Š è¿°å››ä¸ª é›†åˆä¸­æ·»åŠ TypeHandlerå¯¹ è±¡ã€‚register()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡è½½ ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¦‚å›¾ ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/07/image-20200607231443963_Zd5zVS.png" alt="image-20200607231443963"></p><p>ä» ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤šæ•° register()æ–¹æ³•æœ€ç»ˆ ä¼š è°ƒ ç”¨é‡è½½(4) å®Œæˆæ³¨å†Œ åŠŸèƒ½ï¼Œå…ˆæ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ï¼Œå…¶ä¸‰ä¸ª å‚ æ•° åˆ†åˆ« æŒ‡å®šäº† TypeHandlerèƒ½å¤Ÿ å¤„ ç†çš„Javaç±» å‹ã€Jdbcç±» å‹ä»¥åŠ TypeHandlerå¯¹ è±¡ã€‚</p><p>é‡è½½(4)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (javaType != <span class="keyword">null</span>) &#123;<span class="comment">// æ£€æµ‹æ˜¯å¦æ˜ç¡®æŒ‡å®šäº†TypeHanlderèƒ½å¤Ÿå¤„ç†çš„Javaç±»å‹</span></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®šjavaç±»å‹åœ¨TYPE_HANDLER_MAPé›†åˆä¸­å¯¹åº”TypeHanlderé›†åˆ</span></span><br><span class="line">    Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; map = TYPE_HANDLER_MAP.get(javaType);</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span> || map == NULL_TYPE_HANDLER_MAP) &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºæ–°çš„TypeHandleré›†åˆï¼Œå¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­</span></span><br><span class="line">      map = <span class="keyword">new</span> HashMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;();</span><br><span class="line">      TYPE_HANDLER_MAP.put(javaType, map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†TypeHandlerå¯¹è±¡æ³¨å†Œåˆ°å¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­</span></span><br><span class="line">    map.put(jdbcType, handler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å‘ALL_TYPE_HANDLERS_MAPé›†åˆæ³¨å†ŒTypeHandlerç±»å‹å’Œå¯¹åº”çš„TypeHanlderå¯¹è±¡</span></span><br><span class="line">  ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨(1)ã€œ(3)è¿™ ä¸‰ä¸ª <code>register()</code>æ–¹æ³•é‡è½½ ä¸­ä¼š å° è¯• è¯» å–<code>TypeHandler</code>ç±» ä¸­å®šä¹‰ çš„<code>@MappedTypes</code> æ³¨è§£å’Œ<code>@MappedJdbcTypes</code>æ³¨è§£ï¼Œ<code>@MappedTypes</code>æ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ <code>TypeHandler</code>å® ç° ç±» èƒ½å¤Ÿ å¤„ ç† çš„Javaç±» å‹çš„é›†åˆï¼Œ<code>@MappedJdbcTypes</code>æ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ <code>TypeHandler</code>å® ç° ç±» èƒ½å¤Ÿ å¤„ ç†çš„JDBC ç±» å‹é›†åˆã€‚<code>register()</code>æ–¹æ³•çš„é‡è½½(1)ã€œ(3)çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p><p>é‡è½½(1)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Only handler type</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">  MappedTypes mappedTypes = typeHandlerClass.getAnnotation(MappedTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; javaTypeClass : mappedTypes.value()) &#123;</span><br><span class="line">      register(javaTypeClass, typeHandlerClass);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">    register(getInstance(<span class="keyword">null</span>, typeHandlerClass));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡è½½(2)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(TypeHandler&lt;T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">  MappedTypes mappedTypes = typeHandler.getClass().getAnnotation(MappedTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; handledType : mappedTypes.value()) &#123;</span><br><span class="line">      register(handledType, typeHandler);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// @since 3.1.0 - try to auto-discover the mapped type</span></span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound &amp;&amp; typeHandler <span class="keyword">instanceof</span> TypeReference) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      TypeReference&lt;T&gt; typeReference = (TypeReference&lt;T&gt;) typeHandler;</span><br><span class="line">      register(typeReference.getRawType(), typeHandler);</span><br><span class="line">      mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="comment">// maybe users define the TypeReference with a different type and are not assignable, so just ignore it</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">    register((Class&lt;T&gt;) <span class="keyword">null</span>, typeHandler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡è½½(3)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">  MappedJdbcTypes mappedJdbcTypes = typeHandler.getClass().getAnnotation(MappedJdbcTypes.class);</span><br><span class="line">  <span class="keyword">if</span> (mappedJdbcTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (JdbcType handledJdbcType : mappedJdbcTypes.value()) &#123;</span><br><span class="line">      register(javaType, handledJdbcType, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mappedJdbcTypes.includeNullJdbcType()) &#123;</span><br><span class="line">      register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Š è¿° å…¨ éƒ¨ çš„ <code>register()</code>æ–¹ æ³• é‡ è½½ éƒ½ æ˜¯ åœ¨ å‘ <code>TYPE_HANDLER_MAP</code>é›† åˆ å’Œ <code>ALL_TYPE_HANDLERS_MAP</code> é›†åˆæ³¨å†Œ <code>TypeHandler</code> å¯¹ è±¡ï¼Œè€Œé‡è½½(5)æ˜¯å‘ <code>JDBC_TYPE_HANDLER_MAP</code> é›†åˆæ³¨å†Œ <code>TypeHandler</code>å¯¹ è±¡ï¼Œå…¶å…·ä½“ å® ç° å¦‚ä¸‹:</p><p>é‡è½½(5)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">  JDBC_TYPE_HANDLER_MAP.put(jdbcType, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TypeHandlerRegistry</code>é™¤äº†æä¾›æ³¨å†Œ å• ä¸ª <code>TypeHandlerçš„register()</code>é‡è½½ ï¼Œè¿˜ å¯ä»¥æ‰« ææ•´ä¸ª åŒ…ä¸‹ çš„<code>TypeHandler</code>æ¥å£å® ç° ç±» ï¼Œå¹¶ å°† å®Œæˆè¿™ äº›<code>TypeHandler</code>å® ç° ç±» çš„æ³¨å†Œ ã€‚</p><p>é‡è½½(6)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">  ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">  <span class="comment">// æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„æ¥å£å®ç°ç±»</span></span><br><span class="line">  resolverUtil.find(<span class="keyword">new</span> ResolverUtil.IsA(TypeHandler.class), packageName);</span><br><span class="line">  Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; handlerSet = resolverUtil.getClasses();</span><br><span class="line">  <span class="keyword">for</span> (Class&lt;?&gt; type : handlerSet) &#123;</span><br><span class="line">    <span class="comment">//Ignore inner classes and interfaces (including package-info.java) and abstract classes</span></span><br><span class="line">    <span class="keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) &#123;</span><br><span class="line">      register(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. æŸ¥æ‰¾TypeHandler</strong></p><p><code>TypeHandlerRegistry</code>æä¾›äº†æŸ¥ æ‰¾ <code>TypeHandler</code>å¯¹ è±¡çš„åŠŸèƒ½ã€‚<code>TypeHandlerRegistry.getTypeHandler()</code>æ–¹æ³•å® ç° äº†ä» ä¸Šè¿°å››ä¸ª é›†åˆä¸­è· å–å¯¹ åº” <code>TypeHandler</code>å¯¹ è±¡çš„åŠŸèƒ½ã€‚TypeHandlerRegistry.getTypeHandler()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡ è½½ ä¹‹é—´ çš„å…³ ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/08/image-20200608163219733_jqTbhc.png" alt="image-20200608163219733"></p><p>ç» è¿‡ ä¸€ç³»åˆ—ç±» å‹è½¬ æ¢ ä¹‹åï¼Œ<code>TypeHandlerRegistry.getTypeHandler()</code>æ–¹æ³•çš„å¤šä¸ª é‡è½½ éƒ½ä¼š è°ƒ ç”¨ <code>TypeHandlerRegistry.getTypeHandle(Type, JdbcType)</code>è¿™ ä¸ª é‡è½½ æ–¹æ³•ï¼Œå®ƒ ä¼š æ ¹æ®æŒ‡å®šçš„ Java ç±» å‹å’Œ JdbcTypeç±» å‹æŸ¥ æ‰¾ ç›¸åº” çš„TypeHandlerå¯¹ è±¡ã€‚</p><h4 id="TypeAliasRegistry"><a href="#TypeAliasRegistry" class="headerlink" title="TypeAliasRegistry"></a>TypeAliasRegistry</h4><p>åœ¨ç¼– å†™ SQLè¯­ å¥æ—¶ ï¼Œä½¿ç”¨åˆ« åå¯ä»¥æ–¹ä¾¿ç†è§£ä»¥åŠç»´ æŠ¤ ï¼Œä¾‹å¦‚è¡¨åæˆ–åˆ—åå¾ˆ é•¿ æ—¶ ï¼Œæˆ‘ä»¬ ä¸€èˆ¬ ä¼š ä¸º å…¶è®¾ è®¡ æ˜“æ‡‚ æ˜“ç»´ æŠ¤ çš„åˆ« åã€‚MyBatiså°† SQLè¯­ å¥ä¸­åˆ« åçš„æ¦‚ å¿µè¿› è¡Œäº†å»¶ä¼¸å’Œæ‰© å±•ï¼ŒMyBatis å¯ä»¥ä¸º ä¸€ä¸ª ç±» æ·»åŠ ä¸€ä¸ª åˆ« åï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡ åˆ« åå¼•ç”¨è¯¥ ç±» ã€‚</p><p><code>MyBatis</code>é€šè¿‡ <code>TypeAliasRegistry</code>ç±» å®Œæˆåˆ« åæ³¨å†Œ å’Œç®¡ç†çš„åŠŸèƒ½ï¼Œ<code>TypeAliasRegistry</code>çš„ç»“ æ„ æ¯” è¾ƒ ç®€ å• ï¼Œå®ƒ é€šè¿‡ <code>TYPE_ALIASES</code>å­—æ®µ(<code>Map&lt;Stringï¼ŒClass&lt;?&gt;&gt;</code>ç±» å‹)ç®¡ç†åˆ« åä¸ Javaç±» å‹ä¹‹é—´ çš„å¯¹ åº” å…³ ç³»ï¼Œé€šè¿‡ <code>TypeAHasRegistiy.registerAlias()</code>æ–¹æ³•å®Œæˆæ³¨å†Œ åˆ« åï¼Œè¯¥ æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, Class&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (alias == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;The parameter alias cannot be null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†åˆ«åè½¬æ¢æˆå°å†™</span></span><br><span class="line">  String key = alias.toLowerCase(Locale.ENGLISH);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ£€æµ‹åˆ«åæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (TYPE_ALIASES.containsKey(key) </span><br><span class="line">      &amp;&amp; TYPE_ALIASES.get(key) != <span class="keyword">null</span> </span><br><span class="line">      &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  TYPE_ALIASES.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ <code>TypeAliasRegistry</code>çš„æ„ é€ æ–¹æ³•ä¸­ï¼Œé»˜è®¤ ä¸º Javaçš„åŸºæœ¬ç±» å‹åŠå…¶æ•° ç»„ ç±» å‹ã€åŸºæœ¬ç±» å‹çš„å° è£… ç±» åŠå…¶æ•°ç»„ç±»å‹ã€Dateã€BigDecimalã€Biglntegerã€Mapã€HashMapã€Listã€ArrayListã€Collectionã€ Iteratorã€ResultSetç­‰ç±» å‹æ·»åŠ äº†åˆ«åã€‚</p></blockquote><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºç¡€æ”¯æŒå±‚â€”â€”è§£æå™¨æ¨¡å—</title>
      <link href="/blog/2019/10/24/94150c5.html"/>
      <url>/blog/2019/10/24/94150c5.html</url>
      
        <content type="html"><![CDATA[<p>MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/21/2_c5SKkm.png" alt="æ•´ä½“æ¶æ„"></p><blockquote><p>è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„è§£æå™¨æ¨¡å—</p></blockquote><p><code>Mybatis</code>ä¸­æ¶‰åŠå¤§é‡çš„<code>XML</code>é…ç½®æ–‡ä»¶ï¼Œå¸¸è§çš„<code>XML</code>è§£ææ–¹å¼ï¼š<strong>DOMã€SAXå’ŒStAXã€‚</strong></p><h3 id="XPathç®€ä»‹"><a href="#XPathç®€ä»‹" class="headerlink" title="XPathç®€ä»‹"></a>XPathç®€ä»‹</h3><p><code>MyBatis</code>åœ¨åˆå§‹åŒ–è¿‡ ç¨‹ä¸­å¤„ ç†<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„æ–‡ä»¶æ—¶ ï¼Œä½¿ç”¨çš„æ˜¯<code>DOM</code> è§£ææ–¹å¼ï¼Œå¹¶ ç»“ åˆä½¿ç”¨<code>XPath</code>è§£æ<code>XML</code>é…ç½®æ–‡ä»¶ã€‚</p><p>æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼Œ<code>DOM</code>ä¼šå°†æ•´ä¸ª <code>XML</code>æ–‡æ¡£ åŠ è½½ åˆ°å†… å­˜ä¸­å¹¶ å½¢æˆæ ‘çŠ¶æ•°æ®ç»“æ„ ï¼Œè€Œ <code>XPath</code>æ˜¯ä¸€ç§ ä¸º æŸ¥ è¯¢ <code>XML</code>æ–‡æ¡£ è€Œè®¾ è®¡ çš„è¯­ è¨€ï¼Œå®ƒ å¯ä»¥ ä¸ <code>DOM</code>è§£ææ–¹å¼é…åˆä½¿ç”¨ï¼Œå® ç° å¯¹ <code>XML</code>æ–‡æ¡£ çš„è§£æã€‚</p><blockquote><p>Xpath ä¹‹äº XML å°±å¥½æ¯” SQL è¯­è¨€ä¹‹äºæ•°æ®åº“ã€‚</p></blockquote><h3 id="XPathParser"><a href="#XPathParser" class="headerlink" title="XPathParser"></a>XPathParser</h3><p><code>Mybatis</code> æä¾›çš„ <code>Xpathparser</code> ç±»å°è£…äº†<code>Xpath</code>ã€<code>Document</code> å’Œ<code> Entityresolver</code>ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/7_2t67aF.png" alt="7"></p><p><code>Xpathparser</code> ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å’ŒåŠŸèƒ½å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Document document; <span class="comment">// Document å¯¹è±¡ private boolean validation; //æ˜¯å¦å¼€å¯éªŒè¯</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Entityresolver entityresolver; <span class="comment">//ç”¨äºåŠ è½½æœ¬åœ° DTD æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Properties variables; <span class="comment">// mybatis- config. Xm1 ä¸­ã€Špropteriesã€‹æ ‡ç­¾å®šä¹‰çš„é”®å€¼å¯¹é›†åˆ </span></span><br><span class="line"><span class="keyword">private</span> Xpath xpath; <span class="comment">// Xpath å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹ <code>XML</code> æ–‡æ¡£è¿›è¡ŒéªŒè¯æ—¶ï¼Œä¼šæ ¹æ® <code>XML</code> æ–‡æ¡£å¼€å§‹ä½ç½®æŒ‡å®šçš„ç½‘å€åŠ è½½å¯¹åº”çš„ <code>DTD</code> æ–‡ä»¶æˆ– <code>XSD</code> æ–‡ä»¶ã€‚</p><p>å¦‚æœè§£æ <code>mybatis- config. Xml</code> é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤è”ç½‘åŠ è½½ <code>http: / mybatis. Org, / dtd/mybatis-3- config. Dtd</code> è¿™ä¸ª <code>DTD</code> æ–‡æ¡£ï¼Œå½“ç½‘ç»œæ¯”è¾ƒæ…¢æ—¶ä¼šå¯¼è‡´éªŒè¯è¿‡ç¨‹ç¼“æ…¢ã€‚</p><p>åœ¨å®è·µä¸­å¾€å¾€ä¼šæå‰è®¾ç½® <code>Entityresolver</code> æ¥å£å¯¹è±¡åŠ è½½æœ¬åœ°çš„ <code>DTD</code> æ–‡ä»¶ï¼Œä»è€Œé¿å…è”ç½‘åŠ è½½ <code>DTD</code> æ–‡ä»¶ã€‚</p><p><strong><code>Xmlmapperentity Resolver</code> æ˜¯ Mybatis æä¾›çš„ <code>Entity Resolver</code> æ¥å£çš„å®ç°ç±»ã€‚</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/06/8_sk1073.png" alt="8"></p><p><code>EntityResolver</code> æ¥å£çš„æ ¸å¿ƒæ˜¯ <code>resolveEntity()</code>æ–¹æ³•ï¼Œ<code>XMLMapperEntityResolver</code> çš„å® ç° å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMapperEntityResolver</span> <span class="keyword">implements</span> <span class="title">EntityResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IBATIS_CONFIG_SYSTEM = <span class="string">&quot;ibatis-3-config.dtd&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IBATIS_MAPPER_SYSTEM = <span class="string">&quot;ibatis-3-mapper.dtd&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MYBATIS_CONFIG_SYSTEM = <span class="string">&quot;mybatis-3-config.dtd&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MYBATIS_MAPPER_SYSTEM = <span class="string">&quot;mybatis-3-mapper.dtd&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MYBATIS_CONFIG_DTD </span><br><span class="line">    = <span class="string">&quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MYBATIS_MAPPER_DTD </span><br><span class="line">    = <span class="string">&quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span><span class="params">(String publicId, String systemId)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (systemId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String lowerCaseSystemId = systemId.toLowerCase(Locale.ENGLISH);</span><br><span class="line">        <span class="keyword">if</span> (lowerCaseSystemId.contains(MYBATIS_CONFIG_SYSTEM) </span><br><span class="line">            || lowerCaseSystemId.contains(IBATIS_CONFIG_SYSTEM)) &#123;</span><br><span class="line">          <span class="keyword">return</span> getInputSource(MYBATIS_CONFIG_DTD, publicId, systemId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCaseSystemId.contains(MYBATIS_MAPPER_SYSTEM) </span><br><span class="line">                   || lowerCaseSystemId.contains(IBATIS_MAPPER_SYSTEM)) &#123;</span><br><span class="line">          <span class="keyword">return</span> getInputSource(MYBATIS_MAPPER_DTD, publicId, systemId);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SAXException(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> InputSource <span class="title">getInputSource</span><span class="params">(String path, String publicId, String systemId)</span> </span>&#123;</span><br><span class="line">    InputSource source = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream in = Resources.getResourceAsStream(path);</span><br><span class="line">        source = <span class="keyword">new</span> InputSource(in);</span><br><span class="line">        source.setPublicId(publicId);</span><br><span class="line">        source.setSystemId(systemId);        </span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// ignore, null is ok</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°å¯¹ <code>XPathParser</code> çš„ åˆ† æ ï¼Œåœ¨ <code>XPathParser. createDocument()</code>æ–¹æ³•ä¸­å°è£… äº†å‰é¢ä»‹ç» çš„åˆ› å»º<code>Document</code>å¯¹ è±¡çš„è¿‡ ç¨‹å¹¶ è§¦ å‘ äº†åŠ è½½ <code>XML</code>æ–‡æ¡£ çš„ è¿‡ ç¨‹ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commonConstructor</span><span class="params">(<span class="keyword">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.validation = validation;</span><br><span class="line">  <span class="keyword">this</span>.entityResolver = entityResolver;</span><br><span class="line">  <span class="keyword">this</span>.variables = variables;</span><br><span class="line">  XPathFactory factory = XPathFactory.newInstance();</span><br><span class="line">  <span class="keyword">this</span>.xpath = factory.newXPath();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Document <span class="title">createDocument</span><span class="params">(InputSource inputSource)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// important: this must only be called AFTER common constructor</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    factory.setValidating(validation);</span><br><span class="line"></span><br><span class="line">    factory.setNamespaceAware(<span class="keyword">false</span>);</span><br><span class="line">    factory.setIgnoringComments(<span class="keyword">true</span>);</span><br><span class="line">    factory.setIgnoringElementContentWhitespace(<span class="keyword">false</span>);</span><br><span class="line">    factory.setCoalescing(<span class="keyword">false</span>);</span><br><span class="line">    factory.setExpandEntityReferences(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">    builder.setEntityResolver(entityResolver);</span><br><span class="line">    builder.setErrorHandler(<span class="keyword">new</span> ErrorHandler() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(SAXParseException exception)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fatalError</span><span class="params">(SAXParseException exception)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warning</span><span class="params">(SAXParseException exception)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> builder.parse(inputSource);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error creating document instance.  Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>Xpathparser</code> ä¸­æä¾›äº†ä¸€ç³»åˆ—çš„ <code>eval*0</code> æ–¹æ³•ç”¨äºè§£æ <code>boolean</code>ã€<code>shot</code>ã€<code>long</code>ã€<code>int</code>ã€<code>String</code>ã€<code>Node</code> ç­‰ç±»å‹çš„ä¿¡æ¯ï¼Œå®ƒé€šè¿‡è°ƒç”¨å‰é¢ä»‹ç»çš„ <code>Xpath. Evaluate()</code> æ–¹æ³•æŸ¥æ‰¾æŒ‡å®šè·¯å¾„çš„èŠ‚ç‚¹æˆ–å±æ€§ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„ç±»å‹è£…æ¢ã€‚å…·ä½“ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸è´´å‡ºæ¥äº†ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>Xpathparser. Evalstring()</code> æ–¹æ³•ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>Propertyparser. Parse()</code> æ–¹æ³•å¤„ç†èŠ‚ç‚¹ä¸­ç›¸åº”çš„é»˜è®¤å€¼ã€‚</p></li><li><p>åœ¨ <code>Propertyparser</code> ä¸­æŒ‡å®šäº†æ˜¯å¦å¼€å¯ä½¿ç”¨é»˜è®¤å€¼çš„åŠŸèƒ½ä»¥åŠé»˜è®¤çš„åˆ†éš”ç¬¦</p></li><li><p><code>PropertyParser.parse()</code> æ–¹æ³•ä¸­ä¼šåˆ›å»º <strong>Generic Tokenparser</strong> è§£æå™¨ï¼Œå¹¶å°†é»˜è®¤å€¼çš„å¤„ç†å§”æ‰˜ç»™Generic <code>Tokenparser.parse()</code>æ–¹æ³•ã€‚</p></li><li><p><strong>Generic Tokenparser</strong> æ˜¯ä¸€ä¸ªé€šç”¨çš„å­—å ä½ç¬¦è§£æå™¨ï¼Œå…¶å­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Private <span class="keyword">final</span> String opentoken; <span class="comment">//å ä½ç¬¦çš„å¼€å§‹æ ‡è®° </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String closetoken; <span class="comment">//å ä½ç¬¦çš„ç»“æ±æ ‡è®°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Tokenhandler handler; <span class="comment">// Tokenhandler æ¥å£çš„å®ç°ä¼šæŒ‰ç…§ä¸€å®šçš„é€»è¾‘è§£æå ä½ç¬¦</span></span><br></pre></td></tr></table></figure><p><code>GenericTokenparser.parse()</code> æ–¹æ³•çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå®ƒä¼šé¡ºåºæŸ¥æ‰¾ <code>openToken</code> å’Œ <code>closeToken</code>ï¼Œè§£æå¾—åˆ°å ä½ç¬¦çš„å­—é¢å€¼ï¼Œå¹¶å°†å…¶äº¤ç»™ <code>Tokenhandler</code> å¤„ç†ï¼Œç„¶åå°†è§£æç»“æœé‡æ–°æ‹¼è£…æˆå­—ç¬¦ä¸²å¹¶è¿”å›ã€‚</p></li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li><li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
            <tag> åŸºç¡€æ”¯æŒå±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyBatiså¿«é€Ÿå…¥é—¨</title>
      <link href="/blog/2019/10/21/3f93d624.html"/>
      <url>/blog/2019/10/21/3f93d624.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¿ƒè¡€æ¥æ½®ï¼Œæäº†æœ¬ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ï¼Œæ•´ç†ä¸€äº›æ ¸å¿ƒå†…å®¹</p></blockquote><p><strong>æ€ç»´å¯¼å›¾ï¼š</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/09/1_3tUMVN.png" alt="1"></p><p><strong>æ•´ä½“æ¶æ„ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/21/2_c5SKkm.png" alt="æ•´ä½“æ¶æ„"></p><h2 id="åŸºç¡€æ”¯æŒå±‚"><a href="#åŸºç¡€æ”¯æŒå±‚" class="headerlink" title="åŸºç¡€æ”¯æŒå±‚"></a>åŸºç¡€æ”¯æŒå±‚</h2><p>åŸºç¡€æ”¯æŒå±‚åŒ…å«æ•´ä¸ª <code>Mybatis</code> çš„åŸºç¡€æ¨¡å—ï¼Œè¿™äº›æ¨¡å—ä¸ºæ ¸å¿ƒå¤„ç†å±‚çš„åŠŸèƒ½æä¾›äº†è‰¯å¥½çš„æ”¯æ’‘ã€‚</p><h3 id="åå°„æ¨¡å—"><a href="#åå°„æ¨¡å—" class="headerlink" title="åå°„æ¨¡å—"></a>åå°„æ¨¡å—</h3><p><code>Java</code> ä¸­çš„åå°„è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†å¯¹å¤§å¤šæ•°å¼€å‘äººå‘˜æ¥è¯´ï¼Œå†™å‡ºé«˜è´¨é‡çš„åå°„ä»£ç è¿˜æ˜¯</p><p>æœ‰ä¸€å®šéš¾åº¦çš„ã€‚<code>Mybatis</code>  ä¸­ä¸“é—¨æä¾›äº†åå°„æ¨¡å—ï¼Œè¯¥æ¨¡å—å¯¹ <code>Java</code> åŸç”Ÿçš„åå°„è¿›è¡Œäº†è‰¯å¥½çš„å°è£…ï¼Œæä¾›äº†æ›´åŠ ç®€æ´æ˜“ç”¨çš„ APï¼Œæ–¹ä¾¿ä¸Šå±‚ä½¿è°ƒç”¨ï¼Œå¹¶ä¸”å¯¹åå°„æ“ä½œè¿›è¡Œäº†ç³»åˆ—ä¼˜åŒ–ï¼Œä¾‹å¦‚ç¼“å­˜äº†ç±»çš„å…ƒæ•°æ®ï¼Œæé«˜äº†åå°„æ“ä½œçš„æ€§èƒ½ã€‚</p><h3 id="ç±»å‹è½¬æ¢æ¨¡å—"><a href="#ç±»å‹è½¬æ¢æ¨¡å—" class="headerlink" title="ç±»å‹è½¬æ¢æ¨¡å—"></a>ç±»å‹è½¬æ¢æ¨¡å—</h3><p>æ­£å¦‚å‰é¢ç¤ºä¾‹æ‰€ç¤ºï¼Œ<code>Mybatis</code> ä¸ºç®€åŒ–é…ç½®æ–‡ä»¶æä¾›äº†åˆ«åæœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ˜¯ç±»å‹è½¬æ¢æ¨¡å—çš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ã€‚</p><p>ç±»å‹è½¬æ¢æ¨¡å—çš„å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯å®ç° <code>JDBC</code> ç±»å‹ä¸ <code>Java</code> ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè¯¥åŠŸèƒ½åœ¨ä¸º <code>SQL</code> è¯­å¥ç»‘å®šå®å‚ä»¥åŠæ˜ å°„æŸ¥è¯¢ç»“æœé›†æ—¶éƒ½ä¼šæ¶‰åŠã€‚åœ¨ä¸º <code>SQL</code> è¯­å¥ç»‘å®šå®å‚æ—¶ï¼Œä¼šå°†æ•°æ®ç”± <code>Java</code> ç±»å‹è½¬æ¢æˆ <code>JDBC</code> ç±»å‹ï¼›è€Œåœ¨æ˜ å°„ç»“æœé›†æ—¶ï¼Œä¼šå°†æ•°æ®ç”± <code>JDBC</code> ç±»å‹è½¬æ¢æˆ <code>Java</code> ç±»å‹ã€‚</p><p>###æ—¥å¿—æ¨¡å—</p><p>æ— è®ºåœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¿˜æ˜¯åœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„åœ°ä½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚è‰¯å¥½çš„æ—¥å¿—åŠŸèƒ½å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿå®šä½ <code>Bug</code> ä»£ç ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆç­‰é—®é¢˜ã€‚ç›®å‰çš„ <code>Java</code> ä¸–ç•Œä¸­å­˜åœ¨å¾ˆå¤šä¼˜ç§€çš„æ—¥å¿—æ¡†æ¶ï¼Œä¾‹å¦‚ <code>Log4j</code>ã€<code>Log4j2</code>ã€<code>slf4</code> ç­‰ã€‚<code>Mybatis</code> ä½œä¸ºä¸€ä¸ªè®¾è®¡ä¼˜è‰¯çš„æ¡†æ¶ï¼Œé™¤äº†æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¿¡æ¯ï¼Œè¿˜è¦èƒ½å¤Ÿé›†æˆå¤šç§æ—¥å¿—æ¡†æ¶ï¼Œå…¶æ—¥å¿—æ¨¡å—çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯é›†æˆç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶ã€‚èµ„æºåŠ è½½æ¨¡å—</p><p>èµ„æºåŠ è½½æ¨¡å—ä¸»è¦æ˜¯å¯¹ç±»åŠ è½½å™¨è¿›è¡Œå°è£…ï¼Œç¡®å®šç±»åŠ è½½å™¨çš„ä½¿ç”¨é¡ºåºï¼Œå¹¶æä¾›äº†åŠ è½½ç±»æ–‡ä»¶ä»¥åŠå…¶ä»–èµ„æºæ–‡ä»¶çš„åŠŸèƒ½ã€‚</p><h3 id="è§£æå™¨æ¨¡å—"><a href="#è§£æå™¨æ¨¡å—" class="headerlink" title="è§£æå™¨æ¨¡å—"></a>è§£æå™¨æ¨¡å—</h3><p>è§£æå™¨æ¨¡å—çš„ä¸»è¦æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼šä¸€ä¸ªåŠŸèƒ½æ˜¯å¯¹ Xpath è¿›è¡Œå°è£…ï¼Œä¸º <code>Mybatis</code> åˆå§‹åŒ–æ—¶è§£æ mybatis-config, xml é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æä¾›æ”¯æŒï¼›å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯ä¸ºå¤„ç†åŠ¨æ€ SQL è¯­å¥ä¸­çš„å ä½ç¬¦æä¾›æ”¯æŒã€‚æ•°æ®æºæ¨¡å—</p><p>æ•°æ®æºæ˜¯å®é™…å¼€å‘ä¸­å¸¸ç”¨çš„ç»„ä»¶ä¹‹ä¸€ã€‚ç°åœ¨å¼€æºçš„æ•°æ®æºéƒ½æä¾›äº†æ¯”è¾ƒä¸°å¯Œçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œè¿æ¥æ± åŠŸèƒ½ã€æ£€æµ‹è¿æ¥çŠ¶æ€ç­‰ï¼Œé€‰æ‹©æ€§èƒ½ä¼˜ç§€çš„æ•°æ®æºç»„ä»¶å¯¹äºæå‡ ORM æ¡†æ¶ä¹ƒè‡³æ•´ä¸ªåº”ç”¨çš„æ€§èƒ½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚Mybatis è‡ªèº«æä¾›äº†ç›¸åº”çš„æ•°æ®æºå®ç°ï¼Œå½“ç„¶ Mybatis ä¹Ÿæä¾›äº†ä¸ç¬¬ä¸‰æ–¹æ•°æ®æºé›†æˆçš„æ¥å£ï¼Œè¿™äº›åŠŸèƒ½éƒ½ä½äºæ•°æ®æºæ¨¡å—ä¹‹ä¸­ã€‚</p><h3 id="äº‹åŠ¡ç®¡ç†"><a href="#äº‹åŠ¡ç®¡ç†" class="headerlink" title="äº‹åŠ¡ç®¡ç†"></a>äº‹åŠ¡ç®¡ç†</h3><p>Mybatis å¯¹æ•°æ®åº“ä¸­çš„äº‹åŠ¡è¿›è¡Œäº†æŠ½è±¡ï¼Œå…¶è‡ªèº«æä¾›äº†ç›¸åº”çš„äº‹åŠ¡æ¥å£å’Œç®€å•å®ç°ã€‚åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼ŒMy Batis ä¼šä¸ Spring æ¡†æ¶é›†æˆï¼Œå¹¶ç”± Spring æ¡†æ¶ç®¡ç†äº‹åŠ¡ï¼Œåœ¨ç¬¬ 4 ç« ä¼šä»‹ç» Mybatis å¦‚ä½•ä¸ Spring é›†æˆå¼€å‘ï¼Œå…¶ä¸­å°±ä¼šæ¶‰åŠ Spring æ¡†æ¶ç®¡ç†äº‹åŠ¡ç›¸å…³çš„é…ç½®ã€‚</p><h3 id="ç¼“å­˜æ¨¡å—"><a href="#ç¼“å­˜æ¨¡å—" class="headerlink" title="ç¼“å­˜æ¨¡å—"></a>ç¼“å­˜æ¨¡å—</h3><p>åœ¨ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½æ—¶ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œè€Œæ·»åŠ ç¼“å­˜åˆ™æ˜¯ä¼˜åŒ–æ•°æ®åº“æ—¶æœ€æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ã€‚æ­£ç¡®ã€åˆç†åœ°ä½¿ç”¨ç¼“å­˜å¯ä»¥å°†ä¸€éƒ¨åˆ†æ•°æ®åº“è¯·æ±‚æ‹¦æˆªåœ¨ç¼“å­˜è¿™ä¸€å±‚ï¼Œè¿™å°±èƒ½å¤Ÿå‡å°‘ç›¸å½“ä¸€éƒ¨åˆ†æ•°æ®åº“çš„å‹åŠ›ã€‚</p><p>Mybatis ä¸­æä¾›äº†ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œè€Œè¿™ä¸¤çº§ç¼“å­˜éƒ½æ˜¯ä¾èµ–äºåŸºç¡€æ”¯æŒå±‚ä¸­çš„ç¼“å­˜æ¨¡å—å®ç°çš„ã€‚è¿™é‡Œéœ€è¦è¯»è€…æ³¨æ„çš„æ˜¯ï¼ŒMybatis ä¸­è‡ªå¸¦çš„è¿™ä¸¤çº§ç¼“å­˜ä¸ Mybatis ä»¥åŠæ•´ä¸ªåº”ç”¨æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ª JM ä¸­çš„ï¼Œå…±äº«åŒä¸€å—å †å†…å­˜ã€‚å¦‚æœè¿™ä¸¤çº§ç¼“å­˜ä¸­çš„æ•°æ®é‡è¾ƒå¤§ï¼Œåˆ™å¯èƒ½å½±å“ç³»ç»Ÿä¸­å…¶ä»–åŠŸèƒ½çš„è¿è¡Œï¼Œæ‰€ä»¥å½“éœ€è¦ç¼“å­˜å¤§é‡æ•°æ®æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ Redisã€Memcache ç­‰ç¼“å­˜äº§å“ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/10/3_aix99F.png" alt="ç¼“å­˜æ¨¡å—"></p><h3 id="Binding-æ¨¡å—"><a href="#Binding-æ¨¡å—" class="headerlink" title="Binding æ¨¡å—"></a>Binding æ¨¡å—</h3><p>é€šè¿‡å‰é¢çš„ç¤ºä¾‹æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è°ƒç”¨ Sqlsession ç›¸åº”æ–¹æ³•æ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œéœ€è¦æŒ‡å®šæ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„ SQL èŠ‚ç‚¹ï¼Œå¦‚æœå‡ºç°æ‹¼å†™é”™è¯¯ï¼Œæˆ‘ä»¬åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°ç›¸åº”çš„å¼‚å¸¸ã€‚ä¸ºäº†å°½æ—©å‘ç°è¿™ç§é”™è¯¯ï¼ŒMybatis é€šè¿‡ Binding æ¨¡å—å°†ç”¨æˆ·è‡ªå®šä¹‰çš„ Mapper 1 æ¥å£ä¸æ˜ å°„é…ç½®æ–‡ä»¶å…³è”èµ·æ¥ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡è°ƒç”¨è‡ªå®šä¹‰ Mapper æ¥å£ä¸­çš„æ–¹æ³•æ‰§è¡Œç›¸åº”çš„ SQL è¯­å¥å®Œæˆæ•°æ®åº“æ“ä½œï¼Œä»è€Œé¿å…ä¸Šè¿°é—®é¢˜ã€‚</p><p>å€¼å¾—è¯»è€…æ³¨æ„çš„æ˜¯ï¼Œå¼€å‘äººå‘˜æ— é¡»ç¼–å†™è‡ªå®šä¹‰ Mapper æ¥å£çš„å®ç°ï¼ŒMy Batis ä¼šè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚åœ¨æœ‰äº›åœºæ™¯ä¸­ï¼Œè‡ªå®šä¹‰ Mapper æ¥å£å¯ä»¥å®Œå…¨ä»£æ›¿æ˜ å°„é…ç½®æ–‡ä»¶ï¼Œä½†æœ‰çš„æ˜ å°„è§„åˆ™å’Œ SQL è¯­å¥çš„å®šä¹‰è¿˜æ˜¯å†™åœ¨æ˜ å°„é…ç½®æ–‡ä»¶ä¸­æ¯”è¾ƒæ–¹ä¾¿ï¼Œä¾‹å¦‚<strong>åŠ¨æ€ SQL è¯­å¥çš„å®šä¹‰</strong>ã€‚</p><h2 id="æ ¸å¿ƒå¤„ç†å±‚"><a href="#æ ¸å¿ƒå¤„ç†å±‚" class="headerlink" title="æ ¸å¿ƒå¤„ç†å±‚"></a>æ ¸å¿ƒå¤„ç†å±‚</h2><h3 id="é…ç½®è§£æ"><a href="#é…ç½®è§£æ" class="headerlink" title="é…ç½®è§£æ"></a>é…ç½®è§£æ</h3><p>åœ¨ Mybatis åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šåŠ è½½ mybatis-config. Xml é…ç½®æ–‡ä»¶ã€æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠ Mapper æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ï¼Œè§£æåçš„é…ç½®ä¿¡æ¯ä¼šå½¢æˆç›¸åº”çš„å¯¹è±¡å¹¶ä¿å­˜åˆ° Configuration å¯¹è±¡ä¸­ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­å®šä¹‰çš„~  &lt;resultmapã€‹èŠ‚ç‚¹ï¼ˆå³ Resultset I çš„æ˜ å°„è§„åˆ™ï¼‰ä¼šè¢«è§£ææˆ Resultmap å¯¹è±¡ï¼›ç¤ºä¾‹ä¸­å®šä¹‰çš„ã€Šresult èŠ‚ç‚¹ï¼ˆå³å±æ€§æ˜ å°„ï¼‰ä¼šè¢«è§£ææˆ Resultmapping å¯¹è±¡ã€‚ä¹‹åï¼Œåˆ©ç”¨è¯¥ Configuration å¯¹è±¡åˆ›å»º Sqlsessionfactory å¯¹è±¡ã€‚å¾… Mybatis åˆå§‹åŒ–ä¹‹åï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡åˆå§‹åŒ–å¾—åˆ° Sqlsessionfactory åˆ›å»º Sqlsession å¯¹è±¡å¹¶å®Œæˆæ•°æ®åº“æ“ä½œã€‚</p><h3 id="SQL-è§£æä¸-scripting-æ¨¡å—"><a href="#SQL-è§£æä¸-scripting-æ¨¡å—" class="headerlink" title="SQL è§£æä¸ scripting æ¨¡å—"></a>SQL è§£æä¸ scripting æ¨¡å—</h3><p>æ‹¼å‡‘ SQL è¯­å¥æ˜¯ä¸€ä»¶çƒ¦çä¸”æ˜“å‡ºé”™çš„è¿‡ç¨‹ï¼Œä¸ºäº†å°†å¼€å‘äººå‘˜ä»è¿™é¡¹æ¯ç‡¥æ— è¶£çš„å·¥ä½œä¸­è§£è„±å‡ºæ¥ï¼ŒMybatis å®ç°åŠ¨æ€ SQL è¯­å¥çš„åŠŸèƒ½ï¼Œæä¾›äº†å¤šç§åŠ¨æ€ SQL è¯­å¥å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œ<code>where</code>èŠ‚ç‚¹ã€<code>if</code>èŠ‚ç‚¹ã€<code>foreach</code>èŠ‚ç‚¹ç­‰ã€‚é€šè¿‡è¿™äº›èŠ‚ç‚¹çš„ç»„åˆä½¿ç”¨ï¼Œå¼€å‘äººå‘˜å¯ä»¥å†™å‡ºå‡ ä¹æ»¡è¶³æ‰€æœ‰éœ€æ±‚çš„åŠ¨æ€ SQL è¯­å¥ã€‚</p><p>Mybatis ä¸­çš„ scripting æ¨¡å—ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å®å‚ï¼Œè§£ææ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„åŠ¨æ€ SQL èŠ‚ç‚¹ï¼Œå¹¶å½¢æˆæ•°æ®åº“å¯æ‰§è¡Œçš„ SQL è¯­å¥ã€‚ä¹‹åä¼šå¤„ç† SQL è¯­å¥ä¸­çš„å ä½ç¬¦ï¼Œç»‘å®šç”¨æˆ·ä¼ å…¥çš„å®å‚ã€‚</p><h3 id="SQL-æ‰§è¡Œ"><a href="#SQL-æ‰§è¡Œ" class="headerlink" title="SQL æ‰§è¡Œ"></a>SQL æ‰§è¡Œ</h3><p>SQL è¯­å¥çš„æ‰§è¡Œæ¶‰åŠå¤šä¸ªç»„ä»¶ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ Executorã€Statementhandlerã€Parameterhandler å’Œ Resultsethandlerã€‚Executor ä¸»è¦è´Ÿè´£ç»´æŠ¤ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜å¹¶æä¾›äº‹åŠ¡ç®¡ç†çš„ç›¸å…³æ“ä½œï¼Œå®ƒä¼šå°†æ•°æ®åº“ç›¸å…³æ“ä½œå§”æ‰˜ç»™ Statementhandler å®Œæˆ Statementhandler é¦–å…ˆé€šè¿‡ Parameter Handler å®Œæˆ SQL è¯­å¥çš„å®å‚ç»‘å®šï¼Œç„¶åé€šè¿‡ iava, sql Statement å¯¹è±¡æ‰§è¡Œ <code>SQL</code> è¯­å¥å¹¶å¾—åˆ°ç»“æœé›†ï¼Œæœ€åé€šè¿‡ <code>Resultset Handler</code> å®Œæˆç»“æœé›†çš„æ˜ å°„ï¼Œå¾—åˆ°ç»“æœå¯¹è±¡å¹¶è¿”å›ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/10/4_SAR13A.png" alt="Mybatis æ‰§è¡Œä¸€æ¡ SQL è¯­å¥çš„å¤§è‡´è¿‡ç¨‹"></p><h3 id="æ’ä»¶"><a href="#æ’ä»¶" class="headerlink" title="æ’ä»¶"></a>æ’ä»¶</h3><p><code>Mybatis</code> è‡ªèº«çš„åŠŸèƒ½è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œç¾åˆ‡åˆæ‰€æœ‰çš„åº”ç”¨åœºæ™¯ï¼Œå› æ­¤ <code>Mybatis</code> æä¾›äº†æ’ä»¶æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶çš„æ–¹å¼å¯¹ <code>Mybatis</code> è¿›è¡Œæ‰©å±•ã€‚ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¹Ÿå¯ä»¥æ”¹å˜ <code>Mybatis</code> çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¦æˆª <code>SQL</code> è¯­å¥å¹¶å¯¹å…¶è¿›è¡Œé‡å†™ã€‚ç”±äºç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¼šå½±å“ <code>Mybatis</code> çš„æ ¸å¿ƒè¡Œä¸ºï¼Œåœ¨ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ä¹‹å‰ï¼Œå¼€å‘äººå‘˜éœ€è¦äº†è§£ <code>Mybatis</code> å†…éƒ¨çš„åŸç†ï¼Œè¿™æ ·æ‰èƒ½ç¼–å†™å‡ºå®‰å…¨ã€é«˜æ•ˆçš„æ’ä»¶</p><h2 id="æ¥å£å±‚"><a href="#æ¥å£å±‚" class="headerlink" title="æ¥å£å±‚"></a>æ¥å£å±‚</h2><p>æ¥å£å±‚ç›¸å¯¹ç®€å•ï¼Œå…¶æ ¸å¿ƒæ˜¯ <code>Sqlsession</code> æ¥å£ï¼Œè¯¥æ¥å£ä¸­å®šä¹‰äº† <code>Mybatis</code> æš´éœ²ç»™åº”ç”¨ç¨‹åºè°ƒç”¨çš„ <code>API</code>ï¼Œä¹Ÿå°±æ˜¯ä¸Šå±‚åº”ç”¨ä¸ <code>MyBatis</code> äº¤äº’çš„æ¡¥æ¢ã€‚æ¥å£å±‚åœ¨æ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨æ ¸å¿ƒå¤„ç†å±‚çš„ç›¸åº”æ¨¡å—æ¥å®Œæˆå…·ä½“çš„æ•°æ®åº“æ“ä½œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Swarm</title>
      <link href="/blog/2019/09/28/656e6847.html"/>
      <url>/blog/2019/09/28/656e6847.html</url>
      
        <content type="html"><![CDATA[<p> å®è·µä¸­ä¼šå‘ç°ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å•ä¸ª Docker èŠ‚ç‚¹æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæ­å»º Docker é›†ç¾¤åŠ¿åœ¨å¿…è¡Œã€‚ç„¶è€Œï¼Œé¢å¯¹ Kubernetes, Mesos ä»¥åŠ Swarm ç­‰ä¼—å¤šå®¹å™¨é›†ç¾¤ç³»ç»Ÿï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿå®ƒä»¬ä¹‹ä¸­ï¼ŒSwarm æ˜¯ Docker åŸç”Ÿçš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€ç®€å•ï¼Œæœ€æ˜“å­¦ï¼Œæœ€èŠ‚çœèµ„æºçš„ï¼Œæ¯”è¾ƒé€‚åˆä¸­å°å‹å…¬å¸ä½¿ç”¨ã€‚</p><h2 id="Docker-Swarm-ä»‹ç»"><a href="#Docker-Swarm-ä»‹ç»" class="headerlink" title="Docker Swarm ä»‹ç»"></a>Docker Swarm ä»‹ç»</h2><p>Swarm åœ¨ Docker 1.12 ç‰ˆæœ¬ä¹‹å‰å±äºä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œåœ¨ Docker 1.12 ç‰ˆæœ¬å‘å¸ƒä¹‹åï¼Œè¯¥é¡¹ç›®åˆå¹¶åˆ°äº† Docker ä¸­ï¼Œæˆä¸º Docker çš„ä¸€ä¸ªå­å‘½ä»¤ã€‚ç›®å‰ï¼ŒSwarm æ˜¯ Docker ç¤¾åŒºæä¾›çš„å”¯ä¸€ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker é›†ç¾¤ç®¡ç†çš„å·¥å…·ã€‚å®ƒå¯ä»¥æŠŠå¤šä¸ª Docker ä¸»æœºç»„æˆçš„ç³»ç»Ÿè½¬æ¢ä¸ºå•ä¸€çš„è™šæ‹Ÿ Docker ä¸»æœºï¼Œä½¿å¾—å®¹å™¨å¯ä»¥ç»„æˆè·¨ä¸»æœºçš„å­ç½‘ç½‘ç»œã€‚</p><p>Docker Swarm æ˜¯ä¸€ä¸ªä¸º IT è¿ç»´å›¢é˜Ÿæä¾›é›†ç¾¤å’Œè°ƒåº¦èƒ½åŠ›çš„ç¼–æ’å·¥å…·ã€‚ç”¨æˆ·å¯ä»¥æŠŠé›†ç¾¤ä¸­æ‰€æœ‰ Docker Engine æ•´åˆè¿›ä¸€ä¸ªã€Œè™šæ‹Ÿ Engineã€çš„èµ„æºæ± ï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤ä¸å•ä¸€çš„ä¸» Swarm è¿›è¡Œæ²Ÿé€šï¼Œè€Œä¸å¿…åˆ†åˆ«å’Œæ¯ä¸ª Docker Engine æ²Ÿé€šã€‚åœ¨çµæ´»çš„è°ƒåº¦ç­–ç•¥ä¸‹ï¼ŒIT å›¢é˜Ÿå¯ä»¥æ›´å¥½åœ°ç®¡ç†å¯ç”¨çš„ä¸»æœºèµ„æºï¼Œä¿è¯åº”ç”¨å®¹å™¨çš„é«˜æ•ˆè¿è¡Œã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/09/22.png" alt="Docker Swarm"></p><h2 id="Docker-Swarm-ä¼˜ç‚¹"><a href="#Docker-Swarm-ä¼˜ç‚¹" class="headerlink" title="Docker Swarm ä¼˜ç‚¹"></a>Docker Swarm ä¼˜ç‚¹</h2><h3 id="ä»»ä½•è§„æ¨¡éƒ½æœ‰é«˜æ€§èƒ½è¡¨ç°"><a href="#ä»»ä½•è§„æ¨¡éƒ½æœ‰é«˜æ€§èƒ½è¡¨ç°" class="headerlink" title="ä»»ä½•è§„æ¨¡éƒ½æœ‰é«˜æ€§èƒ½è¡¨ç°"></a>ä»»ä½•è§„æ¨¡éƒ½æœ‰é«˜æ€§èƒ½è¡¨ç°</h3><p>å¯¹äºä¼ä¸šçº§çš„ Docker Engine é›†ç¾¤å’Œå®¹å™¨è°ƒåº¦è€Œè¨€ï¼Œå¯æ‹“å±•æ€§æ˜¯å…³é”®ã€‚ä»»ä½•è§„æ¨¡çš„å…¬å¸â€”â€”ä¸è®ºæ˜¯æ‹¥æœ‰äº”ä¸ªè¿˜æ˜¯ä¸Šåƒä¸ªæœåŠ¡å™¨â€”â€”éƒ½èƒ½åœ¨å…¶ç¯å¢ƒä¸‹æœ‰æ•ˆä½¿ç”¨ Swarmã€‚ ç»è¿‡æµ‹è¯•ï¼ŒSwarm å¯æ‹“å±•æ€§çš„æé™æ˜¯åœ¨ 1000 ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ 50000 ä¸ªéƒ¨ç½²å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨çš„å¯åŠ¨æ—¶é—´ä¸ºäºšç§’çº§ï¼ŒåŒæ—¶æ€§èƒ½æ— å‡æŸã€‚</p><h3 id="çµæ´»çš„å®¹å™¨è°ƒåº¦"><a href="#çµæ´»çš„å®¹å™¨è°ƒåº¦" class="headerlink" title="çµæ´»çš„å®¹å™¨è°ƒåº¦"></a>çµæ´»çš„å®¹å™¨è°ƒåº¦</h3><p>Swarm å¸®åŠ© IT è¿ç»´å›¢é˜Ÿåœ¨æœ‰é™æ¡ä»¶ä¸‹å°†æ€§èƒ½è¡¨ç°å’Œèµ„æºåˆ©ç”¨æœ€ä¼˜åŒ–ã€‚Swarm çš„å†…ç½®è°ƒåº¦å™¨ï¼ˆschedulerï¼‰æ”¯æŒå¤šç§è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬ï¼šèŠ‚ç‚¹æ ‡ç­¾ï¼Œäº²å’Œæ€§å’Œå¤šç§å®¹å™¨éƒ¨ç­–ç•¥å¦‚ binpackã€spreadã€random ç­‰ç­‰ã€‚</p><h3 id="æœåŠ¡çš„æŒç»­å¯ç”¨æ€§"><a href="#æœåŠ¡çš„æŒç»­å¯ç”¨æ€§" class="headerlink" title="æœåŠ¡çš„æŒç»­å¯ç”¨æ€§"></a>æœåŠ¡çš„æŒç»­å¯ç”¨æ€§</h3><p>Docker Swarm ç”± Swarm Manager æä¾›é«˜å¯ç”¨æ€§ï¼Œé€šè¿‡åˆ›å»ºå¤šä¸ª Swarm master èŠ‚ç‚¹å’Œåˆ¶å®šä¸» master èŠ‚ç‚¹å®•æœºæ—¶çš„å¤‡é€‰ç­–ç•¥ã€‚å¦‚æœä¸€ä¸ª master èŠ‚ç‚¹å®•æœºï¼Œé‚£ä¹ˆä¸€ä¸ª slave èŠ‚ç‚¹å°±ä¼šè¢«å‡æ ¼ä¸º master èŠ‚ç‚¹ï¼Œç›´åˆ°åŸæ¥çš„ master èŠ‚ç‚¹æ¢å¤æ­£å¸¸ã€‚ æ­¤å¤–ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ï¼ŒSwarm ä¼šç»§ç»­å°è¯•åŠ å…¥ï¼Œå¹¶æä¾›é”™è¯¯è­¦æŠ¥å’Œæ—¥å¿—ã€‚åœ¨èŠ‚ç‚¹å‡ºé”™æ—¶ï¼ŒSwarm ç°åœ¨å¯ä»¥å°è¯•æŠŠå®¹å™¨é‡æ–°è°ƒåº¦åˆ°æ­£å¸¸çš„èŠ‚ç‚¹ä¸Šå»ã€‚</p><p><strong>å’Œ Docker API åŠæ•´åˆæ”¯æŒçš„å…¼å®¹æ€§</strong> Swarm å¯¹ Docker API å®Œå…¨æ”¯æŒï¼Œè¿™æ„å‘³ç€å®ƒèƒ½ä¸ºä½¿ç”¨ä¸åŒ Docker å·¥å…·ï¼ˆå¦‚ Docker CLIï¼ŒComposeï¼ŒTrusted Registryï¼ŒHub å’Œ UCPï¼‰çš„ç”¨æˆ·æä¾›æ— ç¼è¡”æ¥çš„ä½¿ç”¨ä½“éªŒã€‚</p><p><strong>Docker Swarm ä¸º Docker åŒ–åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆè¯¸å¦‚å¤šä¸»æœºç½‘ç»œå’Œå­˜å‚¨å·ç®¡ç†ï¼‰æä¾›åŸç”Ÿæ”¯æŒã€‚</strong>å¼€å‘çš„ Compose æ–‡ä»¶èƒ½ï¼ˆé€šè¿‡ docker-compose up ï¼‰è½»æ˜“åœ°éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨æˆ– Swarm é›†ç¾¤ä¸Šã€‚Docker Swarm è¿˜å¯ä»¥ä» Docker Trusted Registry æˆ– Hub é‡Œ pull å¹¶ run é•œåƒã€‚</p><p><strong>ç»¼ä¸Šæ‰€è¿°ï¼ŒDocker Swarm æä¾›äº†ä¸€å¥—é«˜å¯ç”¨ Docker é›†ç¾¤ç®¡ç†çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œå…¨æ”¯æŒæ ‡å‡†çš„ Docker APIï¼Œæ–¹ä¾¿ç®¡ç†è°ƒåº¦é›†ç¾¤ Docker å®¹å™¨ï¼Œåˆç†å……åˆ†åˆ©ç”¨é›†ç¾¤ä¸»æœºèµ„æº</strong>ã€‚</p><blockquote><p><strong>å¹¶éæ‰€æœ‰æœåŠ¡éƒ½åº”è¯¥éƒ¨ç½²åœ¨Swarmé›†ç¾¤å†…ã€‚æ•°æ®åº“ä»¥åŠå…¶å®ƒæœ‰çŠ¶æ€æœåŠ¡å°±ä¸é€‚åˆéƒ¨ç½²åœ¨Swarmé›†ç¾¤å†…ã€‚</strong></p></blockquote><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><h3 id="èŠ‚ç‚¹"><a href="#èŠ‚ç‚¹" class="headerlink" title="èŠ‚ç‚¹"></a>èŠ‚ç‚¹</h3><p>è¿è¡Œ Docker çš„ä¸»æœºå¯ä»¥ä¸»åŠ¨åˆå§‹åŒ–ä¸€ä¸ª Swarm é›†ç¾¤æˆ–è€…åŠ å…¥ä¸€ä¸ªå·²å­˜åœ¨çš„ Swarm é›†ç¾¤ï¼Œè¿™æ ·è¿™ä¸ªè¿è¡Œ Docker çš„ä¸»æœºå°±æˆä¸ºä¸€ä¸ª Swarm é›†ç¾¤çš„èŠ‚ç‚¹ (node) ã€‚èŠ‚ç‚¹åˆ†ä¸ºç®¡ç† (manager) èŠ‚ç‚¹å’Œå·¥ä½œ (worker) èŠ‚ç‚¹ã€‚</p><p>ç®¡ç†èŠ‚ç‚¹ç”¨äº Swarm é›†ç¾¤çš„ç®¡ç†ï¼Œdocker swarm å‘½ä»¤åŸºæœ¬åªèƒ½åœ¨ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œï¼ˆèŠ‚ç‚¹é€€å‡ºé›†ç¾¤å‘½ä»¤ docker swarm leave å¯ä»¥åœ¨å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œï¼‰ã€‚ä¸€ä¸ª Swarm é›†ç¾¤å¯ä»¥æœ‰å¤šä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä½†åªæœ‰ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹å¯ä»¥æˆä¸º leaderï¼Œleader é€šè¿‡ raft åè®®å®ç°ã€‚</p><p>å·¥ä½œèŠ‚ç‚¹æ˜¯ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹ï¼Œç®¡ç†èŠ‚ç‚¹å°†æœåŠ¡ (service) ä¸‹å‘è‡³å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œã€‚ç®¡ç†èŠ‚ç‚¹é»˜è®¤ä¹Ÿä½œä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®è®©æœåŠ¡åªè¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ã€‚ä¸‹å›¾å±•ç¤ºäº†é›†ç¾¤ä¸­ç®¡ç†èŠ‚ç‚¹ä¸å·¥ä½œèŠ‚ç‚¹çš„å…³ç³»ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/09/23.png" alt="èŠ‚ç‚¹"></p><h3 id="æœåŠ¡å’Œä»»åŠ¡"><a href="#æœåŠ¡å’Œä»»åŠ¡" class="headerlink" title="æœåŠ¡å’Œä»»åŠ¡"></a>æœåŠ¡å’Œä»»åŠ¡</h3><p>ä»»åŠ¡ ï¼ˆTaskï¼‰æ˜¯ Swarm ä¸­çš„æœ€å°çš„è°ƒåº¦å•ä½ï¼Œç›®å‰æ¥è¯´å°±æ˜¯ä¸€ä¸ªå•ä¸€çš„å®¹å™¨ã€‚ æœåŠ¡ ï¼ˆServicesï¼‰ æ˜¯æŒ‡ä¸€ç»„ä»»åŠ¡çš„é›†åˆï¼ŒæœåŠ¡å®šä¹‰äº†ä»»åŠ¡çš„å±æ€§ã€‚æœåŠ¡æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>replicated services æŒ‰ç…§ä¸€å®šè§„åˆ™åœ¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šä¸ªæ•°çš„ä»»åŠ¡ã€‚</li><li>global services æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä»»åŠ¡</li></ul><p>ä¸¤ç§æ¨¡å¼é€šè¿‡ docker service create çš„ â€“mode å‚æ•°æŒ‡å®šã€‚ä¸‹å›¾å±•ç¤ºäº†å®¹å™¨ã€ä»»åŠ¡ã€æœåŠ¡çš„å…³ç³»ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/09/24.png" alt="æœåŠ¡å’Œä»»åŠ¡"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><ul><li><p>è½¬è‡ªï¼š<a href="http://www.ityouknow.com/docker/2018/04/19/docker-swarm.html">Docker(å…­)ï¼šDocker ä¸‰å‰‘å®¢ä¹‹ Docker Swarm</a></p></li><li><p>å¯¹è¿™ä¸ªDocker Swarmè¿™éƒ¨åˆ†ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä¸»è¦æ˜¯æƒ³äº†è§£å…¶æ¦‚å¿µã€‚è½¬å‘è¿™ç¯‡æ–‡ç« å†…å®¹ä»¥å…ä»¥åæ‰¾ä¸åˆ°ã€‚</p></li><li><p>å®è·µä¹‹åå†åšè¡¥å……</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¾®æœåŠ¡ </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹ä»£ç†æ¨¡å¼</title>
      <link href="/blog/2019/04/02/ae152a83.html"/>
      <url>/blog/2019/04/02/ae152a83.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆä»£ç†ï¼‰</p></blockquote><p>ç”Ÿæ´»ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–å®ä¾‹ä¸èƒœæšä¸¾ï¼Œä½†å¯¹äºåšæŠ€æœ¯çš„æˆ‘ä»¬ï¼Œä»¥ç½‘ç»œä»£ç†ä¸¾ä¾‹ç›¸ä¿¡æ˜¯æœ€åˆé€‚ä¸è¿‡äº†ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/7.png" alt="ç½‘ç»œä»£ç†"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸Šç½‘å‰å¾—å»ç½‘ç»œæœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ç”³è¯·äº’è”ç½‘å®½å¸¦ä¸šåŠ¡ï¼Œäºæ˜¯é¡ºç†æˆç« å…‰çº¤å…¥æˆ·ï¼Œå¹¶æ‹¿åˆ°ä¸€ä¸ªè°ƒåˆ¶è§£è°ƒå™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¿—ç§°çš„â€œçŒ«â€ã€‚å¥½ï¼Œâ€œçŒ«â€å®ç°äº†äº’è”ç½‘è®¿é—®æ¥å£ï¼Œçœ‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Internet</span> </span>&#123;<span class="comment">//äº’è”ç½‘è®¿é—®æ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">(String url)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Modem</span> <span class="keyword">implements</span> <span class="title">Internet</span> </span>&#123;<span class="comment">//è°ƒåˆ¶è§£è°ƒå™¨</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">(String url)</span></span>&#123;<span class="comment">//å®ç°äº’è”ç½‘è®¿é—®æ¥å£</span></span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£åœ¨è®¿é—®ï¼š&quot;</span> + url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œä¸ºè°ƒåˆ¶è§£è°ƒå™¨ï¼Œä¸€å®šæœ‰ä¸Šç½‘åŠŸèƒ½äº†ï¼Œç”¨æˆ·çš„ç”µè„‘åªéœ€è¦ç”¨ç½‘çº¿è¿æ¥è¿™åªâ€œçŒ«â€ä¾¿æ¥å…¥äº’è”ç½‘äº†ã€‚å°±è¿™ä¹ˆç®€å•ä¹ˆï¼Ÿç„¶è€ŒæŸå¤©æˆ‘ä»¬å‘ç°å­©å­å­¦ä¹ æ—¶æ€»æ˜¯å·å·ä¸Šç½‘çœ‹ç”µå½±ç©æ¸¸æˆï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šå¯¹æŸäº›ç½‘ç«™è¿›è¡Œè¿‡æ»¤ï¼Œæ‹’ç»é»„èµŒæ¯’ä¾µå®³æœªæˆå¹´ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç»ˆç«¯ç”µè„‘ä¸çŒ«ä¹‹é—´åŠ ä¸€å±‚ä»£ç†ï¼Œç”¨äºè¿‡æ»¤æŸäº›ä¸è‰¯ç½‘ç«™ï¼Œæœ€ç»ˆæˆ‘ä»¬å†³å®šè´­ä¹°ä¸€æ¬¾æœ‰è¿‡æ»¤åŠŸèƒ½çš„è·¯ç”±å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterProxy</span> <span class="keyword">implements</span> <span class="title">Internet</span> </span>&#123;<span class="comment">//è·¯ç”±å™¨ä»£ç†ç±»</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Internet modem;<span class="comment">//æŒæœ‰è¢«ä»£ç†ç±»å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blackList = Arrays.asList(<span class="string">&quot;ç”µå½±&quot;</span>, <span class="string">&quot;æ¸¸æˆ&quot;</span>, <span class="string">&quot;éŸ³ä¹&quot;</span>, <span class="string">&quot;å°è¯´&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RouterProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.modem = <span class="keyword">new</span> Modem();<span class="comment">//å®ä¾‹åŒ–è¢«ä»£ç†ç±»</span></span><br><span class="line">        System.out.println(<span class="string">&quot;æ‹¨å·ä¸Šç½‘...è¿æ¥æˆåŠŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">(String url)</span> </span>&#123;<span class="comment">//åŒæ ·å®ç°äº’è”ç½‘è®¿é—®æ¥å£æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (String keyword : blackList) &#123;<span class="comment">//å¾ªç¯é»‘åå•</span></span><br><span class="line">            <span class="keyword">if</span> (url.contains(keyword)) &#123;<span class="comment">//æ˜¯å¦åŒ…å«é»‘åå•å­—çœ¼</span></span><br><span class="line">                System.out.println(<span class="string">&quot;ç¦æ­¢è®¿é—®ï¼š&quot;</span> + url);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        modem.access(url);<span class="comment">//æ­£å¸¸è®¿é—®äº’è”ç½‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹ï¼Œåœ¨è¿™é‡Œè·¯ç”±å™¨ä»£ç†ä¸»è¦å……å½“ä»£ç†çš„è§’è‰²ï¼Œå’Œä¹‹å‰çš„â€œçŒ«â€ä¸€æ ·ï¼Œå®ƒåŒæ ·å®ç°äº†äº’è”ç½‘æ¥å£ï¼Œçœ‹ä¼¼ä¹Ÿæ˜¯æœ‰ä¸Šç½‘åŠŸèƒ½çš„ï¼Œå…¶å®ä¸ç„¶ã€‚ç¬¬12è¡Œä»£ç å¯¹äºäº’è”ç½‘è®¿é—®åŠŸèƒ½çš„å®ç°ä¸€å¼€å§‹å°±åšäº†ä¸ªè¿‡æ»¤ï¼Œå¦‚æœåœ°å€ä¸­å¸¦æœ‰é»‘åå•ä¸­çš„æ•æ„Ÿå­—çœ¼åˆ™ç¦æ­¢è®¿é—®å¹¶ç›´æ¥é€€å‡ºï¼Œåä¹‹åˆ™äºç¬¬19è¡Œè°ƒç”¨â€œçŒ«â€çš„äº’è”ç½‘è®¿é—®æ–¹æ³•ï¼Œçœ‹åˆ°äº†å§ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨â€œçŒ«â€çš„ä¸Šç½‘åŠŸèƒ½ã€‚æ³¨æ„æ­¤å¤„ä¸ºäº†å¯¹â€œçŒ«â€è¿›è¡Œæ§åˆ¶ï¼Œä»£ç†ä¸“ä¸ºæ­¤è€Œç”Ÿï¼Œæˆ‘ä»¬ç›´æ¥äºç¬¬7è¡Œå®ä¾‹åŒ–å®ƒè€Œä¸æ˜¯éœ€è¦åˆ«äººæŠŠå®ƒæ³¨å…¥è¿›æ¥ã€‚å¥½äº†ï¼Œå­©å­ç°åœ¨æ¥ä¸Šç½‘äº†ï¼Œè¿«ä¸åŠå¾…è¿è¡Œä¹‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Internet proxy = <span class="keyword">new</span> RouterProxy();<span class="comment">//å®ä¾‹åŒ–çš„æ˜¯ä»£ç†</span></span><br><span class="line">        proxy.access(<span class="string">&quot;http://www.ç”µå½±.com&quot;</span>);</span><br><span class="line">        proxy.access(<span class="string">&quot;http://www.æ¸¸æˆ.com&quot;</span>);</span><br><span class="line">        proxy.access(<span class="string">&quot;ftp://www.å­¦ä¹ .com/java&quot;</span>);</span><br><span class="line">        proxy.access(<span class="string">&quot;http://www.å·¥ä½œ.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è¿è¡Œç»“æœ</span></span><br><span class="line"><span class="comment">            æ‹¨å·ä¸Šç½‘...è¿æ¥æˆåŠŸï¼</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼šhttp://www.ç”µå½±.com</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼šhttp://www.æ¸¸æˆ.com</span></span><br><span class="line"><span class="comment">            æ­£åœ¨è®¿é—®ï¼šftp://www.å­¦ä¹ .com/java</span></span><br><span class="line"><span class="comment">            æ­£åœ¨è®¿é—®ï¼šhttp://www.å·¥ä½œ.com</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬3è¡Œå¤„ï¼Œå­©å­å®ä¾‹åŒ–çš„ä¸å†æ˜¯â€œçŒ«â€ï¼Œè€Œæ˜¯è¢«å·æ¢æ¢æŸ±çš„æ›¿æ¢ä¸ºè·¯ç”±å™¨ä»£ç†äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å¤§å®¶ä¸Šç½‘éƒ½è¿æ¥è·¯ç”±å™¨äº†ï¼Œè€Œä¸æ˜¯ç›´æ¥å»è¿â€œçŒ«â€ï¼Œè¿™æ ·ä¸ä½†çœå»äº†æˆ‘ä»¬æ‹¨å·çš„éº»çƒ¦ï¼ˆè·¯ç”±å™¨å¸®åŠ©æ‹¨å·ï¼‰è€Œä¸”å­©å­å†ä¹Ÿè®¿é—®ä¸åˆ°ä¹±ä¸ƒå…«ç³Ÿçš„ç½‘ç«™äº†ã€‚è€Œè¿™ä¸ªä»£ç†è‡ªèº«å…¶å®å¹¶ä¸å…·å¤‡è®¿é—®äº’è”ç½‘çš„èƒ½åŠ›ï¼Œå®ƒåªæ˜¯ç®€å•çš„è°ƒç”¨â€œçŒ«â€ä¸Šç½‘åŠŸèƒ½ï¼Œå…¶å­˜åœ¨ç›®çš„åªæ˜¯ä¸ºäº†æ§åˆ¶å¯¹â€çŒ«â€œçš„äº’è”è®¿é—®ï¼Œå¯¹å…¶è¿›è¡Œä»£ç†è€Œå·²ã€‚</p><p><strong>ä»£ç†æ¨¡å¼æ›´å¼ºè°ƒçš„æ˜¯å¯¹è¢«ä»£ç†å¯¹è±¡çš„æ§åˆ¶ï¼Œè€Œä¸æ˜¯ä»…é™äºå»è£…é¥°ç›®æ ‡å¯¹è±¡å¹¶å¢å¼ºå…¶åŸæœ‰çš„åŠŸèƒ½ã€‚å°±åƒæ˜æ˜Ÿçš„ä¾‹å­ä¸€æ ·ï¼Œå¦‚æœé’±æ²¡ç»™å¤Ÿï¼ŒåˆåŒæœªè¾¾æˆï¼Œåˆ™ä¸è®©æ˜æ˜Ÿéšæ„ä½œç§€ã€‚</strong></p><p>ç›¸ä¿¡å¤§å®¶å·²ç»ç†è§£åœ°å¾ˆé€šé€äº†å§ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä»£ç†æ¨¡å¼äº†ã€‚å…¶å®è¿˜æœ‰ä¸€ç§å«åŠ¨æ€ä»£ç†ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶å®ä¾‹åŒ–è¿‡ç¨‹æ˜¯åœ¨è¿è¡Œæ—¶å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸éœ€è¦ä¸“é—¨é’ˆå¯¹æŸä¸ªæ¥å£å»å†™è¿™ä¹ˆä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œæ˜¯æ ¹æ®æ¥å£åŠ¨æ€ç”Ÿæˆã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬å…ˆå¿˜æ‰ä¹‹å‰çš„è·¯ç”±å™¨ä»£ç†ï¼Œå½“æˆ‘ä»¬å†…ç½‘ä¸­çš„ä¸Šç½‘è®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œè·¯ç”±å™¨çš„Lanå£å·²è¢«å æ»¡ä¸å¤Ÿç”¨äº†ï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šæ¢æˆäº¤æ¢æœºï¼Œçœ‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Intranet</span> </span>&#123;<span class="comment">//å±€åŸŸç½‘è®¿é—®æ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fileAccess</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä¿æŒç®€å•ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªäº¤æ¢æœºSwitchå®ç°äº†å±€åŸŸç½‘è®¿é—®æ¥å£Intranetï¼Œè¯·æ³¨æ„è¿™é‡Œä¸æ˜¯äº’è”ç½‘æ¥å£Internetã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Switch</span> <span class="keyword">implements</span> <span class="title">Intranet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fileAccess</span><span class="params">(String path)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¿é—®å†…ç½‘ï¼š&quot;</span> + path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿›è¡Œçš„æ˜¯å±€åŸŸç½‘æ–‡ä»¶è®¿é—®ï¼Œæ¯”å¦‚è¯´æ˜¯æ‹·è´å¦ä¸€å°å†…ç½‘æœºå™¨ä¸Šçš„å…±äº«æ–‡ä»¶ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³ä¿è¯ä¸ä¹‹å‰ä¸€æ ·çš„å…³é”®å­—è¿‡æ»¤æ§åˆ¶åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡æ˜¯ä»€ä¹ˆåœ°å€éƒ½è¦å…ˆé€šè¿‡è¿‡æ»¤ã€‚</p><p>åˆ°è¿™é‡Œè®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼ŒçŒ«å®ç°çš„æ˜¯äº’è”ç½‘è®¿é—®æ¥å£ï¼Œäº¤æ¢æœºå®ç°çš„æ˜¯å±€åŸŸç½‘è®¿é—®æ¥å£ï¼Œé‚£æˆ‘ä»¬çš„è¿‡æ»¤å™¨ä»£ç†ç±»åˆ°åº•è¯¥æ€ä¹ˆå†™ï¼Ÿæ˜¯å®ç°Internetæ¥å£å‘¢è¿˜æ˜¯å®ç°Intranetæ¥å£å‘¢ï¼Ÿè¦ä¹ˆä¸¤ä¸ªéƒ½å®ç°ï¼Ÿå†åŠ è¿›æ¥æ–°çš„ç±»æ¥å£åˆè¦ä¸åœåœ°æ”¹å®ç°ç±»å—ï¼Ÿè¿™æ˜¾ç„¶è¡Œä¸é€šï¼Œè¿‡æ»¤å™¨æ— éå°±æ˜¯ä¸€æ®µè¿‡æ»¤é€»è¾‘ä¸å¿…æ¥å›æ”¹åŠ¨ï¼Œè¿™è¿åäº†è®¾è®¡æ¨¡å¼å¼€é—­åŸåˆ™ã€‚åŠ¨æ€ä»£ç†åº”æ—¶è€Œç”Ÿï¼Œæˆ‘ä»¬æ¥çœ‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeywordFilter</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blackList = Arrays.asList(<span class="string">&quot;ç”µå½±&quot;</span>, <span class="string">&quot;æ¸¸æˆ&quot;</span>, <span class="string">&quot;éŸ³ä¹&quot;</span>, <span class="string">&quot;å°è¯´&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¢«ä»£ç†çš„çœŸå®å¯¹è±¡,çŒ«ã€äº¤æ¢æœºã€æˆ–æ˜¯åˆ«çš„ä»€ä¹ˆéƒ½æ˜¯ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Object origin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KeywordFilter</span><span class="params">(Object origin)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.origin = origin;<span class="comment">//æ³¨å…¥è¢«ä»£ç†å¯¹è±¡</span></span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">//è¦è¢«åˆ‡å…¥æ–¹æ³•é¢ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">        String arg = args[<span class="number">0</span>].toString();</span><br><span class="line">        <span class="keyword">for</span> (String keyword : blackList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arg.toString().contains(keyword)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ç¦æ­¢è®¿é—®ï¼š&quot;</span> + arg);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è°ƒç”¨çœŸå®çš„è¢«ä»£ç†å¯¹è±¡æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(origin, arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸ªå…³é”®å­—è¿‡æ»¤åŠŸèƒ½æˆ‘ä»¬ä¸å†å†™åˆ°ä»£ç†ç±»é‡Œé¢äº†ï¼Œè€Œæ˜¯å¦å¤–å†™ä¸ªç±»å¹¶å®ç°JDKåå°„åŒ…ä¸­æä¾›çš„InvocationHandleræ¥å£ï¼Œäºç¬¬9è¡Œæ³¨å…¥å³å°†è¢«ä»£ç†çš„å¯¹è±¡ï¼Œä¸ç®¡æ˜¯çŒ«è¿˜æ˜¯äº¤æ¢æœºä»€ä¹ˆçš„å®ƒæ€»å½’æ˜¯ä¸ªObjectï¼Œç„¶ååœ¨ç¬¬14è¡Œå®ç°è¿™ä¸ªinvokeè°ƒç”¨æ–¹æ³•ï¼Œä¹‹åç”Ÿæˆçš„åŠ¨æ€ä»£ç†å°†æ¥ä¼šè°ƒè¿›æ¥è·‘è¿™å—çš„é€»è¾‘ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬è¿™é‡Œä¾ç„¶ä¿æŒä¸å˜çš„é€»è¾‘ï¼Œåœ¨çœŸå®å¯¹è±¡æ–¹æ³•è¢«æ‰§è¡Œä¹‹å‰è¿è¡Œäº†è¿‡æ»¤é€»è¾‘åŠ ä»¥æ§åˆ¶ã€‚ç”±äºä¼ å…¥çš„å‚æ•°æ˜¯è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•methodï¼Œä»¥åŠä¸€å †å‚æ•°argsï¼Œæ‰€ä»¥æ³¨æ„è¿™é‡Œç¬¬24è¡Œæˆ‘ä»¬è¦ç”¨åå°„å»è°ƒç”¨è¢«ä»£ç†å¯¹è±¡originäº†ï¼Œæœ€åæ¥çœ‹æˆ‘ä»¬å¦‚ä½•è¿è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®¿é—®å¤–ç½‘ï¼ˆäº’è”ç½‘ï¼‰,ç”ŸæˆçŒ«ä»£ç†ã€‚</span></span><br><span class="line">        Internet internet = (Internet) Proxy.newProxyInstance(</span><br><span class="line">                Modem.class.getClassLoader(),</span><br><span class="line">                Modem.class.getInterfaces(), </span><br><span class="line">                <span class="keyword">new</span> KeywordFilter(<span class="keyword">new</span> Modem()));</span><br><span class="line">        internet.access(<span class="string">&quot;http://www.ç”µå½±.com&quot;</span>);</span><br><span class="line">        internet.access(<span class="string">&quot;http://www.æ¸¸æˆ.com&quot;</span>);</span><br><span class="line">        internet.access(<span class="string">&quot;http://www.å­¦ä¹ .com&quot;</span>);</span><br><span class="line">        internet.access(<span class="string">&quot;http://www.å·¥ä½œ.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®¿é—®å†…ç½‘ï¼ˆå±€åŸŸç½‘ï¼‰ï¼Œç”Ÿæˆäº¤æ¢æœºä»£ç†ã€‚</span></span><br><span class="line">        Intranet intranet = (Intranet) Proxy.newProxyInstance(</span><br><span class="line">                Switch.class.getClassLoader(),</span><br><span class="line">                Switch.class.getInterfaces(), </span><br><span class="line">                <span class="keyword">new</span> KeywordFilter(<span class="keyword">new</span> Switch()));</span><br><span class="line">        intranet.fileAccess(<span class="string">&quot;\\\\192.68.1.2\\å…±äº«\\ç”µå½±\\IronHuman.mp4&quot;</span>);</span><br><span class="line">        intranet.fileAccess(<span class="string">&quot;\\\\192.68.1.2\\å…±äº«\\æ¸¸æˆ\\Hero.exe&quot;</span>);</span><br><span class="line">        intranet.fileAccess(<span class="string">&quot;\\\\192.68.1.4\\shared\\Javaå­¦ä¹ èµ„æ–™.zip&quot;</span>);</span><br><span class="line">        intranet.fileAccess(<span class="string">&quot;\\\\192.68.1.6\\JavaçŸ¥éŸ³\\è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼.doc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼...</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼šhttp://www.ç”µå½±.com</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼šhttp://www.æ¸¸æˆ.com</span></span><br><span class="line"><span class="comment">            æ­£åœ¨è®¿é—®ï¼šhttp://www.å­¦ä¹ .com</span></span><br><span class="line"><span class="comment">            æ­£åœ¨è®¿é—®ï¼šhttp://www.å·¥ä½œ.com</span></span><br><span class="line"><span class="comment">            å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼...</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼š\\192.68.1.2\å…±äº«\ç”µå½±\IronHuman.mp4</span></span><br><span class="line"><span class="comment">            ç¦æ­¢è®¿é—®ï¼š\\192.68.1.2\å…±äº«\æ¸¸æˆ\Hero.exe</span></span><br><span class="line"><span class="comment">            è®¿é—®å†…ç½‘ï¼š\\192.68.1.4\shared\Javaå­¦ä¹ èµ„æ–™.zip</span></span><br><span class="line"><span class="comment">            è®¿é—®å†…ç½‘ï¼š\\192.68.1.6\JavaçŸ¥éŸ³\è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼.doc</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸ç®¡æ˜¯è®¿é—®äº’è”ç½‘è¿˜æ˜¯å±€åŸŸç½‘ï¼Œåªéœ€è¦åˆ†åˆ«ç”Ÿæˆç›¸åº”çš„ä»£ç†å¹¶è°ƒç”¨å³å¯ï¼Œç›¸åŒçš„è¿‡æ»¤å™¨é€»è¾‘è¢«æ‰§è¡Œäº†ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å†å†™ä»»ä½•çš„ä»£ç†ç±»äº†ï¼Œåªéœ€è¦å®ç°ä¸€æ¬¡InvocationHandlerå°±ä¸€åŠ³æ°¸é€¸äº†ï¼Œåœ¨è¿è¡Œæ—¶å»åŠ¨æ€åœ°ç”Ÿæˆä»£ç†ï¼Œè¾¾åˆ°å…¼å®¹ä»»ä½•æ¥å£çš„ç›®çš„ã€‚</p><p><em>å…¶å®åœ¨å¾ˆå¤šæ¡†æ¶ä¸­å¤§é‡åº”ç”¨åˆ°äº†åŠ¨æ€ä»£ç†æ¨¡å¼ï¼Œæ¯”å¦‚Springçš„é¢å‘åˆ‡é¢AOPï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½ä¸€ä¸ªåˆ‡é¢ç±»@Aspectï¼Œå£°æ˜å…¶åˆ‡å…¥ç‚¹@Pointcutï¼ˆè¢«ä»£ç†çš„å“ªäº›å¯¹è±¡çš„å“ªäº›æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„çŒ«å’Œäº¤æ¢æœºçš„accessä»¥åŠaccessFileï¼‰ï¼Œä»¥åŠè¢«åˆ‡å…¥çš„ä»£ç å—ï¼ˆè¦å¢åŠ ä¸Šå»çš„é€»è¾‘ï¼Œæ¯”å¦‚è¿™é‡Œçš„è¿‡æ»¤åŠŸèƒ½ä»£ç ï¼Œå¯åˆ†ä¸ºå‰ç½®æ‰§è¡Œ@Beforeï¼Œåç½®æ‰§è¡Œ@Afterï¼Œä»¥åŠå¼‚å¸¸å¤„ç†@AfterThrowingç­‰ï¼‰ï¼Œäºæ˜¯æ¡†æ¶è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä»£ç†å¹¶åˆ‡å…¥ç›®æ ‡æ‰§è¡Œã€‚</em>æ­£å¦‚ç»™æ¯ç»™æ–¹æ³•å‰ååŠ å…¥æ—¥å¿—çš„ä¾‹å­ï¼Œæˆ–è€…æ›´ç»å…¸çš„äº‹åŠ¡æ§åˆ¶çš„ä¾‹å­ï¼Œåœ¨æ‰€æœ‰ä¸šåŠ¡ä»£ç ä¹‹å‰å…ˆåˆ‡å…¥â€œäº‹åŠ¡å¼€å§‹â€ï¼Œæ‰§è¡Œè¿‡åå†åˆ‡å…¥â€œäº‹åŠ¡æäº¤â€ï¼Œå¦‚æœæŠ›å¼‚å¸¸è¢«æ•è·åˆ™æ‰§è¡Œâ€œäº‹åŠ¡å›æ»šâ€ï¼Œå¦‚æ­¤å°±ä¸å¿…è¦åœ¨æ¯ä¸ªä¸šåŠ¡ç±»ä¸­å»å†™è¿™äº›é‡å¤ä»£ç äº†ï¼Œä¸€åŠ³æ°¸é€¸ï¼Œå†—ä½™ä»£ç å¤§é‡å‡å°‘ï¼Œå¼€å‘æ•ˆç‡æƒŠäººæå‡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹äº«å…ƒæ¨¡å¼</title>
      <link href="/blog/2019/03/23/34d98dd9.html"/>
      <url>/blog/2019/03/23/34d98dd9.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆäº«å…ƒï¼‰</p></blockquote><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸ªå®ä¾‹ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦å¼€å‘ä¸€æ¬¾RPGæ¸¸æˆï¼Œæ¸¸æˆåœ°å›¾é€šå¸¸éå¸¸å¤§ï¼Œè€Œä¸”æœ‰å„ç§å„æ ·ï¼Œæœ‰è‰åœ°ã€æ²™æ¼ ã€è’åŸï¼Œæ°´è·¯ç­‰ç­‰ï¼Œåœ¨å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸‹åº”è¯¥æ€æ ·å»å»ºæ¨¡ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/6.png" alt="äº«å…ƒæ¨¡å¼"></p><p>å¯¹äºè¿™ç§åœ°å›¾ï¼Œæˆ‘ä»¬åŠ è½½ä¸€æ•´å¼ å›¾ç‰‡æ¥åšåœ°å›¾ï¼Ÿå¦‚æœåœ°å›¾å¤ªå¤§ï¼Œå›¾ç‰‡åŠ è½½ç›¸å½“å¡é¡¿å§ï¼Ÿè€Œä¸”å¤§ç‰‡åœ°å›¾ä¸Šå…¶å®éƒ½æ˜¯é‡å¤çš„å›¾ç‰‡ç´ æï¼Œæ•´å›¾åŠ è½½è®¾è®¡ä¹Ÿæœ‰å¤±çµæ´»æ€§ã€‚å†ä»”ç»†è§‚å¯Ÿä¸‹ï¼Œè¿™åœ°å›¾æ— éå°±æ˜¯å¾ˆå¤šå°å›¾ç‰‡ï¼ˆå…ƒï¼‰æ‹¼èµ·æ¥çš„å“¦ï¼Œè¿™ä¸å°±æ˜¯ç±»ä¼¼äºæˆ‘ä»¬è£…ä¿®æ—¶è´´é©¬èµ›å…‹å˜›ï¼Ÿ</p><p>ç®€å•çš„å®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬æœ‰ä¸ªç –å—ç±»ï¼ŒæŒæœ‰â€œå›¾ç‰‡â€ï¼Œâ€œä½ç½®â€ç­‰å±æ€§ä¿¡æ¯ï¼Œç„¶åå®ä¾‹åŒ–è¿™äº›ç –å—å†è°ƒç”¨å…¶â€œç»˜åˆ¶â€æ–¹æ³•æŠŠå›¾ç‰‡æ˜¾ç¤ºåœ¨åœ°å›¾æŸä½ç½®ä¸Šå³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String image;<span class="comment">//åœ°ç –æ‰€ç”¨çš„å›¾ç‰‡æè´¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x, y;<span class="comment">//åœ°ç –æ‰€åœ¨åæ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tile</span><span class="params">(String image, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = image;</span><br><span class="line">        System.out.print(<span class="string">&quot;ä»ç£ç›˜åŠ è½½[&quot;</span> + image + <span class="string">&quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åœ¨ä½ç½®[&quot;</span> + x + <span class="string">&quot;:&quot;</span> + y + <span class="string">&quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot;</span> + image + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œç¬¬3è¡Œçš„åœ°ç –æè´¨å›¾ç‰‡æˆ‘ä»¬ç”¨Stringæ¥æ¨¡æ‹Ÿä»£æ›¿ï¼Œç¬¬7è¡Œåˆå§‹åŒ–æ—¶æˆ‘ä»¬æŠŠå›¾ç‰‡åŠ è½½åˆ°å†…å­˜ï¼Œæ¯”å¦‚è¯´è¿™ä¸ªIOæ“ä½œè¦è€—è´¹åŠç§’æ—¶é—´ï¼Œå¥½äº†æˆ‘ä»¬å…ˆæµ‹è¯•ç»˜åˆ¶ç¬¬ä¸€è¡Œç –å—ï¼Œè¿è¡Œä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ä»¥ç»˜åˆ¶ç¬¬ä¸€è¡Œä¸ºä¾‹</span></span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;æ²³æµ&quot;</span>, <span class="number">10</span>, <span class="number">10</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;æ²³æµ&quot;</span>, <span class="number">10</span>, <span class="number">20</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;çŸ³è·¯&quot;</span>, <span class="number">10</span>, <span class="number">30</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;è‰åª&quot;</span>, <span class="number">10</span>, <span class="number">40</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;è‰åª&quot;</span>, <span class="number">10</span>, <span class="number">50</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;è‰åª&quot;</span>, <span class="number">10</span>, <span class="number">60</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;è‰åª&quot;</span>, <span class="number">10</span>, <span class="number">70</span>).draw();</span><br><span class="line">        <span class="keyword">new</span> Tile(<span class="string">&quot;è‰åª&quot;</span>, <span class="number">10</span>, <span class="number">80</span>).draw();</span><br><span class="line">        <span class="comment">/* è¿è¡Œç»“æœ</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:10]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:20]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[çŸ³è·¯]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:30]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[çŸ³è·¯]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:40]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:50]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:60]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:70]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:80]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ²¡æœ‰å‘ç°é—®é¢˜ï¼Ÿæ¯åŠ è½½ä¸€å¼ å›¾éƒ½è¦è€—è´¹æ‰åŠç§’é’Ÿï¼Œæ‰ç”»äº†8å¼ åœ°ç –å›¾å°±4ç§’é’Ÿæµé€äº†ï¼Œå¦‚æœæ„å»ºæ•´å¼ åœ°å›¾å¾—å¤šå°‘æ—¶é—´ï¼Ÿè¿™å°±åƒæ˜¯åœ¨æ…¢æ€§è‡ªæ€ï¼Œå¦‚æ­¤æ•ˆç‡ä¸¥é‡å½±å“äº†æ¸¸æˆçš„ç”¨æˆ·ä½“éªŒï¼Œå…‰å¡é¡¿åœ¨åœ°å›¾åŠ è½½è¿™ç»™æ¼«é•¿çš„è¿‡ç¨‹å°±å·²ç»è®©ç©å®¶å¤±å»å…´è¶£äº†ã€‚</p><p>è¿™ä¸ªåœºæ™¯å¾ˆå®¹æ˜“æƒ³åˆ°ç”¨<strong>åŸå‹æ¨¡å¼</strong>æ¥å®ç°ï¼Œ<strong>æŠŠç›¸åŒçš„å›¾å…±äº«å‡ºæ¥ï¼Œç”¨å…‹éš†çš„æ–¹å¼ä»£æ›¿ç‰©ä»¶å›¾å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä»è€ŒåŠ å¿«åˆå§‹åŒ–é€Ÿåº¦ã€‚</strong>å…±äº«å…ƒè²Œä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œé€Ÿåº¦ä¹ŸåŠ å¿«äº†ï¼Œä½†å¯¹è±¡æ•°é‡è²Œä¼¼è¿˜æ˜¯ä¸ªä¸¥é‡é—®é¢˜ï¼Œæ¯ä¸€ä¸ªå°ç‰©ä»¶å›¾éƒ½è¦å¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¹ˆä¸ªå°æ¸¸æˆç”¨å¾—ç€é‚£ä¹ˆå¤§çš„å†…å­˜å¼€é”€ä¹ˆï¼Œæä¸å¥½ç”šè‡³ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œæ‰€ä»¥ï¼Œè®¾è®¡æ¨¡å¼ä¸€å®šè¿˜æ˜¯æœ‰é—®é¢˜ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="å‡è£…æœ‰å›¾"></p><p>æ²¿ç€å…±äº«çš„æ€è·¯æˆ‘ä»¬å†çœ‹ä¸‹åˆ°åº•éœ€ä¸éœ€è¦è¿™ä¹ˆå¤šå¯¹è±¡ï¼Ÿè¿™äº›å¯¹è±¡ä¸åŒçš„åœ°æ–¹åœ¨äºå…¶åæ ‡çš„ä¸åŒï¼Œå†å°±æ˜¯æè´¨çš„ä¸åŒï¼Œä¹Ÿå°±æ˜¯å›¾çš„ä¸åŒäº†ï¼Œèƒ½ä¸èƒ½ä»è¿™äº›å¯¹è±¡é‡ŒæŠ½å–å‡ºæ¥ä¸€äº›å…±åŒç‚¹å‘¢ï¼Ÿé¦–å…ˆæ¯ä¸ªå›¾çš„åæ ‡éƒ½ä¸ä¸€æ ·ï¼Œæ˜¯æ²¡åŠæ³•å…±äº«çš„ï¼Œä½†æ˜¯æè´¨å›¾æ˜¯é‡å¤å‡ºç°çš„ï¼Œæ˜¯å¯ä»¥å…±äº«çš„ï¼ŒåŒæ ·çš„æè´¨å›¾ä¼šåœ¨ä¸åŒçš„åæ ‡ä½ç½®ä¸Šé‡å¤å‡ºç°ï¼Œé‚£ä¹ˆè¿™ä¸ªæè´¨å›¾æ˜¯å¯ä»¥åšæˆå…±äº«å…ƒçš„ã€‚</p><p>æ—¢ç„¶åæ ‡ä¸èƒ½å…±äº«ï¼Œé‚£å°±ä¸åšä¸ºæè´¨ç±»çš„å…±äº«å…ƒå±æ€§ï¼Œç”±å®¢æˆ·ç«¯ç»´æŠ¤è¿™äº›åæ ‡å¹¶ä½œä¸ºå‚æ•°ä¼ å…¥å¥½äº†ï¼Œè€Œä¸”è¿™äº›æè´¨éƒ½æœ‰ç»˜åˆ¶èƒ½åŠ›ï¼Œé‚£å°±å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£å§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;<span class="comment">//ç»˜åˆ¶æ–¹æ³•ï¼Œæ¥æ”¶åœ°å›¾åæ ‡ã€‚</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç”¨æŠ½è±¡ç±»æŠ½å‡ºæ›´å¤šçš„å±æ€§å’Œæ–¹æ³•ä»£æ›¿æ¥å£ï¼Œä½¿å­ç±»å˜å¾—ç®€å•ï¼Œè¿™é‡Œä¸ºäº†æ¸…æ™°è¯´æ˜é—®é¢˜å°±ç”¨æ¥å£ã€‚æ¥ä¸‹æ¥æ˜¯æè´¨ç±»ä»¬ï¼Œç»Ÿç»Ÿå®ç°è¿™ä¸ªç»˜åˆ¶æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Water</span> <span class="keyword">implements</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String image;<span class="comment">//æ²³æµå›¾ç‰‡æè´¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Water</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = <span class="string">&quot;æ²³æµ&quot;</span>;</span><br><span class="line">        System.out.print(<span class="string">&quot;ä»ç£ç›˜åŠ è½½[&quot;</span> + image + <span class="string">&quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åœ¨ä½ç½®[&quot;</span> + x + <span class="string">&quot;:&quot;</span> + y + <span class="string">&quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot;</span> + image + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ç¬¬6è¡Œå› ä¸ºæ˜¯æ²³æµæè´¨ç±»ï¼Œæ‰€ä»¥åˆå§‹åŒ–æˆ‘ä»¬ç›´æ¥åŠ è½½æ²³æµå›¾ç‰‡ç´ æï¼Œè¿™å°±æ˜¯ç±»å†…éƒ¨å³å°†åšå…±äº«çš„â€œå…ƒâ€æ•°æ®äº†ï¼Œä¹Ÿå«åšâ€œå†…è•´çŠ¶æ€â€ï¼Œè‡³äºâ€œå¤–è•´çŠ¶æ€â€å°±æ˜¯åæ ‡äº†ï¼Œåªä½œä¸ºå‚æ•°ä»å¤–éƒ¨ä¼ å…¥ä¸åšå…±äº«ã€‚æ¥ä¸‹æ¥æ˜¯è‰åœ°ã€çŸ³å­è·¯ç­‰ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Grass</span> <span class="keyword">implements</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String image;<span class="comment">//è‰åªå›¾ç‰‡æè´¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Grass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = <span class="string">&quot;è‰åª&quot;</span>;</span><br><span class="line">        System.out.print(<span class="string">&quot;ä»ç£ç›˜åŠ è½½[&quot;</span> + image + <span class="string">&quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åœ¨ä½ç½®[&quot;</span> + x + <span class="string">&quot;:&quot;</span> + y + <span class="string">&quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot;</span> + image + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stone</span> <span class="keyword">implements</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String image;<span class="comment">//çŸ³è·¯å›¾ç‰‡æè´¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = <span class="string">&quot;çŸ³è·¯&quot;</span>;</span><br><span class="line">        System.out.print(<span class="string">&quot;ä»ç£ç›˜åŠ è½½[&quot;</span> + image + <span class="string">&quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åœ¨ä½ç½®[&quot;</span> + x + <span class="string">&quot;:&quot;</span> + y + <span class="string">&quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot;</span> + image + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">House</span> <span class="keyword">implements</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String image;<span class="comment">//æˆ¿å­å›¾ç‰‡æè´¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">House</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = <span class="string">&quot;æˆ¿å­&quot;</span>;</span><br><span class="line">        System.out.print(<span class="string">&quot;ä»ç£ç›˜åŠ è½½[&quot;</span> + image + <span class="string">&quot;]å›¾ç‰‡ï¼Œè€—æ—¶ä¸€ç§’ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å°†å›¾å±‚åˆ‡åˆ°æœ€ä¸Šå±‚ã€‚ã€‚ã€‚&quot;</span>);<span class="comment">//æˆ¿å­ç›–åœ¨åœ°ä¸Šï¼Œæ‰€ä»¥åˆ‡æ¢åˆ°é¡¶å±‚å›¾å±‚ã€‚</span></span><br><span class="line">        System.out.println(<span class="string">&quot;åœ¨ä½ç½®[&quot;</span> + x + <span class="string">&quot;:&quot;</span> + y + <span class="string">&quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot;</span> + image + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢è¿™ä¸ªçš„æˆ¿å­ç±»æœ‰æ‰€ä¸åŒï¼Œå®ƒæœ‰è‡ªå·±ç‰¹æœ‰çš„ç»˜åˆ¶è¡Œä¸ºæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨åœ°æ¿å›¾å±‚ä¹‹ä¸Šç»˜åˆ¶æˆ¿å­ï¼Œè¦†ç›–æ‰ä¸‹é¢çš„åœ°æ¿ï¼Œä½¿å…¶å˜å¾—æ›´åŠ ç«‹ä½“ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<strong>æˆ‘ä»¬éè¦ç”¨æ¥å£æˆ–æŠ½è±¡ç±»æ¥åšå¼•ç”¨ï¼Œä½¿å®ç°ç±»å¯ä»¥æœ‰è‡ªå·±ç‹¬ç‰¹çš„è¡Œä¸ºæ–¹å¼ï¼Œå¤šæ€çš„å¥½å¤„ç«‹ç«¿è§å½±ã€‚</strong>æ¥ä¸‹æ¥å°±æ˜¯å®ç°â€œå…ƒä¹‹å…±äº«â€çš„å…³é”®äº†ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•å·¥å‚ç±»ï¼Œçœ‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;<span class="comment">//å›¾ä»¶å·¥å‚</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Drawable&gt; images;<span class="comment">//å›¾åº“</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Factory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        images = <span class="keyword">new</span> HashMap&lt;String, Drawable&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Drawable <span class="title">getDrawable</span><span class="params">(String image)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ç¼“å­˜é‡Œå¦‚æœæ²¡æœ‰å›¾ä»¶ï¼Œåˆ™å®ä¾‹åŒ–å¹¶æ”¾å…¥ç¼“å­˜ã€‚</span></span><br><span class="line">        <span class="keyword">if</span>(!images.containsKey(image))&#123;</span><br><span class="line">            <span class="keyword">switch</span> (image) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;æ²³æµ&quot;</span>:</span><br><span class="line">                images.put(image, <span class="keyword">new</span> Water());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;è‰åª&quot;</span>:</span><br><span class="line">                images.put(image, <span class="keyword">new</span> Grass());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;çŸ³è·¯&quot;</span>:</span><br><span class="line">                images.put(image, <span class="keyword">new</span> Stone());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç¼“å­˜é‡Œå¿…ç„¶æœ‰å›¾ï¼Œç›´æ¥å–å¾—å¹¶è¿”å›ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> images.get(image);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå›¾ä»¶å·¥å‚ç»´æŠ¤ç€æ‰€æœ‰å…ƒå¯¹è±¡çš„å›¾åº“ï¼Œæ„é€ æ–¹æ³•äºç¬¬5è¡Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå“ˆå¸Œå›¾çš„ç¼“å­˜â€æ± â€œï¼Œå½“å®¢æˆ·ç«¯äºç¬¬8è¡Œéœ€è¦å®ä¾‹åŒ–å›¾ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆè§‚å¯Ÿè¿™ä¸ªå›¾åº“æ± é‡Œå­˜åœ¨ä¸å­˜åœ¨å·²å®ä¾‹åŒ–è¿‡çš„å›¾ä»¶ï¼Œä¹Ÿå°±æ˜¯çœ‹æœ‰æ— å·²åšå…±äº«çš„å›¾å…ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™å®ä¾‹åŒ–å¹¶åŠ å…¥å›¾åº“å…±äº«æ± ä¾›ä¸‹æ¬¡ä½¿ç”¨ï¼Œè¿™ä¾¿æ˜¯â€å…ƒä¹‹å…±äº«â€œçš„ç§˜å¯†äº†ã€‚å·§å¤ºå¤©å·¥çš„è®¾è®¡ä¸€æ°”å‘µæˆï¼Œå·²ç»è¿«ä¸åŠå¾…å»è¿è¡Œäº†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å…ˆå®ä¾‹åŒ–å›¾ä»¶å·¥å‚</span></span><br><span class="line">        Factory factory = <span class="keyword">new</span> Factory();</span><br><span class="line">        <span class="comment">//ä»¥ç¬¬ä¸€è¡Œä¸ºä¾‹</span></span><br><span class="line">        factory.getDrawable(<span class="string">&quot;æ²³æµ&quot;</span>).draw(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;æ²³æµ&quot;</span>).draw(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;çŸ³è·¯&quot;</span>).draw(<span class="number">10</span>, <span class="number">30</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;è‰åª&quot;</span>).draw(<span class="number">10</span>, <span class="number">40</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;è‰åª&quot;</span>).draw(<span class="number">10</span>, <span class="number">50</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;è‰åª&quot;</span>).draw(<span class="number">10</span>, <span class="number">60</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;è‰åª&quot;</span>).draw(<span class="number">10</span>, <span class="number">70</span>);</span><br><span class="line">        factory.getDrawable(<span class="string">&quot;è‰åª&quot;</span>).draw(<span class="number">10</span>, <span class="number">80</span>);</span><br><span class="line">        <span class="comment">/*è¿è¡Œç»“æœ</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:10]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ]</span></span><br><span class="line"><span class="comment">        åœ¨ä½ç½®[10:20]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[çŸ³è·¯]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:30]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[çŸ³è·¯]</span></span><br><span class="line"><span class="comment">        ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:40]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        åœ¨ä½ç½®[10:50]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        åœ¨ä½ç½®[10:60]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        åœ¨ä½ç½®[10:70]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        åœ¨ä½ç½®[10:80]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æŠ›å¼ƒäº†åˆ©ç”¨newå…³é”®å­—è‚†æ„å¦„ä¸ºåœ°åˆ¶é€ å¯¹è±¡ï¼Œè€Œæ˜¯æ”¹ç”¨è¿™ä¸ªå›¾ä»¶å·¥å‚å»å¸®æˆ‘ä»¬æŠŠå…ƒæ„å»ºå¹¶å…±äº«èµ·æ¥ã€‚æ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿è¡Œç»“æœä¸­æ¯æ¬¡å®ä¾‹åŒ–å¯¹è±¡ä¼šè€—è´¹åŠç§’æ—¶é—´ï¼Œå†æ¬¡è¯·æ±‚å¯¹è±¡æ—¶å°±ä¸å†ä¼šåŠ è½½å›¾ç‰‡è€—è´¹æ—¶é—´äº†ï¼Œä¹Ÿå°±æ˜¯ä»å…±äº«å›¾æ± ç›´æ¥æ‹¿åˆ°äº†ï¼Œä¸å†é€ æ¬¡ã€‚æ›´å¦™çš„æ˜¯ï¼Œå¦‚æœç”»å®Œæ•´ä¸ªåœ°å›¾åªéœ€è¦å®ä¾‹åŒ–éœ€è¦ç”¨åˆ°çš„æŸäº›å…ƒç´ æè€Œå·²ï¼Œå³ä½¿æ˜¯é‚£ä¸ªå¤§æˆ¿å­å›¾ä»¶ä¹Ÿåªéœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡å°±å¤Ÿäº†ã€‚è‡³æ­¤ï¼ŒCPUé€Ÿåº¦ï¼Œå†…å­˜è½»é‡åŒ–åŒæ—¶åšåˆ°äº†ä¼˜åŒ–ï¼Œæ•´ä¸ªæ¸¸æˆç”¨æˆ·ä½“éªŒå¾—åˆ°äº†æå¤§çš„æå‡ã€‚</p><p>äº«å…ƒçš„ç²¾é«“å½“ç„¶é‡ç‚¹ä¸æ­¢äºâ€äº«â€œï¼Œæ›´é‡è¦çš„æ˜¯å¯¹äºå…ƒçš„è¾¨è¯†ï¼Œä¾‹å¦‚é‚£ä¸ªä»å¤–éƒ¨å®¢æˆ·ç«¯ä¼ å…¥çš„åæ ‡å‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬ä¾ç„¶æŠŠåæ ‡ä¹Ÿå½“ä½œå…±äº«å¯¹è±¡å…ƒæ•°æ®ï¼ˆå†…è•´çŠ¶æ€ï¼‰çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„å°†æ— å…ƒå¯äº«ï¼Œå¤§é‡çš„å¯¹è±¡å°±å¦‚åŒä¸–ç•Œä¸Šæ²¡æœ‰ç›¸åŒçš„ä¸¤ç‰‡æ ‘å¶ä¸€æ ·å¤šä¸èƒœæ•°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´å›¾åº“æ± è¢«æ’‘çˆ†ï¼Œäº«å…ƒå°†å˜å¾—æ¯«æ— æ„ä¹‰ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ•´ä¸ªç³»ç»Ÿæ•°æ®ç»“æ„çš„åˆ†æã€è®¾è®¡ã€è§„åˆ’æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹ä¸­ä»‹è€…æ¨¡å¼</title>
      <link href="/blog/2019/03/18/af3a654f.html"/>
      <url>/blog/2019/03/18/af3a654f.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆä¸­ä»‹ï¼‰</p></blockquote><p>ä¸­ä»‹ï¼Œä½œç”¨äºå¤šä¸ªäº‹ç‰©ä¹‹é—´å……å½“äº¤äº’æ²Ÿé€šçš„åª’ä»‹ã€‚æˆ‘ä»¬çš„ç”Ÿæ´»ä¸­æœ‰å„ç§å„æ ·çš„åª’ä»‹ï¼Œæ¯”å¦‚ä¸€äº›ä¼ ç»Ÿåª’ä½“ï¼Œä¹¦åˆŠæ‚å¿—ï¼ŒæŠ¥çº¸ï¼ŒæŠŠä¿¡æ¯ä¼ é€’ç»™è¯»è€…ã€‚å†æ¯”å¦‚åˆ©ç”¨ç”µå­ä¿¡æ¯æŠ€æœ¯çš„äº’è”ç½‘ï¼Œä½œä¸ºä¸€ç§æ–°åª’ä½“ï¼Œä¸å•å¯ä»¥æ›´é«˜æ•ˆåœ°æŠŠä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·ï¼Œè€Œä¸”å¯ä»¥åå‘åœ°è·å¾—ç”¨æˆ·åé¦ˆè¯„è®ºï¼Œç”¨æˆ·ä¸ç”¨æˆ·ä¹‹é—´äº¦å¯ä»¥è¿›è¡Œæ²Ÿé€šï¼Œè¿™ç§å…¨ç»ˆç«¯åŒå‘äº’é€šæ˜¯ä¼ ç»Ÿåª’ä½“æ‰€ä¸èƒ½åŠçš„ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå†å¦‚å©šä»‹æ‰€ã€æˆ¿äº§ä¸­ä»‹ã€äº¤æ¢æœºç»„ç½‘ã€ç°ä»£ç”µå­å•†åŠ¡ã€C2Cè´­ç‰©å¹³å°ã€æ‰‹æœºã€å³æ—¶é€šè½¯ä»¶ç­‰ç­‰ï¼Œè¿™äº›éƒ½ä¸æˆ‘ä»¬çš„ç”Ÿæ´»æ¯æ¯ç›¸å…³ï¼Œç¦»å¼€å®ƒä»¬æˆ‘ä»¬å°†ä¸¾æ­¥ç»´è‰°ã€‚å…¶å®ä¸ç®¡æ˜¯ä»»ä½•ä¸­ä»‹ï¼Œå…¶æœ¬è´¨éƒ½æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯å……å½“ä¸­é—´åª’ä»‹çš„è§’è‰²ï¼Œå¹¶è¾¾æˆå¤šæ–¹ä¸šåŠ¡äº’é€šçš„ç›®çš„ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬ä»¥æœ€ç®€å•çš„æ¨¡å‹æ¥è§£å†³é—®é¢˜ï¼Œä»¥ä¸¤ä¸ªäººäº¤è°ˆä¸ºä¾‹ï¼Œå…¶å®ä»–ä»¬ä¹‹é—´å¹¶ä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹åª’ä»‹ï¼Œè€Œæ˜¯ä¸€å¯¹ä¸€ç›´æ¥æ²Ÿé€šï¼Œçœ‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;<span class="comment">//ç”¨åå­—æ¥åŒºåˆ«äººã€‚</span></span><br><span class="line">  <span class="keyword">private</span> People other;<span class="comment">//æŒæœ‰å¯¹æ–¹çš„å¼•ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">People</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;<span class="comment">//åˆå§‹åŒ–å¿…é¡»èµ·åã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(People other)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.other = other;<span class="comment">//è¿æ¥æ–¹æ³•ä¸­æ³¨å…¥å¯¹æ–¹å¼•ç”¨ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    other.listen(msg);<span class="comment">//æˆ‘æ–¹è¯´è¯æ—¶ï¼Œå¯¹æ–¹è†å¬ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è†å¬æ¥è‡ªå¯¹æ–¹çš„å£°éŸ³</span></span><br><span class="line">    System.out.println(</span><br><span class="line">        other.getName() + <span class="string">&quot; å¯¹ &quot;</span> + <span class="keyword">this</span>.name + <span class="string">&quot; è¯´ï¼š&quot;</span> + msg</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€åˆ‡å°±ç»ªï¼Œä¸¤äººå¼€å§‹æ²Ÿé€šã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">    People p3 = <span class="keyword">new</span> People(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    People p4 = <span class="keyword">new</span> People(<span class="string">&quot;æå››&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p3.connect(p4);</span><br><span class="line">    p4.connect(p3);</span><br><span class="line"></span><br><span class="line">    p3.talk(<span class="string">&quot;ä½ å¥½ã€‚&quot;</span>);</span><br><span class="line">    p4.talk(<span class="string">&quot;æ—©ä¸Šå¥½ï¼Œä¸‰å“¥ã€‚&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/****************************</span></span><br><span class="line"><span class="comment">  è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">    å¼ ä¸‰ å¯¹ æå›› è¯´ï¼šä½ å¥½ã€‚</span></span><br><span class="line"><span class="comment">    æå›› å¯¹ å¼ ä¸‰ è¯´ï¼šæ—©ä¸Šå¥½ï¼Œä¸‰å“¥ã€‚</span></span><br><span class="line"><span class="comment">  *****************************/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»Peopleç±»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ²Ÿé€šåªåªèƒ½åœ¨ä¸¤äººä¹‹é—´è¿›è¡Œï¼Œè€Œä¸”å„è‡ªéƒ½æŒæœ‰å¯¹æ–¹å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿æŠŠæ¶ˆæ¯ä¼ é€’ç»™å¯¹æ–¹çš„ç›‘å¬æ–¹æ³•ã€‚è¿™ç§æ¨¡å¼è™½ç„¶ç®€å•ï¼Œä½†è€¦åˆæ€§å¤ªå¼ºï¼Œä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ ï¼Œè°ä¹Ÿç¦»ä¸å¼€è°ã€‚è¯•æƒ³å¦‚æœå†æœ‰å¤šä¸ªäººåŠ å…¥äº¤è°ˆï¼Œé‚£æ¯ä¸ªäººéƒ½è¦æŒæœ‰å…¶ä»–æ‰€æœ‰äººçš„å¼•ç”¨äº†ï¼Œè¿™æ—¶ä¼šé™·å…¥ä¸€ç§å¤šå¯¹å¤šçš„å…³è”é™·é˜±ï¼Œå¯¹è±¡å…³ç³»å˜å¾—å¤æ‚ä¸å ªï¼Œå¦‚è››ç½‘èˆ¬éš¾ä»¥ç»´æŠ¤ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/3.png" alt="1v1"></p><p>æˆ‘ä»¬å°±æ‹¿ç¾¤èŠå¤©å®¤ä¸¾ä¾‹ï¼Œæ¯å½“æœ‰äººåŠ å…¥æˆ–ç¦»å¼€ï¼Œéƒ½è¦æŠŠæ¯ä¸ªäººæŒæœ‰çš„å…¶ä»–äººçš„å¼•ç”¨å…³ç³»æ›´æ–°ä¸€éï¼Œå‘æ¶ˆæ¯æ—¶æ›´æ˜¯ç¹çä¸å ªï¼Œé‡å¤å·¥ä½œæ˜¾å¾—éå¸¸å¤šä½™ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å¼€å§‹è¿›è¡Œæ€è€ƒï¼Œä¸ºä½•ä¸æŠŠé‡å¤çš„éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥å‘¢ï¼Œä¹Ÿå°±æ˜¯æŠŠå¯¹æ–¹çš„å¼•ç”¨æ”¾åœ¨ä¸€ä¸ªä¸­ä»‹ç±»é‡Œé¢å»ç»Ÿä¸€ç»´æŠ¤èµ·æ¥ï¼Œäºæ˜¯è®¾è®¡æ›´æ”¹å¦‚ä¸‹ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/4.png" alt="nvn"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªç”¨æˆ·ä¸å†æ‰€æŒæœ‰å…¶ä»–æ‰€æœ‰ç”¨æˆ·çš„å¼•ç”¨äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯èŠå¤©å®¤çš„å¼•ç”¨ï¼Œè¿™æ ·å¼•ç”¨å…³ç³»ç¬é—´å˜å¾—æ˜æœ—èµ·æ¥ï¼Œå¼€å§‹æˆ‘ä»¬çš„ä»£ç é‡æ„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;<span class="comment">//åå­—</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ChatRoom chatRoom;<span class="comment">//èŠå¤©å®¤å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;<span class="comment">//åˆå§‹åŒ–å¿…é¡»èµ·åå­—</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(ChatRoom chatRoom)</span> </span>&#123;<span class="comment">//ç”¨æˆ·ç™»é™†</span></span><br><span class="line">        chatRoom.connect(<span class="keyword">this</span>);<span class="comment">//è°ƒç”¨èŠå¤©å®¤è¿æ¥æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">this</span>.chatRoom = chatRoom;<span class="comment">//æ³¨å…¥èŠå¤©å®¤å¼•ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">(String msg)</span> </span>&#123;<span class="comment">//ç”¨æˆ·å‘è¨€</span></span><br><span class="line">        chatRoom.sendMsg(<span class="keyword">this</span>, msg);<span class="comment">//ç»™èŠå¤©å®¤å‘æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(User fromWhom, String msg)</span> </span>&#123;<span class="comment">//ä¸”å¬é£åŸ</span></span><br><span class="line">        System.out.print(<span class="string">&quot;ã€&quot;</span>+<span class="keyword">this</span>.name+<span class="string">&quot;çš„å¯¹è¯æ¡†ã€‘&quot;</span>);</span><br><span class="line">        System.out.println(fromWhom.getName() + <span class="string">&quot; è¯´ï¼š &quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¬¬14è¡Œï¼Œç”¨æˆ·ç™»é™†èŠå¤©å®¤æ—¶ä¸å†æ˜¯è¿æ¥å¯¹æ–¹äº†ï¼Œè€Œæ˜¯è¿æ¥é€šçŸ¥èŠå¤©å®¤å¹¶å‘ŠçŸ¥ï¼šâ€œæœ‰äººè¿›æ¥äº†è¯·è¿›è¡Œæ³¨å†Œâ€ï¼Œç„¶åè®°å½•ä¸‹æ¥ç”¨æˆ·å½“å‰æ‰€åœ¨èŠå¤©å®¤çš„å¼•ç”¨ã€‚ç¬¬19è¡Œï¼Œç”¨æˆ·å‘è¨€æ—¶ä¹Ÿä¸æ˜¯ç›´æ¥æ‰¾å¯¹æ–¹äº†ï¼Œè€Œæ˜¯æŠŠæ¶ˆæ¯æ‰”ç»™èŠå¤©å®¤å¤„ç†ã€‚ç¬¬23è¡Œï¼Œè†å¬æ–¹æ³•åŒæ ·ä¹Ÿæ˜¯ï¼Œå°†æ¥ä¼šæ¥å—æ¥è‡ªèŠå¤©å®¤çš„å£°éŸ³ã€‚å¾ˆæ˜¾ç„¶ï¼Œä¸€åˆ‡æ²Ÿé€šéƒ½ä¸æ˜¯ä¸­ä»‹èŠå¤©å®¤è¿›è¡Œï¼Œè¿™æ ·ç”¨æˆ·ä¹‹é—´å°±å®ç°äº†è§£è€¦çš„ç›®çš„ã€‚æ¥ç€å†™èŠå¤©å®¤ä¸­ä»‹ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatRoom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;<span class="comment">//èŠå¤©å®¤å‘½å</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatRoom</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;<span class="comment">//åˆå§‹åŒ–å¿…é¡»å‘½åèŠå¤©å®¤</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">//èŠå¤©å®¤é‡Œçš„ç”¨æˆ·ä»¬</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.users.add(user);<span class="comment">//ç”¨æˆ·è¿›å…¥èŠå¤©å®¤åŠ å…¥åˆ—è¡¨ã€‚</span></span><br><span class="line">        System.out.print(<span class="string">&quot;æ¬¢è¿ã€&quot;</span>);</span><br><span class="line">        System.out.print(user.getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;ã€‘åŠ å…¥èŠå¤©å®¤ã€&quot;</span> + <span class="keyword">this</span>.name + <span class="string">&quot;ã€‘&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(User fromWhom, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¾ªç¯æ‰€æœ‰ç”¨æˆ·ï¼Œåªå‘æ¶ˆæ¯ç»™éå‘é€æ–¹fromWhomã€‚</span></span><br><span class="line">        users.stream()</span><br><span class="line">        .filter(user -&gt; !user.equals(fromWhom))<span class="comment">//è¿‡æ»¤æ‰å‘é€æ–¹fromWhom</span></span><br><span class="line">        .forEach(toWhom -&gt; toWhom.listen(fromWhom, msg));<span class="comment">//å‘é€æ¶ˆæ¯ç»™å‰©ä¸‹çš„æ‰€æœ‰äºº</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªèŠå¤©å®¤ä½œä¸ºä¸­ä»‹ç±»ï¼Œæ‰€æœ‰å‚ä¸è€…ç™»é™†æ—¶è°ƒç”¨ç¬¬10è¡Œçš„connectæ–¹æ³•è¿›å…¥èŠå¤©å®¤ï¼Œå¹¶è®°å½•å…¶å¼•ç”¨åˆ°usersåˆ—è¡¨ä¸­ã€‚ç¬¬17è¡Œï¼Œå½“ç”¨æˆ·å‘æ¶ˆæ¯åˆ°å¹³å°æˆ‘ä»¬å†è½¬å‘ç»™å…¶ä»–äººï¼Œè¿™é‡Œåˆ©ç”¨Java8çš„æµå’ŒLambdaè¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤ï¼ˆUserç±»çš„equalsæ–¹æ³•è¯·è‡ªè¡ŒåŠ å…¥ï¼‰ï¼Œå¹¶å¾ªç¯è°ƒç”¨æ‰€æœ‰æ¥æ”¶æ–¹çš„listenæ–¹æ³•å³å¯ã€‚</p><p>ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ä¿æŒæœ€ç®€å•çš„æ–¹å¼ï¼Œå¦‚æœæŸå¤©æƒ…å†µå˜å¾—å¤æ‚ï¼Œæœ‰äº†ä¸åŒçš„ç”¨æˆ·ï¼Œæˆ–æ˜¯èŠå¤©å®¤ä¹Ÿå„ä¸ç›¸åŒå¹¶åŠ å…¥äº†å„è‡ªçš„ç‰¹æ€§ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦ç»§ç»­é‡æ„ï¼ŒæŠ½è±¡èŠå¤©å®¤ç±»ï¼ŒæŠ½è±¡ç”¨æˆ·ç±»ï¼Œè¯»è€…å¯ä»¥çµæ´»è¿ç”¨ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°äº†ã€‚</p><p>å…¶å®ä¸­ä»‹æ¨¡å¼ä¸æ­¢æ˜¯åœ¨ç”Ÿæ´»ä¸­å¹¿æ³›åº”ç”¨ï¼Œ<strong>åœ¨è½¯ä»¶æ¶æ„ä¸­ä¹Ÿéå¸¸å¸¸è§ï¼Œå½“ä¸‹æµè¡Œçš„å¾®æœåŠ¡åˆ†å¸ƒå¼è½¯ä»¶æ¶æ„æ‰€ç”¨åˆ°çš„æ³¨å†Œä¸­å¿ƒï¼Œä¾‹å¦‚æœ€å¸¸ç”¨åˆ°çš„äº‘ç»„ä»¶Eureka Serverï¼Œå…¶ä½œç”¨å°±æ˜¯ä¸ºä¼—å¤šåˆ†å¸ƒå¼æœåŠ¡æä¾›æ³¨å†Œå‘ç°æœåŠ¡ï¼Œå®ƒæ­£æ˜¯å……å½“åƒä¸­ä»‹ä¸€æ ·çš„è§’è‰²ã€‚</strong></p><p>ä¸­ä»‹æ¨¡å¼æ›´åƒæ˜¯ç½‘ç»œæ‹“æ‰‘ä¸­çš„<strong>æ˜Ÿå‹ç»“æ„</strong>ï¼Œå®ƒæè¿°äº†ä¼—èŠ‚ç‚¹ä¸ä¸­å¿ƒç‚¹çš„å…³ç³»ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/5.png" alt="æ˜Ÿå‹ç»“æ„"></p><p>å¯¹åƒä¹‹é—´æ˜¾å¼åœ°äº’ç›¸å¼•ç”¨è¶Šå¤šï¼Œæ„å‘³ç€ä¾èµ–æ€§è¶Šå¼ºï¼Œç‹¬ç«‹æ€§è¶Šå·®ï¼Œä¸åˆ©äºä»£ç ç»´æŠ¤ä¸æ‰©å±•ï¼ŒåŒæ—¶å¤šæ–¹æ²Ÿé€šçš„ä»»åŠ¡ä¹Ÿåº”äº¤ç”±ä¸­é—´å¹³å°æ¥å®Œæˆï¼Œæ¯ä¸ªç±»åº”åªå…·å¤‡å„è‡ªè¯¥æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¾¿æ˜¯é«˜å†…èšä½è€¦åˆçš„è®¾è®¡æ ‡å‡†ã€‚ä¸­ä»‹æ¨¡å¼ç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ï¼Œå®ƒè§£å†³äº†å¯¹è±¡é—´è¿‡åº¦è€¦åˆã€å¤æ‚é¢‘ç¹äº¤äº’çš„é—®é¢˜ï¼Œæ‰“ç ´äº†ä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ çš„ç›¸äº’ä¾èµ–ï¼Œç¬¬ä¸‰æ–¹çš„ä»‹å…¥æœ‰åŠ©äºåŒæ–¹è°ƒåœï¼Œæ‰“ç ´å¦‚èƒ¶ä¼¼æ¼†ã€çº ç¼ ä¸ä¼‘çš„å…³ç³»ï¼Œè®©ä»–ä»¬ä¹‹é—´å˜å¾—æ¾æ•£ã€è‡ªç”±ã€ç‹¬ç«‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼</title>
      <link href="/blog/2019/03/15/e4d55155.html"/>
      <url>/blog/2019/03/15/e4d55155.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆè£…é¥°ï¼‰</p></blockquote><p>è£…é¥°ï¼Œåœ¨æŸç‰©ä»¶åŸºç¡€ä¸ŠåŠ ä»¥ä¿®é¥°ï¼Œè£…ç‚¹ï¼Œä½¿å¾—åŸæœ¬çš„æœ´ç´ å˜å¾—åä¸½ï¼Œè¾¾åˆ°åŒ–è…æœ½ä¸ºç¥å¥‡çš„æ•ˆæœã€‚æ¯”å¦‚æˆ‘ä»¬ä»å¼€å‘å•†ä¹°æ¥çš„æ¯›å¯æˆ¿ï¼Œå¿…ç„¶è¦è¿›è¡Œå®¤å†…è£…æ½¢è¿™ä¹ˆä¸€é¡¹å·¥ç¨‹ï¼Œä»€ä¹ˆç®€çº¦é£å•Šï¼ŒåŒ—æ¬§é£å•Šï¼Œåœ°ä¸­æµ·ï¼Œç¾å¼ä¸­å¼ç­‰ç­‰ï¼Œå½“ç„¶èåœé’èœå„æœ‰æ‰€çˆ±ï¼Œæ¯ä¸ªäººè£…å‡ºçš„æˆ¿å­éƒ½å„æœ‰å·®å¼‚ï¼Œä½†ä¸ç®¡ä½•ç§é£æ ¼ï¼Œè¿™éƒ½æ˜¯å¯¹åŸæœ¬æ¯›å¯æˆ¿çš„è£…é¥°ï¼Œç•™ç»™ä¸šä¸»æŒ‰ç…§è‡ªå·±çš„å–œå¥½è¿›è¡ŒäºŒæ¬¡åŠ å·¥ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ¯›å¯äºŒæ‰‹æˆ¿æ¯”è£…ä¿®è¿‡çš„è¦å¥½å–ï¼Œæœ‰æˆå“å°±ä¸€å®šå¾—æœ‰åŠæˆå“ï¼Œè¿™æ ·æ‰èƒ½æŠŠæ›´å¤šçš„é€‰æ‹©ç•™ç»™ç”¨æˆ·ï¼Œä½¿å¾—è£…é¥°æˆä¸ºå¯èƒ½ã€‚</p><p>äººé è¡£è£…é©¬é éï¼Œå½“ç„¶ä¸æ­¢æ˜¯è£…ä¿®æœ‰è¿™ä¹ˆç¥å¥‡çš„æ•ˆæœï¼Œå¯¹äºå¥³ç”ŸåŒ–å¦†æ¥è¯´æˆ‘ä»¬ä¹Ÿæ˜¯æ·±æœ‰ä½“ä¼šï¼Œæ¯å½“å¥³å‹å›å®¶å¸å¦†åç´ é¢æœå¤©çš„æ—¶å€™æˆ‘ä»¬çš„å†…å¿ƒæ˜¯å´©æºƒçš„ï¼Œæœ‰ç§å½“åˆç›¸äº²è¢«éª—çš„æ„Ÿè§‰ã€‚</p><p>æ˜¾è€Œæ˜“è§ï¼Œå¥³å‹æ¯å¤©å‡ºé—¨ä¹‹å‰è¿›è¡Œçš„é‚£åœºæ´—ç¤¼æ˜¯å¤šä¹ˆçš„ç¥åœ£ï¼Œå¤šä¹ˆçš„ä¸å¯æˆ–ç¼ºã€‚è¯šç„¶ï¼ŒåŒ–å¦†çš„è¿‡ç¨‹å¯¹äºç”·äººæ¥è¯´å……æ»¡äº†ç¥ç§˜è‰²å½©ï¼Œä½†å¯¹äºå¥³äººæ¥è¯´æ›´åƒæ˜¯ä¸€åœºæ´—ç¤¼ï¼Œæ€€æ£ç€ä¿¡ä»°ä¸æ•¬ç•æ„Ÿè¿›è¡Œçš„ä¸€åœºä»ªå¼ï¼Œæœ€ç»ˆä¼šåƒé­”æ³•ä¸€èˆ¬æŠŠè‡ªå·±çš„è„¸å˜å¾—å®Œç¾æ— ç‘•ï¼Œæ›´æœ‰ç”šè€…æµ“å¦†è‰³æŠ¹åœ°è¿æ¯›å­”éƒ½çœ‹ä¸åˆ°ã€‚</p><p>ä½œä¸ºç ”å‘äººå‘˜ï¼Œæˆ‘ä»¬ä¸€å®šä¸èƒ½æ”¾è¿‡å¯¹äºè¿™é¡¹ç¥ç§˜å·¥ç¨‹çš„æ‹†è§£åˆ†æï¼Œå¼€å§‹æˆ‘ä»¬çš„å·¥ä½œã€‚é¦–å…ˆæ¯ä¸ªäººè¦å±•ç¤ºè‡ªå·±é‚£å¿…ç„¶æœ‰ä¸€ä¸ªæ ‡å‡†è¡Œä¸ºshow()ï¼Œæˆ‘ä»¬å°†å®ƒæŠ½è±¡å‡ºæ¥ä½œä¸ºæ¥å£Showableã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Showable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;<span class="comment">//å®šä¹‰å±•ç¤ºè¡Œä¸º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¥³å‹ä¼šè¿™é—¨åŠŸå¤«äº†ï¼Œæ‰€ä»¥å®ç°äº†æ­¤è¡Œä¸ºå¹¶æ–½å±•å…¶â€œç¾ä¸½çš„è„¸åºâ€äº†ï¼Œä½†æ­¤æ—¶åªæ˜¯åŸç”Ÿæ€çš„ç´ é¢œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Girl</span> <span class="keyword">implements</span> <span class="title">Showable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;å¥³å­©çš„ç´ é¢œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼Œç›´æ¥è°ƒç”¨çš„è¯ä¼šæ˜¯ç´ é¢æœå¤©ç›´é¢æƒ¨æ·¡çš„äººç”Ÿï¼Œè¿™æ ·å½“ç„¶è¾¾ä¸åˆ°ç¾é¢œæ•ˆæœäº†ï¼Œä½•ä»¥ç™»ä¸Šäººç”Ÿå·…å³°ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥è¦è¿›è¡ŒåŒ–å¦†äº†ï¼Œè¿™é‡Œå¿…é¡»ä¾é ä¸€ç§ç¥ç§˜è€Œåˆæ˜‚è´µçš„ä¸œè¥¿ï¼ŒåŒ–å¦†å“ç™»åœºäº†ï¼Œå®ƒåŒæ ·å®ç°äº†Showableæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">implements</span> <span class="title">Showable</span></span>&#123;<span class="comment">//åŒ–å¦†å“ç²‰é¥°å™¨</span></span><br><span class="line"></span><br><span class="line">    Showable showable;<span class="comment">//æŒæœ‰æŸä¸ªå–„äºå±•ç¤ºçš„å®¶ä¼™</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Showable showable)</span> </span>&#123;<span class="comment">//æ„é€ æ—¶æ³¨å…¥è¿™ä¸ªå®¶ä¼™</span></span><br><span class="line">        <span class="keyword">this</span>.showable = showable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;ç²‰é¥°(&quot;</span>);<span class="comment">//åŒ–å¦†å“ç²‰é¥°</span></span><br><span class="line">        showable.show();<span class="comment">//è¿™å®¶ä¼™ç´ é¢æœå¤©çš„ç§€</span></span><br><span class="line">        System.out.print(<span class="string">&quot;)&quot;</span>);<span class="comment">//ç²‰é¥°æ‰“å®Œæ”¶å·¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨æ„é€ åŒ–å¦†å“ç±»çš„æ—¶å€™å¯ä»¥æŠŠå¥³å­©ç»™æ³¨å…¥è¿›æ¥ï¼Œç›®çš„åœ¨äºè°ƒç”¨å¥³å­©çš„showæ–¹æ³•ï¼Œä½†å¯¹äºå…¶åŸæœ¬çš„å…·ä½“è¡Œä¸ºè£…é¥°å™¨ä¸€æ— æ‰€çŸ¥ï¼Œå¹¶ä¸”æ²¡æœ‰åŠ å…¥ä»»ä½•é€»è¾‘é™åˆ¶ï¼Œå®ƒæ‰€åšçš„æ— éæ˜¯â€œç”»é¾™ç‚¹ç›â€ï¼Œâ€œé”¦ä¸Šæ·»èŠ±â€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹çœ‹ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ç”¨è£…é¥°å™¨åŒ…è£¹å¥³å­©showå‡ºæ¥</span></span><br><span class="line">        <span class="keyword">new</span> Decorator(<span class="keyword">new</span> Girl()).show();</span><br><span class="line">        <span class="comment">//ç»“æœï¼šç²‰é¥°(å¥³å­©çš„ç´ é¢œ)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªéœ€è¦æ–°å»ºè£…é¥°å™¨çš„æ—¶å€™æŠŠå¥³å­©ç»™åŒ…è£…è¿›å»å°±å¾—åˆ°äº†ç²‰é¥°è¿‡çš„ç¾é¢œï¼Œæ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿç„¶è€Œæ­¤æ—¶æœ‰å¥³æœ‹å‹ä¼šå«Œå¼ƒäº†ï¼Œâ€œåªæ˜¯æ‰“ç²‰åº•è¿™ä¹ˆç®€å•å—ï¼Ÿçœ¼éœœå‘¢ï¼Ÿå£çº¢å‘¢â€¦â€¦â€ã€‚</p><p>å¥½å§ï¼Œä¸ºäº†æ»¡è¶³å¥³å‹çš„è¦æ±‚ï¼Œæˆ‘ä»¬å¾—å†å¤šä¸€äº›è®¾è®¡ã€‚æƒ³æƒ³çœ‹è¿™äº›åŒ–å¦†å“ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆéƒ½æœ‰å…±åŒçš„ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬ç»Ÿç»Ÿéƒ½å¯ä»¥è£…é¥°åŸç”Ÿæ€çš„ç´ é¢œå±•ç¤ºæ–¹æ³•showï¼Œé‚£æˆ‘ä»¬ä½•ä¸æŠŠè¿™äº›ç‰¹æ€§æŠ½è±¡å‡ºæ¥å‘¢ï¼Ÿå¼€å§‹è¡ŒåŠ¨ï¼Œä¿®æ”¹æˆ‘ä»¬çš„è£…é¥°ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">implements</span> <span class="title">Showable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Showable showable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Showable showable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.showable = showable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        showable.show();<span class="comment">//ç›´æ¥è°ƒç”¨ä¸åšåŠ ä»»ä½•ç²‰é¥°ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠåŒ–å¦†å“ç±»ç»™æ”¹æˆæŠ½è±¡ç±»ï¼Œé‡å†™showæ–¹æ³•ï¼Œä½†ä¸åšä»»ä½•ç²‰é¥°äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç•™ç»™å­ç±»å…·ä½“çš„æŸä¸ªåŒ–å¦†å“å»åšè£…é¥°å§ã€‚åŒ–å¦†é¦–å…ˆç¬¬ä¸€æ­¥ä¸€å®šè¦æ‰“åº•äº†ï¼Œè¿™é‡Œæˆ‘ä»¬é¦–å…ˆåŠ å…¥ä¸€ä¸ªç²‰åº•ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoundationMakeup</span> <span class="keyword">extends</span> <span class="title">Decorator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FoundationMakeup</span><span class="params">(Showable showable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(showable);<span class="comment">//è°ƒç”¨åŒ–å¦†å“çˆ¶ç±»æ³¨å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;æ‰“ç²‰åº•(&quot;</span>);</span><br><span class="line">        showable.show();</span><br><span class="line">        System.out.print(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç²‰åº•ç±»ç»§æ‰¿äº†åŒ–å¦†å“ç±»ï¼Œå½“ç„¶è¿™ä¸ªç²‰åº•çš„showæ–¹æ³•ä¸€å®šè¦åŠ ä»¥ä¿®é¥°äº†ï¼Œåœ¨åŸç”Ÿæ€çš„å‰åéƒ½è¿›è¡Œäº†æ‰“ç²‰åº•æ“ä½œã€‚åŒæ ·åœ°ï¼Œæ‰“å®Œç²‰åº•åå†ç”»ä¸ªå£çº¢å§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lipstick</span> <span class="keyword">extends</span> <span class="title">Decorator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lipstick</span><span class="params">(Showable showable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(showable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;æ¶‚å£çº¢(&quot;</span>);</span><br><span class="line">        showable.show();</span><br><span class="line">        System.out.print(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬æŠŠå¥³å‹ã€ç²‰åº•ã€å£çº¢å±‚å±‚åŒ…è£¹èµ·æ¥å¹¶è¿è¡Œï¼Œç»“æœå¦‚æ„¿ä»¥å¿ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å£çº¢åŒ…è£¹ç²‰åº•ï¼Œå†åŒ…è£¹å¥³å‹ã€‚</span></span><br><span class="line">        Showable madeupGirl = <span class="keyword">new</span> Lipstick(<span class="keyword">new</span> FoundationMakeup(<span class="keyword">new</span> Girl()));</span><br><span class="line">        madeupGirl.show();</span><br><span class="line">        <span class="comment">//è¿è¡Œç»“æœï¼šæ¶‚å£çº¢(æ‰“ç²‰åº•(å¥³å­©çš„è„¸åº))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¥³å‹å¯¹è¿™ç§æ·¡å¦†æ•ˆæœè¿˜æ˜¯ä¸æ»¡æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·»åŠ åŒ–å¦†å“ç±»ï¼Œç«æ¯›è†ã€çœ¼çº¿ã€çœ‰ç¬”ã€è…®çº¢ç­‰ç­‰ç­‰ç­‰ï¼Œåªéœ€è¦å±‚å±‚åŒ…è£¹èµ·æ¥ï¼Œæœ€ç»ˆå®ç°å¥³å‹æµ“å¦†è‰³æŠ¹çš„æ¢¦æƒ³ã€‚</p><p>æˆ‘ä»¬è§‚å¯Ÿè¿™ç§è£…é¥°å™¨æ¨¡å¼ç»“æ„ï¼Œæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†å‘¢ï¼Ÿæ²¡é”™ï¼Œå…¶å®è£…é¥°å™¨æ¨¡å¼åœ¨JDKé‡Œå°±æœ‰å¾ˆå¤šåº”ç”¨ï¼Œæ¯”å¦‚<strong>Java IOåŒ…é‡Œçš„ä¼—å¤šæµå¤„ç†ç±»ã€‚</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(filePath)));</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæµå¤„ç†ç±»å½“ç„¶è¦æ¯”æˆ‘ä»¬çš„ä¾‹å­å¤æ‚çš„å¤šï¼Œä½†å…¶åŸºæœ¬æ€æƒ³å’Œæˆ‘ä»¬å»ç¹å°±ç®€çš„ä¾‹å­å¼‚é€”åŒå½’ï¼Œè¿™äº›å¯¹è±¡å°±å¥½åƒæ˜¯ä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·å±‚å±‚åŒ…è£¹ï¼Œå±‚å±‚è£…é¥°ï¼Œæ¯å¥—ä¸€å±‚å°±ä¼šå¤šå‡ºä¸€äº›åŠŸèƒ½å‡ºæ¥ï¼Œæˆ‘ä»¬æ›´å¯ä»¥è‡ªç”±æ­é…ï¼Œå®ç°ä¸åŒçš„ç»„åˆåŠŸèƒ½ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯å¥³ç”ŸåŒ–å¦†è¿˜æ˜¯ç¨‹åºå‘˜å†™ä»£ç ï¼Œæˆ‘ä»¬éƒ½ä¸å¯èƒ½å¼„å‡ºä¸€ä¸ªå·¨å¤§çš„ç±»ç„¶åå»æå®šæ‰€æœ‰äº‹æƒ…ï¼Œå¦‚æ­¤ä»£ç ä¼šè¶Šå †ç§¯è¶Šå¤šï¼Œéš¾äºç»´æŠ¤ï¼ŒåŠŸèƒ½æ‰©å±•æ›´æ˜¯ä¸¾æ­¥ç»´è‰°ã€‚æˆ‘ä»¬éƒ½éœ€è¦æœ‰è¿™ç§è®¾è®¡æ€æƒ³ï¼Œæ¯ä¸ªåŒ–å¦†å“éƒ¨ä»¶å„å¸å…¶èŒï¼Œä¸åšå’Œè‡ªå·±ä¸ç›¸å…³çš„äº‹ï¼Œç„¶åæŠŠéƒ¨ä»¶å±‚å±‚å åŠ ï¼Œå¹¶æ ¹æ®éœ€æ±‚ç»„è£…æˆå‹ï¼Œä»¥è¾¾æœ€ç»ˆçš„è£…é¥°ç›®çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹é—¨é¢æ¨¡å¼</title>
      <link href="/blog/2019/03/12/2ce91e46.html"/>
      <url>/blog/2019/03/12/2ce91e46.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé—¨é¢ï¼‰</p></blockquote><p>å¼€é—¨è§å±±ï¼Œé—¨ï¼Œå»ºç­‘ç‰©çš„å…¥å£ï¼Œé¢ï¼Œè„¸ä¹Ÿã€‚é—¨é¢ï¼ˆFacadeï¼‰ï¼Œé€šå¸¸æŒ‡åº—é“ºçš„é—¨å¤´å¤–è¡¨éƒ¨åˆ†ï¼Œå½“ç„¶ä¸€å®šè¦ä¸´è¡—æ‰æ˜¯å¥½çš„å•†é“ºï¼Œåœ¨äººæµé‡å¤§çš„åœ°æ–¹è¥é€ æ›´å¥½çš„è§†è§‰å†²å‡»ï¼Œè¿™æ ·ä¼šæœ‰æ›´å¤šç­‰ç­‰æœºä¼šæš´éœ²ç»™æ½œåœ¨é¡¾å®¢ï¼Œå¦åˆ™åªèƒ½æ˜¯é â€œé…’é¦™ä¸æ€•å··å­æ·±â€ï¼Œé å‘³é“æ¥å¸å¼•äººäº†ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/2.jpeg" alt="é…’ç¥ä¸æ€•å··å­æ·±"></p><p>å½“ç„¶é™¤äº†å…‰é²œäº®ä¸½çš„å¤–è¡¨ï¼Œæ›´é‡è¦çš„æ˜¯é—¨åº—æä¾›çš„æœåŠ¡äº†ã€‚å°±æ‹¿é¤é¥®æ¥ä¸¾ä¾‹å§ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›é—¨åº—æˆ‘ä»¬éƒ½æ€æ ·åƒé¥­å‘¢ï¼Ÿæˆ‘ä»¬è‡ªå·±åšåˆä¸ä¼šï¼Œç®—äº†è¿˜æ˜¯æ‰¾å¥³å‹ä¸‹å¨å§ã€‚å¾ˆç®€å•åˆ†ä¸‰æ­¥èµ°ï¼Œé¦–å…ˆæ‰¾èœè´©ä¹°èœï¼Œå…¶æ¬¡å¥³å‹ä¸‹å¨ï¼Œæœ€ååƒå®Œæ´—ç¢—ï¼Œæ‰“å®Œæ”¶å·¥ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VegVendor</span> </span>&#123;<span class="comment">//èœè´©å­</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sell</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;èœè´©å­å–èœã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GirlFriend</span> </span>&#123;<span class="comment">//å¥³å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¥³å‹çƒ¹é¥ªã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Me</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘åªä¼šåƒã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æ‰¾èœè´©å­ä¹°èœ</span></span><br><span class="line">        VegVendor vv = <span class="keyword">new</span> VegVendor();</span><br><span class="line">        vv.sell();</span><br><span class="line">        <span class="comment">//æ‰¾å¥³å‹åšé¥­</span></span><br><span class="line">        GirlFriend gf = <span class="keyword">new</span> GirlFriend();</span><br><span class="line">        gf.cook();</span><br><span class="line">        <span class="comment">//æˆ‘åªä¼šåƒ</span></span><br><span class="line">        Me me = <span class="keyword">new</span> Me();</span><br><span class="line">        me.eat();</span><br><span class="line">        <span class="comment">//è°æ´—ç¢—å‘¢ï¼Ÿä¸€åœºæˆ˜åœºä¸€è§¦å³å‘â€¦â€¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®æˆ‘ä»¬ä¸è¯¥æ‰¾å¥³å‹åšé¥­çš„ï¼Œè€Œæ˜¯åº”è¯¥é›‡ä¸€ä¸ªä¸“ä¸šå¨å¸ˆï¼Œå¯è¿™ä¸‹æ¥å¾—å¤šå¤§èŠ±è´¹å•Šï¼Œå¤ªåˆ’ä¸æ¥äº†ï¼Œä¹Ÿè®¸è¿˜å¾—æˆ‘ä»¬è‡ªå·±æ´—ç¢—â€¦â€¦å“ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿä¸æƒ³éº»çƒ¦ï¼Œè¿˜æ˜¯æ‰¾é—¨åº—æ¥è§£å†³å§ï¼Œè‡³äºé‚£äº›ä¹°èœå•Šï¼Œçƒ¹é¥ªå•Šï¼Œæ´—ç¢—æ”¶æ‹¾æ¡Œå­å•Šæˆ‘ä»¬ç»Ÿç»Ÿéƒ½ä¸ç”¨ç®¡äº†ï¼Œé—¨åº—å¯ä»¥è¿›è¡Œèµ„æºæ•´åˆä¸è°ƒåº¦ï¼Œè¿™æ ·æˆ‘ä»¬åƒé¥­å°±å˜å¾—å¦‚æ­¤ç®€å•äº†ï¼Œåªéœ€è¦ä»˜é’±å°±è¡Œäº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªä¼šåƒã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> VegVendor vv;</span><br><span class="line">    <span class="keyword">private</span> Chef chef;</span><br><span class="line">    <span class="keyword">private</span> Waiter waiter;</span><br><span class="line">    <span class="keyword">private</span> Cleaner cleaner;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Facade</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.vv = <span class="keyword">new</span> VegVendor();</span><br><span class="line">        <span class="comment">//å¼€é—¨å‰å°±æ‰¾èœè´©å­å‡†å¤‡å¥½è”¬èœ</span></span><br><span class="line">        vv.sell();</span><br><span class="line">        <span class="comment">//å½“ç„¶è¿˜å¾—é›‡ä½£å¥½å„ç±»é¥­åº—æœåŠ¡äººå‘˜</span></span><br><span class="line">        <span class="keyword">this</span>.chef = <span class="keyword">new</span> Chef();</span><br><span class="line">        <span class="keyword">this</span>.waiter = <span class="keyword">new</span> Waiter();</span><br><span class="line">        <span class="keyword">this</span>.cleaner = <span class="keyword">new</span> Cleaner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">provideService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//æ¥å¾…ï¼Œå…¥åº§ï¼Œç‚¹èœ</span></span><br><span class="line">        waiter.order();</span><br><span class="line">        <span class="comment">//æ‰¾å¨å¸ˆåšé¥­</span></span><br><span class="line">        chef.cook();</span><br><span class="line">        <span class="comment">//ä¸Šèœ</span></span><br><span class="line">        waiter.serve();</span><br><span class="line">        <span class="comment">//æ”¶æ‹¾æ¡Œå­ï¼Œæ´—ç¢—ï¼Œä»¥åŠå…¶ä»–å·¥åºâ€¦â€¦</span></span><br><span class="line">        cleaner.clean();</span><br><span class="line">        cleaner.wash();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹å¯çˆ½äº†ï¼Œæˆ‘ä»¬å†ä¹Ÿä¸ç”¨å»èŠ±è´¹æ—¶é—´å»è°ƒåŠ¨é‚£ä¹ˆå¤šèµ„æºï¼Œåˆæ˜¯å‡ºé—¨ä¹°èœï¼Œåˆæ˜¯æ‰¾å¥³å‹åšèœï¼Œæ´—ç¢—æ“¦æ¡Œä»€ä¹ˆçš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ€¥éœ€ä¸€ä¸ªé—¨é¢æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰é—¨é¢çš„è¯ï¼Œè¯•æƒ³æ¯å®¶æ¯æˆ·æ¯é¡¿éƒ½åšé¥­çš„è¯ï¼Œäºæ˜¯æˆ‘ä»¬æ”¾å¼ƒæˆ‘ä»¬çš„ä¸“ä¸šä¼˜åŠ¿ï¼Œæ•´å¤©èŠ±å¾ˆé•¿æ—¶é—´åšé¥­æ‰èƒ½ä¸é¥¿è‚šå­ï¼Œå¦‚æ­¤åŠ³åŠ¨åˆ†å·¥ä¸æ˜ç¡®ï¼Œç¤¾ä¼šç”Ÿäº§ç‡ä½ä¸‹ï¼Œå›½å®¶ç»æµç”Ÿäº§ä¸æ™¯æ°”ï¼Œæœ€åé€ æˆGDPä¸‹æ»‘ï¼Œè¿™å°±æ˜¯äºšå½“æ–¯å¯†çš„åŠ³åŠ¨åˆ†å·¥ç†è®ºã€‚</p><hr><p><strong>æ€»ç»“ï¼š</strong></p><p>å…¶å®è¿™å°±æ˜¯é—¨é¢æ¨¡å¼çš„ç”¨æ³•äº†ï¼Œé—¨é¢å°±æ˜¯ä¸€ä¸ªå¤§ç³»ç»Ÿï¼Œé‡Œé¢å°è£…äº†å¾ˆå¤šçš„å­éƒ¨ä»¶ï¼ˆæˆ–å­ç³»ç»Ÿï¼‰ï¼Œéƒ¨ä»¶ä¹‹é—´ä¹Ÿè®¸æœ‰å¤æ‚çš„é€»è¾‘å…³ç³»ï¼Œå¯¹äºæˆ‘ä»¬æ—è§‚è€…æ¥è¯´ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›å­éƒ¨ä»¶æ˜¯éå¸¸éº»çƒ¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥é—¨é¢å°±å……å½“äº†ä¸€ä¸ªåŒ…è£…ç±»çš„è§’è‰²ï¼Œå¹¶ä¸”å¯¹å¤–æš´éœ²ä¸€ä¸ªæ¥å£ï¼Œè¾¾åˆ°ç®€åŒ–å®¢æˆ·æ“ä½œçš„ç›®çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹å®¢æˆ·ç«¯ä¸å­ç³»ç»Ÿä¹‹é—´çš„è§£è€¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿æ–¹æ³•</title>
      <link href="/blog/2019/03/08/334a0583.html"/>
      <url>/blog/2019/03/08/334a0583.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>è®¾è®¡æ¨¡å¼`ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p><p> é¢å‘å¯¹è±¡ï¼Œæ˜¯å¯¹äº‹ç‰©å±æ€§ä¸è¡Œä¸ºçš„å°è£…ï¼Œæ–¹æ³•ï¼ŒæŒ‡çš„å°±æ˜¯è¡Œä¸ºã€‚æ¨¡æ¿æ–¹æ³•ï¼Œæ˜¾è€Œæ˜“è§æ˜¯è¯´æŸä¸ªæ–¹æ³•å……å½“äº†æ¨¡æ¿çš„ä½œç”¨ï¼Œå…¶å……åˆ†åˆ©ç”¨äº†æŠ½è±¡ç±»è™šå®ç»“åˆçš„ç‰¹æ€§ï¼Œè™šéƒ¨æŠ½è±¡é¢„ç•™ï¼Œå®éƒ¨å›ºå®šå»¶ç»­ï¼Œä»¥è¾¾åˆ°å°†æŸç§å›ºæœ‰è¡Œä¸ºå»¶ç»­è‡³å­ç±»çš„ç›®çš„ã€‚åè§‚æ¥å£ï¼Œåˆ™è¾¾ä¸åˆ°è¿™ç§ç›®çš„ã€‚è¦ææ˜ç™½æ¨¡æ¿æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬ä»æ¥å£ä¸æŠ½è±¡ç±»çš„åŒºåˆ«åˆ‡å…¥ã€‚</p><p>ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰</p></blockquote><h2 id="æ¨¡æ¿æ–¹æ³•"><a href="#æ¨¡æ¿æ–¹æ³•" class="headerlink" title="æ¨¡æ¿æ–¹æ³•"></a>æ¨¡æ¿æ–¹æ³•</h2><p>æ±½è½¦ä¸Šçš„æ¥å£æœ€å¸¸è§çš„å°±æ˜¯è¿™å‡ ä¸ªäº†ï¼š<strong>ç‚¹çƒŸå™¨ï¼ŒUSBï¼ŒAUXç­‰ç­‰</strong>ï¼Œå¾ˆæ˜æ˜¾è¿™äº›éƒ½æ˜¯æ¥å£ï¼Œå®ƒä»¬éƒ½é¢„ç•™äº†æŸç§æ ‡å‡†ï¼Œæš´éœ²åœ¨ç³»ç»Ÿå¤–éƒ¨ï¼Œå¹¶ä¸å¤–è®¾å¯¹æ¥ã€‚å°±æ‹¿ç‚¹çƒŸå™¨æ¥å£æ¥è¯´å§ï¼Œå®ƒåŸæœ¬æ˜¯ä¸“é—¨ç”¨äºç»™ç‚¹çƒŸå™¨ä¾›ç”µçš„ï¼Œåæ¥ç”±äºè¿™ä¸ªæ¥å£åœ¨æ±½è½¦ä¸Šçš„é€šç”¨æ€§ï¼Œäºæ˜¯è¡ç”Ÿå‡ºäº†å„ç§å¤–éƒ¨è®¾å¤‡ï¼Œåªè¦æ˜¯ç¬¦åˆè¿™ä¸ªæ ‡å‡†sizeçš„ï¼Œå¸¦æ­£è´Ÿæç°§ç‰‡çš„ï¼Œç›´æµ12Vçš„ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚å¯¼èˆªã€è¡Œè½¦è®°å½•ä»ªã€å¸å°˜å™¨ä»€ä¹ˆçš„ï¼Œä»¥åŠå…¶ä»–å„ç§è½¦è½½ç”µå­è®¾å¤‡ã€‚</p><h3 id="ç‚¹çƒŸå™¨æ¥å£"><a href="#ç‚¹çƒŸå™¨æ¥å£" class="headerlink" title="ç‚¹çƒŸå™¨æ¥å£"></a>ç‚¹çƒŸå™¨æ¥å£</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CigarLighterInterface</span> </span>&#123;<span class="comment">//ç‚¹çƒŸå™¨æ¥å£</span></span><br><span class="line">    <span class="comment">//ä¾›ç”µæ–¹æ³•ï¼Œ16Vç›´æµç”µ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrifyDC16V</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GPS"><a href="#GPS" class="headerlink" title="GPS"></a>GPS</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GPS</span> <span class="keyword">implements</span> <span class="title">CigarLighterInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯¼èˆªçš„å®ç°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrifyDC16V</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¿æ¥å«æ˜Ÿ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å®šä½ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CigarLighter"><a href="#CigarLighter" class="headerlink" title="CigarLighter"></a>CigarLighter</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CigarLighter</span> <span class="keyword">implements</span> <span class="title">CigarLighterInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ç‚¹çƒŸå™¨çš„å®ç°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrifyDC16V</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> time = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">while</span>(--time&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;åŠ çƒ­ç”µç‚‰ä¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç‚¹çƒŸå™¨å¼¹å‡º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç‚¹çƒŸå™¨æ¥å£æ¥è¯´ï¼Œå®ƒæ ¹æœ¬ä¸åœ¨ä¹ä¹Ÿä¸çŸ¥é“å¯¹æ¥çš„å¤–è®¾æ˜¯ä»€ä¹ˆé¬¼ï¼Œå®ƒåªæ˜¯å®šä¹‰äº†ä¸€ç§è§„èŒƒï¼Œä¸€ç§æ ‡å‡†ï¼Œåªè¦ç¬¦åˆçš„éƒ½å¯ä»¥å¯¹æ¥ã€‚å†æ¯”å¦‚USBæ¥å£çš„åº”ç”¨æ›´åŠ å¹¿æ³›ï¼Œå¤–è®¾æ›´æ˜¯åº”æœ‰å°½æœ‰ã€‚</p><p>å½“ç„¶å¤§éƒ¨åˆ†æƒ…å†µæˆ‘ä»¬ä½¿ç”¨æ¥å£ä¼šå¤šäºæŠ½è±¡ç±»ï¼Œå› ä¸ºæ¥å£çµæ´»å•Šï¼ŒæŠ½è±¡ç±»ä¸å…è®¸å¤šç»§æ‰¿å•Šç­‰ç­‰ï¼Œå…¶å®æˆ‘ä»¬è¿˜æ˜¯è¦çœ‹åº”ç”¨åœºæ™¯ï¼Œåœ¨æŸç§æ— è§„çŸ©ä¸æˆæ–¹åœ†ï¼Œæˆ–è€…è§„èŒƒæ¯”è¾ƒæ˜ç¡®ï¼Œçš„æƒ…å†µä¸‹æŠ½è±¡ç±»çš„åº”ç”¨æ˜¯æœ‰å¿…è¦çš„ï¼Œä¸–é—´ä¸‡ç‰©æ²¡æœ‰æœ€å¥½çš„ï¼Œåªæœ‰æœ€åˆé€‚çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹çŠ¶æ€æ¨¡å¼</title>
      <link href="/blog/2019/03/01/5f8f3de5.html"/>
      <url>/blog/2019/03/01/5f8f3de5.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>è®¾è®¡æ¨¡å¼`ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p></blockquote><h2 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h2><blockquote><p>ä»¥ä¸‹æ–‡å­—æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆçŠ¶æ€ï¼‰</p></blockquote><p>çŠ¶æ€Stateï¼ŒæŒ‡æŸäº‹ç‰©æ‰€å¤„çš„çŠ¶å†µæˆ–å½¢æ€ï¼Œæ¯”å¦‚æ°´çš„ä¸‰æ€ï¼Œé›¶ä¸‹ä¼šå˜æˆå›ºæ€å†°ï¼Œå¸¸æ¸©ä¼šæ˜¯æ¶²æ€æ°´ï¼Œ100â„ƒä¼šè’¸å‘æˆæ°”æ€çš„æ°´è’¸æ°”ã€‚</p><p>åœ¨è¿™ä¸ªåœ°çƒç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæ°´çš„æ€»é‡å¹¶ä¸ä¼šå¢åŠ ï¼Œä¹Ÿä¸ä¼šå‡å°‘ï¼Œåªæ˜¯éšç€æ¸©åº¦çš„å˜åŒ–å…¶åˆ†å­é—´å‘ç”Ÿäº†ç¨€æ¾ç´§å¯†çš„å˜åŒ–ç½¢äº†ï¼Œäºæ˜¯ä¾¿æœ‰äº†ä¸åŒçš„è¡Œä¸ºï¼Œæ¯”å¦‚æµåŠ¨ã€å‡å›ºã€æˆ–æ˜¯è’¸è…¾ï¼Œä½†å¯¹äºå…¶æœ¬è´¨H2Oåˆ†å­å¯¹è±¡å¹¶æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå˜åŒ–çš„ï¼Œåªæ˜¯å…¶å½¢æ€ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="å›¾ç‰‡"></p><p>å½“ç„¶ï¼Œäº‹ç‰©çš„çŠ¶æ€éƒ½æ˜¯ä¸åŒçš„ï¼Œæœ‰çš„å¤šæœ‰çš„å°‘ã€‚ç‰©è´¨åŸºæœ¬ä¸‰æ€ï¼Œäººçš„ç²¾ç¥çŠ¶æ€æ›´æ˜¯éå¸¸å¤æ‚å¤šå˜çš„ï¼Œå–œæ€’å“€ä¹ï¼Œäº”å‘³æ‚é™ˆã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œå¯¹äºæŸäº›æ‚£æœ‰ä¸¥é‡çš„ç²¾ç¥åˆ†è£‚çš„ç—…äººæ¥è¯´ï¼Œå…¶ç²¾ç¥çŠ¶æ€æ›´æ˜¯å˜åŒ–æ— å¸¸ï¼Œæœ‰äº›ç«Ÿå¯ä»¥æ‰®æ¼”å‡ åç§è§’è‰²ï¼Œéšæ—¶é—´æˆ–å¢ƒé‡åˆ‡æ¢ï¼Œä¸€ä¼šå˜æˆç²¾æ˜èªé¢–çš„å¾‹å¸ˆï¼Œä¸€ä¼šæ˜¯æ‡¦å¼±çš„å¤±è´¥è€…æ€»æ˜¯è¦è‡ªæ€ï¼Œä¸€ä¸ªå¢ƒé‡è§¦å‘åˆæ˜¯æ„¤æ€’çš„æ€äººæš´å¾’ï¼Œè¿™äººæ ¼åˆ‡æ¢é€Ÿåº¦ï¼Œä¸§å¿ƒç—…ç‹‚åˆ°ä»¤äººå‘æŒ‡ã€‚</p><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><blockquote><p>ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé€‚é…å™¨ï¼‰</p></blockquote><h3 id="å¼€å…³"><a href="#å¼€å…³" class="headerlink" title="å¼€å…³"></a>å¼€å…³</h3><p>å®ç°ä¸€ä¸ªå¼€å…³ç±»ï¼Œæš´éœ²å‡ºä¸¤ä¸ªUIå¯æ“ä½œæ¥å£ï¼ˆå¯¹æ¥ä½ çš„æ‰‹æŒ‡ï¼‰ï¼šå¼€ã€å…³ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/03/01/1.png" alt="å¼€å…³"></p><p>å®šä¹‰ä¸€ä¸ªç±»å§ï¼Œå°±å«å®ƒï¼šSwitcherå¥½äº†ï¼Œå¯¹å¤–æš´éœ²ä¸¤ä¸ªæ–¹æ³•ï¼šswitchOn()ä»¥åŠswitchOff()ï¼Œä»¥ä¾¿ç”¨æˆ·è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Switcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">//falseä»£è¡¨å…³ï¼Œtrueä»£è¡¨å¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> state = <span class="keyword">false</span>;<span class="comment">//åˆå§‹çŠ¶æ€æ˜¯å…³</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state = !state;</span><br><span class="line">        System.out.println(<span class="string">&quot;OK...ç¯äº®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state = !state;</span><br><span class="line">        System.out.println(<span class="string">&quot;OK...ç¯ç­&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£è®¾è®¡å®Œæˆï¼Œæ²¡æœ‰é—®é¢˜äº†ï¼ï¼å½“ç„¶è¯´è¿™ä¸ªæ²¡é—®é¢˜æ˜¯åœ¨å‰ç«¯UIå£³å­è®¾è®¡ç²¾å¦™çš„å‰æä¸‹ï¼Œä½†è¿™<strong>å¹¶ä¸èƒ½ä»£è¡¨æˆ‘ä»¬çš„ç¨‹åºè®¾è®¡æ²¡é—®é¢˜ã€‚</strong>å¦‚æœUIå¯ä»¥é‡å¤è°ƒç”¨å¼€æˆ–è€…å…³ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼ŸçŠ¶æ€ä¹±å¥—äº†ï¼è¿™ä¸ªè®¾è®¡æ˜¯éå¸¸ä¸å¯é çš„ï¼Œæˆ‘ä»¬ä¸èƒ½å› ä¸ºè¡¨é¢è®¾è®¡ä¸Šçš„å®Œç¾å°±å¿½ç•¥äº†åç«¯ä»£ç åŠŸèƒ½çš„é€»è¾‘æ­£ç¡®æ€§ï¼Œè¡¨é‡Œä¸ä¸€ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åšåº”ç”¨æ—¶ä¸ä½†è¦åšå¥½å‰ç«¯æ ¡éªŒï¼ˆ<strong>ç”¨æˆ·ä½“éªŒ</strong>ï¼‰ï¼Œæ›´è¦ä¿è¯åç«¯æ ¡éªŒï¼ˆ<strong>åŠŸèƒ½æ­£ç¡®æ€§</strong>ï¼‰ä¸å¯ç¼ºå¤±ã€‚</p><p>æ”¹ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çš„è®¾è®¡ï¼Œè¿™é‡Œä¸€å®šè¦åŠ å…¥é’ˆå¯¹å½“å‰çŠ¶æ€çš„æ¡ä»¶åˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€çš„çŠ¶æ€ä¸èƒ½å†å¼€ï¼Œå…³çš„çŠ¶æ€ä¸èƒ½å†å…³ï¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Switcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">//falseä»£è¡¨å…³ï¼Œtrueä»£è¡¨å¼€</span></span><br><span class="line">    <span class="keyword">boolean</span> state = <span class="keyword">false</span>;<span class="comment">//åˆå§‹çŠ¶æ€æ˜¯å…³</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(state == <span class="keyword">false</span>)&#123;<span class="comment">//å½“å‰æ˜¯å…³çŠ¶æ€</span></span><br><span class="line">            state = <span class="keyword">true</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;OK...ç¯äº®&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">//å½“å‰æ˜¯å¼€çŠ¶æ€</span></span><br><span class="line">            System.out.println(<span class="string">&quot;WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(state == <span class="keyword">true</span>)&#123;<span class="comment">//å½“å‰æ˜¯å¼€çŠ¶æ€</span></span><br><span class="line">            state = <span class="keyword">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;OK...ç¯ç­&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">//å½“å‰æ˜¯å…³çŠ¶æ€</span></span><br><span class="line">            System.out.println(<span class="string">&quot;WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŠ å…¥äº†é€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœé‡å¤å¼€æˆ–è€…é‡å¤å…³çš„è¯æ˜¯ä¼šå‘Šè­¦çš„ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥æŠ›å¼‚å¸¸å‡ºå»ï¼Œæˆ‘ä»¬å°±ä¸æé‚£ä¹ˆå¤æ‚åŒ–äº†ã€‚é‚£å¯¹äºè¿™æ ·çš„è®¾è®¡æ²¡æœ‰é—®é¢˜å§ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œé€»è¾‘ä¸Šæ˜¯è·‘çš„é€šçš„ï¼Œå†™ä¸ªClientç±»æµ‹è¯•ä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Switcher s = <span class="keyword">new</span> Switcher();</span><br><span class="line">        s.switchOff();<span class="comment">//WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³</span></span><br><span class="line">        s.switchOn();<span class="comment">//OK...ç¯äº®</span></span><br><span class="line">        s.switchOff();<span class="comment">//OK...ç¯ç­</span></span><br><span class="line">        s.switchOn();<span class="comment">//OK...ç¯äº®</span></span><br><span class="line">        s.switchOn();<span class="comment">//WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So farï¼Œä¸ç®¡ç†Šå­©å­æ€ä¹ˆå¼€å¼€å…³å…³éƒ½ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚</p><h3 id="è‡ªåŠ¨æŒ¡"><a href="#è‡ªåŠ¨æŒ¡" class="headerlink" title="è‡ªåŠ¨æŒ¡"></a>è‡ªåŠ¨æŒ¡</h3><blockquote><p>è¿™æ ·çš„è®¾è®¡ä»ç„¶æ˜¯ç³Ÿç³•çš„ã€‚è¯•æƒ³ï¼Œå¦‚æœçŠ¶æ€ä¸æ­¢ä¸€ç§ï¼Œå¹¶ä¸”çŠ¶æ€åˆ‡æ¢æœ‰åŠå…¶å¤æ‚çš„é€»è¾‘ï¼Œä¾‹å¦‚ï¼šæ±½è½¦çš„è‡ªåŠ¨æŒ¡ã€‚</p></blockquote><p>æ±½è½¦çš„è‡ªåŠ¨æŒ¡ï¼ŒæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘æ¥è®¾è®¡ï¼Œå°±åƒå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="comment">//0ï¼šParké©»è½¦æ¡£ï¼Œ1ï¼šReverseå€’é€€æŒ¡ï¼Œ</span></span><br><span class="line">    <span class="comment">//2ï¼šNeutralç©ºæŒ¡ï¼Œ3ï¼šDriveå‰è¿›æ¡£ã€‚</span></span><br><span class="line">    String state = <span class="string">&quot;P&quot;</span>;<span class="comment">//åˆå§‹çŠ¶æ€æ˜¯Pæ¡£</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">()</span></span>&#123;<span class="comment">//å‘ä¸Šæ¨æ¡£æ†</span></span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;P&quot;</span>:<span class="comment">//é©»è½¦æ¡£çŠ¶æ€</span></span><br><span class="line">            System.out.println(<span class="string">&quot;WARN!!!åˆ°å¤´äº†æ¨ä¸åŠ¨äº†ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;R&quot;</span>:<span class="comment">//å€’æŒ¡çŠ¶æ€</span></span><br><span class="line">            state = <span class="string">&quot;P&quot;</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;OK...åˆ‡Pæ¡£&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;N&quot;</span>:<span class="comment">//ç©ºæ¡£çŠ¶æ€</span></span><br><span class="line">            System.out.println(<span class="string">&quot;OK...åˆ‡Ræ¡£&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;D&quot;</span>:<span class="comment">//å‰è¿›æ¡£çŠ¶æ€</span></span><br><span class="line">            System.out.println(<span class="string">&quot;OK...åˆ‡Næ¡£&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pull</span><span class="params">()</span></span>&#123;<span class="comment">//å‘ä¸‹æ‹‰æ¡£æ†</span></span><br><span class="line">        <span class="comment">//è¿™é‡Œçœç•¥ï¼Œé€»è¾‘åŒä¸Šç±»ä¼¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯åœ¨<strong>ä½œæ­»</strong>äº†ï¼Œé‚£ä¸€å¤§å †é€»è¾‘åˆ¤æ–­å†™åœ¨å®¿ä¸»ç±»é‡Œä¼šè¶Šæ¥è¶Šåƒèœ˜è››ç½‘ï¼æˆ‘ä»¬å¿…é¡»æƒ³æ–¹è®¾æ³•æŠŠè¿™ä¸ªè®¾è®¡ç»™æ¨¡å—åŒ–ï¼ŒæŠŠçŠ¶æ€æ¨¡å—ç»™ç‹¬ç«‹å‡ºæ¥ï¼å¯ä»¥ä½¿ç”¨<a href="/2019/02/26/2019022601/">ç­–ç•¥æ¨¡å¼</a>ï¼Œå°†ç®—æ³•ç­–ç•¥è¢«æŠ½ç¦»å‡ºæ¥ï¼Œè¿™é‡Œä¸¾ä¸€åä¸‰ï¼ŒæŠŠçŠ¶æ€ä¹Ÿç»™æŠ½ç¦»å‡ºæ¥ï¼Œå¥½äº†åŠæ³•æœ‰äº†ï¼Œæˆ‘ä»¬å¿˜æ‰è‡ªåŠ¨æŒ¡ï¼Œç»§ç»­ç”¨æˆ‘ä»¬å¤§é“è‡³ç®€çš„å¼€å…³ä¾‹å­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">(Switcher switcher)</span></span>;<span class="comment">//å¼€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">(Switcher switcher)</span></span>;<span class="comment">//å…³</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæˆ‘ä»¬é¦–å…ˆäº†å®šä¹‰ä¸€ä¸ªçŠ¶æ€Stateæ¥å£ï¼Œä¸¤ä¸ªæ–¹æ³•å¼€ä¸å…³ï¼Œæ³¨æ„è¿™é‡Œä¸ç­–ç•¥æ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸ºäº†ä¸å®¿ä¸»Switcherå¯¹æ¥æ‰€ä»¥æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ç„¶åæ˜¯å¼€çŠ¶æ€ä¸å…³çŠ¶æ€çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">On</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">(Switcher switcher)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">(Switcher switcher)</span> </span>&#123;</span><br><span class="line">        switcher.setState(<span class="keyword">new</span> Off());</span><br><span class="line">        System.out.println(<span class="string">&quot;OK...ç¯ç­&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Off</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">(Switcher switcher)</span> </span>&#123;</span><br><span class="line">        switcher.setState(<span class="keyword">new</span> On());</span><br><span class="line">        System.out.println(<span class="string">&quot;OK...ç¯äº®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">(Switcher switcher)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§ï¼Œæ³¨æ„çœ‹ç¬¬10è¡Œä»£ç ï¼Œå¼€çŠ¶æ€ä¸èƒ½åšå¼€è¡Œä¸ºï¼Œåªå‘Šè­¦å¹¶è¿”å›ï¼Œå…³çŠ¶æ€åä¹‹äº¦ç„¶ã€‚è€Œç¬¬4è¡Œä»£ç åˆ™æ˜¯åˆæ³•çš„è¡Œä¸ºï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡ŒçŠ¶æ€åˆ‡æ¢å¹¶å®æ–½ç›¸åº”è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€çŠ¶æ€å¯å…³ï¼Œå…³çŠ¶æ€å¯å¼€ã€‚æ³¨æ„è¿™é‡Œæ˜¯æŠŠå®¿ä¸»å¯¹è±¡ä¼ å…¥è¿›æ¥ç”¨äºåˆ‡æ¢å…¶å½“å‰çŠ¶æ€ï¼Œäº¦æˆ–æ˜¯è°ƒç”¨å®¿ä¸»çš„å…·ä½“åŠŸèƒ½æ–¹æ³•ï¼ˆè¿™é‡Œçœç•¥ç”¨æ‰“å°è¾“å‡ºä»£æ›¿ï¼‰ï¼Œæ¯”å¦‚å®¿ä¸»é‡Œçš„ä¸€ç›ç¯æä¾›çš„æ–¹æ³•ã€‚</p><p>è‡³æ­¤ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éå¸¸ä¼˜é›…ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸçš„å°†çŠ¶æ€ä»å®¿ä¸»ä¸­æŠ½ç¦»äº†ï¼Œæœ€åå†æ¥çœ‹å®¿ä¸»å¼€å…³ç±»æ˜¯ä»€ä¹ˆæ ·å­ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Switcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¼€å…³çš„åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºâ€œå…³â€</span></span><br><span class="line">    <span class="keyword">private</span> State state = <span class="keyword">new</span> Off();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state.switchOn(<span class="keyword">this</span>);<span class="comment">//è¿™é‡Œè°ƒç”¨çš„æ˜¯å½“å‰çŠ¶æ€çš„å¼€æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state.switchOff(<span class="keyword">this</span>);<span class="comment">//è¿™é‡Œè°ƒç”¨çš„æ˜¯å½“å‰çŠ¶æ€çš„å…³æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”šè‡³æˆ‘ä»¬è¿˜å¯ä»¥ç»™é‡Œé¢åŠ ä¸€ç›ç¯ï¼Œåƒä¹‹å‰æˆ‘ä»¬æåˆ°çš„é‚£æ ·ï¼Œåœ¨StateçŠ¶æ€æ¥å£å®ç°é‡Œå»è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Switcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...ä¹‹ä¸Šä»£ç ç•¥...</span></span><br><span class="line">    <span class="keyword">private</span> Lamp lamp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lampOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        lamp.on();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lampOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">        lamp.off();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å®ƒå°±æ˜¯ç­–ç•¥çš„ä¸€ä¸ªå˜ç§ï¼Œåªä¸è¿‡<strong>çŠ¶æ€æ¨¡å¼ä¼šæ›´å¥½çš„æ ¹æ®å½“å‰çš„çŠ¶æ€å»å®æ–½ä¸åŒçš„è¡Œä¸ºï¼Œå¹¶ä¸”è‡ªä¸»åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼Œå¼€å˜å…³ï¼Œå…³å˜å¼€ã€‚</strong>å°±å¥½ä¼¼ç”µæ¢¯ï¼ˆè™½ç„¶æ˜¯åµŒå…¥å¼é¢å‘è¿‡ç¨‹ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ï¼‰ï¼Œç”¨æˆ·æ ¹æœ¬æ— æ³•éšæ„å¼ºåˆ¶æ›´æ”¹å…¶çŠ¶æ€ä»¥åŠè¡Œä¸ºï¼Œä½ è®©å®ƒä¸Šï¼Œå®ƒä¸ä¸€å®šé©¬ä¸Šå°±èƒ½ä¸Šï¼Œå¦åˆ™ä¼šé€ æˆäº‹æ•…ã€‚ç”µæ¢¯å†…éƒ¨å°è£…äº†å¤šä¸ªçŠ¶æ€ä»¥åŠå¯¹åº”çš„é€»è¾‘äº§ç”Ÿä¸åŒçš„è¡Œä¸ºï¼Œå®ƒä¼šæ ¹æ®å½“å‰çŠ¶æ€å»è‡ªæˆ‘è°ƒæ•´å¹¶å®æ–½æœ€ä¼˜æ–¹æ¡ˆï¼Œä»¥è¾¾åˆ°å®‰å…¨ã€é«˜æ•ˆçš„ç›®çš„ï¼Œè¿™æ‰æ˜¯å¯é çš„è®¾è®¡ã€‚</p><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong>åœ¨è¡Œä¸ºå—çŠ¶æ€çº¦æŸçš„æ—¶å€™ä½¿ç”¨çŠ¶æ€æ¨¡å¼ï¼Œè€Œä¸”çŠ¶æ€ä¸è¶…è¿‡ 5 ä¸ªã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹ç­–ç•¥æ¨¡å¼</title>
      <link href="/blog/2019/02/26/a7a792e2.html"/>
      <url>/blog/2019/02/26/a7a792e2.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>è®¾è®¡æ¨¡å¼</code>ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p></blockquote><h2 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h2><p>åœ¨ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰ä¸­ï¼Œä¸€ä¸ªç±»çš„è¡Œä¸ºæˆ–å…¶ç®—æ³•å¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚</p><p>åœ¨ç­–ç•¥æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºè¡¨ç¤ºå„ç§ç­–ç•¥çš„å¯¹è±¡å’Œä¸€ä¸ªè¡Œä¸ºéšç€ç­–ç•¥å¯¹è±¡æ”¹å˜è€Œæ”¹å˜çš„ context å¯¹è±¡ã€‚ç­–ç•¥å¯¹è±¡æ”¹å˜ context å¯¹è±¡çš„æ‰§è¡Œç®—æ³•ã€‚</p><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><blockquote><p>ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆç­–ç•¥ï¼‰</p></blockquote><h3 id="è®¡ç®—å™¨"><a href="#è®¡ç®—å™¨" class="headerlink" title="è®¡ç®—å™¨"></a>è®¡ç®—å™¨</h3><p>å®ç°ä¸€ä¸ªæœ€ç®€å•çš„è®¡ç®—å™¨ï¼Œå‡è®¾åªèƒ½è¿›è¡ŒåŠ å‡æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> </span>&#123;<span class="comment">//è¿åè®¾è®¡æ¨¡å¼åŸåˆ™çš„åšæ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;<span class="comment">//åŠ æ³•</span></span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;<span class="comment">//å‡æ³•</span></span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å†™èƒ½å®ç°æˆ‘ä»¬çš„åŠ å‡æ³•åŠŸèƒ½ï¼Œä½†æ˜¯å¾€æ‹“å±•æ–¹é¢æƒ³ï¼Œå¦‚æœéšç€æˆ‘ä»¬çš„ç®—æ³•ä¸æ–­å¢åŠ ï¼Œå¦‚ä¹˜æ³•ã€é™¤æ³•ã€æ¬¡æ–¹ã€å¼€æ–¹ç­‰ç­‰ï¼Œé‚£ä¹ˆè¿™ä¸ªè®¡ç®—å™¨ç±»å°±å¾—ä¸æ–­çš„æ”¹å•Šæ”¹å•Šï¼Œæ”¹åˆ°æœ€åè¿™ä¸ªç±»çš„ä»£ç å°†ä¼šéå¸¸åºå¤§ã€‚ã€‚</p><h3 id="æŠ½è±¡"><a href="#æŠ½è±¡" class="headerlink" title="æŠ½è±¡"></a>æŠ½è±¡</h3><p>æ—¢ç„¶ä¸èƒ½æŠŠç®—æ³•ç»™å†™æ­»åœ¨è¿™é‡Œé¢ï¼Œé‚£ä¸€å®šè¦æŠŠè¿™ä¸ªç®—æ³•ç»™æŠ½è±¡ä¸€ä¸‹ï¼Œ<strong>æŠŠå®ç°ç»†èŠ‚ä»è¿™ä¸ªç±»é‡ŒæŠ½ç¦»å‡ºæ¥ï¼Œç‹¬ç«‹å‡ºæ¥æˆä¸ºnä¸ªç­–ç•¥ï¼Œ</strong>å°±å½“ä¸‹æ¥è®²æˆ‘ä»¬ä¸€å…±æœ‰ä¿©ä¸ªç­–ç•¥ï¼Œä¸€ä¸ªæ˜¯åŠ æ³•ç­–ç•¥ï¼Œä¸€ä¸ªæ˜¯å‡æ³•ç­–ç•¥ï¼Œä»–ä»¬å®ç°çš„éƒ½æ˜¯åŒä¸€ä¸ªç®—æ³•æ¥å£ï¼Œæ¥æ”¶å‚æ•°ä¸ºæ“ä½œæ•°aï¼Œä»¥åŠè¢«æ“ä½œæ•°bã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;<span class="comment">//ç®—æ³•æ ‡å‡†</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;<span class="comment">//æ“ä½œæ•°ï¼Œè¢«æ“ä½œæ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="åŠ æ³•"><a href="#åŠ æ³•" class="headerlink" title="åŠ æ³•"></a>åŠ æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Addition</span> <span class="keyword">implements</span> <span class="title">Strategy</span></span>&#123;<span class="comment">//å®ç°ç®—æ³•æ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;<span class="comment">//åŠ æ•°ä¸è¢«åŠ æ•°</span></span><br><span class="line">        <span class="keyword">return</span> a + b;<span class="comment">//è¿™é‡Œæˆ‘ä»¬åšåŠ æ³•è¿ç®—</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡æ³•"><a href="#å‡æ³•" class="headerlink" title="å‡æ³•"></a>å‡æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subtraction</span> <span class="keyword">implements</span> <span class="title">Strategy</span></span>&#123;<span class="comment">//å®ç°ç®—æ³•æ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;<span class="comment">//å‡æ•°ä¸è¢«å‡æ•°</span></span><br><span class="line">        <span class="keyword">return</span> a - b;<span class="comment">//è¿™é‡Œæˆ‘ä»¬åšå‡æ³•è¿ç®—</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°è®¡ç®—å™¨"><a href="#å®ç°è®¡ç®—å™¨" class="headerlink" title="å®ç°è®¡ç®—å™¨"></a>å®ç°è®¡ç®—å™¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> </span>&#123;<span class="comment">//è®¡ç®—å™¨ç±»</span></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;<span class="comment">//æ‹¥æœ‰æŸç§ç®—æ³•ç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStrategy</span><span class="params">(Strategy strategy)</span> </span>&#123;<span class="comment">//æ¥å…¥ç®—æ³•ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.strategy.calculate(a, b);<span class="comment">//è¿”å›å…·ä½“ç­–ç•¥çš„ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—å™¨ç±»é‡Œå·²ç»æŠŠä¹‹å‰çš„å…·ä½“åŠ å‡ç®—æ³•å®ç°ä»£ç ç»™å‰¥ç¦»å‡ºå»äº†ï¼Œè¦ç”¨å“ªä¸ªç®—æ³•ï¼Œåªéœ€è¦æ³¨å…¥è¿›æ¥ï¼Œç„¶åè·å¾—è®¡ç®—ç»“æœgetResultå®é™…ä¸Šè°ƒç”¨çš„æ˜¯å…·ä½“ç®—æ³•çš„calculateã€‚</p><h4 id="ä½¿ç”¨è®¡ç®—å™¨"><a href="#ä½¿ç”¨è®¡ç®—å™¨" class="headerlink" title="ä½¿ç”¨è®¡ç®—å™¨"></a>ä½¿ç”¨è®¡ç®—å™¨</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Calculator calculator = <span class="keyword">new</span> Calculator();<span class="comment">//å®ä¾‹åŒ–è®¡ç®—å™¨</span></span><br><span class="line">        calculator.setStrategy(<span class="keyword">new</span> Addition());<span class="comment">//æ¥å…¥åŠ æ³•å®ç°</span></span><br><span class="line">        <span class="keyword">int</span> result = calculator.getResult(<span class="number">1</span>, <span class="number">1</span>);<span class="comment">//è®¡ç®—ï¼</span></span><br><span class="line">        System.out.println(result);<span class="comment">//å¾—åˆ°çš„æ˜¯åŠ æ³•ç»“æœ2</span></span><br><span class="line"></span><br><span class="line">        calculator.setStrategy(<span class="keyword">new</span> Subtraction());<span class="comment">//å†æ¬¡æ¥å…¥å‡æ³•å®ç°</span></span><br><span class="line">        result = calculator.getResult(<span class="number">1</span>, <span class="number">1</span>);<span class="comment">//è®¡ç®—ï¼</span></span><br><span class="line">        System.out.println(result);<span class="comment">//å¾—åˆ°çš„æ˜¯å‡æ³•ç»“æœ0</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè®¡ç®—å™¨å¯ä»¥è¯´æ˜¯å…·æœ‰ç®—æ³•ç­–ç•¥æ‰©å±•æ€§çš„ï¼Œä»¥åè¦æœ‰æ–°çš„ç®—æ³•æ˜¯ä¸éœ€è¦å†æ›´æ”¹ä»»ä½•ç°æœ‰ä»£ç çš„ï¼Œåªéœ€è¦æ–°å†™ä¸€ä¸ªç®—æ³•æ¯”å¦‚ä¹˜æ³•Multiplicationï¼Œå¹¶å®ç°calculateæ–¹æ³•ï¼Œæ¥ä¸‹æ¥è¦åšçš„åªæ˜¯ç»„è£…ä¸Šå»ä¾¿å¯ä»¥ä½¿ç”¨äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç­–ç•¥å®ç°ç±»å·²ç»æˆä¸ºç‹¬ç«‹äºå®¿ä¸»ä¹‹å¤–çš„æ¨¡å—ï¼Œå³æ’å³ç”¨ã€‚å¯ä»¥ç»„åˆæˆä¸ºä¸€ä¸ªæ•´ä½“ï¼Œåˆå¯ä»¥åˆ†æ‹†ç‹¬ç«‹ï¼Œå¯ä»¥å‘ç”Ÿå…³è”ï¼Œä½†ç»ä¸è€¦åˆï¼Œæ—¢å¯¹ç«‹åˆç»Ÿä¸€ï¼Œè¿™æ˜¯å”¯ç‰©è¾©è¯æ³•çš„ç»ä½³ä½“ç°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹é€‚é…å™¨æ¨¡å¼</title>
      <link href="/blog/2019/02/25/8ac957b9.html"/>
      <url>/blog/2019/02/25/8ac957b9.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>è®¾è®¡æ¨¡å¼</code>ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p></blockquote><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><blockquote><p>ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé€‚é…å™¨ï¼‰</p></blockquote><p>é¡¾åæ€ä¹‰ï¼Œé€‚é…å™¨ï¼Œå¾—é€‚åº”å½“å‰çš„ä¸åŒé…ç½®ï¼Œè§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚æˆ‘ä»¬ç”Ÿæ´»ä¸­å……æ»¡äº†å„ç§å„æ ·çš„é€‚é…å™¨ï¼Œä¸Šç½‘ç”¨çš„è°ƒåˆ¶è§£è°ƒå™¨(modem)å°±æ˜¯ä¸€ç§æ•°æ¨¡è½¬æ¢çš„é€‚é…å™¨ï¼Œä¿—ç§°â€œçŒ«â€ï¼Œä¸è¿‡ç°åœ¨éƒ½æ˜¯å…‰çŒ«äº†ï¼Œä¹Ÿå°±æ˜¯å…‰ä¿¡å·å’Œç”µä¿¡å·çš„äº’ç›¸è½¬åŒ–ï¼Œå…¶å®é“ç†æ˜¯ä¸€æ ·çš„ï¼Œè¿˜æœ‰å„ç§å˜å‹å™¨ä¹Ÿå±äºç”µå‹è½¬æ¢çš„é€‚é…å™¨ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/25/1.png" alt="é€‚é…å™¨"></p><p>å¦‚æœè§‰å¾—è¿˜ä¸å¤Ÿå½¢è±¡å¯ä»¥çœ‹ä¸€ä¸‹å®¶é‡Œçš„ç”µå™¨ï¼Œæ¯”å¦‚ä½ çš„ç”µè§†æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå¢™ä¸Šçš„æ’å­”æ˜¯ä¸‰é¡¹æ’å­”æ€ä¹ˆåŠï¼Ÿå“¦ï¼Œæœ‰äººè¯´æŠŠæ’å¤´æ°å¼¯å¼ºè¡Œæ’å…¥ï¼é‚£å¦‚æœæ˜¯ä¸‰é¡¹æ’å¤´æ¥ä¸¤é¡¹æ’å­”å‘¢ï¼ŸæŠŠé›¶çº¿æ’é’ˆæ‹”äº†ï¼å‘ƒï¼Œæˆ‘åªèƒ½è¯´è¿™æ˜¯æš´åŠ›ç ´è§£ï¼è¿åè®¾è®¡æ¨¡å¼åŸåˆ™ã€‚è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸è¦éšä¾¿ç ´åç°æœ‰çš„ç±»ï¼Œé‚£æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œç”¨ä¼˜é›…å¾®å¦™çš„æ–¹å¼åŒ–è§£è¿™ç§ä¸å…¼å®¹æƒ…å†µã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/25/2.png" alt="é€‚é…å™¨"></p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¼€å§‹ä»£ç éƒ¨åˆ†ï¼Œå…ˆå†™å¢™ä¸Šçš„ä¸‰é¡¹æ’å­”æ¥å£ï¼Œå‘½å<code>TriplePin</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TriplePin</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å‚æ•°åˆ†åˆ«ä¸ºç«çº¿liveï¼Œé›¶çº¿nullï¼Œåœ°çº¿earth</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrify</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> n, <span class="keyword">int</span> e)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªå®šä¹‰ä¸‰æ’å­”æ ‡å‡†<code>electrify</code>ï¼ˆé€šç”µï¼‰æ–¹æ³•ï¼Œä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç«çº¿ã€é›¶çº¿ã€åœ°çº¿ï¼Œå¾ˆç®€å•å§ï¼ŒåŒæ ·åœ°æ¥ä¸‹æ¥æ˜¯ä¸¤é¡¹æ’å­”æ¥å£ï¼Œåªæ˜¯å°‘äº†åœ°çº¿ï¼Œå‘½å<code>DualPin</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DualPin</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrify</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> n)</span></span>;<span class="comment">//è¿™é‡Œæ²¡æœ‰åœ°çº¿</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯æˆ‘ä»¬çš„å¢™ä¸Šçš„ç›®æ ‡æ¥å£ï¼Œè€Œæ˜¯ç”µè§†æœºçš„ä¸¤æ’æ ‡å‡†ã€‚å¥½äº†ç»§ç»­ï¼Œæˆ‘ä»¬çš„<code>TV</code>ç™»åœºäº†ï¼Œç”¨çš„æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå½“ç„¶å®ƒå®ç°çš„æ˜¯<code>DualPin</code>çš„æ ‡å‡†ï¼Œ<code>Let&#39;s keep it simple</code>ï¼Œå‘½å<code>TV</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TV</span> <span class="keyword">implements</span> <span class="title">DualPin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//æ—¢ç„¶æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå½“ç„¶å®ç°ä¸¤é¡¹æ’æ ‡å‡†</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrify</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç«çº¿é€šç”µï¼š&quot;</span> + l);</span><br><span class="line">        System.out.println(<span class="string">&quot;é›¶çº¿é€šç”µï¼š&quot;</span> + n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¢™ä¸Šçš„æ¥å£æ˜¯ä¸‰æ’æ ‡å‡†ï¼Œç”µè§†å®ç°çš„æ˜¯ä¸¤æ’æ ‡å‡†ï¼Œæ— æ³•é€šç”µã€‚æ€ä¹ˆåŠï¼ŸæŠŠç”µè§†æ‹†äº†é‡æ–°ä¿®æ”¹å®ç°ä¸‰æ’æ ‡å‡†ä¹ˆï¼Ÿæš´åŠ›ä»½å­ä½ åˆæ¥ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯å¦å®šçš„ï¼Œæ—¢ç„¶æ˜¯è®¾è®¡æ¨¡å¼ï¼Œæœæ–­è½¬æ¢æ’å¤´å•Šï¼å¥½ï¼Œå†™ä¸ª<code>Adapter</code>è§£å†³ä»–ä»¬ä¹‹é—´ä¸å¯è°ƒå’Œçš„çŸ›ç›¾ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">TriplePin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DualPin dualPinDevice; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºé€‚é…å™¨åœ°æ—¶å€™ï¼Œéœ€è¦æŠŠåŒæ’è®¾å¤‡æ¥å…¥è¿›æ¥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Adapter</span><span class="params">(DualPin dualPinDevice)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dualPinDevice = dualPinDevice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€‚é…å™¨å®ç°çš„æ˜¯ç›®æ ‡æ¥å£</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrify</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> n, <span class="keyword">int</span> e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å®é™…ä¸Šè°ƒç”¨äº†è¢«é€‚é…è®¾å¤‡çš„åŒæ’é€šç”µï¼Œåœ°çº¿eè¢«ä¸¢å¼ƒäº†ã€‚</span></span><br><span class="line">        dualPinDevice.electrify(l, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„äº†æœ€å…³é”®æœ€ç²¾åçš„éƒ¨åˆ†æ¥äº†ï¼Œ<code>private DualPin dualPinDevice; </code>ä»£ç æ„å‘³ç€è¿™ä¸ªé€‚é…å™¨å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ªåŒæ’æ¥å£çš„ï¼Œå¯¹äºä»»ä½•åŒæ’æ ‡å‡†çš„è®¾å¤‡éƒ½æ˜¯å¯ä»¥å…¼å®¹çš„OKå—ï¼Ÿä¸æ˜ç™½èµ¶ç´§çœ‹çœ‹ä½ å®¶é‡Œçš„é€‚é…å™¨ã€‚<code>public Adapter(DualPin dualPinDevice) &#123;...&#125;</code>æ–¹æ³•çš„ä»£ç å®Œæˆçš„è¿‡ç¨‹å®é™…å°±æ˜¯ä½ æŠŠç”µè§†æ’å¤´æ¥å…¥<code>Adapter</code>äº†ï¼Œå…¶å®é€‚é…å™¨å¹¶ä¸åœ¨æ„æ˜¯ä»€ä¹ˆè®¾å¤‡ï¼Œæ´—è¡£æœºå†°ç®±éƒ½å¯ä»¥çš„ï¼Œåªè¦æ˜¯åŒæ’æ ‡å‡†å°±å¯ä»¥æ¥å…¥ï¼ˆç¬¬ä¸€èŠ‚è®²è¿‡çš„å¤šæ€æ¦‚å¿µï¼‰ã€‚<code>electrify()</code>é€šç”µæ–¹æ³•å®ç°çš„æ˜¯ä¸‰æ’æ ‡å‡†ï¼Œä½†æ–¹æ³•ä½“å†…éƒ¨<code>dualPinDevice.electrify(l, n);</code>å®é™…ä¸Šæ˜¯åœ¨ç»™â€œæŸä¸ªè®¾å¤‡â€ï¼ˆæ˜¯ä»€ä¹ˆè®¾å¤‡å°±çœ‹ä½ æ¥ä»€ä¹ˆäº†ï¼‰çš„åŒæ’ä¾›ç”µï¼Œåœ°çº¿eé‚£ä¸ªå‚æ•°æ˜¯ç”¨ä¸ä¸Šçš„ï¼Œæ‰€ä»¥å°±æ²¡æœ‰æ¥é€šï¼Œå¾ˆæ¸…æ™°é€å½»å§ï¼Ÿ</p><p>å½“ç„¶ï¼Œé™¤äº†ä»¥ä¸Šçš„æ³¨å…¥æ’å¤´çš„æ–¹å¼ï¼ˆå¯¹è±¡é€‚é…ï¼‰ï¼Œè¿˜æœ‰å¦ä¸€ç§æ›´ç®€å•çš„æ–¹å¼å«åšâ€œç±»é€‚é…å™¨â€æˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassAdapter</span> <span class="keyword">extends</span> <span class="title">TV</span> <span class="keyword">implements</span> <span class="title">TriplePin</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">electrify</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> n, <span class="keyword">int</span> e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.electrify(l, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹å‡ºæ¥åŒºåˆ«æ²¡æœ‰ï¼Ÿè¿™é‡Œå¹¶æ²¡æœ‰æ³¨å…¥æ’å¤´ï¼ˆå¯¹è±¡ç»„åˆï¼‰ï¼Œè€Œæ˜¯æŠŠç”µè§†æœºç»™ç»§æ‰¿äº†ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨çˆ¶ç±»ï¼ˆTVï¼‰çš„åŒæ’é€šç”µè€Œä¸æ˜¯æ³¨å…¥è¿›æ¥å»è°ƒç”¨ï¼Œç¼ºç‚¹å¤§å®¶ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™é€‚é…å™¨ç»§æ‰¿ä¸ºTVå„¿å­ä¸“ç”¨äº†ï¼Œæ´—è¡£æœºæ˜¯ç”¨ä¸äº†å•¦ï¼Œä½œæ­»ï¼Ÿå…¶å®ä¹Ÿä¸æ˜¯å®Œå…¨ä¸å¥½ï¼Œè¦çœ‹å…·ä½“åº”ç”¨åœºæ™¯å“ˆã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„<code>Adapter</code>å°±å·®ä¸å¤šå®Œæˆäº†ï¼Œä»¥åå†ä¹Ÿä¸ç”¨ç ´åæ’å¤´äº†ï¼Œå› ä¸ºè¿™æ ·é‡å†™æ¥å£æˆ–è€…ä¿®æ”¹ç±»çš„ä»£ä»·å¤ªå¤§ï¼Œå¦‚æœå…¶ä»–ç±»è¿˜æœ‰ä¾èµ–çš„è¯ï¼Œé‚£ç»Ÿç»Ÿè¦ä¿®æ”¹ï¼Œå¼•å…¥äº†æ²¡æœ‰å¿…è¦çš„é‡æ„ï¼Œæ€»ä¹‹æš´åŠ›ä¿®æ”¹æ˜¯è¿åè®¾è®¡æ¨¡å¼çš„åŸºæœ¬åŸåˆ™çš„ï¼Œå¼€é—­åŸåˆ™ï¼ŒæŒ‡çš„å°±æ˜¯å¯¹æ‰©å±•å¼€æ”¾ï¼Œè€Œå¯¹ä¿®æ”¹å…³é—­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¦å»æ”¹åŠ¨åŸå§‹ç±»ï¼Œè€Œæ˜¯æ‰©å±•ç°æœ‰åŠŸèƒ½ï¼Œæä¾›å¦ä¸€ç§æœºåˆ¶è®©æ•´ä¸ªç³»ç»Ÿå®ç°æƒ³è¦çš„åŠŸèƒ½ã€‚</p><p>æœ€åè¯´ä¸‹é‚£äº›æ¦‚å¿µï¼Œå½’ç±»ï¼Œåå­—ï¼Œä»€ä¹ˆâ€œç±»é€‚é…å™¨â€ï¼Œâ€œå¯¹è±¡é€‚é…å™¨â€å•Šï¼Œå…¶å®ï¼Œç†è§£ä¸äº†å°±ç®—äº†æ— æ‰€è°“ï¼ŒçœŸæ­£çš„æ„ä¹‰åœ¨äºæ€ä¹ˆæ ·åœ¨å®é™…å·¥ä½œä¸­çµæ´»è¿ç”¨ï¼Œå®ç°æ–¹å¼æ˜¯æ— ç©·æ— å°½çš„ï¼Œé“ä¸æ¸…è¯´ä¸å°½çš„ï¼Œæ²¡å¿…è¦å¤ªçº ç»“å®ƒåˆ°åº•å«ä»€ä¹ˆï¼Œå½’äºå“ªä¸€ç±»ï¼ŒæŒæ§å…¶èƒŒåçš„é“æ‰æ˜¯æœ€æ ¹æœ¬çš„ï¼Œæ­£å¦‚æè€³å›æ‰€è¨€ï¼šâ€œé“å¯é“ï¼Œéå¸¸é“ã€‚åå¯åï¼Œéå¸¸åã€‚â€</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼</title>
      <link href="/blog/2019/02/20/242438ad.html"/>
      <url>/blog/2019/02/20/242438ad.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>è®¾è®¡æ¨¡å¼</code>ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p></blockquote><h2 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><p>å•ä¾‹æ¨¡å¼ï¼ˆ<code>Singleton Pattern</code>ï¼‰æ˜¯ <code>Java</code> ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚</p><p>è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚</p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><ul><li>1ã€å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚</li><li>2ã€å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚</li><li>3ã€å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚</li></ul><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>æ„å›¾ï¼š</strong>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚</p><p><strong>ä¸»è¦è§£å†³ï¼š</strong>ä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯ã€‚</p><p><strong>ä½•æ—¶ä½¿ç”¨ï¼š</strong>å½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™ã€‚</p><p><strong>å¦‚ä½•è§£å†³ï¼š</strong>åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºã€‚</p><p><strong>å…³é”®ä»£ç ï¼š</strong>æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚</p><h2 id="å®ä¾‹åº”ç”¨"><a href="#å®ä¾‹åº”ç”¨" class="headerlink" title="å®ä¾‹åº”ç”¨"></a>å®ä¾‹åº”ç”¨</h2><blockquote><p>ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆå•ä¾‹ï¼‰</p></blockquote><p>å•ä¾‹ï¼Œé¡¾åæ€ä¹‰ï¼Œæ•´ä¸ªç³»ç»Ÿå…¶å®å°±åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨ï¼Œä¸èƒ½å†å¤šï¼Œå¦åˆ™å°±ä¸å«å•ä¾‹ã€‚é‚£æˆ‘ä»¬æŠŠæ•´ä¸ªå®‡å®™çœ‹åšæ˜¯ä¸€ä¸ªåºå¤§çš„ç³»ç»Ÿï¼Œè¿™å®‡å®™é‡Œæœ‰å„ç§å¯¹è±¡å­˜åœ¨ï¼Œäººå•Šï¼ŒåŠ¨ç‰©å•Šï¼Œæ¤ç‰©å•Šä¸èƒœæšä¸¾ï¼Œè¿™äº›éƒ½æ˜¯å®ä¾‹ï¼Œä¸°å¯Œå¤šå½©çš„ä¸–ç•Œæ˜¯ç¾å¥½çš„ã€‚ç„¶è€Œï¼ŒæŒç»­å‡ åƒå¹´çš„æˆ˜äº‰ç»™ä¸–ç•Œå¸¦æ¥äº†å·¨å¤§ç¾éš¾ï¼Œå°¤å…¶æ˜¯å®—æ•™æˆ˜äº‰æœ€ä¸ºæ®‹å¿ï¼Œå„ä¸ªä¿¡ä»°é—´å­˜åœ¨æå¤§çš„ä¸–ç•Œè§‚ä»·å€¼è§‚å†²çªã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="ç¥"></p><p>å•å°åº¦ä¸€ä¸ªå›½å®¶å°±æœ‰å‡ ç™¾ä¸ªç¥ï¼Œäººä»¬å„ä¿¡å„çš„ï¼Œé£ä¿—å„å¼‚ï¼Œå„é‚¦æ–‡åŒ–å†²çªä¸æ–­ï¼Œè¯­è¨€ä¸é€šï¼ŒåŠäº‹æ•ˆç‡æä½ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="æ’å›¾"></p><p>ä¸ºäº†è®©å¹¸ç¦ç¾å¥½æ´’æ»¡äººé—´ï¼Œé‚£æˆ‘ä»¬å°±å®šä¹‰ä¸€ä½ç¥å§ï¼Œç‹¬ä¸€æ— äºŒçš„ç¥ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="æ’å›¾"></p><p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªGodç±»å§ï¼Œç±»ä¸­ç©ºç©ºå¦‚ä¹Ÿï¼Œä¸–ç•Œå¦‚æ­¤æ¸…å‡€ï¼Œè™šæ— ç¼¥ç¼ˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬å¾—ä¿è¯ä»»ä½•äººéƒ½ä¸èƒ½å»åˆ›å»ºç¥çš„å®ä¾‹ï¼Œå¦åˆ™å¦‚ï¼š<code>new God()</code>ï¼Œè¿™æ ·ä¸–ç•Œåˆè¦é™·å…¥æˆ˜äº‰çš„ç¾éš¾ï¼Œå„ç§é€ ç¥è¿åŠ¨ï¼Œæˆ–æ˜¯æŸå¤©åˆå‡ºæ¥ä¸ªä»€ä¹ˆç¥æ£å…ˆçŸ¥å‘Šè¯‰ä¿¡å¾’è¯´ä»–ä»¬è‚šå­é‡Œæœ‰ä¸ªè½®å­ã€‚é‚£å°±ä¸å†™æ„é€ æ–¹æ³•å§ï¼Ÿä¸è¡Œï¼Œå› ä¸ºæœ‰é»˜è®¤çš„æ— å‚æ„é€ å™¨ï¼é‚£å°±æŠŠæ„é€ æ–¹æ³•æ”¹æˆprivateå§ï¼Œä¹Ÿå°±æ˜¯ç¥å¯ä»¥è‡ªå·±åˆ›é€ è‡ªå·±ï¼Œä½†åˆ«äººä¸èƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125;<span class="comment">//æ„é€ æ–¹æ³•ç§æœ‰åŒ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Godç±»é‡Œé¢å°è£…ä¸€ä¸ªGodè‡ªå·±ï¼Œå¯¹ï¼Œä¸€åˆ‡éƒ½æ˜¯ç¥åˆ›é€ çš„ï¼ŒåŒ…æ‹¬æˆ‘ä»¬äººç±»ã€‚æœ‰äººå¼€å§‹è´¨ç–‘ï¼Œé‚£ç¥æ˜¯è°ï¼Ÿç¥è‡ªå·±æ˜¯è°é€ çš„ï¼Ÿè¿™æ˜¯ä¸ªå“²å­¦é—®é¢˜ã€‚ç¥è¯´â€œI am who I am.â€ æˆ‘æ˜¯æˆ‘æ‰€æ˜¯ï¼Œæˆ‘å°±æ˜¯æˆ‘ï¼Œè‡ªæœ‰æ°¸æœ‰ï¼Œè¶…è¶Šæ—¶ç©ºã€‚å¾ˆé€†å¤©å§ï¼Ÿ å¥½å§ï¼Œè°ä¹Ÿä¸èƒ½é€ ä¸Šå¸ï¼Œç¥è‡ªå·±é€ è‡ªå·±ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> God god = <span class="keyword">new</span> God();<span class="comment">//è‡ªæœ‰æ°¸æœ‰çš„ç¥å•ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125;<span class="comment">//æ„é€ æ–¹æ³•ç§æœ‰åŒ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Š<code>private</code>å…³é”®å­—ä¿è¯äº†ä¸Šå¸çš„ç§æœ‰æ€§ï¼Œä¸å¯è§æ€§ï¼Œä¸å¯è®¿é—®æ€§ï¼Œæˆ‘æƒ³æ²¡æœ‰æ´»äººè§è¿‡ä¸Šå¸å§ï¼Ÿ<code>static</code>å…³é”®å­—ä¿è¯ä¸Šå¸çš„é™æ€æ€§ï¼Œä»–ä¸ç±»åŒåœ¨ï¼Œä¸ä¾èµ–äºç±»çš„å®ä¾‹åŒ–å°±è‡ªæœ‰æ°¸æœ‰ï¼Œä»–å°†åœ¨å†…å­˜ä¸­æ°¸ç”Ÿï¼Œ<code>GC</code>åƒåœ¾å›æ”¶å™¨ä¹Ÿå›æ”¶ä¸äº†ä»–ã€‚<code>final</code>å…³é”®å­—åˆ™ä¿è¯è¿™ä½ç¥æ˜¯å’Œå¸¸é‡ï¼Œè¡¡é‡ï¼Œä»–æ˜¯ç»ˆæä¸Šå¸ï¼Œä¸èƒ½å†æ”¹ã€‚</p><p>æ­£å¦‚åŒé™æ€æ–¹æ³•<code>main()</code>ï¼Œä¸éœ€è¦å®ä¾‹åŒ–ç±»å°±èƒ½è¿è¡Œçš„å…¥å£ï¼ŒåŒæ ·æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé™æ€æ–¹æ³•<code>getInstance()</code>æ¥è¯·ç¥ï¼Œæ–¹æ³•ä½“å†…æˆ‘ä»¬å°±è¿”å›è¿™ä¸ªåœ¨å”¯ä¸€çš„çœŸç¥ï¼Œå½“ç„¶æ–¹æ³•å®ƒå¿…é¡»æ˜¯<code>public</code>å…¬å¼€çš„ï¼Œä¸ç„¶è°éƒ½è®¿é—®ä¸äº†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> God god = <span class="keyword">new</span> God();<span class="comment">//è‡ªæœ‰æ°¸æœ‰çš„ç¥å•ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125;<span class="comment">//æ„é€ æ–¹æ³•ç§æœ‰åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> God <span class="title">getInstance</span><span class="params">()</span></span>&#123;<span class="comment">//è¯·ç¥æ–¹æ³•å…¬å¼€åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> god;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„ç¥ç±»é›å½¢å·²ç»å†™å¥½äº†ï¼Œå½“ç„¶ä½ è¿˜å¯ä»¥åŠ å…¶ä»–çš„åŠŸèƒ½æ–¹æ³•ï¼Œæ¯”å¦‚è¯´åˆ›ä¸–çºªç¥é€ äº†å…‰ï¼Œé€ äº†ä¸–ç•Œã€åŠ¨ç‰©ã€äººã€äºšå½“å¤å¨ƒç­‰ç­‰åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸åœ¨èµ˜è¿°äº†ã€‚é‚£å¯¹äºå¤–éƒ¨æ¥è¯´åªè¦è°ƒç”¨<code>God.getInstance();</code>å°±å¯ä»¥æ‹¿åˆ°ç¥äº†ï¼Œè€Œä¸”ä¸ç®¡è°æ‹¿ï¼Œæ‹¿å‡ æ¬¡ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªç¥ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•´ä¸ªç³»ç»Ÿä¸­ç¥çš„å”¯ä¸€æ€§ï¼Œä¸å¯ä¼ªé€ æ€§ï¼Œè‡³äºå…¶ä»–å…ˆçŸ¥é‚£ä¹Ÿåªæ˜¯ç¥çš„ä»£ç†äººï¼Œåªèƒ½å¸®è¯·ç¥è€Œå·²ã€‚</p><p>å¥½äº†ï¼Œå…¶å®æˆ‘ä»¬å·²ç»å­¦ä¼šäº†å•ä¾‹æ¨¡å¼çš„<strong>â€œç—´æ±‰æ¨¡å¼ï¼ˆEager loadï¼‰â€</strong>ï¼Œä»£ç ç¬¬ä¸€è¡Œä¸€å¼€å§‹å°±é€ å‡ºäº†ç¥ï¼ˆnew Godé‚£ä¸€å¥ï¼‰ï¼Œå·²ç»å‡†å¤‡å¥½äº†éšæ—¶ç»™ä½ è¯·ç¥ï¼Œè¿™æ ·å°±æœ‰äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ²¡äººè¯·ç¥é‚£ä¸æ˜¯ç™½é€ äº†ï¼Ÿæå‰å¤‡è´§å¦‚æœä»·æ ¼è·Œäº†ä¸æ˜¯å¾ˆæƒ¨ï¼Ÿååº”åœ¨ç³»ç»Ÿä¸­çš„é—®é¢˜å°±æ˜¯å ç”¨äº†å†…å­˜ç©ºé—´ã€‚äºæ˜¯åˆæœ‰äº†<strong>â€œæ‡’æ±‰æ¨¡å¼ï¼ˆLazy loadï¼‰â€</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> God god;<span class="comment">//è¿™é‡Œä¸è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> God <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (god == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ— ç¥æ‰é€ ç¥</span></span><br><span class="line">            god = <span class="keyword">new</span> God();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> god;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æˆ‘ä»¬çœ‹åˆ°ä¸€å¼€å§‹å°±æ²¡æœ‰é€ ç¥ï¼Œåªæœ‰æŸäººç¬¬ä¸€æ¬¡æ±‚ç¥æ—¶æ‰å®ä¾‹åŒ–ï¼Œä¹‹åå†æ±‚çš„å°±ç›´æ¥è¿”å›äº†ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯çœäº†ä¸€æ®µæ—¶é—´çš„å†…å­˜ï¼ˆæ— æ±‚ç¥æœŸé—´ï¼‰ï¼Œåå¤„æ˜¯ç¬¬ä¸€æ¬¡è¯·ç¥çš„æ—¶å€™é€Ÿåº¦ç›¸è¾ƒä¹‹å‰çš„ç—´æ±‰æ¨¡å¼ä¼šæ…¢ï¼Œå› ä¸ºè¦æ¶ˆè€—<code>CPU</code>å»é€ ç¥ã€‚</p><p>å…¶å®è¿™ä¹ˆå†™æ˜¯åœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹æ˜¯æœ‰é™·é˜±çš„ï¼Œè¯•æƒ³å¤šäººåŒæ—¶å¹¶å‘è¯·ç¥çš„è¯ï¼Œä¾ç„¶ä¼šé€ æˆå¤šç¥ï¼Œå¥½å§æˆ‘ä»¬å†æ¥æ”¹è‰¯ä¸€ä¸‹ï¼ŒæŠŠè¯·ç¥æ–¹æ³•åŠ ä¸Š<code>synchronized</code>ï¼Œå£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼ŒæŸçº¿ç¨‹è°ƒç”¨å‰å¿…é¡»è·å–åŒæ­¥é”ï¼Œè°ƒç”¨å®Œåä¼šé‡Šæ”¾é”ç»™å…¶ä»–çº¿ç¨‹ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯·ç¥çš„å¿…é¡»æ’é˜Ÿï¼Œå¤§å®¶ä¸€ä¸ªä¸€ä¸ªæŒ‰é¡ºåºæ¥ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> God god;<span class="comment">//è¿™é‡Œä¸è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> God <span class="title">getInstance</span><span class="params">()</span> </span>&#123;<span class="comment">//æ­¤å¤„åŠ å…¥åŒæ­¥</span></span><br><span class="line">        <span class="keyword">if</span> (god == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ— ç¥æ‰é€ ç¥</span></span><br><span class="line">            god = <span class="keyword">new</span> God();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> god;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œè¿™æ ·åšæ˜¯è¦ä»˜å‡ºä»£ä»·çš„ï¼Œè¿˜æ²¡è¿›åº™å‘¢ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€è¯·ç¥çš„ç›´æ¥ç»™åŠ é”æ’é˜Ÿï¼Œç»“æœé˜Ÿä¼ä»åŒ—è¾¹çš„åº™æ’åˆ°äº†å—å¤©é—¨ï¼Œäººä»¬éƒ½è¦æ¥ä¸€ä¸ªä¸€ä¸ªæ‹œä½›æ±‚ç¥ï¼Œè¿™é€ æˆäº†å·¨å¤§æ—¶é—´æµªè´¹ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨<code>CPU</code>èµ„æºå¹¶å‘ä¼˜åŠ¿ï¼ˆç‰¹åˆ«æ˜¯å¤šæ ¸æƒ…å†µï¼‰ã€‚å¥½å§ï¼Œé‚£è¿˜æ˜¯è®©äººä»¬æŠ¢å¥½äº†ï¼Œä½†ä¾ç„¶å¾—ä¿è¯å•ä¾‹ç¥çš„æƒ…å†µä¸‹ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/20/1.jpg" alt="æ’å›¾"></p><p>è¿™é‡Œæˆ‘ä»¬å»æ‰æ–¹æ³•ä¸Šçš„åŒæ­¥å…³é”®å­—ï¼Œæ¢åˆ°æ–¹æ³•ä½“å†…éƒ¨åšåŒæ­¥ï¼Œæ•´ä¸ªæ–¹æ³•å¼€æ”¾å¹¶å‘å¤§å®¶éƒ½å¯ä»¥åŒæ—¶å…¥åº™ï¼Œå½“ç„¶èµ·æ—©è´ªé»‘çš„è™”è¯šä¿¡å¾’ä»¬è¦æŠ¢å¤´é¦™æ˜¯å¿…é¡»è¦å…¥å ‚æ’é˜Ÿçš„ã€‚ä¸€æ—¦å¤´é¦™è¯ç”Ÿï¼Œé‚£å…¶ä»–æŠ¢é¦™çš„éƒ½ç™½æ—©èµ·ï¼Œç™½æ’é˜Ÿäº†ã€‚å†ä¹‹åçš„äº‹æƒ…æˆ‘ä»¬éƒ½å¯ä»¥é¢„è§äº†ï¼Œå¤´æ³¨é¦™è¢«æŠ¢åå ‚å†…æ’é˜Ÿå†æ— å¿…è¦æ¥äº†ï¼Œå¤§å®¶å¯ä»¥åœ¨å ‚å¤–åŒæ—¶å¹¶å‘æ‹œä½›æ±‚ç¥ï¼Œè¿™å°±æå¤§çš„åˆ©ç”¨äº†<code>CPU</code>èµ„æºã€‚ç®€è€Œè¨€ä¹‹ï¼šåªæœ‰ç¬¬ä¸€æ‰¹æŠ¢å¤´é¦™çš„åœ¨æ’é˜Ÿï¼Œä¹‹åå¤§å®¶éƒ½ä¸å¿…æ’é˜Ÿäº†ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">God</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> God god;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">God</span><span class="params">()</span></span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> God <span class="title">getInstance</span><span class="params">()</span> </span>&#123;<span class="comment">//åº™æ˜¯å¼€æ”¾çš„ä¸ç”¨æ’é˜Ÿè¿›å…¥</span></span><br><span class="line">        <span class="keyword">if</span> (god == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœå¤´æŸ±é¦™æœªäº§ç”Ÿï¼Œè¿™æ‰¹æŠ¢é¦™äººè¿›å…¥å ‚å†…æ’é˜Ÿã€‚</span></span><br><span class="line">            <span class="keyword">synchronized</span>(God.class)&#123;</span><br><span class="line">                <span class="keyword">if</span> (god == <span class="keyword">null</span>) &#123;<span class="comment">//åªæœ‰å¤´é¦™é€ äº†ç¥ï¼Œå…¶ä»–æŠ¢é¦™çš„ç™½æ’é˜Ÿäº†</span></span><br><span class="line">                    god = <span class="keyword">new</span> God();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ­¤å¤„å¤´æŸ±é¦™äº§ç”Ÿåä¸å¿…å†æ’é˜Ÿ</span></span><br><span class="line">        <span class="keyword">return</span> god;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®åœ¨è¿™ä¹‹ä¸Šè¿˜å‘å±•å‡ºäº†å„ç§å„æ ·çš„å•ä¾‹æ¨¡å¼å˜ç§ï¼Œæˆ‘ä»¬è¿™é‡Œåªè®²äº†æœ€åŸºç¡€çš„ä¸¤ç§ï¼Œå…¶å®ä»–ä»¬éƒ½å„æœ‰ä¼˜ç¼ºï¼Œæˆ‘ä»¬è¦åšåˆ°çµæ´»è¿ç”¨ï¼Œå„å–æ‰€éœ€ã€‚å¯¹äºæˆ‘ä¸ªäººæ¥è®²å€¾å‘äºç—´æ±‰æ¨¡å¼ï¼Œç°åœ¨å†…å­˜æˆæœ¬æ ¹æœ¬ä¸ç®—é—®é¢˜ï¼Œå†µä¸”è¿Ÿæ—©è¦è¢«å®ä¾‹åŒ–å ç”¨å†…å­˜ï¼ŒåŠ é”è§£é”æ›´æ˜¯ä¸€ç§æµªè´¹ï¼Œè¿˜æœ‰åŒæ­¥æ•ˆç‡ä½ç­‰é—®é¢˜ï¼Œå¦‚æœä¸Šå¸ä¸æ˜¯å¾ˆå ç©ºé—´é‚£å°±æ²¡å¿…è¦å»æ‡’æ±‰å»¶è¿ŸåŠ è½½ï¼Œè¶Šå¤æ‚é—®é¢˜è¶Šå¤šï¼Œé£é™©è¶Šå¤§ã€‚</p><h2 id="å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼"><a href="#å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼"></a>å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼</h2><h3 id="æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨"><a href="#æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨"></a>æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨</h3><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>æ˜¯</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>å¦</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>æ˜“</p><p><strong>æè¿°ï¼š</strong>è¿™ç§æ–¹å¼æ˜¯æœ€åŸºæœ¬çš„å®ç°æ–¹å¼ï¼Œè¿™ç§å®ç°æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹ã€‚å› ä¸ºæ²¡æœ‰åŠ é” synchronizedï¼Œæ‰€ä»¥ä¸¥æ ¼æ„ä¹‰ä¸Šå®ƒå¹¶ä¸ç®—å•ä¾‹æ¨¡å¼ã€‚<br>è¿™ç§æ–¹å¼ <code>lazy loading</code> å¾ˆæ˜æ˜¾ï¼Œä¸è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¤šçº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        instance = <span class="keyword">new</span> Singleton();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨"><a href="#æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨" class="headerlink" title="æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨"></a>æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨</h3><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>æ˜¯</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>æ˜¯</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>æ˜“</p><p><strong>æè¿°ï¼š</strong>è¿™ç§æ–¹å¼å…·å¤‡å¾ˆå¥½çš„ <code>lazy loading</code>ï¼Œèƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ä¸­å¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯ï¼Œæ•ˆç‡å¾ˆä½ï¼Œ<code>99%</code> æƒ…å†µä¸‹ä¸éœ€è¦åŒæ­¥ã€‚<br>ä¼˜ç‚¹ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ‰åˆå§‹åŒ–ï¼Œé¿å…å†…å­˜æµªè´¹ã€‚<br>ç¼ºç‚¹ï¼šå¿…é¡»åŠ é” <code>synchronized</code> æ‰èƒ½ä¿è¯å•ä¾‹ï¼Œä½†åŠ é”ä¼šå½±å“æ•ˆç‡ã€‚<br><code>getInstance()</code> çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºä¸æ˜¯å¾ˆå…³é”®ï¼ˆè¯¥æ–¹æ³•ä½¿ç”¨ä¸å¤ªé¢‘ç¹ï¼‰ã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        instance = <span class="keyword">new</span> Singleton();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é¥¿æ±‰å¼"><a href="#é¥¿æ±‰å¼" class="headerlink" title="é¥¿æ±‰å¼"></a>é¥¿æ±‰å¼</h3><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>å¦</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>æ˜¯</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>æ˜“</p><p><strong>æè¿°ï¼š</strong>è¿™ç§æ–¹å¼æ¯”è¾ƒå¸¸ç”¨ï¼Œä½†å®¹æ˜“äº§ç”Ÿåƒåœ¾å¯¹è±¡ã€‚<br>ä¼˜ç‚¹ï¼šæ²¡æœ‰åŠ é”ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šæé«˜ã€‚<br>ç¼ºç‚¹ï¼šç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œæµªè´¹å†…å­˜ã€‚<br>å®ƒåŸºäº <code>classloader</code> æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ï¼Œä¸è¿‡ï¼Œ<code>instance</code> åœ¨ç±»è£…è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œè™½ç„¶å¯¼è‡´ç±»è£…è½½çš„åŸå› æœ‰å¾ˆå¤šç§ï¼Œåœ¨å•ä¾‹æ¨¡å¼ä¸­å¤§å¤šæ•°éƒ½æ˜¯è°ƒç”¨ <code>getInstance</code> æ–¹æ³•ï¼Œ ä½†æ˜¯ä¹Ÿä¸èƒ½ç¡®å®šæœ‰å…¶ä»–çš„æ–¹å¼ï¼ˆæˆ–è€…å…¶ä»–çš„é™æ€æ–¹æ³•ï¼‰å¯¼è‡´ç±»è£…è½½ï¼Œè¿™æ—¶å€™åˆå§‹åŒ– <code>instance</code> æ˜¾ç„¶æ²¡æœ‰è¾¾åˆ° <code>lazy loading</code> çš„æ•ˆæœã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒæ£€é”-åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³-double-checked-lockingï¼‰"><a href="#åŒæ£€é”-åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³-double-checked-lockingï¼‰" class="headerlink" title="åŒæ£€é”/åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³ double-checked lockingï¼‰"></a>åŒæ£€é”/åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³ double-checked lockingï¼‰</h3><p><strong>JDK ç‰ˆæœ¬ï¼š</strong><code>JDK1.5</code> èµ·</p><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>æ˜¯</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>æ˜¯</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>è¾ƒå¤æ‚</p><p><strong>æè¿°ï¼š</strong>è¿™ç§æ–¹å¼é‡‡ç”¨åŒé”æœºåˆ¶ï¼Œå®‰å…¨ä¸”åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹èƒ½ä¿æŒé«˜æ€§èƒ½ã€‚<br><code>getInstance()</code> çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºå¾ˆå…³é”®ã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton singleton;  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;  </span><br><span class="line">            singleton = <span class="keyword">new</span> Singleton();  </span><br><span class="line">        &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> singleton;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç™»è®°å¼-é™æ€å†…éƒ¨ç±»"><a href="#ç™»è®°å¼-é™æ€å†…éƒ¨ç±»" class="headerlink" title="ç™»è®°å¼/é™æ€å†…éƒ¨ç±»"></a>ç™»è®°å¼/é™æ€å†…éƒ¨ç±»</h3><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>æ˜¯</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>æ˜¯</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>ä¸€èˆ¬</p><p><strong>æè¿°ï¼š</strong>è¿™ç§æ–¹å¼èƒ½è¾¾åˆ°åŒæ£€é”æ–¹å¼ä¸€æ ·çš„åŠŸæ•ˆï¼Œä½†å®ç°æ›´ç®€å•ã€‚å¯¹é™æ€åŸŸä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåº”ä½¿ç”¨è¿™ç§æ–¹å¼è€Œä¸æ˜¯åŒæ£€é”æ–¹å¼ã€‚è¿™ç§æ–¹å¼åªé€‚ç”¨äºé™æ€åŸŸçš„æƒ…å†µï¼ŒåŒæ£€é”æ–¹å¼å¯åœ¨å®ä¾‹åŸŸéœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æ—¶ä½¿ç”¨ã€‚<br>è¿™ç§æ–¹å¼åŒæ ·åˆ©ç”¨äº† <code>classloader</code> æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ– <code>instance</code> æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒè·Ÿç¬¬ <code>3</code> ç§æ–¹å¼ä¸åŒçš„æ˜¯ï¼šç¬¬ <code>3</code> ç§æ–¹å¼åªè¦ <code>Singleton</code> ç±»è¢«è£…è½½äº†ï¼Œé‚£ä¹ˆ <code>instance</code> å°±ä¼šè¢«å®ä¾‹åŒ–ï¼ˆæ²¡æœ‰è¾¾åˆ° <code>lazy loading</code> æ•ˆæœï¼‰ï¼Œè€Œè¿™ç§æ–¹å¼æ˜¯ <code>Singleton</code> ç±»è¢«è£…è½½äº†ï¼Œ<code>instance</code> ä¸ä¸€å®šè¢«åˆå§‹åŒ–ã€‚å› ä¸º <code>SingletonHolder</code> ç±»æ²¡æœ‰è¢«ä¸»åŠ¨ä½¿ç”¨ï¼Œåªæœ‰é€šè¿‡æ˜¾å¼è°ƒç”¨ <code>getInstance</code> æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ˜¾å¼è£…è½½ <code>SingletonHolder</code> ç±»ï¼Œä»è€Œå®ä¾‹åŒ– <code>instance</code>ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœå®ä¾‹åŒ– <code>instance</code> å¾ˆæ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥æƒ³è®©å®ƒå»¶è¿ŸåŠ è½½ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œåˆä¸å¸Œæœ›åœ¨ <code>Singleton</code> ç±»åŠ è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œå› ä¸ºä¸èƒ½ç¡®ä¿ <code>Singleton</code> ç±»è¿˜å¯èƒ½åœ¨å…¶ä»–çš„åœ°æ–¹è¢«ä¸»åŠ¨ä½¿ç”¨ä»è€Œè¢«åŠ è½½ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®ä¾‹åŒ– <code>instance</code> æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿™ç§æ–¹å¼ç›¸æ¯”ç¬¬ 3 ç§æ–¹å¼å°±æ˜¾å¾—å¾ˆåˆç†ã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton INSTANCE = <span class="keyword">new</span> Singleton();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> SingletonHolder.INSTANCE;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h3><p><strong>JDK ç‰ˆæœ¬ï¼š</strong><code>JDK1.5</code> èµ·</p><p><strong>æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼š</strong>å¦</p><p><strong>æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼š</strong>æ˜¯</p><p><strong>å®ç°éš¾åº¦ï¼š</strong>æ˜“</p><p><strong>æè¿°ï¼š</strong>è¿™ç§å®ç°æ–¹å¼è¿˜æ²¡æœ‰è¢«å¹¿æ³›é‡‡ç”¨ï¼Œä½†è¿™æ˜¯å®ç°å•ä¾‹æ¨¡å¼çš„æœ€ä½³æ–¹æ³•ã€‚å®ƒæ›´ç®€æ´ï¼Œè‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ã€‚<br>è¿™ç§æ–¹å¼æ˜¯ <code>Effective Java</code> ä½œè€… <code>Josh Bloch</code> æå€¡çš„æ–¹å¼ï¼Œå®ƒä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè€Œä¸”è¿˜è‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œé˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ã€‚ä¸è¿‡ï¼Œç”±äº <code>JDK1.5</code> ä¹‹åæ‰åŠ å…¥ <code>enum</code> ç‰¹æ€§ï¼Œç”¨è¿™ç§æ–¹å¼å†™ä¸å…è®©äººæ„Ÿè§‰ç”Ÿç–ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œä¹Ÿå¾ˆå°‘ç”¨ã€‚<br>ä¸èƒ½é€šè¿‡ <code>reflection attack</code> æ¥è°ƒç”¨ç§æœ‰æ„é€ æ–¹æ³•ã€‚</p><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    INSTANCE;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whateverMethod</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»éªŒä¹‹è°ˆï¼š</strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ç¬¬ <code>1</code> ç§å’Œç¬¬ <code>2</code> ç§æ‡’æ±‰æ–¹å¼ï¼Œå»ºè®®ä½¿ç”¨ç¬¬ <code>3</code> ç§é¥¿æ±‰æ–¹å¼ã€‚åªæœ‰åœ¨è¦æ˜ç¡®å®ç° <code>lazy loading</code> æ•ˆæœæ—¶ï¼Œæ‰ä¼šä½¿ç”¨ç¬¬ <code>5</code> ç§ç™»è®°æ–¹å¼ã€‚å¦‚æœæ¶‰åŠåˆ°ååºåˆ—åŒ–åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ç¬¬ <code>6</code> ç§æšä¸¾æ–¹å¼ã€‚å¦‚æœæœ‰å…¶ä»–ç‰¹æ®Šçš„éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç¬¬ <code>4</code> ç§åŒæ£€é”æ–¹å¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹åŸå‹æ¨¡å¼</title>
      <link href="/blog/2019/02/14/44e9b870.html"/>
      <url>/blog/2019/02/14/44e9b870.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>è®¾è®¡æ¨¡å¼</code>ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚</p></blockquote><h2 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h2><p>åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æ˜¯ç”¨äºåˆ›å»ºé‡å¤çš„å¯¹è±¡ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ€§èƒ½ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚</p><p>è¿™ç§æ¨¡å¼æ˜¯å®ç°äº†ä¸€ä¸ªåŸå‹æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåˆ›å»ºå½“å‰å¯¹è±¡çš„å…‹éš†ã€‚å½“ç›´æ¥åˆ›å»ºå¯¹è±¡çš„ä»£ä»·æ¯”è¾ƒå¤§æ—¶ï¼Œåˆ™é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸€ä¸ªé«˜ä»£ä»·çš„æ•°æ®åº“æ“ä½œä¹‹åè¢«åˆ›å»ºã€‚æˆ‘ä»¬å¯ä»¥ç¼“å­˜è¯¥å¯¹è±¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶è¿”å›å®ƒçš„å…‹éš†ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ›´æ–°æ•°æ®åº“ï¼Œä»¥æ­¤æ¥å‡å°‘æ•°æ®åº“è°ƒç”¨ã€‚</p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>æ„å›¾ï¼š</strong>ç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚</p><p><strong>ä¸»è¦è§£å†³ï¼š</strong>åœ¨è¿è¡ŒæœŸå»ºç«‹å’Œåˆ é™¤åŸå‹ã€‚</p><p><strong>ä½•æ—¶ä½¿ç”¨ï¼š</strong> 1ã€å½“ä¸€ä¸ªç³»ç»Ÿåº”è¯¥ç‹¬ç«‹äºå®ƒçš„äº§å“åˆ›å»ºï¼Œæ„æˆå’Œè¡¨ç¤ºæ—¶ã€‚ 2ã€å½“è¦å®ä¾‹åŒ–çš„ç±»æ˜¯åœ¨è¿è¡Œæ—¶åˆ»æŒ‡å®šæ—¶ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡åŠ¨æ€è£…è½½ã€‚ 3ã€ä¸ºäº†é¿å…åˆ›å»ºä¸€ä¸ªä¸äº§å“ç±»å±‚æ¬¡å¹³è¡Œçš„å·¥å‚ç±»å±‚æ¬¡æ—¶ã€‚ 4ã€å½“ä¸€ä¸ªç±»çš„å®ä¾‹åªèƒ½æœ‰å‡ ä¸ªä¸åŒçŠ¶æ€ç»„åˆä¸­çš„ä¸€ç§æ—¶ã€‚å»ºç«‹ç›¸åº”æ•°ç›®çš„åŸå‹å¹¶å…‹éš†å®ƒä»¬å¯èƒ½æ¯”æ¯æ¬¡ç”¨åˆé€‚çš„çŠ¶æ€æ‰‹å·¥å®ä¾‹åŒ–è¯¥ç±»æ›´æ–¹ä¾¿ä¸€äº›ã€‚</p><p><strong>å¦‚ä½•è§£å†³ï¼š</strong>åˆ©ç”¨å·²æœ‰çš„ä¸€ä¸ªåŸå‹å¯¹è±¡ï¼Œå¿«é€Ÿåœ°ç”Ÿæˆå’ŒåŸå‹å¯¹è±¡ä¸€æ ·çš„å®ä¾‹ã€‚</p><p><strong>å…³é”®ä»£ç ï¼š</strong> 1ã€å®ç°å…‹éš†æ“ä½œï¼Œåœ¨ JAVA ç»§æ‰¿ Cloneableï¼Œé‡å†™ clone()ï¼Œåœ¨ .NET ä¸­å¯ä»¥ä½¿ç”¨ Object ç±»çš„ MemberwiseClone() æ–¹æ³•æ¥å®ç°å¯¹è±¡çš„æµ…æ‹·è´æˆ–é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼æ¥å®ç°æ·±æ‹·è´ã€‚ 2ã€åŸå‹æ¨¡å¼åŒæ ·ç”¨äºéš”ç¦»ç±»å¯¹è±¡çš„ä½¿ç”¨è€…å’Œå…·ä½“ç±»å‹ï¼ˆæ˜“å˜ç±»ï¼‰ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œå®ƒåŒæ ·è¦æ±‚è¿™äº›â€æ˜“å˜ç±»â€æ‹¥æœ‰ç¨³å®šçš„æ¥å£ã€‚</p><p><strong>åº”ç”¨å®ä¾‹ï¼š</strong> 1ã€ç»†èƒåˆ†è£‚ã€‚ 2ã€JAVA ä¸­çš„ Object clone() æ–¹æ³•ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong> 1ã€æ€§èƒ½æé«˜ã€‚ 2ã€é€ƒé¿æ„é€ å‡½æ•°çš„çº¦æŸã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong> 1ã€é…å¤‡å…‹éš†æ–¹æ³•éœ€è¦å¯¹ç±»çš„åŠŸèƒ½è¿›è¡Œé€šç›˜è€ƒè™‘ï¼Œè¿™å¯¹äºå…¨æ–°çš„ç±»ä¸æ˜¯å¾ˆéš¾ï¼Œä½†å¯¹äºå·²æœ‰çš„ç±»ä¸ä¸€å®šå¾ˆå®¹æ˜“ï¼Œç‰¹åˆ«å½“ä¸€ä¸ªç±»å¼•ç”¨ä¸æ”¯æŒä¸²è¡ŒåŒ–çš„é—´æ¥å¯¹è±¡ï¼Œæˆ–è€…å¼•ç”¨å«æœ‰å¾ªç¯ç»“æ„çš„æ—¶å€™ã€‚ 2ã€å¿…é¡»å®ç° Cloneable æ¥å£ã€‚</p><p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong> 1ã€èµ„æºä¼˜åŒ–åœºæ™¯ã€‚ 2ã€ç±»åˆå§‹åŒ–éœ€è¦æ¶ˆåŒ–éå¸¸å¤šçš„èµ„æºï¼Œè¿™ä¸ªèµ„æºåŒ…æ‹¬æ•°æ®ã€ç¡¬ä»¶èµ„æºç­‰ã€‚ 3ã€æ€§èƒ½å’Œå®‰å…¨è¦æ±‚çš„åœºæ™¯ã€‚ 4ã€é€šè¿‡ new äº§ç”Ÿä¸€ä¸ªå¯¹è±¡éœ€è¦éå¸¸ç¹ççš„æ•°æ®å‡†å¤‡æˆ–è®¿é—®æƒé™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼ã€‚ 5ã€ä¸€ä¸ªå¯¹è±¡å¤šä¸ªä¿®æ”¹è€…çš„åœºæ™¯ã€‚ 6ã€ä¸€ä¸ªå¯¹è±¡éœ€è¦æä¾›ç»™å…¶ä»–å¯¹è±¡è®¿é—®ï¼Œè€Œä¸”å„ä¸ªè°ƒç”¨è€…å¯èƒ½éƒ½éœ€è¦ä¿®æ”¹å…¶å€¼æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åŸå‹æ¨¡å¼æ‹·è´å¤šä¸ªå¯¹è±¡ä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚ 7ã€åœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒåŸå‹æ¨¡å¼å¾ˆå°‘å•ç‹¬å‡ºç°ï¼Œä¸€èˆ¬æ˜¯å’Œå·¥å‚æ–¹æ³•æ¨¡å¼ä¸€èµ·å‡ºç°ï¼Œé€šè¿‡ clone çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åç”±å·¥å‚æ–¹æ³•æä¾›ç»™è°ƒç”¨è€…ã€‚åŸå‹æ¨¡å¼å·²ç»ä¸ Java èä¸ºæµ‘ç„¶ä¸€ä½“ï¼Œå¤§å®¶å¯ä»¥éšæ‰‹æ‹¿æ¥ä½¿ç”¨ã€‚</p><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong>ä¸é€šè¿‡å¯¹ä¸€ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–æ¥æ„é€ æ–°å¯¹è±¡ä¸åŒçš„æ˜¯ï¼ŒåŸå‹æ¨¡å¼æ˜¯é€šè¿‡æ‹·è´ä¸€ä¸ªç°æœ‰å¯¹è±¡ç”Ÿæˆæ–°å¯¹è±¡çš„ã€‚æµ…æ‹·è´å®ç° Cloneableï¼Œé‡å†™ï¼Œæ·±æ‹·è´æ˜¯é€šè¿‡å®ç° Serializable è¯»å–äºŒè¿›åˆ¶æµã€‚</p><h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><blockquote><p>ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆåŸå‹ï¼‰</p></blockquote><p>å‡è®¾æˆ‘ä»¬è¦åšä¸€ä¸ªæ‰“é£æœºæ¸¸æˆï¼Œæ¸¸æˆè®¾å®šä½çºµç‰ˆç§»åŠ¨ï¼Œå•æ‰“ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/14/1.jpg" alt="æ‰“é£æœº"></p><p>æ—¢ç„¶æ˜¯å•æ‰“ï¼Œé‚£æˆ‘ä»¬çš„ä¸»è§’é£æœºå½“ç„¶åªæœ‰ä¸€æ¶ï¼Œäºæ˜¯æˆ‘ä»¬å†™ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œæ­¤å¤„æˆ‘ä»¬çœç•¥ä¸»è§’ä»£ç ã€‚é‚£ä¹ˆæ•Œæœºå‘¢ï¼Ÿå½“ç„¶æœ‰å¾ˆå¤šæ¶äº†ï¼Œå¥½ï¼Œä¸ºäº†è¯´æ˜é—®é¢˜æˆ‘ä»¬å»ç¹å°±ç®€ï¼Œå…ˆå†™ä¸€ä¸ªæ•Œæœºç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnemyPlane</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;<span class="comment">//æ•Œæœºæ¨ªåæ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">0</span>;<span class="comment">//æ•Œæœºçºµåæ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyPlane</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;<span class="comment">//æ„é€ å™¨</span></span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>&#123;<span class="comment">//è®©æ•Œæœºé£</span></span><br><span class="line">        y++;<span class="comment">//æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œæ•Œæœºé£è¡Œæ—¶çºµåæ ‡ï¼‹1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç <code>public EnemyPlane(int x) &#123;//æ„é€ å™¨....</code>å¼€å§‹ï¼Œåˆå§‹åŒ–åªæ¥æ”¶xåæ ‡ï¼Œå› ä¸ºæ•Œæœºä¸€å¼€å§‹æ˜¯ä»é¡¶éƒ¨å‡ºæ¥æ‰€ä»¥çºµåæ ‡<code>y</code>å¿…ç„¶æ˜¯<code>0</code>ã€‚æ­¤ç±»åªæä¾›<code>getter</code>è€Œæ²¡æœ‰<code>setter</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½åœ¨åˆå§‹åŒ–æ—¶ç¡®å®šæ•Œæœºçš„æ¨ªåæ ‡xï¼Œåç»­æ˜¯ä¸éœ€è¦æ›´æ”¹åæ ‡äº†ï¼Œåªè¦è¿ç»­è°ƒç”¨ç¬¬17è¡Œçš„flyæ–¹æ³•å³å¯è®©é£æœºè·Ÿé›¨ç‚¹ä¸€æ ·å¾€ä¸‹ç ¸ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹ç»˜åˆ¶æ•ŒæœºåŠ¨ç”»äº†ï¼Œå…ˆå®ä¾‹åŒ–å‡º50æ¶å§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;EnemyPlane&gt; enemyPlanes = <span class="keyword">new</span> ArrayList&lt;EnemyPlane&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//æ­¤å¤„éšæœºä½ç½®äº§ç”Ÿæ•Œæœº</span></span><br><span class="line">            EnemyPlane ep = <span class="keyword">new</span> EnemyPlane(<span class="keyword">new</span> Random().nextInt(<span class="number">200</span>));</span><br><span class="line">            enemyPlanes.add(ep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä»£ç <code>EnemyPlane ep = new EnemyPlane(new Random().nextInt(200));</code>ï¼Œ<em>è§‰ä¸è§‰å¾—æ¯ä¸ªè¿­ä»£éƒ½å®ä¾‹åŒ–newå‡ºä¸€ä¸ªå¯¹è±¡å­˜åœ¨æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿ</em>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™ä¸ªå®ä¾‹åŒ–çš„è¿‡ç¨‹æ˜¯å¾—ä¸å¿å¤±çš„ï¼Œæ„é€ æ–¹æ³•ä¼šè¢«è°ƒç”¨50æ¬¡ï¼Œcpuè¢«æå¤§æµªè´¹äº†ï¼Œå†…å­˜è¢«æå¤§æµªè´¹äº†ï¼Œå°¤å…¶å¯¹äºæ¸¸æˆæ¥è¯´æ€§èƒ½ç“¶é¢ˆç»å¯¹æ˜¯å¤§å¿Œï¼Œè¿™ä¼šé€ æˆç”¨æˆ·ä½“éªŒé—®é¢˜ï¼Œè°ä¹Ÿä¸å¸Œæœ›ç©æ¸¸æˆä¼šå¡å¸§å§ã€‚</p><p>é‚£åˆ°åº•ä»€ä¹ˆæ—¶å€™å»newï¼Ÿæ¸¸æˆåœºæ™¯åˆå§‹åŒ–å°±newæ•Œæœºï¼ˆå¦‚ä»¥ä¸Šä»£ç ï¼‰ï¼Ÿè¿™å…³ä¼šå‡ºç°500ä¸ªæ•Œæœºé‚£æˆ‘ä»¬ä¸€æ¬¡éƒ½newå‡ºæ¥å§ï¼Ÿæµªè´¹å†…å­˜ï¼é‚£æˆ‘ä»¬å®æ—¶çš„å»newï¼Œæ¯åˆ°ä¸€ä¸ªåœ°æ–¹æ‰newå‡ºæ¥ä¸€ä¸ªï¼æµªè´¹CPUï¼å¦‚æœæ•Œæœºçº¿ç¨‹è¿‡å¤šé€ æˆCPUèµ„æºè€—å°½ï¼Œæ¯å‡ºä¸€ä¸ªæ•Œæœºæ¸¸æˆä¼šå¡ä¸€ä¸‹ï¼Œè¯•æƒ³ä¸€ä¸‹è¿™ç§æç«¯æƒ…å†µä¸‹ï¼Œæ¸¸æˆå¯¹è±¡å®ä¾‹å¾ˆå¤šçš„è¯å°±æ˜¯åœ¨ä½œæ­»ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2019/02/14/2.jpg" alt="æ‰“é£æœº"></p><p>è§£å†³æ–¹æ¡ˆåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¥½ï¼Œ<code>åŸå‹æ¨¡å¼Prototype</code>ï¼ä¸Šä»£ç ï¼æˆ‘ä»¬æŠŠä¸Šé¢çš„æ•Œæœºç±»æ”¹é€ ä¸€ä¸‹ï¼Œè®©å®ƒæ”¯æŒåŸå‹æ‹·è´ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnemyPlane</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;<span class="comment">//æ­¤å¤„å®ç°å…‹éš†æ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;<span class="comment">//æ•Œæœºæ¨ªåæ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">0</span>;<span class="comment">//æ•Œæœºçºµåæ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EnemyPlane</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;<span class="comment">//æ„é€ å™¨</span></span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>&#123;<span class="comment">//è®©æ•Œæœºé£</span></span><br><span class="line">        y++;<span class="comment">//æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œæ•Œæœºé£è¡Œæ—¶çºµåæ ‡ï¼‹1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ­¤å¤„å¼€æ”¾setXï¼Œä¸ºäº†è®©å…‹éš†åçš„å®ä¾‹é‡æ–°ä¿®æ”¹xåæ ‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸ºäº†ä¿è¯é£æœºé£è¡Œçš„è¿è´¯æ€§</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œæˆ‘ä»¬å…³é—­setYæ–¹æ³•ï¼Œä¸æ”¯æŒéšæ„æ›´æ”¹Yçºµåæ ‡</span></span><br><span class="line"><span class="comment">//    public void setY(int y) &#123;</span></span><br><span class="line"><span class="comment">//        this.y = y;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡å†™å…‹éš†æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EnemyPlane <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (EnemyPlane)<span class="keyword">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setX()</code>æ–¹æ³•ä¸ºäº†ä¿è¯å…‹éš†é£æœºçš„ä¸ªæ€§åŒ–ï¼Œå› ä¸ºå®ƒä»¬å‡ºç°çš„ä½ç½®æ˜¯ä¸åŒçš„ã€‚<code>å…‹éš†æ–¹æ³•</code>é‡å†™æˆ‘ä»¬è°ƒç”¨äº†çˆ¶ç±»Objectçš„å…‹éš†æ–¹æ³•ï¼Œ<strong>è¿™é‡ŒJVMä¼šè¿›è¡Œå†…å­˜æ“ä½œç›´æ¥æ‹·è´åŸå§‹æ•°æ®æµï¼Œ</strong>ç®€å•ç²—æš´ï¼Œä¸ä¼šæœ‰å…¶ä»–æ›´å¤šçš„å¤æ‚æ“ä½œï¼ˆç±»åŠ è½½ï¼Œå®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–ç­‰ç­‰ï¼‰ï¼Œé€Ÿåº¦è¿œè¿œå¿«äºå®ä¾‹åŒ–æ“ä½œã€‚OKï¼Œæˆ‘ä»¬çœ‹æ€ä¹ˆå…‹éš†è¿™äº›æ•Œæœºï¼Œåšä¸€ä¸ªé€ é£æœºçš„å·¥å‚å§ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnemyPlaneFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ­¤å¤„ç”¨ç—´æ±‰æ¨¡å¼é€ ä¸€ä¸ªæ•ŒæœºåŸå‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EnemyPlane protoType = <span class="keyword">new</span> EnemyPlane(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ•Œæœºå…‹éš†å®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EnemyPlane <span class="title">getInstance</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        EnemyPlane clone = protoType.clone();<span class="comment">//å¤åˆ¶åŸå‹æœº</span></span><br><span class="line">        clone.setX(x);<span class="comment">//é‡æ–°è®¾ç½®å…‹éš†æœºçš„xåæ ‡</span></span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æˆ‘ä»¬çœå»æŠ“å¼‚å¸¸ï¼Œéšåçš„äº‹æƒ…å°±éå¸¸ç®€å•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å¾ˆç®€å•åœ°è°ƒç”¨<code>EnemyPlaneFactory.getInstance(int x)</code>å¹¶å£°æ˜<code>xåæ ‡</code>ä½ç½®ï¼Œä¸€æ¶æ•Œæœºå¾ˆå¿«åœ°å°±åšå¥½äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¿è¯æ˜¯åœ¨æ•Œæœºå‡ºç°çš„æ—¶å€™å†å»å…‹éš†ï¼Œç¡®ä¿ä¸è¦ä¸€å¼€å±€å°±å…¨éƒ¨å…‹éš†å‡ºæ¥ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ—¢ä¿è¯äº†å®æ—¶æ€§èŠ‚çœäº†å†…å­˜ç©ºé—´ï¼Œåˆä¿è¯äº†æ•Œæœºå®ä¾‹åŒ–çš„é€Ÿåº¦ï¼Œæ¸¸æˆç»ä¸ä¼šå¡å¸§ï¼</p><p>æœ€åï¼Œè¿˜è¦å¼ºè°ƒä¸€ç‚¹å°±æ˜¯æµ…æ‹·è´å’Œæ·±æ‹·è´çš„é—®é¢˜ã€‚å‡å¦‚æˆ‘ä»¬çš„æ•Œæœºç±»é‡Œæœ‰ä¸€é¢—å­å¼¹bulletå¯ä»¥å°„å‡»æˆ‘ä»¬çš„ä¸»è§’ï¼Œå¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnemyPlane</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bullet bullet = <span class="keyword">new</span> Bullet();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;<span class="comment">//æ•Œæœºæ¨ªåæ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y = <span class="number">0</span>;<span class="comment">//æ•Œæœºçºµåæ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¹‹åä»£ç çœç•¥â€¦â€¦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éƒ½çŸ¥é“<strong>Javaä¸­çš„å˜é‡åˆ†ä¸ºåŸå§‹ç±»å‹å’Œå¼•ç”¨ç±»å‹ï¼Œæ‰€è°“æµ…æ‹·è´åªæ˜¯æ‹·è´åŸå§‹ç±»å‹çš„æŒ‡ï¼Œæ¯”å¦‚åæ ‡x, yçš„æŒ‡ä¼šè¢«æ‹·è´åˆ°å…‹éš†å¯¹è±¡ä¸­ï¼Œå¯¹äºå¯¹è±¡bulletä¹Ÿä¼šè¢«æ‹·è´ï¼Œä½†æ˜¯è¯·æ³¨æ„æ‹·è´çš„åªæ˜¯åœ°å€è€Œå·²ï¼Œé‚£ä¹ˆå¤šä¸ªåœ°å€å…¶å®çœŸæ­£æŒ‡å‘çš„å¯¹è±¡è¿˜æ˜¯åŒä¸€ä¸ªbulletã€‚</strong></p><p>ç”±äºæˆ‘ä»¬è°ƒç”¨çˆ¶ç±»<code>Object</code>çš„<code>clone</code>æ–¹æ³•è¿›è¡Œçš„æ˜¯æµ…æ‹·è´ï¼Œæ‰€ä»¥æ­¤å¤„çš„<code>bullet</code>å¹¶æ²¡æœ‰è¢«å…‹éš†æˆåŠŸï¼Œæ¯”å¦‚æˆ‘ä»¬æ¯æ¶æ•Œæœºå¿…é¡»æºå¸¦çš„å­å¼¹æ˜¯ä¸åŒçš„å®ä¾‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»è¿›è¡Œæ·±æ‹·è´ï¼Œäºæ˜¯æˆ‘ä»¬çš„ä»£ç å°±å¾—åšè¿™æ ·çš„æ”¹åŠ¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnemyPlane</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bullet bullet = <span class="keyword">new</span> Bullet();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBullet</span><span class="params">(Bullet bullet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bullet = bullet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EnemyPlane <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="comment">// å…ˆå…‹éš†å‡ºæ•Œæœºï¼Œå…¶ä¸­å­å¼¹è¿˜æœªè¿›è¡Œå…‹éš†ã€‚</span></span><br><span class="line">        EnemyPlane clonePlane = (EnemyPlane) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="comment">// å¯¹å­å¼¹è¿›è¡Œæ·±æ‹·è´</span></span><br><span class="line">        clonePlane.setBullet(<span class="keyword">this</span>.bullet.clone());</span><br><span class="line">        <span class="keyword">return</span> clonePlane;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¹‹åä»£ç çœç•¥â€¦â€¦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å¤§å®¶çœ‹æ³¨é‡Šå°±èƒ½æ‡‚äº†ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šè§£é‡Šï¼Œå½“ç„¶å¯¹äº<code>Bullet</code>ç±»ä¹ŸåŒæ ·å®ç°äº†å…‹éš†æ¥å£ï¼Œä»£ç ä¸ç”¨å†å†™äº†å§ï¼Ÿç›¸ä¿¡å¤§å®¶éƒ½å­¦ä¼šäº†ä¸¾ä¸€åä¸‰ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æ¯ä¸ªæ•Œæœºæºå¸¦çš„å¼¹è¯ä¹ŸåŒæ ·è¢«å…‹éš†å®Œæ¯•äº†ï¼Œå†ä¹Ÿä¸å¿…æ‹…å¿ƒæ¸¸æˆçš„æµç•…æ€§äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> Javaè®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8ç‰¹æ€§ä¸€è§ˆ</title>
      <link href="/blog/2019/01/22/1abc3648.html"/>
      <url>/blog/2019/01/22/1abc3648.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>è½¬è‡ªï¼š<a href="https://github.com/winterbe/java8-tutorial">https://github.com/winterbe/java8-tutorial</a></p><p>è½¬è‡ªï¼š<a href="https://juejin.im/post/5c3d7c8a51882525dd591ac7?utm_source=gold_browser_extension#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3-Functional-Interface">Java8 æ–°ç‰¹æ€§æŒ‡å¯¼æ‰‹å†Œ</a></p></blockquote><h2 id="æ¥å£å†…å…è®¸æ·»åŠ é»˜è®¤å®ç°çš„æ–¹æ³•"><a href="#æ¥å£å†…å…è®¸æ·»åŠ é»˜è®¤å®ç°çš„æ–¹æ³•" class="headerlink" title="æ¥å£å†…å…è®¸æ·»åŠ é»˜è®¤å®ç°çš„æ–¹æ³•"></a>æ¥å£å†…å…è®¸æ·»åŠ é»˜è®¤å®ç°çš„æ–¹æ³•</h2><p>Java 8 å…è®¸æˆ‘ä»¬é€šè¿‡ <code>default</code> å…³é”®å­—å¯¹æ¥å£ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•æä¾›ä¸€ä¸ªé»˜è®¤çš„å®ç°ã€‚</p><p>è¯·çœ‹ä¸‹é¢ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªå…¬å¼æ¥å£</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Formula</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—</span></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ±‚å¹³æ–¹æ ¹</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">double</span> <span class="title">sqrt</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢è¿™ä¸ªæ¥å£ä¸­ï¼Œæˆ‘ä»¬é™¤äº†å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³• <code>calculate</code>ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å®ç°çš„æ–¹æ³• <code>sqrt</code>ã€‚ æˆ‘ä»¬åœ¨å®ç°è¿™ä¸ªæ¥å£æ—¶ï¼Œå¯ä»¥åªéœ€è¦å®ç° <code>calculate</code> æ–¹æ³•ï¼Œé»˜è®¤æ–¹æ³• <code>sqrt</code> å¯ä»¥ç›´æ¥è°ƒç”¨å³å¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ä¸å¿…å¼ºåˆ¶å®ç° <code>sqrt</code> æ–¹æ³•ã€‚</p><blockquote><p>è¡¥å……ï¼šé€šè¿‡ <code>default</code> å…³é”®å­—è¿™ä¸ªæ–°ç‰¹æ€§ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å¯¹ä¹‹å‰çš„æ¥å£åšæ‹“å±•ï¼Œè€Œæ­¤æ¥å£çš„å®ç°ç±»ä¸å¿…åšä»»ä½•æ”¹åŠ¨ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Formula formula = <span class="keyword">new</span> Formula() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sqrt(a * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">formula.calculate(<span class="number">100</span>);     <span class="comment">// 100.0</span></span><br><span class="line">formula.sqrt(<span class="number">16</span>);           <span class="comment">// 4.0</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢é€šè¿‡åŒ¿åå¯¹è±¡å®ç°äº† <code>Formula</code> æ¥å£ã€‚ä½†æ˜¯å³ä½¿æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä¸ºäº†å®Œæˆä¸€ä¸ª <code>sqrt(a * 100)</code>ç®€å•è®¡ç®—ï¼Œå°±å†™äº† 6 è¡Œä»£ç ï¼Œå¾ˆæ˜¯å†—ä½™ã€‚</p><h2 id="Lamdbaè¡¨è¾¾å¼"><a href="#Lamdbaè¡¨è¾¾å¼" class="headerlink" title="Lamdbaè¡¨è¾¾å¼"></a>Lamdbaè¡¨è¾¾å¼</h2><p>åœ¨å­¦ä¹  <code>Lambda</code> è¡¨è¾¾å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µè€ç‰ˆæœ¬çš„ç¤ºä¾‹ä»£ç ï¼Œå…¶å¯¹ä¸€ä¸ªå«æœ‰å­—ç¬¦ä¸²çš„é›†åˆè¿›è¡Œæ’åºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; names = Arrays.asList(<span class="string">&quot;peter&quot;</span>, <span class="string">&quot;anna&quot;</span>, <span class="string">&quot;mike&quot;</span>, <span class="string">&quot;xenia&quot;</span>);</span><br><span class="line"></span><br><span class="line">Collections.sort(names, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>Collections</code> å·¥å…·ç±»æä¾›äº†é™æ€æ–¹æ³• <code>sort</code> æ–¹æ³•ï¼Œå…¥å‚æ˜¯ä¸€ä¸ª <code>List</code> é›†åˆï¼Œå’Œä¸€ä¸ª <code>Comparator</code> æ¯”è¾ƒå™¨ï¼Œä»¥ä¾¿å¯¹ç»™å®šçš„ <code>List</code> é›†åˆè¿›è¡Œ æ’åºã€‚ä¸Šé¢çš„ç¤ºä¾‹ä»£ç åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ä½œä¸ºå…¥å‚ï¼Œè¿™ç§ç±»ä¼¼çš„æ“ä½œåœ¨æˆ‘ä»¬æ—¥å¸¸çš„å·¥ä½œä¸­éšå¤„å¯è§ã€‚</p><p>Java 8 ä¸­ä¸å†æ¨èè¿™ç§å†™æ³•ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨ Lambda è¡¨è¾¾ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> b.compareTo(a);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ­£å¦‚ä½ çœ‹åˆ°çš„ï¼Œä¸Šé¢è¿™æ®µä»£ç å˜å¾—ç®€çŸ­å¾ˆå¤šè€Œä¸”æ˜“äºé˜…è¯»ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥å†ç²¾ç‚¼ä¸€ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collections.sort(names, (String a, String b) -&gt; b.compareTo(a));</span><br></pre></td></tr></table></figure><p><code>List</code> é›†åˆç°åœ¨å·²ç»æ·»åŠ äº† <code>sort</code> æ–¹æ³•ã€‚è€Œä¸” Java ç¼–è¯‘å™¨èƒ½å¤Ÿæ ¹æ®<strong>ç±»å‹æ¨æ–­æœºåˆ¶</strong>åˆ¤æ–­å‡ºå‚æ•°ç±»å‹ï¼Œè¿™æ ·ï¼Œè¿å…¥å‚çš„ç±»å‹éƒ½å¯ä»¥çœç•¥äº†ï¼</p><h2 id="å‡½æ•°å¼æ¥å£-Functional-Interface"><a href="#å‡½æ•°å¼æ¥å£-Functional-Interface" class="headerlink" title="å‡½æ•°å¼æ¥å£ Functional Interface"></a>å‡½æ•°å¼æ¥å£ Functional Interface</h2><p>æŠ›å‡ºä¸€ä¸ªç–‘é—®ï¼šåœ¨æˆ‘ä»¬ä¹¦å†™ä¸€æ®µ Lambda è¡¨è¾¾å¼åï¼ˆæ¯”å¦‚ä¸Šä¸€ç« èŠ‚ä¸­åŒ¿åå†…éƒ¨ç±»çš„ Lambda è¡¨è¾¾å¼ç¼©å†™å½¢å¼ï¼‰ï¼ŒJava ç¼–è¯‘å™¨æ˜¯å¦‚ä½•è¿›è¡Œç±»å‹æ¨æ–­çš„ï¼Œå®ƒåˆæ˜¯æ€ä¹ˆçŸ¥é“é‡å†™çš„å“ªä¸ªæ–¹æ³•çš„ï¼Ÿ</p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸æ˜¯æ¯ä¸ªæ¥å£éƒ½å¯ä»¥ç¼©å†™æˆ Lambda è¡¨è¾¾å¼ã€‚åªæœ‰é‚£äº›å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰æ‰èƒ½ç¼©å†™æˆ Lambda è¡¨ç¤ºå¼ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰å‘¢ï¼Ÿ</p><p>æ‰€è°“å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰å°±æ˜¯åªåŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„å£°æ˜ã€‚é’ˆå¯¹è¯¥æ¥å£ç±»å‹çš„æ‰€æœ‰ Lambda è¡¨è¾¾å¼éƒ½ä¼šä¸è¿™ä¸ªæŠ½è±¡æ–¹æ³•åŒ¹é…ã€‚</p><blockquote><p>æ³¨æ„ï¼šä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼ŒJava 8 ä¸­ä¸æ˜¯å…è®¸é€šè¿‡ defualt å…³é”®å­—æ¥ä¸ºæ¥å£æ·»åŠ é»˜è®¤æ–¹æ³•å—ï¼Ÿé‚£å®ƒç®—ä¸ç®—æŠ½è±¡æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸ç®—ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ¯«æ— é¡¾å¿Œçš„æ·»åŠ é»˜è®¤æ–¹æ³•ï¼Œå®ƒå¹¶ä¸è¿åå‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰çš„å®šä¹‰ã€‚</p></blockquote><p>æ€»ç»“ä¸€ä¸‹ï¼šåªè¦æ¥å£ä¸­ä»…ä»…åŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å…¶æ”¹å†™ä¸º Lambda è¡¨è¾¾å¼ã€‚ä¸ºäº†ä¿è¯ä¸€ä¸ªæ¥å£æ˜ç¡®çš„è¢«å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¯¥æ¥å£æ·»åŠ æ³¨è§£ï¼š<code>@FunctionalInterface</code>ã€‚è¿™æ ·ï¼Œä¸€æ—¦ä½ æ·»åŠ äº†ç¬¬äºŒä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç¼–è¯‘å™¨ä¼šç«‹åˆ»æŠ›å‡ºé”™è¯¯æç¤ºã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(F from)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç 2ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Converter&lt;String, Integer&gt; converter = (from) -&gt; Integer.valueOf(from);</span><br><span class="line">Integer converted = converter.convert(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">System.out.println(converted);    <span class="comment">// 123</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œå³ä½¿å»æ‰ <code>@FunctionalInterface</code> ä¹Ÿæ˜¯å¥½ä½¿çš„ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ç§çº¦æŸè€Œå·²ã€‚</p></blockquote><h2 id="ä¾¿æ·çš„å¼•ç”¨ç±»çš„æ„é€ å™¨åŠæ–¹æ³•"><a href="#ä¾¿æ·çš„å¼•ç”¨ç±»çš„æ„é€ å™¨åŠæ–¹æ³•" class="headerlink" title="ä¾¿æ·çš„å¼•ç”¨ç±»çš„æ„é€ å™¨åŠæ–¹æ³•"></a>ä¾¿æ·çš„å¼•ç”¨ç±»çš„æ„é€ å™¨åŠæ–¹æ³•</h2><p>å°ä¼™ä¼´ä»¬ï¼Œè¿˜è®°å¾—ä¸Šä¸€ä¸ªç« èŠ‚è¿™æ®µç¤ºä¾‹ä»£ç ä¹ˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(F from)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Converter&lt;String, Integer&gt; converter = (from) -&gt; Integer.valueOf(from);</span><br><span class="line">Integer converted = converter.convert(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">System.out.println(converted);    <span class="comment">// 123</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç ï¼Œé€šè¿‡ Java 8 çš„æ–°ç‰¹æ€§ï¼Œè¿›ä¸€æ­¥ç®€åŒ–ä¸Šé¢çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Converter&lt;String, Integer&gt; converter = Integer::valueOf;</span><br><span class="line">Integer converted = converter.convert(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">System.out.println(converted);   <span class="comment">// 123</span></span><br></pre></td></tr></table></figure><p>Java 8 ä¸­å…è®¸ä½ é€šè¿‡ <code>::</code> å…³é”®å­—æ¥å¼•ç”¨ç±»çš„æ–¹æ³•æˆ–æ„é€ å™¨ã€‚ä¸Šé¢çš„ä»£ç ç®€å•çš„ç¤ºä¾‹äº†å¦‚ä½•å¼•ç”¨é™æ€æ–¹æ³•ï¼Œå½“ç„¶ï¼Œé™¤äº†é™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¼•ç”¨æ™®é€šæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Something</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">startsWith</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(s.charAt(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Something something = <span class="keyword">new</span> Something();</span><br><span class="line">Converter&lt;String, String&gt; converter = something::startsWith;</span><br><span class="line">String converted = converter.convert(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">System.out.println(converted);    <span class="comment">// &quot;J&quot;</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡ <code>::</code> å…³é”®å­—æ¥å¼•ç”¨ç±»çš„æ„é€ å™¨ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªç¤ºä¾‹ç±»ï¼Œåœ¨ç±»ä¸­å£°æ˜ä¸¤ä¸ªæ„é€ å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    String firstName;</span><br><span class="line">    String lastName;</span><br><span class="line"></span><br><span class="line">    Person() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Person(String firstName, String lastName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªå·¥å‚æ¥å£ï¼Œç”¨æ¥ç”Ÿæˆ <code>Person</code> ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Person å·¥å‚</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PersonFactory</span>&lt;<span class="title">P</span> <span class="keyword">extends</span> <span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">P <span class="title">create</span><span class="params">(String firstName, String lastName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>::</code> å…³é”®å­—æ¥å¼•ç”¨ <code>Person</code> ç±»çš„æ„é€ å™¨ï¼Œæ¥ä»£æ›¿æ‰‹åŠ¨å»å®ç°è¿™ä¸ªå·¥å‚æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥å¼•ç”¨ Person æ„é€ å™¨</span></span><br><span class="line">PersonFactory&lt;Person&gt; personFactory = Person::<span class="keyword">new</span>;</span><br><span class="line">Person person = personFactory.create(<span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Parker&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>Person::new</code> è¿™æ®µä»£ç ï¼Œèƒ½å¤Ÿç›´æ¥å¼•ç”¨ <code>Person</code> ç±»çš„æ„é€ å™¨ã€‚ç„¶å Java ç¼–è¯‘å™¨èƒ½å¤Ÿæ ¹æ®ä¸Šä¸‹æ–‡é€‰ä¸­æ­£ç¡®çš„æ„é€ å™¨å»å®ç° <code>PersonFactory.create</code> æ–¹æ³•ã€‚</p><h2 id="Lamdbaè®¿é—®å¤–éƒ¨å˜é‡åŠæ¥å£é»˜è®¤æ–¹æ³•"><a href="#Lamdbaè®¿é—®å¤–éƒ¨å˜é‡åŠæ¥å£é»˜è®¤æ–¹æ³•" class="headerlink" title="Lamdbaè®¿é—®å¤–éƒ¨å˜é‡åŠæ¥å£é»˜è®¤æ–¹æ³•"></a>Lamdbaè®¿é—®å¤–éƒ¨å˜é‡åŠæ¥å£é»˜è®¤æ–¹æ³•</h2><p>åœ¨æœ¬ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºå¦‚ä½•åœ¨ lambda è¡¨è¾¾å¼ä¸­è®¿é—®å¤–éƒ¨å˜é‡ï¼ˆåŒ…æ‹¬ï¼šå±€éƒ¨å˜é‡ï¼Œæˆå‘˜å˜é‡ï¼Œé™æ€å˜é‡ï¼Œæ¥å£çš„é»˜è®¤æ–¹æ³•.ï¼‰ï¼Œå®ƒä¸åŒ¿åå†…éƒ¨ç±»è®¿é—®å¤–éƒ¨å˜é‡å¾ˆç›¸ä¼¼ã€‚</p><h3 id="è®¿é—®å±€éƒ¨å˜é‡"><a href="#è®¿é—®å±€éƒ¨å˜é‡" class="headerlink" title="è®¿é—®å±€éƒ¨å˜é‡"></a>è®¿é—®å±€éƒ¨å˜é‡</h3><p>åœ¨ Lambda è¡¨è¾¾å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®å¤–éƒ¨çš„ <code>final</code> ç±»å‹å˜é‡ï¼Œå¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è½¬æ¢å™¨</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(F from)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">å¤åˆ¶ä»£ç </span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">Converter&lt;Integer, String&gt; stringConverter =</span><br><span class="line">        (from) -&gt; String.valueOf(from + num);</span><br><span class="line"></span><br><span class="line">stringConverter.convert(<span class="number">2</span>);     <span class="comment">// 3</span></span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>ä¸åŒ¿åå†…éƒ¨ç±»ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…æ˜¾å¼å£°æ˜ <code>num</code> å˜é‡ä¸º <code>final</code> ç±»å‹ï¼Œä¸‹é¢è¿™æ®µä»£ç åŒæ ·æœ‰æ•ˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">Converter&lt;Integer, String&gt; stringConverter =</span><br><span class="line">        (from) -&gt; String.valueOf(from + num);</span><br><span class="line"></span><br><span class="line">stringConverter.convert(<span class="number">2</span>);     <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ <code>num</code> å˜é‡å¿…é¡»ä¸ºéšå¼çš„ <code>final</code> ç±»å‹ï¼Œä½•ä¸ºéšå¼çš„ <code>final</code> å‘¢ï¼Ÿå°±æ˜¯è¯´åˆ°ç¼–è¯‘æœŸä¸ºæ­¢ï¼Œ<code>num</code> å¯¹è±¡æ˜¯ä¸èƒ½è¢«æ”¹å˜çš„ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå°±ä¸èƒ½è¢«ç¼–è¯‘é€šè¿‡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">Converter&lt;Integer, String&gt; stringConverter =</span><br><span class="line">        (from) -&gt; String.valueOf(from + num);</span><br><span class="line">num = <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ lambda è¡¨è¾¾å¼å†…éƒ¨æ”¹å˜ <code>num</code> å€¼åŒæ ·ç¼–è¯‘ä¸é€šè¿‡ï¼Œéœ€è¦æ³¨æ„, æ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">Converter&lt;Integer, String&gt; converter = (from) -&gt; &#123;</span><br><span class="line">String value = String.valueOf(from + num);</span><br><span class="line">num = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="è®¿é—®æˆå‘˜å˜é‡å’Œé™æ€å˜é‡"><a href="#è®¿é—®æˆå‘˜å˜é‡å’Œé™æ€å˜é‡" class="headerlink" title="è®¿é—®æˆå‘˜å˜é‡å’Œé™æ€å˜é‡"></a>è®¿é—®æˆå‘˜å˜é‡å’Œé™æ€å˜é‡</h3><p>ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œäº†è§£äº†å¦‚ä½•åœ¨ Lambda è¡¨è¾¾å¼ä¸­è®¿é—®å±€éƒ¨å˜é‡ã€‚ä¸å±€éƒ¨å˜é‡ç›¸æ¯”ï¼Œåœ¨ Lambda è¡¨è¾¾å¼ä¸­å¯¹æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ‹¥æœ‰è¯»å†™æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(F from)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lambda4</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é™æ€å˜é‡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> outerStaticNum;</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡</span></span><br><span class="line">    <span class="keyword">int</span> outerNum;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testScopes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Converter&lt;Integer, String&gt; stringConverter1 = (from) -&gt; &#123;</span><br><span class="line">            <span class="comment">// å¯¹æˆå‘˜å˜é‡èµ‹å€¼</span></span><br><span class="line">            outerNum = <span class="number">23</span>;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(from);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Converter&lt;Integer, String&gt; stringConverter2 = (from) -&gt; &#123;</span><br><span class="line">            <span class="comment">// å¯¹é™æ€å˜é‡èµ‹å€¼</span></span><br><span class="line">            outerStaticNum = <span class="number">72</span>;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(from);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¿é—®æ¥å£çš„é»˜è®¤æ–¹æ³•"><a href="#è®¿é—®æ¥å£çš„é»˜è®¤æ–¹æ³•" class="headerlink" title="è®¿é—®æ¥å£çš„é»˜è®¤æ–¹æ³•"></a>è®¿é—®æ¥å£çš„é»˜è®¤æ–¹æ³•</h3><p>è¿˜è®°å¾—ç¬¬ä¸€ç« èŠ‚ä¸­å®šä¹‰çš„é‚£ä¸ª <code>Formula</code> (å…¬å¼) æ¥å£å—ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Formula</span> </span>&#123;</span><br><span class="line"><span class="comment">// è®¡ç®—</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ±‚å¹³æ–¹æ ¹</span></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">double</span> <span class="title">sqrt</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Math.sqrt(a);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ—¶ï¼Œæˆ‘ä»¬åœ¨æ¥å£ä¸­å®šä¹‰äº†ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å®ç°çš„ <code>sqrt</code> æ±‚å¹³æ–¹æ ¹æ–¹æ³•ï¼Œåœ¨åŒ¿åå†…éƒ¨ç±»ä¸­æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¿é—®æ­¤æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Formula formula = <span class="keyword">new</span> Formula() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> sqrt(a * <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ lambda è¡¨è¾¾å¼ä¸­å¯ä¸è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Formula formula = (a) -&gt; sqrt(a * <span class="number">100</span>);</span><br></pre></td></tr></table></figure><p>å¸¦æœ‰é»˜è®¤å®ç°çš„æ¥å£æ–¹æ³•ï¼Œæ˜¯<strong>ä¸èƒ½</strong>åœ¨ lambda è¡¨è¾¾å¼ä¸­è®¿é—®çš„ï¼Œä¸Šé¢è¿™æ®µä»£ç å°†æ— æ³•è¢«ç¼–è¯‘é€šè¿‡ã€‚</p><h2 id="å†…ç½®çš„å‡½æ•°å¼æ¥å£"><a href="#å†…ç½®çš„å‡½æ•°å¼æ¥å£" class="headerlink" title="å†…ç½®çš„å‡½æ•°å¼æ¥å£"></a>å†…ç½®çš„å‡½æ•°å¼æ¥å£</h2><p>JDK 1.8 API åŒ…å«äº†å¾ˆå¤šå†…ç½®çš„å‡½æ•°å¼æ¥å£ã€‚å…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬åœ¨è€ç‰ˆæœ¬ä¸­ç»å¸¸è§åˆ°çš„ Comparator å’Œ Runnableï¼ŒJava 8 ä¸ºä»–ä»¬éƒ½æ·»åŠ äº† @FunctionalInterface æ³¨è§£ï¼Œä»¥ç”¨æ¥æ”¯æŒ Lambda è¡¨è¾¾å¼ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé™¤äº† Comparator å’Œ Runnable å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ–°çš„å‡½æ•°å¼æ¥å£ï¼Œå®ƒä»¬å¾ˆå¤šéƒ½å€Ÿé‰´äºçŸ¥åçš„ <a href="https://link.juejin.im/?target=https://github.com/google/guava">Google Guava</a> åº“ã€‚</p><h3 id="Predicateæ–­è¨€"><a href="#Predicateæ–­è¨€" class="headerlink" title="Predicateæ–­è¨€"></a>Predicateæ–­è¨€</h3><p><code>Predicate</code> æ˜¯ä¸€ä¸ªå¯ä»¥æŒ‡å®šå…¥å‚ç±»å‹ï¼Œå¹¶è¿”å› boolean å€¼çš„å‡½æ•°å¼æ¥å£ã€‚å®ƒå†…éƒ¨æä¾›äº†ä¸€äº›å¸¦æœ‰é»˜è®¤å®ç°çš„æ–¹æ³•ï¼Œå¯ä»¥ è¢«ç”¨æ¥ç»„åˆä¸€ä¸ªå¤æ‚çš„é€»è¾‘åˆ¤æ–­ï¼ˆ<code>and</code>, <code>or</code>, <code>negate</code>ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Predicate&lt;String&gt; predicate = (s) -&gt; s.length() &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">predicate.test(<span class="string">&quot;foo&quot;</span>);              <span class="comment">// true</span></span><br><span class="line">predicate.negate().test(<span class="string">&quot;foo&quot;</span>);     <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">Predicate&lt;Boolean&gt; nonNull = Objects::nonNull;</span><br><span class="line">Predicate&lt;Boolean&gt; isNull = Objects::isNull;</span><br><span class="line"></span><br><span class="line">Predicate&lt;String&gt; isEmpty = String::isEmpty;</span><br><span class="line">Predicate&lt;String&gt; isNotEmpty = isEmpty.negate();</span><br></pre></td></tr></table></figure><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p><code>Function</code> å‡½æ•°å¼æ¥å£çš„ä½œç”¨æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå…¶æä¾›ä¸€ä¸ªåŸæ–™ï¼Œä»–ç»™ç”Ÿäº§ä¸€ä¸ªæœ€ç»ˆçš„äº§å“ã€‚é€šè¿‡å®ƒæä¾›çš„é»˜è®¤æ–¹æ³•ï¼Œç»„åˆ,é“¾è¡Œå¤„ç†(<code>compose</code>, <code>andThen</code>)ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Function&lt;String, Integer&gt; toInteger = Integer::valueOf;</span><br><span class="line">Function&lt;String, String&gt; backToString = toInteger.andThen(String::valueOf);</span><br><span class="line"></span><br><span class="line">backToString.apply(<span class="string">&quot;123&quot;</span>);     <span class="comment">// &quot;123&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Supplierç”Ÿäº§è€…"><a href="#Supplierç”Ÿäº§è€…" class="headerlink" title="Supplierç”Ÿäº§è€…"></a>Supplierç”Ÿäº§è€…</h3><p><code>Supplier</code> ä¸ <code>Function</code> ä¸åŒï¼Œå®ƒä¸æ¥å—å…¥å‚ï¼Œç›´æ¥ä¸ºæˆ‘ä»¬ç”Ÿäº§ä¸€ä¸ªæŒ‡å®šçš„ç»“æœï¼Œæœ‰ç‚¹åƒç”Ÿäº§è€…æ¨¡å¼ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    String firstName;</span><br><span class="line">    String lastName;</span><br><span class="line"></span><br><span class="line">    Person() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Person(String firstName, String lastName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Supplier&lt;Person&gt; personSupplier = Person::<span class="keyword">new</span>;</span><br><span class="line">personSupplier.get();   <span class="comment">// new Person</span></span><br></pre></td></tr></table></figure><p>###Consumeræ¶ˆè´¹è€…</p><p>å¯¹äº <code>Consumer</code>ï¼Œæˆ‘ä»¬éœ€è¦æä¾›å…¥å‚ï¼Œç”¨æ¥è¢«æ¶ˆè´¹ï¼Œå¦‚ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    String firstName;</span><br><span class="line">    String lastName;</span><br><span class="line"></span><br><span class="line">    Person() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Person(String firstName, String lastName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Consumer&lt;Person&gt; greeter = (p) -&gt; System.out.println(<span class="string">&quot;Hello, &quot;</span> + p.firstName);</span><br><span class="line">greeter.accept(<span class="keyword">new</span> Person(<span class="string">&quot;Luke&quot;</span>, <span class="string">&quot;Skywalker&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="Comparator"><a href="#Comparator" class="headerlink" title="Comparator"></a>Comparator</h3><p><code>Comparator</code> åœ¨ Java 8 ä¹‹å‰æ˜¯ä½¿ç”¨æ¯”è¾ƒæ™®éçš„ã€‚Java 8 ä¸­é™¤äº†å°†å…¶å‡çº§æˆäº†å‡½æ•°å¼æ¥å£ï¼Œè¿˜ä¸ºå®ƒæ‹“å±•äº†ä¸€äº›é»˜è®¤æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Comparator&lt;Person&gt; comparator = (p1, p2) -&gt; p1.firstName.compareTo(p2.firstName);</span><br><span class="line"></span><br><span class="line">Person p1 = <span class="keyword">new</span> Person(<span class="string">&quot;John&quot;</span>, <span class="string">&quot;Doe&quot;</span>);</span><br><span class="line">Person p2 = <span class="keyword">new</span> Person(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Wonderland&quot;</span>);</span><br><span class="line"></span><br><span class="line">comparator.compare(p1, p2);             <span class="comment">// &gt; 0</span></span><br><span class="line">comparator.reversed().compare(p1, p2);  <span class="comment">// &lt; 0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h2><p>é¦–å…ˆï¼Œ<code>Optional</code> å®ƒä¸æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œè®¾è®¡å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ˆ<code>NullPointerException</code>ï¼‰ï¼Œè¦çŸ¥é“åœ¨ Java ç¼–ç¨‹ä¸­ï¼Œ ç©ºæŒ‡é’ˆå¼‚å¸¸å¯æ˜¯è‡­åæ˜­è‘—çš„ã€‚</p><p>è®©æˆ‘ä»¬æ¥å¿«é€Ÿäº†è§£ä¸€ä¸‹ <code>Optional</code> è¦å¦‚ä½•ä½¿ç”¨ï¼ä½ å¯ä»¥å°† <code>Optional</code> çœ‹åšæ˜¯åŒ…è£…å¯¹è±¡ï¼ˆå¯èƒ½æ˜¯ <code>null</code>, ä¹Ÿæœ‰å¯èƒ½é <code>null</code>ï¼‰çš„å®¹å™¨ã€‚å½“ä½ å®šä¹‰äº† ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡å¯èƒ½æ˜¯ç©ºï¼Œä¹Ÿæœ‰å¯èƒ½éç©ºçš„æ—¶å€™ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ç”¨ <code>Optional</code> æ¥åŒ…è£…å®ƒï¼Œè¿™ä¹Ÿæ˜¯åœ¨ Java 8 è¢«æ¨èä½¿ç”¨çš„åšæ³•ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Optional&lt;String&gt; optional = Optional.of(<span class="string">&quot;bam&quot;</span>);</span><br><span class="line"></span><br><span class="line">optional.isPresent();           <span class="comment">// true</span></span><br><span class="line">optional.get();                 <span class="comment">// &quot;bam&quot;</span></span><br><span class="line">optional.orElse(<span class="string">&quot;fallback&quot;</span>);    <span class="comment">// &quot;bam&quot;</span></span><br><span class="line"></span><br><span class="line">optional.ifPresent((s) -&gt; System.out.println(s.charAt(<span class="number">0</span>)));     <span class="comment">// &quot;b&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Streamæµ"><a href="#Streamæµ" class="headerlink" title="Streamæµ"></a>Streamæµ</h2><p><em>ä»€ä¹ˆæ˜¯ Stream æµï¼Ÿ</em></p><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>java.util.Stream</code> å¯¹ä¸€ä¸ªåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ çš„é›†åˆåšå„ç§æ“ä½œã€‚è¿™äº›æ“ä½œå¯èƒ½æ˜¯ <em>ä¸­é—´æ“ä½œ</em> äº¦æˆ–æ˜¯ <em>ç»ˆç«¯æ“ä½œ</em>ã€‚ ç»ˆç«¯æ“ä½œä¼šè¿”å›ä¸€ä¸ªç»“æœï¼Œè€Œä¸­é—´æ“ä½œä¼šè¿”å›ä¸€ä¸ª <code>Stream</code> æµã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ åªèƒ½å¯¹å®ç°äº† <code>java.util.Collection</code> æ¥å£çš„ç±»åšæµçš„æ“ä½œã€‚</p><blockquote><p><code>Map</code> ä¸æ”¯æŒ <code>Stream</code> æµã€‚</p></blockquote><p><code>Stream</code> æµæ”¯æŒåŒæ­¥æ‰§è¡Œï¼Œä¹Ÿæ”¯æŒå¹¶å‘æ‰§è¡Œã€‚</p><h3 id="Filterè¿‡æ»¤"><a href="#Filterè¿‡æ»¤" class="headerlink" title="Filterè¿‡æ»¤"></a>Filterè¿‡æ»¤</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>List</code> é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; stringCollection = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">stringCollection.add(<span class="string">&quot;ddd2&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;aaa2&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;bbb1&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;aaa1&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;bbb3&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;bbb2&quot;</span>);</span><br><span class="line">stringCollection.add(<span class="string">&quot;ddd1&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>Filter</code> çš„å…¥å‚æ˜¯ä¸€ä¸ª <code>Predicate</code>, ä¸Šé¢å·²ç»è¯´åˆ°ï¼Œ<code>Predicate</code> æ˜¯ä¸€ä¸ªæ–­è¨€çš„ä¸­é—´æ“ä½œï¼Œå®ƒèƒ½å¤Ÿå¸®æˆ‘ä»¬ç­›é€‰å‡ºæˆ‘ä»¬éœ€è¦çš„é›†åˆå…ƒç´ ã€‚å®ƒçš„è¿”å‚åŒæ · æ˜¯ä¸€ä¸ª <code>Stream</code> æµï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>foreach</code>ç»ˆç«¯æ“ä½œï¼Œæ¥æ‰“å°è¢«ç­›é€‰çš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stringCollection</span><br><span class="line">    .stream()</span><br><span class="line">    .filter((s) -&gt; s.startsWith(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">    .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;aaa2&quot;, &quot;aaa1&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š<code>foreach</code> æ˜¯ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œå®ƒçš„è¿”å‚æ˜¯ <code>void</code>, æˆ‘ä»¬æ— æ³•å¯¹å…¶å†æ¬¡è¿›è¡Œæµæ“ä½œã€‚</p></blockquote><h3 id="Sortedæ’åº"><a href="#Sortedæ’åº" class="headerlink" title="Sortedæ’åº"></a>Sortedæ’åº</h3><p><code>Sorted</code> åŒæ ·æ˜¯ä¸€ä¸ªä¸­é—´æ“ä½œï¼Œå®ƒçš„è¿”å‚æ˜¯ä¸€ä¸ª <code>Stream</code> æµã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ª <code>Comparator</code> ç”¨æ¥è‡ªå®šä¹‰æ’åºï¼Œå¦‚æœä¸ä¼ ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æ’åºè§„åˆ™ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stringCollection</span><br><span class="line">    .stream()</span><br><span class="line">    .sorted()</span><br><span class="line">    .filter((s) -&gt; s.startsWith(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">    .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;aaa1&quot;, &quot;aaa2&quot;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ï¼Œ<code>sorted</code> ä¸ä¼šå¯¹ <code>stringCollection</code> åšå‡ºä»»ä½•æ”¹å˜ï¼Œ<code>stringCollection</code> è¿˜æ˜¯åŸæœ‰çš„é‚£äº›ä¸ªå…ƒç´ ï¼Œä¸”é¡ºåºä¸å˜ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(stringCollection);</span><br><span class="line"><span class="comment">// ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1</span></span><br></pre></td></tr></table></figure><h3 id="Mapè½¬æ¢"><a href="#Mapè½¬æ¢" class="headerlink" title="Mapè½¬æ¢"></a>Mapè½¬æ¢</h3><p>ä¸­é—´æ“ä½œ <code>Map</code> èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å°† <code>List</code> ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ åšåŠŸèƒ½å¤„ç†ã€‚ä¾‹å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼Œé€šè¿‡ <code>map</code>æˆ‘ä»¬å°†æ¯ä¸€ä¸ª <code>string</code> è½¬æˆå¤§å†™ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stringCollection</span><br><span class="line">    .stream()</span><br><span class="line">    .map(String::toUpperCase)</span><br><span class="line">    .sorted((a, b) -&gt; b.compareTo(a))</span><br><span class="line">    .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;DDD2&quot;, &quot;DDD1&quot;, &quot;CCC&quot;, &quot;BBB3&quot;, &quot;BBB2&quot;, &quot;AAA2&quot;, &quot;AAA1&quot;</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšå¯¹è±¡ä¹‹é—´çš„è½¬æ¢ï¼Œä¸šåŠ¡ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯å°† <code>DO</code>ï¼ˆæ•°æ®åº“å¯¹è±¡ï¼‰ è½¬æ¢æˆ <code>BO</code>ï¼ˆä¸šåŠ¡å¯¹è±¡ï¼‰ ã€‚</p><h3 id="MatchåŒ¹é…"><a href="#MatchåŒ¹é…" class="headerlink" title="MatchåŒ¹é…"></a>MatchåŒ¹é…</h3><p>é¡¾åæ€ä¹‰ï¼Œ<code>match</code> ç”¨æ¥åšåŒ¹é…æ“ä½œï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>boolean</code> ç±»å‹ã€‚é€šè¿‡ <code>match</code>, æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„éªŒè¯ä¸€ä¸ª <code>list</code> ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªç±»å‹çš„å…ƒç´ ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// éªŒè¯ list ä¸­ string æ˜¯å¦æœ‰ä»¥ a å¼€å¤´çš„, åŒ¹é…åˆ°ç¬¬ä¸€ä¸ªï¼Œå³è¿”å› true</span></span><br><span class="line"><span class="keyword">boolean</span> anyStartsWithA =</span><br><span class="line">    stringCollection</span><br><span class="line">        .stream()</span><br><span class="line">        .anyMatch((s) -&gt; s.startsWith(<span class="string">&quot;a&quot;</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(anyStartsWithA);      <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯ list ä¸­ string æ˜¯å¦éƒ½æ˜¯ä»¥ a å¼€å¤´çš„</span></span><br><span class="line"><span class="keyword">boolean</span> allStartsWithA =</span><br><span class="line">    stringCollection</span><br><span class="line">        .stream()</span><br><span class="line">        .allMatch((s) -&gt; s.startsWith(<span class="string">&quot;a&quot;</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(allStartsWithA);      <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯ list ä¸­ string æ˜¯å¦éƒ½ä¸æ˜¯ä»¥ z å¼€å¤´çš„,</span></span><br><span class="line"><span class="keyword">boolean</span> noneStartsWithZ =</span><br><span class="line">    stringCollection</span><br><span class="line">        .stream()</span><br><span class="line">        .noneMatch((s) -&gt; s.startsWith(<span class="string">&quot;z&quot;</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(noneStartsWithZ);      <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="Countè®¡æ•°"><a href="#Countè®¡æ•°" class="headerlink" title="Countè®¡æ•°"></a>Countè®¡æ•°</h3><p><code>count</code> æ˜¯ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œå®ƒèƒ½å¤Ÿç»Ÿè®¡ <code>stream</code> æµä¸­çš„å…ƒç´ æ€»æ•°ï¼Œè¿”å›å€¼æ˜¯ <code>long</code> ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…ˆå¯¹ list ä¸­å­—ç¬¦ä¸²å¼€å¤´ä¸º b è¿›è¡Œè¿‡æ»¤ï¼Œè®©åç»Ÿè®¡æ•°é‡</span></span><br><span class="line"><span class="keyword">long</span> startsWithB =</span><br><span class="line">    stringCollection</span><br><span class="line">        .stream()</span><br><span class="line">        .filter((s) -&gt; s.startsWith(<span class="string">&quot;b&quot;</span>))</span><br><span class="line">        .count();</span><br><span class="line"></span><br><span class="line">System.out.println(startsWithB);    <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><h3 id="Reduceæ±‡èš"><a href="#Reduceæ±‡èš" class="headerlink" title="Reduceæ±‡èš"></a>Reduceæ±‡èš</h3><p><code>Reduce</code> ä¸­æ–‡ç¿»è¯‘ä¸ºï¼š<em>å‡å°‘ã€ç¼©å°</em>ã€‚é€šè¿‡å…¥å‚çš„ <code>Function</code>ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°† <code>list</code> å½’çº¦æˆä¸€ä¸ªå€¼ã€‚å®ƒçš„è¿”å›ç±»å‹æ˜¯ <code>Optional</code> ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Optional&lt;String&gt; reduced =</span><br><span class="line">    stringCollection</span><br><span class="line">        .stream()</span><br><span class="line">        .sorted()</span><br><span class="line">        .reduce((s1, s2) -&gt; s1 + <span class="string">&quot;#&quot;</span> + s2);</span><br><span class="line"></span><br><span class="line">reduced.ifPresent(System.out::println);</span><br><span class="line"><span class="comment">// &quot;aaa1#aaa2#bbb1#bbb2#bbb3#ccc#ddd1#ddd2&quot;</span></span><br></pre></td></tr></table></figure><p>##Parallel Streamså¹¶è¡Œæµ</p><p>å‰é¢ç« èŠ‚æˆ‘ä»¬è¯´è¿‡ï¼Œ<code>stream</code> æµæ˜¯æ”¯æŒ<strong>é¡ºåº</strong>å’Œ<strong>å¹¶è¡Œ</strong>çš„ã€‚é¡ºåºæµæ“ä½œæ˜¯å•çº¿ç¨‹æ“ä½œï¼Œè€Œå¹¶è¡Œæµæ˜¯é€šè¿‡å¤šçº¿ç¨‹æ¥å¤„ç†çš„ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç‰©ç†æœº å¤šæ ¸ CPU çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¤„ç†é€Ÿåº¦æ›´å¿«ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å« 1000000 UUID list é›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> max = <span class="number">1000000</span>;</span><br><span class="line">List&lt;String&gt; values = <span class="keyword">new</span> ArrayList&lt;&gt;(max);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">    UUID uuid = UUID.randomUUID();</span><br><span class="line">    values.add(uuid.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«é€šè¿‡é¡ºåºæµå’Œå¹¶è¡Œæµï¼Œå¯¹è¿™ä¸ª list è¿›è¡Œæ’åºï¼Œæµ‹ç®—è€—æ—¶:</p><h3 id="é¡ºåºæµæ’åº"><a href="#é¡ºåºæµæ’åº" class="headerlink" title="é¡ºåºæµæ’åº"></a>é¡ºåºæµæ’åº</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çº³ç§’</span></span><br><span class="line"><span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> count = values.stream().sorted().count();</span><br><span class="line">System.out.println(count);</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº³ç§’è½¬å¾®ç§’</span></span><br><span class="line"><span class="keyword">long</span> millis = TimeUnit.NANOSECONDS.toMillis(t1 - t0);</span><br><span class="line">System.out.println(String.format(<span class="string">&quot;é¡ºåºæµæ’åºè€—æ—¶: %d ms&quot;</span>, millis));</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡ºåºæµæ’åºè€—æ—¶: 899 ms</span></span><br></pre></td></tr></table></figure><h3 id="å¹¶è¡Œæµæ’åº"><a href="#å¹¶è¡Œæµæ’åº" class="headerlink" title="å¹¶è¡Œæµæ’åº"></a>å¹¶è¡Œæµæ’åº</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çº³ç§’</span></span><br><span class="line"><span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> count = values.parallelStream().sorted().count();</span><br><span class="line">System.out.println(count);</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº³ç§’è½¬å¾®ç§’</span></span><br><span class="line"><span class="keyword">long</span> millis = TimeUnit.NANOSECONDS.toMillis(t1 - t0);</span><br><span class="line">System.out.println(String.format(<span class="string">&quot;å¹¶è¡Œæµæ’åºè€—æ—¶: %d ms&quot;</span>, millis));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶è¡Œæµæ’åºè€—æ—¶: 472 ms</span></span><br></pre></td></tr></table></figure><p>æ­£å¦‚ä½ æ‰€è§ï¼ŒåŒæ ·çš„é€»è¾‘å¤„ç†ï¼Œé€šè¿‡å¹¶è¡Œæµï¼Œæˆ‘ä»¬çš„æ€§èƒ½æå‡äº†è¿‘ **50%**ã€‚å®Œæˆè¿™ä¸€åˆ‡ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ä»…ä»…æ˜¯å°† <code>stream</code> æ”¹æˆäº† <code>parallelStream</code>ã€‚</p><h2 id="Mapé›†åˆ"><a href="#Mapé›†åˆ" class="headerlink" title="Mapé›†åˆ"></a>Mapé›†åˆ</h2><p>å‰é¢å·²ç»æåˆ°è¿‡ <code>Map</code> æ˜¯ä¸æ”¯æŒ <code>Stream</code> æµçš„ï¼Œå› ä¸º <code>Map</code> æ¥å£å¹¶æ²¡æœ‰åƒ <code>Collection</code> æ¥å£é‚£æ ·ï¼Œå®šä¹‰äº† <code>stream()</code> æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶ <code>key</code>, <code>values</code>, <code>entry</code> ä½¿ç”¨ æµæ“ä½œï¼Œå¦‚ <code>map.keySet().stream()</code>, <code>map.values().stream()</code> å’Œ <code>map.entrySet().stream()</code>.</p><p>å¦å¤–, JDK 8 ä¸­å¯¹ <code>map</code> æä¾›äº†ä¸€äº›å…¶ä»–æ–°ç‰¹æ€§:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Integer, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// ä¸è€ç‰ˆä¸åŒçš„æ˜¯ï¼ŒputIfAbent() æ–¹æ³•åœ¨ put ä¹‹å‰ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¼šåˆ¤æ–­ key æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å› value, å¦åˆ™ put, å†è¿”å› value</span></span><br><span class="line">    map.putIfAbsent(i, <span class="string">&quot;val&quot;</span> + i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// forEach å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹ map è¿›è¡Œéå†æ“ä½œ</span></span><br><span class="line">map.forEach((key, value) -&gt; System.out.println(value));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„ <code>putIfAbsent()</code> å’Œ <code>forEach()</code> å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹æŸä¸ª <code>key</code> çš„å€¼åšç›¸å…³æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// computeIfPresent(), å½“ key å­˜åœ¨æ—¶ï¼Œæ‰ä¼šåšç›¸å…³å¤„ç†</span></span><br><span class="line"><span class="comment">// å¦‚ä¸‹ï¼šå¯¹ key ä¸º 3 çš„å€¼ï¼Œå†…éƒ¨ä¼šå…ˆåˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™åš value + key çš„æ‹¼æ¥æ“ä½œ</span></span><br><span class="line">map.computeIfPresent(<span class="number">3</span>, (num, val) -&gt; val + num);</span><br><span class="line">map.get(<span class="number">3</span>);             <span class="comment">// val33</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆåˆ¤æ–­ key ä¸º 9 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™åšåˆ é™¤æ“ä½œ</span></span><br><span class="line">map.computeIfPresent(<span class="number">9</span>, (num, val) -&gt; <span class="keyword">null</span>);</span><br><span class="line">map.containsKey(<span class="number">9</span>);     <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// computeIfAbsent(), å½“ key ä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šåšç›¸å…³å¤„ç†</span></span><br><span class="line"><span class="comment">// å¦‚ä¸‹ï¼šå…ˆåˆ¤æ–­ key ä¸º 23 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ </span></span><br><span class="line">map.computeIfAbsent(<span class="number">23</span>, num -&gt; <span class="string">&quot;val&quot;</span> + num);</span><br><span class="line">map.containsKey(<span class="number">23</span>);    <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆåˆ¤æ–­ key ä¸º 3 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†</span></span><br><span class="line">map.computeIfAbsent(<span class="number">3</span>, num -&gt; <span class="string">&quot;bam&quot;</span>);</span><br><span class="line">map.get(<span class="number">3</span>);             <span class="comment">// val33</span></span><br></pre></td></tr></table></figure><p>å…³äºåˆ é™¤æ“ä½œï¼ŒJDK 8 ä¸­æä¾›äº†èƒ½å¤Ÿæ–°çš„ <code>remove()</code> API:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.remove(<span class="number">3</span>, <span class="string">&quot;val3&quot;</span>);</span><br><span class="line">map.get(<span class="number">3</span>);             <span class="comment">// val33</span></span><br><span class="line"></span><br><span class="line">map.remove(<span class="number">3</span>, <span class="string">&quot;val33&quot;</span>);</span><br><span class="line">map.get(<span class="number">3</span>);             <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç ï¼Œåªæœ‰å½“ç»™å®šçš„ <code>key</code> å’Œ <code>value</code> å®Œå…¨åŒ¹é…æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œåˆ é™¤æ“ä½œã€‚</p><p>å…³äºæ·»åŠ æ–¹æ³•ï¼ŒJDK 8 ä¸­æä¾›äº†å¸¦æœ‰é»˜è®¤å€¼çš„ <code>getOrDefault()</code> æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è‹¥ key 42 ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› not found</span></span><br><span class="line">map.getOrDefault(<span class="number">42</span>, <span class="string">&quot;not found&quot;</span>);  <span class="comment">// not found</span></span><br></pre></td></tr></table></figure><p>å¯¹äº <code>value</code> çš„åˆå¹¶æ“ä½œä¹Ÿå˜å¾—æ›´åŠ ç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// merge æ–¹æ³•ï¼Œä¼šå…ˆåˆ¤æ–­è¿›è¡Œåˆå¹¶çš„ key æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ·»åŠ å…ƒç´ </span></span><br><span class="line">map.merge(<span class="number">9</span>, <span class="string">&quot;val9&quot;</span>, (value, newValue) -&gt; value.concat(newValue));</span><br><span class="line">map.get(<span class="number">9</span>);             <span class="comment">// val9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‹¥ key çš„å…ƒç´ å­˜åœ¨ï¼Œåˆ™å¯¹ value æ‰§è¡Œæ‹¼æ¥æ“ä½œ</span></span><br><span class="line">map.merge(<span class="number">9</span>, <span class="string">&quot;concat&quot;</span>, (value, newValue) -&gt; value.concat(newValue));</span><br><span class="line">map.get(<span class="number">9</span>);             <span class="comment">// val9concat</span></span><br></pre></td></tr></table></figure><h2 id="æ–°çš„æ—¥æœŸAPI"><a href="#æ–°çš„æ—¥æœŸAPI" class="headerlink" title="æ–°çš„æ—¥æœŸAPI"></a>æ–°çš„æ—¥æœŸAPI</h2><p>Java 8 ä¸­åœ¨åŒ… <code>java.time</code> ä¸‹æ·»åŠ äº†æ–°çš„æ—¥æœŸ API. å®ƒå’Œ <a href="https://link.juejin.im/?target=http://www.joda.org/joda-time/">Joda-Time</a> åº“ç›¸ä¼¼ï¼Œä½†åˆä¸å®Œå…¨ç›¸åŒã€‚</p><h3 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a>Clock</h3><p><code>Clock</code> æä¾›å¯¹å½“å‰æ—¥æœŸå’Œæ—¶é—´çš„è®¿é—®ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥æ›¿ä»£ <code>System.currentTimeMillis()</code> æ–¹æ³•ã€‚å¦å¤–ï¼Œé€šè¿‡ <code>clock.instant()</code> èƒ½å¤Ÿè·å–ä¸€ä¸ª <code>instant</code> å®ä¾‹ï¼Œ æ­¤å®ä¾‹èƒ½å¤Ÿæ–¹ä¾¿åœ°è½¬æ¢æˆè€ç‰ˆæœ¬ä¸­çš„ <code>java.util.Date</code> å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Clock clock = Clock.systemDefaultZone();</span><br><span class="line"><span class="keyword">long</span> millis = clock.millis();</span><br><span class="line"></span><br><span class="line">Instant instant = clock.instant();</span><br><span class="line">Date legacyDate = Date.from(instant);   <span class="comment">// è€ç‰ˆæœ¬ java.util.Date</span></span><br></pre></td></tr></table></figure><h3 id="Timezonesæ—¶åŒº"><a href="#Timezonesæ—¶åŒº" class="headerlink" title="Timezonesæ—¶åŒº"></a>Timezonesæ—¶åŒº</h3><p><code>ZoneId</code> ä»£è¡¨æ—¶åŒºç±»ã€‚é€šè¿‡é™æ€å·¥å‚æ–¹æ³•æ–¹ä¾¿åœ°è·å–å®ƒï¼Œå…¥å‚æˆ‘ä»¬å¯ä»¥ä¼ å…¥æŸä¸ªæ—¶åŒºç¼–ç ã€‚å¦å¤–ï¼Œæ—¶åŒºç±»è¿˜å®šä¹‰äº†ä¸€ä¸ªåç§»é‡ï¼Œç”¨æ¥åœ¨å½“å‰æ—¶åˆ»æˆ–æŸæ—¶é—´ ä¸ç›®æ ‡æ—¶åŒºæ—¶é—´ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(ZoneId.getAvailableZoneIds());</span><br><span class="line"><span class="comment">// prints all available timezone ids</span></span><br><span class="line"></span><br><span class="line">ZoneId zone1 = ZoneId.of(<span class="string">&quot;Europe/Berlin&quot;</span>);</span><br><span class="line">ZoneId zone2 = ZoneId.of(<span class="string">&quot;Brazil/East&quot;</span>);</span><br><span class="line">System.out.println(zone1.getRules());</span><br><span class="line">System.out.println(zone2.getRules());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZoneRules[currentStandardOffset=+01:00]</span></span><br><span class="line"><span class="comment">// ZoneRules[currentStandardOffset=-03:00]</span></span><br></pre></td></tr></table></figure><h3 id="LocalTime"><a href="#LocalTime" class="headerlink" title="LocalTime"></a>LocalTime</h3><p><code>LocalTime</code> è¡¨ç¤ºä¸€ä¸ªæ²¡æœ‰æŒ‡å®šæ—¶åŒºçš„æ—¶é—´ç±»ï¼Œä¾‹å¦‚ï¼Œ<code>10 p.m</code>.æˆ–è€… <code>17ï¼š30:15</code>ï¼Œä¸‹é¢ç¤ºä¾‹ä»£ç ä¸­ï¼Œå°†ä¼šä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ æ—¶åŒºå¯¹è±¡åˆ›å»ºä¸¤ä¸ª <code>LocalTime</code>ã€‚ç„¶åæˆ‘ä»¬ä¼šæ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ï¼Œå¹¶è®¡ç®—å®ƒä»¬ä¹‹é—´çš„å°æ—¶å’Œåˆ†é’Ÿçš„ä¸åŒã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalTime now1 = LocalTime.now(zone1);</span><br><span class="line">LocalTime now2 = LocalTime.now(zone2);</span><br><span class="line"></span><br><span class="line">System.out.println(now1.isBefore(now2));  <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> hoursBetween = ChronoUnit.HOURS.between(now1, now2);</span><br><span class="line"><span class="keyword">long</span> minutesBetween = ChronoUnit.MINUTES.between(now1, now2);</span><br><span class="line"></span><br><span class="line">System.out.println(hoursBetween);       <span class="comment">// -3</span></span><br><span class="line">System.out.println(minutesBetween);     <span class="comment">// -239</span></span><br></pre></td></tr></table></figure><p><code>LocalTime</code> æä¾›å¤šä¸ªé™æ€å·¥å‚æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¯¹æ—¶é—´å¯¹è±¡å®ä¾‹çš„åˆ›å»ºå’Œæ“ä½œï¼ŒåŒ…æ‹¬å¯¹æ—¶é—´å­—ç¬¦ä¸²è¿›è¡Œè§£æçš„æ“ä½œç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalTime late = LocalTime.of(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">System.out.println(late);       <span class="comment">// 23:59:59</span></span><br><span class="line"></span><br><span class="line">DateTimeFormatter germanFormatter =</span><br><span class="line">    DateTimeFormatter</span><br><span class="line">        .ofLocalizedTime(FormatStyle.SHORT)</span><br><span class="line">        .withLocale(Locale.GERMAN);</span><br><span class="line"></span><br><span class="line">LocalTime leetTime = LocalTime.parse(<span class="string">&quot;13:37&quot;</span>, germanFormatter);</span><br><span class="line">System.out.println(leetTime);   <span class="comment">// 13:37</span></span><br></pre></td></tr></table></figure><h3 id="LocalDate"><a href="#LocalDate" class="headerlink" title="LocalDate"></a>LocalDate</h3><p><code>LocalDate</code> æ˜¯ä¸€ä¸ªæ—¥æœŸå¯¹è±¡ï¼Œä¾‹å¦‚ï¼š<code>2014-03-11</code>ã€‚å®ƒå’Œ <code>LocalTime</code> ä¸€æ ·æ˜¯ä¸ª <code>final</code> ç±»å‹å¯¹è±¡ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡åŠ å‡æ—¥ï¼Œæœˆï¼Œå¹´ç­‰æ¥è®¡ç®—ä¸€ä¸ªæ–°çš„æ—¥æœŸã€‚</p><blockquote><p><code>LocalDate</code>, <code>LocalTime</code>, å› ä¸ºæ˜¯ <code>final</code> ç±»å‹çš„å¯¹è±¡ï¼Œæ¯ä¸€æ¬¡æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„æ—¶é—´å¯¹è±¡ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line"><span class="comment">// ä»Šå¤©åŠ ä¸€å¤©</span></span><br><span class="line">LocalDate tomorrow = today.plus(<span class="number">1</span>, ChronoUnit.DAYS);</span><br><span class="line"><span class="comment">// æ˜å¤©å‡ä¸¤å¤©</span></span><br><span class="line">LocalDate yesterday = tomorrow.minusDays(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2014 å¹´ä¸ƒæœˆçš„ç¬¬å››å¤©</span></span><br><span class="line">LocalDate independenceDay = LocalDate.of(<span class="number">2014</span>, Month.JULY, <span class="number">4</span>);</span><br><span class="line">DayOfWeek dayOfWeek = independenceDay.getDayOfWeek();</span><br><span class="line">System.out.println(dayOfWeek);    <span class="comment">// æ˜ŸæœŸäº”</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥è§£ææ—¥æœŸå­—ç¬¦ä¸²ï¼Œç”Ÿæˆ <code>LocalDate</code> å®ä¾‹ã€‚ï¼ˆå’Œ <code>LocalTime</code> æ“ä½œä¸€æ ·ç®€å•ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DateTimeFormatter germanFormatter =</span><br><span class="line">    DateTimeFormatter</span><br><span class="line">        .ofLocalizedDate(FormatStyle.MEDIUM)</span><br><span class="line">        .withLocale(Locale.GERMAN);</span><br><span class="line"></span><br><span class="line">LocalDate xmas = LocalDate.parse(<span class="string">&quot;24.12.2014&quot;</span>, germanFormatter);</span><br><span class="line">System.out.println(xmas);   <span class="comment">// 2014-12-24</span></span><br></pre></td></tr></table></figure><h3 id="LocalDateTime"><a href="#LocalDateTime" class="headerlink" title="LocalDateTime"></a>LocalDateTime</h3><p><code>LocalDateTime</code> æ˜¯ä¸€ä¸ª<strong>æ—¥æœŸ-æ—¶é—´</strong>å¯¹è±¡ã€‚ä½ ä¹Ÿå¯ä»¥å°†å…¶çœ‹æˆæ˜¯ <code>LocalDate</code> å’Œ <code>LocalTime</code> çš„ç»“åˆä½“ã€‚æ“ä½œä¸Šï¼Œä¹Ÿå¤§è‡´ç›¸åŒã€‚</p><blockquote><p><code>LocalDateTime</code> åŒæ ·æ˜¯ä¸€ä¸ª <code>final</code> ç±»å‹å¯¹è±¡ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDateTime sylvester = LocalDateTime.of(<span class="number">2014</span>, Month.DECEMBER, <span class="number">31</span>, <span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line"></span><br><span class="line">DayOfWeek dayOfWeek = sylvester.getDayOfWeek();</span><br><span class="line">System.out.println(dayOfWeek);      <span class="comment">// æ˜ŸæœŸä¸‰</span></span><br><span class="line"></span><br><span class="line">Month month = sylvester.getMonth();</span><br><span class="line">System.out.println(month);          <span class="comment">// åäºŒæœˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ”¹æ—¶é—´æ˜¯è¯¥å¤©ä¸­çš„ç¬¬å‡ åˆ†é’Ÿ</span></span><br><span class="line"><span class="keyword">long</span> minuteOfDay = sylvester.getLong(ChronoField.MINUTE_OF_DAY);</span><br><span class="line">System.out.println(minuteOfDay);    <span class="comment">// 1439</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœå†åŠ ä¸Šçš„æ—¶åŒºä¿¡æ¯ï¼Œ<code>LocalDateTime</code> è¿˜èƒ½å¤Ÿè¢«è½¬æ¢æˆ <code>Instance</code> å®ä¾‹ã€‚<code>Instance</code> èƒ½å¤Ÿè¢«è½¬æ¢æˆè€ç‰ˆæœ¬ä¸­ <code>java.util.Date</code> å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Instant instant = sylvester</span><br><span class="line">        .atZone(ZoneId.systemDefault())</span><br><span class="line">        .toInstant();</span><br><span class="line"></span><br><span class="line">Date legacyDate = Date.from(instant);</span><br><span class="line">System.out.println(legacyDate);     <span class="comment">// Wed Dec 31 23:59:59 CET 2014</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ ¼å¼åŒ– <code>LocalDateTime</code> å¯¹è±¡å°±å’Œæ ¼å¼åŒ– LocalDate æˆ–è€… LocalTime ä¸€æ ·ã€‚é™¤äº†ä½¿ç”¨é¢„å®šä¹‰çš„æ ¼å¼ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ ¼å¼åŒ–è¾“å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DateTimeFormatter formatter =</span><br><span class="line">    DateTimeFormatter</span><br><span class="line">        .ofPattern(<span class="string">&quot;MMM dd, yyyy - HH:mm&quot;</span>);</span><br><span class="line"></span><br><span class="line">LocalDateTime parsed = LocalDateTime.parse(<span class="string">&quot;Nov 03, 2014 - 07:13&quot;</span>, formatter);</span><br><span class="line">String string = formatter.format(parsed);</span><br><span class="line">System.out.println(string);     <span class="comment">// Nov 03, 2014 - 07:13</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šå’Œ <code>java.text.NumberFormat</code> ä¸åŒï¼Œæ–°çš„ <code>DateTimeFormatter</code> ç±»æ˜¯ <code>final</code> ç±»å‹çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></blockquote><h2 id="Annotationsæ³¨è§£"><a href="#Annotationsæ³¨è§£" class="headerlink" title="Annotationsæ³¨è§£"></a>Annotationsæ³¨è§£</h2><p>åœ¨ Java 8 ä¸­ï¼Œæ³¨è§£æ˜¯å¯ä»¥é‡å¤çš„ã€‚è®©æˆ‘é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œæ¥çœ‹çœ‹åˆ°åº•æ˜¯å’‹å›äº‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ…è£…æ³¨è§£ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªæœ‰ç€å®é™…æ³¨è§£çš„æ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@interface</span> Hints &#123;</span><br><span class="line">    Hint[] value();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repeatable(Hints.class)</span></span><br><span class="line"><span class="meta">@interface</span> Hint &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Java 8 ä¸­ï¼Œé€šè¿‡ <code>@Repeatable</code>ï¼Œå…è®¸æˆ‘ä»¬å¯¹åŒä¸€ä¸ªç±»ä½¿ç”¨å¤šé‡æ³¨è§£ï¼š</p><p>ç¬¬ä¸€ç§å½¢æ€ï¼šä½¿ç”¨æ³¨è§£å®¹å™¨ï¼ˆè€æ–¹æ³•ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Hints(&#123;@Hint(&quot;hint1&quot;), @Hint(&quot;hint2&quot;)&#125;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§å½¢æ€ï¼šä½¿ç”¨å¯é‡å¤æ³¨è§£ï¼ˆæ–°æ–¹æ³•ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Hint(&quot;hint1&quot;)</span></span><br><span class="line"><span class="meta">@Hint(&quot;hint2&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¬¬äºŒç§å½¢æ€ï¼ŒJava ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨å†…éƒ¨è‡ªåŠ¨å¯¹ <code>@Hint</code> è¿›è¡Œè®¾ç½®ã€‚è¿™å¯¹äºéœ€è¦é€šè¿‡åå°„æ¥è¯»å–æ³¨è§£ä¿¡æ¯æ—¶ï¼Œæ˜¯éå¸¸é‡è¦çš„ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hint hint = Person.class.getAnnotation(Hint.class);</span><br><span class="line">System.out.println(hint);                   <span class="comment">// null</span></span><br><span class="line"></span><br><span class="line">Hints hints1 = Person.class.getAnnotation(Hints.class);</span><br><span class="line">System.out.println(hints1.value().length);  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">Hint[] hints2 = Person.class.getAnnotationsByType(Hint.class);</span><br><span class="line">System.out.println(hints2.length);          <span class="comment">// 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å°½ç®¡æˆ‘ä»¬ç»å¯¹ä¸ä¼šåœ¨ <code>Person</code> ç±»ä¸Šå£°æ˜ <code>@Hints</code> æ³¨è§£ï¼Œä½†æ˜¯å®ƒçš„ä¿¡æ¯ä»ç„¶æ˜¯å¯ä»¥é€šè¿‡ <code>getAnnotation(Hints.class)</code> æ¥è¯»å–çš„ã€‚ å¹¶ä¸”ï¼Œ<code>getAnnotationsByType</code> æ–¹æ³•ä¼šæ›´æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒèµ‹äºˆäº†æ‰€æœ‰ <code>@Hints</code> æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ç›´æ¥çš„è®¿é—®æƒé™ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE_PARAMETER, ElementType.TYPE_USE&#125;)</span></span><br><span class="line"><span class="meta">@interface</span> MyAnnotation &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆåˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªï¼‰</title>
      <link href="/blog/2019/01/04/a773bf3d.html"/>
      <url>/blog/2019/01/04/a773bf3d.html</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h2><p>ä¸€èˆ¬çš„ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡è·Ÿè¸ªç³»ç»Ÿä¸»è¦ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š</p><ul><li>æ•°æ®æ”¶é›†</li><li>æ•°æ®å­˜å‚¨</li><li>æ•°æ®å±•ç¤º</li></ul><p>æ ¹æ®ç³»ç»Ÿå¤§å°ä¸åŒï¼Œæ¯ä¸€éƒ¨åˆ†çš„ç»“æ„åˆæœ‰ä¸€å®šå˜åŒ–ã€‚è­¬å¦‚ï¼Œå¯¹äºå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ•°æ®å­˜å‚¨å¯åˆ†ä¸ºå®æ—¶æ•°æ®å’Œå…¨é‡æ•°æ®ä¸¤éƒ¨åˆ†ï¼Œå®æ—¶æ•°æ®ç”¨äºæ•…éšœæ’æŸ¥ï¼ˆ<code>Trouble Shooting</code>ï¼‰ï¼Œå…¨é‡æ•°æ®ç”¨äºç³»ç»Ÿä¼˜åŒ–ï¼›æ•°æ®æ”¶é›†é™¤äº†æ”¯æŒå¹³å°æ— å…³å’Œå¼€å‘è¯­è¨€æ— å…³ç³»ç»Ÿçš„æ•°æ®æ”¶é›†ï¼Œè¿˜åŒ…æ‹¬å¼‚æ­¥æ•°æ®æ”¶é›†ï¼ˆéœ€è¦è·Ÿè¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œä¿è¯è°ƒç”¨çš„è¿è´¯æ€§ï¼‰ï¼Œä»¥åŠç¡®ä¿æ›´å°çš„ä¾µå…¥æ€§ï¼›æ•°æ®å±•ç¤ºåˆæ¶‰åŠåˆ°æ•°æ®æŒ–æ˜å’Œåˆ†æã€‚è™½ç„¶æ¯ä¸€éƒ¨åˆ†éƒ½å¯èƒ½å˜å¾—å¾ˆå¤æ‚ï¼Œä½†åŸºæœ¬åŸç†éƒ½ç±»ä¼¼ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/a1.png" alt="åˆ†å¸ƒå¼æœåŠ¡è·Ÿè¸ª"></p><p>æœåŠ¡è¿½è¸ªçš„è¿½è¸ªå•å…ƒæ˜¯ä»å®¢æˆ·å‘èµ·è¯·æ±‚ï¼ˆ<code>request</code>ï¼‰æŠµè¾¾è¢«è¿½è¸ªç³»ç»Ÿçš„è¾¹ç•Œå¼€å§‹ï¼Œåˆ°è¢«è¿½è¸ªç³»ç»Ÿå‘å®¢æˆ·è¿”å›å“åº”ï¼ˆ<code>response</code>ï¼‰ä¸ºæ­¢çš„è¿‡ç¨‹ï¼Œç§°ä¸ºä¸€ä¸ª<code>trace</code>ã€‚æ¯ä¸ª <code>trace</code> ä¸­ä¼šè°ƒç”¨è‹¥å¹²ä¸ªæœåŠ¡ï¼Œä¸ºäº†è®°å½•è°ƒç”¨äº†å“ªäº›æœåŠ¡ï¼Œä»¥åŠæ¯æ¬¡è°ƒç”¨çš„æ¶ˆè€—æ—¶é—´ç­‰ä¿¡æ¯ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨æœåŠ¡æ—¶ï¼ŒåŸ‹å…¥ä¸€ä¸ªè°ƒç”¨è®°å½•ï¼Œç§°ä¸ºä¸€ä¸ª<code>span</code>ã€‚è¿™æ ·ï¼Œè‹¥å¹²ä¸ªæœ‰åºçš„ <code>span</code> å°±ç»„æˆäº†ä¸€ä¸ª <code>trace</code>ã€‚åœ¨ç³»ç»Ÿå‘å¤–ç•Œæä¾›æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸æ–­åœ°æœ‰è¯·æ±‚å’Œå“åº”å‘ç”Ÿï¼Œä¹Ÿå°±ä¼šä¸æ–­ç”Ÿæˆ <code>trace</code>ï¼ŒæŠŠè¿™äº›å¸¦æœ‰<code>span</code> çš„ <code>trace</code> è®°å½•ä¸‹æ¥ï¼Œå°±å¯ä»¥æç»˜å‡ºä¸€å¹…ç³»ç»Ÿçš„æœåŠ¡æ‹“æ‰‘å›¾ã€‚é™„å¸¦ä¸Š <code>span</code> ä¸­çš„å“åº”æ—¶é—´ï¼Œä»¥åŠè¯·æ±‚æˆåŠŸä¸å¦ç­‰ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨å‘ç”Ÿé—®é¢˜çš„æ—¶å€™ï¼Œæ‰¾åˆ°å¼‚å¸¸çš„æœåŠ¡ï¼›æ ¹æ®å†å²æ•°æ®ï¼Œè¿˜å¯ä»¥ä»ç³»ç»Ÿæ•´ä½“å±‚é¢åˆ†æå‡ºå“ªé‡Œæ€§èƒ½å·®ï¼Œå®šä½æ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ã€‚</p><p><code>Spring Cloud Sleuth</code>ä¸ºæœåŠ¡ä¹‹é—´è°ƒç”¨æä¾›é“¾è·¯è¿½è¸ªã€‚é€šè¿‡<code>Sleuth</code>å¯ä»¥å¾ˆæ¸…æ¥šçš„äº†è§£åˆ°ä¸€ä¸ªæœåŠ¡è¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡å¤„ç†èŠ±è´¹äº†å¤šé•¿ã€‚ä»è€Œè®©æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç†æ¸…å„å¾®æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»ã€‚æ­¤å¤–<code>Sleuth</code>å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š</p><ul><li>è€—æ—¶åˆ†æ: é€šè¿‡<code>Sleuth</code>å¯ä»¥å¾ˆæ–¹ä¾¿çš„äº†è§£åˆ°æ¯ä¸ªé‡‡æ ·è¯·æ±‚çš„è€—æ—¶ï¼Œä»è€Œåˆ†æå‡ºå“ªäº›æœåŠ¡è°ƒç”¨æ¯”è¾ƒè€—æ—¶;</li><li>å¯è§†åŒ–é”™è¯¯: å¯¹äºç¨‹åºæœªæ•æ‰çš„å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡é›†æˆZipkinæœåŠ¡ç•Œé¢ä¸Šçœ‹åˆ°;</li><li>é“¾è·¯ä¼˜åŒ–: å¯¹äºè°ƒç”¨æ¯”è¾ƒé¢‘ç¹çš„æœåŠ¡ï¼Œå¯ä»¥é’ˆå¯¹è¿™äº›æœåŠ¡å®æ–½ä¸€äº›ä¼˜åŒ–æªæ–½ã€‚</li></ul><p><code>spring cloud sleuth</code>å¯ä»¥ç»“åˆ<code>zipkin</code>ï¼Œå°†ä¿¡æ¯å‘é€åˆ°<code>zipkin</code>ï¼Œåˆ©ç”¨<code>zipkin</code>çš„å­˜å‚¨æ¥å­˜å‚¨ä¿¡æ¯ï¼Œåˆ©ç”¨<code>zipkin ui</code>æ¥å±•ç¤ºæ•°æ®ã€‚</p><p>è¿™æ˜¯<code>Spring Cloud Sleuth</code>çš„æ¦‚å¿µå›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/a2.png" alt="trace"></p><p>-</p><h2 id="ZipKin"><a href="#ZipKin" class="headerlink" title="ZipKin"></a>ZipKin</h2><p><code>Zipkin</code> æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”±<code>Twitter</code>å…¬å¸å¼€æºï¼Œå®ƒè‡´åŠ›äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚</p><p>æ¯ä¸ªæœåŠ¡å‘<code>zipkin</code>æŠ¥å‘Šè®¡æ—¶æ•°æ®ï¼Œ<code>zipkin</code>ä¼šæ ¹æ®è°ƒç”¨å…³ç³»é€šè¿‡<code>Zipkin UI</code>ç”Ÿæˆä¾èµ–å…³ç³»å›¾ï¼Œæ˜¾ç¤ºäº†å¤šå°‘è·Ÿè¸ªè¯·æ±‚é€šè¿‡æ¯ä¸ªæœåŠ¡ï¼Œè¯¥ç³»ç»Ÿè®©å¼€å‘è€…å¯é€šè¿‡ä¸€ä¸ª <code>Web</code> å‰ç«¯è½»æ¾çš„æ”¶é›†å’Œåˆ†ææ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·æ¯æ¬¡è¯·æ±‚æœåŠ¡çš„å¤„ç†æ—¶é—´ç­‰ï¼Œå¯æ–¹ä¾¿çš„ç›‘æµ‹ç³»ç»Ÿä¸­å­˜åœ¨çš„ç“¶é¢ˆã€‚</p><p><code>Zipkin</code>æä¾›äº†å¯æ’æ‹”æ•°æ®å­˜å‚¨æ–¹å¼ï¼š<code>In-Memory</code>ã€<code>MySql</code>ã€<code>Cassandra</code>ä»¥åŠ<code>Elasticsearch</code>ã€‚</p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p><code>Zipkin</code> åˆ†ä¸ºä¸¤ç«¯ï¼Œä¸€ä¸ªæ˜¯ <code>Zipkin</code> æœåŠ¡ç«¯ï¼Œä¸€ä¸ªæ˜¯ <code>Zipkin</code> å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯å¾®æœåŠ¡çš„åº”ç”¨ã€‚<br>å®¢æˆ·ç«¯ä¼šé…ç½®æœåŠ¡ç«¯çš„ <code>URL</code> åœ°å€ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡é—´çš„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè¢«é…ç½®åœ¨å¾®æœåŠ¡é‡Œé¢çš„ <code>Sleuth</code> çš„ç›‘å¬å™¨ç›‘å¬ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ <code>Trace</code> å’Œ <code>Span</code> ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚<br>å‘é€çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ <code>HTTP</code> æŠ¥æ–‡çš„æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ¶ˆæ¯æ€»çº¿çš„æ–¹å¼å¦‚ <code>RabbitMQ</code>ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>æ— è®ºæ˜¯ç”¨<code>HTTP</code>çš„æ–¹å¼è¿˜æ˜¯<code>æ¶ˆæ¯æ€»çº¿</code>çš„æ–¹å¼ï¼Œéƒ½éœ€è¦ï¼š</p><ul><li>ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨ä¹‹å‰çš„å°±è¡Œ</li><li>ä¸€ä¸ªZipkinæœåŠ¡ç«¯</li><li>ä¸¤ä¸ªå¾®æœåŠ¡åº”ç”¨ï¼Œ<code>trace-a</code>å’Œ<code>trace-b</code>ï¼Œå…¶ä¸­<code>trace-a</code>ä¸­æœ‰ä¸€ä¸ª REST æ¥å£<code>/trace-a</code>ï¼Œè°ƒç”¨è¯¥æ¥å£åå°†è§¦å‘å¯¹<code>trace-b</code>åº”ç”¨çš„è°ƒç”¨ã€‚</li></ul><h4 id="ZipkinæœåŠ¡ç«¯"><a href="#ZipkinæœåŠ¡ç«¯" class="headerlink" title="ZipkinæœåŠ¡ç«¯"></a>ZipkinæœåŠ¡ç«¯</h4><p>ä½¿ç”¨<code>Docker</code>ï¼š</p><ol><li><p>pull image</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull openzipkin/zipkin</span><br></pre></td></tr></table></figure></li><li><p>run container</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d -p 9411:9411 openzipkin/zipkin</span><br></pre></td></tr></table></figure></li></ol><p>å¯åŠ¨åï¼Œè®¿é—®<a href="http://localhost:9411/zipkin/">http://localhost:9411/zipkin/</a>å°±èƒ½çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/3.png" alt="zipkin"></p><p>-</p><p>æœåŠ¡ç«¯<code>OK</code>ã€‚</p><h4 id="å¾®æœåŠ¡åº”ç”¨"><a href="#å¾®æœåŠ¡åº”ç”¨" class="headerlink" title="å¾®æœåŠ¡åº”ç”¨"></a>å¾®æœåŠ¡åº”ç”¨</h4><p>åˆ›å»ºä¸¤ä¸ªåŸºæœ¬çš„<code>Spring Boot</code>å·¥ç¨‹ï¼Œåˆ†åˆ«åä¸º<code>trace-a</code>å’Œ<code>trace-b</code>ã€‚</p><h3 id="pomé…ç½®"><a href="#pomé…ç½®" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h3><p>ä¸¤ä¸ªå·¥ç¨‹çš„<code>pom</code>æ–‡ä»¶é…ç½®éƒ½å¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>ä¸¤è€…çš„é…ç½®æ–‡ä»¶ä¹Ÿä¸€æ ·ï¼ˆé™¤äº†<code>spring. application.name</code>å’Œ<code>server.port</code>ï¼Œè‡ªè¡Œä¿®æ”¹ï¼‰</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">trace-a</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment"># å°†é‡‡æ ·æ¯”ä¾‹è®¾ç½®ä¸º 1.0ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨éƒ½éœ€è¦ã€‚é»˜è®¤æ˜¯ 0.1</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411/</span> <span class="comment"># æŒ‡å®šäº† Zipkin æœåŠ¡å™¨çš„åœ°å€</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28092</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Sleuth æœ‰ä¸€ä¸ª Sampler ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå®ç°ç±»æ¥æ§åˆ¶é‡‡æ ·ç®—æ³•ã€‚é‡‡æ ·å™¨ä¸ä¼šé˜»ç¢ span ç›¸å…³ id çš„äº§ç”Ÿï¼Œä½†æ˜¯ä¼šå¯¹å¯¼å‡ºä»¥åŠé™„åŠ äº‹ä»¶æ ‡ç­¾çš„ç›¸å…³æ“ä½œé€ æˆå½±å“ã€‚ Sleuth é»˜è®¤é‡‡æ ·ç®—æ³•çš„å®ç°æ˜¯ Reservoir samplingï¼Œå…·ä½“çš„å®ç°ç±»æ˜¯ PercentageBasedSamplerï¼Œé»˜è®¤çš„é‡‡æ ·æ¯”ä¾‹ä¸º: 0.1(å³ 10%)ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>spring.sleuth.sampler.percentage</code>æ¥è®¾ç½®ï¼Œæ‰€è®¾ç½®çš„å€¼ä»‹äº 0.0 åˆ° 1.0 ä¹‹é—´ï¼Œ1.0 åˆ™è¡¨ç¤ºå…¨éƒ¨é‡‡é›†ã€‚</p></blockquote><h3 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h3><p>å¯¹<code>trace-a</code>å’Œ<code>trace-b</code>è¿›è¡Œç¼–ç ã€‚</p><h4 id="trace-a"><a href="#trace-a" class="headerlink" title="trace-a"></a>trace-a</h4><p>é…ç½®ä¸€ä¸ª<code>WebClient</code> <strong>Bean</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceAApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TraceAApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerExchangeFilterFunction lbFunction;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebClient <span class="title">webClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> WebClient.builder()</span><br><span class="line">            .baseUrl(<span class="string">&quot;http://trace-b&quot;</span>)</span><br><span class="line">            .filter(lbFunction).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª<code>TraceAController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceAController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/trace-a&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">trace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;call trace-a.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> webClient.get().uri(<span class="string">&quot;/trace-b&quot;</span>)</span><br><span class="line">            .retrieve().bodyToMono(String.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="trace-b"><a href="#trace-b" class="headerlink" title="trace-b"></a>trace-b</h4><p><code>trace-b</code>çš„å¯åŠ¨ç±»å¦‚ä¸‹ï¼Œä½¿ç”¨é»˜è®¤çš„ä»£ç ï¼Œä¸éœ€ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceBApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TraceBApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª<code>TraceBController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceBController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/trace-b&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">trace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;call trace-b.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;Trace.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚*<code>Spring</code> åº”ç”¨åœ¨ç›‘æµ‹åˆ° <code>classpath</code> ä¸­æœ‰ <code>Sleuth</code> å’Œ <code>Zipkin</code> åï¼Œä¼šè‡ªåŠ¨åœ¨ <code>WebClient</code>ï¼ˆæˆ– <code>RestTemplate</code>ï¼‰çš„è°ƒç”¨è¿‡ç¨‹ä¸­å‘ <code>HTTP</code> è¯·æ±‚æ³¨å…¥è¿½è¸ªä¿¡æ¯ï¼Œå¹¶å‘ <code>Zipkin Server</code> å‘é€è¿™äº›ä¿¡æ¯ã€‚*</p><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><p>åˆ†åˆ«å¯åŠ¨<code>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</code>ã€<code>trace-a</code>å’Œ<code>trace-b</code>ï¼Œè®¿é—®<a href="http://localhost:28092/trace-a">http://localhost:28092/trace-a</a>ï¼Œå¯ä»¥å¾—åˆ°è¿”å›å€¼<code>Trace.</code>ï¼ŒåŒæ—¶åœ¨ä¸¤ä¸ªå·¥ç¨‹çš„æ§åˆ¶å°éƒ½èƒ½çœ‹åˆ°ç›¸å…³æ—¥å¿—è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> trace-aå·¥ç¨‹æ§åˆ¶å°</span></span><br><span class="line">call trace-a.</span><br><span class="line"><span class="meta">#</span><span class="bash"> trace-bå·¥ç¨‹æ§åˆ¶å°</span></span><br><span class="line">call trace-b.</span><br></pre></td></tr></table></figure><p>è®¿é—®<a href="http://localhost:9411/">http://localhost:9411</a>ï¼Œç‚¹å‡»<code>Find Traces</code>çœ‹åˆ°æœ‰ä¸€æ¡è®°å½•ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/a4.png" alt="zipkin"></p><p>-</p><p>ç‚¹å‡»è¿›å»å¯ä»¥çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/a5.png" alt="zipkin"></p><p>-</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/a6.png" alt="zipkin"></p><h3 id="æ¶ˆæ¯æ€»çº¿-RabbitMQæ–¹å¼"><a href="#æ¶ˆæ¯æ€»çº¿-RabbitMQæ–¹å¼" class="headerlink" title="æ¶ˆæ¯æ€»çº¿-RabbitMQæ–¹å¼"></a>æ¶ˆæ¯æ€»çº¿-RabbitMQæ–¹å¼</h3><p><code>Zipkin</code> ä¸å†æ¨èæˆ‘ä»¬æ¥è‡ªå®šä¹‰ <code>Server</code> ç«¯äº†ï¼Œæ‰€ä»¥åœ¨æœ€æ–°ç‰ˆæœ¬çš„ <code>Spring Cloud</code> ä¾èµ–ç®¡ç†é‡Œå·²ç»æ‰¾ä¸åˆ° <code>zipkin-server</code> äº†ã€‚</p><p>é€šè¿‡ç¯å¢ƒå˜é‡è®©<code>Zipkin</code>ä»<code>RabbitMQ</code>ä¸­è¯»å–ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">RABBIT_ADDRESSES=localhost java -jar zipkin.jar</span><br></pre></td></tr></table></figure><p>å…³äº <code>Zipkin</code> çš„ <code>Client</code> ç«¯ï¼Œä¹Ÿå°±æ˜¯å¾®æœåŠ¡åº”ç”¨ï¼Œæˆ‘ä»¬å°±åœ¨ä¹‹å‰ <code>trace-a</code>ã€<code>trace-b</code> çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼Œåªè¦åœ¨ä»–ä»¬çš„ä¾èµ–é‡Œéƒ½å¼•å…¥<code>spring-cloud-stream-binder-rabbit</code>å°±å¥½äº†ï¼Œåˆ«çš„ä¸ç”¨æ”¹ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://windmt.com/2018/04/24/spring-cloud-12-sleuth-zipkin/">åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ª Sleuth ä¸ Zipkinã€Finchley ç‰ˆã€‘</a></li><li><a href="http://www.ityouknow.com/springcloud/2018/02/02/spring-cloud-sleuth-zipkin.html">ä½¿ç”¨Spring Cloud Sleuthå’ŒZipkinè¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ª</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆæœåŠ¡ç½‘å…³zuulï¼‰</title>
      <link href="/blog/2019/01/03/d3f1148e.html"/>
      <url>/blog/2019/01/03/d3f1148e.html</url>
      
        <content type="html"><![CDATA[<h2 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h2><p>API Gatewayæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼š<a href="http://dockone.io/article/482">http://dockone.io/article/482</a>ã€‚</p><p>API Gatewayæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯è¿›å…¥ç³»ç»Ÿçš„å”¯ä¸€èŠ‚ç‚¹ã€‚è¿™è·Ÿé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ä¸­çš„Facadeæ¨¡å¼å¾ˆåƒã€‚API Gatewayå°è£…å†…éƒ¨ç³»ç»Ÿçš„æ¶æ„ï¼Œå¹¶ä¸”æä¾›APIç»™å„ä¸ªå®¢æˆ·ç«¯ã€‚å®ƒè¿˜å¯èƒ½æœ‰å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æˆæƒã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡å’Œç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰ã€‚</p><p>API Gatewayè´Ÿè´£è¯·æ±‚è½¬å‘ã€åˆæˆå’Œåè®®è½¬æ¢ã€‚æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½è¦å…ˆç»è¿‡API Gatewayï¼Œç„¶åè·¯ç”±è¿™äº›è¯·æ±‚åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚API Gatewayå°†ç»å¸¸é€šè¿‡è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚ä»¥åŠèšåˆå¤šä¸ªæœåŠ¡çš„ç»“æœã€‚å®ƒå¯ä»¥åœ¨webåè®®ä¸å†…éƒ¨ä½¿ç”¨çš„éWebå‹å¥½å‹åè®®é—´è¿›è¡Œè½¬æ¢ï¼Œå¦‚HTTPåè®®ã€WebSocketåè®®ã€‚</p><p>API Gatewayå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„APIã€‚å®ƒæš´éœ²ä¸€ä¸ªç²—ç²’åº¦APIç»™ç§»åŠ¨å®¢æˆ·ç«¯ã€‚ä»¥äº§å“æœ€ç»ˆé¡µè¿™ä¸ªä½¿ç”¨åœºæ™¯ä¸ºä¾‹ã€‚API Gatewayæä¾›ä¸€ä¸ªæœåŠ¡æä¾›ç‚¹ï¼ˆ/productdetails?productid=xxxï¼‰ä½¿å¾—ç§»åŠ¨å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ£€ç´¢åˆ°äº§å“æœ€ç»ˆé¡µçš„å…¨éƒ¨æ•°æ®ã€‚API Gatewayé€šè¿‡è°ƒç”¨å¤šä¸ªæœåŠ¡æ¥å¤„ç†è¿™ä¸€ä¸ªè¯·æ±‚å¹¶è¿”å›ç»“æœï¼Œæ¶‰åŠäº§å“ä¿¡æ¯ã€æ¨èã€è¯„è®ºç­‰ã€‚</p><p>ä¸€ä¸ªå¾ˆå¥½çš„API Gatewayä¾‹å­æ˜¯<a href="http://techblog.netflix.com/2013/02/rxjava-netflix-api.html">Netfix API Gateway</a>ã€‚NetflixæµæœåŠ¡æä¾›æ•°ç™¾ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼ŒåŒ…æ‹¬ç”µè§†ã€æœºé¡¶ç›’ã€æ™ºèƒ½æ‰‹æœºã€æ¸¸æˆç³»ç»Ÿã€å¹³æ¿ç”µè„‘ç­‰ã€‚èµ·åˆï¼ŒNetflixè§†å›¾æä¾›ä¸€ä¸ª<a href="http://www.programmableweb.com/news/why-rest-keeps-me-night/2012/05/15">é€‚ç”¨å…¨åœºæ™¯</a>çš„APIã€‚ä½†æ˜¯ï¼Œä»–ä»¬å‘ç°è¿™ç§å½¢å¼ä¸å¥½ç”¨ï¼Œå› ä¸ºæ¶‰åŠåˆ°å„å¼å„æ ·çš„è®¾å¤‡ä»¥åŠå®ƒä»¬ç‹¬ç‰¹çš„éœ€æ±‚ã€‚ç°åœ¨ï¼Œä»–ä»¬é‡‡ç”¨ä¸€ä¸ªAPI Gatewayæ¥æä¾›å®¹é”™æ€§é«˜çš„APIï¼Œé’ˆå¯¹ä¸åŒç±»å‹è®¾å¤‡æœ‰ç›¸åº”ä»£ç ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªé€‚é…å™¨å¤„ç†ä¸€ä¸ªè¯·æ±‚å¹³å‡è¦è°ƒç”¨6åˆ°8ä¸ªåç«¯æœåŠ¡ã€‚Netflix API Gatewayæ¯å¤©å¤„ç†æ•°åäº¿çš„è¯·æ±‚ã€‚</p><h3 id="API-Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹"><a href="#API-Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹" class="headerlink" title="API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹"></a>API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹</h3><p>å¦‚ä½ æ‰€æ–™ï¼Œé‡‡ç”¨API Gatewayä¹Ÿæ˜¯ä¼˜ç¼ºç‚¹å¹¶å­˜çš„ã€‚API Gatewayçš„ä¸€ä¸ªæœ€å¤§å¥½å¤„æ˜¯å°è£…åº”ç”¨å†…éƒ¨ç»“æ„ã€‚ç›¸æ¯”èµ·æ¥è°ƒç”¨æŒ‡å®šçš„æœåŠ¡ï¼Œå®¢æˆ·ç«¯ç›´æ¥è·Ÿgatwayäº¤äº’æ›´ç®€å•ç‚¹ã€‚API Gatewayæä¾›ç»™æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªç‰¹å®šAPIï¼Œè¿™æ ·å‡å°‘äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡æ¬¡æ•°ï¼Œä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚</p><p>API Gatewayä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„ç»„ä»¶ï¼Œå¿…é¡»è¦å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒå¯èƒ½æˆä¸ºå¼€å‘çš„ä¸€ä¸ªç“¶é¢ˆã€‚å¼€å‘è€…å¿…é¡»æ›´æ–°API Gatewayæ¥æä¾›æ–°æœåŠ¡æä¾›ç‚¹æ¥æ”¯æŒæ–°æš´éœ²çš„å¾®æœåŠ¡ã€‚æ›´æ–°API Gatewayæ—¶å¿…é¡»è¶Šè½»é‡çº§è¶Šå¥½ã€‚å¦åˆ™ï¼Œå¼€å‘è€…å°†å› ä¸ºæ›´æ–°Gatewayè€Œæ’é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œé™¤äº†è¿™äº›ç¼ºç‚¹ï¼Œå¯¹äºå¤§éƒ¨åˆ†çš„åº”ç”¨ï¼Œé‡‡ç”¨API Gatewayçš„æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚</p><p>ä½¿ç”¨API Gatewayåï¼Œå®¢æˆ·ç«¯å’Œå¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œå›¾å˜æˆä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/lzchLT.png" alt="API Gateway"></p><p>é€šè¿‡API Gatewayï¼Œå¯ä»¥ç»Ÿä¸€å‘å¤–éƒ¨ç³»ç»Ÿæä¾›REST APIã€‚Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚</p><h2 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h2><p>Netflixå¼€æºçš„å¾®æœåŠ¡ç½‘å…³ï¼Œæ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—è¿‡æ»¤å™¨ï¼š</p><ul><li>èº«ä»½è®¤è¯å®‰å…¨</li><li>å®¡æŸ¥ä¸ç›‘æ§</li><li>åŠ¨æ€è·¯ç”±</li><li>å‹åŠ›æµ‹è¯•</li><li>é™„å†åˆ†é…</li><li>é™æ€å“åº”å¤„ç†</li><li>å¤šåŒºåŸŸå¼¹æ€§</li></ul><h2 id="Zuulè¿‡æ»¤å™¨"><a href="#Zuulè¿‡æ»¤å™¨" class="headerlink" title="Zuulè¿‡æ»¤å™¨"></a>Zuulè¿‡æ»¤å™¨</h2><p>Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ä¸»è¦ä¸º4ç§æ ‡å‡†ç±»å‹ï¼š</p><ul><li>PREï¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨</li><li>ROUTINGï¼šè¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡</li><li>POSTï¼šåœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œ</li><li>ERRORï¼šåœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶è‡ªä¿¡è¯¥è¿‡æ»¤å™¨</li></ul><h2 id="Spring-Cloud-Zuul"><a href="#Spring-Cloud-Zuul" class="headerlink" title="Spring Cloud Zuul"></a>Spring Cloud Zuul</h2><p><code>Spring Cloud Zuul</code>è·¯ç”±æ˜¯å¾®æœåŠ¡æ¶æ„çš„ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œæä¾›åŠ¨æ€è·¯ç”±ï¼Œç›‘æ§ï¼Œå¼¹æ€§ï¼Œå®‰å…¨ç­‰çš„è¾¹ç¼˜æœåŠ¡ã€‚<code>Zuul</code>æ˜¯<code>Netflix</code>å‡ºå“çš„ä¸€ä¸ªåŸºäº<code>JVM</code>è·¯ç”±å’ŒæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡å™¨ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>æ–°å»ºä¸€ä¸ª<code>Spring Boot</code>é¡¹ç›®ï¼Œå‘½åä¸ºï¼š<code>api-gateway</code>ï¼Œ</p><h3 id="POMé…ç½®"><a href="#POMé…ç½®" class="headerlink" title="POMé…ç½®"></a>POMé…ç½®</h3><p>åœ¨<code>pom.xml</code>ä¸­å¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cayzlh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-demos-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>api-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>api-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨é…ç½®æ–‡ä»¶ <code>application.yml</code> ä¸­åŠ å…¥æœåŠ¡åã€ç«¯å£å·ã€<code>Eureka</code> æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28091</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ä½¿ç”¨<code>@EnableZuulProxy</code>æ³¨è§£å¼€å¯<code>Zuul</code>åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiGatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä¸€ä¸ªåŸºäº<code>Spring Cloud Zuul</code>çš„æœåŠ¡ç½‘å…³å°±å·²ç»æ„å»ºå®Œæˆã€‚åˆ†åˆ«å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç”Ÿäº§è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€<code>API-GATEWAY</code>ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/zmVnNy.png" alt="api-gateway"></p><p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—®<a href="http://localhost:28081/">http://localhost:208081</a>ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ç»“æœã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ç”±äº <code>Spring Cloud Zuul</code> åœ¨æ•´åˆäº† <code>Eureka</code> ä¹‹åï¼Œå…·å¤‡é»˜è®¤çš„æœåŠ¡è·¯ç”±åŠŸèƒ½ï¼Œå³ï¼š<strong>å½“æˆ‘ä»¬è¿™é‡Œæ„å»ºçš„<code>api-gateway</code>åº”ç”¨å¯åŠ¨å¹¶æ³¨å†Œåˆ° <code>Eureka</code> ä¹‹åï¼ŒæœåŠ¡ç½‘å…³ä¼šå‘ç°ä¸Šé¢æˆ‘ä»¬å¯åŠ¨çš„ä¸¤ä¸ªæœåŠ¡<code>producer</code>å’Œ<code>consumer</code>ï¼Œè¿™æ—¶å€™ <code>Zuul</code> å°±ä¼šåˆ›å»ºä¸¤ä¸ªè·¯ç”±è§„åˆ™ã€‚æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å¤–éƒ¨è¯·æ±‚çš„åŒ¹é…è§„åˆ™ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯è·¯ç”±çš„æœåŠ¡ <code>ID</code>ã€‚</strong>é’ˆå¯¹å½“å‰ç¤ºä¾‹çš„æƒ…å†µï¼Œ<code>Zuul</code> ä¼šåˆ›å»ºä¸‹é¢çš„ä¸¤ä¸ªè·¯ç”±è§„åˆ™ï¼š</p><ul><li>è½¬å‘åˆ°<code>eureka-producer</code>æœåŠ¡çš„è¯·æ±‚è§„åˆ™ä¸ºï¼š<code>/eureka-producer/**</code></li><li>è½¬å‘åˆ°<code>eureka-consumer</code>æœåŠ¡çš„è¯·æ±‚è§„åˆ™ä¸ºï¼š<code>/eureka-consumer/**</code></li></ul><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®<code>28091</code>ç«¯å£çš„æœåŠ¡ç½‘å…³æ¥éªŒè¯ä¸Šè¿°è·¯ç”±çš„æ­£ç¡®æ€§ï¼š</p><ul><li><p>æ¯”å¦‚è®¿é—®ï¼š<a href="http://localhost:28091/eureka-consumer/hello/zhangsan">http://localhost:28091/eureka-consumer/hello/zhangsan</a>ï¼Œè¯¥è¯·æ±‚å°†æœ€ç»ˆè¢«è·¯ç”±åˆ°<code>consumer</code>çš„<code>/hello</code>æ¥å£ä¸Šï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/06aKRo.png" alt="api-gateway"></p></li></ul><p>ä»¥ä¸Šç»“æœè¯´æ˜zuulå·²ç»å¼€å§‹ç”Ÿæ•ˆäº†ã€‚</p><h2 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h2><p><code>Zuul</code>è¿˜æœ‰æ›´å¤šçš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ï¼šé‰´æƒã€æµé‡è½¬å‘ã€è¯·æ±‚ç»Ÿè®¡ç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¯ä»¥ä½¿ç”¨<code>Zuul</code>æ¥å®ç°ã€‚</p><h3 id="Zuulçš„æ ¸å¿ƒ"><a href="#Zuulçš„æ ¸å¿ƒ" class="headerlink" title="Zuulçš„æ ¸å¿ƒ"></a>Zuulçš„æ ¸å¿ƒ</h3><p><code>Filter</code>æ˜¯<code>Zuul</code>çš„æ ¸å¿ƒï¼Œç”¨æ¥å®ç°å¯¹å¤–æœåŠ¡çš„æ§åˆ¶ã€‚Filterçš„ç”Ÿå‘½å‘¨æœŸæœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>PRE</code>ã€<code>ROUTING</code>ã€<code>POST</code>ã€<code>ERROR</code>ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/8upBZN.png" alt="Filterç”Ÿå‘½å‘¨æœŸ"></p><p><code>Zuul</code>å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯é€šè¿‡è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œè¿™äº›è¿‡æ»¤å™¨ç±»å‹å¯¹åº”äºè¯·æ±‚çš„å…¸å‹ç”Ÿå‘½å‘¨æœŸã€‚</p><ul><li><strong>PREï¼š</strong> è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚</li><li><strong>ROUTINGï¼š</strong>è¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡ã€‚è¿™ç§è¿‡æ»¤å™¨ç”¨äºæ„å»ºå‘é€ç»™å¾®æœåŠ¡çš„è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨<code>Apache HttpClient</code>æˆ–<code>Netfilx Ribbon</code>è¯·æ±‚å¾®æœåŠ¡ã€‚</li><li><strong>POSTï¼š</strong>è¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„<code>HTTP Header</code>ã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚</li><li><strong>ERRORï¼š</strong>åœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶æ‰§è¡Œè¯¥è¿‡æ»¤å™¨ã€‚ é™¤äº†é»˜è®¤çš„è¿‡æ»¤å™¨ç±»å‹ï¼Œ<code>Zuul</code>è¿˜å…è®¸æˆ‘ä»¬åˆ›å»ºè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ä¸€ç§<code>STATIC</code>ç±»å‹çš„è¿‡æ»¤å™¨ï¼Œç›´æ¥åœ¨<code>Zuul</code>ä¸­ç”Ÿæˆå“åº”ï¼Œè€Œä¸å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ã€‚</li></ul><h3 id="Zuulä¸­é»˜è®¤å®ç°çš„Filter"><a href="#Zuulä¸­é»˜è®¤å®ç°çš„Filter" class="headerlink" title="Zuulä¸­é»˜è®¤å®ç°çš„Filter"></a>Zuulä¸­é»˜è®¤å®ç°çš„Filter</h3><table><thead><tr><th>ç±»å‹</th><th>é¡ºåº</th><th>è¿‡æ»¤å™¨</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>pre</td><td>-3</td><td>ServletDetectionFilter</td><td>æ ‡è®°å¤„ç†Servletçš„ç±»å‹</td></tr><tr><td>pre</td><td>-2</td><td>Servlet30WrapperFilter</td><td>åŒ…è£…HttpServletRequestè¯·æ±‚</td></tr><tr><td>pre</td><td>-1</td><td>FormBodyWrapperFilter</td><td>åŒ…è£…è¯·æ±‚ä½“</td></tr><tr><td>route</td><td>1</td><td>DebugFilter</td><td>æ ‡è®°è°ƒè¯•æ ‡å¿—</td></tr><tr><td>route</td><td>5</td><td>PreDecorationFilter</td><td>å¤„ç†è¯·æ±‚ä¸Šä¸‹æ–‡ä¾›åç»­ä½¿ç”¨</td></tr><tr><td>route</td><td>10</td><td>RibbonRoutingFilter</td><td>serviceIdè¯·æ±‚è½¬å‘</td></tr><tr><td>route</td><td>100</td><td>SimpleHostRoutingFilter</td><td>urlè¯·æ±‚è½¬å‘</td></tr><tr><td>route</td><td>500</td><td>SendForwardFilter</td><td>forwardè¯·æ±‚è½¬å‘</td></tr><tr><td>post</td><td>0</td><td>SendErrorFilter</td><td>å¤„ç†æœ‰é”™è¯¯çš„è¯·æ±‚å“åº”</td></tr><tr><td>post</td><td>1000</td><td>SendResponseFilter</td><td>å¤„ç†æ­£å¸¸çš„è¯·æ±‚å“åº”</td></tr></tbody></table><p>-</p><h3 id="ç¦ç”¨æŒ‡å®šçš„Filter"><a href="#ç¦ç”¨æŒ‡å®šçš„Filter" class="headerlink" title="ç¦ç”¨æŒ‡å®šçš„Filter"></a>ç¦ç”¨æŒ‡å®šçš„Filter</h3><p>å¯ä»¥åœ¨<code>application.xml</code>ä¸­é…ç½®éœ€è¦ç¦ç”¨çš„<code>filter</code>ï¼Œä»¥<code>zuul.&lt;SimpleClassName&gt;.&lt;filterType&gt;.disable=true</code>è¿™æ ·çš„æ ¼å¼é…ç½®ï¼Œæ¯”å¦‚è¦ç¦ç”¨<code>org.springframework.cloud.netflix.zuul.filters.post.SendResponseFilter</code>å°±è®¾ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">SendResponseFilter:</span></span><br><span class="line">    <span class="attr">post:</span></span><br><span class="line">      <span class="attr">disable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰Filter"><a href="#è‡ªå®šä¹‰Filter" class="headerlink" title="è‡ªå®šä¹‰Filter"></a>è‡ªå®šä¹‰Filter</h3><p>æˆ‘ä»¬å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå› ä¸ºæœåŠ¡ç½‘å…³åº”å¯¹çš„æ˜¯å¤–éƒ¨çš„æ‰€æœ‰è¯·æ±‚ï¼Œä¸ºäº†é¿å…äº§ç”Ÿå®‰å…¨éšæ‚£ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¯·æ±‚åšä¸€å®šçš„é™åˆ¶ï¼Œæ¯”å¦‚è¯·æ±‚ä¸­å«æœ‰ <code>Token</code> ä¾¿è®©è¯·æ±‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œå¦‚æœè¯·æ±‚ä¸å¸¦ <code>Token</code> å°±ç›´æ¥è¿”å›å¹¶ç»™å‡ºæç¤ºã€‚</p><p>é¦–å…ˆè‡ªå®šä¹‰ä¸€ä¸ª <code>Filter</code>ï¼Œç»§æ‰¿ <code>ZuulFilter</code> æŠ½è±¡ç±»ï¼Œåœ¨ <code>run()</code> æ–¹æ³•ä¸­éªŒè¯å‚æ•°æ˜¯å¦å«æœ‰ <code>Token</code>ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿‡æ»¤å™¨çš„ç±»å‹ï¼Œå®ƒå†³å®šè¿‡æ»¤å™¨åœ¨è¯·æ±‚çš„å“ªä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œå®šä¹‰ä¸ºpreï¼Œä»£è¡¨ä¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * filteræ‰§è¡Œé¡ºåºï¼Œé€šè¿‡æ•°å­—æŒ‡å®šã€‚</span></span><br><span class="line"><span class="comment">     * æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥è¿”å›äº†trueï¼Œå› æ­¤è¯¥è¿‡æ»¤å™¨å¯¹æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”Ÿæ•ˆã€‚</span></span><br><span class="line"><span class="comment">     * å®é™…è¿ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ¥æŒ‡å®šè¿‡æ»¤å™¨çš„æœ‰æ•ˆèŒƒå›´ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿‡æ»¤å™¨çš„å…·ä½“é€»è¾‘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line"></span><br><span class="line">        String token = request.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> || token.isEmpty()) &#123;</span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            ctx.setResponseStatusCode(<span class="number">401</span>);</span><br><span class="line">            ctx.setResponseBody(<span class="string">&quot;token is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢å®ç°çš„è¿‡æ»¤å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç»§æ‰¿<code>ZuulFilter</code>æŠ½è±¡ç±»å¹¶é‡å†™äº†ä¸‹é¢çš„å››ä¸ªæ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ã€‚è¿™å››ä¸ªæ–¹æ³•åˆ†åˆ«å®šä¹‰äº†ï¼š</p><ul><li><code>filterType()</code>ï¼šè¿‡æ»¤å™¨çš„ç±»å‹ï¼Œå®ƒå†³å®šè¿‡æ»¤å™¨åœ¨è¯·æ±‚çš„å“ªä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œã€‚è¿™é‡Œå®šä¹‰ä¸º<code>pre</code>ï¼Œä»£è¡¨ä¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œã€‚</li><li><code>filterOrder()</code>ï¼šè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºã€‚å½“è¯·æ±‚åœ¨ä¸€ä¸ªé˜¶æ®µä¸­å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨æ—¶ï¼Œéœ€è¦æ ¹æ®è¯¥æ–¹æ³•è¿”å›çš„å€¼æ¥ä¾æ¬¡æ‰§è¡Œã€‚é€šè¿‡æ•°å­—æŒ‡å®šï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚</li><li><code>shouldFilter()</code>ï¼šåˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥è¿”å›äº†<code>true</code>ï¼Œå› æ­¤è¯¥è¿‡æ»¤å™¨å¯¹æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”Ÿæ•ˆã€‚å®é™…è¿ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ¥æŒ‡å®šè¿‡æ»¤å™¨çš„æœ‰æ•ˆèŒƒå›´ã€‚</li><li><code>run()</code>ï¼šè¿‡æ»¤å™¨çš„å…·ä½“é€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡<code>ctx.setSendZuulResponse(false)</code>ä»¤ Zuul è¿‡æ»¤è¯¥è¯·æ±‚ï¼Œä¸å¯¹å…¶è¿›è¡Œè·¯ç”±ï¼Œç„¶åé€šè¿‡<code>ctx.setResponseStatusCode(401)</code>è®¾ç½®äº†å…¶è¿”å›çš„é”™è¯¯ç ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æˆ‘ä»¬çš„è¿”å›ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡<code>ctx.setResponseBody(body)</code>å¯¹è¿”å› body å†…å®¹è¿›è¡Œç¼–è¾‘ç­‰ã€‚</li></ul><p>åœ¨å®ç°äº†è‡ªå®šä¹‰è¿‡æ»¤å™¨ä¹‹åï¼Œå®ƒå¹¶ä¸ä¼šç›´æ¥ç”Ÿæ•ˆï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸ºå…¶åˆ›å»ºå…·ä½“çš„ <code>Bean</code> æ‰èƒ½å¯åŠ¨è¯¥è¿‡æ»¤å™¨ï¼Œæ¯”å¦‚ï¼Œåœ¨åº”ç”¨ä¸»ç±»ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiGatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenFilter <span class="title">tokenFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TokenFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¯¹<code>api-gateway</code>æœåŠ¡å®Œæˆäº†ä¸Šé¢çš„æ”¹é€ ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¯åŠ¨å®ƒï¼Œå¹¶å‘èµ·ä¸‹é¢çš„è¯·æ±‚ï¼Œå¯¹ä¸Šé¢å®šä¹‰çš„è¿‡æ»¤å™¨åšä¸€ä¸ªéªŒè¯ï¼š</p><ul><li><p>è®¿é—® <a href="http://localhost:14000/eureka-consumer/hello/zhangsan">http://localhost:14000/eureka-consumer/hello/zhangsan</a> è¿”å› 401 é”™è¯¯å’Œ<code>token is empty</code></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/McjnNy.png" alt="zuul-filter"></p></li><li><p>è®¿é—®  <a href="http://localhost:14000/eureka-consumer/hello/zhangsan?token=token">http://localhost:14000/eureka-consumer/hello/zhangsan?token=token</a> æ­£ç¡®è·¯ç”±åˆ°<code>eureka-consumer</code>çš„<code>/hello</code>æ¥å£ï¼Œå¹¶è¿”å›<code>Hello, zhangsan!, ç°åœ¨æ—¶é—´ï¼š1546506130007</code></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/K9vzNb.png" alt="zuul-filter"></p></li></ul><h2 id="è·¯ç”±ç†”æ–­"><a href="#è·¯ç”±ç†”æ–­" class="headerlink" title="è·¯ç”±ç†”æ–­"></a>è·¯ç”±ç†”æ–­</h2><p>å½“æˆ‘ä»¬çš„åç«¯æœåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å°†å¼‚å¸¸æŠ›å‡ºç»™æœ€å¤–å±‚ï¼ŒæœŸæœ›æœåŠ¡å¯ä»¥è‡ªåŠ¨è¿›è¡Œä¸€é™çº§ã€‚<code>Zuul</code>ç»™æˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ”¯æŒã€‚å½“æŸä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥è¿”å›æˆ‘ä»¬é¢„è®¾çš„ä¿¡æ¯ã€‚</p><p>æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰çš„<code>fallback</code>æ–¹æ³•ï¼Œå¹¶ä¸”å°†å…¶æŒ‡å®šç»™æŸä¸ª<code>route</code>æ¥å®ç°è¯¥<code>route</code>è®¿é—®å‡ºé—®é¢˜çš„ç†”æ–­å¤„ç†ã€‚ä¸»è¦ç»§æ‰¿<code>ZuulFallbackProvider</code>æ¥å£æ¥å®ç°ï¼Œ<code>ZuulFallbackProvider</code>é»˜è®¤æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥æŒ‡æ˜ç†”æ–­æ‹¦æˆªå“ªä¸ªæœåŠ¡ï¼Œä¸€ä¸ªå®šåˆ¶è¿”å›å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ZuulFallbackProvider</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The route this fallback will be used for.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The route the fallback will be used for.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides a fallback response.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The fallback response.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ç±»é€šè¿‡å®ç°<code>getRoute</code>æ–¹æ³•ï¼Œå‘Šè¯‰<code>Zuul</code>å®ƒæ˜¯è´Ÿè´£å“ªä¸ª<code>route</code>å®šä¹‰çš„ç†”æ–­ã€‚è€Œ<code>fallbackResponse</code>æ–¹æ³•åˆ™æ˜¯å‘Šè¯‰ <code>Zuul</code> æ–­è·¯å‡ºç°æ—¶ï¼Œå®ƒä¼šæä¾›ä¸€ä¸ªä»€ä¹ˆè¿”å›å€¼æ¥å¤„ç†è¯·æ±‚ã€‚</p><p>åæ¥<code>Spring</code>åˆæ‰©å±•äº†æ­¤ç±»ï¼Œä¸°å¯Œäº†è¿”å›æ–¹å¼ï¼Œåœ¨è¿”å›çš„å†…å®¹ä¸­æ·»åŠ äº†å¼‚å¸¸ä¿¡æ¯ï¼Œå› æ­¤æœ€æ–°ç‰ˆæœ¬å»ºè®®ç›´æ¥ç»§æ‰¿ç±»<code>FallbackProvider</code> ã€‚</p><h2 id="è·¯ç”±é‡è¯•"><a href="#è·¯ç”±é‡è¯•" class="headerlink" title="è·¯ç”±é‡è¯•"></a>è·¯ç”±é‡è¯•</h2><p>æœ‰æ—¶å€™å› ä¸ºç½‘ç»œæˆ–è€…å…¶å®ƒåŸå› ï¼ŒæœåŠ¡å¯èƒ½ä¼šæš‚æ—¶çš„ä¸å¯ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›å¯ä»¥å†æ¬¡å¯¹æœåŠ¡è¿›è¡Œé‡è¯•ï¼Œ<code>Zuul</code>ä¹Ÿå¸®æˆ‘ä»¬å®ç°äº†æ­¤åŠŸèƒ½ï¼Œéœ€è¦ç»“åˆ<code>Spring Retry</code> ä¸€èµ·æ¥å®ç°ã€‚éœ€è¦æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>å¼€å¯é‡è¯•åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚å½“å‹åŠ›è¿‡å¤§ï¼Œä¸€ä¸ªå®ä¾‹åœæ­¢å“åº”æ—¶ï¼Œè·¯ç”±å°†æµé‡è½¬åˆ°å¦ä¸€ä¸ªå®ä¾‹ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æœ€ç»ˆæ‰€æœ‰çš„å®ä¾‹å…¨è¢«å‹å®ã€‚è¯´åˆ°åº•ï¼Œæ–­è·¯å™¨çš„å…¶ä¸­ä¸€ä¸ªä½œç”¨å°±æ˜¯é˜²æ­¢æ•…éšœæˆ–è€…å‹åŠ›æ‰©æ•£ã€‚ç”¨äº†<code>retry</code>ï¼Œæ–­è·¯å™¨å°±åªæœ‰åœ¨è¯¥æœåŠ¡çš„æ‰€æœ‰å®ä¾‹éƒ½æ— æ³•è¿ä½œçš„æƒ…å†µä¸‹æ‰èƒ½èµ·ä½œç”¨ã€‚è¿™ç§æ—¶å€™ï¼Œæ–­è·¯å™¨çš„å½¢å¼æ›´åƒæ˜¯æä¾›ä¸€ç§å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ–è€…å‡è£…æœåŠ¡æ­£å¸¸è¿è¡Œçš„å‡è±¡ç»™ä½¿ç”¨è€…ã€‚</p><p>ä¸ç”¨<code>retry</code>ï¼Œä»…ä½¿ç”¨è´Ÿè½½å‡è¡¡å’Œç†”æ–­ï¼Œå°±å¿…é¡»è€ƒè™‘åˆ°æ˜¯å¦èƒ½å¤Ÿæ¥å—å•ä¸ªæœåŠ¡å®ä¾‹å…³é—­å’Œ<code>eureka</code>åˆ·æ–°æœåŠ¡åˆ—è¡¨ä¹‹é—´å¸¦æ¥çš„çŸ­æ—¶é—´çš„ç†”æ–­ã€‚å¦‚æœå¯ä»¥æ¥å—ï¼Œå°±æ— éœ€ä½¿ç”¨<code>retry</code>ã€‚</p></blockquote><p>-</p><h2 id="Zuulé«˜å¯ç”¨"><a href="#Zuulé«˜å¯ç”¨" class="headerlink" title="Zuulé«˜å¯ç”¨"></a>Zuulé«˜å¯ç”¨</h2><p>ä¸åŒçš„å®¢æˆ·ç«¯ä½¿ç”¨ä¸åŒçš„è´Ÿè½½å°†è¯·æ±‚åˆ†å‘åˆ°åç«¯çš„<code>Zuul</code>ï¼Œ<code>Zuul</code>åœ¨é€šè¿‡<code>Eureka</code>è°ƒç”¨åç«¯æœåŠ¡ï¼Œæœ€åå¯¹å¤–è¾“å‡ºã€‚å› æ­¤ä¸ºäº†ä¿è¯<code>Zuul</code>çš„é«˜å¯ç”¨æ€§ï¼Œå‰ç«¯å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ª<code>Zuul</code>å®ä¾‹è¿›è¡Œè´Ÿè½½ï¼Œåœ¨<code>Zuul</code>çš„å‰ç«¯ä½¿ç”¨<code>Nginx</code>æˆ–è€…<code>F5</code>è¿›è¡Œè´Ÿè½½è½¬å‘ä»¥è¾¾åˆ°é«˜å¯ç”¨æ€§ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://windmt.com/2018/04/23/spring-cloud-10-zuul-router/">æœåŠ¡ç½‘å…³ Zuulï¼ˆè·¯ç”±ï¼‰ã€Finchley ç‰ˆã€‘</a></li><li><a href="http://www.ityouknow.com/springcloud/2017/06/01/gateway-service-zuul.html">æœåŠ¡ç½‘å…³zuulåˆçº§ç¯‡</a></li><li><a href="http://www.ityouknow.com/springcloud/2018/01/20/spring-cloud-zuul.html">æœåŠ¡ç½‘å…³Zuulé«˜çº§ç¯‡</a></li><li><a href="https://windmt.com/2018/04/23/spring-cloud-11-zuul-filter/">æœåŠ¡ç½‘å…³ Zuulï¼ˆè¿‡æ»¤å™¨ï¼‰ã€Finchley ç‰ˆã€‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆé…ç½®ä¸­å¿ƒå’Œæ¶ˆæ¯æ€»çº¿ï¼‰</title>
      <link href="/blog/2019/01/01/b2f3c839.html"/>
      <url>/blog/2019/01/01/b2f3c839.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨<a href="/archives/5e7c1be9.html">SpringCloudï¼ˆGitç‰ˆé…ç½®ä¸­å¿ƒï¼‰</a>ä¸­æœ‰æåˆ°è¿‡ï¼Œå¦‚æœéœ€è¦å®¢æˆ·ç«¯è·å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯éœ€è¦æ‰§è¡Œ<code>refresh</code>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨webhookçš„æœºåˆ¶æ¯æ¬¡æäº¤ä»£ç å‘é€è¯·æ±‚æ¥åˆ·æ–°å®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ‰§è¡Œä¸€éï¼Œè¿™ç§æ–¹æ¡ˆå°±ä¸å¤ªé€‚åˆäº†ã€‚ä½¿ç”¨Spring Cloud Buså¯ä»¥å®Œç¾è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p></blockquote><h2 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h2><p><code>Spring cloud bus</code>é€šè¿‡è½»é‡æ¶ˆæ¯ä»£ç†è¿æ¥å„ä¸ªåˆ†å¸ƒçš„èŠ‚ç‚¹ã€‚è¿™ä¼šç”¨åœ¨å¹¿æ’­çŠ¶æ€çš„å˜åŒ–ï¼ˆä¾‹å¦‚é…ç½®å˜åŒ–ï¼‰æˆ–è€…å…¶ä»–çš„æ¶ˆæ¯æŒ‡ä»¤ã€‚<code>Spring bus</code>çš„ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡åˆ†å¸ƒå¼çš„å¯åŠ¨å™¨å¯¹<code>spring boot</code>åº”ç”¨è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å»ºç«‹ä¸€ä¸ªå¤šä¸ªåº”ç”¨ä¹‹é—´çš„é€šä¿¡é¢‘é“ã€‚ç›®å‰å”¯ä¸€å®ç°çš„æ–¹å¼æ˜¯ç”¨<code>AMQP</code>æ¶ˆæ¯ä»£ç†ä½œä¸ºé€šé“ï¼ŒåŒæ ·ç‰¹æ€§çš„è®¾ç½®ï¼ˆæœ‰äº›å–å†³äºé€šé“çš„è®¾ç½®ï¼‰åœ¨æ›´å¤šé€šé“çš„æ–‡æ¡£ä¸­ã€‚</p><p><code>Spring cloud bus</code>å¯ä»¥å°†å®ƒç†è§£ä¸ºç®¡ç†å’Œä¼ æ’­æ‰€æœ‰åˆ†å¸ƒå¼é¡¹ç›®ä¸­çš„æ¶ˆæ¯æ—¢å¯ï¼Œå…¶å®æœ¬è´¨æ˜¯åˆ©ç”¨äº†<code>MQ</code>çš„å¹¿æ’­æœºåˆ¶åœ¨åˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ä¼ æ’­æ¶ˆæ¯ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰<code>Kafka</code>å’Œ<code>RabbitMQ</code>ã€‚åˆ©ç”¨<code>bus</code>çš„æœºåˆ¶å¯ä»¥åšå¾ˆå¤šçš„äº‹æƒ…ï¼Œå…¶ä¸­é…ç½®ä¸­å¿ƒå®¢æˆ·ç«¯åˆ·æ–°å°±æ˜¯å…¸å‹çš„åº”ç”¨åœºæ™¯ä¹‹ä¸€ï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æè¿°<code>bus</code>åœ¨é…ç½®ä¸­å¿ƒä½¿ç”¨çš„æœºåˆ¶ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/2020/04/17/1-cYdy1e.jpg" alt="spring cloud bus"></p><p>æ ¹æ®æ­¤å›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºåˆ©ç”¨<code>Spring Cloud Bus</code>åšé…ç½®æ›´æ–°çš„æ­¥éª¤:</p><ul><li>æäº¤ä»£ç è§¦å‘<code>post</code>ç»™å®¢æˆ·ç«¯<code>A</code>å‘é€<code>bus/refresh</code></li><li>å®¢æˆ·ç«¯Aæ¥æ”¶åˆ°è¯·æ±‚ä»<code>Server</code>ç«¯æ›´æ–°é…ç½®å¹¶ä¸”å‘é€ç»™<code>Spring Cloud Bus</code></li><li><code>Spring Cloud bus</code>æ¥åˆ°æ¶ˆæ¯å¹¶é€šçŸ¥ç»™å…¶å®ƒå®¢æˆ·ç«¯</li><li>å…¶å®ƒå®¢æˆ·ç«¯æ¥æ”¶åˆ°é€šçŸ¥ï¼Œè¯·æ±‚<code>Server</code>ç«¯è·å–æœ€æ–°é…ç½®</li><li>å…¨éƒ¨å®¢æˆ·ç«¯å‡è·å–åˆ°æœ€æ–°çš„é…ç½®</li></ul><h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>ç”±äºéœ€è¦ç”¨åˆ°<code>MQ</code>ï¼Œè¿™é‡Œä½¿ç”¨<code>Docker</code>å®‰è£…<code>RabbitMQ</code>æ¥ç”¨ä½œç¤ºä¾‹ï¼Œ<a href="http://www.runoob.com/docker/docker-tutorial.html">Dockeræ•™ç¨‹</a>ã€‚</p><h3 id="Dockerä¸­ä½¿ç”¨RabbitMQ"><a href="#Dockerä¸­ä½¿ç”¨RabbitMQ" class="headerlink" title="Dockerä¸­ä½¿ç”¨RabbitMQ"></a>Dockerä¸­ä½¿ç”¨RabbitMQ</h3><p>RabbitMQæ˜¯å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆæœ‰æ—¶ç§°ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ï¼Œå®ƒå®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰ã€‚RabbitMQæœåŠ¡å™¨é‡‡ç”¨Erlangç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼Œæ„å»ºäºOpen Telecom Platformæ¡†æ¶ä¹‹ä¸Šï¼Œç”¨äºé›†ç¾¤å’Œæ•…éšœè½¬ç§»ã€‚ä¸ä»£ç†æ¥å£çš„å®¢æˆ·ç«¯åº“å¯ç”¨äºæ‰€æœ‰ä¸»è¦ç¼–ç¨‹è¯­è¨€ã€‚</p><h3 id="æ‹‰å–rabbitmqé•œåƒ"><a href="#æ‹‰å–rabbitmqé•œåƒ" class="headerlink" title="æ‹‰å–rabbitmqé•œåƒ"></a>æ‹‰å–rabbitmqé•œåƒ</h3><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ‹‰å–<code>latest</code>ç‰ˆå®˜æ–¹é•œåƒï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull rabbitmq:management</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¸¦ç®¡ç†ç•Œé¢çš„é•œåƒã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/pQDSEG.png" alt="docker-rabbitmq"></p><h3 id="ä½¿ç”¨é•œåƒ"><a href="#ä½¿ç”¨é•œåƒ" class="headerlink" title="ä½¿ç”¨é•œåƒ"></a>ä½¿ç”¨é•œåƒ</h3><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä½¿ç”¨é•œåƒï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --name rabbitmq --publish 5671:5671 \</span><br><span class="line"> --publish 5672:5672 --publish 4369:4369 \</span><br><span class="line"> --publish 25672:25672 --publish 15671:15671 --publish 15672:15672 \</span><br><span class="line">rabbitmq:management</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¹‹åè®¿é—®<a href="http://localhost:15672/">http://localhost:15672/</a>èƒ½å¤Ÿçœ‹åˆ°<code>Web</code>ç®¡ç†ç•Œé¢ï¼Œä½¿ç”¨<strong>guest / guest</strong>ç™»å½•ä¹‹åçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œè¯´æ˜é•œåƒå·²ç»è¿è¡Œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/04/17/RQYNr2.png" alt="docker-rabbitmq"></p><p>å¾ˆå¥½ï¼Œ ç°åœ¨å¼€å§‹æ”¹é€ ä»£ç ã€‚</p><h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><h3 id="pomé…ç½®"><a href="#pomé…ç½®" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h3><p>åœ¨<code>pom.xml</code>ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ä»¥ä¸Šå››ä¸ªä¾èµ–æ˜¯å¿…é¡»çš„</strong></p><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>ä¿®æ”¹<code>application.yml</code>æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/cayzlh/SpringCloudDemos</span> <span class="comment"># é…ç½®gitä»“åº“çš„åœ°å€</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config-repo</span> <span class="comment"># gitä»“åº“åœ°å€ä¸‹çš„ç›¸å¯¹åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œç”¨,åˆ†å‰²ã€‚</span></span><br><span class="line">    <span class="attr">bus:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">trace:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28088</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">bus-refresh</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦å¢åŠ çš„å†…å®¹æœ‰ï¼š</p><ul><li>spring.cloud.bus.enable</li><li>spring.cloud.bus.trace.enable</li><li>Management.endpoints.web.exposure.include</li></ul><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>æ·»åŠ <code>@EnableConfigServer</code>æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerGitApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServerGitApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><h3 id="pomé…ç½®-1"><a href="#pomé…ç½®-1" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h3><p>åœ¨ <code>pom.xml</code> é‡Œæ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼Œå‰ 5 ä¸ªæ˜¯å¿…é¡»çš„ï¼Œæœ€åä¸€ä¸ª <code>webflux</code> å¯ä»¥ç”¨ <code>web</code> æ¥ä»£æ›¿ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœç¼ºäº†<code>spring-boot-starter-actuator</code>ï¼Œå½“å¯¹æœåŠ¡ç«¯æ‰§è¡Œ<code>/actuator/bus-refresh</code>çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯æ¥æ”¶ä¸åˆ°ä¿¡æ¯ã€‚</p></blockquote><h3 id="é…ç½®æ–‡ä»¶-1"><a href="#é…ç½®æ–‡ä»¶-1" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œ<code>application.xml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client-git</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">bus:</span></span><br><span class="line">      <span class="attr">trace:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28089</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">refresh</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨<code>spring cloud bus</code>ï¼Œ<code>bootstrap.xml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-config</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br></pre></td></tr></table></figure><h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p>åŸºæœ¬ä¸Šæ²¡æœ‰å•¥æ”¹åŠ¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.hello:error&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String profile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/info&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(profile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@RefreshScope</code>æ³¨è§£å¿…é¡»åŠ ä¸Šï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šå—åˆ°æœåŠ¡ç«¯çš„æ›´æ–°æ¶ˆæ¯ï¼Œä½†æ˜¯æ›´æ–°ä¸äº†ï¼Œå› ä¸ºä¸çŸ¥é“æ›´æ–°å“ªé‡Œçš„ã€‚</p><h3 id="å¯åŠ¨ç±»-1"><a href="#å¯åŠ¨ç±»-1" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>é»˜è®¤çš„å°±å¯ä»¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfitClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfitClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>åˆ†åˆ«å¯åŠ¨<code>æ³¨å†Œä¸­å¿ƒ</code>ã€<code>config-server-git</code>ã€<code>config-client</code>ï¼ˆå…¶ä¸­<code>client</code>åˆ†åˆ«ç”¨ä¸åŒç«¯å£å¯åŠ¨ä¸¤ä¸ªä»¥ä¸Šå®ä¾‹ï¼Œç”¨ä»¥æ¨¡æ‹Ÿå¤šä¸ªå®¢æˆ·ç«¯ï¼‰ï¼Œå¯åŠ¨åï¼Œ<code>RabbitMQ</code> ä¸­ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª <code>topic</code> ç±»å‹çš„ <code>Exchange</code> å’Œä¸¤ä¸ªä»¥<code>springCloudBus.anonymous.</code>å¼€å¤´çš„åŒ¿å <code>Queue</code>ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/GpiLYs.png" alt="Exchange"></p><p>-</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/ZcofUy.png" alt="Queues"></p><p>-</p><p>ä½¿ç”¨<code>postman</code>è¯·æ±‚<a href="http://localhost:28089/info">http://localhost:28089/info</a>ï¼Œå¾—åˆ°ç»“æœï¼ˆå„ä¸ªç«¯å£çš„å®¢æˆ·ç«¯æ¥å£éƒ½è¯·æ±‚ï¼‰ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/2CrYUM.png" alt="postman"></p><p>-</p><p>ä¿®æ”¹<code>test-config-test.yml</code>ï¼Œå°†é‡Œé¢çš„å†…å®¹æ”¹æˆï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">hello:</span> <span class="string">test,</span> <span class="string">are</span> <span class="string">you</span> <span class="string">ok</span> <span class="string">??</span> <span class="string">bus</span> <span class="string">!!</span></span><br></pre></td></tr></table></figure><p>å°†å…¶<code>push</code>åˆ°<code>GitHub</code>ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -X POST http://localhost:28088/actuator/bus-refresh/   </span><br></pre></td></tr></table></figure><p>å†æ¬¡è¯·æ±‚ä¸¤ä¸ªå®¢æˆ·ç«¯çš„<a href="http://localhost:28089/info">http://localhost:28089/info</a>æ¥å£ï¼Œ<strong>éƒ½èƒ½</strong>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¯´æ˜æˆåŠŸäº†ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/pfz34y.png" alt="postman"></p><p>-</p><blockquote><p><strong>åªè¦å¼€å¯ <code>Spring Cloud Bus</code> åï¼Œä¸ç®¡æ˜¯å¯¹ <code>config-server</code> è¿˜æ˜¯ <code>config-client</code> æ‰§è¡Œ<code>/actuator/bus-refresh</code>éƒ½æ˜¯å¯ä»¥æ›´æ–°é…ç½®çš„ã€‚</strong></p></blockquote><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>å½“ä½¿ç”¨<code>SpringBoot-2.1.1.RELEASE</code>çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥é”™ä»¥ä¸‹é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Failed to introspect Class \[org.springframework.cloud.stream.config.BindingServiceConfiguration] from ClassLoader \[sun.misc.Launcher$AppClassLoader@18b4aac2]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç•™ç€ä»¥åç ”ç©¶ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="http://www.ityouknow.com/springcloud/2017/05/26/springcloud-config-eureka-bus.html">é…ç½®ä¸­å¿ƒå’Œæ¶ˆæ¯æ€»çº¿ï¼ˆé…ç½®ä¸­å¿ƒç»ˆç»“ç‰ˆï¼‰</a></li><li><a href="https://windmt.com/2018/04/19/spring-cloud-9-config-eureka-bus/">é…ç½®ä¸­å¿ƒï¼ˆæ¶ˆæ¯æ€»çº¿ï¼‰ã€Finchley ç‰ˆã€‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆé…ç½®ä¸­å¿ƒæœåŠ¡åŒ–ä¸é«˜å¯ç”¨ï¼‰</title>
      <link href="/blog/2018/12/31/2f34c065.html"/>
      <url>/blog/2018/12/31/2f34c065.html</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨é…ç½®ä¸­å¿ƒçš„å®¢æˆ·ç«¯éƒ½æ˜¯ç›´æ¥è°ƒç”¨é…ç½®ä¸­å¿ƒçš„<code>server</code>ç«¯æ¥è·å–é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚è¿™æ ·å°±å­˜åœ¨äº†ä¸€ä¸ªé—®é¢˜ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è€¦åˆæ€§å¤ªé«˜ï¼Œå¦‚æœ<code>server</code>ç«¯è¦åšé›†ç¾¤ï¼Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡åŸå§‹çš„æ–¹å¼æ¥è·¯ç”±ï¼Œ<code>server</code>ç«¯æ”¹å˜<code>IP</code>åœ°å€çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¹Ÿéœ€è¦ä¿®æ”¹é…ç½®ï¼Œä¸ç¬¦åˆ<code>springcloud</code>æœåŠ¡æ²»ç†çš„ç†å¿µã€‚<code>springcloud</code>æä¾›äº†è¿™æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†<code>server</code>ç«¯å½“åšä¸€ä¸ªæœåŠ¡æ³¨å†Œåˆ°<code>eureka</code>ä¸­ï¼Œ<code>client</code>ç«¯å»<code>eureka</code>ä¸­å»è·å–é…ç½®ä¸­å¿ƒ<code>server</code>ç«¯çš„æœåŠ¡æ—¢å¯ã€‚</p><p>åœ¨<a href="/archives/5e7c1be9.html">ä¸Šä¸€ç¯‡</a>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å®Œæˆäº†ï¼š</p><ul><li>æ„å»ºäº† <code>config-server</code>ï¼Œè¿æ¥åˆ° <code>Git</code> ä»“åº“</li><li>åœ¨ <code>Git</code> ä¸Šåˆ›å»ºäº†ä¸€ä¸ª <code>config-repo</code> ç›®å½•ï¼Œç”¨æ¥å­˜å‚¨é…ç½®ä¿¡æ¯</li><li>æ„å»ºäº† <code>config-client</code>ï¼Œæ¥è·å– <code>Git</code> ä¸­çš„é…ç½®ä¿¡æ¯</li><li>åœ¨ <code>config-client</code> ä¸­å¼€å¯äº† <code>Refresh</code>ï¼ŒåŠ¨æ€åˆ·æ–°é…ç½®ä¿¡æ¯</li></ul><p>æ¥ä¸‹æ¥ï¼ŒåŸºäºé…ç½®ä¸­å¿ƒ<code>Git</code>ç‰ˆæœ¬æ¥è¿›è¡Œæ”¹é€ ã€‚</p><h2 id="Serverç«¯æ”¹é€ "><a href="#Serverç«¯æ”¹é€ " class="headerlink" title="Serverç«¯æ”¹é€ "></a>Serverç«¯æ”¹é€ </h2><h3 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h3><p>åœ¨<code>pom.xml</code>æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨<code>application.yml</code>ä¸­æ·»åŠ <code>erueka</code>é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ç»™å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableDiscoveryClient</code>æ³¨è§£ï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerGitApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServerGitApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Server</code>ç«¯æ”¹é€ å®Œæˆï¼Œä¾æ¬¡å¯åŠ¨<code>æ³¨å†Œä¸­å¿ƒ</code>ã€<code>config-server</code>ï¼Œè®¿é—®<a href="http://localhost:28081/">http://localhost:28081</a>ï¼Œå°±ä¼šçœ‹åˆ°<code>config-server</code>å·²æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/ujqSTV.png" alt="eureka"></p><h2 id="å®¢æˆ·ç«¯æ”¹é€ "><a href="#å®¢æˆ·ç«¯æ”¹é€ " class="headerlink" title="å®¢æˆ·ç«¯æ”¹é€ "></a>å®¢æˆ·ç«¯æ”¹é€ </h2><h3 id="POM-1"><a href="#POM-1" class="headerlink" title="POM"></a>POM</h3><p>åœ¨<code>pom.xml</code>ä¸­æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="bootstrap-yml"><a href="#bootstrap-yml" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h3><p>ä¿®æ”¹<code>bootstrap.yml</code>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-config</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å»æ‰äº†<code>spring.cloud.config.uri</code>ç›´æ¥æŒ‡å‘ Server ç«¯åœ°å€çš„é…ç½®ï¼Œå¢åŠ äº†æœ€åçš„ä¸‰ä¸ªé…ç½®ï¼š</p><ul><li><code>spring.cloud.config.discovery.enabled</code>ï¼šå¼€å¯ Config æœåŠ¡å‘ç°æ”¯æŒ</li><li><code>spring.cloud.config.discovery.serviceId</code>ï¼šæŒ‡å®š Server ç«¯çš„ name, ä¹Ÿå°±æ˜¯ Server ç«¯<code>spring.application.name</code>çš„å€¼</li><li><code>eureka.client.service-url.defaultZone</code>ï¼šæŒ‡å‘é…ç½®ä¸­å¿ƒçš„åœ°å€</li></ul><p>è¿™ä¸‰ä¸ªé…ç½®æ–‡ä»¶éƒ½éœ€è¦æ”¾åˆ°<code>bootstrap.yml</code>çš„é…ç½®ä¸­ã€‚</p><h3 id="å¯åŠ¨ç±»-1"><a href="#å¯åŠ¨ç±»-1" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><h3 id="å¯åŠ¨ç±»-2"><a href="#å¯åŠ¨ç±»-2" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ç»™å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableDiscoveryClient</code>æ³¨è§£ï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfitClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfitClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Client</code>ç«¯ä¹Ÿæ”¹é€ å®Œæˆï¼Œå¯åŠ¨<code>Client</code>ç«¯ï¼Œè®¿é—®<a href="http://localhost:28081/">http://localhost:28081</a>ï¼Œå¯ä»¥çœ‹åˆ°<code>Client</code>ä¹Ÿå·²ç»æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ:</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/BERfrl.png" alt="eureka"></p><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>åœ¨<code>postman</code>è¯·æ±‚<a href="http://localhost:28089/info">http://localhost:28089/info</a>ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼Œè¯´æ˜æ”¹é€ æˆåŠŸï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/cTaxB5.png" alt="postman"></p><h2 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h2><p>å¯åŠ¨ä¸¤ä¸ª <code>Server</code> ç«¯ï¼Œç«¯å£åˆ†åˆ«ä¸º <code>28088</code> å’Œ <code>28090</code>ï¼Œæä¾›é«˜å¯ç”¨çš„ <code>Server</code> ç«¯æ”¯æŒã€‚è¿™æ ·åœ¨å…¶ä¸­ä¸€ä¸ª<code>Server</code>æŒ‚æ‰çš„æ—¶å€™ï¼Œè¿˜æœ‰å¦ä¸€ä¸ª<code>Server</code>å¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚</p><p>å…·ä½“å®æ–½ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‰“åŒ…</span></span><br><span class="line">./mvn clean package -Dmaven.test.skip=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ä¸¤ä¸ª Server</span></span><br><span class="line">java -jar target/config-server-git-0.0.1-SNAPSHOT.jar --server.port=28089</span><br><span class="line">java -jar target/config-server-git-0.0.1-SNAPSHOT.jar --server.port=28090</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«ä½¿ç”¨<code>postman</code>å»è¯·æ±‚ä¸¤ä¸ªç«¯å£çš„æœåŠ¡ç«¯ï¼Œéƒ½èƒ½æ­£ç¡®è¿”å›é…ç½®ä¿¡æ¯ï¼Œè¯´æ˜é«˜å¯ç”¨é›†æˆæˆåŠŸã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆGitç‰ˆé…ç½®ä¸­å¿ƒï¼‰</title>
      <link href="/blog/2018/12/30/5e7c1be9.html"/>
      <url>/blog/2018/12/30/5e7c1be9.html</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h2><p>éšç€çº¿ä¸Šé¡¹ç›®å˜çš„æ—¥ç›Šåºå¤§ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½æ•£è½ç€å„ç§é…ç½®æ–‡ä»¶ï¼Œå¦‚æœé‡‡ç”¨åˆ†å¸ƒå¼çš„å¼€å‘æ¨¡å¼ï¼Œéœ€è¦çš„é…ç½®æ–‡ä»¶éšç€æœåŠ¡å¢åŠ è€Œä¸æ–­å¢å¤šã€‚æŸä¸€ä¸ªåŸºç¡€æœåŠ¡ä¿¡æ¯å˜æ›´ï¼Œéƒ½ä¼šå¼•èµ·ä¸€ç³»åˆ—çš„æ›´æ–°å’Œé‡å¯ï¼Œè¿ç»´è‹¦ä¸å ªè¨€ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚é…ç½®ä¸­å¿ƒä¾¿æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„çµä¸¹å¦™è¯ã€‚**<code>Spring Cloud Config</code>ï¼Œå› ä¸ºå®ƒåŠŸèƒ½å…¨é¢å¼ºå¤§ï¼Œå¯ä»¥æ— ç¼çš„å’Œ<code>spring</code>ä½“ç³»ç›¸ç»“åˆã€‚**</p><p><code>Spring Cloud Config</code> æ˜¯ <code>Spring Cloud</code> å›¢é˜Ÿåˆ›å»ºçš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œç”¨æ¥ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åŸºç¡€è®¾æ–½å’Œå¾®æœåŠ¡åº”ç”¨æä¾›é›†ä¸­åŒ–çš„å¤–éƒ¨é…ç½®æ”¯æŒï¼Œå®ƒåˆ†ä¸ºæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¸¤ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­æœåŠ¡ç«¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡åº”ç”¨ï¼Œç”¨æ¥è¿æ¥é…ç½®ä»“åº“å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›è·å–é…ç½®ä¿¡æ¯ã€åŠ å¯† / è§£å¯†ä¿¡æ¯ç­‰è®¿é—®æ¥å£ï¼›è€Œå®¢æˆ·ç«¯åˆ™æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å„ä¸ªå¾®æœåŠ¡åº”ç”¨æˆ–åŸºç¡€è®¾æ–½ï¼Œå®ƒä»¬é€šè¿‡æŒ‡å®šçš„é…ç½®ä¸­å¿ƒæ¥ç®¡ç†åº”ç”¨èµ„æºä¸ä¸šåŠ¡ç›¸å…³çš„é…ç½®å†…å®¹ï¼Œå¹¶åœ¨å¯åŠ¨çš„æ—¶å€™ä»é…ç½®ä¸­å¿ƒè·å–å’ŒåŠ è½½é…ç½®ä¿¡æ¯ã€‚<code>Spring Cloud Config</code> å®ç°äº†å¯¹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸­ç¯å¢ƒå˜é‡å’Œå±æ€§é…ç½®çš„æŠ½è±¡æ˜ å°„ï¼Œæ‰€ä»¥å®ƒé™¤äº†é€‚ç”¨äº <code>Spring</code> æ„å»ºçš„åº”ç”¨ç¨‹åºä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»ä½•å…¶ä»–è¯­è¨€è¿è¡Œçš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚ç”±äº <code>Spring Cloud Config</code> å®ç°çš„é…ç½®ä¸­å¿ƒé»˜è®¤é‡‡ç”¨ <code>Git</code> æ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>Spring Cloud Config</code> æ„å»ºçš„é…ç½®æœåŠ¡å™¨ï¼Œå¤©ç„¶å°±æ”¯æŒå¯¹å¾®æœåŠ¡åº”ç”¨é…ç½®ä¿¡æ¯çš„ç‰ˆæœ¬ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>Git</code> å®¢æˆ·ç«¯å·¥å…·æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ã€‚å½“ç„¶å®ƒä¹Ÿæä¾›äº†å¯¹å…¶ä»–å­˜å‚¨æ–¹å¼çš„æ”¯æŒï¼Œæ¯”å¦‚ï¼š<code>SVN</code> ä»“åº“ã€æœ¬åœ°åŒ–æ–‡ä»¶ç³»ç»Ÿã€‚</p><p><strong>é…ç½®ä¸­å¿ƒæä¾›çš„åŠŸèƒ½ï¼š</strong></p><ul><li>æä¾›æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ”¯æŒ</li><li>é›†ä¸­ç®¡ç†å„ç¯å¢ƒçš„é…ç½®æ–‡ä»¶</li><li>é…ç½®æ–‡ä»¶ä¿®æ”¹ä¹‹åï¼Œå¯ä»¥å¿«é€Ÿçš„ç”Ÿæ•ˆ</li><li>å¯ä»¥è¿›è¡Œç‰ˆæœ¬ç®¡ç†</li><li>æ”¯æŒå¤§çš„å¹¶å‘æŸ¥è¯¢</li><li>æ”¯æŒå„ç§è¯­è¨€</li></ul><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>åœ¨ <code>Github</code> ä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ <code>config-repo</code> ç”¨æ¥å­˜æ”¾é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºä»¥ä¸‹ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; å¼€å‘ç¯å¢ƒ</span><br><span class="line">test-config-dev.yml</span><br><span class="line">&#x2F;&#x2F; æµ‹è¯•ç¯å¢ƒ</span><br><span class="line">test-config-test.yml</span><br><span class="line">&#x2F;&#x2F; ç”Ÿäº§ç¯å¢ƒ</span><br><span class="line">test-config-prod.yml</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ–‡ä»¶éƒ½å†™ä¸€ä¸ª<code>test.hello</code>å±æ€§ï¼Œå±æ€§å€¼åˆ†åˆ«æ˜¯<code>dev</code>ã€<code>test</code>ã€<code>prod</code>ï¼Œå¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">hello:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><h2 id="Serverç«¯"><a href="#Serverç«¯" class="headerlink" title="Serverç«¯"></a>Serverç«¯</h2><p>åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ <code>Spring Boot</code> å·¥ç¨‹ï¼Œå‘½åä¸ºï¼š<code>config-server-git</code>ã€‚</p><h3 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>spring-cloud-config-server</code>ä¾èµ–ã€‚</p><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®æœåŠ¡çš„åŸºæœ¬ä¿¡æ¯ä»¥åŠgitçš„åœ°å€ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/cayzlh/SpringCloudDemos</span> <span class="comment"># é…ç½®gitä»“åº“çš„åœ°å€</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config-repo</span> <span class="comment"># gitä»“åº“åœ°å€ä¸‹çš„ç›¸å¯¹åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œç”¨,åˆ†å‰²ã€‚</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28088</span></span><br></pre></td></tr></table></figure><p><code>Spring Cloud Config</code> ä¹Ÿæä¾›æœ¬åœ°å­˜å‚¨é…ç½®çš„æ–¹å¼ã€‚æˆ‘ä»¬åªéœ€è¦è®¾ç½®å±æ€§<code>spring.profiles.active=native</code>ï¼Œ<code>Config Server</code> ä¼šé»˜è®¤ä»åº”ç”¨çš„<code>src/main/resource</code>ç›®å½•ä¸‹æ£€ç´¢é…ç½®æ–‡ä»¶ã€‚ä¹Ÿå¯ä»¥é€šè¿‡<code>spring.cloud.config.server.native.searchLocations=file:E:/properties/</code>å±æ€§æ¥æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚è™½ç„¶ <code>Spring Cloud Config</code> æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸ºäº†æ”¯æŒæ›´å¥½çš„ç®¡ç†å†…å®¹å’Œç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨ <code>Git</code> çš„æ–¹å¼ã€‚</p><blockquote><p>å¦‚æœæˆ‘ä»¬çš„ Git ä»“åº“éœ€è¦æƒé™è®¿é—®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡é…ç½®ä¸‹é¢çš„ä¸¤ä¸ªå±æ€§æ¥å®ç°ï¼›<br>spring.cloud.config.server.git.usernameï¼šè®¿é—® Git ä»“åº“çš„ç”¨æˆ·å<br>spring.cloud.config.server.git.passwordï¼šè®¿é—® Git ä»“åº“çš„ç”¨æˆ·å¯†ç </p></blockquote><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>å¯åŠ¨ç±»æ·»åŠ <code>@EnableConfigServer</code>ï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerGitApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServerGitApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Server</code>ç«¯çš„é…ç½®åˆ°æ­¤ä¸ºæ­¢</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æµ‹è¯• <code>Server</code> ç«¯æ˜¯å¦å¯ä»¥è¯»å–åˆ° <code>github</code> ä¸Šé¢çš„é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡<code>postman</code>è¯·æ±‚<a href="http://localhost:28088/test-config/test">http://localhost:28088/test-config/test</a>ï¼Œè¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test-config&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;profiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;test&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;cd3f7acc23d556b64499d08ea9a14d2ee23c4534&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;state&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;propertySources&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;https://github.com/cayzlh/\</span></span><br><span class="line"><span class="string">SpringCloudDemos/config-repo/test-config-test.yml&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;test.hello&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨ï¼š</strong>è·¯å¾„ä¸­çš„<code>test-config</code>æ˜¯æŒ‡<code>config-repo</code>ä¸­çš„æ–‡ä»¶åå‰ç¼€ã€‚</p><p>ä¿®æ”¹<code>test-config-test.yml</code>ä¸­çš„å†…å®¹ï¼Œå†æ¬¡åœ¨<code>postman</code>è¯·æ±‚ï¼Œå‘ç°è¿”å›çš„å†…å®¹æ˜¯æœ€æ–°çš„äº†ï¼Œè¯´æ˜<code>Server</code>ç«¯ä¼šè‡ªåŠ¨è¯»å–æœ€æ–°æäº¤çš„å†…å®¹ã€‚</p><blockquote><p>ä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶ä¼šè¢«è½¬æ¢æˆ Web æ¥å£ï¼Œè®¿é—®å¯ä»¥å‚ç…§ä»¥ä¸‹çš„è§„åˆ™ï¼š</p><ul><li>/{application}/{profile}[/{label}]</li><li>/{application}-{profile}.yml</li><li>/{label}/{application}-{profile}.yml</li><li>/{application}-{profile}.properties</li><li>/{label}/{application}-{profile}.properties</li></ul><p>ä¸Šé¢çš„ <code>URL</code> ä¼šæ˜ å°„<code>&#123;application&#125;-&#123;profile&#125;.yml</code>å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­<code>&#123;label&#125;</code>å¯¹åº” Git ä¸Šä¸åŒçš„åˆ†æ”¯ï¼Œé»˜è®¤ä¸º <code>master</code>ã€‚ä»¥ <code>config-client-dev.yml</code> ä¸ºä¾‹å­ï¼Œå®ƒçš„ <code>application</code> æ˜¯ <code>config-client</code>ï¼Œ<code>profile</code> æ˜¯ <code>dev</code>ã€‚</p></blockquote><h2 id="Clientç«¯"><a href="#Clientç«¯" class="headerlink" title="Clientç«¯"></a>Clientç«¯</h2><p>åœ¨å¾®æœåŠ¡åº”ç”¨ä¸­è·å–ä¸Šè¿°çš„é…ç½®ä¿¡æ¯ã€‚å†åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ <code>Spring Boot</code> åº”ç”¨ï¼Œå‘½åä¸º <code>config-client</code>ã€‚</p><h3 id="POM-1"><a href="#POM-1" class="headerlink" title="POM"></a>POM</h3><p>ä¿®æ”¹<code>pom</code>æ–‡ä»¶ï¼Œå¼•å…¥å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p><em><code>spring-boot-starter-webflux</code> æ˜¯ä¸ºäº†æ–¹ä¾¿ <code>Web</code> æµ‹è¯•ã€‚<code>Spring WebFlux</code> æ˜¯éš <code>Spring 5</code> æ¨å‡ºçš„å“åº”å¼ <code>Web</code> æ¡†æ¶ã€‚</em></p><h3 id="é…ç½®æ–‡ä»¶-1"><a href="#é…ç½®æ–‡ä»¶-1" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>éœ€è¦ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œ<code>application.yml</code>å’Œ<code>bootstrap.yml</code>ã€‚</p><p><code>application.yml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client-git</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28089</span></span><br></pre></td></tr></table></figure><p><code>bootstrap.yml</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:28088</span> <span class="comment"># é…ç½®ä¸­å¿ƒçš„å…·ä½“åœ°å€ï¼Œå³ config-server</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-config</span> <span class="comment"># å¯¹åº” &#123;application&#125; éƒ¨åˆ†</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">test</span> <span class="comment"># å¯¹åº” &#123;profile&#125; éƒ¨åˆ†</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment"># å¯¹åº” &#123;label&#125; éƒ¨åˆ†ï¼Œå³ Git çš„åˆ†æ”¯ã€‚å¦‚æœé…ç½®ä¸­å¿ƒä½¿ç”¨çš„æ˜¯æœ¬åœ°å­˜å‚¨ï¼Œåˆ™è¯¥å‚æ•°æ— ç”¨</span></span><br></pre></td></tr></table></figure><ul><li>spring.application.nameï¼šå¯¹åº”{application}éƒ¨åˆ†</li><li>spring.cloud.config.profileï¼šå¯¹åº”{profile}éƒ¨åˆ†</li><li>spring.cloud.config.labelï¼šå¯¹åº”gitçš„åˆ†æ”¯ã€‚å¦‚æœé…ç½®ä¸­å¿ƒä½¿ç”¨çš„æ˜¯æœ¬åœ°å­˜å‚¨ï¼Œåˆ™è¯¥å‚æ•°æ— ç”¨</li><li>spring.cloud.config.uriï¼šé…ç½®ä¸­å¿ƒçš„å…·ä½“åœ°å€</li><li>spring.cloud.config.discovery.service-idï¼šæŒ‡å®šé…ç½®ä¸­å¿ƒçš„service-idï¼Œä¾¿äºæ‰©å±•ä¸ºé«˜å¯ç”¨é…ç½®é›†ç¾¤ã€‚</li></ul><blockquote><p>ä¸Šé¢è¿™äº›ä¸ <code>Spring Cloud Config</code> ç›¸å…³çš„å±æ€§å¿…é¡»é…ç½®åœ¨ <code>bootstrap.yml</code> ä¸­ï¼Œ<code>config</code> éƒ¨åˆ†å†…å®¹æ‰èƒ½è¢«æ­£ç¡®åŠ è½½ã€‚å› ä¸º <code>config</code> çš„ç›¸å…³é…ç½®ä¼šå…ˆäº <code>application.yml</code>ï¼Œè€Œ <code>bootstrap.yml</code> çš„åŠ è½½ä¹Ÿæ˜¯å…ˆäº <code>application.yml</code>ã€‚</p></blockquote><h3 id="å¯åŠ¨ç±»-1"><a href="#å¯åŠ¨ç±»-1" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ä¸éœ€è¦ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfitClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfitClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å»º<code>HelloController</code>ï¼Œä½¿ç”¨<code>@value</code>æ³¨è§£æ¥è·å–<code>Server</code>ç«¯å‚æ•°çš„å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.hello:error&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String profile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/info&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(profile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä½¿ç”¨<code>postman</code>è¯·æ±‚<a href="http://localhost:28089/info">http://localhost:28089/info</a>ï¼Œè¿”å›å¦‚ä¸‹ç»“æœï¼Œåˆ™è¯´æ˜<code>Client</code>ç«¯æˆåŠŸè·å–åˆ°äº†<code>Server</code>ç«¯çš„é…ç½®å€¼ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/h1eyl7.png" alt="postman"></p><p>è‡³æ­¤ï¼Œ<code>SpringCloud</code>çš„<code>Git</code>ç‰ˆé…ç½®ä¸­å¿ƒå°±å®Œæˆäº†ã€‚</p><h2 id="Refresh"><a href="#Refresh" class="headerlink" title="Refresh"></a>Refresh</h2><p><code>Spring Cloud Config</code>åˆ†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯è´Ÿè´£å°†<code>gitï¼ˆsvnï¼‰</code>ä¸­å­˜å‚¨çš„é…ç½®æ–‡ä»¶å‘å¸ƒæˆ<code>REST</code>æ¥å£ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»æœåŠ¡ç«¯<code>REST</code>æ¥å£è·å–é…ç½®ã€‚ä½†å®¢æˆ·ç«¯å¹¶ä¸èƒ½ä¸»åŠ¨æ„ŸçŸ¥åˆ°é…ç½®çš„å˜åŒ–ï¼Œä»è€Œä¸»åŠ¨å»è·å–æ–°çš„é…ç½®ã€‚å®¢æˆ·ç«¯å¦‚ä½•å»ä¸»åŠ¨è·å–æ–°çš„é…ç½®ä¿¡æ¯å‘¢ï¼Œ<code>springcloud</code>å·²ç»ç»™æˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œæ¯ä¸ªå®¢æˆ·ç«¯é€šè¿‡<code>POST</code>æ–¹æ³•è§¦å‘å„è‡ªçš„<code>/refresh</code>ã€‚</p><p>ä»…ä¿®æ”¹å®¢æˆ·ç«¯é¡¹ç›®ï¼Œå°±å¯ä»¥å®ç° <code>refresh</code> çš„åŠŸèƒ½ã€‚</p><h3 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¢åŠ äº†<code>spring-boot-starter-actuator</code>åŒ…ï¼Œ<code>spring-boot-starter-actuator</code>æ˜¯ä¸€å¥—ç›‘æ§çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›‘æ§ç¨‹åºåœ¨è¿è¡Œæ—¶çŠ¶æ€ï¼Œå…¶ä¸­å°±åŒ…æ‹¬<code>/actuator/refresh</code>çš„åŠŸèƒ½ã€‚</p><h3 id="å¼€å¯æ›´æ–°æœºåˆ¶"><a href="#å¼€å¯æ›´æ–°æœºåˆ¶" class="headerlink" title="å¼€å¯æ›´æ–°æœºåˆ¶"></a>å¼€å¯æ›´æ–°æœºåˆ¶</h3><p>éœ€è¦ç»™åŠ è½½å˜é‡çš„ç±»ä¸Šé¢åŠ è½½<code>@RefreshScope</code>ï¼Œåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ<code>/actuator/refresh</code>çš„æ—¶å€™å°±ä¼šæ›´æ–°æ­¤ç±»ä¸‹é¢çš„å˜é‡å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.hello:error&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String profile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/info&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(profile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶-2"><a href="#é…ç½®æ–‡ä»¶-2" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p><code>SpringBoot1.5</code>ä»¥åéœ€è¦æ·»åŠ ä»¥ä¸‹é…ç½®ä»¥å°†<code>/actuator/refresh</code>è¿™ä¸ª <code>Endpoint</code> æš´éœ²å‡ºæ¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">refresh</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•-2"><a href="#æµ‹è¯•-2" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>é‡å¯ <code>config-client</code>ï¼Œæˆ‘ä»¬ä»¥ <code>POST</code> è¯·æ±‚çš„æ–¹å¼æ¥è®¿é—®<a href="http://localhost:28089/actuator/refresh">http://localhost:28089/actuator/refresh</a>å°±ä¼šæ›´æ–°é…ç½®æ–‡ä»¶è‡³æœ€æ–°ç‰ˆæœ¬ã€‚</p><ol><li>ä¿®æ”¹<code>test-config-test.yml</code>æ–‡ä»¶çš„å†…å®¹</li><li>ä½¿ç”¨<code>postman</code>è¯·æ±‚<a href="http://localhost:28089/actuator/refresh">http://localhost:28089/actuator/refresh</a>æ¥å£</li><li>å†è¯·æ±‚<a href="http://localhost:28089/info">http://localhost:28089/info</a>æ¥å£</li><li>å‘ç°é…ç½®å†…å®¹å·²ç»æ›´æ–°åˆ°æœ€æ–°äº†</li></ol><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/qtrGxR.png" alt="postman"></p><p>è‡³æ­¤ï¼Œé…ç½®ä¸­å¿ƒçš„é…ç½®åˆ·æ–°å°±ç®—å®Œæˆäº†ï¼Œä½†æ˜¯è¿™æ ·åšæœ‰ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ›´æ–°äº†é…ç½®ä¹‹åéƒ½è¦è¯·æ±‚<code>refresh</code>æ¥å£ï¼Œè¿™å°±å¾ˆéº»çƒ¦ã€‚ã€‚</p><h3 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h3><p><code>Webhook</code> æ˜¯å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡å‘é€ <code>HTTP POST</code> è¯·æ±‚çš„æ–¹å¼æ¥é€šçŸ¥ä¿¡æ¯æ¥æ”¶æ–¹ã€‚<code>Webhook</code> æ¥ç›‘æµ‹ä½ åœ¨ <code>Github.com</code> ä¸Šçš„å„ç§äº‹ä»¶ï¼Œæœ€å¸¸è§çš„è«è¿‡äº <code>push</code> äº‹ä»¶ã€‚å¦‚æœä½ è®¾ç½®äº†ä¸€ä¸ªç›‘æµ‹ <code>push</code> äº‹ä»¶çš„ <code>Webhook</code>ï¼Œé‚£ä¹ˆæ¯å½“ä½ çš„è¿™ä¸ªé¡¹ç›®æœ‰äº†ä»»ä½•æäº¤ï¼Œè¿™ä¸ª <code>Webhook</code> éƒ½ä¼šè¢«è§¦å‘ï¼Œè¿™æ—¶ <code>Github</code> å°±ä¼šå‘é€ä¸€ä¸ª <code>HTTP POST</code> è¯·æ±‚åˆ°ä½ é…ç½®å¥½çš„åœ°å€ã€‚</p><p>å¦‚æ­¤ä¸€æ¥ï¼Œä½ å°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å»è‡ªåŠ¨å®Œæˆä¸€äº›é‡å¤æ€§å·¥ä½œï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ <code>Webhook</code> æ¥è‡ªåŠ¨è§¦å‘ä¸€äº›æŒç»­é›†æˆï¼ˆCIï¼‰å·¥å…·çš„è¿ä½œï¼Œæ¯”å¦‚ <code>Travis CI</code>ï¼›åˆæˆ–è€…æ˜¯é€šè¿‡ <code>Webhook</code> å»éƒ¨ç½²ä½ çš„çº¿ä¸ŠæœåŠ¡å™¨ã€‚ä¸‹å›¾å°±æ˜¯ <code>Github</code> ä¸Šé¢çš„ <code>Webhook</code> é…ç½®ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/ATMvIp.jpg" alt="Webhook"></p><ul><li><code>Payload URL</code> ï¼šè§¦å‘åå›è°ƒçš„ URL</li><li><code>Content type</code> ï¼šæ•°æ®æ ¼å¼ï¼Œä¸¤ç§ä¸€èˆ¬ä½¿ç”¨ json</li><li><code>Secret</code> ï¼šç”¨ä½œç»™ POST çš„ body åŠ å¯†çš„å­—ç¬¦ä¸²ã€‚é‡‡ç”¨ HMAC ç®—æ³•</li><li><code>events</code> ï¼šè§¦å‘çš„äº‹ä»¶åˆ—è¡¨ã€‚</li></ul><p>-</p><table><thead><tr><th>events äº‹ä»¶ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>push</td><td>ä»“åº“æœ‰ push æ—¶è§¦å‘ã€‚é»˜è®¤äº‹ä»¶</td></tr><tr><td>create</td><td>å½“æœ‰åˆ†æ”¯æˆ–æ ‡ç­¾è¢«åˆ›å»ºæ—¶è§¦å‘</td></tr><tr><td>delete</td><td>å½“æœ‰åˆ†æ”¯æˆ–æ ‡ç­¾è¢«åˆ é™¤æ—¶è§¦å‘</td></tr></tbody></table><p>-</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ <code>hook</code> çš„æœºåˆ¶å»è§¦å‘å®¢æˆ·ç«¯çš„æ›´æ–°ï¼Œä½†æ˜¯å½“å®¢æˆ·ç«¯è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œ<code>hook</code> æœºåˆ¶ä¹Ÿä¸å¤Ÿä¼˜é›…äº†ï¼Œå¦å¤–æ¯æ¬¡å¢åŠ å®¢æˆ·ç«¯éƒ½éœ€è¦æ”¹åŠ¨ <code>hook</code> ä¹Ÿæ˜¯ä¸ç°å®çš„ã€‚å…¶å®ï¼Œ<code>Spring Cloud</code> ç»™äº†æˆ‘ä»¬æ›´å¥½è§£å†³æ–¹æ¡ˆâ€”â€”<code>Spring Cloud Bus</code>ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="http://www.ityouknow.com/springcloud/2017/05/22/springcloud-config-git.html">é…ç½®ä¸­å¿ƒgitç¤ºä¾‹</a></li><li><a href="http://www.ityouknow.com/springcloud/2017/05/23/springcloud-config-svn-refresh.html">é…ç½®ä¸­å¿ƒsvnç¤ºä¾‹å’Œrefresh</a></li><li><a href="https://windmt.com/2018/04/19/spring-cloud-7-config-sample/">Spring Cloudï¼ˆä¸ƒï¼‰ï¼šé…ç½®ä¸­å¿ƒï¼ˆGit ç‰ˆä¸åŠ¨æ€åˆ·æ–°ï¼‰ã€Finchley ç‰ˆã€‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆHystrixç›‘æ§æ•°æ®èšåˆTurbineï¼‰</title>
      <link href="/blog/2018/12/29/9090e9d4.html"/>
      <url>/blog/2018/12/29/9090e9d4.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹ç»å¸¸éœ€è¦éƒ¨ç½²ä¸Šç™¾ç”šè‡³ä¸Šåƒä¸ªï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿ç»´äººå‘˜å¸Œæœ›èƒ½å¤ŸæŠŠç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹çŠ¶æ€ä»¥ä¸€ä¸ªæ•´ä½“é›†ç¾¤çš„å½¢å¼å±•ç°å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„æŠŠæ¡æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ã€‚ ä¸ºæ­¤ï¼ŒNetflixæä¾›äº†ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ˆTurbineï¼‰æ¥æä¾›æŠŠå¤šä¸ªhystrix.streamçš„å†…å®¹èšåˆä¸ºä¸€ä¸ªæ•°æ®æºä¾›Dashboardå±•ç¤ºã€‚</p></blockquote><h2 id="åˆ›å»ºTurbine"><a href="#åˆ›å»ºTurbine" class="headerlink" title="åˆ›å»ºTurbine"></a>åˆ›å»ºTurbine</h2><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>Turbine</code>çš„<code>Spring Boot</code>å·¥ç¨‹</p><h3 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h3><p>åœ¨<code>pom.xml</code>ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-turbine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>åœ¨å¯åŠ¨ç±»ä¸Šä½¿ç”¨<code>@EnableTurbine</code>æ³¨è§£å¼€å¯ <code>Turbine</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableTurbine</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurbineApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TurbineApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨ <code>application.yml</code> åŠ å…¥ <code>Eureka</code> å’Œ <code>Turbine</code> çš„ç›¸å…³é…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hystrix-dashboard-turbine</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28087</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28088</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br><span class="line"><span class="attr">turbine:</span></span><br><span class="line">  <span class="attr">app-config:</span> <span class="string">eureka-consumer</span></span><br><span class="line">  <span class="attr">cluster-name-expression:</span> <span class="string">new</span> <span class="string">String(&quot;default&quot;)</span></span><br><span class="line">  <span class="attr">combine-host-port:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°ï¼š</strong></p><ul><li><code>turbine.app-config</code>å‚æ•°æŒ‡å®šäº†éœ€è¦æ”¶é›†ç›‘æ§ä¿¡æ¯çš„æœåŠ¡åï¼›</li><li><code>turbine.cluster-name-expression</code> å‚æ•°æŒ‡å®šäº†é›†ç¾¤åç§°ä¸º <code>default</code>ï¼Œå½“æˆ‘ä»¬æœåŠ¡æ•°é‡éå¸¸å¤šçš„æ—¶å€™ï¼Œå¯ä»¥å¯åŠ¨å¤šä¸ª Turbine æœåŠ¡æ¥æ„å»ºä¸åŒçš„èšåˆé›†ç¾¤ï¼Œè€Œè¯¥å‚æ•°å¯ä»¥ç”¨æ¥åŒºåˆ†è¿™äº›ä¸åŒçš„èšåˆé›†ç¾¤ï¼ŒåŒæ—¶è¯¥å‚æ•°å€¼å¯ä»¥åœ¨ Hystrix ä»ªè¡¨ç›˜ä¸­ç”¨æ¥å®šä½ä¸åŒçš„èšåˆé›†ç¾¤ï¼Œåªéœ€è¦åœ¨ Hystrix Stream çš„ URL ä¸­é€šè¿‡ cluster å‚æ•°æ¥æŒ‡å®šï¼›</li><li><code>turbine.combine-host-port</code>å‚æ•°è®¾ç½®ä¸º<code>true</code>ï¼Œå¯ä»¥è®©åŒä¸€ä¸»æœºä¸Šçš„æœåŠ¡é€šè¿‡ä¸»æœºåä¸ç«¯å£å·çš„ç»„åˆæ¥è¿›è¡ŒåŒºåˆ†ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä»¥ host æ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡ï¼Œè¿™ä¼šä½¿å¾—åœ¨æœ¬åœ°è°ƒè¯•çš„æ—¶å€™ï¼Œæœ¬æœºä¸Šçš„ä¸åŒæœåŠ¡èšåˆæˆä¸€ä¸ªæœåŠ¡æ¥ç»Ÿè®¡ã€‚</li></ul><p>å…¶ä¸­ï¼š<code>new String(&quot;default&quot;)</code>è¿™ä¸ªä¸€å®šè¦ç”¨ String æ¥åŒ…ä¸€ä¸‹ï¼Œå¦åˆ™å¯åŠ¨çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">org.springframework.expression.spel.SpelEvaluationException: EL1008E: Property or field &#x27;default&#x27; cannot be found on object of type &#x27;com.netflix.appinfo.InstanceInfo&#x27; - maybe not public or not valid?</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®<a href="http://localhost:28086/hystrix">http://localhost:28086/hystrix</a>ï¼Œå¼€å¯å¯¹<code>http://localhost:28087/turbine.stream</code>çš„ç›‘æ§ï¼Œèƒ½å¤Ÿçœ‹åˆ°é’ˆå¯¹æœåŠ¡<code>eureka-consumer</code>çš„èšåˆç›‘æ§æ•°æ®ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/RmKaJd.png" alt="turbine"></p><p>æ­¤æ—¶çš„æœåŠ¡æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/vFi62E.jpg" alt="turbine"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://windmt.com/2018/04/17/spring-cloud-6-turbine/">Spring Cloudï¼ˆå…­ï¼‰ï¼šHystrix ç›‘æ§æ•°æ®èšåˆ Turbineã€Finchley ç‰ˆã€‘</a></li><li><a href="http://www.ityouknow.com/springcloud/2017/05/18/hystrix-dashboard-turbine.html">springcloud(äº”)ï¼šç†”æ–­ç›‘æ§Hystrix Dashboardå’ŒTurbine</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆHystrixç†”æ–­ç›‘æ§é¢æ¿ï¼‰</title>
      <link href="/blog/2018/12/23/c10f5abe.html"/>
      <url>/blog/2018/12/23/c10f5abe.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« å†…å®¹éƒ¨åˆ†æ‘˜æŠ„è‡ª<a href="http://www.ityouknow.com/springcloud/2017/05/18/hystrix-dashboard-turbine.html">springcloud(äº”)ï¼šç†”æ–­ç›‘æ§Hystrix Dashboardå’ŒTurbine</a></p></blockquote><p>æ–­è·¯å™¨æ˜¯æ ¹æ®ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ¥åˆ¤æ–­å¹¶æ“ä½œæ–­è·¯å™¨çš„æ‰“å¼€å’Œå…³é—­çŠ¶æ€çš„ã€‚</p><p><code>Hystrix-dashboard</code>æ˜¯ä¸€æ¬¾é’ˆå¯¹<code>Hystrix</code>è¿›è¡Œå®æ—¶ç›‘æ§çš„å·¥å…·ï¼Œé€šè¿‡<code>Hystrix Dashboard</code>æˆ‘ä»¬å¯ä»¥åœ¨ç›´è§‚åœ°çœ‹åˆ°å„<code>Hystrix Command</code>çš„è¯·æ±‚å“åº”æ—¶é—´, è¯·æ±‚æˆåŠŸç‡ç­‰æ•°æ®ã€‚ä½†æ˜¯åªä½¿ç”¨<code>Hystrix Dashboard</code>çš„è¯, ä½ åªèƒ½çœ‹åˆ°å•ä¸ªåº”ç”¨å†…çš„æœåŠ¡ä¿¡æ¯, è¿™æ˜æ˜¾ä¸å¤Ÿ. æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·èƒ½è®©æˆ‘ä»¬æ±‡æ€»ç³»ç»Ÿå†…å¤šä¸ªæœåŠ¡çš„æ•°æ®å¹¶æ˜¾ç¤ºåˆ°<code>Hystrix Dashboard</code>ä¸Š, è¿™ä¸ªå·¥å…·å°±æ˜¯<code>Turbine</code>.</p><h2 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h2><p>åˆ›å»ºä¸€ä¸ª<code>SpringBoot</code>å·¥ç¨‹ï¼Œèµ·åä¸º<code>hystrix-dashboard</code>ã€‚</p><h3 id="pomé…ç½®"><a href="#pomé…ç½®" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h3><p>åœ¨<code>pom.xml</code>ä¸­å¼•å…¥ç›¸å…³ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableHystrixDashboard</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixDashboardApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hystrix-dashboard</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28086</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p>å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®<a href="http://localhost:28086/hystrix">http://localhost:28086/hystrix</a>ï¼Œçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/P0aNxz.png" alt="hystrix-dashboard"></p><h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><blockquote><p>è¿™æ®µæ¥æºï¼š<a href="https://windmt.com/2018/04/16/spring-cloud-5-hystrix-dashboard/">https://windmt.com/2018/04/16/spring-cloud-5-hystrix-dashboard/</a></p></blockquote><p>é€šè¿‡ <code>Hystrix Dashboard</code> ä¸»é¡µé¢çš„æ–‡å­—ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ<code>Hystrix Dashboard</code> å…±æ”¯æŒä¸‰ç§ä¸åŒçš„ç›‘æ§æ–¹å¼ï¼š</p><ul><li>é»˜è®¤çš„é›†ç¾¤ç›‘æ§ï¼šé€šè¿‡ URLï¼š<a href="http://turbine-hostname:port/turbine.stream">http://turbine-hostname:port/turbine.stream</a> å¼€å¯ï¼Œå®ç°å¯¹é»˜è®¤é›†ç¾¤çš„ç›‘æ§ã€‚</li><li>æŒ‡å®šçš„é›†ç¾¤ç›‘æ§ï¼šé€šè¿‡ URLï¼š<a href="http://turbine-hostname:port/turbine.stream?cluster=[clusterName]">http://turbine-hostname:port/turbine.stream?cluster=[clusterName]</a> å¼€å¯ï¼Œå®ç°å¯¹ <code>clusterName</code> é›†ç¾¤çš„ç›‘æ§ã€‚</li><li>å•ä½“åº”ç”¨çš„ç›‘æ§ï¼š <del>é€šè¿‡ URLï¼š<a href="http://hystrix-app:port/hystrix.stream">http://hystrix-app:port/hystrix.stream</a> å¼€å¯</del> ï¼Œå®ç°å¯¹å…·ä½“æŸä¸ªæœåŠ¡å®ä¾‹çš„ç›‘æ§ã€‚<strong>ï¼ˆç°åœ¨è¿™é‡Œçš„ URL åº”è¯¥ä¸º <a href="http://hystrix-app:port/actuator/hystrix.streamï¼ŒActuator">http://hystrix-app:port/actuator/hystrix.streamï¼ŒActuator</a> 2.x ä»¥å  endpoints å…¨éƒ¨åœ¨/actuatorä¸‹ï¼Œå¯ä»¥é€šè¿‡management.endpoints.web.base-pathä¿®æ”¹ï¼‰</strong></li></ul><p>å‰ä¸¤è€…éƒ½å¯¹é›†ç¾¤çš„ç›‘æ§ï¼Œéœ€è¦æ•´åˆ <code>Turbine</code> æ‰èƒ½å®ç°ã€‚è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å…ˆå®ç°å¯¹å•ä½“åº”ç”¨çš„ç›‘æ§ï¼Œè¿™é‡Œçš„å•ä½“åº”ç”¨å°±ç”¨æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ <code>Feign</code> å’Œ <code>Hystrix</code> å®ç°çš„æœåŠ¡æ¶ˆè´¹è€…â€”â€”<code>eureka-consumer</code>ã€‚</p><p>é¡µé¢ä¸Šçš„å¦å¤–ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><code>Delay</code>ï¼šæ§åˆ¶æœåŠ¡å™¨ä¸Šè½®è¯¢ç›‘æ§ä¿¡æ¯çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º <code>2000</code> æ¯«ç§’ï¼Œå¯ä»¥é€šè¿‡é…ç½®è¯¥å±æ€§æ¥é™ä½å®¢æˆ·ç«¯çš„ç½‘ç»œå’Œ <code>CPU</code> æ¶ˆè€—ã€‚</li><li><code>Title</code>ï¼šè¯¥å‚æ•°å¯ä»¥å±•ç¤ºåˆé€‚çš„æ ‡é¢˜ã€‚</li></ul><h2 id="æ·»åŠ endpoint"><a href="#æ·»åŠ endpoint" class="headerlink" title="æ·»åŠ endpoint"></a>æ·»åŠ <code>endpoint</code></h2><p>æ—¢ç„¶ <code>Hystrix Dashboard</code> ç›‘æ§å•å®ä¾‹èŠ‚ç‚¹éœ€è¦é€šè¿‡è®¿é—®å®ä¾‹çš„<code>/actuator/hystrix.stream</code>æ¥å£æ¥å®ç°ï¼Œè‡ªç„¶æˆ‘ä»¬éœ€è¦ä¸ºæœåŠ¡å®ä¾‹æ·»åŠ è¿™ä¸ª <code>endpoint</code>ã€‚</p><p>ä½¿ç”¨å‰é¢çš„<code>eureka-consumer</code>å·¥ç¨‹ï¼›</p><h3 id="ä¿®æ”¹pomé…ç½®"><a href="#ä¿®æ”¹pomé…ç½®" class="headerlink" title="ä¿®æ”¹pomé…ç½®"></a>ä¿®æ”¹pomé…ç½®</h3><p>åœ¨<code>dependencies</code>èŠ‚ç‚¹ä¸‹æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»-1"><a href="#å¯åŠ¨ç±»-1" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ä¿®æ”¹å¯åŠ¨ç±»ï¼Œæ·»åŠ <code>@EnableCircuitBreaker</code>æˆ–è€…<code>@EnableHystrix</code>æ³¨è§£ï¼Œå¼€å¯æ–­è·¯å™¨åŠŸèƒ½ï¼›</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶-1"><a href="#é…ç½®æ–‡ä»¶-1" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">hystrix.stream</span></span><br></pre></td></tr></table></figure><p><code>management.endpoints.web.exposure.include</code>è¿™ä¸ªæ˜¯ç”¨æ¥æš´éœ² <code>endpoints</code> çš„ã€‚ç”±äº <code>endpoints</code> ä¸­ä¼šåŒ…å«å¾ˆå¤šæ•æ„Ÿä¿¡æ¯ï¼Œé™¤äº† <code>health</code> å’Œ <code>info</code> ä¸¤ä¸ªæ”¯æŒ <code>web</code> è®¿é—®å¤–ï¼Œå…¶ä»–çš„é»˜è®¤ä¸æ”¯æŒ <code>web</code> è®¿é—®ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><ol><li><p>åˆ†åˆ«å†å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç”Ÿäº§è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€‚</p></li><li><p>åœ¨<code>Hystrix Dashboard</code>ä¸­è¾“å…¥<code>http://localhost:28085/actuator/hystrix.stream</code>ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹çš„<code>Monitor Stream</code>æŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°<code>Loding</code>ç•Œé¢ã€‚</p></li><li><p>è¿™ä¸ªæ—¶å€™è®¿é—®<a href="http://localhost:28085/hello/zhangsan">http://localhost:28085/hello/zhangsan</a>ï¼Œè®¿é—®æˆåŠŸåå†å›æ¥<code>DashBoard</code>é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/gRbwox.png" alt="hystrix-dashboard"></p></li></ol><h3 id="å›¾åƒè§£è¯»"><a href="#å›¾åƒè§£è¯»" class="headerlink" title="å›¾åƒè§£è¯»"></a>å›¾åƒè§£è¯»</h3><p>ä»¥ä¸Šå›¾æ¥è¯´æ˜å…¶ä¸­å„å…ƒç´ çš„å…·ä½“å«ä¹‰ï¼š</p><ul><li><p>å®å¿ƒåœ†ï¼šå®ƒæœ‰é¢œè‰²å’Œå¤§å°ä¹‹åˆ†ï¼Œåˆ†åˆ«ä»£è¡¨å®ä¾‹çš„ç›‘æ§ç¨‹åº¦å’Œæµé‡å¤§å°ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒçš„å¥åº·åº¦ä»ç»¿è‰²ã€é»„è‰²ã€æ©™è‰²ã€çº¢è‰²é€’å‡ã€‚é€šè¿‡è¯¥å®å¿ƒåœ†çš„å±•ç¤ºï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¤§é‡çš„å®ä¾‹ä¸­å¿«é€Ÿçš„å‘ç°æ•…éšœå®ä¾‹å’Œé«˜å‹åŠ›å®ä¾‹ã€‚</p></li><li><p>æ›²çº¿ï¼šç”¨æ¥è®°å½• 2 åˆ†é’Ÿå†…æµé‡çš„ç›¸å¯¹å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è§‚å¯Ÿåˆ°æµé‡çš„ä¸Šå‡å’Œä¸‹é™è¶‹åŠ¿ã€‚</p></li><li><p>å…¶ä»–æ•°é‡æŒ‡æ ‡</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/tPK2p4.jpg" alt="å›¾ç‰‡æ¥æºä¸ç½‘ç»œ"></p></li></ul><h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>åˆ°æ­¤ï¼Œå•ä¸ªæœåŠ¡çš„ç†”æ–­ç›‘æ§å·²ç»å®Œæˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆç†”æ–­å™¨Hystrixï¼‰</title>
      <link href="/blog/2018/12/22/5a724b6.html"/>
      <url>/blog/2018/12/22/5a724b6.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä½¿ç”¨Feign-Hystrixåšç†”æ–­å™¨"><a href="#ä½¿ç”¨Feign-Hystrixåšç†”æ–­å™¨" class="headerlink" title="ä½¿ç”¨Feign Hystrixåšç†”æ–­å™¨"></a>ä½¿ç”¨<code>Feign Hystrix</code>åšç†”æ–­å™¨</h2><p>ç†”æ–­ä½œç”¨åœ¨æœåŠ¡è°ƒç”¨çš„ä¸€ç«¯ï¼Œè¦å®ç°ç†”æ–­å™¨ï¼Œ åªéœ€åœ¨æœåŠ¡æ¶ˆè´¹è€…ï¼ˆ<code>eureka-consumer</code>ï¼‰ä¸Šåšæ”¹åŠ¨å°±è¡Œã€‚</p><p><em>Feignä¸­å·²ç»ä¾èµ–äº†Hystrixæ‰€ä»¥åœ¨mavené…ç½®ä¸Šä¸ç”¨åšä»»ä½•æ”¹åŠ¨ã€‚</em></p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-consumer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28085</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºä¸€ä¸ªå›è°ƒæ–¹æ³•ç±»"><a href="#åˆ›å»ºä¸€ä¸ªå›è°ƒæ–¹æ³•ç±»" class="headerlink" title="åˆ›å»ºä¸€ä¸ªå›è°ƒæ–¹æ³•ç±»"></a>åˆ›å»ºä¸€ä¸ªå›è°ƒæ–¹æ³•ç±»</h3><p>åˆ›å»º <code>HelloRemoteHystrix</code> ç±»å®ç° <code>HelloRemote</code> ä¸­å®ç°å›è°ƒçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloRemoteHystrix</span> <span class="keyword">implements</span> <span class="title">HelloRemote</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Helloï¼Œ&quot;</span>+name+<span class="string">&quot; ï¼Œå½“å‰æœåŠ¡å´©äº†ã€‚&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®fallbackå±æ€§"><a href="#è®¾ç½®fallbackå±æ€§" class="headerlink" title="è®¾ç½®fallbackå±æ€§"></a>è®¾ç½®fallbackå±æ€§</h3><p>åœ¨<code>HelloRemote</code>ç±»æ·»åŠ æŒ‡å®š fallback ç±»ï¼Œåœ¨æœåŠ¡ç†”æ–­çš„æ—¶å€™è¿”å› fallback ç±»ä¸­çš„å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;eureka-producer&quot;, fallback = HelloRemoteHystrix.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloRemote</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç éƒ¨åˆ†ï¼Œåˆ°æ­¤ä¸ºæ­¢å°±okäº†ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å¯åŠ¨ä¸‰ä¸ªé¡¹ç›®ï¼ˆæ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ï¼‰</p><p>è®¿é—®<a href="http://localhost:28085/hello/zhangsan">http://localhost:28085/hello/zhangsan</a>è¿”å›ç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/egbFqA.png" alt="æœåŠ¡æ­£å¸¸è¿”å›ç»“æœ"></p><p>å¯ä»¥çœ‹åˆ°å½“å‰æ˜¯æ­£å¸¸è¿”å›ç»“æœçš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒæŠŠæœåŠ¡æä¾›è€…çš„æœåŠ¡<code>kill</code>æ‰ï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:28085/hello/zhangsan">http://localhost:28085/hello/zhangsan</a>ï¼Œè¿”å›ç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/C8IGdR.png" alt="æœåŠ¡ç†”æ–­åçš„ç»“æœ"></p><p>è¯´æ˜ç†”æ–­æˆåŠŸï¼</p><h2 id="é›ªå´©æ•ˆåº”"><a href="#é›ªå´©æ•ˆåº”" class="headerlink" title="é›ªå´©æ•ˆåº”"></a>é›ªå´©æ•ˆåº”</h2><blockquote><p>è¿™æ®µæ‘˜è‡ª<a href="http://www.ityouknow.com/springcloud/2017/05/16/springcloud-hystrix.html">çº¯æ´çš„å¾®ç¬‘åšå®¢</a></p></blockquote><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­é€šå¸¸ä¼šæœ‰å¤šä¸ªæœåŠ¡å±‚è°ƒç”¨ï¼ŒåŸºç¡€æœåŠ¡çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœï¼Œè¿›è€Œé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”ã€‚æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å› â€œæœåŠ¡æä¾›è€…â€çš„ä¸å¯ç”¨å¯¼è‡´â€œæœåŠ¡æ¶ˆè´¹è€…â€çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§çš„è¿‡ç¨‹ã€‚</p><p>å¦‚æœä¸‹å›¾æ‰€ç¤ºï¼šAä½œä¸ºæœåŠ¡æä¾›è€…ï¼ŒBä¸ºAçš„æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCå’ŒDæ˜¯Bçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚Aä¸å¯ç”¨å¼•èµ·äº†Bçš„ä¸å¯ç”¨ï¼Œå¹¶å°†ä¸å¯ç”¨åƒæ»šé›ªçƒä¸€æ ·æ”¾å¤§åˆ°Cå’ŒDæ—¶ï¼Œé›ªå´©æ•ˆåº”å°±å½¢æˆäº†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/5fnF7p.png" alt="é›ªå´©æ•ˆåº”"></p><h2 id="ç†”æ–­å™¨"><a href="#ç†”æ–­å™¨" class="headerlink" title="ç†”æ–­å™¨"></a>ç†”æ–­å™¨</h2><blockquote><p>è¿™æ®µæ‘˜è‡ª<a href="http://www.ityouknow.com/springcloud/2017/05/16/springcloud-hystrix.html">çº¯æ´çš„å¾®ç¬‘åšå®¢</a></p></blockquote><p>ç†”æ–­å™¨çš„åŸç†å¾ˆç®€å•ï¼Œå¦‚åŒç”µåŠ›è¿‡è½½ä¿æŠ¤å™¨ã€‚å®ƒå¯ä»¥å®ç°å¿«é€Ÿå¤±è´¥ï¼Œå¦‚æœå®ƒåœ¨ä¸€æ®µæ—¶é—´å†…ä¾¦æµ‹åˆ°è®¸å¤šç±»ä¼¼çš„é”™è¯¯ï¼Œä¼šå¼ºè¿«å…¶ä»¥åçš„å¤šä¸ªè°ƒç”¨å¿«é€Ÿå¤±è´¥ï¼Œä¸å†è®¿é—®è¿œç¨‹æœåŠ¡å™¨ï¼Œä»è€Œé˜²æ­¢åº”ç”¨ç¨‹åºä¸æ–­åœ°å°è¯•æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œï¼Œä½¿å¾—åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œè€Œä¸ç”¨ç­‰å¾…ä¿®æ­£é”™è¯¯ï¼Œæˆ–è€…æµªè´¹CPUæ—¶é—´å»ç­‰åˆ°é•¿æ—¶é—´çš„è¶…æ—¶äº§ç”Ÿã€‚ç†”æ–­å™¨ä¹Ÿå¯ä»¥ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè¯Šæ–­é”™è¯¯æ˜¯å¦å·²ç»ä¿®æ­£ï¼Œå¦‚æœå·²ç»ä¿®æ­£ï¼Œåº”ç”¨ç¨‹åºä¼šå†æ¬¡å°è¯•è°ƒç”¨æ“ä½œã€‚</p><p>ç†”æ–­å™¨æ¨¡å¼å°±åƒæ˜¯é‚£äº›å®¹æ˜“å¯¼è‡´é”™è¯¯çš„æ“ä½œçš„ä¸€ç§ä»£ç†ã€‚è¿™ç§ä»£ç†èƒ½å¤Ÿè®°å½•æœ€è¿‘è°ƒç”¨å‘ç”Ÿé”™è¯¯çš„æ¬¡æ•°ï¼Œç„¶åå†³å®šä½¿ç”¨å…è®¸æ“ä½œç»§ç»­ï¼Œæˆ–è€…ç«‹å³è¿”å›é”™è¯¯ã€‚ ç†”æ–­å™¨å¼€å…³ç›¸äº’è½¬æ¢çš„é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/2S9QD5.png" alt="ç†”æ–­å™¨"></p><p>ç†”æ–­å™¨å°±æ˜¯ä¿æŠ¤æœåŠ¡é«˜å¯ç”¨çš„æœ€åä¸€é“é˜²çº¿ã€‚</p><h3 id="Hystrixç‰¹æ€§"><a href="#Hystrixç‰¹æ€§" class="headerlink" title="Hystrixç‰¹æ€§"></a>Hystrixç‰¹æ€§</h3><h4 id="æ–­è·¯å™¨æœºåˆ¶"><a href="#æ–­è·¯å™¨æœºåˆ¶" class="headerlink" title="æ–­è·¯å™¨æœºåˆ¶"></a>æ–­è·¯å™¨æœºåˆ¶</h4><p>æ–­è·¯å™¨å¾ˆå¥½ç†è§£, å½“<code>Hystrix Command</code>è¯·æ±‚åç«¯æœåŠ¡å¤±è´¥æ•°é‡è¶…è¿‡ä¸€å®šæ¯”ä¾‹(é»˜è®¤<code>50%</code>), æ–­è·¯å™¨ä¼šåˆ‡æ¢åˆ°å¼€è·¯çŠ¶æ€(<code>Open</code>). è¿™æ—¶æ‰€æœ‰è¯·æ±‚ä¼šç›´æ¥å¤±è´¥è€Œä¸ä¼šå‘é€åˆ°åç«¯æœåŠ¡. æ–­è·¯å™¨ä¿æŒåœ¨å¼€è·¯çŠ¶æ€ä¸€æ®µæ—¶é—´å(é»˜è®¤5ç§’), è‡ªåŠ¨åˆ‡æ¢åˆ°åŠå¼€è·¯çŠ¶æ€(<code>HALF-OPEN</code>). è¿™æ—¶ä¼šåˆ¤æ–­ä¸‹ä¸€æ¬¡è¯·æ±‚çš„è¿”å›æƒ…å†µ, å¦‚æœè¯·æ±‚æˆåŠŸ, æ–­è·¯å™¨åˆ‡å›é—­è·¯çŠ¶æ€(<code>CLOSED</code>), å¦åˆ™é‡æ–°åˆ‡æ¢åˆ°å¼€è·¯çŠ¶æ€(<code>OPEN</code>). <code>Hystrix</code>çš„æ–­è·¯å™¨å°±åƒæˆ‘ä»¬å®¶åº­ç”µè·¯ä¸­çš„ä¿é™©ä¸, ä¸€æ—¦åç«¯æœåŠ¡ä¸å¯ç”¨, æ–­è·¯å™¨ä¼šç›´æ¥åˆ‡æ–­è¯·æ±‚é“¾, é¿å…å‘é€å¤§é‡æ— æ•ˆè¯·æ±‚å½±å“ç³»ç»Ÿååé‡, å¹¶ä¸”æ–­è·¯å™¨æœ‰è‡ªæˆ‘æ£€æµ‹å¹¶æ¢å¤çš„èƒ½åŠ›.</p><h4 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h4><p><code>Fallback</code>ç›¸å½“äºæ˜¯é™çº§æ“ä½œ. å¯¹äºæŸ¥è¯¢æ“ä½œ, æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ª<code>fallback</code>æ–¹æ³•, å½“è¯·æ±‚åç«¯æœåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™, å¯ä»¥ä½¿ç”¨<code>fallback</code>æ–¹æ³•è¿”å›çš„å€¼. <code>fallback</code>æ–¹æ³•çš„è¿”å›å€¼ä¸€èˆ¬æ˜¯è®¾ç½®çš„é»˜è®¤å€¼æˆ–è€…æ¥è‡ªç¼“å­˜.</p><h4 id="èµ„æºéš”ç¦»"><a href="#èµ„æºéš”ç¦»" class="headerlink" title="èµ„æºéš”ç¦»"></a>èµ„æºéš”ç¦»</h4><p>åœ¨<code>Hystrix</code>ä¸­, ä¸»è¦é€šè¿‡çº¿ç¨‹æ± æ¥å®ç°èµ„æºéš”ç¦». é€šå¸¸åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä¼šæ ¹æ®è°ƒç”¨çš„è¿œç¨‹æœåŠ¡åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹æ± . ä¾‹å¦‚è°ƒç”¨äº§å“æœåŠ¡çš„<code>Command</code>æ”¾å…¥<code>A</code>çº¿ç¨‹æ± , è°ƒç”¨è´¦æˆ·æœåŠ¡çš„<code>Command</code>æ”¾å…¥Bçº¿ç¨‹æ± . è¿™æ ·åšçš„ä¸»è¦ä¼˜ç‚¹æ˜¯è¿è¡Œç¯å¢ƒè¢«éš”ç¦»å¼€äº†. è¿™æ ·å°±ç®—è°ƒç”¨æœåŠ¡çš„ä»£ç å­˜åœ¨<code>bug</code>æˆ–è€…ç”±äºå…¶ä»–åŸå› å¯¼è‡´è‡ªå·±æ‰€åœ¨çº¿ç¨‹æ± è¢«è€—å°½æ—¶, ä¸ä¼šå¯¹ç³»ç»Ÿçš„å…¶ä»–æœåŠ¡é€ æˆå½±å“. ä½†æ˜¯å¸¦æ¥çš„ä»£ä»·å°±æ˜¯ç»´æŠ¤å¤šä¸ªçº¿ç¨‹æ± ä¼šå¯¹ç³»ç»Ÿå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€. å¦‚æœæ˜¯å¯¹æ€§èƒ½æœ‰ä¸¥æ ¼è¦æ±‚è€Œä¸”ç¡®ä¿¡è‡ªå·±è°ƒç”¨æœåŠ¡çš„å®¢æˆ·ç«¯ä»£ç ä¸ä¼šå‡ºé—®é¢˜çš„è¯, å¯ä»¥ä½¿ç”¨<code>Hystrix</code>çš„ä¿¡å·æ¨¡å¼(<code>Semaphores</code>)æ¥éš”ç¦»èµ„æº.</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡ä½¿ç”¨ <code>Hystrix</code>ï¼Œæˆ‘ä»¬èƒ½æ–¹ä¾¿çš„é˜²æ­¢é›ªå´©æ•ˆåº”ï¼ŒåŒæ—¶ä½¿ç³»ç»Ÿå…·æœ‰è‡ªåŠ¨é™çº§å’Œè‡ªåŠ¨æ¢å¤æœåŠ¡çš„æ•ˆæœã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆæœåŠ¡æä¾›ä¸å‘ç°Eurekaï¼‰</title>
      <link href="/blog/2018/12/20/b6f15c0c.html"/>
      <url>/blog/2018/12/20/b6f15c0c.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æä¾›ä¸‰ä¸ªè§’è‰²ï¼šæœåŠ¡æ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€‚ç”¨æ¥æ¨¡æ‹Ÿ<code>Eureka</code>æœåŠ¡æä¾›è€…ä¸æ¶ˆè´¹è€…å…³ç³»ã€‚</p></blockquote><h2 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><ol><li>å¯åŠ¨æ³¨å†Œä¸­å¿ƒ</li><li>æœåŠ¡æä¾›è€…ç”Ÿäº§æœåŠ¡å¹¶æ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒä¸­</li><li>æ¶ˆè´¹è€…ä»æœåŠ¡ä¸­å¿ƒä¸­è·å–æœåŠ¡å¹¶æ‰§è¡Œ</li></ol><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/o5a0rW.jpg" alt="æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…æµç¨‹"></p><center>ï¼ˆå›¾ç‰‡æ¥æºäº<a href="https://google.com" target="_blank">ç½‘ç»œ</a>ï¼‰</center><h2 id="æœåŠ¡æ³¨å†Œä¸­å¿ƒ"><a href="#æœåŠ¡æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æœåŠ¡æ³¨å†Œä¸­å¿ƒ"></a>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</h2><p>å‚è€ƒå¦ä¸€ç‰‡ç¬”è®°ã€Š<a href="/archives/b21e91d6.html">SpringCloudï¼ˆæ³¨å†Œä¸­å¿ƒEurekaï¼‰</a>ã€‹</p><h2 id="æœåŠ¡æä¾›è€…"><a href="#æœåŠ¡æä¾›è€…" class="headerlink" title="æœåŠ¡æä¾›è€…"></a>æœåŠ¡æä¾›è€…</h2><p><strong>æä¾›ä¸€ä¸ª<code>hello()</code>æ–¹æ³•æ‰“å°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</strong></p><h3 id="æ–°å»ºä¸€ä¸ªåä¸ºspring-cloud-producerçš„SpringBootå·¥ç¨‹"><a href="#æ–°å»ºä¸€ä¸ªåä¸ºspring-cloud-producerçš„SpringBootå·¥ç¨‹" class="headerlink" title="æ–°å»ºä¸€ä¸ªåä¸ºspring-cloud-producerçš„SpringBootå·¥ç¨‹"></a>æ–°å»ºä¸€ä¸ªåä¸º<code>spring-cloud-producer</code>çš„<code>SpringBoot</code>å·¥ç¨‹</h3><h3 id="POMæ–‡ä»¶éƒ¨åˆ†é…ç½®"><a href="#POMæ–‡ä»¶éƒ¨åˆ†é…ç½®" class="headerlink" title="POMæ–‡ä»¶éƒ¨åˆ†é…ç½®"></a>POMæ–‡ä»¶éƒ¨åˆ†é…ç½®</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="application-ymlæ–‡ä»¶é…ç½®"><a href="#application-ymlæ–‡ä»¶é…ç½®" class="headerlink" title="application.ymlæ–‡ä»¶é…ç½®"></a>application.ymlæ–‡ä»¶é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-producer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28084</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>spring.application.name</code>å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¾®æœåŠ¡çš„åç§°åç»­åœ¨è°ƒç”¨çš„æ—¶å€™åªéœ€è¦ä½¿ç”¨è¯¥åç§°å°±å¯ä»¥è¿›è¡ŒæœåŠ¡çš„è®¿é—®ã€‚<code>eureka.client.serviceUrl.defaultZone</code>å±æ€§å¯¹åº”æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®å†…å®¹ï¼ŒæŒ‡å®šæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„ä½ç½®ã€‚ä¸ºäº†åœ¨æœ¬æœºä¸Šæµ‹è¯•åŒºåˆ†æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨<code>server.port</code>å±æ€§è®¾ç½®ä¸åŒçš„ç«¯å£ã€‚</p><h3 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>ä¿æŒé»˜è®¤ç”Ÿæˆçš„å³å¯ï¼Œ Finchley.RC1 è¿™ä¸ªç‰ˆæœ¬çš„ Spring Cloud å·²ç»æ— éœ€æ·»åŠ <code>@EnableDiscoveryClient</code>æ³¨è§£äº†ã€‚å¦‚æœå¼•å…¥äº†ç›¸å…³çš„jaråŒ…ï¼Œéœ€è¦ç¦ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œåªéœ€è®¾ç½®<code>eureka.client.enabled=false</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudProducerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringCloudProducerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰ä¸€ä¸ªç®€å•Controlleræ¥å£ï¼Œç”¨æ¥æä¾›helloæœåŠ¡"><a href="#å®šä¹‰ä¸€ä¸ªç®€å•Controlleræ¥å£ï¼Œç”¨æ¥æä¾›helloæœåŠ¡" class="headerlink" title="å®šä¹‰ä¸€ä¸ªç®€å•Controlleræ¥å£ï¼Œç”¨æ¥æä¾›helloæœåŠ¡"></a>å®šä¹‰ä¸€ä¸ªç®€å•Controlleræ¥å£ï¼Œç”¨æ¥æä¾›helloæœåŠ¡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;, ç°åœ¨æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒæœåŠ¡æä¾›è€…å°±å¼€å‘å®Œæˆäº†ã€‚åˆ†åˆ«å¯åŠ¨æœåŠ¡æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡æä¾›è€…ï¼Œå¯ä»¥åœ¨æ³¨å†Œ<a href="http://localhost:28081/">http://localhost:28081</a>ä¸­å¿ƒçœ‹åˆ°<code>EUERKA-PRODUCER</code>æœåŠ¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/sV2uml.png" alt="EUERKA-PRODUCER"></p><p>è®¿é—®<a href="http://localhost:28084/hello/?name=zhangsan">http://localhost:28084/hello/?name=zhangsan</a></p><p>å¯ä»¥çœ‹åˆ°æœ‰è¿”å›ç»“æœï¼Œè¯´æ˜æœåŠ¡æä¾›è€…å·²ç»é…ç½®å®Œæˆã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/E2lO45.png" alt="Hello Zhangsan"></p><h2 id="æœåŠ¡æ¶ˆè´¹è€…"><a href="#æœåŠ¡æ¶ˆè´¹è€…" class="headerlink" title="æœåŠ¡æ¶ˆè´¹è€…"></a>æœåŠ¡æ¶ˆè´¹è€…</h2><p>åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…æ ¹æ®ä½¿ç”¨ API çš„ä¸åŒï¼Œå¤§è‡´åˆ†ä¸ºä¸‰ç§æ–¹å¼ï¼ˆ<code>LoadBalancerClient</code>ã€<code>Spring Cloud Ribbon</code>å’Œ<code>Feign</code> è°ƒç”¨å®ç°ï¼‰ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ç”¨çš„åº”è¯¥éƒ½æ˜¯ <code>Feign</code>ï¼Œè¿™é‡Œåªè®°å½•<code>Feign</code>ã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªåä¸ºeureka-consumerçš„SpringBootå·¥ç¨‹"><a href="#åˆ›å»ºä¸€ä¸ªåä¸ºeureka-consumerçš„SpringBootå·¥ç¨‹" class="headerlink" title="åˆ›å»ºä¸€ä¸ªåä¸ºeureka-consumerçš„SpringBootå·¥ç¨‹"></a>åˆ›å»ºä¸€ä¸ªåä¸º<code>eureka-consumer</code>çš„<code>SpringBoot</code>å·¥ç¨‹</h3><h3 id="POMåŒ…é…ç½®"><a href="#POMåŒ…é…ç½®" class="headerlink" title="POMåŒ…é…ç½®"></a>POMåŒ…é…ç½®</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-consumer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:28081/eureka/</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28085</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ç±»-1"><a href="#å¯åŠ¨ç±»-1" class="headerlink" title="å¯åŠ¨ç±»"></a>å¯åŠ¨ç±»</h3><p>åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š<code>@EnableFeignClients</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Feign-è°ƒç”¨å®ç°"><a href="#Feign-è°ƒç”¨å®ç°" class="headerlink" title="Feign è°ƒç”¨å®ç°"></a>Feign è°ƒç”¨å®ç°</h3><p>åˆ›å»ºä¸€ä¸ª Feign çš„å®¢æˆ·ç«¯æ¥å£å®šä¹‰ã€‚ä½¿ç”¨<code>@FeignClient</code>æ³¨è§£æ¥æŒ‡å®šè¿™ä¸ªæ¥å£æ‰€è¦è°ƒç”¨çš„æœåŠ¡åç§°ï¼Œæ¥å£ä¸­å®šä¹‰çš„å„ä¸ªå‡½æ•°ä½¿ç”¨ <code>Spring MVC</code> çš„æ³¨è§£å°±å¯ä»¥æ¥ç»‘å®šæœåŠ¡æä¾›æ–¹çš„ <code>REST</code> æ¥å£ï¼Œæ¯”å¦‚ä¸‹é¢å°±æ˜¯ç»‘å®š <code>eureka-producer</code> æœåŠ¡çš„<code>/hello/</code>æ¥å£çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;eureka-producer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloRemote</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ­¤ç±»ä¸­çš„æ–¹æ³•å’Œè¿œç¨‹æœåŠ¡ä¸­ <code>Contoller</code> ä¸­çš„æ–¹æ³•åå’Œå‚æ•°éœ€ä¿æŒä¸€è‡´ã€‚</strong></p><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>å°†<code>HelloRemote</code>æ³¨å…¥åˆ°<code>Controller</code>ä¸­ï¼Œåƒæ™®é€šæ–¹æ³•ä¸€æ ·è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HelloRemote helloRemote;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloRemote.hello(name + <span class="string">&quot;!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ Spring Cloud Feign æ¥å®ç°æœåŠ¡è°ƒç”¨çš„æ–¹å¼éå¸¸ç®€å•ï¼Œé€šè¿‡<code>@FeignClient</code>å®šä¹‰çš„æ¥å£æ¥ç»Ÿä¸€çš„å£°æ˜æˆ‘ä»¬éœ€è¦ä¾èµ–çš„å¾®æœåŠ¡æ¥å£ã€‚è€Œåœ¨å…·ä½“ä½¿ç”¨çš„æ—¶å€™å°±è·Ÿè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€ç‚¹çš„è¿›è¡Œè°ƒç”¨å³å¯ã€‚ç”±äº Feign æ˜¯åŸºäº Ribbon å®ç°çš„ï¼Œæ‰€ä»¥å®ƒè‡ªå¸¦äº†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Ribbon çš„ IRule è¿›è¡Œç­–ç•¥æ‰©å±•ã€‚å¦å¤–ï¼ŒFeign è¿˜æ•´åˆçš„ Hystrix æ¥å®ç°æœåŠ¡çš„å®¹é”™ä¿æŠ¤ã€‚</p><blockquote><p>åœ¨ Finchley.RC1 ç‰ˆæœ¬ä¸­ï¼ŒFeign çš„ Hystrix é»˜è®¤æ˜¯å…³é—­çš„ã€‚</p></blockquote><p>å¯åŠ¨æœåŠ¡ï¼Œåœ¨æ³¨å†Œ<a href="http://localhost:28081/">http://localhost:28081</a>ä¸­å¿ƒçœ‹åˆ°<code>eureka-consumer</code>æœåŠ¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/W5fZJv.png" alt="eureka-consumer"></p><p>è®¿é—®<a href="http://localhost:28085/hello/zhangsan">http://localhost:28085/hello/zhangsan</a>ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¯´æ˜æ¶ˆè´¹è€…æˆåŠŸæ¶ˆè´¹äº†æä¾›è€…çš„æœåŠ¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/mM0iRg.png" alt="eureka-consumer"></p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="è¦æƒ³ä½¿ç”¨-Feignï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªä¾èµ–"><a href="#è¦æƒ³ä½¿ç”¨-Feignï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªä¾èµ–" class="headerlink" title="è¦æƒ³ä½¿ç”¨ Feignï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªä¾èµ–"></a>è¦æƒ³ä½¿ç”¨ Feignï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªä¾èµ–</h3><ul><li>spring-boot-starter-web</li><li>spring-cloud-starter-openfeign</li><li>spring-cloud-starter-netflix-eureka-cli</li></ul><h3 id="HelloRemoteç±»ä¸­çš„æ–¹æ³•å‚æ•°è¦åŠ ä¸Š-RequestParamæ³¨è§£"><a href="#HelloRemoteç±»ä¸­çš„æ–¹æ³•å‚æ•°è¦åŠ ä¸Š-RequestParamæ³¨è§£" class="headerlink" title="HelloRemoteç±»ä¸­çš„æ–¹æ³•å‚æ•°è¦åŠ ä¸Š@RequestParamæ³¨è§£"></a>HelloRemoteç±»ä¸­çš„æ–¹æ³•å‚æ•°è¦åŠ ä¸Š<code>@RequestParam</code>æ³¨è§£</h3><p>Getè¯·æ±‚çš„ç±»å‹ï¼Œ è¦åŠ ä¸Š<code>@RequestParam</code>æ³¨è§£ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ã€‚</p><blockquote><p>å½“å‚æ•°æ²¡æœ‰è¢«<code>@RequestParam</code>æ³¨è§£ä¿®é¥°æ—¶ï¼Œä¼šè‡ªåŠ¨è¢«å½“åš request body æ¥å¤„ç†ã€‚åªè¦æœ‰ bodyï¼Œå°±ä¼šè¢« Feign è®¤ä¸ºæ˜¯ POST è¯·æ±‚ï¼Œæ‰€ä»¥æ•´ä¸ªæœåŠ¡æ˜¯è¢«å½“ä½œå¸¦æœ‰ request parameter å’Œ body çš„ POST è¯·æ±‚å‘é€å‡ºå»çš„ã€‚</p></blockquote><h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><p>å°†producerå·¥ç¨‹æ‰“åŒ…æˆJaråŒ…ï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚</p><p>å½“é€šè¿‡æ¶ˆè´¹è€…è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šäº¤æ›¿æ¶ˆè´¹ä¸¤ä¸ªæœåŠ¡ï¼Œä»¥æ­¤æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudï¼ˆæ³¨å†Œä¸­å¿ƒEurekaï¼‰</title>
      <link href="/blog/2018/12/16/b21e91d6.html"/>
      <url>/blog/2018/12/16/b21e91d6.html</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>Eureka</code>æ˜¯<code>Netflix</code>å¼€æºçš„ä¸€æ¬¾æä¾›æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„äº§å“ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„<code>Service Registry</code>å’Œ<code>Service Discovery</code>å®ç°ã€‚ä¹Ÿæ˜¯<code>springcloud</code>ä½“ç³»ä¸­æœ€é‡è¦æœ€æ ¸å¿ƒçš„ç»„ä»¶ä¹‹ä¸€ã€‚</p></blockquote><h3 id="æœåŠ¡ä¸­å¿ƒ"><a href="#æœåŠ¡ä¸­å¿ƒ" class="headerlink" title="æœåŠ¡ä¸­å¿ƒ"></a>æœåŠ¡ä¸­å¿ƒ</h3><p>æœåŠ¡ä¸­å¿ƒåˆç§°æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†å„ç§æœåŠ¡åŠŸèƒ½åŒ…æ‹¬æœåŠ¡çš„æ³¨å†Œã€å‘ç°ã€ç†”æ–­ã€è´Ÿè½½ã€é™çº§ç­‰ï¼Œæ¯”å¦‚<code>dubbo admin</code>åå°çš„å„ç§åŠŸèƒ½ã€‚</p><h3 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h3><p>Eureka æ˜¯ä¸€ä¸ªåŸºäº <code>REST</code> çš„æœåŠ¡ï¼Œä¸»è¦åœ¨ <code>AWS</code> äº‘ä¸­ä½¿ç”¨, å®šä½æœåŠ¡æ¥è¿›è¡Œä¸­é—´å±‚æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ã€‚</p><p><code>Spring Cloud</code> å°è£…äº† <code>Netflix</code> å…¬å¸å¼€å‘çš„ <code>Eureka</code> æ¨¡å—æ¥å®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚<code>Eureka</code> é‡‡ç”¨äº† <code>C-S</code> çš„è®¾è®¡æ¶æ„ã€‚<code>Eureka Server</code> ä½œä¸ºæœåŠ¡æ³¨å†ŒåŠŸèƒ½çš„æœåŠ¡å™¨ï¼Œå®ƒæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚è€Œç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ï¼Œä½¿ç”¨ <code>Eureka</code> çš„å®¢æˆ·ç«¯è¿æ¥åˆ° <code>Eureka Server</code>ï¼Œå¹¶ç»´æŒå¿ƒè·³è¿æ¥ã€‚è¿™æ ·ç³»ç»Ÿçš„ç»´æŠ¤äººå‘˜å°±å¯ä»¥é€šè¿‡ Eureka Server æ¥ç›‘æ§ç³»ç»Ÿä¸­å„ä¸ªå¾®æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚<code>Spring Cloud</code> çš„ä¸€äº›å…¶ä»–æ¨¡å—ï¼ˆæ¯”å¦‚<code>Zuul</code>ï¼‰å°±å¯ä»¥é€šè¿‡ <code>Eureka Server</code> æ¥å‘ç°ç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ï¼Œå¹¶æ‰§è¡Œç›¸å…³çš„é€»è¾‘ã€‚</p><p>Eurekaç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼šEurekaæœåŠ¡å™¨å’ŒEurekaå®¢æˆ·ç«¯ã€‚EurekaæœåŠ¡å™¨ç”¨ä½œæœåŠ¡æ³¨å†ŒæœåŠ¡å™¨ã€‚Eurekaå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªjavaå®¢æˆ·ç«¯ï¼Œç”¨æ¥ç®€åŒ–ä¸æœåŠ¡å™¨çš„äº¤äº’ã€ä½œä¸ºè½®è¯¢è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶æä¾›æœåŠ¡çš„æ•…éšœåˆ‡æ¢æ”¯æŒã€‚Netflixåœ¨å…¶ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„æ˜¯å¦å¤–çš„å®¢æˆ·ç«¯ï¼Œå®ƒæä¾›åŸºäºæµé‡ã€èµ„æºåˆ©ç”¨ç‡ä»¥åŠå‡ºé”™çŠ¶æ€çš„åŠ æƒè´Ÿè½½å‡è¡¡ã€‚</p><p><strong>Eurekaçš„åŸºæœ¬æ¶æ„ï¼Œç”±3ä¸ªè§’è‰²ç»„æˆï¼š</strong></p><p>1ã€Eureka Server</p><ul><li>æä¾›æœåŠ¡æ³¨å†Œå’Œå‘ç°</li></ul><p>2ã€Service Provider</p><ul><li>æœåŠ¡æä¾›æ–¹</li><li>å°†è‡ªèº«æœåŠ¡æ³¨å†Œåˆ°Eurekaï¼Œä»è€Œä½¿æœåŠ¡æ¶ˆè´¹æ–¹èƒ½å¤Ÿæ‰¾åˆ°</li></ul><p>3ã€Service Consumer</p><ul><li>æœåŠ¡æ¶ˆè´¹æ–¹</li><li>ä»Eurekaè·å–æ³¨å†ŒæœåŠ¡åˆ—è¡¨ï¼Œä»è€Œèƒ½å¤Ÿæ¶ˆè´¹æœåŠ¡</li></ul><h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><h4 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h4><p><code>spring cloud</code>å·²ç»å¸®æˆ‘å®ç°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦å¾ˆç®€å•çš„å‡ ä¸ªæ­¥éª¤å°±å¯ä»¥å®Œæˆã€‚</p><ol><li><p>æ–°å»ºä¸€ä¸ª<code>SpringBoot</code>å·¥ç¨‹ï¼Œå–åä¸º<code>eureka-server</code>ï¼Œ<code>springboot</code>ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯<code>2.1.1.RELEASE</code></p></li><li><p>åœ¨<code>pom</code>ä¸­æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œ<code>spring-cloud</code>çš„ç‰ˆæœ¬ç”¨çš„æ˜¯<code>Finchley.RELEASE</code>ï¼Œspring-bootçš„ç‰ˆæœ¬æ˜¯<code>2.1.1.RELEASE</code>ã€‚å› æ­¤ä¾èµ–ä½¿ç”¨çš„æ˜¯<code>spring-cloud-starter-netflix-eureka-server</code>.</strong></p></li><li><p>åœ¨å¯åŠ¨ç±»ä¸­åŠ ä¸Š<code>@EnableEurekaServer</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure><ul><li><code>eureka.client.register-with-eureka</code> ï¼šè¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverï¼Œé»˜è®¤ä¸ºtrueã€‚</li><li><code>eureka.client.fetch-registry</code> ï¼šè¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚</li><li><code>eureka.client.serviceUrl.defaultZone</code> ï¼šè®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€ï¼ŒæŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€ã€‚é»˜è®¤æ˜¯<a href="http://localhost:8761/eureka">http://localhost:8761/eureka</a> ï¼›å¤šä¸ªåœ°å€å¯ä½¿ç”¨ , åˆ†éš”ã€‚</li></ul></li><li><p>å¯åŠ¨å·¥ç¨‹åï¼Œè®¿é—®ï¼š<a href="http://localhost:28081/">http://localhost:28081</a>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼Œå…¶ä¸­è¿˜æ²¡æœ‰å‘ç°ä»»ä½•æœåŠ¡ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/MMWE7h.png" alt="http://localhost:28081"></p></li></ol><h3 id="é›†ç¾¤"><a href="#é›†ç¾¤" class="headerlink" title="é›†ç¾¤"></a>é›†ç¾¤</h3><p>æ³¨å†Œä¸­å¿ƒè¿™ä¹ˆå…³é”®çš„æœåŠ¡ï¼Œå¦‚æœæ˜¯å•ç‚¹è¯ï¼Œé‡åˆ°æ•…éšœå°±æ˜¯æ¯ç­æ€§çš„ã€‚åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯æœ€é‡è¦çš„åŸºç¡€éƒ¨åˆ†ï¼Œç†åº”éšæ—¶å¤„äºå¯ä»¥æä¾›æœåŠ¡çš„çŠ¶æ€ã€‚ä¸ºäº†ç»´æŒå…¶å¯ç”¨æ€§ï¼Œä½¿ç”¨é›†ç¾¤æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚<code>Eureka</code>é€šè¿‡äº’ç›¸æ³¨å†Œçš„æ–¹å¼æ¥å®ç°é«˜å¯ç”¨çš„éƒ¨ç½²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†<code>Eureke Server</code>é…ç½®å…¶ä»–å¯ç”¨çš„<code>serviceUrl</code>å°±èƒ½å®ç°é«˜å¯ç”¨éƒ¨ç½²ã€‚</p><h4 id="ä¸‰èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒ"><a href="#ä¸‰èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="ä¸‰èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒ"></a>ä¸‰èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒ</h4><p>å°è¯•ä¸€ä¸‹ä¸‰èŠ‚ç‚¹çš„æ³¨å†Œä¸­å¿ƒçš„æ­å»ºã€‚</p><ol><li><p>ä¿®æ”¹<code>application.yml</code>æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">peer1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">peer1</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer2:28082/eureka/,http://peer3:28083/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">peer2</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer1:28081/eureka/,http://peer3:28083/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">28083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">peer3</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer3</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer2:28082/eureka/,http://peer1:28081/eureka/</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹æœ¬æœºçš„<code>hosts</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/hosts</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1 peer1 peer2 peer3</span><br></pre></td></tr></table></figure><p>ç”¨æ¥æ¨¡æ‹Ÿä¸åŒçš„ç¯å¢ƒã€‚</p></li><li><p>æ‰“å¼€<code>idea</code>çš„<code>Terminal</code>ï¼Œä¾æ¬¡æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‰“åŒ…</span></span><br><span class="line">mvn clean package  -Dmaven.test.skip=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ†åˆ«ä»¥ peer1 å’Œ peer2 é…ç½®ä¿¡æ¯å¯åŠ¨ Eureka</span></span><br><span class="line">java -jar target/eureka-server-0.0.1-SNAPSHOT.jar  --spring.profiles.active=peer1</span><br><span class="line">java -jar target/eureka-server-0.0.1-SNAPSHOT.jar  --spring.profiles.active=peer2</span><br><span class="line">java -jar target/eureka-server-0.0.1-SNAPSHOT.jar  --spring.profiles.active=peer3</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡å¯åŠ¨å®Œæˆåï¼Œè®¿é—®<a href="http://peer1:28081/">http://peer1:28081</a>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/KGkg1O.png" alt="http://localhost:28081"></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/P8zCXo.png" alt="http://localhost:28081"></p><p>åˆ°æ­¤ä¸‰èŠ‚ç‚¹çš„é…ç½®å·²ç»å®Œæˆã€‚</p></li></ol><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li>åœ¨æ­å»º <code>Eureka Server</code> é›†ç¾¤çš„æ—¶å€™ï¼Œè¦æŠŠ<code>eureka.client.register-with-eureka</code>å’Œ<code>eureka.client.fetch-registry</code>å‡æ”¹ä¸º<code>true</code>ï¼ˆé»˜è®¤ï¼‰ã€‚å¦åˆ™ä¼šå‡ºç°å®ä¾‹åˆ—è¡¨ä¸ºç©ºï¼Œä¸” <code>peer2</code> ä¸åœ¨ <code>available-replicas</code> è€Œåœ¨ <code>unavailable-replicas</code> çš„æƒ…å†µï¼ˆè¿™æ—¶å…¶å®åªæ˜¯å¯åŠ¨äº†ä¸¤ä¸ªå•ç‚¹å®ä¾‹ï¼‰ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾®æœåŠ¡çš„ä¼˜ç¼ºç‚¹</title>
      <link href="/blog/2018/12/15/ded3e7ee.html"/>
      <url>/blog/2018/12/15/ded3e7ee.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ¥è‡ªNginxå®˜æ–¹åšå®¢ï¼Œæ˜¯å¾®æœåŠ¡ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œä¸»è¦æ¢è®¨äº†ä¼ ç»Ÿçš„å•ä½“å¼åº”ç”¨çš„ä¸è¶³ï¼Œä»¥åŠå¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜ã€‚æ­£å¦‚ä½œè€…æ‰€è¯´ï¼Œå¾®æœåŠ¡æ¶æ„æ›´é€‚åˆç”¨äºæ„å»ºå¤æ‚çš„åº”ç”¨ï¼Œå°½ç®¡å®ƒä¹Ÿæœ‰è‡ªå·±çš„ä¸è¶³ã€‚</p><p>è½¬è‡ªï¼š<a href="http://dockone.io/article/394">å¾®æœåŠ¡å®æˆ˜ï¼ˆä¸€ï¼‰ï¼šå¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ä¸ä¸è¶³</a></p></blockquote><h2 id="å•ä½“å¼åº”ç”¨çš„ä¸è¶³"><a href="#å•ä½“å¼åº”ç”¨çš„ä¸è¶³" class="headerlink" title="å•ä½“å¼åº”ç”¨çš„ä¸è¶³"></a>å•ä½“å¼åº”ç”¨çš„ä¸è¶³</h2><p>å•ä½“å¼åº”ç”¨å¼€å‘ç®€å•å´æœ‰å¾ˆå¤§çš„å±€é™æ€§ã€‚ä¸€ä¸ªç®€å•çš„åº”ç”¨ä¼šéšç€æ—¶é—´æ¨ç§»é€æ¸å˜å¤§ã€‚åœ¨æ¯æ¬¡çš„<strong>sprint</strong>ä¸­ï¼Œå¼€å‘å›¢é˜Ÿéƒ½ä¼šé¢å¯¹æ–°â€œæ•…äº‹â€ï¼Œç„¶åå¼€å‘è®¸å¤šæ–°ä»£ç ã€‚å‡ å¹´åï¼Œè¿™ä¸ªå°è€Œç®€å•çš„åº”ç”¨ä¼šå˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„æ€ªç‰©ã€‚</p><p>ä¸€æ—¦ä½ çš„åº”ç”¨å˜æˆä¸€ä¸ªåˆå¤§åˆå¤æ‚çš„æ€ªç‰©ï¼Œé‚£å¼€å‘å›¢é˜Ÿè‚¯å®šå¾ˆç—›è‹¦ã€‚æ•æ·å¼€å‘å’Œéƒ¨ç½²ä¸¾æ­¥ç»´è‰°ï¼Œå…¶ä¸­æœ€ä¸»è¦é—®é¢˜å°±æ˜¯è¿™ä¸ªåº”ç”¨å¤ªå¤æ‚ï¼Œä»¥è‡³äºä»»ä½•å•ä¸ªå¼€å‘è€…éƒ½ä¸å¯èƒ½ææ‡‚å®ƒã€‚å› æ­¤ï¼Œä¿®æ­£bugå’Œæ­£ç¡®çš„æ·»åŠ æ–°åŠŸèƒ½å˜çš„éå¸¸å›°éš¾ï¼Œå¹¶ä¸”å¾ˆè€—æ—¶ã€‚å¦å¤–ï¼Œå›¢é˜Ÿå£«æ°”ä¹Ÿä¼šèµ°ä¸‹å¡è·¯ã€‚å¦‚æœä»£ç éš¾äºç†è§£ï¼Œå°±ä¸å¯èƒ½è¢«æ­£ç¡®çš„ä¿®æ”¹ã€‚æœ€ç»ˆä¼šèµ°å‘å·¨å¤§çš„ã€ä¸å¯ç†è§£çš„æ³¥æ½­ã€‚</p><p>å•ä½“å¼åº”ç”¨ä¹Ÿä¼šé™ä½å¼€å‘é€Ÿåº¦ã€‚åº”ç”¨è¶Šå¤§ï¼Œå¯åŠ¨æ—¶é—´ä¼šè¶Šé•¿ã€‚æ¯”å¦‚ï¼Œæœ€è¿‘çš„ä¸€ä¸ªè°ƒæŸ¥è¡¨æ˜ï¼Œæœ‰æ—¶å€™åº”ç”¨çš„å¯åŠ¨æ—¶é—´å±…ç„¶è¶…è¿‡äº†12åˆ†é’Ÿã€‚æˆ‘è¿˜å¬è¯´æŸäº›åº”ç”¨éœ€è¦40åˆ†é’Ÿå¯åŠ¨æ—¶é—´ã€‚å¦‚æœå¼€å‘è€…éœ€è¦ç»å¸¸é‡å¯åº”ç”¨ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†æ—¶é—´å°±è¦åœ¨ç­‰å¾…ä¸­æ¸¡è¿‡ï¼Œç”Ÿäº§æ•ˆç‡å—åˆ°æå¤§å½±å“ã€‚</p><p>å¦å¤–ï¼Œå¤æ‚è€Œå·¨å¤§çš„å•ä½“å¼åº”ç”¨ä¹Ÿä¸åˆ©äºæŒç»­æ€§å¼€å‘ã€‚ä»Šå¤©ï¼ŒSaaSåº”ç”¨å¸¸æ€å°±æ˜¯æ¯å¤©ä¼šæ”¹å˜å¾ˆå¤šæ¬¡ï¼Œè€Œè¿™å¯¹äºå•ä½“å¼åº”ç”¨æ¨¡å¼éå¸¸å›°éš¾ã€‚å¦å¤–ï¼Œè¿™ç§å˜åŒ–å¸¦æ¥çš„å½±å“å¹¶æ²¡æœ‰å¾ˆå¥½çš„è¢«ç†è§£ï¼Œæ‰€ä»¥ä¸å¾—ä¸åšå¾ˆå¤šæ‰‹å·¥æµ‹è¯•ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒæŒç»­éƒ¨ç½²ä¹Ÿä¼šå¾ˆè‰°éš¾ã€‚</p><p>å•ä½“å¼åº”ç”¨åœ¨ä¸åŒæ¨¡å—å‘ç”Ÿèµ„æºå†²çªæ—¶ï¼Œæ‰©å±•å°†ä¼šéå¸¸å›°éš¾ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å®Œæˆä¸€ä¸ªCPUæ•æ„Ÿé€»è¾‘ï¼Œåº”è¯¥éƒ¨ç½²åœ¨AWS EC2 Compute Optimized instancesï¼Œè€Œå¦å¤–ä¸€ä¸ªå†…å­˜æ•°æ®åº“æ¨¡å—æ›´åˆé€‚äºEC2 Memory-optimized instancesã€‚ç„¶è€Œï¼Œç”±äºè¿™äº›æ¨¡å—éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œå› æ­¤ä¸å¾—ä¸åœ¨ç¡¬ä»¶é€‰æ‹©ä¸Šåšä¸€ä¸ªå¦¥åã€‚</p><p>å•ä½“å¼åº”ç”¨å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯å¯é æ€§ã€‚å› ä¸ºæ‰€æœ‰æ¨¡å—éƒ½è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæ¨¡å—ä¸­çš„ä¸€ä¸ªbugï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²ï¼Œå°†ä¼šæœ‰å¯èƒ½å¼„å®æ•´ä¸ªè¿›ç¨‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå› ä¸ºæ‰€æœ‰åº”ç”¨å®ä¾‹éƒ½æ˜¯å”¯ä¸€çš„ï¼Œè¿™ä¸ªbugå°†ä¼šå½±å“åˆ°æ•´ä¸ªåº”ç”¨çš„å¯é æ€§ã€‚</p><p>æœ€åï¼Œå•ä½“å¼åº”ç”¨ä½¿å¾—é‡‡ç”¨æ–°æ¶æ„å’Œè¯­è¨€éå¸¸å›°éš¾ã€‚æ¯”å¦‚ï¼Œè®¾æƒ³ä½ æœ‰ä¸¤ç™¾ä¸‡è¡Œé‡‡ç”¨XYZæ¡†æ¶å†™çš„ä»£ç ã€‚å¦‚æœæƒ³æ”¹æˆABCæ¡†æ¶ï¼Œæ— è®ºæ˜¯æ—¶é—´è¿˜æ˜¯æˆæœ¬éƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œå³ä½¿ABCæ¡†æ¶æ›´å¥½ã€‚å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— æ³•é€¾è¶Šçš„é¸¿æ²Ÿã€‚ä½ ä¸å¾—ä¸åœ¨æœ€åˆé€‰æ‹©é¢å‰ä½å¤´ã€‚</p><p><strong>æ€»ç»“ä¸€ä¸‹ï¼š</strong>ä¸€å¼€å§‹ä½ æœ‰ä¸€ä¸ªå¾ˆæˆåŠŸçš„å…³é”®ä¸šåŠ¡åº”ç”¨ï¼Œåæ¥å°±å˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„ï¼Œæ— æ³•ç†è§£çš„æ€ªç‰©ã€‚å› ä¸ºé‡‡ç”¨è¿‡æ—¶çš„ï¼Œæ•ˆç‡ä½çš„æŠ€æœ¯ï¼Œä½¿å¾—é›‡ä½£æœ‰æ½œåŠ›çš„å¼€å‘è€…å¾ˆå›°éš¾ã€‚åº”ç”¨æ— æ³•æ‰©å±•ï¼Œå¯é æ€§å¾ˆä½ï¼Œæœ€ç»ˆï¼Œæ•æ·æ€§å¼€å‘å’Œéƒ¨ç½²å˜çš„æ— æ³•å®Œæˆã€‚</p><h2 id="å¾®å¤„ç†æ¶æ„â€”â€”å¤„ç†å¤æ‚äº‹ç‰©"><a href="#å¾®å¤„ç†æ¶æ„â€”â€”å¤„ç†å¤æ‚äº‹ç‰©" class="headerlink" title="å¾®å¤„ç†æ¶æ„â€”â€”å¤„ç†å¤æ‚äº‹ç‰©"></a>å¾®å¤„ç†æ¶æ„â€”â€”å¤„ç†å¤æ‚äº‹ç‰©</h2><p>è®¸å¤šå…¬å¸ï¼Œæ¯”å¦‚Amazonã€eBayå’ŒNetFlixï¼Œé€šè¿‡é‡‡ç”¨å¾®å¤„ç†ç»“æ„æ¨¡å¼è§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚å…¶æ€è·¯ä¸æ˜¯å¼€å‘ä¸€ä¸ªå·¨å¤§çš„å•ä½“å¼çš„åº”ç”¨ï¼Œè€Œæ˜¯å°†åº”ç”¨åˆ†è§£ä¸ºå°çš„ã€äº’ç›¸è¿æ¥çš„å¾®æœåŠ¡ã€‚</p><p>ä¸€ä¸ªå¾®æœåŠ¡ä¸€èˆ¬å®ŒæˆæŸä¸ªç‰¹å®šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸‹å•ç®¡ç†ã€å®¢æˆ·ç®¡ç†ç­‰ç­‰ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å¾®å‹å…­è§’å½¢åº”ç”¨ï¼Œéƒ½æœ‰è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å’Œé€‚é…å™¨ã€‚ä¸€äº›å¾®æœåŠ¡è¿˜ä¼šå‘å¸ƒAPIç»™å…¶å®ƒå¾®æœåŠ¡å’Œåº”ç”¨å®¢æˆ·ç«¯ä½¿ç”¨ã€‚å…¶å®ƒå¾®æœåŠ¡å®Œæˆä¸€ä¸ªWeb UIï¼Œè¿è¡Œæ—¶ï¼Œæ¯ä¸€ä¸ªå®ä¾‹å¯èƒ½æ˜¯ä¸€ä¸ªäº‘VMæˆ–è€…æ˜¯Dockerå®¹å™¨ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018/12/15/1.png"></p><p>å¾®æœåŠ¡æ¶æ„æ¨¡å¼åœ¨ä¸Šå›¾ä¸­å¯¹åº”äºä»£è¡¨å¯æ‰©å±•Scale Cubeçš„Yè½´ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨ã€ŠThe Art of Scalabilityã€‹ä¹¦ä¸­æè¿°è¿‡çš„ä¸‰ç»´æ‰©å±•æ¨¡å‹ã€‚å¦å¤–ä¸¤ä¸ªå¯æ‰©å±•è½´ï¼ŒXè½´ç”±è´Ÿè½½å‡è¡¡å™¨åç«¯è¿è¡Œçš„å¤šä¸ªåº”ç”¨å‰¯æœ¬ç»„æˆï¼ŒZè½´æ˜¯å°†éœ€æ±‚è·¯ç”±åˆ°ç›¸å…³æœåŠ¡ã€‚</p><p>åº”ç”¨åŸºæœ¬å¯ä»¥ç”¨ä»¥ä¸Šä¸‰ä¸ªç»´åº¦æ¥è¡¨ç¤ºï¼ŒYè½´ä»£è¡¨å°†åº”ç”¨åˆ†è§£ä¸ºå¾®æœåŠ¡ã€‚è¿è¡Œæ—¶ï¼ŒXè½´ä»£è¡¨è¿è¡Œå¤šä¸ªéšè—åœ¨è´Ÿè½½å‡è¡¡å™¨ä¹‹åçš„å®ä¾‹ï¼Œæä¾›ååèƒ½åŠ›ã€‚ä¸€äº›åº”ç”¨å¯èƒ½è¿˜æ˜¯ç”¨Zè½´å°†æœåŠ¡åˆ†åŒºã€‚ä¸‹é¢çš„å›¾æ¼”ç¤ºè¡Œç¨‹ç®¡ç†æœåŠ¡å¦‚ä½•éƒ¨ç½²åœ¨è¿è¡ŒäºAWS EC2ä¸Šçš„Dockerä¸Šã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018/12/15/2.png"></p><p>è¿è¡Œæ—¶ï¼Œè¡Œç¨‹ç®¡ç†æœåŠ¡ç”±å¤šä¸ªæœåŠ¡å®ä¾‹æ„æˆã€‚æ¯ä¸€ä¸ªæœåŠ¡å®ä¾‹éƒ½æ˜¯ä¸€ä¸ªDockerå®¹å™¨ã€‚ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œè¿™äº›å®¹å™¨ä¸€èˆ¬éƒ½è¿è¡Œåœ¨å¤šä¸ªäº‘VMä¸Šã€‚æœåŠ¡å®ä¾‹å‰æ˜¯ä¸€å±‚è¯¸å¦‚NGINXçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä»–ä»¬è´Ÿè´£åœ¨å„ä¸ªå®ä¾‹é—´åˆ†å‘è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡å™¨ä¹ŸåŒæ—¶å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œä¾‹å¦‚ç¼“å­˜ã€æƒé™æ§åˆ¶ã€APIç»Ÿè®¡å’Œç›‘æ§ã€‚</p><p>è¿™ç§å¾®æœåŠ¡æ¶æ„æ¨¡å¼æ·±åˆ»å½±å“äº†åº”ç”¨å’Œæ•°æ®åº“ä¹‹é—´çš„å…³ç³»ï¼Œ<strong>ä¸åƒä¼ ç»Ÿå¤šä¸ªæœåŠ¡å…±äº«ä¸€ä¸ªæ•°æ®åº“ï¼Œå¾®æœåŠ¡æ¶æ„æ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“</strong>ã€‚å¦å¤–ï¼Œè¿™ç§æ€è·¯ä¹Ÿå½±å“åˆ°äº†ä¼ä¸šçº§æ•°æ®æ¨¡å¼ã€‚åŒæ—¶ï¼Œè¿™ç§æ¨¡å¼æ„å‘³ç€å¤šä»½æ•°æ®ï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³è·å¾—å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼Œæ¯ä¸ªæœåŠ¡ç‹¬æœ‰ä¸€ä¸ªæ•°æ®åº“æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºè¿™ç§æ¶æ„éœ€è¦è¿™ç§æ¾è€¦åˆã€‚ä¸‹é¢çš„å›¾æ¼”ç¤ºç¤ºä¾‹åº”ç”¨æ•°æ®åº“æ¶æ„ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018/12/15/3.png"></p><p>æ¯ç§æœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œå¦å¤–ï¼Œæ¯ç§æœåŠ¡å¯ä»¥ç”¨æ›´é€‚åˆè‡ªå·±çš„æ•°æ®åº“ç±»å‹ï¼Œä¹Ÿè¢«ç§°ä½œå¤šè¯­è¨€ä¸€è‡´æ€§æ¶æ„ã€‚æ¯”å¦‚ï¼Œé©¾é©¶å‘˜ç®¡ç†ï¼ˆå‘ç°å“ªä¸ªé©¾é©¶å‘˜æ›´é è¿‘ä¹˜å®¢ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨æ”¯æŒåœ°ç†ä¿¡æ¯æŸ¥è¯¢çš„æ•°æ®åº“ã€‚</p><p>è¡¨é¢ä¸Šçœ‹æ¥ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æœ‰ç‚¹åƒSOAï¼Œä»–ä»¬éƒ½ç”±å¤šä¸ªæœåŠ¡æ„æˆã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä»å¦å¤–ä¸€ä¸ªè§’åº¦çœ‹æ­¤é—®é¢˜ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æ˜¯ä¸€ä¸ªä¸åŒ…å«WebæœåŠ¡ï¼ˆWS-ï¼‰å’ŒESBæœåŠ¡çš„SOAã€‚å¾®æœåŠ¡åº”ç”¨ä¹äºé‡‡ç”¨ç®€å•è½»é‡çº§åè®®ï¼Œæ¯”å¦‚RESTï¼Œè€Œä¸æ˜¯WS-ï¼Œåœ¨å¾®æœåŠ¡å†…éƒ¨é¿å…ä½¿ç”¨ESBä»¥åŠESBç±»ä¼¼åŠŸèƒ½ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ä¹Ÿæ‹’ç»ä½¿ç”¨canonical schemaç­‰SOAæ¦‚å¿µã€‚</p><h2 id="å¾®æœåŠ¡çš„å¥½å¤„"><a href="#å¾®æœåŠ¡çš„å¥½å¤„" class="headerlink" title="å¾®æœåŠ¡çš„å¥½å¤„"></a>å¾®æœåŠ¡çš„å¥½å¤„</h2><p>å¾®æœåŠ¡æ¶æ„æ¨¡å¼æœ‰å¾ˆå¤šå¥½å¤„ã€‚é¦–å…ˆï¼Œé€šè¿‡åˆ†è§£å·¨å¤§å•ä½“å¼åº”ç”¨ä¸ºå¤šä¸ªæœåŠ¡æ–¹æ³•è§£å†³äº†å¤æ‚æ€§é—®é¢˜ã€‚åœ¨åŠŸèƒ½ä¸å˜çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨è¢«åˆ†è§£ä¸ºå¤šä¸ªå¯ç®¡ç†çš„åˆ†æ”¯æˆ–æœåŠ¡ã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªç”¨RPC-æˆ–è€…æ¶ˆæ¯é©±åŠ¨APIå®šä¹‰æ¸…æ¥šçš„è¾¹ç•Œã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ç»™é‡‡ç”¨å•ä½“å¼ç¼–ç æ–¹å¼å¾ˆéš¾å®ç°çš„åŠŸèƒ½æä¾›äº†æ¨¡å—åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œç”±æ­¤ï¼Œå•ä¸ªæœåŠ¡å¾ˆå®¹æ˜“å¼€å‘ã€ç†è§£å’Œç»´æŠ¤ã€‚</p><p>ç¬¬äºŒï¼Œè¿™ç§æ¶æ„ä½¿å¾—æ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥æœ‰ä¸“é—¨å¼€å‘å›¢é˜Ÿæ¥å¼€å‘ã€‚å¼€å‘è€…å¯ä»¥è‡ªç”±é€‰æ‹©å¼€å‘æŠ€æœ¯ï¼Œæä¾›APIæœåŠ¡ã€‚å½“ç„¶ï¼Œè®¸å¤šå…¬å¸è¯•å›¾é¿å…æ··ä¹±ï¼Œåªæä¾›æŸäº›æŠ€æœ¯é€‰æ‹©ã€‚ç„¶åï¼Œè¿™ç§è‡ªç”±æ„å‘³ç€å¼€å‘è€…ä¸éœ€è¦è¢«è¿«ä½¿ç”¨æŸé¡¹ç›®å¼€å§‹æ—¶é‡‡ç”¨çš„è¿‡æ—¶æŠ€æœ¯ï¼Œä»–ä»¬å¯ä»¥é€‰æ‹©ç°åœ¨çš„æŠ€æœ¯ã€‚ç”šè‡³äºï¼Œå› ä¸ºæœåŠ¡éƒ½æ˜¯ç›¸å¯¹ç®€å•ï¼Œå³ä½¿ç”¨ç°åœ¨æŠ€æœ¯é‡å†™ä»¥å‰ä»£ç ä¹Ÿä¸æ˜¯å¾ˆå›°éš¾çš„äº‹æƒ…ã€‚</p><p>ç¬¬ä¸‰ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æ˜¯æ¯ä¸ªå¾®æœåŠ¡ç‹¬ç«‹çš„éƒ¨ç½²ã€‚å¼€å‘è€…ä¸å†éœ€è¦åè°ƒå…¶å®ƒæœåŠ¡éƒ¨ç½²å¯¹æœ¬æœåŠ¡çš„å½±å“ã€‚è¿™ç§æ”¹å˜å¯ä»¥åŠ å¿«éƒ¨ç½²é€Ÿåº¦ã€‚UIå›¢é˜Ÿå¯ä»¥é‡‡ç”¨ABæµ‹è¯•ï¼Œå¿«é€Ÿçš„éƒ¨ç½²å˜åŒ–ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æŒç»­åŒ–éƒ¨ç½²æˆä¸ºå¯èƒ½ã€‚</p><p>æœ€åï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ‰©å±•ã€‚ä½ å¯ä»¥æ ¹æ®æ¯ä¸ªæœåŠ¡çš„è§„æ¨¡æ¥éƒ¨ç½²æ»¡è¶³éœ€æ±‚çš„è§„æ¨¡ã€‚ç”šè‡³äºï¼Œä½ å¯ä»¥ä½¿ç”¨æ›´é€‚åˆäºæœåŠ¡èµ„æºéœ€æ±‚çš„ç¡¬ä»¶ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨EC2 Compute Optimized instancesä¸Šéƒ¨ç½²CPUæ•æ„Ÿçš„æœåŠ¡ï¼Œè€Œåœ¨EC2 memory-optimized instancesä¸Šéƒ¨ç½²å†…å­˜æ•°æ®åº“ã€‚</p><h2 id="å¾®æœåŠ¡çš„ä¸è¶³"><a href="#å¾®æœåŠ¡çš„ä¸è¶³" class="headerlink" title="å¾®æœåŠ¡çš„ä¸è¶³"></a>å¾®æœåŠ¡çš„ä¸è¶³</h2><p>Fred Brooksåœ¨30å¹´å‰å†™é“ï¼Œâ€œthere are no silver bulletsâ€ï¼Œåƒä»»ä½•å…¶å®ƒç§‘æŠ€ä¸€æ ·ï¼Œå¾®æœåŠ¡æ¶æ„ä¹Ÿæœ‰ä¸è¶³ã€‚å…¶ä¸­ä¸€ä¸ªè·Ÿä»–çš„åå­—ç±»ä¼¼ï¼Œã€å¾®æœåŠ¡ã€å¼ºè°ƒäº†æœåŠ¡å¤§å°ï¼Œå®é™…ä¸Šï¼Œæœ‰ä¸€äº›å¼€å‘è€…é¼“å¹å»ºç«‹ç¨å¾®å¤§ä¸€äº›çš„ï¼Œ10-100 LOCæœåŠ¡ç»„ã€‚å°½ç®¡å°æœåŠ¡æ›´ä¹äºè¢«é‡‡ç”¨ï¼Œä½†æ˜¯ä¸è¦å¿˜äº†è¿™åªæ˜¯ç»ˆç«¯çš„é€‰æ‹©è€Œä¸æ˜¯æœ€ç»ˆçš„ç›®çš„ã€‚å¾®æœåŠ¡çš„ç›®çš„æ˜¯æœ‰æ•ˆçš„æ‹†åˆ†åº”ç”¨ï¼Œå®ç°æ•æ·å¼€å‘å’Œéƒ¨ç½²ã€‚</p><p>å¦å¤–ä¸€ä¸ªä¸»è¦çš„ä¸è¶³æ˜¯ï¼Œå¾®æœåŠ¡åº”ç”¨æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”±æ­¤ä¼šå¸¦æ¥å›ºæœ‰çš„å¤æ‚æ€§ã€‚å¼€å‘è€…éœ€è¦åœ¨RPCæˆ–è€…æ¶ˆæ¯ä¼ é€’ä¹‹é—´é€‰æ‹©å¹¶å®Œæˆè¿›ç¨‹é—´é€šè®¯æœºåˆ¶ã€‚æ›´ç”šäºï¼Œä»–ä»¬å¿…é¡»å†™ä»£ç æ¥å¤„ç†æ¶ˆæ¯ä¼ é€’ä¸­é€Ÿåº¦è¿‡æ…¢æˆ–è€…ä¸å¯ç”¨ç­‰å±€éƒ¨å¤±æ•ˆé—®é¢˜ã€‚å½“ç„¶è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼Œä½†ç›¸å¯¹äºå•ä½“å¼åº”ç”¨ä¸­é€šè¿‡è¯­è¨€å±‚çº§çš„æ–¹æ³•æˆ–è€…è¿›ç¨‹è°ƒç”¨ï¼Œå¾®æœåŠ¡ä¸‹è¿™ç§æŠ€æœ¯æ˜¾å¾—æ›´å¤æ‚ä¸€äº›ã€‚</p><p>å¦å¤–ä¸€ä¸ªå…³äºå¾®æœåŠ¡çš„æŒ‘æˆ˜æ¥è‡ªäºåˆ†åŒºçš„æ•°æ®åº“æ¶æ„ã€‚å•†ä¸šäº¤æ˜“ä¸­åŒæ—¶ç»™å¤šä¸ªä¸šåŠ¡åˆ†ä¸»ä½“æ›´æ–°æ¶ˆæ¯å¾ˆæ™®éã€‚è¿™ç§äº¤æ˜“å¯¹äºå•ä½“å¼åº”ç”¨æ¥è¯´å¾ˆå®¹æ˜“ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªæ•°æ®åº“ã€‚åœ¨å¾®æœåŠ¡æ¶æ„åº”ç”¨ä¸­ï¼Œéœ€è¦æ›´æ–°ä¸åŒæœåŠ¡æ‰€ä½¿ç”¨çš„ä¸åŒçš„æ•°æ®åº“ã€‚ä½¿ç”¨åˆ†å¸ƒå¼äº¤æ˜“å¹¶ä¸ä¸€å®šæ˜¯å¥½çš„é€‰æ‹©ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºCAPç†è®ºï¼Œè¿˜å› ä¸ºä»Šå¤©é«˜æ‰©å±•æ€§çš„NoSQLæ•°æ®åº“å’Œæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶å¹¶ä¸æ”¯æŒè¿™ä¸€éœ€æ±‚ã€‚æœ€ç»ˆä½ ä¸å¾—ä¸ä½¿ç”¨ä¸€ä¸ªæœ€ç»ˆä¸€è‡´æ€§çš„æ–¹æ³•ï¼Œä»è€Œå¯¹å¼€å‘è€…æå‡ºäº†æ›´é«˜çš„è¦æ±‚å’ŒæŒ‘æˆ˜ã€‚</p><p>æµ‹è¯•ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„åº”ç”¨ä¹Ÿæ˜¯å¾ˆå¤æ‚çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼Œé‡‡ç”¨æµè¡Œçš„Spring Bootæ¶æ„ï¼Œå¯¹ä¸€ä¸ªå•ä½“å¼webåº”ç”¨ï¼Œæµ‹è¯•å®ƒçš„REST APIï¼Œæ˜¯å¾ˆå®¹æ˜“çš„äº‹æƒ…ã€‚åè¿‡æ¥ï¼ŒåŒæ ·çš„æœåŠ¡æµ‹è¯•éœ€è¦å¯åŠ¨å’Œå®ƒæœ‰å…³çš„æ‰€æœ‰æœåŠ¡ï¼ˆè‡³å°‘éœ€è¦è¿™äº›æœåŠ¡çš„stubsï¼‰ã€‚å†é‡ç”³ä¸€æ¬¡ï¼Œä¸èƒ½ä½ä¼°äº†é‡‡ç”¨å¾®æœåŠ¡æ¶æ„å¸¦æ¥çš„å¤æ‚æ€§ã€‚</p><p>å¦å¤–ä¸€ä¸ªæŒ‘æˆ˜åœ¨äºï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼åº”ç”¨çš„æ”¹å˜å°†ä¼šæ³¢åŠå¤šä¸ªæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå‡è®¾ä½ åœ¨å®Œæˆä¸€ä¸ªæ¡ˆä¾‹ï¼Œéœ€è¦ä¿®æ”¹æœåŠ¡Aã€Bã€Cï¼Œè€ŒAä¾èµ–Bï¼ŒBä¾èµ–Cã€‚åœ¨å•ä½“å¼åº”ç”¨ä¸­ï¼Œä½ åªéœ€è¦æ”¹å˜ç›¸å…³æ¨¡å—ï¼Œæ•´åˆå˜åŒ–ï¼Œéƒ¨ç½²å°±å¥½äº†ã€‚å¯¹æ¯”ä¹‹ä¸‹ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼å°±éœ€è¦è€ƒè™‘ç›¸å…³æ”¹å˜å¯¹ä¸åŒæœåŠ¡çš„å½±å“ã€‚æ¯”å¦‚ï¼Œä½ éœ€è¦æ›´æ–°æœåŠ¡Cï¼Œç„¶åæ˜¯Bï¼Œæœ€åæ‰æ˜¯Aï¼Œå¹¸è¿çš„æ˜¯ï¼Œè®¸å¤šæ”¹å˜ä¸€èˆ¬åªå½±å“ä¸€ä¸ªæœåŠ¡ï¼Œè€Œéœ€è¦åè°ƒå¤šæœåŠ¡çš„æ”¹å˜å¾ˆå°‘ã€‚</p><p>éƒ¨ç½²ä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨ä¹Ÿå¾ˆå¤æ‚ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨åªéœ€è¦ç®€å•åœ¨å¤æ‚å‡è¡¡å™¨åé¢éƒ¨ç½²å„è‡ªçš„æœåŠ¡å™¨å°±å¥½äº†ã€‚æ¯ä¸ªåº”ç”¨å®ä¾‹æ˜¯éœ€è¦é…ç½®è¯¸å¦‚æ•°æ®åº“å’Œæ¶ˆæ¯ä¸­é—´ä»¶ç­‰åŸºç¡€æœåŠ¡ã€‚ç›¸å¯¹æ¯”ï¼Œä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨ä¸€èˆ¬ç”±å¤§æ‰¹æœåŠ¡æ„æˆã€‚ä¾‹å¦‚ï¼Œæ ¹æ®Adrian Cockcroftï¼Œ<a href="https://sudo.hailoapp.com/services/2015/03/09/journey-into-a-microservice-world-part-3/">Hailoæœ‰160ä¸ªä¸åŒæœåŠ¡æ„æˆ</a>ï¼ŒNetFlixæœ‰å¤§çº¦600ä¸ªæœåŠ¡ã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰å¤šä¸ªå®ä¾‹ã€‚è¿™å°±é€ æˆè®¸å¤šéœ€è¦é…ç½®ã€éƒ¨ç½²ã€æ‰©å±•å’Œç›‘æ§çš„éƒ¨åˆ†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜éœ€è¦å®Œæˆä¸€ä¸ªæœåŠ¡å‘ç°æœºåˆ¶ï¼ˆåç»­æ–‡ç« ä¸­å‘è¡¨ï¼‰ï¼Œä»¥ç”¨æ¥å‘ç°ä¸å®ƒé€šè®¯æœåŠ¡çš„åœ°å€ï¼ˆåŒ…æ‹¬æœåŠ¡å™¨åœ°å€å’Œç«¯å£ï¼‰ã€‚ä¼ ç»Ÿçš„è§£å†³é—®é¢˜åŠæ³•ä¸èƒ½ç”¨äºè§£å†³è¿™ä¹ˆå¤æ‚çš„é—®é¢˜ã€‚æ¥ç»­è€Œæ¥ï¼ŒæˆåŠŸéƒ¨ç½²ä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨éœ€è¦å¼€å‘è€…æœ‰è¶³å¤Ÿçš„æ§åˆ¶éƒ¨ç½²æ–¹æ³•ï¼Œå¹¶é«˜åº¦è‡ªåŠ¨åŒ–ã€‚</p><p>ä¸€ç§è‡ªåŠ¨åŒ–æ–¹æ³•æ˜¯ä½¿ç”¨PaaSæœåŠ¡ï¼Œä¾‹å¦‚<a href="http://www.cloudfoundry.org/">Cloud Foundry</a>ã€‚PaaSç»™å¼€å‘è€…æä¾›ä¸€ä¸ªéƒ¨ç½²å’Œç®¡ç†å¾®æœåŠ¡çš„ç®€å•æ–¹æ³•ï¼Œå®ƒæŠŠæ‰€æœ‰è¿™äº›é—®é¢˜éƒ½æ‰“åŒ…å†…ç½®è§£å†³äº†ã€‚åŒæ—¶ï¼Œé…ç½®PaaSçš„ç³»ç»Ÿå’Œç½‘ç»œä¸“å®¶å¯ä»¥é‡‡ç”¨æœ€ä½³å®è·µå’Œç­–ç•¥æ¥ç®€åŒ–è¿™äº›é—®é¢˜ã€‚å¦å¤–ä¸€ä¸ªè‡ªåŠ¨éƒ¨ç½²å¾®æœåŠ¡åº”ç”¨çš„æ–¹æ³•æ˜¯å¼€å‘å¯¹äºä½ æ¥è¯´æœ€åŸºç¡€çš„PaaSç³»ç»Ÿã€‚ä¸€ä¸ªå…¸å‹çš„å¼€å§‹ç‚¹æ˜¯ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤åŒ–æ–¹æ¡ˆï¼Œæ¯”å¦‚é…åˆDockerä½¿ç”¨Mesosæˆ–è€…Kubernetesã€‚åé¢çš„ç³»åˆ—æˆ‘ä»¬ä¼šçœ‹çœ‹å¦‚ä½•åŸºäºè½¯ä»¶éƒ¨ç½²æ–¹æ³•ä¾‹å¦‚NGINXï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨å¾®æœåŠ¡å±‚é¢æä¾›ç¼“å­˜ã€æƒé™æ§åˆ¶ã€APIç»Ÿè®¡å’Œç›‘æ§ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ„å»ºå¤æ‚çš„åº”ç”¨çœŸçš„æ˜¯éå¸¸å›°éš¾ã€‚å•ä½“å¼çš„æ¶æ„æ›´é€‚åˆè½»é‡çº§çš„ç®€å•åº”ç”¨ã€‚å¦‚æœä½ ç”¨å®ƒæ¥å¼€å‘å¤æ‚åº”ç”¨ï¼Œé‚£çœŸçš„ä¼šå¾ˆç³Ÿç³•ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼å¯ä»¥ç”¨æ¥æ„å»ºå¤æ‚åº”ç”¨ï¼Œå½“ç„¶ï¼Œè¿™ç§æ¶æ„æ¨¡å‹ä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹å’ŒæŒ‘æˆ˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¾®æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloudä¸­çš„åè¯è§£é‡Š</title>
      <link href="/blog/2018/12/02/60e9e95d.html"/>
      <url>/blog/2018/12/02/60e9e95d.html</url>
      
        <content type="html"><![CDATA[<h2 id="å¾®æœåŠ¡"><a href="#å¾®æœåŠ¡" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h2><p>è¿‘å¹´æ¥ï¼Œåœ¨è½¯ä»¶å¼€å‘é¢†åŸŸå…³äºå¾®æœåŠ¡çš„è®¨è®ºå‘ˆç°å‡ºç«çˆ†çš„å±€é¢ï¼Œæœ‰äººå€¾å‘äºåœ¨ç³»ç»Ÿè®¾è®¡ä¸å¼€å‘ä¸­é‡‡ç”¨å¾®æœåŠ¡æ–¹å¼å®ç°è½¯ä»¶ç³»ç»Ÿçš„æ¾è€¦åˆã€è·¨éƒ¨é—¨å¼€å‘ï¼Œè¢«è®¤ä¸ºæ˜¯ITè½¯ä»¶æ¶æ„çš„æœªæ¥æ–¹å‘ï¼ŒMartin Fowlerä¹Ÿç»™å¾®æœåŠ¡æ¶æ„æé«˜çš„è¯„ä»·ï¼›åŒæ—¶ï¼Œåå¯¹ä¹‹å£°ä¹Ÿå¾ˆå¼ºçƒˆï¼ŒæŒåå¯¹è§‚ç‚¹çš„äººè¡¨ç¤ºå¾®æœåŠ¡å¢åŠ äº†ç³»ç»Ÿç»´æŠ¤ã€éƒ¨ç½²çš„éš¾åº¦ï¼Œå¯¼è‡´ä¸€äº›åŠŸèƒ½æ¨¡å—æˆ–ä»£ç æ— æ³•å¤ç”¨ï¼ŒåŒæ—¶å¾®æœåŠ¡å…è®¸ä½¿ç”¨ä¸åŒçš„è¯­è¨€å’Œæ¡†æ¶æ¥å¼€å‘å„ä¸ªç³»ç»Ÿæ¨¡å—ï¼Œè¿™åˆä¼šå¢åŠ ç³»ç»Ÿé›†æˆä¸æµ‹è¯•çš„éš¾åº¦ï¼Œè€Œä¸”éšç€ç³»ç»Ÿè§„æ¨¡çš„æ—¥æ¸å¢é•¿ï¼Œå¾®æœåŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿä¼šå¯¼è‡´ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚å°½ç®¡ä¸€äº›å…¬å¸å·²ç»åœ¨ç”Ÿäº§ç³»ç»Ÿä¸­é‡‡ç”¨äº†å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶ä¸”å–å¾—äº†è‰¯å¥½çš„æ•ˆæœï¼›ä½†æ›´å¤šå…¬å¸è¿˜æ˜¯å¤„åœ¨è§‚æœ›çš„æ€åº¦ã€‚</p><p>ä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ¶æ„å‘¢ï¼Ÿç®€å•è¯´å°±æ˜¯å°†ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ï¼ˆå•ä½“åº”ç”¨ï¼‰æŒ‰ç…§ä¸€å®šçš„æ‹†åˆ†è§„åˆ™ï¼ˆåæ–‡è®²è¿°ï¼‰æ‹†åˆ†æˆå¤šä¸ªä¸åŒçš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½èƒ½ç‹¬ç«‹åœ°è¿›è¡Œå¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•ã€‚æœåŠ¡äºæœåŠ¡ä¹‹é—´é€šè¿‡æ³¨å…¥RESTful apiæˆ–å…¶ä»–æ–¹å¼è°ƒç”¨ã€‚</p><h3 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h3><p>ç‰ˆæœ¬å·åŒ…å« è‹±æ–‡å•è¯ï¼ˆrelease trainï¼‰ + SRXï¼ˆservice releaseï¼‰ï¼ˆXï¼šæ•°å­—ï¼‰</p><ul><li>release trainï¼šæŒ‰ä¼¦æ•¦åœ°é“ç«™åA-Zè¿›è¡Œé¦–å­—æ¯è¿­ä»£æ’åº</li><li>SRï¼šä¸€èˆ¬è¡¨ç¤ºå½“å‰ä¿®å¤BUGçš„ç‰ˆæœ¬ç¼–å·<br> ä¾‹ï¼šCamden SR4ã€Camden SR5ã€Dalston SR1<br> è€Œå¤§å¤šæ•°Springé¡¹ç›®éƒ½ä»¥â€œä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.å¢é‡ç‰ˆæœ¬å·.é‡Œç¨‹ç¢‘ç‰ˆæœ¬å·â€çš„å½¢å¼å‘½åç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ Spring Framework ç¨³å®šç‰ˆæœ¬ 4.3.5.RELEASEã€é‡Œç¨‹ç¢‘ç‰ˆæœ¬ 5.0.0.M4 ç­‰ã€‚</li></ul><h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><p>Spring Cloudæ˜¯åœ¨Spring Bootçš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œç”¨äºç®€åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿæ„å»ºçš„å·¥å…·é›†ï¼Œä¸ºå¼€å‘äººå‘˜æä¾›å¿«é€Ÿå»ºç«‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€äº›å¸¸è§çš„æ¨¡å¼ã€‚</p><blockquote><p>ä¾‹å¦‚ï¼šé…ç½®ç®¡ç†ï¼ˆconfiguration managementï¼‰ï¼ŒæœåŠ¡å‘ç°ï¼ˆservice discoveryï¼‰ï¼Œæ–­è·¯å™¨ï¼ˆcircuit breakersï¼‰ï¼Œæ™ºèƒ½è·¯ç”±ï¼ˆ intelligent routingï¼‰ï¼Œå¾®ä»£ç†ï¼ˆmicro-proxyï¼‰ï¼Œæ§åˆ¶æ€»çº¿ï¼ˆcontrol busï¼‰ï¼Œä¸€æ¬¡æ€§ä»¤ç‰Œï¼ˆ one-time tokensï¼‰ï¼Œå…¨å±€é”ï¼ˆglobal locksï¼‰ï¼Œé¢†å¯¼é€‰ä¸¾ï¼ˆleadership electionï¼‰ï¼Œåˆ†å¸ƒå¼ä¼šè¯ï¼ˆdistributed sessionsï¼‰ï¼Œé›†ç¾¤çŠ¶æ€ï¼ˆcluster stateï¼‰ã€‚</p></blockquote><p>Spring Cloud åŒ…å«äº†å¤šä¸ªå­é¡¹ç›®ï¼š</p><blockquote><p>ä¾‹å¦‚ï¼šSpring Cloud Configã€Spring Cloud Netflixç­‰</p></blockquote><p>Spring Cloud é¡¹ç›®ä¸»é¡µï¼š<a href="http://projects.spring.io/spring-cloud/">http://projects.spring.io/spring-cloud/</a></p><h2 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰æ˜¯å…³é”®åŸåˆ™ä¹‹ä¸€ã€‚æ‰‹åŠ¨é…ç½®æ¯ä¸ªå®¢æˆ·ç«¯æˆ–æŸç§å½¢å¼çš„çº¦å®šæ˜¯å¾ˆéš¾åšçš„ï¼Œå¹¶ä¸”å¾ˆè„†å¼±ã€‚Spring Cloudæä¾›äº†å¤šç§æœåŠ¡å‘ç°çš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚ï¼šEurekaã€Consulã€Zookeeperã€‚</p><h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><p><strong>Eurekaæ˜¯</strong>Netflixå¼€å‘çš„æœåŠ¡å‘ç°ç»„ä»¶ï¼Œæœ¬èº«<strong>æ˜¯</strong>ä¸€ä¸ªåŸºäºRESTçš„æœåŠ¡ã€‚ Spring Cloudå°†å®ƒé›†æˆåœ¨å…¶å­é¡¹ç›®spring-cloud-netflixä¸­ï¼Œä»¥å®ç°Spring Cloudçš„æœåŠ¡å‘ç°åŠŸèƒ½ã€‚</p><h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><p>Consul æ˜¯ HashiCorp å…¬å¸æ¨å‡ºçš„å¼€æºå·¥å…·ï¼Œç”¨äºå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœåŠ¡å‘ç°ä¸é…ç½®ã€‚ä¸å…¶ä»–åˆ†å¸ƒå¼æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ–¹æ¡ˆï¼ŒConsulçš„æ–¹æ¡ˆæ›´â€œä¸€ç«™å¼â€ï¼Œå†…ç½®äº†æœåŠ¡æ³¨å†Œä¸å‘ç°æ¡† æ¶ã€åˆ†å¸ƒä¸€è‡´æ€§åè®®å®ç°ã€å¥åº·æ£€æŸ¥ã€Key/Valueå­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒæ–¹æ¡ˆï¼Œä¸å†éœ€è¦ä¾èµ–å…¶ä»–å·¥å…·ï¼ˆæ¯”å¦‚ZooKeeperç­‰ï¼‰ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒ ä¸ºç®€å•ã€‚Consulä½¿ç”¨Goè¯­è¨€ç¼–å†™ï¼Œå› æ­¤å…·æœ‰å¤©ç„¶å¯ç§»æ¤æ€§(æ”¯æŒLinuxã€windowså’ŒMac OS X)ï¼›å®‰è£…åŒ…ä»…åŒ…å«ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–¹ä¾¿éƒ¨ç½²ï¼Œä¸Dockerç­‰è½»é‡çº§å®¹å™¨å¯æ— ç¼é…åˆ ã€‚</p><h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><p>Ribbonæ˜¯Netflixå‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå°†Netflixçš„ä¸­é—´å±‚æœåŠ¡è¿æ¥åœ¨ä¸€èµ·ã€‚Ribbonå®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ—å‡ºLoad Balanceråé¢æ‰€æœ‰çš„æœºå™¨ï¼ŒRibbonä¼šè‡ªåŠ¨çš„å¸®åŠ©ä½ åŸºäºæŸç§è§„åˆ™ï¼ˆå¦‚ç®€å•è½®è¯¢ï¼Œéšæœºè¿æ¥ç­‰ï¼‰å»è¿æ¥è¿™äº›æœºå™¨ã€‚æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨Ribbonå®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚ç®€å•åœ°è¯´ï¼ŒRibbonæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ã€‚</p><p>Ribbonå·¥ä½œæ—¶åˆ†ä¸ºä¸¤æ­¥ï¼šç¬¬ä¸€æ­¥å…ˆé€‰æ‹© Eureka Server, å®ƒä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªZoneä¸”è´Ÿè½½è¾ƒå°‘çš„Serverï¼›ç¬¬äºŒæ­¥å†æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œåœ¨ä»Serverå–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚å…¶ä¸­Ribbonæä¾›äº†å¤šç§ç­–ç•¥ï¼Œä¾‹å¦‚è½®è¯¢ã€éšæœºã€æ ¹æ®å“åº”æ—¶é—´åŠ æƒç­‰ã€‚</p><h2 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h2><p>Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„web serviceå®¢æˆ·ç«¯ï¼Œå®ƒä½¿å¾—ç¼–å†™web serviceå®¢æˆ·ç«¯æ›´ä¸ºå®¹æ˜“ã€‚åˆ›å»ºæ¥å£ï¼Œä¸ºæ¥å£æ·»åŠ æ³¨è§£ï¼Œå³å¯ä½¿ç”¨Feignã€‚Feignå¯ä»¥ä½¿ç”¨Feignæ³¨è§£æˆ–è€…JAX-RSæ³¨è§£ï¼Œè¿˜æ”¯æŒçƒ­æ’æ‹”çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚Spring Cloudä¸ºFeignæ·»åŠ äº†Spring MVCçš„æ³¨è§£æ”¯æŒï¼Œå¹¶æ•´åˆäº†Ribbonå’ŒEurekaæ¥ä¸ºä½¿ç”¨Feignæ—¶æä¾›è´Ÿè½½å‡è¡¡ã€‚</p><h2 id="ç†”æ–­å™¨"><a href="#ç†”æ–­å™¨" class="headerlink" title="ç†”æ–­å™¨"></a>ç†”æ–­å™¨</h2><h3 id="é›ªå´©æ•ˆåº”"><a href="#é›ªå´©æ•ˆåº”" class="headerlink" title="é›ªå´©æ•ˆåº”"></a>é›ªå´©æ•ˆåº”</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­é€šå¸¸ä¼šæœ‰å¤šä¸ªæœåŠ¡å±‚è°ƒç”¨ï¼ŒåŸºç¡€æœåŠ¡çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœï¼Œè¿›è€Œé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”ã€‚æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å› â€œæœåŠ¡æä¾›è€…â€çš„ä¸å¯ç”¨å¯¼è‡´â€œæœåŠ¡æ¶ˆè´¹è€…â€çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§çš„è¿‡ç¨‹ã€‚</p><p>å¦‚æœä¸‹å›¾æ‰€ç¤ºï¼šAä½œä¸ºæœåŠ¡æä¾›è€…ï¼ŒBä¸ºAçš„æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCå’ŒDæ˜¯Bçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚Aä¸å¯ç”¨å¼•èµ·äº†Bçš„ä¸å¯ç”¨ï¼Œå¹¶å°†ä¸å¯ç”¨åƒæ»šé›ªçƒä¸€æ ·æ”¾å¤§åˆ°Cå’ŒDæ—¶ï¼Œé›ªå´©æ•ˆåº”å°±å½¢æˆäº†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/YmtntU.png" alt="é›ªå´©æ•ˆåº”"></p><h3 id="ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰"><a href="#ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰" class="headerlink" title="ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰"></a>ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰</h3><p>ç†”æ–­å™¨çš„åŸç†å¾ˆç®€å•ï¼Œå¦‚åŒç”µåŠ›è¿‡è½½ä¿æŠ¤å™¨ã€‚å®ƒå¯ä»¥å®ç°å¿«é€Ÿå¤±è´¥ï¼Œå¦‚æœå®ƒåœ¨ä¸€æ®µæ—¶é—´å†…ä¾¦æµ‹åˆ°è®¸å¤šç±»ä¼¼çš„é”™è¯¯ï¼Œä¼šå¼ºè¿«å…¶ä»¥åçš„å¤šä¸ªè°ƒç”¨å¿«é€Ÿå¤±è´¥ï¼Œä¸å†è®¿é—®è¿œç¨‹æœåŠ¡å™¨ï¼Œä»è€Œé˜²æ­¢åº”ç”¨ç¨‹åºä¸æ–­åœ°å°è¯•æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œï¼Œä½¿å¾—åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œè€Œä¸ç”¨ç­‰å¾…ä¿®æ­£é”™è¯¯ï¼Œæˆ–è€…æµªè´¹CPUæ—¶é—´å»ç­‰åˆ°é•¿æ—¶é—´çš„è¶…æ—¶äº§ç”Ÿã€‚ç†”æ–­å™¨ä¹Ÿå¯ä»¥ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè¯Šæ–­é”™è¯¯æ˜¯å¦å·²ç»ä¿®æ­£ï¼Œå¦‚æœå·²ç»ä¿®æ­£ï¼Œåº”ç”¨ç¨‹åºä¼šå†æ¬¡å°è¯•è°ƒç”¨æ“ä½œã€‚</p><p>ç†”æ–­å™¨æ¨¡å¼å°±åƒæ˜¯é‚£äº›å®¹æ˜“å¯¼è‡´é”™è¯¯çš„æ“ä½œçš„ä¸€ç§ä»£ç†ã€‚è¿™ç§ä»£ç†èƒ½å¤Ÿè®°å½•æœ€è¿‘è°ƒç”¨å‘ç”Ÿé”™è¯¯çš„æ¬¡æ•°ï¼Œç„¶åå†³å®šä½¿ç”¨å…è®¸æ“ä½œç»§ç»­ï¼Œæˆ–è€…ç«‹å³è¿”å›é”™è¯¯ã€‚</p><p>ç†”æ–­å™¨å¼€å…³ç›¸äº’è½¬æ¢çš„é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/OSjXSn.png" alt="ç†”æ–­å™¨"></p><h2 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h2><p>åœ¨Spring Cloudä¸­ä½¿ç”¨äº†Netflixå¼€å‘çš„Hystrixæ¥å®ç°ç†”æ–­å™¨ã€‚</p><h2 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h2><p><strong>Hystrixç›‘æ§</strong>ï¼Œé™¤äº†éš”ç¦»ä¾èµ–æœåŠ¡çš„è°ƒç”¨ä»¥å¤–ï¼ŒHystrixè¿˜æä¾›äº†è¿‘å®æ—¶çš„ç›‘æ§ï¼ŒHystrixä¼šå®æ—¶ã€ç´¯åŠ åœ°è®°å½•æ‰€æœ‰å…³äºHystrixCommandçš„æ‰§è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ç§’æ‰§è¡Œå¤šå°‘è¯·æ±‚å¤šå°‘æˆåŠŸï¼Œå¤šå°‘å¤±è´¥ç­‰ã€‚Netflixé€šè¿‡hystrix-metrics-event-streamé¡¹ç›®å®ç°äº†å¯¹ä»¥ä¸ŠæŒ‡æ ‡çš„ç›‘æ§ã€‚</p><h2 id="Turbine"><a href="#Turbine" class="headerlink" title="Turbine"></a>Turbine</h2><p>åœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹ç»å¸¸éœ€è¦éƒ¨ç½²ä¸Šç™¾ç”šè‡³ä¸Šåƒä¸ªï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿ç»´äººå‘˜å¸Œæœ›èƒ½å¤ŸæŠŠç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹çŠ¶æ€ä»¥ä¸€ä¸ªæ•´ä½“é›†ç¾¤çš„å½¢å¼å±•ç°å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„æŠŠæ¡æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ã€‚ ä¸ºæ­¤ï¼ŒNetflixæä¾›äº†ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ˆTurbineï¼‰æ¥æä¾›æŠŠå¤šä¸ªhystrix.streamçš„å†…å®¹èšåˆä¸ºä¸€ä¸ªæ•°æ®æºä¾›Dashboardå±•ç¤ºã€‚ </p><p>å’ŒHystrix Dashboardä¸€æ ·ï¼ŒTurbineä¹Ÿå¯ä»¥ä¸‹è½½waråŒ…éƒ¨ç½²åˆ°Webå®¹å™¨ã€‚</p><h2 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h2><p>Netflixå¼€æºçš„å¾®æœåŠ¡ç½‘å…³ï¼Œæ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—è¿‡æ»¤å™¨ï¼š</p><ul><li>èº«ä»½è®¤è¯å®‰å…¨</li><li>å®¡æŸ¥ä¸ç›‘æ§</li><li>åŠ¨æ€è·¯ç”±</li><li>å‹åŠ›æµ‹è¯•</li><li>é™„å†åˆ†é…</li><li>é™æ€å“åº”å¤„ç†</li><li>å¤šåŒºåŸŸå¼¹æ€§</li></ul><h2 id="Zuulè¿‡æ»¤å™¨"><a href="#Zuulè¿‡æ»¤å™¨" class="headerlink" title="Zuulè¿‡æ»¤å™¨"></a>Zuulè¿‡æ»¤å™¨</h2><p>Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ä¸»è¦ä¸º4ç§æ ‡å‡†ç±»å‹ï¼š</p><ul><li>PREï¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨</li><li>ROUTINGï¼šè¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡</li><li>POSTï¼šåœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œ</li><li>ERRORï¼šåœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶è‡ªä¿¡è¯¥è¿‡æ»¤å™¨</li></ul><h2 id="Sleuth"><a href="#Sleuth" class="headerlink" title="Sleuth"></a>Sleuth</h2><p>ä¸ºSpring Cloud æä¾›äº†åˆ†å¸ƒå¼è·Ÿè¸ªçš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¤§é‡å€ŸåŠ©äº†Google Dapperã€Twitter Zipkin å’Œ Apache HTraceçš„è®¾è®¡ã€‚<br>Sleuthçš„æœ¯è¯­ï¼š<strong>spanï¼ˆè·¨åº¦ï¼‰</strong>ã€<strong>traceï¼ˆè·Ÿè¸ªï¼‰</strong>ã€<strong>annotationï¼ˆæ ‡æ³¨ï¼‰</strong></p><h2 id="é…ç½®ä¸­å¿ƒ"><a href="#é…ç½®ä¸­å¿ƒ" class="headerlink" title="é…ç½®ä¸­å¿ƒ"></a>é…ç½®ä¸­å¿ƒ</h2><p>Spring Cloud Configæä¾›äº†ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤–éƒ¨åŒ–é…ç½®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ”¯æŒã€‚é…ç½®æœåŠ¡å™¨æœ‰ä¸€ä¸ªä¸­å¿ƒä½ç½®ï¼Œç®¡ç†æ‰€æœ‰ç¯å¢ƒä¸‹çš„åº”ç”¨çš„å¤–éƒ¨å±æ€§ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ˜ å°„åˆ°ç›¸åŒSpring Eventment å’Œ PropertySrouceæŠ½è±¡çš„æ¦‚å¿µï¼Œæ‰€ä»¥éå¸¸é€‚åˆSpringåº”ç”¨ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨ä»»ä½•è¯­è¨€å¼€å‘çš„ä»»ä½•åº”ç”¨ä¸­ä½¿ç”¨ã€‚åœ¨ä¸€ä¸ªåº”ç”¨ä»å¼€å‘ã€æµ‹è¯•åˆ°ç”Ÿäº§çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥åˆ†åˆ«åœ°ç®¡ç†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„é…ç½®ï¼Œå¹¶ä¸”åœ¨è¿ç§»çš„æ—¶å€™è·å–ç›¸åº”çš„é…ç½®æ¥è¿è¡Œã€‚</p><p>Config Server å­˜å‚¨åç«¯é»˜è®¤ä½¿ç”¨gitå­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œå› æ­¤å¯ä»¥å¾ˆå®¹æ˜“æ”¯æŒæ ‡è®°é…ç½®ç¯å¢ƒçš„ç‰ˆæœ¬ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä½¿ç”¨å¹¿æ³›çš„å·¥å…·ç®¡ç†é…ç½®å†…å®¹ã€‚å½“ç„¶æ·»åŠ å…¶ä»–æ–¹å¼çš„å­˜å‚¨å®ç°ä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„ã€‚</p><h2 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h2><p>API Gatewayæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼š<a href="http://dockone.io/article/482">http://dockone.io/article/482</a>ã€‚</p><p>API Gatewayæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯è¿›å…¥ç³»ç»Ÿçš„å”¯ä¸€èŠ‚ç‚¹ã€‚è¿™è·Ÿé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ä¸­çš„Facadeæ¨¡å¼å¾ˆåƒã€‚API Gatewayå°è£…å†…éƒ¨ç³»ç»Ÿçš„æ¶æ„ï¼Œå¹¶ä¸”æä¾›APIç»™å„ä¸ªå®¢æˆ·ç«¯ã€‚å®ƒè¿˜å¯èƒ½æœ‰å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æˆæƒã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡å’Œç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰ã€‚</p><p>API Gatewayè´Ÿè´£è¯·æ±‚è½¬å‘ã€åˆæˆå’Œåè®®è½¬æ¢ã€‚æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½è¦å…ˆç»è¿‡API Gatewayï¼Œç„¶åè·¯ç”±è¿™äº›è¯·æ±‚åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚API Gatewayå°†ç»å¸¸é€šè¿‡è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚ä»¥åŠèšåˆå¤šä¸ªæœåŠ¡çš„ç»“æœã€‚å®ƒå¯ä»¥åœ¨webåè®®ä¸å†…éƒ¨ä½¿ç”¨çš„éWebå‹å¥½å‹åè®®é—´è¿›è¡Œè½¬æ¢ï¼Œå¦‚HTTPåè®®ã€WebSocketåè®®ã€‚</p><p>API Gatewayå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„APIã€‚å®ƒæš´éœ²ä¸€ä¸ªç²—ç²’åº¦APIç»™ç§»åŠ¨å®¢æˆ·ç«¯ã€‚ä»¥äº§å“æœ€ç»ˆé¡µè¿™ä¸ªä½¿ç”¨åœºæ™¯ä¸ºä¾‹ã€‚API Gatewayæä¾›ä¸€ä¸ªæœåŠ¡æä¾›ç‚¹ï¼ˆ/productdetails?productid=xxxï¼‰ä½¿å¾—ç§»åŠ¨å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ£€ç´¢åˆ°äº§å“æœ€ç»ˆé¡µçš„å…¨éƒ¨æ•°æ®ã€‚API Gatewayé€šè¿‡è°ƒç”¨å¤šä¸ªæœåŠ¡æ¥å¤„ç†è¿™ä¸€ä¸ªè¯·æ±‚å¹¶è¿”å›ç»“æœï¼Œæ¶‰åŠäº§å“ä¿¡æ¯ã€æ¨èã€è¯„è®ºç­‰ã€‚</p><p>ä¸€ä¸ªå¾ˆå¥½çš„API Gatewayä¾‹å­æ˜¯<a href="http://techblog.netflix.com/2013/02/rxjava-netflix-api.html">Netfix API Gateway</a>ã€‚NetflixæµæœåŠ¡æä¾›æ•°ç™¾ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼ŒåŒ…æ‹¬ç”µè§†ã€æœºé¡¶ç›’ã€æ™ºèƒ½æ‰‹æœºã€æ¸¸æˆç³»ç»Ÿã€å¹³æ¿ç”µè„‘ç­‰ã€‚èµ·åˆï¼ŒNetflixè§†å›¾æä¾›ä¸€ä¸ª<a href="http://www.programmableweb.com/news/why-rest-keeps-me-night/2012/05/15">é€‚ç”¨å…¨åœºæ™¯</a>çš„APIã€‚ä½†æ˜¯ï¼Œä»–ä»¬å‘ç°è¿™ç§å½¢å¼ä¸å¥½ç”¨ï¼Œå› ä¸ºæ¶‰åŠåˆ°å„å¼å„æ ·çš„è®¾å¤‡ä»¥åŠå®ƒä»¬ç‹¬ç‰¹çš„éœ€æ±‚ã€‚ç°åœ¨ï¼Œä»–ä»¬é‡‡ç”¨ä¸€ä¸ªAPI Gatewayæ¥æä¾›å®¹é”™æ€§é«˜çš„APIï¼Œé’ˆå¯¹ä¸åŒç±»å‹è®¾å¤‡æœ‰ç›¸åº”ä»£ç ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªé€‚é…å™¨å¤„ç†ä¸€ä¸ªè¯·æ±‚å¹³å‡è¦è°ƒç”¨6åˆ°8ä¸ªåç«¯æœåŠ¡ã€‚Netflix API Gatewayæ¯å¤©å¤„ç†æ•°åäº¿çš„è¯·æ±‚ã€‚</p><h3 id="API-Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹"><a href="#API-Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹" class="headerlink" title="API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹"></a>API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹</h3><p>å¦‚ä½ æ‰€æ–™ï¼Œé‡‡ç”¨API Gatewayä¹Ÿæ˜¯ä¼˜ç¼ºç‚¹å¹¶å­˜çš„ã€‚API Gatewayçš„ä¸€ä¸ªæœ€å¤§å¥½å¤„æ˜¯å°è£…åº”ç”¨å†…éƒ¨ç»“æ„ã€‚ç›¸æ¯”èµ·æ¥è°ƒç”¨æŒ‡å®šçš„æœåŠ¡ï¼Œå®¢æˆ·ç«¯ç›´æ¥è·Ÿgatwayäº¤äº’æ›´ç®€å•ç‚¹ã€‚API Gatewayæä¾›ç»™æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªç‰¹å®šAPIï¼Œè¿™æ ·å‡å°‘äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡æ¬¡æ•°ï¼Œä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚</p><p>API Gatewayä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„ç»„ä»¶ï¼Œå¿…é¡»è¦å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒå¯èƒ½æˆä¸ºå¼€å‘çš„ä¸€ä¸ªç“¶é¢ˆã€‚å¼€å‘è€…å¿…é¡»æ›´æ–°API Gatewayæ¥æä¾›æ–°æœåŠ¡æä¾›ç‚¹æ¥æ”¯æŒæ–°æš´éœ²çš„å¾®æœåŠ¡ã€‚æ›´æ–°API Gatewayæ—¶å¿…é¡»è¶Šè½»é‡çº§è¶Šå¥½ã€‚å¦åˆ™ï¼Œå¼€å‘è€…å°†å› ä¸ºæ›´æ–°Gatewayè€Œæ’é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œé™¤äº†è¿™äº›ç¼ºç‚¹ï¼Œå¯¹äºå¤§éƒ¨åˆ†çš„åº”ç”¨ï¼Œé‡‡ç”¨API Gatewayçš„æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚</p><p>ä½¿ç”¨API Gatewayåï¼Œå®¢æˆ·ç«¯å’Œå¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œå›¾å˜æˆä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/17/MGTTqC.png" alt="API Gateway"></p><p>é€šè¿‡API Gatewayï¼Œå¯ä»¥ç»Ÿä¸€å‘å¤–éƒ¨ç³»ç»Ÿæä¾›REST APIã€‚Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚</p><hr><p><strong>å›¾æ–‡æ¥æºï¼š</strong><a href="https://github.com/eacdy/spring-cloud-book">https://github.com/eacdy/spring-cloud-book</a>ã€<a href="https://google.com/">Google</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringCloud </tag>
            
            <tag> å¾®æœåŠ¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–</title>
      <link href="/blog/2018/09/21/7876bd5d.html"/>
      <url>/blog/2018/09/21/7876bd5d.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¹¶å‘å¤„ç†çš„å¹¿æ³›åº”ç”¨æ˜¯ä½¿å¾—Amdahlå®šå¾‹ä»£æ›¿æ‘©å°”å®šå¾‹æˆä¸ºè®¡ç®—æœºæ€§èƒ½å‘å±•æºåŠ¨åŠ›çš„æ ¹æœ¬åŸå› ï¼Œä¹Ÿæ˜¯äººç±»å‹æ¦¨è®¡ç®—æœºè¿ç®—èƒ½åŠ›æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨è½¯ä»¶ä¸šå‘å±•çš„åˆæœŸï¼Œç¨‹åºç¼–å†™éƒ½æ˜¯ä»¥ç®—æ³•ä¸ºæ ¸å¿ƒçš„ï¼Œç¨‹åºå‘˜ä¼šæŠŠæ•°æ®å’Œè¿‡ç¨‹åˆ†åˆ«ä½œä¸ºç‹¬ç«‹çš„éƒ¨åˆ†æ¥è€ƒè™‘ï¼Œæ•°æ®ä»£è¡¨é—®é¢˜ç©ºé—´ä¸­çš„å®¢ä½“ï¼Œç¨‹åºä»£ç åˆ™ç”¨äºå¤„ç†è¿™äº›æ•°æ®ï¼Œè¿™ç§æ€ç»´æ–¹å¼æ˜¯ç›´æ¥ç«™åœ¨è®¡ç®—æœºçš„è§’åº¦å»æŠ½è±¡é—®é¢˜å’Œè§£å†³é—®é¢˜ï¼Œç§°ä¸ºé¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹æ€æƒ³ã€‚ä¸æ­¤ç›¸å¯¹ï¼Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³åˆ™ç«™åœ¨ç°å®ä¸–ç•Œçš„è§’åº¦å»æŠ½è±¡å’Œè§£å†³é—®é¢˜ï¼Œå®ƒæŠŠæ•°æ®å’Œè¡Œä¸ºéƒ½çœ‹ä½œæ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥è®©ç¨‹åºå‘˜èƒ½ä»¥ç¬¦åˆç°å®ä¸–ç•Œçš„æ€ç»´æ–¹å¼æ¥ç¼–å†™å’Œç»„ç»‡ç¨‹åºã€‚</p><p>äººä»¬å¾ˆéš¾æƒ³è±¡ç°å®ä¸­çš„å¯¹è±¡åœ¨ä¸€é¡¹å·¥ä½œè¿›è¡Œå™¨ä»¶ï¼Œä¼šè¢«ä¸åœåœ°ä¸­æ–­å’Œåˆ‡æ¢ï¼Œå¯¹è±¡åœ°å±æ€§å¯èƒ½ä¼šåœ¨ä¸­æ–­æœŸé—´è¢«ä¿®æ”¹å’Œå˜è„ï¼Œè€Œè¿™äº›äº‹ä»¶åœ¨è®¡ç®—æœºä¸–ç•Œä¸­æ˜¯å¾ˆæ­£å¸¸åœ°äº‹æƒ…ã€‚è‰¯å¥½åœ°è®¾è®¡åŸåˆ™ä¸å¾—ä¸å‘ç°å®åšå‡ºä¸€äº›è®©æ­¥ï¼Œæˆ‘ä»¬å¿…é¡»è®©ç¨‹åºåœ¨è®¡ç®—æœºä¸­æ­£ç¡®æ— è¯¯åœ°è¿è¡Œï¼Œç„¶åå†è€ƒè™‘å¦‚ä½•å°†ä»£ç ç»„ç»‡å¾—æ›´å¥½ï¼Œè®©ç¨‹åºè¿è¡Œå¾—æ›´å¿«ã€‚</p><h2 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><blockquote><p>â€œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹å¾—è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„ååŒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£è¿™ä¸ªå¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚â€</p><p>â€”â€” ã€ŠJava Concurrency In Practiceã€‹çš„ä½œè€…Brian Goetzå¯¹â€œçº¿ç¨‹å®‰å…¨â€çš„å®šä¹‰</p></blockquote><p>è¿™ä¸ªå®šä¹‰å¾ˆä¸¥è°¨ï¼Œå®ƒè¦æ±‚äº†çº¿ç¨‹å®‰å…¨çš„ä»£ç å¿…é¡»éƒ½å…·å¤‡ä¸€ä¸ªç‰¹å¾ï¼š<strong>ä»£ç æœ¬èº«å°è£…äº†æ‰€æœ‰å¿…è¦çš„æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µï¼ˆå¦‚äº’æ–¥åŒæ­¥ç­‰ï¼‰ï¼Œä»¤è°ƒç”¨è€…æ— é¡»å…³ç³»å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œæ›´æ— é¡»è‡ªå·±å®ç°ä»»ä½•æªæ–½æ¥ä¿è¯å¤šçº¿ç¨‹çš„æ­£ç¡®è°ƒç”¨ã€‚</strong>è¿™ç‚¹å¹¶ä¸å®¹æ˜“åšåˆ°ã€‚</p><h3 id="Javaè¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨"><a href="#Javaè¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="Javaè¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨"></a>Javaè¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨</h3><p>æˆ‘ä»¬è®¨è®ºçº¿ç¨‹å®‰å…¨ï¼Œå°±é™å®šäºå¤šä¸ªçº¿ç¨‹ä¹‹é—´å­˜åœ¨å…±äº«æ•°æ®è®¿é—®è¿™ä¸ªå‰æï¼Œå› ä¸ºå¦‚æœä¸€æ®µä»£ç æ ¹æœ¬ä¸ä¼šä¸å…¶ä»–çº¿ç¨‹å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆä»çº¿ç¨‹å®‰å…¨çš„è§’åº¦ä¸Šçœ‹ï¼Œç¨‹åºæ—¶ä¸²è¡Œæ‰§è¡Œè¿˜æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œå¯¹å®ƒæ¥è¯´æ˜¯å®Œå…¨æ²¡æœ‰åŒºåˆ«çš„ã€‚</p><p>æŒ‰ç…§çº¿ç¨‹å®‰å…¨çš„â€œå®‰å…¨ç¨‹åº¦â€ç”±å¼ºè‡³å¼±æ¥æ’åºï¼Œå¯ä»¥å°†Javaè¯­è¨€ä¸­å„ç§æ“ä½œå…±äº«çš„æ•°æ®åˆ†ä¸ºäº”ç±»ï¼š<strong>ä¸å¯å˜ã€ç»å¯¹çº¿ç¨‹å®‰å…¨ã€ç›¸å¯¹çº¿ç¨‹å®‰å…¨ã€å¿åŸå…¼å®¹å’Œçº¿ç¨‹å¯¹ç«‹ã€‚</strong></p><h4 id="ä¸å¯å˜"><a href="#ä¸å¯å˜" class="headerlink" title="ä¸å¯å˜"></a>ä¸å¯å˜</h4><p>åœ¨Javaè¯­è¨€é‡Œé¢ï¼Œä¸å¯å˜çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— è®ºæ˜¯å¯¹è±¡çš„æ–¹æ³•å®ç°è¿˜æ˜¯æ–¹æ³•çš„è°ƒç”¨è€…ï¼Œéƒ½ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ï¼Œ<strong>åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®çš„æ„å»ºå‡ºæ¥ï¼ˆæ²¡æœ‰å‘ç”Ÿthisé€ƒé€¸çš„æƒ…å†µï¼‰ï¼Œé‚£å…¶å¤–éƒ¨çš„å¯è§çŠ¶æ€æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒå†å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„ç‹‚æ€ã€‚</strong>â€œä¸å¯å˜â€å¸¦æ¥çš„å®‰å…¨æ€§æ˜¯æœ€ç®€å•æœ€çº¯ç²¹çš„ã€‚</p><p>å¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªä¸€æœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆåªè¦å†å®šä¹‰æ—¶ä½¿ç”¨<code>final</code>å…³é”®å­—ä¿®é¥°å®ƒå°±å¯ä»¥ä¿è¯å®ƒæ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±éœ€è¦ä¿è¯å¯¹è±¡çš„è¡Œä¸ºä¸ä¼šå¯¹å…¶çŠ¶æ€äº§ç”Ÿä»»ä½•å½±å“æ‰è¡Œã€‚<code>java.lang.String</code>ç±»çš„å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„ä¸å¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬è°ƒç”¨å®ƒçš„<code>substring()</code>ã€<code>replace()</code>å’Œ<code>concat()</code>è¿™äº›æ–¹æ³•éƒ½ä¸ä¼šå½±å“å®ƒåŸæ¥çš„å€¼ï¼Œåªä¼šè¿”å›ä¸€ä¸ªæ–°æ„é€ çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</p><blockquote><p>ä¿è¯å¯¹è±¡è¡Œä¸ºä¸å½±å“è‡ªå·±çŠ¶æ€çš„é€”å¾„ç”±å¾ˆå¤šç§ï¼Œå…¶ä¸­æœ€ç®€å•çš„å°±æ˜¯æŠŠå¯¹è±¡ä¸­å¸¦æœ‰çŠ¶æ€çš„å˜é‡éƒ½å£°æ˜ä¸º<code>final</code>ï¼Œè¿™æ ·åœ¨æ„é€ å‡½æ•°ç»“æŸä¹‹åï¼Œ å®ƒå°±æ˜¯ä¸å¯å˜çš„ã€‚</p></blockquote><p><code>java.lang.Integer</code>æ„é€ å‡½æ•°ï¼Œå®ƒé€šè¿‡å°†å†…éƒ¨çŠ¶æ€å˜é‡<code>value</code>å®šä¹‰ä¸º<code>final</code>æ¥ä¿éšœçŠ¶æ€ä¸å˜ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * The value of the &#123;<span class="doctag">@code</span> Integer&#125;.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Constructs a newly allocated &#123;<span class="doctag">@code</span> Integer&#125; object that</span></span><br><span class="line"><span class="comment">  * represents the specified &#123;<span class="doctag">@code</span> int&#125; value.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>   value   the value to be represented by the</span></span><br><span class="line"><span class="comment">  *                  &#123;<span class="doctag">@code</span> Integer&#125; object.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Integer</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.value = value;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨Java APIä¸­ç¬¦åˆä¸å¯å˜è¦æ±‚çš„ç±»å‹ï¼Œé™¤äº†<code>String</code>ä¹‹å¤–ï¼Œå¸¸ç”¨çš„è¿˜æœ‰æšä¸¾ç±»å‹ï¼Œä»¥åŠ<code>java.lang.Number</code>çš„éƒ¨åˆ†å­ç±»ã€‚</p><h4 id="ç»å¯¹çº¿ç¨‹å®‰å…¨"><a href="#ç»å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="ç»å¯¹çº¿ç¨‹å®‰å…¨"></a>ç»å¯¹çº¿ç¨‹å®‰å…¨</h4><p>ç»å¯¹çº¿ç¨‹å®‰å…¨å®Œå…¨æ»¡è¶³<code>Brian Goetz</code>ç»™å‡ºçš„çº¿ç¨‹å®‰å…¨çš„å®šä¹‰ï¼Œè¿™ä¸ªå®šä¹‰å…¶å®æ˜¯å¾ˆä¸¥æ ¼çš„ï¼Œä¸€ä¸ªç±»è¦è¾¾åˆ°â€œä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒå¦‚ä½•ï¼Œè°ƒç”¨è€…éƒ½ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æªæ–½â€é€šå¸¸éœ€è¦ä»˜å‡ºå¾ˆå¤§çš„ï¼Œç”šè‡³æ˜¯ä¸åˆ‡å®é™…çš„ä»£ä»·ã€‚åœ¨Java APIä¸­æ ‡æ³¨è‡ªå·±æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œå¤§å¤šæ•°éƒ½ä¸æ˜¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ã€‚</p><p><code>java.util.Vector</code>æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œå› ä¸ºå®ƒçš„<code>add()</code>ã€<code>get()</code>å’Œ<code>size()</code>è¿™ç±»æ–¹æ³•éƒ½æ˜¯è¢«<code>synchronized</code>ä¿®é¥°çš„ï¼Œå°½ç®¡è¿™æ ·æ•ˆç‡å¾ˆä½ï¼Œä½†ç¡®å®æ˜¯å®‰å…¨çš„ã€‚ä½†æ˜¯ï¼Œ<strong>å³ä½¿å®ƒæ‰€æœ‰çš„æ–¹æ³•éƒ½è¢«ä¿®é¥°æˆåŒæ­¥ï¼Œä¹Ÿä¸æ„å‘³ç€è°ƒç”¨å®ƒçš„æ—¶å€™æ°¸è¿œéƒ½ä¸å†éœ€è¦åŒæ­¥æ‰‹æ®µäº†ã€‚</strong></p><p>ä»£ç æ¸…å•ï¼Œå¯¹Vectorçº¿ç¨‹å®‰å…¨çš„æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.jvmdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Antä¸¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorSaveTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; vector = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Thread removeThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        vector.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            Thread printThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        System.out.println(vector.get(i));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            removeThread.start();</span><br><span class="line">            printThread.start();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ä¸è¦åŒæ—¶äº§ç”Ÿè¿‡å¤šçš„çº¿ç¨‹ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå‡æ­»</span></span><br><span class="line">            <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">20</span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/l0vR4U.png" alt="å¯¹Vectorçº¿ç¨‹å®‰å…¨çš„æµ‹è¯•"></p><p>å°½ç®¡è¿™é‡Œä½¿ç”¨åˆ°çš„<code>Vector</code>çš„<code>get()</code>ã€<code>remove()</code>å’Œ<code>size()</code>æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœä¸åœ¨æ–¹æ³•è°ƒç”¨ç«¯åšé¢å¤–çš„ä¸åŒæªæ–½ï¼Œä½¿ç”¨è¿™æ®µä»£ç ä»ç„¶æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸º<strong>å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹åˆ‡å¥½åœ¨é”™è¯¯çš„æ—¶é—´é‡Œåˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œå¯¼è‡´åºå·iå·²ç»ä¸å†å¯ç”¨çš„è¯ï¼Œget()æ–¹æ³•å°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>ArrayIndexOutOfBoundsException</code>ã€‚</strong></p><p>è¦ä¿è¯è¿™æ®µä»£ç èƒ½æ­£ç¡®åœ°æ‰§è¡Œä¸‹å»ï¼Œè¦å¯¹<code>removeThread</code>å’Œ<code>printThread</code>åšä¸€äº›ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread removeThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (vector) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                vector.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Thread printThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (vector) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                System.out.println(vector.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="ç›¸å¯¹çº¿ç¨‹å®‰å…¨"><a href="#ç›¸å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="ç›¸å¯¹çº¿ç¨‹å®‰å…¨"></a>ç›¸å¯¹çº¿ç¨‹å®‰å…¨</h4><p>ç›¸å¯¹çº¿ç¨‹å®‰å…¨å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šæ‰€è®²çš„çº¿ç¨‹å®‰å…¨ï¼Œ å®ƒéœ€è¦ä¿è¯å¯¹è¿™ä¸ªå¯¹è±¡å•ç‹¬çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨é¢å¤–çš„åŒæ­¥æ‰‹æ®µæ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚</p><blockquote><p>åœ¨Javaè¯­è¨€ä¸­ï¼Œå¤§éƒ¨åˆ†çš„çº¿ç¨‹å®‰å…¨ç±»éƒ½å±äºè¿™ç§ç±»å‹ï¼Œä¾‹å¦‚<code>Vector</code>ã€<code>HashTable</code>ã€<code>Collections</code>çš„<code>synchronizedCollection()</code>æ–¹æ³•åŒ…è£…çš„é›†åˆç­‰ã€‚</p></blockquote><h4 id="çº¿ç¨‹å…¼å®¹"><a href="#çº¿ç¨‹å…¼å®¹" class="headerlink" title="çº¿ç¨‹å…¼å®¹"></a>çº¿ç¨‹å…¼å®¹</h4><p>çº¿ç¨‹å…¼å®¹æ˜¯æŒ‡å¯¹è±¡æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®åœ°ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡åœ¨å¹¶å‘ç¯å¢ƒä¸­å®‰å…¨åœ°ä½¿ç”¨ï¼Œæˆ‘ä»¬å¹³å¸¸è¯´ä¸€ä¸ªç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç»å¤§å¤šæ•°æŒ‡çš„éƒ½æ˜¯è¿™ç§æƒ…å†µã€‚Java APIä¸­å¤§éƒ¨åˆ†çš„ç±»éƒ½æ˜¯çº¿ç¨‹å…¼å®¹çš„ï¼Œå¦‚<code>Vector</code>å’Œ<code>Hashtable</code>ç›¸å¯¹åº”çš„é›†åˆç±»<code>ArrayList</code>å’Œ<code>HashMap</code>ç­‰ã€‚</p><h4 id="çº¿ç¨‹å¯¹ç«‹"><a href="#çº¿ç¨‹å¯¹ç«‹" class="headerlink" title="çº¿ç¨‹å¯¹ç«‹"></a>çº¿ç¨‹å¯¹ç«‹</h4><p>çº¿ç¨‹å¯¹ç«‹æ˜¯æŒ‡ä¸ç®¡è°ƒç”¨ç«¯æ˜¯å¦é‡‡å–äº†åŒæ­¥æªæ–½ï¼Œéƒ½æ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘ä½¿ç”¨çš„ä»£ç ã€‚ç”±äºJavaè¯­è¨€å¤©ç”Ÿå°±å…·å¤‡å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œçº¿ç¨‹å¯¹ç«‹è¿™ç§æ’æ–¥å¤šçº¿ç¨‹çš„ä»£ç å¾ˆå°‘å‡ºç°ï¼Œè€Œä¸”é€šå¸¸æ˜¯æœ‰å®³çš„ï¼Œåº”å°½é‡é¿å…ã€‚</p><p>ä¸€ä¸ªçº¿ç¨‹å¯¹ç«‹çš„ä¾‹å­æ˜¯<code>Thread</code>ç±»çš„<code>suspend()</code>å’Œ<code>resume()</code>æ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä¸€ä¸ªå°è¯•å»ä¸­æ–­çº¿ç¨‹ï¼Œä¸€ä¸ªå°è¯•å»æ¢å¤çº¿ç¨‹ï¼Œå¦‚æœå¹¶å‘è¿›è¡Œçš„è¯ï¼Œ æ— è®ºè°ƒç”¨æ—¶æ˜¯å¦è¿›è¡Œäº†åŒæ­¥ï¼Œç›®æ ‡çº¿ç¨‹éƒ½æ˜¯å­˜åœ¨æ­»é”é£é™©çš„ï¼Œå¦‚æœ<code>suspend()</code>ä¸­æ–­çš„çº¿ç¨‹å°±æ˜¯å³å°†è¦æ‰§è¡Œ<code>resume()</code>çš„é‚£ä¸ªçº¿ç¨‹ï¼Œé‚£å°±è‚¯å®šäº§ç”Ÿæ­»é”äº†ã€‚</p><h3 id="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•"><a href="#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" class="headerlink" title="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•"></a>çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•</h3><p>å¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨ä¸ä»£ç çš„ç¼–å†™æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œä½†è™šæ‹Ÿæœºæä¾›çš„åŒæ­¥å’Œé”æœºåˆ¶ä¹Ÿèµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p><h4 id="äº’æ–¥åŒæ­¥"><a href="#äº’æ–¥åŒæ­¥" class="headerlink" title="äº’æ–¥åŒæ­¥"></a>äº’æ–¥åŒæ­¥</h4><p><strong>äº’æ–¥åŒæ­¥æ˜¯æœ€å¸¸è§çš„ä¸€ç§å¹¶å‘æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µï¼ŒåŒæ­¥æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€æ¡çº¿ç¨‹ä½¿ç”¨ã€‚è€Œäº’æ–¥æ˜¯å®ç°åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼Œä¸´ç•ŒåŒºã€äº’æ–¥é‡å’Œä¿¡å·é‡éƒ½æ˜¯ä¸»è¦çš„äº’æ–¥å®ç°æ–¹å¼ã€‚</strong>äº’æ–¥æ˜¯å› ï¼ŒåŒæ­¥æ˜¯æœï¼Œäº’æ–¥æ˜¯æ–¹æ³•ï¼ŒåŒæ­¥æ˜¯ç›®çš„ã€‚</p><p>åœ¨Javaé‡Œé¢ï¼Œæœ€åŸºæœ¬çš„äº’æ–¥åŒæ­¥æ‰‹æ®µå°±æ˜¯<code>synchronized</code>å…³é”®å­—ï¼Œ<code>synchronized</code>å…³é”®å­—ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œä¼šåœ¨åŒæ­¥å—çš„å‰ååˆ†åˆ«å½¢æˆ<code>monitorenter</code>å’Œ<code>monitorexit</code>è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç éƒ½éœ€è¦ä¸€ä¸ª<code>reference</code>ç±»å‹çš„å‚æ•°æ¥æŒ‡æ˜è¦é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚å¦‚æœJavaç¨‹åºä¸­çš„<code>synchronized</code>æ˜ç¡®æŒ‡å®šäº†å¯¹è±¡å‚æ•°ï¼Œé‚£å°±æ˜¯å¯¹è¿™ä¸ªå‚æ•°çš„<code>reference</code>ï¼›å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œé‚£å°±æ ¹æ®<code>synchronized</code>ä¿®é¥°çš„å®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œå»å–å¯¹åº”çš„å¯¹è±¡å®ä¾‹æˆ–Classå¯¹è±¡æ¥ä½œä¸ºé”å¯¹è±¡ã€‚</p><blockquote><p>åœ¨æ‰§è¡Œ<code>monitorenter</code>æŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆè¦å°è¯•è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œæˆ–è€…å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†é‚£ä¸ªå¯¹è±¡çš„é”ï¼ŒæŠŠé”çš„è®¡æ•°å™¨åŠ 1ï¼Œç›¸åº”åœ°ï¼Œåœ¨æ‰§è¡Œ<code>monitorexit</code>æŒ‡ä»¤æ—¶ä¼šè®²é”è®¡æ•°å™¨å‡1ï¼Œå½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œé”å°±é‡Šæ”¾äº†ã€‚å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥äº†ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚</p></blockquote><p>é¦–å…ˆ<code>synchronized</code>åŒæ­¥å—å¯¹åŒä¸€æ¡çº¿ç¨‹æ¥è¯´æ˜¯å¯é‡å…¥çš„ï¼Œä¸ä¼šå‡ºç°è‡ªå·±æŠŠè‡ªå·±é”æ­»çš„é—®é¢˜ã€‚å…¶æ¬¡ï¼ŒåŒæ­¥å—åœ¨å·²è¿›å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¼šé˜»å¡åé¢å…¶ä»–çº¿ç¨‹çš„è¿›å…¥ã€‚<strong>Javaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸå£°çº¿ç¨‹ä¸Šçš„ï¼Œå¦‚æœè¦é˜»å¡æˆ–å”¤é†’ä¸€æ¡çº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿæ¥å¸®å¿™å®Œæˆï¼Œè¿™å°±éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ä¸­ï¼Œå› æ­¤çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´ã€‚å¯¹äºä»£ç ç®€å•çš„åŒæ­¥å—ï¼ŒçŠ¶æ€è½¬æ¢æ¶ˆè€—çš„æ—¶é—´å¯èƒ½æ¯”ç”¨æˆ·ä»£ç æ‰§è¡Œçš„æ—¶é—´è¿˜è¦å¸¸ã€‚æ‰€ä»¥<code>synchronized</code>æ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ä¸ªé‡é‡çº§çš„æ“ä½œï¼Œåœ¨å¿…è¦çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨è¿™ç§æ“ä½œã€‚</strong>è™šæ‹Ÿæœºæœ¬èº«ä¹Ÿä¼šè¿›è¡Œä¸€äº›ä¼˜åŒ–ï¼Œè­¬å¦‚åœ¨é€šçŸ¥æ“ä½œç³»ç»Ÿé˜»å¡çº¿ç¨‹ä¹‹å‰åŠ å…¥ä¸€æ®µè‡ªæ—‹ç­‰å¾…è¿‡ç¨‹ï¼Œé¿å…é¢‘ç¹åœ°åˆ‡å…¥åˆ°æ ¸å¿ƒæ€ä¹‹ä¸­ã€‚</p><h4 id="éé˜»å¡åŒæ­¥"><a href="#éé˜»å¡åŒæ­¥" class="headerlink" title="éé˜»å¡åŒæ­¥"></a>éé˜»å¡åŒæ­¥</h4><p><em>äº’æ–¥åŒæ­¥æœ€è¦çš„é—®é¢˜æ˜¯è¿›è¡Œçº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿè¢«ç§°ä¸ºé˜»å¡åŒæ­¥ã€‚å¦å¤–ï¼Œå®ƒå±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºé—®é¢˜ï¼Œæ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦è¢«å”¤é†’ç­‰æ“ä½œã€‚</em></p><p>éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæœ‰äº†å¦å¤–ä¸€ä¸ªé€‰æ‹©ï¼š<strong>åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥ï¼Œé€šä¿—åœ°è¯´å°±æ˜¯å…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼›å¦‚æœå…±äº«æ•°æ®æœ‰äº‰ç”¨ï¼Œäº§ç”Ÿäº†å†²çªï¼Œé‚£å°±å†è¿›è¡Œå…¶ä»–çš„è¡¥å¿æªæ–½ï¼ˆä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰ï¼Œè¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šé¦–å…ˆéƒ½ä¸éœ€è¦æŠŠçº¿ç¨‹æŒ‚èµ·ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œè¢«ç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚</strong></p><h4 id="æ— åŒæ­¥æ–¹æ¡ˆ"><a href="#æ— åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="æ— åŒæ­¥æ–¹æ¡ˆ"></a>æ— åŒæ­¥æ–¹æ¡ˆ</h4><p>è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸æ˜¯ä»¥é¡¶è¦è¿›è¡ŒåŒæ­¥ï¼Œä¸¤è€…æ²¡æœ‰å› æœå…³ç³»ã€‚åŒæ­¥åªæ˜¯ä¿éšœå…±äº«æ•°æ®ç«äº‰ç”¨æ—¶çš„æ­£ç¡®æ€§çš„æ‰‹æ®µï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£å®ƒè‡ªç„¶å°±æ— éœ€ä»»ä½•åŒæ­¥æªæ–½å»ä¿è¯æ­£ç¡®æ€§ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›ä»£ç å¤©ç”Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š</p><h5 id="å¯é‡å…¥ä»£ç "><a href="#å¯é‡å…¥ä»£ç " class="headerlink" title="å¯é‡å…¥ä»£ç "></a>å¯é‡å…¥ä»£ç </h5><p>è¿™ç§ä»£ç ä¹Ÿå«çº¯ä»£ç ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºå‡ºç°ä»»ä½•é”™è¯¯ã€‚ç›¸å¯¹çº¿ç¨‹å®‰å…¨æ¥è¯´ï¼Œ å¯é‡å…¥æ€§æ˜¯æ›´åŸºæœ¬çš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå³æ‰€æœ‰çš„å¯é‡å…¥çš„ä»£ç éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¹¶éæ‰€æœ‰çš„çº¿ç¨‹å®‰å…¨çš„ä»£ç éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</p><p>å¯é‡å…¥ä»£ç æœ‰ä¸€äº›å…±åŒçš„ç‰¹å¾ï¼šä¾‹å¦‚ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½ç”±å‚æ•°ä¸­ä¼ å…¥ã€ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚åˆ¤æ–­ä»£ç æ˜¯å¦å…·å¤‡å¯é‡å…¥ï¼š<strong>å¦‚æœä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›çš„ç»“æœæ˜¯å¯ä»¥é¢„æµ‹çš„ï¼Œåªè¦è¾“å…¥äº†ç›¸åŒçš„æ•°æ®ï¼Œå°±èƒ½è¿”å›ç›¸åŒçš„ç»“æœï¼Œé‚£å®ƒæ»¡è¶³å¯é‡å…¥æ€§çš„è¦æ±‚ï¼Œå½“ç„¶ä¹Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</strong></p><h5 id="çº¿ç¨‹æœ¬åœ°å­˜å‚¨"><a href="#çº¿ç¨‹æœ¬åœ°å­˜å‚¨" class="headerlink" title="çº¿ç¨‹æœ¬åœ°å­˜å‚¨"></a>çº¿ç¨‹æœ¬åœ°å­˜å‚¨</h5><p>ä¸€æ®µä»£ç ä¸­æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹èƒ½å¦å¦æ­£è¿™äº›å…±äº«æ•°æ®åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œè¿™æ ·ï¼Œæ— é¡»åŒæ­¥ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚<strong>æœ€å¸¸è§çš„åº”ç”¨å°±æ˜¯æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶æ„æ¨¡å¼ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼‰ï¼Œéƒ½ä¼šè®²äº§å“çš„æ¶ˆè´¹è¿‡ç¨‹å°½é‡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¶ˆè´¹å®Œï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹å°±æ˜¯Webäº¤äº’æ¨¡å‹ä¸­çš„â€œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹çš„å¤„ç†æ–¹å¼ï¼Œè¿™ç§å¤„ç†æ–¹å¼çš„å¹¿æ³›åº”ç”¨ä½¿å¾—WebæœåŠ¡ç«¯çš„å¾ˆå¤šåº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚â€</strong></p><p>Javaè¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡è¦è¢«å¤šçº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨<code>volatile</code>å…³é”®å­—å£°æ˜å®ƒä¸ºâ€œæ˜“å˜çš„â€ï¼›å¦‚æœä¸€ä¸ªå˜é‡è¦è¢«æŸä¸ªçº¿ç¨‹ç‹¬äº«ï¼Œå¯ä»¥é€šè¿‡<code>java.lang.ThreadLocal</code>ç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ã€‚<strong>æ¯ä¸€ä¸ªçº¿ç¨‹çš„<code>Thread</code>å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ª<code>ThreadLocalMap</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å­˜å‚¨äº†ä¸€ç»„ä»¥<code>ThreadLocal.threadLocalHashCode</code>ä¸ºé”®ï¼Œä»¥æœ¬åœ°çº¿ç¨‹å˜é‡ä¸ºå€¼çš„<code>K-V</code>å€¼å¯¹ï¼Œ<code>ThreadLocal</code>å¯¹è±¡å°±æ˜¯å½“å‰çº¿ç¨‹çš„<code>ThreadLocalMap</code>çš„è®¿é—®å…¥å£ï¼Œæ¯ä¸ª<code>ThreadLocal</code>å¯¹è±¡éƒ½åŒ…å«äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„<code>threadLocalHashCode</code>å€¼ï¼Œä½¿ç”¨è¿™ä¸ªå€¼å°±å¯ä»¥åœ¨çº¿ç¨‹<code>K-V</code>å€¼å¯¹ä¸­æ‰¾å›å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹å˜é‡ã€‚</strong></p><h2 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a>é”ä¼˜åŒ–</h2><p>è™šæ‹Ÿæœºå¼€å‘å›¢é˜Ÿå®ç°å„ç§é”ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚<strong>é€‚åº”æ€§è‡ªæ—‹ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€è½»é‡çº§é”ã€åå‘é”ç­‰ï¼Œ</strong>è¿™äº›æŠ€æœ¯éƒ½æ˜¯ä¸ºäº†çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œä»¥åŠè§£å†³ç«äº‰é—®é¢˜ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><h3 id="è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹"><a href="#è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹" class="headerlink" title="è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹"></a>è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹</h3><p>äº’æ–¥åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡çš„å®ç°ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å†…æ ¸æ€ä¸­å®Œæˆï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚åŒæ—¶ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚<strong>å¦‚æœç‰©ç†æœºå™¨æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å¤„ç†å™¨ï¼Œèƒ½è®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå°±å¯ä»¥è®©åé¢è¯·æ±‚é”çš„é‚£ä¸ªçº¿ç¨‹â€œç¨ç­‰ä¸€ä¼šå„¿â€ï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹å•Šå¯èƒ½æŒæœ‰é”æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚</strong>ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œåªé¡»è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“è‡ªæ—‹é”ã€‚</p><p>è‡ªæ—‹ç­‰å¾…ä¸èƒ½ä»£æ›¿é˜»å¡ï¼Œå…ˆä¸è¯´å¯¹å¤„ç†å™¨æ•°é‡çš„è¦æ±‚ï¼Œè‡ªæ—‹ç­‰å¾…æœ¬èº«è™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å®ƒæ˜¯è¦å ç”¨å¤„ç†å™¨æ—¶é—´çš„ï¼Œæ‰€ä»¥å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œåä¹‹å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šæ‹œæ‹œæ¶ˆè€—å¤„ç†å™¨èµ„æºï¼Œè€Œä¸ä¼šåšä»»ä½•æ¸¸æ³³çš„å·¥ä½œï¼Œåè€Œä¼šå¸¦æ¥æ€§èƒ½çš„æµªè´¹ã€‚å› æ­¤è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”å½“ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ã€‚</p><p><strong>è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œ</strong>æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ã€‚å¦å¤–ä¸€æ–¹é¢ï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä¸€é¢æµªè´¹å¤„ç†å™¨èµ„æºã€‚</p><p><em>æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œå’Œæ€§èƒ½ç›‘æ§ä¿¡æ¯çš„ä¸æ–­å®Œå–„ï¼Œè™šæ‹Ÿæœºå¯¹ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œè™šæ‹Ÿæœºå°±ä¼šå˜å¾—è¶Šæ¥è¶Šâ€œèªæ˜â€ã€‚</em></p><h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h3><p>é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚<strong>é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤æ–­ä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åˆ°ä¸€æ®µä»£ç ä¸­ï¼Œåœ¨å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬åšæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶å°±æ— é¡»è¿›è¡Œã€‚</strong></p><h3 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h3><p>åŸåˆ™ä¸Šï¼Œåœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæ¨èå°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°â€”â€”åªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°ï¼Œå¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé‚£ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿèƒ½å°½å¿«æ‹¿åˆ°é”ã€‚</p><p><strong>å¦‚æœä¸€ç³»åˆ—è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹çš„ç«äº‰ï¼Œé¢‘ç¹åœ°è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</strong></p><p>å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰è¿™æ ·çš„ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ªæ“ä½œä¹‹åï¼Œè¿™æ ·åªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><h3 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h3><blockquote><p>è½»é‡çº§æ˜¯ç›¸å¯¹äºæ“ä½œç³»ç»Ÿäº’æ–¥é‡æ¥å®ç°çš„ä¼ ç»Ÿé”è€Œè¨€çš„ï¼Œå› æ­¤ä¼ ç»Ÿçš„é”æœºåˆ¶å°±è¢«ç§°ä¸ºé‡é‡çº§é”ã€‚</p><p>è½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ï¼Œå®ƒæœ¬æ„æ˜¯åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ã€‚</p></blockquote><p>åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœæ­¤åŒæ­¥å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ã€‚ç„¶åï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆã€‚å¦‚æœè¿™ä¸ªæ›´æ–°åŠ¨ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½å°†è½¬å˜ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å‡ºäºè½»é‡çº§é”çš„çŠ¶æ€ã€‚</p><p><strong>å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯å°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜è¿™ä¸ªé”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ã€‚</strong>å¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œè¦è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚</p><p><strong>è½»é‡çº§é”èƒ½æ›¿èº«ç¨‹åºåŒæ­¥æ€§èƒ½çš„ä¾æ®æ˜¯â€œå¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„â€ï¼Œè¿™æ˜¯ä¸€ä¸ªç»éªŒæ•°æ®ã€‚å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œè½»é‡çº§é”ä½¿ç”¨CASé¿å…äº†ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€ï¼Œä½†å¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œå‡ºäº†äº’æ–¥é‡çš„å¼€é”€å¤–ï¼Œè¿˜é¢å¤–å‘ç”Ÿäº†CASæ“ä½œï¼Œå› æ­¤åœ¨æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é”å›é¿ä¼ ç»Ÿçš„é‡é‡çº§é”æ›´æ…¢ã€‚</strong></p><h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>åå‘é”çš„ç›®çš„æ˜¯æ¶ˆé™¤æ•°æ®åœ¨æ— ç«äº‰æƒ…å†µä¸‹çš„åŒæ­¥åŸè¯­ï¼Œè¿›ä¸€æ­¥æé«˜ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚<strong>å¦‚æœè¯´è½»é‡çº§é”æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹ä½¿ç”¨CASæ“ä½œå»æ¶ˆé™¤åŒæ­¥ä½¿ç”¨çš„äº’æ–¥é‡ï¼Œé‚£åå‘é”å°±æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹æŠŠæ•´ä¸ªåŒæ­¥éƒ½æ¶ˆé™¤ï¼Œè¿CASæ“ä½œéƒ½ä¸åšäº†ã€‚</strong></p><p>åå‘é”çš„â€œåâ€ï¼Œæ„æ€æ˜¯è¿™ä¸ªé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹ï¼Œå¦‚æœåœ¨æ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯¥é”æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹çš„è·å–ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹å°†æ°¸è¿œä¸éœ€è¦å†è¿›è¡ŒåŒæ­¥ã€‚</p><p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”æ—¶ï¼Œåå‘æ¨¡å¼å°±å®£å‘Šç»“æŸã€‚æ ¹æ®é”å¯¹è±¡ç›®å‰æ˜¯å¦è¢«é”å®šçš„çŠ¶æ€ï¼Œæ’¤é”€åå‘åæ¢å¤åˆ°æœªé”å®šæˆ–è½»é‡çº§é”å®šçš„çŠ¶æ€ï¼Œåç»­çš„åŒæ­¥æ“ä½œå°±å¦‚è½»é‡çº§é”é‚£æ ·æ‰§è¡Œã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/1l9bkd.png" alt="åå‘é”ã€è½»é‡çº§é”çš„çŠ¶æ€è½¬åŒ–åŠå¯¹è±¡Mark Wordçš„å…³ç³»"></p><p>åå‘é”å¯ä»¥æé«˜å¸¦æœ‰ä¸åŒä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚å®ƒåŒæ ·æ˜¯ä¸€ä¸ªå¸¦æœ‰åˆ©ç›Šæƒè¡¡æ€§è´¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¸€å®šæ€»æ˜¯å¯¹ç¨‹åºè¿è¡Œæœ‰åˆ©ï¼Œå¦‚æœç¨‹åºä¸­å¤§å¤šæ•°é”éƒ½æ€»æ˜¯è¢«å¤šä¸ªä¸åŒçš„çº¿ç¨‹è®¿é—®ï¼Œé‚£åå‘æ¨¡å¼å°±æ˜¯å¤šä½™çš„ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä»‹ç»äº†çº¿ç¨‹å®‰å…¨æ¶‰åŠçš„æ¦‚å¿µå’Œåˆ†ç±»ã€åŒæ­¥å®ç°çš„æ–¹å¼åŠè™šæ‹Ÿæœºçš„åº•å±‚è¿ä½œåŸç†ï¼Œå¹¶ä¸”ä»‹ç»äº†è™šæ‹Ÿæœºå®ç°é«˜æ•ˆå¹¶å‘æ‰€ä½œçš„ä¸€ç³»åˆ—é”ä¼˜åŒ–æªæ–½ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾</li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹</title>
      <link href="/blog/2018/09/18/badf9669.html"/>
      <url>/blog/2018/09/18/badf9669.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¹¶å‘å¤„ç†çš„å¹¿æ³›åº”ç”¨æ˜¯ä½¿å¾—Amdahlå®šå¾‹ä»£æ›¿æ‘©å°”å®šå¾‹æˆä¸ºè®¡ç®—æœºæ€§èƒ½å‘å±•æºåŠ¨åŠ›çš„æ ¹æœ¬åŸå› ï¼Œä¹Ÿæ˜¯äººç±»å‹æ¦¨è®¡ç®—æœºè¿ç®—èƒ½åŠ›æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>é™¤äº†å……åˆ†åˆ©ç”¨è®¡ç®—æœºå¤„ç†å™¨çš„èƒ½åŠ›å¤–ï¼Œä¸€ä¸ªæœåŠ¡ç«¯åŒæ—¶å¯¹å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡æ˜¯ä¸€ä¸ªå…·ä½“çš„å¹¶å‘åº”ç”¨çš„åœºæ™¯ã€‚è¡¡é‡ä¸€ä¸ªæœåŠ¡å™¨æ€§èƒ½çš„é«˜ä½å¥½åï¼Œæ¯ç§’äº‹åŠ¡å¤„ç†æ•°ï¼ˆTransactions Per Secondï¼ŒTPSï¼‰æ˜¯æœ€é‡è¦çš„æŒ‡æ ‡ä¹‹ä¸€ï¼Œå®ƒä»£è¡¨ç€ä¸€ç§’å†…æœåŠ¡ç«¯å¹³å‡èƒ½å“åº”çš„è¯·æ±‚æ€»æ•°ï¼ŒäºŒTPSå€¼ä¸ç¨‹åºçš„å¹¶å‘èƒ½åŠ›åˆæœ‰éå¸¸å¯†åˆ‡çš„å…³ç³»ã€‚å¯¹äºè®¡ç®—é‡ç›¸åŒçš„ä»»åŠ¡ï¼Œç¨‹åºçº¿ç¨‹å¹¶å‘åè°ƒå¾—è¶Šæœ‰æ¡ä¸ç´Šï¼Œæ•ˆç‡è‡ªç„¶å°±ä¼šè¶Šé«˜ï¼›åä¹‹ï¼Œçº¿ç¨‹ä¹‹é—´é¢‘ç¹é˜»å¡ç”šè‡³æ­»é”ï¼Œå°†ä¼šå¤§å¤§é™ä½ç¨‹åºçš„å¹¶å‘èƒ½åŠ›ã€‚</p><p>æœåŠ¡ç«¯æ˜¯Javaè¯­è¨€æœ€æ“…é•¿çš„é¢†åŸŸä¹‹ä¸€ï¼Œè¿™ä¸ªé¢†å–çš„åº”ç”¨å äº†Javaåº”ç”¨ä¸­æœ€å¤§çš„ä¸€å—ä»½é¢ï¼Œä¸è¿‡å¦‚ä½•å†™å¥½å¹¶å‘åº”ç”¨ç¨‹åºç¡®å®ç¨‹åºå¼€å‘çš„éš¾ç‚¹ä¹‹ä¸€ï¼Œå¤„ç†å¥½å¹¶å‘æ–¹é¢çš„é—®é¢˜é€šå¸¸éœ€è¦æ›´å¤šçš„ç»éªŒã€‚<strong>æ— è®ºè¯­è¨€ã€ä¸­é—´ä»¶å’Œæ¡†æ¶å¦‚ä½•å…ˆè¿›ï¼Œæˆ‘ä»¬éƒ½ä¸èƒ½æœŸæœ›å®ƒä»¬èƒ½ç‹¬ç«‹å®Œæˆå¹¶å‘å¤„ç†çš„æ‰€æœ‰äº‹æƒ…ï¼Œäº†è§£å¹¶å‘çš„å†…å¹•ä¹Ÿæ˜¯ä¸å¯ç¼ºå°‘çš„è¯¾ç¨‹ã€‚</strong></p><h2 id="ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§"><a href="#ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§" class="headerlink" title="ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§"></a>ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§</h2><p>ç”±äºè®¡ç®—æœºçš„å­˜å‚¨è®¾å¤‡ä¸å¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦ä¹‹é—´æœ‰ç€å‡ ä¸ªæ•°é‡çº§çš„å·®è·ï¼Œæ‰€ä»¥ç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½ä¸å¾—ä¸åŠ å…¥ä¸€å±‚è¯»å†™å°½å¯èƒ½æ¥è¿‘å¤„ç†å™¨è¿ç®—é€Ÿåº¦çš„é«˜é€Ÿç¼“å­˜ï¼ˆCacheï¼‰æ¥ä½œä¸ºå†…å­˜ä¸å¤„ç†å™¨ä¹‹é—´çš„ç¼“å†²ï¼šå°†è¿ç®—éœ€è¦ä½¿ç”¨çš„æ•°æ®èµ‹å€¼åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚</p><p>åŸºäºé«˜é€Ÿç¼“å­˜çš„å­˜å‚¨äº¤äº’å¾ˆå¥½åœ°è§£å†³äº†å¤„ç†å™¨ä¸å†…å­˜åœ°é€Ÿåº¦çŸ›ç›¾ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼š<strong>ç¼“å­˜ä¸€è‡´æ€§ï¼ˆCache Coherenceï¼‰</strong>ã€‚æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±åœ°é«˜é€Ÿç¼“å­˜ï¼Œè€Œå®ƒä»¬åˆå…±äº«åŒä¸€ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ã€‚å½“å¤šä¸ªå¤„ç†å™¨åœ°è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåŒä¸€å—ä¸»å†…å­˜åŒºåŸŸæ—¶ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªåœ°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´åœ°æƒ…å†µã€‚ä¸ºäº†è§£å†³ä¸€è‡´æ€§åœ°é—®é¢˜ï¼Œéœ€è¦å„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®æ¥è¿›è¡Œæ“ä½œã€‚<strong>Javaè™šæ‹Ÿæœºå†…å­˜æ¨¡å‹ä¸­å®šä¹‰åœ°å†…å­˜è®¿é—®æ“ä½œä¸ç¡¬ä»¶åœ°ç¼“å­˜è®¿é—®æ“ä½œæ—¶å…·æœ‰å¯æ¯”æ€§åœ°ã€‚</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/WEKuAO.png" alt="å¤„ç†å™¨ã€é«˜é€Ÿç¼“å­˜ã€ä¸»å†…å­˜ä¹‹é—´åœ°äº¤äº’å…³ç³»"></p><p><strong>ä¸ºäº†ä½¿å¾—å¤„ç†å™¨å†…éƒ¨åœ°è¿ç®—å•å…ƒèƒ½å°½é‡è¢«å……åˆ†åˆ©ç”¨ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼ˆOut-Of-Order Executionï¼‰ä¼˜åŒ–ï¼Œå¤„ç†å™¨ä¼šåœ¨è®¡ç®—ä¹‹åå°†ä¹±åºæ‰§è¡Œåœ°ç»“æœé‡ç»„ï¼Œä¿è¯è¯¥ç»“æœä¸é¡ºåºæ‰§è¡Œåœ°ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä½†å¹¶ä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥è®¡ç®—çš„å…ˆåé¡ºåºä¸è¾“å…¥ä»£ç çš„é¡ºåºä¸€è‡´ï¼Œå› æ­¤å¦‚æœå­˜åœ¨ä¸€ä¸ªè®¡ç®—ä»»åŠ¡ä¾èµ–å¦ä¸€ä¸ªè®¡ç®—ä»»åŠ¡çš„ä¸­é—´ç»“æœï¼Œé‚£ä¹ˆå…¶é¡ºåºæ€§å¹¶ä¸èƒ½é ä»£ç çš„å…ˆåé¡ºåºæ¥ä¿è¯ã€‚ä¸å¤„ç†å™¨çš„ä¹±åºæ‰§è¡Œä¼˜åŒ–ç±»ä¼¼ï¼ŒJavaè™šæ‹Ÿæœºçš„å³æ—¶ç¼–è¯‘å™¨ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ä¼˜åŒ–ã€‚</strong></p><h2 id="Javaå†…å­˜æ¨¡å‹"><a href="#Javaå†…å­˜æ¨¡å‹" class="headerlink" title="Javaå†…å­˜æ¨¡å‹"></a>Javaå†…å­˜æ¨¡å‹</h2><p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥<strong>å®ç°Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å¹¶å‘æ•ˆæœã€‚</strong></p><h3 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"><a href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜" class="headerlink" title="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"></a>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h3><p>Javaå†…å­˜æ¨¡å‹çš„ä¸»è¦ç›®æ ‡æ˜¯<strong>å®šä¹‰ç¨‹åºä¸­å„ä¸ªå˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå³åœ¨è™šæ‹Ÿæœºä¸­å°†å˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºæ¥å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚</strong>æ­¤å¤„çš„å˜é‡ä¸Javaç¼–ç¨‹ä¸­æ‰€è¯´çš„å˜é‡æœ‰åŒºåˆ«ï¼Œå®ƒåŒ…æ‹¬äº†å®ä¾‹å­—æ®µã€é™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼Œ<strong>ä½†æ˜¯ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡ä¸æ–¹æ³•å‚æ•°ï¼Œå› ä¸ºåè€…æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œ</strong>ä¸ä¼šè¢«å…±äº«ï¼Œè‡ªç„¶å°±ä¸å­˜åœ¨ç«äº‰é—®é¢˜ã€‚</p><blockquote><p>ä¸ºäº†è·å¾—è¾ƒå¥½çš„æ‰§è¡Œæ•ˆèƒ½ï¼ŒJavaå†…å­˜æ¨¡å‹å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„ç‰¹å®šå¯„å­˜å™¨æˆ–ç¼“å­˜æ¥å’Œä¸»å†…å­˜è¿›è¡Œäº¤äº’ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶å³æ—¶ç¼–è¯‘å™¨è°ƒæ•´ä»£ç æ‰§è¡Œé¡ºåºè¿™ç±»æƒåˆ©ã€‚</p></blockquote><p><strong>Javaå†…å­˜æ¨¡å‹è§„å®šäº†æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ã€‚</strong>æ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆWorking Menoryï¼Œç±»æ¯”é«˜é€Ÿç¼“å­˜ï¼‰ï¼Œ<strong>çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚</strong>ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„å€¼ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/q9VXLj.png" alt="çº¿ç¨‹ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸‰è€…çš„äº¤äº’å…³ç³»"></p><p>è¿™é‡Œæ‰€è®²çš„ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸Javaå†…å­˜åŒºåŸŸä¸­çš„Javaå †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ã€‚<strong>ä»å˜é‡ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜çš„å®šä¹‰æ¥çœ‹ï¼Œä¸»å†…å­˜ä¸»è¦å¯¹åº”Javaå †ä¸­å¯¹è±¡çš„å®ä¾‹æ•°æ®éƒ¨åˆ†ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸã€‚</strong>ä»æ›´ä½çš„å±‚æ¬¡æ¥è¯´ï¼Œä¸»å†…å­˜å°±æ˜¯ç¡¬ä»¶çš„å†…å­˜ï¼Œè€Œä¸ºäº†è·å¾—æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹ŸæœºåŠç¡¬ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨ä¸å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ã€‚</p><h3 id="å†…å­˜é—´äº¤äº’æ“ä½œ"><a href="#å†…å­˜é—´äº¤äº’æ“ä½œ" class="headerlink" title="å†…å­˜é—´äº¤äº’æ“ä½œ"></a>å†…å­˜é—´äº¤äº’æ“ä½œ</h3><p>å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¹‹ç±»çš„å®ç°ç»†èŠ‚ï¼ŒJavaå†…å­˜æ¨¡å‹é¡¶äº†å…«ç§æ“ä½œæ¥å®Œæˆï¼š</p><ul><li>lockï¼ˆé”å®šï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çš„çŠ¶æ€ã€‚</li><li>unlockï¼ˆè§£é”ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚</li><li>readï¼ˆè¯»å–ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ã€‚</li><li>loadï¼ˆè½½å…¥ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»å†…ä¸»å†…å­˜å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚</li><li>useï¼ˆä½¿ç”¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨åˆ°å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚</li><li>assignï¼ˆèµ‹å€¼ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚</li><li>storeï¼ˆå­˜å‚¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeæ“ä½œä½¿ç”¨ã€‚</li><li>writeï¼ˆå†™å…¥ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚</li></ul><p>å¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜ï¼Œé‚£å°±è¦æŒ‰é¡ºåºæ‰§è¡Œ<code>read</code>å’Œ<code>load</code>æ“ä½œï¼Œå¦‚æœè¦æŠŠå˜é‡ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ï¼Œå°±è¦æŒ‰é¡ºåºåœ°æ‰§è¡Œ<code>store</code>å’Œ<code>write</code>æ“ä½œã€‚</p><blockquote><p>Javaå†…å­˜æ¨¡å‹åªè¦æ±‚ä¸Šè¿°ä¸¤ä¸ªæ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œè€Œæ²¡æœ‰ä¿è¯å¿…é¡»è¿ç»­æ‰§è¡Œã€‚</p></blockquote><p>Javaå†…å­˜æ¨¡å‹è¿˜è§„å®šäº†åœ¨æ‰§è¡Œä¸Šè¿°å…«ç§åŸºæœ¬æ“ä½œæ—¶å¿…é¡»æ»¡è¶³ï¼š</p><ul><li>ä¸å…è®¸<code>read</code>å’Œ<code>load</code>ã€<code>store</code>å’Œ<code>write</code>æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜è¯»å–äº†ä½†å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…ä»å·¥ä½œå†…å­˜å‘èµ·å›å†™äº†ä½†ä¸»å†…å­˜ä¸æ¥å—åœ°æƒ…å†µå‡ºç°ã€‚</li><li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒæœ€å¿Œä½ åœ°<code>assign</code>æ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚</li><li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°æŠŠæ•°æ®ä»çº¿ç¨‹åœ°å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</li><li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆ<code>load</code>æˆ–<code>assign</code>ï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½<code>use</code>å’Œ<code>store</code>æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº†<code>assign</code>å’Œ<code>load</code>æ“ä½œã€‚</li><li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ<code>lock</code>æ“ä½œï¼Œä½†lockæ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ<code>lock</code>åï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„<code>unlock</code>æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚</li><li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ<code>lock</code>æ“ä½œï¼Œå°†ä¼šæ™´ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ<code>load</code>æˆ–<code>assign</code>æ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚</li><li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢«<code>lock</code>æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ<code>unlock</code>æ“ä½œï¼›ä¹Ÿä¸å…è®¸<code>unlock</code>ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚</li><li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ<code>unlock</code>æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä½å†…å­˜ä¸­ï¼ˆæ‰§è¡Œ<code>store</code>å’Œ<code>write</code>æ“ä½œï¼‰ã€‚</li></ul><h3 id="å¯¹äºvolatileå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"><a href="#å¯¹äºvolatileå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™" class="headerlink" title="å¯¹äºvolatileå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"></a>å¯¹äºvolatileå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™</h3><blockquote><p>å…³é”®å­—<code>volatile</code>å¯ä»¥è¯´æ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„æœ€è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å®¹æ˜“è¢«æ­£ç¡®åœ°ã€å®Œæ•´åœ°ç†è§£ï¼Œä»¥è‡³äºå¾ˆå¤šæ—¶å€™éƒ½ä¸å»ä½¿ç”¨å®ƒï¼Œé‡åˆ°éœ€è¦å¤„ç†å¤šçº¿ç¨‹æ•°æ®ç«äº‰çš„æ—¶å€™ä¸€å¾‹ä½¿ç”¨<code>synchronize</code>æ¥è¿›è¡ŒåŒæ­¥ã€‚</p></blockquote><p><strong>å½“ä¸€ä¸ªå˜é‡è¢«å®šä¹‰æˆ<code>volatile</code>ä¹‹åï¼Œå®ƒå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼š</strong></p><h4 id="ç¬¬ä¸€"><a href="#ç¬¬ä¸€" class="headerlink" title="ç¬¬ä¸€"></a>ç¬¬ä¸€</h4><p><strong>ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§</strong>ï¼Œè¿™é‡Œçš„â€œå¯è§æ€§â€æ˜¯æŒ‡å½“ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œæ–°å€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯ä»¥ç«‹å³å¾—çŸ¥çš„ã€‚è€Œæ™®é€šå˜é‡ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œå˜é‡å€¼åœ¨çº¿ç¨‹é—´ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p><p><em><code>volatile</code>å˜é‡åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¸å­˜åœ¨ä¸€æ‰§è¡Œé—®é¢˜ï¼ˆåœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­<code>volatile</code>å˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯ç”±äºæ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½è¦å…ˆåˆ·æ–°ï¼Œæ‰§è¡Œå¼•æ“çœ‹ä¸åˆ°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºä¸å­˜åœ¨ä¸€æ‰§è¡Œé—®é¢˜ï¼‰ï¼Œä½†æ˜¯Javaé‡Œé¢çš„è¿ç®—å¹¶éåŸå­æ“ä½œï¼Œå¯¼è‡´<code>volatile</code>å˜é‡çš„è¿ç®—åœ¨å¹¶å‘ä¸‹ä¸€æ ·ä¸æ˜¯å®‰å…¨çš„ã€‚</em></p><p>ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨è§£é‡Šæ‰§è¡Œæ—¶ï¼Œè§£é‡Šå™¨å°†è¦è¿è¡Œè®¸å¤šè¡Œä»£ç æ‰èƒ½å®ç°å®ƒçš„è¯­ä¹‰ï¼Œå¦‚æœæ˜¯ç¼–è¯‘æ‰§è¡Œï¼Œä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤ä¹Ÿå¯èƒ½è½¬åŒ–æˆè‹¥å¹²æ¡æœ¬åœ°æœºå™¨ç æŒ‡ä»¤ã€‚</p><p><strong>ç”±äº<code>volatile</code>å˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œåœ¨ä¸ç¬¦åˆä»¥ä¸‹ä¸¤ç§è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸­ï¼Œä»ç„¶è¦é€šè¿‡æ·é”ï¼ˆä½¿ç”¨<code>synchronized</code>æˆ–<code>java.util.concurrent</code>ä¸­çš„åŸå­ç±»ï¼‰æ¥ä¿è¯åŸå­æ€§ã€‚</strong></p><ol><li>è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼ã€‚</li><li>å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚</li></ol><p>ä½¿ç”¨ä½¿ç”¨<code>volatile</code>æ¥æ§åˆ¶å¹¶å‘çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> shutdownRequested;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    shutdownRequested = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!shutdownRequested) &#123;</span><br><span class="line">        <span class="comment">// do stuff</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¬¬äºŒ"><a href="#ç¬¬äºŒ" class="headerlink" title="ç¬¬äºŒ"></a>ç¬¬äºŒ</h4><p><strong>ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</strong>ï¼Œæ™®é€šçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚<strong>å› ä¸ºåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç‚¹ï¼Œè¿™å°±æ˜¯Javaå†…å­˜æ¨¡å‹ä¸­æè¿°çš„æ‰€è°“çš„â€œçº¿ç¨‹å†…å­˜è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ï¼ˆWithin-Thread As-If-Serial Semanticsï¼‰ã€‚</strong></p><p>æŒ‡ä»¤é‡æ’åºä¼šå¹²æ‰°ç¨‹åºçš„å¹¶ç½šæ‰§è¡Œçš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map configOptions;</span><br><span class="line"><span class="keyword">char</span>[] configText;</span><br><span class="line"><span class="comment">// æ­¤å˜é‡å¿…é¡»å®šä¹‰ä¸ºvolatile</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// å‡è®¾ä»¥ä¸‹ä»£ç åœ¨çº¿ç¨‹Aä¸­æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿè¯»å–é…ç½®ä¿¡æ¯ï¼Œå½“è¯»å–å®Œæˆåï¼Œå°†initializedè®¾ç½®ä¸ºtrueæ¥é€šçŸ¥å…¶ä»–çº¿ç¨‹é…ç½®å¯ç”¨</span></span><br><span class="line">configOptions = <span class="keyword">new</span> HashMap();</span><br><span class="line">configText = readConfigFile(fileName);</span><br><span class="line">processConfigOptions(configText, configOptions);</span><br><span class="line">initialized = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡è®¾ä»¥ä¸‹ä»£ç åœ¨çº¿ç¨‹Bä¸­æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// ç­‰å¾…initializedä¸ºtrueï¼Œä»£è¡¨çº¿ç¨‹Aå·²ç»æŠŠé…ç½®ä¿¡æ¯åˆå§‹åŒ–å®Œæˆã€€</span></span><br><span class="line"><span class="keyword">while</span> (!initialized) &#123;</span><br><span class="line">    sleep();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨çº¿ç¨‹Aä¸­åˆå§‹åŒ–å¥½çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line">doSomethingWithConfig();</span><br></pre></td></tr></table></figure><p>è¿™æ®µä¼ªä»£ç æè¿°çš„åœºæ™¯ååˆ†å¸¸è§ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨å¤„ç†é…ç½®æ–‡ä»¶æ—¶ä¸€èˆ¬ä¸ä¼šå‡ºç°å¹¶å‘è€Œå·²ã€‚å¦‚æœ<code>initialized</code>æ²¡æœ‰ä½¿ç”¨<code>volatile</code>ä¿®é¥°ï¼Œå°±å¯èƒ½ä¼šç”±äºæŒ‡ä»¤é‡æ’åºçš„ä¼˜åŒ–ï¼Œå¯¼è‡´çº¿ç¨‹Aä¸­æœ€åä¸€å¥ä¸­çš„â€œinitialized = true;â€è¢«æå‰æ‰§è¡Œï¼Œè¿™æ ·çº¿ç¨‹Bä¸­ä½¿ç”¨é…ç½®ä¿¡æ¯çš„ä»£ç å°±å¯èƒ½å‡ºç°é”™è¯¯ï¼Œè€Œ<code>volatile</code>å¯ä»¥é¿å…è¿™ç±»æƒ…å†µçš„å‘ç”Ÿã€‚</p><h4 id="Javaå†…å­˜æ¨¡å‹ä¸­å¯¹volatileå˜é‡å®šä¹‰çš„ç‰¹æ®Šè§„åˆ™ã€‚"><a href="#Javaå†…å­˜æ¨¡å‹ä¸­å¯¹volatileå˜é‡å®šä¹‰çš„ç‰¹æ®Šè§„åˆ™ã€‚" class="headerlink" title="Javaå†…å­˜æ¨¡å‹ä¸­å¯¹volatileå˜é‡å®šä¹‰çš„ç‰¹æ®Šè§„åˆ™ã€‚"></a>Javaå†…å­˜æ¨¡å‹ä¸­å¯¹<code>volatile</code>å˜é‡å®šä¹‰çš„ç‰¹æ®Šè§„åˆ™ã€‚</h4><p>å‡å®šTè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼ŒVå’ŒWåˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ª<code>volatile</code>å‹å˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œ<code>read</code>ã€<code>load</code>ã€<code>use</code>ã€<code>asign</code>ã€<code>store</code>å’Œ<code>write</code>æ“ä½œæ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹çš„è§„åˆ™ï¼š</p><ul><li>åªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„å‰ä¸€ä¸ªåŠ¨ä½œæ—¶loadçš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡Œ<code>use</code>åŠ¨ä½œï¼›å¹¶ä¸”ï¼Œåªæœ‰çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„åä¸€ä¸ªåŠ¨ä½œæ—¶<code>use</code>çš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹Væ‰§è¡Œ<code>load</code>åŠ¨ä½œã€‚ç¨‹åºTå¯¹å˜é‡Vçš„<code>use</code>åŠ¨ä½œå¯ä»¥è®¤ä¸ºæ˜¯ä¸çº¿ç¨‹Tå¯¹å˜é‡Vçš„<code>load</code>å’Œ<code>read</code>åŠ¨ä½œç›¸å…³è”çš„ï¼Œå¿…é¡»ä¸€èµ·è¿ç»­å‡ºç°ã€‚ï¼ˆ<strong>è¿™æ¡è§„åˆ™è¦æ±‚åœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨Vå‰éƒ½å¿…é¡»ä»ä¸»å†…å­˜åˆ·æ–°æœ€å…ˆçš„å€¼ï¼Œç”¨äºä¿è¯èƒ½çœ‹è§å…¶ä»–çº¿ç¨‹å¯¹å˜é‡Væ‰€åšçš„ä¿®æ”¹åçš„å€¼</strong>ï¼‰ã€‚</li><li>åªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„å‰ä¸€ä¸ªåŠ¨ä½œæ—¶<code>assign</code>çš„æ—¶å€™ï¼Œ çº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡Œ<code>store</code>åŠ¨ä½œï¼›å¹¶ä¸”ï¼Œåªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡æ‰§è¡Œçš„åä¸€ä¸ªåŠ¨ä½œæ—¶<code>store</code>çš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡Œ<code>assign</code>åŠ¨ä½œã€‚çº¿ç¨‹Tå¯¹å˜é‡Vçš„<code>assign</code>åŠ¨ä½œå¯ä»¥è®¤ä¸ºæ˜¯ä¸çº¿ç¨‹Tå¯¹å˜é‡Vçš„<code>store</code>å’Œ<code>writy</code>åŠ¨ä½œç›¸å…³è”çš„ï¼Œå¿…é¡»ä¸€èµ·è¿ç»­å‡ºç°ï¼ˆ<strong>è¿™æ¡è§„åˆ™è¦æ±‚åœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä¿®æ”¹Våéƒ½å¿…é¡»ç«‹åˆ»åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼Œç”¨äºä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹åˆ°è‡ªå·±å¯¹å˜é‡Væ‰€åšçš„çš„ä¿®æ”¹</strong>ï¼‰ã€‚</li><li>å‡å®šåŠ¨ä½œAæ˜¯çº¿ç¨‹Tå¯¹å˜é‡Vå®æ–½çš„<code>use</code>æˆ–<code>assign</code>åŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œFæ˜¯ä¸åŠ¨ä½œAç›¸å…³è”çš„<code>load</code>å’Œ<code>store</code>åŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œPæ˜¯ä¸åŠ¨ä½œFç›¸åº”çš„å¯¹å˜é‡Vçš„<code>read</code>æˆ–<code>write</code>åŠ¨ä½œï¼›ç±»ä¼¼çš„ï¼Œå‡å®šåŠ¨ä½œBæ˜¯çº¿ç¨‹Tå¯¹å˜é‡Wå®æ–½çš„<code>use</code>æˆ–<code>assign</code>åŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œGæ˜¯ä¸åŠ¨ä½œBç›¸å…³çš„<code>load</code>æˆ–<code>store</code>åŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œQæ˜¯ä¸åŠ¨ä½œGç›¸åº”çš„å¯¹å˜é‡Wçš„<code>read</code>æˆ–<code>write</code>åŠ¨ä½œã€‚å¦‚æœAå…ˆäºBï¼Œé‚£ä¹ˆPå…ˆäºQï¼ˆ<strong>è¿™æ¡è§„åˆ™è¦æ±‚<code>volatile</code>ä¿®é¥°çš„å˜é‡ä¸å›å‘—æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œä¿è¯ä»£ç çš„æ‰§è¡Œé¡ºåºä¸ç¨‹åºçš„é¡ºåºç›¸åŒ</strong>ï¼‰ã€‚</li></ul><h3 id="å¯¹äºlongå’Œdoubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"><a href="#å¯¹äºlongå’Œdoubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™" class="headerlink" title="å¯¹äºlongå’Œdoubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"></a>å¯¹äºlongå’Œdoubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™</h3><p>Javaå†…å­˜æ¨¡å‹è¦æ±‚<code>lock</code>ã€<code>unlock</code>ã€<code>read</code>ã€<code>load</code>ã€<code>assign</code>ã€<code>use</code>ã€<code>store</code>å’Œ<code>write</code>è¿™å…«ä¸ªæ“ä½œéƒ½å…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯å¯¹äº64ä½çš„æ•°æ®ç±»å‹ï¼ˆ<code>long</code>å’Œ<code>double</code>ï¼‰ï¼Œåœ¨æ¨¡å‹ä¸­ç‰¹åˆ«å®šä¹‰äº†ä¸€æ¡å®½æ¾çš„è§„å®šï¼šå…è®¸è™šæ‹Ÿæœºå°†æ²¡æœ‰è¢«<code>volatile</code>ä¿®é¥°çš„64ä½æ•°æ®çš„è¯»å†™æ“ä½œåˆ’åˆ†ä¸ºä¸¤æ¬¡32ä½çš„æ“ä½œæ¥è¿›è¡Œï¼Œå³å…è®¸è™šæ‹Ÿæœºå®ç°é€‰æ‹©å¯ä»¥ä¸ä¿è¯64ä½æ•°æ®ç±»å‹çš„<code>load</code>ã€<code>store</code>ã€<code>read</code>å’Œ<code>write</code>è¿™å››ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œè¿™ç‚¹å°±æ˜¯æ‰€è°“çš„<strong>longå’Œdoubleçš„éåŸå­æ€§åå®š</strong>ã€‚åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸éœ€è¦å°†ç”¨åˆ°çš„longå’Œdoubleå˜é‡ä¸“é—¨å£°æ˜ä¸º<code>volatile</code>ã€‚</p><h3 id="åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§"><a href="#åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§" class="headerlink" title="åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§"></a>åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§</h3><p>Javaå†…å­˜æ¨¡å‹æ—¶å›´ç»•ç€åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†<strong>åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§</strong>è¿™ä¸‰ä¸ªç‰¹å¾æ¥å»ºç«‹çš„ã€‚</p><h4 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h4><p>ç”±Javaå†…å­˜æ¨¡å‹æ¥ç›´æ¥ä¿è¯çš„åŸå­æ€§å˜é‡æ“ä½œåŒ…æ‹¬<code>read</code>ã€<code>load</code>ã€<code>assign</code>ã€<code>use</code>ã€<code>store</code>å’Œ<code>write</code>è¿™å…­ä¸ªï¼Œå¤§è‡´å¯ä»¥è®¤ä¸ºåŸºæœ¬æ•°æ®ç±»å‹çš„è®¿é—®å’Œè¯»å†™æ—¶å…·å¤‡åŸå­æ€§çš„ã€‚</p><blockquote><p>å¦‚æœéœ€è¦ä¸€ä¸ªæ›´å¤§èŒƒå›´çš„åŸå­æ€§ä¿è¯ï¼ŒJavaå†…å­˜æ¨¡å‹æä¾›äº†<code>lock</code>å’Œ<code>unlock</code>æ“ä½œæ¥æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œå°½ç®¡è™šæ‹ŸæœºæœªæŠŠ<code>lock</code>å’Œ<code>unlock</code>æ“ä½œç›´æ¥å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ˜¯å´æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤<code>monitorenter</code>å’Œ<code>monitorexit</code>æ¥éšå¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ“ä½œï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç åæ˜ åˆ°Javaä»£ç ä¸­å°±æ˜¯ç—›ä¸å¿«â€”â€”<code>synchronized</code>å…³é”®å­—ï¼Œå› æ­¤åœ¨<code>synchronized</code>å—ä¹‹é—´çš„æ“ä½œä¹Ÿå…·å¤‡åŸå­æ€§ã€‚</p></blockquote><h4 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h4><p>å¯è§æ€§æ˜¯æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚<strong>Javaå†…å­˜æ¨¡å‹æ—¶é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°å¯è§æ€§çš„ï¼Œæ— è®ºæ˜¯æ™®é€šçš„å˜é‡è¿˜æ˜¯<code>volatile</code>å˜é‡éƒ½æ˜¯å¦‚æ­¤ï¼Œæ™®é€šå˜é‡ä¸<code>volatile</code>å˜é‡çš„åŒºåˆ«æ˜¯<code>volatile</code>çš„ç‰¹æ®Šè§„åˆ™ä¿è¯äº†æ–°å€¼èƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œä»¥åŠæ¯æ¬¡ä½¿ç”¨å‰ç«‹å³ä»ä¸»å†…å­˜åˆ·æ–°ã€‚</strong></p><blockquote><p>é™¤äº†<code>volatile</code>å¤–ï¼ŒJavaçš„<code>synchronized</code>å’Œ<code>final</code>å…³é”®å­—ä¹Ÿèƒ½å®ç°å¯è§æ€§ã€‚</p></blockquote><h4 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h4><p><strong>å¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚</strong>å‰åŠå¥æ˜¯æŒ‡â€œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ï¼ŒååŠå¥æ˜¯æŒ‡â€œæŒ‡ä»¤é‡æ’åºç°è±¡â€å’Œâ€œå·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿâ€ç°è±¡ã€‚</p><blockquote><p>Javaè¯­è¨€æä¾›äº†<code>volatile</code>å’Œ<code>synchronized</code>ä¸¤ä¸ªå…³é”®å­—æ¥ä¿è¯çº¿ç¨‹ä¹‹é—´çš„æ“ä½œçš„æœ‰åºæ€§ï¼Œ<code>volatile</code>å…³é”®å­—æœ¬èº«å°±åŒ…å«äº†ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„è¯­ä¹‰ï¼Œè€Œ<code>synchronized</code>åˆ™æ˜¯ç”±â€œä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ<code>lock</code>æ“ä½œâ€è¿™æ¡è§„åˆ™è·å¾—çš„ï¼Œè¿™ä¸ªè§„åˆ™å†³å®šäº†æŒæœ‰åŒä¸€ä¸ªé”çš„ä¸¤ä¸ªåŒæ­¥å—åªèƒ½ä¸²è¡Œåœ°è¿›å…¥ã€‚</p></blockquote><h3 id="å…ˆè¡Œå‘ç”ŸåŸåˆ™"><a href="#å…ˆè¡Œå‘ç”ŸåŸåˆ™" class="headerlink" title="å…ˆè¡Œå‘ç”ŸåŸåˆ™"></a>å…ˆè¡Œå‘ç”ŸåŸåˆ™</h3><p><strong>å…ˆè¡Œå‘ç”Ÿæ—¶Javaå†…å­˜æ¨¡å‹ä¸­å®šä¹‰çš„ä¸¤é¡¹æ“ä½œä¹‹é—´çš„ååºå…³ç³»ï¼Œå¦‚æœè¯´æ“ä½œAå…ˆè¡Œå‘ç”Ÿä¸æ“ä½œBï¼Œå…¶å®å°±æ˜¯è¯´åœ¨å‘ç”Ÿæ“ä½œBä¹‹å‰ï¼Œæ“ä½œAäº§ç”Ÿçš„å½±å“èƒ½å‘—æ“ä½œBè§‚å¯Ÿåˆ°</strong>ï¼Œâ€œå½±å“â€åŒ…æ‹¬ä¿®æ”¹äº†å†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ã€å‘é€äº†æ¶ˆæ¯ã€è°ƒç”¨äº†æ–¹æ³•ç­‰ã€‚</p><h4 id="Javaå†…å­˜æ¨¡å‹ä¸‹ä¸€äº›å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š"><a href="#Javaå†…å­˜æ¨¡å‹ä¸‹ä¸€äº›å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š" class="headerlink" title="Javaå†…å­˜æ¨¡å‹ä¸‹ä¸€äº›å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š"></a>Javaå†…å­˜æ¨¡å‹ä¸‹ä¸€äº›å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š</h4><ul><li>ç¨‹åºæ¬¡åºè§„åˆ™ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ç¨‹åºä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿä¸ä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚å‡†ç¡®çš„è¯´åº”è¯¥æ˜¯æ§åˆ¶æµé¡ºåºè€Œä¸æ˜¯ç¨‹åºä»£ç é¡ºåºï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚</li><li>ç®¡ç¨‹é”è§„åˆ™ï¼šä¸€ä¸ªunlockæ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„lockæ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯åŒä¸€ä¸ªé”ï¼Œè€Œåé¢æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚</li><li><code>volatile</code>å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª<code>volatile</code>å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„æ¯’æ“ä½œï¼Œè¿™é‡Œçš„åé¢åŒæ ·æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚</li><li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼š<code>Thread</code>å¯¹è±¡çš„<code>start()</code>æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</li><li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ã€‚</li><li>çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹<code>interrupt()</code>æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿã€‚</li><li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆå…ˆè¡Œå‘ç”Ÿäºå®ƒçš„<code>finalize()</code>æ–¹æ³•çš„å¼€å§‹ã€‚</li><li>ä¼ é€’æ€§ï¼šå¦‚æœæ“ä½œAå…ˆè¡Œå‘ç”Ÿäºæ“ä½œBï¼Œæ“ä½œBå…ˆè¡Œå‘ç”ŸäºCï¼Œé‚£å°±å¯ä»¥å¾—å‡ºAæ“ä½œå…ˆè¡Œå‘ç”Ÿäºæ“ä½œCçš„ç»“è®ºã€‚</li></ul><p><strong>äº‹ä»¶ä¸Šå…ˆåé¡ºåºä¸å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹é—´åŸºæœ¬æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¡¡é‡å¹¶å‘å®‰å…¨é—®é¢˜æ—¶ä¸è¦æ”¶åˆ°äº‹ä»¶é¡ºåºçš„å¹²æ‰°ï¼Œä¸€åˆ‡å¿…é¡»ä»¥å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¸ºå‡†ã€‚</strong></p><h2 id="Javaä¸çº¿ç¨‹"><a href="#Javaä¸çº¿ç¨‹" class="headerlink" title="Javaä¸çº¿ç¨‹"></a>Javaä¸çº¿ç¨‹</h2><p><em>å¹¶å‘ä¸ä¸€å®šè¦ä¾èµ–å¤šçº¿ç¨‹ï¼Œä½†æ˜¯åœ¨Javaé‡Œé¢è°ˆè®ºå¹¶å‘ï¼Œå¤§å¤šæ•°éƒ½ä¸çº¿ç¨‹è„±ä¸å¼€å…³ç³»ã€‚</em></p><h3 id="çº¿ç¨‹çš„å®ç°"><a href="#çº¿ç¨‹çš„å®ç°" class="headerlink" title="çº¿ç¨‹çš„å®ç°"></a>çº¿ç¨‹çš„å®ç°</h3><p>ä¸»æµçš„æ“ä½œç³»ç»Ÿéƒ½æä¾›äº†çº¿ç¨‹å®ç°ï¼Œ<strong>Javaè¯­è¨€åˆ™æä¾›äº†åœ¨ä¸åŒç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå¹³å°ä¸‹å¯¹çº¿ç¨‹æ“ä½œçš„ç»Ÿä¸€å¤„ç†ï¼Œæ¯ä¸ª<code>java.lang.Thread</code>ç±»çš„å®ä¾‹å°±ä»£è¡¨äº†ä¸€ä¸ªçº¿ç¨‹ã€‚</strong>ä¸è¿‡Threadç±»ä¸å¤§éƒ¨åˆ†çš„Java APIæœ‰ç€æ˜¾è‘—çš„åŒºåˆ«ï¼Œå®ƒçš„æ‰€æœ‰å…³é”®æ–¹æ³•éƒ½è¢«å£°æ˜ä¸ºNativeã€‚åœ¨Java APIä¸­ä¸€ä¸ªNativeæ–¹æ³•å¯èƒ½å°±ä»¥ä¸ºç€è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨å¹³å°æ— å…³çš„æ‰‹æ®µæ¥å®ç°ã€‚</p><p>å®ç°çº¿ç¨‹ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š<strong>ä½¿ç”¨å†…æ ¸å®ç°ï¼Œä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°ï¼Œä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°ã€‚</strong></p><h4 id="ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°"><a href="#ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°" class="headerlink" title="ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°"></a>ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°</h4><p>ç›´æ¥ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒçš„çº¿ç¨‹ï¼Œè¿™ç§çº¿ç¨‹ç”±å†…æ ¸çº¿ç¨‹æ¥å®Œæˆåˆ‡æ¢ï¼Œå†…æ ¸é€šè¿‡æ“çºµè°ƒåº¦å™¨å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œå¹¶è´Ÿè´£å°†çº¿ç¨‹çš„ä»»åŠ¡æ˜ å°„åˆ°å„ä¸ªå¤„ç†å™¨ä¸Šã€‚<strong>ç¨‹åºä¸€èˆ¬ä¸ä¼šç›´æ¥å»ä½¿ç”¨å†…æ ¸çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨å†…æ ¸çº¿ç¨‹çš„ä¸€ç§é«˜çº§æ¥å£â€”â€”è½»é‡çº§è¿›ç¨‹ï¼Œè½»é‡çº§è¿›ç¨‹å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šæ‰€å°†çš„çº¿ç¨‹ï¼Œç”±äºæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½ç”±ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ”¯æŒï¼Œå› æ­¤åªæœ‰å…ˆæ”¯æŒå†…æ ¸çº¿ç¨‹ï¼Œæ‰èƒ½æœ‰è½»é‡çº§è¿›ç¨‹ã€‚</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/uzlRTG.png" alt="è½»é‡çº§è¿›ç¨‹ä¸å†…æ ¸çº¿ç¨‹ä¹‹é—´1:1çš„å…³ç³»"></p><p>ç”±äºå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå³ä½¿æœ‰ä¸€ä¸ªè½»é‡çº§è¿›ç¨‹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­é˜»å¡äº†ï¼Œä¹Ÿä¸ä¼šå½±å“æ•´ä¸ªè¿›ç¨‹ç»§ç»­å·¥ä½œï¼Œä½†æ˜¯è½»é‡çº§è¿›ç¨‹å…·æœ‰å®ƒçš„å±€é™æ€§ï¼š<strong>é¦–å…ˆï¼Œç”±äºæ˜¯åŸºäºå†…æ ¸çº¿ç¨‹å®ç°çš„ï¼Œæ‰€ä»¥å„ç§è¿›ç¨‹æ“ä½œï¼Œå¦‚åˆ›å»ºã€ææ„åŠåŒæ­¥ï¼Œéƒ½éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</strong>è€Œç³»ç»Ÿè°ƒç”¨çš„ä»£ä»·ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸­æ¥å›åˆ‡æ¢ã€‚å…¶æ¬¡ï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œå› æ­¤è½»é‡çº§è¿›ç¨‹è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼Œå› æ­¤ä¸€ä¸ªç³»ç»Ÿæ”¯æŒè½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚</p><h4 id="ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°"><a href="#ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°" class="headerlink" title="ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°"></a>ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°</h4><p>å¹¿ä¹‰ä¸Šæ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹åªè¦ä¸æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œé‚£å°±å¯ä»¥è®¤ä¸ºæ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œå› æ­¤ä»è¿™ä¸ªå®šä¹‰ä¸Šæ¥è®²è½»é‡çº§è¿›ç¨‹ä¹Ÿå±äºç”¨æˆ·çº¿ç¨‹ï¼Œä½†è½»é‡çº§è¿›ç¨‹çš„å®ç°å§‹ç»ˆæ˜¯å»ºç«‹åœ¨å†…æ ¸ä¹‹ä¸Šçš„ï¼Œè®¸å¤šæ“ä½œéƒ½è¦è¿›è¡Œç³»ç»Ÿå—²ç”¨ï¼Œå› æ­¤æ•ˆç‡ä¼šæ”¶åˆ°é™åˆ¶ã€‚</p><p>ç‹­ä¹‰ä¸Šæ¥è®²ï¼Œç”¨æˆ·çš„çº¿ç¨‹æŒ‡çš„æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´çš„çº¿ç¨‹åº“ä¸Šï¼Œç³»ç»Ÿå†…æ ¸ä¸èƒ½æ„ŸçŸ¥åˆ°çº¿ç¨‹å­˜åœ¨çš„å®ç°ã€‚<strong>ç”¨æˆ·çº¿ç¨‹çš„å»ºç«‹ã€åŒæ­¥ã€é”€æ¯å’Œè°ƒåº¦å®Œå…¨åœ¨ç”¨æˆ·æ€ä¸­å®Œæˆï¼Œä¸éœ€è¦å†…æ ¸çš„å¸®åŠ©ã€‚</strong>å¦‚æœç¨‹åºå®ç°å¾—å½“ï¼Œè¿™ç§çº¿ç¨‹ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå› æ­¤æ“ä½œå¯ä»¥æ˜¯éå¸¸å¿«ä¸”ä½æ¶ˆè€—çš„ï¼Œä¹Ÿå¯ä»¥æ”¯æŒè§„æ¨¡æ›´å¤§çš„çº¿ç¨‹æ•°é‡ï¼Œéƒ¨åˆ†é«˜æ€§èƒ½æ•°æ®åº“ä¸­çš„å¤šçº¿ç¨‹å°±æ˜¯ç”±ç”¨æˆ·çº¿ç¨‹å®ç°çš„ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/eMtx7A.png" alt="è¿›ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ä¹‹é—´1:Nçš„å…³ç³»"></p><p><em>ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹çš„ä¼˜åŠ¿åœ¨äºä¸éœ€è¦ç³»ç»Ÿå†…æ ¸æ”¯æ´ï¼ŒåŠ£åŠ¿åœ¨äºæ²¡æœ‰ç³»ç»Ÿå†…æ ¸çš„æ”¯æ´ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æ“ä½œéƒ½éœ€è¦ç”¨æˆ·ç¨‹åºè‡ªå·±å¤„ç†ã€‚</em>çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢å’Œè°ƒåº¦éƒ½æ˜¯éœ€è¦è€ƒè™‘é—®é¢˜ã€‚</p><h4 id="æ··åˆå®ç°"><a href="#æ··åˆå®ç°" class="headerlink" title="æ··åˆå®ç°"></a>æ··åˆå®ç°</h4><p>çº¿ç¨‹é™¤äº†ä¾èµ–å†…æ ¸çº¿ç¨‹å®ç°å’Œå®Œå…¨ç”±ç”¨æˆ·ç¨‹åºè‡ªå·±å®ç°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°†å†…æ ¸çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·ä½¿ç”¨çš„å®ç°æ–¹å¼ã€‚åœ¨è¿™ç§æ··åˆå®ç°ä¸‹ï¼Œæ—¢æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œä¹Ÿå­˜åœ¨è½»é‡çº§è¿›ç¨‹ã€‚ç”¨æˆ·å¿åŸè¿˜æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œå› æ­¤ç”¨æˆ·çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€ææ„ç­‰æ“ä½œä¾ç„¶å»‰ä»·ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒå¤§è§„æ¨¡çš„ç”¨æˆ·çº¿ç¨‹å¹¶å‘ã€‚è€Œæ“ä½œç³»ç»Ÿæä¾›æ”¯æŒçš„è½»é‡çº§è¿›ç¨‹åˆ™ä½œä¸ºç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹ä¹‹é—´çš„æ¡¥æ¢ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨å†…æ ¸æä¾›çš„çº¿ç¨‹è°ƒåº¦åŠŸèƒ½åŠå¤„ç†å™¨æ˜ å°„ï¼Œå¹¶ä¸”ç”¨æˆ·çº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨è¦é€šè¿‡è½»é‡çº§çº¿ç¨‹æ¥å®Œæˆï¼Œå¤§å¤§é™ä½äº†è¿›ç¨‹è¢«é˜»å¡çš„é£é™©ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/GMf8rD.png" alt="ç”¨æˆ·çº¿ç¨‹ä¸è½»é‡çº§è¿›ç¨‹ä¹‹é—´M:Nçš„å…³ç³»"></p><h4 id="Javaçº¿ç¨‹çš„å®ç°"><a href="#Javaçº¿ç¨‹çš„å®ç°" class="headerlink" title="Javaçº¿ç¨‹çš„å®ç°"></a>Javaçº¿ç¨‹çš„å®ç°</h4><p>æ“ä½œç³»ç»Ÿæ”¯æŒæ€æ ·çš„çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨å¾ˆå¤§æˆéƒ½ä¸Šå°±å†³å®šäº†Javaè™šæ‹Ÿæœºçš„çº¿ç¨‹æ˜¯æ€ä¹ˆæ ·æ˜ å°„çš„ï¼Œè¿™ç‚¹åœ¨ä¸åŒçš„å¹³å°ä¸Šæ²¡æœ‰åŠæ³•è¾¾æˆä¸€è‡´ï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿå¹¶æœªé™å®šJavaçº¿ç¨‹éœ€è¦ä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹æ¥å®ç°ã€‚</p><h3 id="Javaçº¿ç¨‹è°ƒåº¦"><a href="#Javaçº¿ç¨‹è°ƒåº¦" class="headerlink" title="Javaçº¿ç¨‹è°ƒåº¦"></a>Javaçº¿ç¨‹è°ƒåº¦</h3><p>çº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é…å¤„ç†å™¨ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œä¸»è¦è°ƒåº¦æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<strong>ååŒå¼çº¿ç¨‹è°ƒåº¦å’ŒæŠ¢å å¼çº¿ç¨‹è°ƒåº¦ã€‚</strong></p><h4 id="ååŒå¼è°ƒåº¦"><a href="#ååŒå¼è°ƒåº¦" class="headerlink" title="ååŒå¼è°ƒåº¦"></a>ååŒå¼è°ƒåº¦</h4><p>çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ¥æ§åˆ¶ï¼Œçº¿ç¨‹æŠŠè‡ªå·±çš„å·¥ä½œæ‰§è¡Œå®Œäº†ä¹‹åï¼Œè¦ä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸Šå»ã€‚ååŒå¼å¤šçº¿ç¨‹çš„æœ€å¤§å¥½å¤„æ˜¯å®ç°ç®€å•ï¼Œè€Œä¸”ç”±äºçº¿ç¨‹è¦æŠŠè‡ªå·±çš„äº‹æƒ…å¹²å®Œåæ‰ä¼šè¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œåˆ‡æ¢æ“ä½œå¯¹çº¿ç¨‹è‡ªå·±æ˜¯å¯çŸ¥çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p><h4 id="æŠ¢å å¼è°ƒåº¦"><a href="#æŠ¢å å¼è°ƒåº¦" class="headerlink" title="æŠ¢å å¼è°ƒåº¦"></a>æŠ¢å å¼è°ƒåº¦</h4><p>æ¯ä¸ªçº¿ç¨‹ç”±ç³»ç»Ÿæ¥åˆ†é…æ‰§è¡Œæ—¶é—´ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸ç”±çº¿ç¨‹æœ¬èº«æ¥å†³å®šã€‚åœ¨è¿™ç§å®ç°çº¿ç¨‹è°ƒåº¦çš„æ–¹å¼ä¸‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´æ˜¯ç³»ç»Ÿå¯æ§çš„ï¼Œä¹Ÿä¸ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¼è‡´æ•´ä¸ªè¿›ç¨‹é˜»å¡çš„é—®é¢˜ï¼Œ<strong>Javaä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ–¹å¼å°±æ˜¯æŠ¢å å¼è°ƒåº¦ã€‚</strong></p><h3 id="çŠ¶æ€è½¬æ¢"><a href="#çŠ¶æ€è½¬æ¢" class="headerlink" title="çŠ¶æ€è½¬æ¢"></a>çŠ¶æ€è½¬æ¢</h3><p>Javaå®šä¹‰äº†5ç§è¿›ç¨‹çŠ¶æ€ï¼Œåœ¨ä»»æ„ä¸€ä¸ªæ—¶é—´ç‚¹ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹åªèƒ½ç”±ä¸”åªæœ‰ä¸€ç§çŠ¶æ€ï¼š</p><ul><li>æ–°å»ºï¼šåˆ›å»ºåå°šæœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€</li><li>è¿è¡Œï¼šRunableåŒ…æ‹¬äº†æ“ä½œç³»ç»Ÿçº¿ç¨‹çŠ¶æ€ä¸­çš„Runningå’ŒReadyï¼Œä¹Ÿå°±æ˜¯å¤„äºæ­¤çŠ¶æ€çš„çº¿ç¨‹æœ‰å¯èƒ½æ­£åœ¨æ‰§è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½æ­£åœ¨ç­‰å¾…ç€CPUä¸ºå®ƒåˆ†é…æ‰§è¡Œæ—¶é—´ã€‚</li><li>æ— é™æœŸç­‰å¾…ï¼šå¤„äºè¿™ç§çŠ¶æ€çš„è¿›ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œå®ƒä»¬è¦ç­‰å¾…è¢«å…¶ä»–çº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ã€‚ä»¥ä¸‹æ–¹æ³•ä¼šè®©çº¿ç¨‹é™·å…¥æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼š<ul><li>æ²¡æœ‰è®¾ç½®Timeoutå‚æ•°åœ°Object.wait()æ–¹æ³•ã€‚</li><li>æ²¡æœ‰è®¾ç½®Timeoutå‚æ•°åœ°Thread.join()æ–¹æ³•ã€‚</li><li>LockSupport.park()æ–¹æ³•ã€‚</li></ul></li><li>é™æœŸç­‰å¾…ï¼šå¤„äºè¿™ç§çŠ¶æ€çš„è¿›ç¨‹ä¹Ÿä¸ä¼šåˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œä¸è¿‡æ— é¡»ç­‰å¾…è¢«å…¶ä»–çº¿ç¨‹æ˜¾å¼å”¤é†’ï¼Œåœ¨ä¸€å®šæ—¶é—´ä¹‹åä»–ä»¬ä¼šç”±ç³»ç»Ÿè‡ªåŠ¨å”¤é†’ã€‚ä»¥ä¸‹æ–¹æ³•ä¼šè®©çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…çŠ¶æ€ï¼š<ul><li>Thread.sleep()æ–¹æ³•ã€‚</li><li>è®¾ç½®äº†Timeoutå‚æ•°çš„Object.wait()æ–¹æ³•ã€‚</li><li>è®¾ç½®äº†Timeoutå‚æ•°çš„Thread.join()æ–¹æ³•ã€‚</li><li>LockSupport.parkNanos()æ–¹æ³•ã€‚</li><li>LockSupport.parkUntil()æ–¹æ³•ã€‚</li></ul></li><li>é˜»å¡ï¼šè¿›ç¨‹è¢«é˜»å¡äº†ï¼Œé˜»å¡çŠ¶æ€åœ¨ç­‰å¾…ç€è·å–åˆ°ä¸€ä¸ªæ’ä»–é”ï¼Œè¿™ä¸ªäº‹ä»¶å°†åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒè¿™ä¸ªé”çš„æ—¶å€™å‘ç”Ÿï¼›ç­‰å¾…çŠ¶æ€åˆ™æ˜¯åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…å”¤é†’åŠ¨ä½œçš„å‘ç”Ÿã€‚åœ¨ç¨‹åºç­‰å¾…è¿›å…¥åŒæ­¥åŒºåŸŸçš„æ—¶å€™ï¼Œ çº¿ç¨‹å°†è¿›å…¥è¿™ç§çŠ¶æ€ã€‚</li><li>ç»“æŸï¼šå·²ç»ˆæ­¢çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ï¼Œçº¿ç¨‹å·²ç»ç»“æŸæ‰§è¡Œã€‚</li></ul><p>çº¿ç¨‹çŠ¶æ€è½¬æ¢å…³ç³»ï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/a34Lkz.png" alt="çº¿ç¨‹çŠ¶æ€è½¬æ¢å…³ç³»"></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>äº†è§£äº†è™šæ‹ŸæœºJavaå†…å­˜æ¨¡å‹çš„ç»“æ„åŠæ“ä½œï¼Œè®²è§£äº†åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§åœ¨Javaå†…å­˜æ¨¡å‹ä¸­çš„ä½“ç°ï¼Œå…ˆè¡Œå‘ç”ŸåŸåˆ™çš„è§„åˆ™åŠä½¿ç”¨ã€‚è¿˜æœ‰çº¿ç¨‹åœ¨Javaè¯­è¨€ä¹‹ä¸­æ—¶å¦‚ä½•å®ç°çš„ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾</li><li><a href="https://www.google.com/imghp?hl=zh-CN&tab=wi">å›¾ç‰‡æ¥æº</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“</title>
      <link href="/blog/2018/09/16/4cd43d51.html"/>
      <url>/blog/2018/09/16/4cd43d51.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»£ç ç¼–è¯‘çš„ç»“æœä»æœ¬åœ°æœºå™¨ç å˜ä¸ºå­—èŠ‚ç ï¼Œæ˜¯å­˜å‚¨æ ¼å¼å‘å±•çš„ä¸€å°æ­¥ï¼Œç¡®å®ç¼–ç¨‹è¯­è¨€å‘å±•çš„ä¸€å¤§æ­¥</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>æ‰§è¡Œå¼•æ“æ˜¯Javaè™šæ‹Ÿæœºæœ€æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¡¬ä»¶ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œ<strong>è™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è‡ªå·±å®ç°çš„ï¼Œå› æ­¤å¯ä»¥è‡ªè¡Œåˆ¶å®šæŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‰§è¡Œå“ªäº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†å¤Ÿæ ¼å¼ã€‚</strong></p><p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­åˆ¶å®šäº†è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“çš„æ¦‚å¿µæ¨¡å‹ï¼Œè¿™ä¸ªæ¦‚å¿µæ¨¡å‹æˆä¸ºå„ç§è™šæ‹Ÿæœºæ‰§è¡Œå¼•æ“çš„ç»Ÿä¸€å¤–è§‚ï¼ˆFacadeï¼‰ã€‚åœ¨ä¸åŒçš„è™šæ‹Ÿæœºå®ç°é‡Œé¢ï¼Œæ‰§è¡Œå¼•æ“åœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™å¯èƒ½æœ‰<strong>è§£é‡Šæ‰§è¡Œï¼ˆé€šè¿‡è§£é‡Šå™¨æ‰§è¡Œï¼‰</strong>å’Œ<strong>ç¼–è¯‘æ‰§è¡Œï¼ˆé€šè¿‡å³æ—¶ç¼–è¯‘å™¨äº§ç”Ÿæœ¬åœ°ä»£ç æ‰§è¡Œï¼‰</strong>ä¸¤ç§é€‰æ‹©ï¼Œä¹Ÿå¯èƒ½ä¸¤è€…å…¼å¤‡ï¼Œç”šè‡³è¿˜å¯èƒ½åŒ…å«å‡ ä¸ªä¸åŒçº§åˆ«çš„ç¼–è¯‘å™¨æ‰§è¡Œå¼•æ“ã€‚ä½†ä»å¤–è§‚ä¸Šçœ‹èµ·æ¥ï¼Œ<strong>æ‰€æœ‰Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“éƒ½æ˜¯ä¸€è‡´çš„ï¼šè¾“å…¥çš„æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£æçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œç»“æœã€‚</strong></p><h2 id="è¿è¡Œæ—¶æ ˆå¸§ç»“æ„"><a href="#è¿è¡Œæ—¶æ ˆå¸§ç»“æ„" class="headerlink" title="è¿è¡Œæ—¶æ ˆå¸§ç»“æ„"></a>è¿è¡Œæ—¶æ ˆå¸§ç»“æ„</h2><p>æ ˆå¸§ï¼ˆStack Frameï¼‰æ˜¯ç”¨äºæ”¯æŒè™šæ‹Ÿæœºè¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºä¸­çš„è™šæ‹Ÿæœºæ ˆçš„æ ˆå…ƒç´ ã€‚<strong>æ ˆå¸§å­˜å‚¨çš„æ–¹æ³•çš„çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥å’Œæ–¹æ³•è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚</strong> <em>æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨å¼€å§‹åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆé‡Œé¢ä»å…¥æ ˆé“å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</em></p><blockquote><p>æ¯ä¸€ä¸ªæ ˆå¸§éƒ½åŒ…æ‹¬äº†å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€å’Œä¸€äº›é¢å¤–çš„é™„åŠ ä¿¡æ¯ã€‚åœ¨ç¼–è¯‘ç¨‹åºä»£ç çš„æ—¶å€™ï¼Œæ ˆå¸§ä¸­éœ€è¦å¤šå¤§çš„å±€éƒ¨å˜é‡è¡¨ã€å¤šæ·±çš„æ“ä½œæ•°æ ˆéƒ½å·²ç»å®Œå…¨ç¡®å®šäº†ï¼Œå¹¶ä¸”å†™å…¥åˆ°æ–¹æ³•è¡¨çš„<code>Code</code>å±æ€§ä¹‹ä¸­ï¼Œå› æ­¤<strong>ä¸€ä¸ªæ ˆå¸§éœ€è¦åˆ†é…å¤šå°‘å†…å­˜ï¼Œä¸ä¼šæ”¶åˆ°ç¨‹åºè¿è¡ŒæœŸå˜é‡æ•°æ®çš„å½±å“ï¼Œè€Œä»…ä»…å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°</strong>ã€‚</p></blockquote><p>ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ–¹æ³•è°ƒç”¨é“¾å¯èƒ½å›å¾ˆé•¿ï¼Œå¾ˆå¤šæ–¹æ³•éƒ½åŒäº‹å¤„äºæ‰§è¡ŒçŠ¶æ€ã€‚å¯¹äºæ‰§è¡Œå¼•æ“æ¥è®²ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œåªæœ‰æ ˆé¡¶æ˜¯æœ‰æ•ˆçš„ï¼Œç§°ä¸ºå½“å‰æ ˆå¸§ï¼Œè¿™ä¸ªæ ˆå¸§æ‰€å…³è”çš„æ–¹æ³•ç§°ä¸ºå½“å‰æ–¹æ³•ã€‚<strong>æ‰§è¡Œå¼•æ“æ‰€è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤éƒ½åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚</strong></p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/EZRTAh.png" alt="æ ˆå¸§çš„æ¦‚å¿µç»“æ„"></p><h3 id="å±€éƒ¨å˜é‡è¡¨"><a href="#å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="å±€éƒ¨å˜é‡è¡¨"></a>å±€éƒ¨å˜é‡è¡¨</h3><p><strong>å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œç”¨äºå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚Javaç¨‹åºè¢«ç¼–è¯‘ä¸ºClassæ–‡ä»¶æ—¶ï¼Œå°±åœ¨æ–¹æ³•çš„Codeå±æ€§çš„mac_localsæ•°æ®é¡¹ä¸­ç¡®å®šäº†è¯¥æ–¹æ³•æ‰€éœ€è¦åˆ†é…çš„æœ€å¤§å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ã€‚</strong></p><p>å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ä»¥å˜é‡æ§½ï¼ˆVariable Slotï¼‰ä¸ºæœ€å°å•ä½ï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®æŒ‡æ˜ä¸€ä¸ªSlotåº”å å†…å­˜ç©ºé—´å¤§å°ï¼Œåªæ˜¯è¯´æ˜æ¯ä¸ªSlotéƒ½åº”è¯¥èƒ½å­˜æ”¾ä¸€ä¸ªbooleanã€btyeã€charã€shortã€intã€floatã€referenceæˆ–returnAddressç±»å‹çš„æ•°æ®ï¼Œå®ƒå…è®¸Slotçš„é•¿åº¦éšç€å¤„ç†å™¨ã€æ“ä½œç³»ç»Ÿæˆ–è™šæ‹Ÿæœºçš„ä¸åŒè€Œå‘ç”Ÿå˜åŒ–ã€‚<strong>ä¸è¿‡æ— è®ºå¦‚ä½•ï¼Œå³ä½¿åœ¨64ä½è™šæ‹Ÿæœºä¸­ä½¿ç”¨äº†64ä½é•¿åº¦çš„å†…å­˜ç©ºé—´é‡Œçˆ±å®ç°ä¸€ä¸ªSlotï¼Œè™šæ‹Ÿæœºä»è¦ä½¿ç”¨å¯¹é½å’Œè¡¥ç™½çš„æ‰‹æ®µè®©Slotåœ¨å¤–è§‚ä¸Šçœ‹èµ·æ¥ä¸32ä½è™šæ‹Ÿæœºçš„ä¸€è‡´ã€‚</strong></p><blockquote><p>å¯¹äº64ä½çš„æ•°æ®ç±»å‹ï¼Œè™šæ‹Ÿæœºä¼šä»¥é«˜ä½åœ¨å‰çš„æ–¹å¼ä¸ºå…¶åˆ†é…ä¸¤ä¸ªè¿ç»­çš„Slotç©ºé—´ã€‚Javaè¯­è¨€ä¸­æ˜ç¡®è§„å®šçš„64ä½çš„æ•°æ®ç±»å‹åªæœ‰longå’Œdoubleä¸¤ç§ã€‚</p><p><strong>è¿™é‡ŒæŠŠlongå’Œdoubleæ•°æ®ç±»å‹åˆ†å‰²å­˜å‚¨çš„åšæ³•ä¸â€œlongå’Œdoubleçš„éåŸå­æ€§åå®šâ€ä¸­æŠŠlongå’Œdoubleæ•°æ®ç±»å‹è¯»å†™åˆ†å‰²ä¸ºä¸¤æ¬¡32ä½è¯»å†™çš„åšæ³•ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œç”±äºå±€éƒ¨å˜é‡è¡¨å»ºç«‹åœ¨çº¿ç¨‹çš„å¯¹æˆ˜ä¸Šï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œæ— è®ºè¯»å†™ä¸¤ä¸ªè¿ç»­çš„Slotæ˜¯å¦æ˜¯åŸå­æ“ä½œï¼Œéƒ½ä¸ä¼šå¼•èµ·æ•°æ®å®‰å…¨é—®é¢˜ã€‚</strong></p></blockquote><p>è™šæ‹Ÿæœºé€šè¿‡ç´¢å¼•å®šä½çš„æ–¹å¼ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨ï¼Œç´¢å¼•å€¼çš„èŒƒå›´æ˜¯ä»0å¼€å§‹åˆ°å±€éƒ¨å˜é‡è¡¨æœ€å¤§çš„Slotå˜é‡ã€‚å¦‚æœæ˜¯32ä½æ•°æ®ç±»å‹çš„å˜é‡ï¼Œç´¢å¼•nå°±ä»£è¡¨äº†ä½¿ç”¨ç¬¬nä¸ªSlotï¼Œå¦‚æœæ˜¯64ä½æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™è¯´æ˜è¦ä½¿ç”¨ç¬¬nå’Œç¬¬n+1ä¸¤ä¸ªSlotã€‚</p><h3 id="æ“ä½œæ•°æ ˆ"><a href="#æ“ä½œæ•°æ ˆ" class="headerlink" title="æ“ä½œæ•°æ ˆ"></a>æ“ä½œæ•°æ ˆ</h3><p><strong>æ“ä½œæ•°æ ˆä¹Ÿå¸¸è¢«ç§°ä¸ºæ“ä½œæ ˆï¼Œæ˜¯ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLast In First Outï¼ŒLIFOï¼‰æ ˆã€‚</strong>åŒå±€éƒ¨å˜é‡è¡¨ä¸€æ ·ï¼Œæ“ä½œæ ˆçš„æœ€å¤§æ·±åº¦ä¹Ÿåœ¨ç¼–è¯‘çš„æ—¶å€™è¢«å†™å…¥åˆ°Codeå±æ€§çš„max_stacksæ•°æ®é¡¹ä¸­ã€‚æ“ä½œæ ˆçš„æ¯ä¸€ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„Javaæ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬longå’Œdoubleã€‚32ä½çš„æ•°æ®ç±»å‹æ‰€æ ˆçš„æ ˆå®¹é‡ä¸º1ï¼Œ64ä½çš„æ•°æ®ç±»å‹æ‰€å çš„æ ˆå®¹é‡ä¸º2ã€‚<strong>åœ¨æ–¹æ³•æ‰§è¡Œçš„ä»»ä½•æ—¶å€™ï¼Œæ“ä½œæ•°æ ˆçš„æ·±åº¦éƒ½ä¸ä¼šè¶…è¿‡åœ¨max_stacksæ•°æ®é¡¹ä¸­è®¾å®šçš„æœ€å¤§å€¼ã€‚</strong></p><p>å½“ä¸€ä¸ªæ–¹æ³•åˆšåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å„ç§å­—èŠ‚ç æŒ‡ä»¤å‘æ“ä½œæ•°æ ˆä¸­å†™å…¥å’Œæå–å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å…¥æ ˆå‡ºæ ˆæ“ä½œã€‚</p><blockquote><p>ä¾‹å¦‚ï¼Œåœ¨åšç®—æœ¯è¿ç®—çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œçš„ï¼Œåˆæˆ–è€…åœ¨è°ƒç”¨å…¶ä»–æ–¹æ³•çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œå‚æ•°ä¼ é€’çš„ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ•´æ•°åŠ æ³•çš„å­—èŠ‚ç æŒ‡ä»¤<code>iadd</code>åœ¨è¿è¡Œçš„æ—¶å€™è¦æ±‚æ“ä½œæ•°æ ˆä¸­æœ€æ¥è¿‘æ ˆé¡¶çš„ä¸¤ä¸ªå…ƒç´ å·²ç»å­˜å…¥äº†ä¸¤ä¸ª<code>int</code>å‹çš„æ•°å€¼ï¼Œå½“æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤æ—¶ï¼Œä¼šå°†è¿™ä¸¤ä¸ª<code>int</code>å€¼å‡ºæ ˆå¹¶ç›¸åŠ ï¼Œç„¶åå°†ç›¸åŠ çš„ç»“æœå…¥æ ˆã€‚</p></blockquote><p>åœ¨æ¦‚å¿µæ¨¡å‹ä¸­ï¼Œä¸¤ä¸ªæ ˆå¸§ä½œä¸ºè™šæ‹Ÿæœºæ ˆçš„å…ƒç´ ï¼Œç›¸äº’ä¹‹é—´æ—¶å®Œå…¨ç‹¬ç«‹çš„ã€‚ä½†æ˜¯å¤§å¤šæ•°è™šæ‹Ÿæœºçš„å®ç°é‡Œéƒ½ä¼šåšä¸€äº›ä¼˜åŒ–å¤„ç†ï¼Œä»¤ä¸¤ä¸ªæ ˆå¸§å‡ºç°ä¸€éƒ¨åˆ†é‡å ã€‚è®©ä¸‹é¢æ ˆå¸§çš„éƒ¨åˆ†æ“ä½œæ•°æ ˆä¸ä¸Šé¢æ ˆå¸§çš„éƒ¨åˆ†å±€éƒ¨å˜é‡è¡¨é‡å åœ¨ä¸€èµ·ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶å°±å¯ä»¥å…±ç”¨ä¸€éƒ¨åˆ†æ•°æ®ï¼Œè€Œæ— é¡»è¿›è¡Œé¢å¤–çš„å‚æ•°å¤åˆ¶ä¼ é€’äº†ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/LMjrzh.png" alt="ä¸¤ä¸ªæ ˆå¸§ä¹‹é—´æ•°æ®å…±äº«"></p><p><strong>Javaè™šæ‹Ÿæœºçš„è§£é‡Šæ‰§è¡Œå¼•æ“ç§°ä¸ºâ€œåŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“â€ï¼Œå…¶ä¸­æ‰€æŒ‡çš„â€œæ ˆâ€å°±æ˜¯æ“ä½œæ•°æ ˆã€‚</strong></p><h3 id="åŠ¨æ€è¿æ¥"><a href="#åŠ¨æ€è¿æ¥" class="headerlink" title="åŠ¨æ€è¿æ¥"></a>åŠ¨æ€è¿æ¥</h3><p>æ¯ä¸ªæ ˆå¸§éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆæ‰€å±çš„æ–¹æ³•çš„å¼•ç”¨ï¼ŒæŒæœ‰è¿™ä¸ªå¼•ç”¨æ—¶ä¸ºäº†æ”¯æŒæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€è¿æ¥ã€‚å­—èŠ‚ç ä¸­çš„æ–¹æ³•è°ƒç”¨æŒ‡ä»¤å°±ä»¥å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ä¸ºå‚æ•°ã€‚è¿™äº›ç¬¦å·å¼•ç”¨ä¸€éƒ¨åˆ†ä¼šåœ¨ç±»åŠ è½½é˜¶æ®µæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™ç§è½¬åŒ–ç§°ä¸ºé™æ€è§£æã€‚å¦å¤–ä¸€éƒ¨åˆ†å°†åœ¨æ¯ä¸€æ¬¡çš„è¿è¡ŒæœŸé—´è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†ç§°ä¸ºåŠ¨æ€è¿æ¥ã€‚</p><h3 id="æ–¹æ³•è¿”å›åœ°å€"><a href="#æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="æ–¹æ³•è¿”å›åœ°å€"></a>æ–¹æ³•è¿”å›åœ°å€</h3><p>å½“ä¸€ä¸ªæ–¹æ³•è¢«æ‰§è¡Œåï¼Œæœ‰ä¸¤ç§æ–¹å¼é€€å‡ºè¿™ä¸ªæ–¹æ³•ã€‚</p><ul><li>æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œæ˜¯å¦æœ‰è¿”å›å€¼å’Œè¿”å›å€¼çš„ç±»å‹å°†æ ¹æ®é‡åˆ°ä½•ç§æ–¹æ³•è¿”å›æŒ‡ä»¤æ¥å†³å®šï¼Œè¿™ç§é€€å‡ºæ–¹æ³•çš„æ–¹å¼ç§°ä¸ºæ­£å¸¸å®Œæˆå‡ºå£ã€‚</li><li>åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•ä½“å†…å¾—åˆ°å¤„ç†ï¼Œæ— è®ºæ˜¯Javaè™šæ‹Ÿæœºå†…éƒ¨äº§ç”Ÿçš„å¼‚å¸¸ï¼Œè¿˜æ˜¯ä»£ç ä¸­ä½¿ç”¨<code>athrow</code>å­—èŠ‚ç æŒ‡ä»¤äº§ç”Ÿçš„å¼‚å¸¸ï¼Œåªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œè¿™ç§é€€å‡ºæ–¹æ³•çš„æ–¹å¼ç§°ä¸ºå¼‚å¸¸å®Œæˆå‡ºå£ã€‚ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨å¼‚å¸¸å®Œæˆå‡ºå£çš„æ–¹å¼é€€å‡ºï¼Œæ˜¯ä¸ä¼šç»™å®ƒçš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿè¿”å›å€¼çš„ã€‚</li></ul><p>æ— è®ºé‡‡ç”¨ä½•ç§é€€å‡ºæ–¹å¼ï¼Œåœ¨æ–¹æ³•é€€å‡ºä¹‹åï¼Œéƒ½éœ€è¦è¿”å›åˆ°æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ï¼Œç¨‹åºè—èƒ½ç»§ç»­æ‰§è¡Œï¼Œæ–¹æ³•è¿”å›æ—¶å¯èƒ½éœ€è¦åœ¨æ ˆå¸§ä¸­ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œç”¨æ¥å¸®åŠ©æ¢å¤å®ƒçš„ä¸Šå±‚æ–¹æ³•æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼å°±å¯ä»¥ä½œä¸ºè¿”å›åœ°å€ï¼Œæ ˆå¸§ä¸­å¾ˆå¯èƒ½ä¼šä¿å­˜è¿™ä¸ªè®¡æ•°å™¨å€¼ã€‚è€Œæ–¹æ³•å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€æ—¶è¦é€šè¿‡å¼‚å¸¸å¤„ç†å™¨è¡¨æ¥ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚</p><blockquote><p>æ–¹æ³•é€€å‡ºçš„è¿‡ç¨‹å®é™…ä¸Šç­‰åŒäºæŠŠå½“å‰æ ˆå¸§å‡ºæ ˆï¼Œå› æ­¤é€€å‡ºæ—¶å¯èƒ½æ‰§è¡Œçš„æ“ä½œæœ‰ï¼š</p><ul><li>æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆ</li><li>æŠŠè¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­</li><li>è°ƒæ•´PCè®¡æ•°å™¨çš„å€¼ä»¥æŒ‡å‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åé¢çš„ä¸€æ¡æŒ‡ä»¤</li></ul></blockquote><h3 id="é™„åŠ ä¿¡æ¯"><a href="#é™„åŠ ä¿¡æ¯" class="headerlink" title="é™„åŠ ä¿¡æ¯"></a>é™„åŠ ä¿¡æ¯</h3><p>è™šæ‹Ÿæœºè§„èŒƒå…è®¸å…·ä½“çš„è™šæ‹Ÿæœºå®ç°å¢åŠ ä¸€äº›è§„èŒƒé‡Œæ²¡æœ‰æè¿°çš„ä¿¡æ¯åˆ°æ ˆå¸§ä¹‹ä¸­ï¼Œä¾‹å¦‚ä¸è°ƒè¯•ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å®Œå…¨å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸€èˆ¬ä¼šæŠŠåŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€ä¸å…¶ä»–é™„åŠ ä¿¡æ¯å…¨éƒ¨å½’ä½ä¸€ç±»ï¼Œç§°ä¸ºæ ˆå¸§ä¿¡æ¯ã€‚</p><h2 id="æ–¹æ³•è°ƒç”¨"><a href="#æ–¹æ³•è°ƒç”¨" class="headerlink" title="æ–¹æ³•è°ƒç”¨"></a>æ–¹æ³•è°ƒç”¨</h2><p><strong>æ–¹æ³•è°ƒç”¨å¹¶ä¸ç­‰åŒäºæ–¹æ³•æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨é˜¶æ®µå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šè¢«è°ƒç”¨æ–¹æ³•çš„ç‰ˆæœ¬ï¼ˆå³è°ƒç”¨å“ªä¸€ä¸ªæ–¹æ³•ï¼‰ï¼Œæš‚æ—¶è¿˜ä¸æ¶‰åŠæ–¹æ³•å†…éƒ¨çš„å…·ä½“è¿è¡Œè¿‡ç¨‹ã€‚</strong></p><blockquote><p>åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶æœ€æ™®éã€æœ€é¢‘ç¹çš„æ“ä½œï¼Œä½†å‰é¢å·²ç»è®²è¿‡ï¼ŒClassæ–‡ä»¶è¿›è¡Œç¼–è¯‘è¿‡ç¨‹ä¸­ä¸åŒ…å«ä¼ ç»Ÿç¼–è¯‘ä¸­çš„è¿ç»­æ­¥éª¤ï¼Œä¸€åˆ‡æ–¹æ³•è°ƒç”¨åœ¨Classæ–‡ä»¶é‡Œå­˜å‚¨çš„éƒ½åªæ˜¯ç¬¦å·å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ–¹æ³•åœ¨å®é™…è¿è¡Œæ—¶å†…å­˜å¸ƒå±€ä¸­çš„å…¥å£åœ°å€ã€‚è¿™ä¸ªç‰¹æ€§ç»™Javaå¸¦æ¥äº†æ›´å¼ºå¤§çš„åŠ¨æ€æ‰©å±•èƒ½åŠ›ï¼Œä½†ä¹Ÿä½¿å¾—Javaæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å˜å¾—ç›¸å¯¹å¤æ‚èµ·æ¥ï¼Œéœ€è¦åœ¨ç±»åŠ è½½æœŸé—´ç”šè‡³åˆ°è¿è¡ŒæœŸé—´æ‰èƒ½ç¡®å®šç›®æ ‡æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚</p></blockquote><h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p>æ‰€æœ‰æ–¹æ³•è°ƒç”¨ä¸­çš„ç›®æ ‡æ–¹æ³•åœ¨Classæ–‡ä»¶é‡Œé¢éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨ï¼Œåœ¨ç±»åŠ è½½çš„è§£æé˜¶æ®µï¼Œä¼šå°†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™ç§è§£æèƒ½æˆç«‹çš„å‰ææ˜¯ï¼š<strong>æ–¹æ³•åœ¨ç¨‹åºçœŸæ­£æ‰§è¡Œä¹‹å‰å°±æœ‰ä¸€ä¸ªç¡®å®šçš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ç§è§£æèƒ½æˆç«‹çš„å‰ææ˜¯ï¼šæ–¹æ³•åœ¨ç¨‹åºçœŸæ­£è¿è¡Œä¹‹å‰å°±æœ‰ä¸€ä¸ªå¯ç¡®å®šçš„è°ƒç”¨ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ç‰ˆæœ¬åœ¨è¿è¡ŒæœŸæ˜¯ä¸å¯æ”¹å˜çš„ã€‚</strong>æ¢å¥è¯è¯´ï¼Œè°ƒç”¨ç›®æ ‡åœ¨ç¨‹åºä»£ç å†™å¥½ã€ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æ—¶å°±å¿…é¡»ç¡®å®šä¸‹æ¥ã€‚è¿™ç±»æ–¹æ³•çš„è°ƒç”¨ç§°ä¸ºè§£æã€‚</p><blockquote><p>åœ¨Javaè¯­è¨€ä¸­ï¼Œç¬¦åˆâ€œç¼–è¯‘å™¨å¯çŸ¥ï¼Œè¿è¡ŒæœŸä¸å¯å˜â€è¿™ä¸ªè¦æ±‚çš„æ–¹æ³•ä¸»è¦æœ‰é™æ€æ–¹æ³•å’Œç§æœ‰æ–¹æ³•ä¸¤å¤§ç±»ï¼Œå‰è€…ä¸ç±»å‹ç›´æ¥å…³è”ï¼Œåè€…åœ¨å¤–éƒ¨ä¸å¯è¢«è®¿é—®ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸å¯èƒ½é€šè¿‡ç»§æ‰¿æˆ–åˆ«çš„æ–¹å¼å……è¡€å‡ºå…¶ä»–ç‰ˆæœ¬ï¼Œå› æ­¤å®ƒä»¬éƒ½é€‚åˆåœ¨ç±»åŠ è½½é˜¶æ®µè¿›è¡Œè§£æã€‚</p></blockquote><p>è§£æè°ƒç”¨ä¸€å®šæ˜¯ä¸ªé™æ€çš„è¿‡ç¨‹ï¼Œåœ¨ç¼–è¯‘æœŸé—´å°±å®Œå…¨ç¡®å®šï¼Œåœ¨ç±»è£…è½½çš„è§£æé˜¶æ®µå°±ä¼šæŠŠæ¶‰åŠçš„ç¬¦å·å¼•ç”¨å…¨éƒ¨è½¬å˜ä¸ºå¯ç¡®å®šçš„ç›´æ¥å¼•ç”¨ï¼Œä¸ä¼šå»¶è¿Ÿåˆ°è¿è¡ŒæœŸå†å»å®Œæˆã€‚è€Œåˆ†æ´¾è°ƒç”¨åˆ™å¯èƒ½æ—¶é™æ€çš„ä¹Ÿå¯èƒ½æ—¶åŠ¨æ€çš„ï¼Œæ ¹æ®åˆ†æ´¾ä¸€å¥çš„å®—é‡æ•°å¯åˆ†ä¸ºå•åˆ†æ´¾å’Œå¤šåˆ†æ´¾ã€‚è¿™ä¸¤ç±»åˆ†æ´¾æ–¹å¼ä¸¤ä¸¤ç»„åˆå°±æ„æˆäº†é™æ€å•åˆ†æ´¾ã€é™æ€å¤šåˆ†æ´¾ã€åŠ¨æ€å•åˆ†æ´¾ã€åŠ¨æ€å¤šåˆ†æ´¾å››ç§åˆ†æ´¾æƒ…å†µã€‚</p><h3 id="åˆ†æ´¾"><a href="#åˆ†æ´¾" class="headerlink" title="åˆ†æ´¾"></a>åˆ†æ´¾</h3><p>Javaæ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå› ä¸ºJavaå…·å¤‡é¢å‘å¯¹è±¡çš„ä¸‰ä¸ªç‰¹å¾ï¼šç»§æ‰¿ã€å°è£…å’Œå¤šæ€ã€‚åˆ†æ´¾è°ƒç”¨è¿‡ç¨‹å°†ä¼šæ­ç¤ºå¤šæ€ç‰¹æ€§çš„ä¸€äº›æœ€åŸºæœ¬çš„ä½“ç°ï¼ˆå¦‚â€œé‡è½½â€å’Œâ€œé‡å†™â€ï¼‰ã€‚</p><h4 id="é™æ€åˆ†æ´¾"><a href="#é™æ€åˆ†æ´¾" class="headerlink" title="é™æ€åˆ†æ´¾"></a>é™æ€åˆ†æ´¾</h4><p>ä»£ç æ¸…å•ï¼ˆæ–¹æ³•é™æ€åˆ†æ´¾æ¼”ç¤ºï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ³•é™æ€åˆ†æ´¾æ¼”ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticDispatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">Human</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Woman</span> <span class="keyword">extends</span> <span class="title">Human</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(Human guy)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, guy!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(Man guy)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, gentleman!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(Woman guy)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, lady!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Human man = <span class="keyword">new</span> Man();</span><br><span class="line">        Human women = <span class="keyword">new</span> Woman();</span><br><span class="line"></span><br><span class="line">        StaticDispatch sd = <span class="keyword">new</span> StaticDispatch();</span><br><span class="line">        sd.sayHello(man);</span><br><span class="line">        sd.sayHello(women);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Hello, guy!</span><br><span class="line">Hello, guy!</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å¯¹Javaç¨å¾®æœ‰ç»éªŒçš„ç¨‹åºå‘˜çœ‹å®Œç¨‹åºåéƒ½èƒ½å¾—å‡ºæ­£ç¡®çš„è¿è¡Œç»“æœï¼Œä½†ä¸ºä»€ä¹ˆä¼šé€‰æ‹©æ‰§è¡Œå‚æ•°ç±»å‹ä¸ºhumançš„é‡è½½å‘¢ï¼Ÿåœ¨è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œå…ˆæŒ‰å¦‚ä¸‹ä»£ç å®šä¹‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Human man = <span class="keyword">new</span> Man();</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢ä»£ç ä¸­çš„â€œHumanâ€ç§°ä¸ºå˜é‡çš„é™æ€ç±»å‹ï¼ˆStatic Typeï¼‰æˆ–è€…å¤–è§‚ç±»å‹ï¼ˆApparent Typeï¼‰ï¼Œåé¢çš„â€œManâ€åˆ™ç§°ä¸ºå˜é‡çš„å®é™…ç±»å‹ï¼ˆActual Typeï¼‰ï¼Œé™æ€ç±»å‹å’Œå®é™…ç±»å‹åœ¨ç¨‹åºä¸­éƒ½å¯ä»¥å‘ç”Ÿä¸€äº›å˜åŒ–ï¼ŒåŒºåˆ«æ˜¯é™æ€ç±»å‹çš„å˜åŒ–ä»…ä»…åœ¨ä½¿ç”¨æ—¶å‘ç”Ÿï¼Œå˜é‡æœ¬èº«çš„é™æ€å˜é‡ç±»å‹ä¸ä¼šæ”¹å˜ï¼Œå¹¶ä¸”æœ€ç»ˆçš„é™æ€ç±»å‹æ˜¯åœ¨ç¼–è¯‘æœŸå¯çŸ¥çš„ï¼›è€Œå®é™…ç±»å‹å˜åŒ–çš„ç»“æœåœ¨è¿è¡ŒæœŸæ‰å¯ç¡®å®šï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘ç¨‹åºçš„æ—¶å€™å¹¶ä¸çŸ¥é“ä¸€ä¸ªå¯¹è±¡çš„å®é™…ç±»å‹æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®é™…ç±»å‹å˜åŒ–</span></span><br><span class="line">Human man = <span class="keyword">new</span> Man();</span><br><span class="line">man = <span class="keyword">new</span> Women();</span><br><span class="line"><span class="comment">// é™æ€ç±»å‹å˜åŒ–</span></span><br><span class="line">sd.sayHello((Man) man);</span><br><span class="line">sd.sayHello((Women) women);</span><br></pre></td></tr></table></figure><p>ä¼šåˆ°ä»£ç ä¸­ï¼Œ<code>main()</code>é‡Œé¢ä¸¤æ¬¡<code>sayHello()</code>æ–¹æ³•è°ƒç”¨ï¼Œåœ¨æ–¹æ³•æ¥æ”¶è€…å·²ç»ç¡®å®šæ˜¯å¯¹è±¡<code>sd</code>çš„å‰æä¸‹ï¼Œä½¿ç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬ï¼Œå°±å®Œå…¨å–å†³äºä¼ å…¥å‚æ•°çš„æ•°é‡å’Œæ•°æ®ç±»å‹ã€‚<strong>ä»£ç ä¸­å®šä¹‰äº†ä¸¤ä¸ªé™æ€ç±»å‹ç›¸åŒã€å®é™…ç±»å‹ä¸åŒçš„å˜é‡ï¼Œå•è™šæ‹Ÿæœºåœ¨é‡è½½æ—¶æ˜¯é€šè¿‡å‚æ•°çš„é™æ€ç±»å‹è€Œä¸æ˜¯å®é™…ç±»å‹ä½œä¸ºåˆ¤å®šä¾æ®çš„ã€‚</strong>å¹¶ä¸”é™æ€ç±»å‹æ˜¯ç¼–è¯‘æœŸå¯çŸ¥çš„ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒJavacç¼–è¯‘å™¨å°±æ ¹æ®å‚æ•°çš„é™æ€ç±»å‹å†³å®šä½¿ç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬ã€‚</p><p><strong>æ‰€æœ‰ä¾èµ–é™æ€ç±»å‹æ¥å®šä½æ–¹æ³•æ‰§è¡Œç‰ˆæœ¬çš„åˆ†æ´¾åŠ¨ä½œï¼Œéƒ½ç§°ä¸ºé™æ€åˆ†æ´¾ã€‚</strong>é™æ€åˆ†æ´¾çš„æœ€å…¸å‹åº”ç”¨å°±æ˜¯æ–¹æ³•é‡è½½ã€‚é™æ€åˆ†æ´¾å‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå› æ­¤é™æ€åˆ†æ´¾çš„åŠ¨ä½œå®é™…ä¸Šä¸æ˜¯ç”±è™šæ‹Ÿæœºæ¥æ‰§è¡Œçš„ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è™½ç„¶èƒ½ç¡®å®šå‡ºæ–¹æ³•çš„é‡è½½ç‰ˆæœ¬ï¼Œä½†åœ¨å¾ˆå¤šæƒ…å†µä¸‹è¿™ä¸ªé‡è½½ç‰ˆæœ¬å¹¶ä¸æ˜¯â€œå”¯ä¸€çš„â€ï¼Œå¾€å¾€åªèƒ½ç¡®å®šä¸€ä¸ªâ€œæ›´åŠ é€‚åˆçš„â€ç‰ˆæœ¬ã€‚</p><h4 id="åŠ¨æ€åˆ†æ´¾"><a href="#åŠ¨æ€åˆ†æ´¾" class="headerlink" title="åŠ¨æ€åˆ†æ´¾"></a>åŠ¨æ€åˆ†æ´¾</h4><p>åŠ¨æ€åˆ†æ´¾å’Œå¤šæ€æ€§çš„å¦å¤–ä¸€ä¸ªé‡è¦ä½“ç°â€”â€”é‡å†™ï¼ˆOverrideï¼‰æœ‰ç€å¾ˆå¯†åˆ‡çš„å…³è”ã€‚</p><p>ä»£ç æ¸…å•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ³•åŠ¨æ€åˆ†æ´¾æ¼”ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDispatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;man say hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Women</span> <span class="keyword">extends</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;women say hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Human man = <span class="keyword">new</span> Man();</span><br><span class="line">        Human women = <span class="keyword">new</span> Women();</span><br><span class="line"></span><br><span class="line">        man.sayHello();</span><br><span class="line">        women.sayHello();</span><br><span class="line"></span><br><span class="line">        man = <span class="keyword">new</span> Women();</span><br><span class="line">        man.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">man say hello</span><br><span class="line">women say hello</span><br><span class="line">women say hello</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶è¿™é‡Œæ˜¯ä¸å¯èƒ½æ ¹æ®é™æ€ç±»å‹æ¥å†³å®šçš„ï¼Œå› ä¸ºé™æ€ç±»å‹éƒ½æ˜¯<code>Human</code>çš„ä¸¤ä¸ªå˜é‡<code>man</code>å’Œ<code>women</code>åœ¨è°ƒç”¨<code>sayHello()</code>æ–¹æ³•æ—¶æ‰§è¡Œäº†ä¸åŒçš„è¡Œä¸ºï¼Œå¹¶ä¸”å˜é‡<code>man</code>åœ¨ä¸¤æ¬¡è°ƒç”¨ä¸­æ‰§è¡Œäº†ä¸åŒçš„æ–¹æ³•ã€‚å¯¼è‡´è¿™ä¸ªç°è±¡çš„åŸå› å¾ˆæ˜æ˜¾ï¼Œæ˜¯è¿™ä¸¤ä¸ªå˜é‡çš„å®é™…ç±»å‹ä¸åŒã€‚</p><h4 id="å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾"><a href="#å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾" class="headerlink" title="å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾"></a>å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾</h4><p>æ–¹æ³•çš„æ¥æ”¶è€…ä¸æ–¹æ³•çš„å‚æ•°ç»Ÿç§°ä¸ºæ–¹æ³•çš„å®—é‡ã€‚æ ¹æ®åˆ†æ´¾åŸºäºå¤šå°‘ç§å®—é‡ï¼Œå¯ä»¥å°†åˆ†æ´¾åˆ’åˆ†ä¸ºå•åˆ†æ´¾å’Œå¤šåˆ†æ´¾ä¸¤ç§ã€‚å•åˆ†æ´¾æ˜¯æ ¹æ®ä¸€ä¸ªå®—é‡å¯¹ç›®æ ‡è¿›è¡Œé€‰æ‹©ï¼Œå¤šåˆ†æ´¾åˆ™æ˜¯æ ¹æ®å¤šä½™ä¸€ä¸ªçš„å®—é‡å¯¹ç›®æ ‡è¿›è¡Œé€‰æ‹©ã€‚</p><p>ä»£ç æ¸…å•ï¼ˆåˆ—ä¸¾ä¸€ä¸ªFatherå’ŒSonä¸€èµ·æ¥åšå‡ºâ€œä¸€ä¸ªè‰°éš¾çš„å†³å®šâ€çš„ä¾‹å­ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dispatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">QQ</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">_360</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hardChoice</span><span class="params">(QQ arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;father choose qq&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hardChoice</span><span class="params">(_360 arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;father choose 360&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hardChoice</span><span class="params">(QQ arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;son choose qq&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hardChoice</span><span class="params">(_360 arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;son choose 360&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Father father = <span class="keyword">new</span> Father();</span><br><span class="line">        Father son = <span class="keyword">new</span> Son();</span><br><span class="line">        father.hardChoice(<span class="keyword">new</span> _360());</span><br><span class="line">        son.hardChoice(<span class="keyword">new</span> QQ());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">father choose 360</span><br><span class="line">son choose qq</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘èŠ‚ç‚¹ç¼–è¯‘æœŸçš„é€‰æ‹©è¿‡ç¨‹ï¼Œå³é™æ€åˆ†æ´¾çš„è¿‡ç¨‹ã€‚è¿™æ—¶å€™é€‰æ‹©ç›®æ ‡æ–¹æ³•çš„ä¾æ®æœ‰ä¸¤ç‚¹ï¼š<strong>ä¸€æ˜¯é™æ€ç±»å‹æ˜¯Fatherè¿˜æ˜¯Sonï¼ŒäºŒæ˜¯æ–¹æ³•å‚æ•°æ˜¯QQè¿˜æ˜¯360ã€‚</strong>è¿™æ¬¡é€‰æ‹©ç»“æœçš„æœ€ç»ˆäº§ç‰©æ˜¯äº§ç”Ÿäº†ä¸¤æ¡<code>invokevirtual</code>æŒ‡ä»¤ï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„å‚æ•°åˆ†åˆ«ä¸ºå¸¸é‡æ± ä¸­æŒ‡å‘<code>Father.hardChoince(360)</code>åŠ<code>Father.hardChoice(QQ)</code>æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ã€‚<strong>å› ä¸ºæ˜¯æ ¹æ®ä¸¤ä¸ªå®—é‡è¿›è¡Œé€‰æ‹©ï¼Œæ‰€ä»¥Javaè¯­è¨€çš„é™æ€åˆ†æ´¾å±äºå¤šåˆ†æ´¾ç±»å‹ã€‚</strong></p><p>è¿è¡Œé˜¶æ®µè™šæ‹Ÿæœºçš„é€‰æ‹©ï¼Œå³åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ã€‚åœ¨æ‰§è¡Œâ€son.hardChoice(new QQ())â€è¿™å¥ä»£ç æ—¶ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œåœ¨æ‰§è¡Œè¿™å¥ä»£ç æ‰€å¯¹åº”çš„<code>invokevirtual</code>æŒ‡ä»¤æ—¶ï¼Œç”±äºç¼–è¯‘æœŸå·²ç»å†³å®šç›®æ ‡æ–¹æ³•çš„ç­¾åå¿…é¡»ä¸º<code>hardChoice(QQ)</code>ï¼Œè™šæ‹Ÿæœºæ­¤æ—¶ä¸ä¼šå…³å¿ƒä¼ é€’è¿‡æ¥çš„å‚æ•°æ˜¯â€œQQâ€åˆ°åº•æ˜¯â€œè…¾è®¯QQâ€è¿˜æ˜¯â€œå¥‡ç‘QQâ€ï¼Œå› ä¸ºè¿™æ—¶å‚æ•°çš„é™æ€ç±»å‹ã€å®é™…ç±»å‹éƒ½ä¸ä¼šå¯¹æ–¹æ³•çš„é€‰æ‹©æ„æˆä»»ä½•å½±å“ï¼Œ<strong>å”¯ä¸€å¯ä»¥å½±å“è™šæ‹Ÿæœºé€‰æ‹©çš„å› ç´ åªæœ‰æ­¤æ–¹æ³•çš„æ¥æ”¶è€…çš„å®é™…ç±»å‹æ˜¯<code>Father</code>è¿˜æ˜¯<code>Son</code>ã€‚å› ä¸ºåªæœ‰ä¸€ä¸ªå®—é‡ä½œä¸ºé€‰æ‹©ä¾æ®ï¼Œæ‰€ä»¥Javaè¯­è¨€çš„åŠ¨æ€åˆ†æ´¾å±äºå•åˆ†æ´¾ç±»å‹ã€‚</strong></p><h4 id="è™šæ‹ŸæœºåŠ¨æ€åˆ†æ´¾çš„å®ç°"><a href="#è™šæ‹ŸæœºåŠ¨æ€åˆ†æ´¾çš„å®ç°" class="headerlink" title="è™šæ‹ŸæœºåŠ¨æ€åˆ†æ´¾çš„å®ç°"></a>è™šæ‹ŸæœºåŠ¨æ€åˆ†æ´¾çš„å®ç°</h4><p>ç”±äºåŠ¨æ€åˆ†æ´¾æ˜¯éå¸¸é¢‘ç¹çš„åŠ¨ä½œï¼Œè€Œä¸”åŠ¨æ€åˆ†æ´¾çš„æ–¹æ³•ç‰ˆæœ¬é€‰æ‹©è¿‡ç¨‹éœ€è¦è¿è¡Œæ—¶åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤åœ¨è™šæ‹Ÿæœºçš„å®é™…å®ç°ä¸­åŸºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œå¤§éƒ¨åˆ†å®ç°éƒ½ä¸ä¼šçœŸçš„è¿›è¡Œå¦‚æ­¤é¢‘ç¹çš„æœç´¢ã€‚</p><p>é¢å¯¹è¿™ç§æƒ…å†µï¼Œæœ€å¸¸ç”¨çš„â€œç¨³å®šä¼˜åŒ–â€æ‰‹æ®µå°±æ˜¯**åœ¨ç±»çš„æ–¹æ³•åŒºä¸­å»ºç«‹ä¸€ä¸ªå¾æ–¹æ³•è¡¨ï¼Œä½¿ç”¨è™šæ‹Ÿæ–¹æ³•è¡¨ç´¢å¼•æ¥ä»£æ›¿åŸæ•°æ®æŸ¥æ‰¾ä»¥æé«˜æ€§èƒ½ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/Bt352A.png" alt="æ–¹æ³•è¡¨ç»“æ„"></p><p>è™šæ–¹æ³•è¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£åœ°å€ã€‚<strong>å¦‚æœæŸä¸ªæ–¹æ³•åœ¨å­ç±»ä¸­æ²¡æœ‰è¢«é‡å†™ï¼Œé‚£ä¹ˆå­ç±»çš„è™šæ–¹æ³•è¡¨é‡Œé¢çš„åœ°å€å…¥å£å’Œçˆ¶ç±»ç›¸åŒæ–¹æ³•çš„å…¥å£æ—¶ä¸€è‡´çš„ï¼Œéƒ½æŒ‡å‘çˆ¶ç±»çš„å®ç°å…¥å£ã€‚å¦‚æœå­ç±»ä¸­é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œå­ç±»æ–¹æ³•è¡¨ä¸­çš„åœ°å€å°†ä¼šè¢«æ›¿æ¢ä¸ºæŒ‡å‘å­å˜å®ç°ç‰ˆæœ¬çš„å…¥å£åœ°å€ã€‚</strong></p><p>ä¸ºäº†ç¨‹åºå®ç°ä¸Šçš„æ–¹ä¾¿ï¼Œå…·æœ‰ç›¸åŒç­¾åçš„æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»ã€å­ç±»çš„è™šæ–¹æ³•è¡¨ä¸­éƒ½åº”å½“å…·æœ‰ä¸€æ ·çš„ç´¢å¼•åºå·ï¼Œè¿™æ ·å½“ç±»å‹å˜æ¢æ—¶ï¼Œä»…éœ€è¦å˜æ›´æŸ¥æ‰¾çš„æ–¹æ³•è¡¨ï¼Œå°±å¯ä»¥ä»ä¸åŒçš„è™šæ–¹æ³•è¡¨ä¸­æŒ‰ç´¢å¼•è½¬æ¢å‡ºæ‰€éœ€çš„å…¥å£åœ°å€ã€‚</p><p><strong>æ–¹æ³•è¡¨ä¸€èˆ¬åœ¨ç±»åŠ è½½çš„è¿æ¥é˜¶æ®µè¿›è¡Œåˆå§‹åŒ–ï¼Œå‡†å¤‡äº†ç±»çš„å˜é‡åˆå§‹å€¼åï¼Œè™šæ‹Ÿæœºä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚</strong></p><h2 id="åŸºäºæ ˆçš„å­—èŠ‚ç è§£é‡Šæ‰§è¡Œå¼•æ“"><a href="#åŸºäºæ ˆçš„å­—èŠ‚ç è§£é‡Šæ‰§è¡Œå¼•æ“" class="headerlink" title="åŸºäºæ ˆçš„å­—èŠ‚ç è§£é‡Šæ‰§è¡Œå¼•æ“"></a>åŸºäºæ ˆçš„å­—èŠ‚ç è§£é‡Šæ‰§è¡Œå¼•æ“</h2><h3 id="è§£é‡Šæ‰§è¡Œ"><a href="#è§£é‡Šæ‰§è¡Œ" class="headerlink" title="è§£é‡Šæ‰§è¡Œ"></a>è§£é‡Šæ‰§è¡Œ</h3><p>ä¸è®ºæ˜¯è§£é‡Šè¿˜æ˜¯ç¼–è¯‘ï¼Œä¹Ÿä¸è®ºæ˜¯ç‰©ç†æœºè¿˜æ˜¯è™šæ‹Ÿæœºï¼Œå¯¹äºåº”ç”¨ç¨‹åºï¼Œæœºå™¨éƒ½ä¸å¯èƒ½å¦‚äººé‚£æ ·é˜…è¯»å’Œç†è§£ï¼Œç„¶åå‡ è·å¾—äº†ç†è§£èƒ½åŠ›ã€‚å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç åˆ°ç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ç¼–è¯‘è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾ï¼Œä¸­ä¸‹é¢çš„é‚£æ¡åˆ†æ”¯ï¼Œå°±æ˜¯ä¼ ç»Ÿç¼–è¯‘åŸç†ä¸­ç¨‹åºä»£ç åˆ°ç›®æ ‡æœºå™¨ä»£ç çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œè€Œä¸­é—´çš„é‚£æ¡åˆ†æ”¯è‡ªç„¶å°±æ˜¯è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/bztPYs.png" alt="ç¼–è¯‘è¿‡ç¨‹"></p><blockquote><p>å¦‚ä»Šï¼ŒåŸºäºç‰©ç†æœºã€Javaè™šæ‹Ÿæœºæˆ–è€…æ˜¯éJavaçš„å…¶ä»–é«˜çº§è¯­è¨€è™šæ‹Ÿæœºçš„è¯­è¨€ï¼Œå¤§å¤šéƒ½éµå¾ªç€ä¸­åŸºäºç°ä»£ç»å…¸ç¼–è¯‘åŸç†çš„æ€è·¯ï¼Œ<strong>åœ¨æ‰§è¡Œå‰å…ˆå¯¹ç¨‹åºæºç è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æå¤„ç†ï¼ŒæŠŠæºç è½¬åŒ–ä¸ºæŠ½è±¡è¯­æ³•æœ¯ã€‚</strong>å¯¹äºä¸€é—¨å…·ä½“è¯­è¨€çš„å®ç°æ¥è¯´ï¼Œè¯æ³•å’Œè¯­æ³•åˆ†æä¹ƒè‡³åé¢çš„ä¼˜åŒ–å™¨å’Œç›®æ ‡ä»£ç ç”Ÿæˆå™¨éƒ½å¯ä»¥é€‰æ‹©ç‹¬ç«‹äºæ‰§è¡Œå¼•æ“ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´æ„ä¹‰çš„ç¼–è¯‘å™¨å»å®ç°ï¼Œè¿™ç±»ä»£è¡¨æ˜¯C/C++è¯­è¨€ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æŠŠå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ­¥éª¤å®ç°ä¸ºä¸€ä¸ªåŠç‹¬ç«‹çš„ç¼–è¯‘å™¨ï¼Œè¿™ç±»ä»£è¡¨æ˜¯Javaè¯­è¨€ã€‚åˆæˆ–è€…æŠŠè¿™äº›æ­¥éª¤å’Œæ‰§è¡Œå¼•æ“å…¨éƒ¨é›†ä¸­å°è£…åœ¨ä¸€ä¸ªå°é—­çš„é»‘å¤¹å­ä¹‹ä¸­ï¼Œå¦‚å¤§å¤šæ•°çš„JavaScriptæ‰§è¡Œå™¨ï¼Œ</p></blockquote><p>Javaè¯­è¨€ä¸­ï¼Œ<strong>Javacç¼–è¯‘å™¨å®Œæˆäº†ç¨‹åºä»£ç ç»è¿‡è¯æ³•åˆ†æã€è¯­æ³•åˆ†æåˆ°æŠ½è±¡è¯­æ³•ä¹¦ï¼Œå†ä¾¿éå†è¯­æ³•æœ¯ç”Ÿæˆçº¿æ€§çš„å­—èŠ‚ç æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚</strong>å› ä¸ºè¿™ä¸€éƒ¨åˆ†åŠ¨ä½œæ˜¯åœ¨Javaè™šæ‹Ÿæœºä¹‹å¤–è¿›è¡Œçš„ï¼Œè€Œè§£é‡Šå™¨åœ¨è™šæ‹Ÿæœºçš„å†…éƒ¨ï¼Œæ‰€ä»¥Javaçš„ç¼–è¯‘å°±æ˜¯åŠç‹¬ç«‹çš„å®ç°ã€‚</p><h3 id="åŸºäºæ ˆçš„æŒ‡ä»¤é›†ä¸åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†"><a href="#åŸºäºæ ˆçš„æŒ‡ä»¤é›†ä¸åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†" class="headerlink" title="åŸºäºæ ˆçš„æŒ‡ä»¤é›†ä¸åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†"></a>åŸºäºæ ˆçš„æŒ‡ä»¤é›†ä¸åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†</h3><p>Javaç¼–è¯‘å™¨è¾“å‡ºçš„æŒ‡ä»¤æµï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ç§åŸºäºæ ˆçš„æŒ‡ä»¤é›†æ¶æ„ï¼ŒæŒ‡ä»¤æµé‡Œé¢çš„æŒ‡ä»¤å¤§éƒ¨åˆ†éƒ½æ˜¯é›¶åœ°å€æŒ‡ä»¤ï¼Œå®ƒä»¬ä¾èµ–æ“ä½œæ•°æ ˆè¿›è¡Œå·¥ä½œã€‚<em>ä¸ä¹‹ç›¸å¯¹çš„å¦å¤–ä¸€å¥—å¸¸ç”¨çš„æŒ‡ä»¤é›†æ¶æ„å¸ˆåŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†ï¼Œæœ€å…¸å‹çš„å°±æ˜¯x86çš„äºŒåœ°å€æŒ‡ä»¤é›†ã€‚</em></p><p>åŸºäºæ ˆçš„æŒ‡ä»¤é›†æœ€ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯å¯ç§»æ¤æ€§ï¼Œå¯„å­˜å™¨ç”±ç¡¬ä»¶ç›´æ¥æä¾›ï¼Œç¨‹åºç›´æ¥ä»¥æ¥è¿™äº›ç¡¬ä»¶å¯„å­˜å™¨åˆ™ä¸å¯é¿å…åœ°è¦å—åˆ°çº¦æŸã€‚</p><p>æ ˆæ¶æ„æŒ‡ä»¤é›†çš„ä¸»è¦ç¼ºç‚¹æ˜¯æ‰§è¡Œé€Ÿåº¦ç›¸å¯¹æ¥è¯´ç¨æ…¢ä¸€äº›ã€‚æ‰€æœ‰ä¸»æµç‰©ç†æœºçš„æŒ‡ä»¤é›†éƒ½æ˜¯å¯„å­˜å™¨æ¶æ„ä¹Ÿä»ä¾§é¢å°è¯äº†è¿™ä¸€ç‚¹ã€‚</p><p>æ ˆæ¶æ„æŒ‡ä»¤é›†çš„ä»£ç è™½ç„¶ç´§å‡‘ï¼Œä½†æ˜¯å®Œæˆç›¸åŒåŠŸèƒ½æ‰€éœ€çš„æŒ‡ä»¤æ•°é‡ä¸€èˆ¬ä¼šæ¯”å¯„å­˜å™¨æ¶æ„å¤šï¼Œå› ä¸ºå‡ºæ ˆã€å…¥æ ˆæ“ä½œæœ¬èº«å°±äº§ç”Ÿäº†ç›¸å½“å¤šçš„æŒ‡ä»¤ã€‚<strong>æ›´é‡è¦çš„æ˜¯æ ˆå®ç°åœ¨å†…å­˜ä¹‹ä¸­ï¼Œé¢‘ç¹çš„æ ˆè®¿é—®ä¹Ÿå°±æ„å‘³ç€é¢‘ç¹çš„å†…å­˜è®¿é—®ï¼Œç›¸å¯¹äºå¤„ç†å™¨æ¥è¯´ï¼Œå†…å­˜å§‹ç»ˆæ˜¯æ‰§è¡Œé€Ÿåº¦çš„ç“¶é¢ˆã€‚</strong>å°½ç®¡è™šæ‹Ÿæœºå¯ä»¥é‡‡å–æ ˆé¡¶ç¼“å­˜çš„æ‰‹æ®µï¼ŒæŠŠæœ€é•¿ç”¨çš„æ“ä½œæ˜ å°„åˆ°å¯„å­˜å™¨ä¸­ä»¥é¿å…ç›´æ¥å†…å­˜è®¿é—®ï¼Œä½†è¿™ä¹Ÿåªèƒ½æ˜¯ä¼˜åŒ–æªæ–½è€Œä¸æ˜¯è§£å†³æœ¬è´¨é—®é¢˜çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œ**ç”±äºæŒ‡ä»¤æ•°é‡å’Œå†…å­˜è®¿é—®çš„åŸå› ï¼Œå¯¼è‡´äº†æ ˆæ¶æ„æŒ‡ä»¤é›†çš„æ‰§è¡Œé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åˆ†æäº†è™šæ‹Ÿæœºåœ¨æ‰§è¡Œä»£ç æ—¶å¦‚ä½•æ‰¾åˆ°æ­£ç¡®çš„æ–¹æ³•ï¼Œå¦‚ä½•æ‰§è¡Œæ–¹æ³•å†…çš„å­—èŠ‚ç ï¼Œä»¥åŠæ‰§è¡Œä»£ç æ—¶æ¶‰åŠçš„å†…å­˜ç»“æ„ã€‚é’ˆå¯¹Javaç¨‹åºæ—¶å¦‚ä½•å­˜å‚¨çš„ã€å¦‚ä½•è½½å…¥ï¼ˆåˆ›å»ºï¼‰çš„ä»¥åŠå¦‚ä½•æ‰§è¡Œçš„é—®é¢˜ç›¸å…³çŸ¥è¯†è®²è§£äº†ä¸€ä¸‹ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾</li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶</title>
      <link href="/blog/2018/09/14/cdffca23.html"/>
      <url>/blog/2018/09/14/cdffca23.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»£ç ç¼–è¯‘çš„ç»“æœä»æœ¬åœ°æœºå™¨ç å˜ä¸ºå­—èŠ‚ç ï¼Œæ˜¯å­˜å‚¨æ ¼å¼å‘å±•çš„ä¸€å°æ­¥ï¼Œç¡®å®ç¼–ç¨‹è¯­è¨€å‘å±•çš„ä¸€å¤§æ­¥</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><strong>è™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è½¬æ¢è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œè¿™å°±æ˜¯è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶ã€‚</strong></p><p>ä¸å“ªäº›ç¼–è¯‘æ—¶éœ€è¦è¿›è¡Œè¿æ¥å·¥ä½œçš„è¯­è¨€ä¸åŒï¼Œåœ¨Javaè¯­è¨€é‡Œé¢ï¼Œç±»å‹çš„åŠ è½½å’Œè¿æ¥è¿‡ç¨‹éƒ½æ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å®Œæˆçš„ï¼Œè¿™æ ·ä¼šåœ¨ç±»åŠ è½½æ—¶ç¨å¾®å¢åŠ ä¸€äº›æ€§èƒ½å¼€é”€ï¼Œä½†æ—¶å´èƒ½ä¸ºJavaåº”ç”¨ç¨‹åºæä¾›é«˜åº¦çš„çµæ´»æ€§ï¼ŒJavaä¸­å¤©ç”Ÿå¯ä»¥åŠ¨æ€æ‰©å±•çš„è¯­è¨€ç‰¹æ€§å°±æ˜¯ä¾èµ–è¿è¡ŒæœŸåŠ¨æ€åŠ è½½å’ŒåŠ¨æ€è¿æ¥è¿™ä¸ªç‰¹ç‚¹å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œ<strong>å¦‚æœç¼–å†™ä¸€ä¸ªä½¿ç”¨æ¥å£çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç­‰åˆ°è¿è¡Œæ—¶å†æŒ‡å®šå…¶å®é™…çš„å®ç°ã€‚</strong>è¿™ç§ç»„è£…åº”ç”¨ç¨‹åºçš„æ–¹å¼å¹¿æ³›åº”ç”¨äºJavaç¨‹åºä¹‹ä¸­ã€‚</p><h2 id="ç±»åŠ è½½çš„æ—¶æœº"><a href="#ç±»åŠ è½½çš„æ—¶æœº" class="headerlink" title="ç±»åŠ è½½çš„æ—¶æœº"></a>ç±»åŠ è½½çš„æ—¶æœº</h2><p>ç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œåˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼š<strong>åŠ è½½ï¼ˆLoadingï¼‰ã€éªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰ã€ä½¿ç”¨ï¼ˆUsingï¼‰å’Œå¸è½½ï¼ˆUnloadingï¼‰ä¸ƒä¸ªé˜¶æ®µã€‚</strong>å…¶ä¸­éªŒè¯ã€å‡†å¤‡å’Œè§£æä¸‰ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºè¿æ¥ï¼ˆLinkingï¼‰ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/kYqehE.png" alt="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></p><p>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½è¿™äº”ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰<strong>éƒ¨å°±ç­åœ°å¼€å§‹ï¼Œ</strong>è€Œè§£æé˜¶æ®µåˆ™ä¸ä¸€å®šï¼šå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒJavaè¯­è¨€çš„è¿è¡Œæ—¶ç»‘å®šï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€ç»‘å®šæˆ–æ™šæœŸç»‘å®šï¼‰ã€‚<em>æ³¨æ„è¿™é‡Œæ˜¯æŒ‰éƒ¨å°±ç­åœ°â€œå¼€å§‹â€ï¼Œè€Œä¸æ˜¯æŒ‰éƒ¨å°±ç­åœ°â€œè¿›è¡Œâ€æˆ–â€œå®Œæˆâ€ï¼Œå› ä¸ºè¿™äº›é˜¶æ®µé€šå¸¸éƒ½æ˜¯äº’ç›¸äº¤å‰åœ°æ··åˆå¼è¿›è¡Œåœ°ï¼Œé€šå¸¸ä¼šå†ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œåœ°è¿‡ç¨‹ä¸­è°ƒç”¨æˆ–æ¿€æ´»å¦å¤–ä¸€ä¸ªé˜¶æ®µã€‚</em></p><p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰å››ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œâ€œåˆå§‹åŒ–â€ï¼ˆè€ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡è‡ªç„¶éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ï¼‰ï¼š</p><ul><li>é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤åœ°æœ€å¸¸è§åœ°Javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡åœ°æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± åœ°é™æ€å­—æ®µé™¤å¤–ï¼‰åœ°æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»åœ°é™æ€æ–¹æ³•åœ°æ—¶å€™ã€‚</li><li>ä½¿ç”¨java.lang.reflectåŒ…åœ°æ–¹æ³•å¯¹ç±»è¿›è¡Œå‘å°„è°ƒç”¨åœ°æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li><li>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»åœ°æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»åœ°åˆå§‹åŒ–ã€‚</li><li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œåœ°ä¸»ç±»ï¼ˆåŒ…æ‹¬main()æ–¹æ³•åœ°é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚</li></ul><h3 id="è¢«åŠ¨å¼•ç”¨åœ°ä¾‹å­ä¹‹ä¸€"><a href="#è¢«åŠ¨å¼•ç”¨åœ°ä¾‹å­ä¹‹ä¸€" class="headerlink" title="è¢«åŠ¨å¼•ç”¨åœ°ä¾‹å­ä¹‹ä¸€"></a>è¢«åŠ¨å¼•ç”¨åœ°ä¾‹å­ä¹‹ä¸€</h3><p>çˆ¶ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢«åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤ºä¸€</span></span><br><span class="line"><span class="comment"> *  é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SuperClass init..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SubClass init..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éä¸»åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(SuperClass.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/B2cEYa.png" alt="è¿è¡Œç»“æœ"></p><p>ä¸Šè¿°ä»£ç è¿è¡Œä¹‹åï¼Œ åªä¼šè¾“å‡ºâ€œSuperClass init..â€ï¼Œè€Œä¸ä¼šè¾“å‡ºâ€œSubClass init..â€ã€‚<strong>å¯¹äºé™æ€å­—æ®µï¼Œåªæœ‰ç›´æ¥å®šä¹‰è¿™ä¸ªå­—æ®µçš„ç±»æ‰ä¼šè¢«åˆå§‹åŒ–ï¼Œå› æ­¤é€šè¿‡å­ç±»æ¥å¼•ç”¨çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€å­—æ®µï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–è€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–ã€‚</strong>è‡³äºæ˜¯å¦è¦è§¦å‘å­ç±»çš„åŠ è½½å’ŒéªŒè¯ï¼Œå†è™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®è§„å®šï¼Œè¿™ç‚¹å–å†³äºè™šæ‹Ÿæœºçš„å…·ä½“å®ç°ã€‚</p><h3 id="è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹äºŒ"><a href="#è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹äºŒ" class="headerlink" title="è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹äºŒ"></a>è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹äºŒ</h3><p>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cayzlh.reference1.SuperClass;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SuperClass[] sca = <span class="keyword">new</span> SuperClass[<span class="number">10</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/SslBsv.png" alt="è¿è¡Œç»“æœ"></p><p>è¿è¡Œä¹‹åå‘ç°æ²¡æœ‰è¾“å‡ºâ€œSuperClass init..â€ï¼Œè¯´æ˜å¹¶æ²¡æœ‰è§¦å‘<code>SuperClass</code>ç±»çš„åˆå§‹åŒ–é˜¶æ®µã€‚</p><h3 id="è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹ä¸‰"><a href="#è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹ä¸‰" class="headerlink" title="è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹ä¸‰"></a>è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹ä¸‰</h3><p>ä»£ç 1ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference3;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"> * æœ¬è´¨ä¸Šæ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å®šä¹‰å¸¸é‡çš„ç±»ï¼Œ</span></span><br><span class="line"><span class="comment"> * å› æ­¤ä¸èƒ½è§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ConstClass init..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLOWORLD = <span class="string">&quot;Hello World.&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç 2ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cayzlh.reference3;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éä¸»åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(ConstClass.HELLOWORLD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/MDhSi7.png" alt="è¿è¡Œç»“æœ"></p><p>ä¸Šè¿°ä»£ç è¿è¡Œä¹‹åï¼Œæ²¡æœ‰è¾“å‡ºâ€œConstClass init..â€ï¼Œè¿™æ˜¯å› ä¸ºè™½ç„¶åœ¨Javaæºç ä¸­å¼•ç”¨äº†ConstClassç±»ä¸­çš„å¸¸é‡HELLOWORLDï¼Œä½†æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå°†æ­¤å¸¸é‡çš„å€¼â€Hello World.â€å­˜å‚¨åˆ°äº†<code>NotInitialization</code>ç±»çš„å¸¸é‡æ± ä¸­ï¼Œå¯¹å¸¸é‡ConstClass.HELLOWORLDçš„å¼•ç”¨éƒ½è¢«è½¬åŒ–ä¸ºNotInitializationç±»å¯¹è‡ªèº«å¸¸é‡æ± çš„å¼•ç”¨äº†ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´å®é™…ä¸ŠNotInitializationçš„Classæ–‡ä»¶ä¹‹ä¸­å¹¶æ²¡æœ‰ConstClassç±»çš„ç¬¦å·å¼•ç”¨å…¥å£ï¼Œè¿™ä¸¤ä¸ªç±»åœ¨ç¼–è¯‘æˆClassä¹‹åå°±ä¸å†å­˜åœ¨ä»»ä½•è”ç³»äº†ã€‚</strong></p><h2 id="ç±»åŠ è½½çš„è¿‡ç¨‹"><a href="#ç±»åŠ è½½çš„è¿‡ç¨‹" class="headerlink" title="ç±»åŠ è½½çš„è¿‡ç¨‹"></a>ç±»åŠ è½½çš„è¿‡ç¨‹</h2><p>ç±»åŠ è½½çš„çš„å…¨è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–è¿™äº”ä¸ªé˜¶æ®µçš„è¿‡ç¨‹ã€‚</p><h3 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h3><p>â€œåŠ è½½â€ï¼ˆLoadingï¼‰é˜¶æ®µæ˜¯â€œç±»åŠ è½½â€ï¼ˆClass Loadingï¼‰è¿‡ç¨‹çš„ä¸€ä¸ªé˜¶æ®µã€‚åœ¨åŠ è½½é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦å®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…ï¼š</p><ul><li>1ï¼‰<strong>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</strong></li><li>2ï¼‰<strong>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</strong></li><li>3ï¼‰<strong>åœ¨Javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„<code>java.lang.Class</code>å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºå°†è¿™äº›æ•°æ®çš„è®¿é—®å…¥å£</strong></li></ul><p>è™šæ‹Ÿæœºè§„èŒƒçš„è¿™ä¸‰ç‚¹è¦æ±‚å®é™…ä¸Šå¹¶ä¸å…·ä½“ï¼Œå› æ­¤è™šæ‹Ÿæœºå®ç°ä¸å…·ä½“åº”ç”¨çš„çµæ´»åº¦ç›¸å½“å¤§ã€‚<em>ç›¸å¯¹äºç±»åŠ è½½è¿‡ç¨‹çš„å…¶ä»–é˜¶æ®µï¼ŒåŠ è½½é˜¶æ®µï¼ˆåŠ è½½é˜¶æ®µä¸­è·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠ¨ä½œï¼‰æ˜¯å¼€å‘æœŸå¯æ§æ€§æœ€å¼ºçš„é˜¶æ®µï¼Œå› ä¸ºåŠ è½½é˜¶æ®µæ˜¯æ—¢å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨æ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å»å®Œæˆï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨å»æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ã€‚</em></p><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><blockquote><p>éªŒè¯æ—¶è¿æ¥é˜¶æ®µçš„ç¬¬ä¸€æ­¥ï¼Œè¿™ä¸€é˜¶æ®µçš„ç›®çš„æ—¶ä¸ºäº†ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚</p></blockquote><p><strong>Classæ–‡ä»¶å¹¶ä¸ä¸€å®šè¦æ±‚ç”¨Javaæºç ç¼–è¯‘è€Œæ¥ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•é€”å¾„ï¼ŒåŒ…æ‹¬ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨ç›´æ¥ç¼–å†™æ¥äº§ç”ŸClassæ–‡ä»¶ã€‚</strong>å¦‚æœè™šæ‹Ÿæœºä¸æ£€æŸ¥è¾“å…¥çš„å­—èŠ‚æµï¼Œå¯¹å…¶å®Œå…¨ä¿¡ä»»çš„è¯ï¼Œå¾ˆå¯èƒ½ä¼šå› ä¸ºè½½å…¥äº†æœ‰å®³çš„å­—èŠ‚æµè€Œå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ‰€ä»¥éªŒè¯æ—¶è™šæ‹Ÿæœºè‡ªèº«ä¿æŠ¤çš„ä¸€é¡¹é‡è¦å·¥ä½œã€‚</p><p>è™šæ‹Ÿæœºå¤§è‡´ä¸Šä¼šå®Œæˆä¸‹é¢å››ä¸ªé˜¶æ®µçš„æ£€æŸ¥è¿‡ç¨‹ï¼š<strong>æ–‡ä»¶æ ¼å¼éªŒè¯ã€å…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯å’Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚</strong></p><h4 id="æ–‡ä»¶æ ¼å¼éªŒè¯"><a href="#æ–‡ä»¶æ ¼å¼éªŒè¯" class="headerlink" title="æ–‡ä»¶æ ¼å¼éªŒè¯"></a>æ–‡ä»¶æ ¼å¼éªŒè¯</h4><p>ç¬¬ä¸€é˜¶æ®µè¦éªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ï¼š</p><ul><li>æ˜¯å¦ä»¥é­”æ•°<code>0xCAFEBABE</code>å¼€å¤´</li><li>ä¸»ã€æ¬¡ç‰ˆæœ¬å·æ˜¯å¦åœ¨å½“å‰è™šæ‹Ÿæœºå¤„ç†èŒƒå›´ä¹‹å†…</li><li>å¸¸é‡æ± çš„å¸¸é‡ä¸­æ˜¯å¦æœ‰ä¸è¢«æ”¯æŒçš„å¸¸é‡ç±»å‹</li><li>æŒ‡å‘å¸¸é‡çš„å„ç§ç´¢å¼•å€¼æ˜¯å¦æœ‰åªæƒ³ä¸å­˜åœ¨å¸¸é‡æˆ–ä¸ç¬¦åˆç±»å‹çš„å¸¸é‡</li><li>CONSTANT_Utf8_infoå‹çš„å¸¸é‡ä¸­æ˜¯å¦æœ‰ä¸ç¬¦åˆUTF8ç¼–ç çš„æ•°æ®</li><li>Classæ–‡ä»¶ä¸­å„ä¸ªéƒ¨åˆ†åŠæ–‡ä»¶æœ¬èº«æ˜¯å¦æœ‰è¢«åˆ é™¤çš„é¢æˆ–é™„åŠ çš„å…¶ä»–ä¿¡æ¯</li><li>Â·Â·Â·Â·Â·Â·</li></ul><p>å®é™…ä¸Šç¬¬ä¸€é˜¶æ®µçš„éªŒè¯è¿˜è¿œè¿œä¸æ­¢è¿™äº›ï¼Œè¯¥éªŒè¯é˜¶æ®µçš„ä¸»è¦ç›®çš„æ—¶ä¿è¯è¾“å…¥çš„å­—èŠ‚æµèƒ½æ­£ç¡®åœ°è§£æå¹¶å­˜å‚¨ä¸æ–¹æ³•åŒºä¹‹å†…ï¼Œæ ¼å¼ä¸Šç¬¦åˆæè¿°ä¸€ä¸ªJavaç±»å‹ä¿¡æ¯åœ°è¦æ±‚ã€‚<strong>è¿™é˜¶æ®µçš„éªŒè¯æ—¶åŸºäºå­—èŠ‚æµè¿›è¡Œçš„ï¼Œç»è¿‡è¿™ä¸ªé˜¶æ®µçš„éªŒè¯ä¹‹åï¼Œå­—èŠ‚æµæ‰ä¼šæµå…¥å†…å­˜çš„æ–¹æ³•åŒºä¸­è¿›è¡Œå­˜å‚¨ï¼Œæ‰€ä»¥ä»¥åçš„ä¸‰ä¸ªéªŒè¯é˜¶æ®µéƒ½æ˜¯åŸºäºæ–¹æ³•åŒºå­˜å‚¨ç»“æ„è¿›è¡Œçš„ã€‚</strong></p><h4 id="å…ƒæ•°æ®éªŒè¯"><a href="#å…ƒæ•°æ®éªŒè¯" class="headerlink" title="å…ƒæ•°æ®éªŒè¯"></a>å…ƒæ•°æ®éªŒè¯</h4><p>ç¬¬äºŒé˜¶æ®µæ˜¯å †å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆJavaè¯­è¨€çš„è§„èŒƒçš„è¦æ±‚ï¼Œè¿™ä¸ªé˜¶æ®µåŒ…æ‹¬ï¼š</p><ul><li>è¿™ä¸ªç±»æ˜¯å¦æœ‰çˆ¶ç±»ï¼ˆé™¤äº†java.lang.Objectï¼Œæ‰€æœ‰çš„ç±»éƒ½åº”å½“æœ‰çˆ¶ç±»ï¼‰</li><li>è¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯å¦ç»§æ‰¿äº†ä¸å…è®¸è¢«ç»§æ‰¿çš„ç±»ï¼ˆè¢«finalä¿®é¥°çš„ç±»ï¼‰</li><li>å¦‚æœè¿™ä¸ªç±»ä¸æ˜¯æŠ½è±¡ç±»ï¼Œæ˜¯å¦å®ç°äº†å…¶çˆ¶ç±»æˆ–æ¥å£ä¹‹ä¸­è¦æ±‚å®ç°çš„æ‰€æœ‰æ–¹æ³•</li><li>ç±»ä¸­çš„å­—æ®µã€æ–¹æ³•æ˜¯å¦ä¸çˆ¶ç±»äº§ç”Ÿäº†çŸ›ç›¾ï¼ˆä¾‹å¦‚è¦†ç›–äº†çˆ¶ç±»çš„finalå­—æ®µï¼Œæˆ–è€…å‡ºç°ä¸ç¬¦åˆè§„åˆ™çš„æ–¹æ³•é‡è½½ï¼Œä¾‹å¦‚æ–¹æ³•å‚æ•°éƒ½ä¸€è‡´ï¼Œä½†è¿”å›å€¼ç±»å‹å´ä¸åŒç­‰ï¼‰</li><li>Â·Â·Â·Â·Â·Â·</li></ul><p>ç¬¬äºŒé˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯å¯¹ç±»çš„å…ƒæ•°æ®ä¿¡æ¯è¿›è¡Œè¯­ä¹‰æ ¡éªŒï¼Œä¿è¯ä¸å­˜åœ¨ä¸ç¬¦åˆJavaè¯­è¨€è§„èŒƒçš„å…ƒæ•°æ®ä¿¡æ¯ã€‚</p><h4 id="å­—èŠ‚ç éªŒè¯"><a href="#å­—èŠ‚ç éªŒè¯" class="headerlink" title="å­—èŠ‚ç éªŒè¯"></a>å­—èŠ‚ç éªŒè¯</h4><p>ç¬¬ä¸‰é˜¶æ®µæ˜¯æ•´ä¸ªéªŒè¯è¿‡ç¨‹ä¸­æœ€å¤æ‚çš„ä¸€ä¸ªé˜¶æ®µï¼Œä¸»è¦å·¥ä½œæ˜¯è¿›è¡Œæ•°æ®æµå’Œæ§åˆ¶æµåˆ†æã€‚åœ¨ç¬¬äºŒé˜¶æ®µå¯¹å…ƒæ•°æ®ä¿¡æ¯ä¸­çš„æ•°æ®ç±»å‹åšå®Œæ ¡éªŒåï¼Œ<strong>è¿™é˜¶æ®µå¯¹ç±»çš„æ–¹æ³•ä½“è¿›è¡Œæ ¡éªŒåˆ†æã€‚è¿™é˜¶æ®µçš„ä»»åŠ¡æ˜¯ä¿è¯è¢«æ ¡éªŒç±»çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šåšå‡ºå±å®³è™šæ‹Ÿæœºå®‰å…¨çš„è¡Œä¸ºï¼š</strong></p><ul><li>ä¿è¯ä»»æ„æ—¶åˆ»<strong>æ“ä½œæ•°æ®æ ˆ</strong>ä¸æŒ‡ä»¤ä»£ç åºåˆ—éƒ½èƒ½é…åˆå·¥ä½œï¼Œä¾‹å¦‚ä¸ä¼šå‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼š<strong>åœ¨æ“ä½œæ ˆä¸­æ”¾ç½®äº†ä¸€ä¸ªintç±»å‹çš„æ•°æ®ï¼Œä½¿ç”¨æ—¶å´æŒ‰longç±»å‹æ¥åŠ è½½å¦‚æœ¬åœ°å˜é‡è¡¨ä¸­ã€‚</strong></li><li>ä¿è¯è·³è½¬æŒ‡ä»¤ä¸ä¼šè·³è½¬åˆ°æ–¹æ³•ä½“æ„å¤–çš„å­—èŠ‚ç æŒ‡ä»¤ä¸Šã€‚</li><li>ä¿è¯æ–¹æ³•ä½“ä¸­çš„ç±»å‹è½¬æ¢æ˜¯æœ‰æ•ˆçš„ï¼Œä¾‹å¦‚<strong>å¯ä»¥æŠŠä¸€ä¸ªå­ç±»å¯¹è±¡èµ‹å€¼ç»™çˆ¶ç±»æ•°æ®ç±»å‹ï¼Œè¿™æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯æŠŠçˆ¶ç±»å¯¹è±¡èµ‹å€¼ç»™å­ç±»æ•°æ®ç±»å‹ï¼Œç”šè‡³æŠŠå¯¹è±¡èµ‹å€¼ç»™ä¸å®ƒæ¯«æ— å…³ç³»ã€å®Œå…¨ä¸ç›¸å¹²çš„æ•°æ®ç±»å‹ï¼Œåˆ™æ˜¯å±é™©å’Œä¸åˆæ³•çš„ã€‚</strong></li><li>Â·Â·Â·Â·Â·Â·</li></ul><p>å¦‚æœä¸€ä¸ªç±»çš„æ–¹æ³•ä½“çš„å­—èŠ‚ç æ²¡æœ‰é€šè¿‡å­—èŠ‚ç éªŒè¯ï¼Œé‚£è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ï¼›ä½†å¦‚æœä¸€ä¸ªæ–¹æ³•ä½“é€šè¿‡äº†å­—èŠ‚ç éªŒè¯ï¼Œä¹Ÿä¸èƒ½è¯´æ˜å…¶ä¸€å®šå°±æ˜¯å®‰å…¨çš„ã€‚å³ä½¿å­—èŠ‚ç éªŒè¯ä¹‹ä¸­è¿›è¡Œäº†å¤§é‡çš„æ£€æŸ¥ï¼Œä¹Ÿä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚<strong>é€šä¿—ä¸€ç‚¹è®²å°±æ˜¯ï¼Œé€šè¿‡ç¨‹åºå»æ ¡éªŒç¨‹åºé€»è¾‘æ˜¯æ— æ³•åšåˆ°ç»å¯¹å‡†ç¡®çš„â€”â€”ä¸èƒ½é€šè¿‡ç¨‹åºå‡†ç¡®çš„æ£€æŸ¥å‡ºç¨‹åºæ˜¯å¦èƒ½åœ¨æœ‰é™çš„æ—¶é—´ä¹‹å†…ç»“æŸè¿è¡Œã€‚</strong></p><h4 id="ç¬¦å·å¼•ç”¨éªŒè¯"><a href="#ç¬¦å·å¼•ç”¨éªŒè¯" class="headerlink" title="ç¬¦å·å¼•ç”¨éªŒè¯"></a>ç¬¦å·å¼•ç”¨éªŒè¯</h4><p>æœ€åä¸€ä¸ªé˜¶æ®µçš„æ ¡éªŒå‘ç”Ÿåœ¨<strong>è™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬åŒ–ç›´æ¥å¼•ç”¨çš„æ—¶å€™ï¼Œ</strong>è¿™ä¸ªè‡ªåŠ¨è½¬åŒ–å°†åœ¨è¿æ¥çš„ç¬¬ä¸‰ä¸ªé˜¶æ®µâ€”â€”è§£æé˜¶æ®µä¸­å‘ç”Ÿã€‚ç¬¦å·å¼•ç”¨éªŒè¯å¯ä»¥çœ‹ä½œæ˜¯å¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆ<strong>å¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨</strong>ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§çš„æ ¡éªŒï¼š</p><ul><li>ç¬¦å·å¼•ç”¨ä¸­é€šè¿‡ç¬¦å·ä¸²æè¿°çš„å…¨é™å®šåæ˜¯å¦èƒ½æ‰¾åˆ°å¯¹è±¡çš„ç±»ã€‚</li><li>åœ¨æŒ‡å®šç±»ä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆæ–¹æ³•çš„å­—æ®µæè¿°ç¬¦åŠç®€å•åç§°æ‰€æè¿°çš„æ–¹æ³•å’Œå­—æ®µã€‚</li><li>ç¬¦å·å¼•ç”¨ä¸­çš„ç±»ã€å­—æ®µå’Œæ–¹æ³•çš„è®¿é—®è¡Œï¼ˆprivateã€protectedã€publicã€defaultï¼‰æ˜¯å¦å¯è¢«å½“å‰ç±»è®¿é—®ã€‚</li><li>Â·Â·Â·Â·Â·Â·</li></ul><p>ç¬¦å·å¼•ç”¨éªŒè¯çš„ç›®çš„æ˜¯ç¡®ä¿è§£æåŠ¨ä½œèƒ½æ­£å¸¸æ‰§è¡Œã€‚</p><blockquote><p>éªŒè¯é˜¶æ®µå¯¹äºè™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ã€ä½†ä¸ä¸€å®šæ—¶å¿…è¦çš„é˜¶æ®µã€‚å¦‚æœæ‰€è¿è¡Œçš„å…¨éƒ¨ä»£ç ï¼ˆåŒ…æ‹¬è‡ªå·±å†™çš„ã€ç¬¬ä¸‰æ–¹åŒ…ä¸­çš„ä»£ç ï¼‰éƒ½å·²ç»è¢«åå¤ä½¿ç”¨å’ŒéªŒè¯è¿‡ï¼Œåœ¨å®æ–½é˜¶æ®µå°±å£å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>-Xverify:none</code>å‚æ•°æ¥å…³é—­å¤§éƒ¨åˆ†çš„ç±»éªŒè¯æªæ–½ï¼Œä»¥ç¼©çŸ­è™šæ‹Ÿæœºç±»åŠ è½½çš„æ—¶é—´ã€‚</p></blockquote><h3 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><p><strong>å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µï¼Œè¿™äº›å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…ã€‚</strong>è¿™ä¸ªé˜¶æ®µä¸­æœ‰ä¸¤ä¸ªå®¹æ˜“äº§ç”Ÿæ··æ·†çš„æ¦‚å¿µéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œé¦–å…ˆæ˜¯è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬<strong>ç±»å˜é‡ï¼ˆè¢«<code>static</code>ä¿®é¥°çš„å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚</strong>å…¶æ¬¡æ—¶è¿™é‡Œæ‰€è¯´çš„åˆå§‹å€¼â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ—¶æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œå‡è®¾ä¸€ä¸ªç±»å˜é‡å®šä¹‰ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå˜é‡valueåœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼æ˜¯0è€Œä¸æ˜¯123ï¼Œå› ä¸ºè¿™æ—¶å€™å°šæœªå¼€å§‹æ‰§è¡Œä»»ä½•Javaæ–¹æ³•ï¼Œè€ŒæŠŠvalueèµ‹å€¼ä¸º123çš„putstaticæŒ‡ä»¤æ˜¯ç¨‹åºè¢«ç¼–è¯‘åï¼Œå­˜æ”¾äºç±»ç»“æ„å™¨<clinit>()æ–¹æ³•ä¹‹ä¸­ï¼Œæ‰€ä»¥valueèµ‹å€¼ä¸º123çš„åŠ¨ä½œå°†åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«æ‰§è¡Œã€‚</p><p>â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ—¶æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œé‚£ç›¸å¯¹çš„ä¼šæœ‰ä¸€äº›â€œç‰¹æ®Šæƒ…å†µâ€ï¼šå¦‚æœç±»å­—æ®µçš„å­—æ®µå±æ€§è¡¨ä¸­å­˜åœ¨ConstantValueå±æ€§ï¼Œé‚£åœ¨å‡†å¤‡é˜¶æ®µå˜é‡valueå°±ä¼šè¢«åˆå§‹åŒ–ä¸ºConstantValueå±æ€§æ‰€æŒ‡çš„å€¼ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æ—¶å°†ä¼šä¸ºvalueç”ŸæˆConstantValueså±æ€§ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ®ConstantValueçš„è®¾ç½®å°†valueèµ‹å€¼ä¸º123ã€‚</p><h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p><strong>è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</strong>è§£æé˜¶æ®µä¸­æ‰€è¯´çš„ç›´æ¥å¼•ç”¨ä¸ç¬¦å·å¼•ç”¨æœ‰ä»€ä¹ˆå…³è”å‘¢ï¼Ÿ</p><ul><li>ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰ï¼šç¬¦å·å¼•ç”¨ä»¥ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚å¯Œè±ªå¼•ç”¨<strong>ä¸è™šæ‹Ÿæœºå®ç°åœ°å†…å­˜å¸ƒå±€æ— å…³</strong>ï¼Œå¼•ç”¨åœ°ç›®æ ‡å¹¶ä¸ä¸€å®šå·²ç»åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>ç›´æ¥å¼•ç”¨ï¼ˆDirect Referenceï¼‰ï¼šç›´æ¥å¼•ç”¨å¯ä»¥æ—¶ç›´æ¥æŒ‡å‘ç›®æ ‡åœ°æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–æ˜¯ä¸€ä¸ªèƒ½é—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ç›´æ¥å¼•ç”¨æ˜¯<strong>ä¸è™šæ‹Ÿæœºå®ç°çš„å†…å­˜å¸ƒå±€ç›¸å…³</strong>çš„ï¼ŒåŒä¸€ä¸ªç¬¦å·å¼•ç”¨åœ¨ä¸åŒè™šæ‹Ÿæœºå®ä¾‹ä¸Šç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¸€èˆ¬ä¸ä¼šç›¸åŒã€‚<strong>å¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£å¼•ç”¨çš„ç›®æ ‡å¿…å®šå·²ç»åœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚</strong></li></ul><blockquote><p>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•å››ç±»ç¬¦å·å¼•ç”¨è¿›è¡Œï¼Œåˆ†åˆ«å¯¹åº”äºå¸¸é‡æ± ä¸­çš„CONSTANT_Class_infoã€CONSTANT_Fieldref_infoã€CONSTANT_Methodref_infoåŠCONSTANT_InterfaceMethodref_infoå››ç§å¸¸é‡ç±»å‹ã€‚</p></blockquote><h4 id="ç±»æˆ–æ¥å£çš„è§£æ"><a href="#ç±»æˆ–æ¥å£çš„è§£æ" class="headerlink" title="ç±»æˆ–æ¥å£çš„è§£æ"></a>ç±»æˆ–æ¥å£çš„è§£æ</h4><p>è¦æŠŠä¸€ä¸ªç±»æˆ–è€…æ¥å£çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ï¼Œéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>å¦‚æœè¯¥ç¬¦å·å¼•ç”¨ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†ä¼šæŠŠè¯¥ç¬¦å·ä»£è¡¨çš„å…¨é™å®šåç§°ä¼ é€’ç»™ç±»åŠ è½½å™¨å»åŠ è½½è¿™ä¸ªç±»ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±äºæ¶‰åŠéªŒè¯è¿‡ç¨‹æ‰€ä»¥å¯èƒ½ä¼šè§¦å‘å…¶ä»–ç›¸å…³ç±»çš„åŠ è½½</li><li>å¦‚æœè¯¥ç¬¦å·å¼•ç”¨æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œå¹¶ä¸”è¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯å¯¹è±¡ã€‚æˆ‘ä»¬çŸ¥é“ç¬¦å·å¼•ç”¨æ˜¯å­˜åœ¨æ–¹æ³•åŒºçš„å¸¸é‡æ± ä¸­çš„ï¼Œè¯¥ç¬¦å·å¼•ç”¨çš„æè¿°ç¬¦ä¼šç±»ä¼¼â€[java/lang/Integerâ€çš„å½¢å¼ï¼Œå°†ä¼šæŒ‰ç…§ä¸Šé¢çš„è§„åˆ™è¿›è¡ŒåŠ è½½æ•°ç»„å…ƒç´ ç±»å‹ï¼Œå¦‚æœæè¿°ç¬¦å¦‚å‰é¢å‡è®¾çš„å½¢å¼ï¼Œéœ€è¦åŠ è½½çš„å…ƒç´ ç±»å‹å°±æ˜¯java.lang.Integer ,æ¥ç€ç”±è™šæ‹Ÿæœºå°†ä¼šç”Ÿæˆä¸€ä¸ªä»£è¡¨æ­¤æ•°ç»„å¯¹è±¡çš„ç›´æ¥å¼•ç”¨</li><li>å¦‚æœä¸Šé¢çš„æ­¥éª¤éƒ½æ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥ç¬¦å·å¼•ç”¨å·²ç»åœ¨è™šæ‹Ÿæœºä¸­äº§ç”Ÿäº†ä¸€ä¸ªç›´æ¥å¼•ç”¨ï¼Œä½†æ˜¯åœ¨è§£æå®Œæˆä¹‹å‰éœ€è¦å¯¹ç¬¦å·å¼•ç”¨è¿›è¡ŒéªŒè¯ï¼Œä¸»è¦æ˜¯ç¡®è®¤å½“å‰è°ƒç”¨è¿™ä¸ªç¬¦å·å¼•ç”¨çš„ç±»æ˜¯å¦å…·æœ‰è®¿é—®æƒé™ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™å°†æŠ›å‡ºjava.lang.IllegalAccesså¼‚å¸¸</li></ol><h4 id="å­—æ®µè§£æ"><a href="#å­—æ®µè§£æ" class="headerlink" title="å­—æ®µè§£æ"></a>å­—æ®µè§£æ</h4><p>å¯¹å­—æ®µçš„è§£æéœ€è¦é¦–å…ˆå¯¹å…¶æ‰€å±çš„ç±»è¿›è¡Œè§£æï¼Œå› ä¸ºå­—æ®µæ˜¯å±äºç±»çš„ï¼Œåªæœ‰åœ¨æ­£ç¡®è§£æå¾—åˆ°å…¶ç±»çš„æ­£ç¡®çš„ç›´æ¥å¼•ç”¨æ‰èƒ½ç»§ç»­å¯¹å­—æ®µçš„è§£æã€‚å¯¹å­—æ®µçš„è§£æä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å¦‚æœè¯¥å­—æ®µç¬¦å·å¼•ç”¨å°±åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ä¸ç›®æ ‡ç›¸åŒ¹é…çš„å­—æ®µï¼Œåˆ™è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ</li><li>å¦åˆ™ï¼Œå¦‚æœåœ¨è¯¥ç¬¦å·çš„ç±»å®ç°äº†æ¥å£ï¼Œå°†ä¼šæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šé€’å½’æœç´¢å„ä¸ªæ¥å£å’Œå®ƒçš„çˆ¶æ¥å£ï¼Œå¦‚æœåœ¨æ¥å£ä¸­åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ä¸ç›®æ ‡ç›¸åŒ¹é…çš„å­—æ®µï¼Œé‚£ä¹ˆä¹…ç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ</li><li>å¦åˆ™ï¼Œå¦‚æœè¯¥ç¬¦å·æ‰€åœ¨çš„ç±»ä¸æ˜¯Objectç±»çš„è¯ï¼Œå°†ä¼šæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šé€’å½’æœç´¢å…¶çˆ¶ç±»ï¼Œå¦‚æœåœ¨çˆ¶ç±»ä¸­åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ç›¸åŒ¹é…çš„å­—æ®µï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ</li><li>å¦åˆ™ï¼Œè§£æå¤±è´¥ï¼ŒæŠ›å‡ºjava.lang.NoSuchFieldErrorå¼‚å¸¸</li></ol><p>å¦‚æœæœ€ç»ˆè¿”å›äº†è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œå°±è¿›è¡Œæƒé™éªŒè¯ï¼Œå¦‚æœå‘ç°ä¸å…·å¤‡å¯¹å­—æ®µçš„è®¿é—®æƒé™ï¼Œå°†æŠ›å‡ºjava.lang.IllegalAccessErrorå¼‚å¸¸</p><h4 id="ç±»æ–¹æ³•è§£æ"><a href="#ç±»æ–¹æ³•è§£æ" class="headerlink" title="ç±»æ–¹æ³•è§£æ"></a>ç±»æ–¹æ³•è§£æ</h4><p>è¿›è¡Œç±»æ–¹æ³•çš„è§£æä»ç„¶éœ€è¦å…ˆè§£ææ­¤ç±»æ–¹æ³•çš„ç±»ï¼Œåœ¨æ­£ç¡®è§£æä¹‹åéœ€è¦è¿›è¡Œå¦‚ä¸‹çš„æ­¥éª¤ï¼š</p><ol><li>ç±»æ–¹æ³•å’Œæ¥å£æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ˜¯åˆ†å¼€çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨ç±»æ–¹æ³•è¡¨ä¸­å‘ç°class_indexï¼ˆç±»ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ï¼‰çš„ç´¢å¼•æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºjava.lang.IncompatibleClassChangeErrorçš„å¼‚å¸¸</li><li>å¦‚æœclass_indexçš„ç´¢å¼•ç¡®å®æ˜¯ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯å°±è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾ç»“æŸ</li><li>å¦åˆ™ï¼Œåœ¨è¯¥ç±»çš„çˆ¶ç±»ä¸­é€’å½’æŸ¥æ‰¾æ˜¯å¦å…·æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾ç»“æŸ</li><li>å¦åˆ™ï¼Œåœ¨è¿™ä¸ªç±»çš„æ¥å£ä»¥åŠå®ƒçš„çˆ¶æ¥å£ä¸­é€’å½’æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯å°±è¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒæŸ¥æ‰¾ç»“æŸï¼Œè¿”å›java.lang.AbstractMethodErrorå¼‚å¸¸</li><li>å¦åˆ™ï¼ŒæŸ¥æ‰¾å¤±è´¥ï¼ŒæŠ›å‡ºjava.lang.NoSuchMethodErrorå¼‚å¸¸</li></ol><p>å¦‚æœæœ€ç»ˆè¿”å›äº†ç›´æ¥å¼•ç”¨ï¼Œè¿˜éœ€è¦å¯¹è¯¥ç¬¦å·å¼•ç”¨è¿›è¡Œæƒé™éªŒè¯ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™ï¼Œå°±æŠ›å‡ºjava.lang.IllegalAccessErrorå¼‚å¸¸ã€‚</p><h4 id="æ¥å£æ–¹æ³•è§£æ"><a href="#æ¥å£æ–¹æ³•è§£æ" class="headerlink" title="æ¥å£æ–¹æ³•è§£æ"></a>æ¥å£æ–¹æ³•è§£æ</h4><p>åŒç±»æ–¹æ³•è§£æä¸€æ ·ï¼Œä¹Ÿéœ€è¦å…ˆè§£æå‡ºè¯¥æ–¹æ³•çš„ç±»æˆ–è€…æ¥å£çš„ç¬¦å·å¼•ç”¨ï¼Œå¦‚æœè§£ææˆåŠŸï¼Œå°±è¿›è¡Œä¸‹é¢çš„è§£æå·¥ä½œï¼š</p><ol><li>å¦‚æœåœ¨æ¥å£æ–¹æ³•è¡¨ä¸­å‘ç°class_indexçš„ç´¢å¼•æ˜¯ä¸€ä¸ªç±»è€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆä¹Ÿä¼šæŠ›å‡ºjava.lang.IncompatibleClassChangeErrorçš„å¼‚å¸¸</li><li>å¦åˆ™ï¼Œåœ¨è¯¥æ¥å£æ–¹æ³•çš„æ‰€å±çš„æ¥å£ä¸­æŸ¥æ‰¾æ˜¯å¦å…·æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚</li><li>å¦åˆ™ï¼Œåœ¨è¯¥æ¥å£ä»¥åŠå…¶çˆ¶æ¥å£ä¸­æŸ¥æ‰¾ï¼Œç›´åˆ°Objectç±»ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨</li><li>å¦åˆ™ï¼ŒæŸ¥æ‰¾å¤±è´¥</li></ol><p>æ¥å£çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯publicï¼Œæ‰€ä»¥ä¸å­˜åœ¨è®¿é—®æƒé™é—®é¢˜</p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p><strong>åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„javaç¨‹åºä»£ç ã€‚</strong></p><p>åˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨<clinit>()æ–¹æ³•çš„è¿‡ç¨‹ã€‚åœ¨ä»¥ä¸‹å››ç§æƒ…å†µä¸‹åˆå§‹åŒ–è¿‡ç¨‹ä¼šè¢«è§¦å‘æ‰§è¡Œï¼š</p><ol><li><p>é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤çš„æœ€å¸¸è§çš„javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µ(è¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–)çš„æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚</p></li><li><p>ä½¿ç”¨java.lang.reflectåŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™</p></li><li><p>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ã€åˆ™éœ€è¦å…ˆå‡ºå‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–</p></li><li><p>jvmå¯åŠ¨æ—¶ï¼Œç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ‰§è¡Œçš„ä¸»ç±»(åŒ…å«mainæ–¹æ³•çš„é‚£ä¸ªç±»)ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªç±»</p></li></ol><p>åœ¨å‡†å¤‡é˜¶æ®µï¼Œå˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼ï¼ŒäºŒåœ¨åˆå§‹é˜¶æ®µï¼Œåˆ™æ˜¯æ ¹æ®ç¨‹åºå‘˜é€šè¿‡ç¨‹åºåˆ¶å®šçš„ä¸»è§‚è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶ä»–èµ„æºã€‚</p><h2 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h2><blockquote><p>è™šæ‹Ÿæœºè®¾è®¡å›¢é˜ŸæŠŠç±»åŠ è½½é˜¶æ®µä¸­çš„â€œé€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµâ€è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°Javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—è¢«ç§°ä¸ºâ€œç±»åŠ è½½å™¨â€ã€‚</p></blockquote><p>ç±»åŠ è½½å™¨å¯ä»¥è¯´æ˜¯Javaè¯­è¨€çš„ä¸€é¡¹åˆ›æ–°ï¼Œä¹Ÿæ˜¯Javaè¯­è¨€æµè¡Œçš„é‡è¦åŸå› ä¹‹ä¸€ã€‚</p><h3 id="ç±»ä¸ç±»åŠ è½½å™¨"><a href="#ç±»ä¸ç±»åŠ è½½å™¨" class="headerlink" title="ç±»ä¸ç±»åŠ è½½å™¨"></a>ç±»ä¸ç±»åŠ è½½å™¨</h3><p>ç±»åŠ è½½å™¨è™½ç„¶åªç”¨äºå®ç°ç±»çš„åŠ è½½åŠ¨ä½œï¼Œä½†å®ƒåœ¨Javaç¨‹åºä¸­èµ·åˆ°çš„ä½œç”¨å´è¿œè¿œä¸é™äºç±»åŠ è½½é˜¶æ®µã€‚<strong>å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®å®šå…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ã€‚</strong>é€šä¿—ä¸€ç‚¹ï¼šæ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦â€œç›¸ç­‰â€ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¹‹ä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå¦åˆ™ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œåªè¦è®°è½½ä»–ä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ã€‚</p><h3 id="åŒäº²å§”æ´¾æ¨¡å‹"><a href="#åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹"></a>åŒäº²å§”æ´¾æ¨¡å‹</h3><p>ç«™åœ¨Javaè™šæ‹Ÿæœºçš„è§’åº¦çœ‹ï¼Œåªå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š<strong>ä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨<code>C++</code>è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼›å¦å¤–ä¸€ç§å°±æ˜¯æ‰€æœ‰å…¶ä»–çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±»<code>java.lang.ClassLoader</code>ã€‚</strong></p><p>ç»å¤§éƒ¨åˆ†Javaç¨‹åºéƒ½ä¼šä½¿ç”¨åˆ°ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ï¼š</p><ul><li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šè´Ÿè´£å°†å­˜æ”¾åœ¨<code>bin</code>ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«<code>-Xbootclasspath</code>å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨ã€‚</li><li>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½<code>lib\ext</code>ç›®å½•ä¸­ï¼Œæˆ–è€…è¢«<code>java.ext.dirs</code>ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚</li><li>åº”ç”¨ç¨‹åºåŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ï¼šç”±äºè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ClassLoaderä¸­çš„<code>getSystemClassLoader()</code>æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚<strong>è´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</strong></li></ul><p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±è¿™ä¸‰ç§ç±»åŠ è½½å™¨äº’ç›¸é…åˆè¿›è¡ŒåŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥åŠ å…¥è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚è¿™äº›ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ä¸€èˆ¬å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/19/Kg9O8N.png" alt="ç±»åŠ è½½å™¨åŒäº²å§”æ´¾æ¨¡å‹"></p><p>åŒäº²å§”æ´¾æ¨¡å‹é™¤äº†è¦æ±‚é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸ä¼šä»¥ç»§æ‰¿çš„å…³ç³»å®ç°ï¼Œè€Œæ˜¯éƒ½ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶ç±»åŠ è½½å™¨çš„ä»£ç ã€‚</p><blockquote><p>åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡æ˜¯ï¼š<strong>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“é™„åŠ åœ¨ä¸ƒåé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆ<em>å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»</em>ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚</strong></p></blockquote><p>ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ¥ç»„ç»‡ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ï¼Œå¥½å¤„å°±æ˜¯Javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚<strong>åŒäº²å§”æ´¾æ¨¡å‹å¯¹äºä¿è¯Javaç¨‹åºçš„ç¨³å®šè¿è¡Œå¾ˆé‡è¦ï¼Œä½†å®ƒçš„å®ç°å´éå¸¸ç®€å•ï¼Œ</strong>å®ç°åŒäº²å§”æ´¾çš„ä»£ç éƒ½é›†ä¸­åœ¨<code>java.lang.ClassLoader</code>çš„<code>loadClass()</code>æ–¹æ³•ä¹‹ä¸­ã€‚å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡ï¼Œè‹¥æ²¡æœ‰åŠ è½½åˆ™è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨çš„<code>loadClass()</code>æ–¹æ³•ï¼Œè‹¥çˆ¶ç±»åŠ è½½å™¨ä¸ºç©ºåˆ™é»˜è®¤ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ä½œä¸ºçˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œåˆ™åœ¨æŠ›å‡º<code>ClassNotFoundException</code>å¼‚å¸¸åï¼Œå†è°ƒç”¨è‡ªå·±çš„<code>findClass()</code>æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚</p><h3 id="ç ´ååŒäº²å§”æ´¾æ¨¡å‹"><a href="#ç ´ååŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="ç ´ååŒäº²å§”æ´¾æ¨¡å‹"></a>ç ´ååŒäº²å§”æ´¾æ¨¡å‹</h3><h4 id="ç¬¬ä¸€æ¬¡ç ´å"><a href="#ç¬¬ä¸€æ¬¡ç ´å" class="headerlink" title="ç¬¬ä¸€æ¬¡ç ´å"></a>ç¬¬ä¸€æ¬¡ç ´å</h4><p>ç”±äºåŒäº²å§”æ´¾æ¨¡å‹æ˜¯åœ¨JDK1.2ä¹‹åæ‰è¢«å¼•å…¥çš„ï¼Œè€Œç±»åŠ è½½å™¨å’ŒæŠ½è±¡ç±»java.lang.ClassLoaderåˆ™åœ¨JDK1.0æ—¶ä»£å°±å·²ç»å­˜åœ¨ï¼Œé¢å¯¹å·²ç»å­˜åœ¨çš„ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°ä»£ç ï¼ŒJavaè®¾è®¡è€…å¼•å…¥åŒäº²å§”æ´¾æ¨¡å‹æ—¶ä¸å¾—ä¸åšå‡ºä¸€äº›å¦¥åã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç”¨æˆ·å»ç»§æ‰¿java.lang.ClassLoaderçš„å”¯ä¸€ç›®çš„å°±æ˜¯ä¸ºäº†é‡å†™loadClass()æ–¹æ³•ï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ä¼šè°ƒç”¨åŠ è½½å™¨çš„ç§æœ‰æ–¹æ³•loadClassInternal()ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å”¯ä¸€é€»è¾‘å°±æ˜¯å»è°ƒç”¨è‡ªå·±çš„loadClass()ã€‚</p><h4 id="ç¬¬äºŒæ¬¡ç ´å"><a href="#ç¬¬äºŒæ¬¡ç ´å" class="headerlink" title="ç¬¬äºŒæ¬¡ç ´å"></a>ç¬¬äºŒæ¬¡ç ´å</h4><p>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·æ‰€å¯¼è‡´çš„ï¼ŒåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨çš„åŸºç¡€ç±»çš„åŒä¸€é—®é¢˜ï¼ˆè¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼‰ï¼ŒåŸºç¡€ç±»ä¹‹æ‰€ä»¥ç§°ä¸ºâ€œåŸºç¡€â€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ€»æ˜¯ä½œä¸ºè¢«ç”¨æˆ·ä»£ç è°ƒç”¨çš„APIï¼Œä½†ä¸–äº‹å¾€å¾€æ²¡æœ‰ç»å¯¹çš„å®Œç¾ã€‚</p><h4 id="å¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥ä¹ˆåŠï¼Ÿ"><a href="#å¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥ä¹ˆåŠï¼Ÿ" class="headerlink" title="å¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥ä¹ˆåŠï¼Ÿ"></a>å¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥ä¹ˆåŠï¼Ÿ</h4><p>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯JNDIæœåŠ¡ï¼ŒJNDIç°åœ¨å·²ç»æ˜¯Javaçš„æ ‡å‡†æœåŠ¡ï¼Œ<br> å®ƒçš„ä»£ç ç”±å¯åŠ¨ç±»åŠ è½½å™¨å»åŠ è½½ï¼ˆåœ¨JDK1.3æ—¶æ”¾è¿›å»çš„rt.jarï¼‰ï¼Œä½†JNDIçš„ç›®çš„å°±æ˜¯å¯¹èµ„æºè¿›è¡Œé›†ä¸­ç®¡ç†å’ŒæŸ¥æ‰¾ï¼Œå®ƒéœ€è¦è°ƒç”¨ç”±ç‹¬ç«‹å‚å•†å®ç°å¹¶éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºçš„ClassPathä¸‹çš„JNDIæ¥å£æä¾›è€…çš„ä»£ç ï¼Œä½†å¯åŠ¨ç±»åŠ è½½å™¨ä¸å¯èƒ½â€œè®¤è¯†â€è¿™äº›ä»£ç ã€‚</p><p><strong>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaè®¾è®¡å›¢é˜Ÿåªå¥½å¼•å…¥äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(Thread Context ClassLoader)ã€‚è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡java.lang.Threadç±»çš„setContextClassLoader()æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œä»–å°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚</strong></p><p>æœ‰äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼ŒJNDIæœåŠ¡å°±å¯ä»¥ä½¿ç”¨å®ƒå»åŠ è½½æ‰€éœ€è¦çš„SPIä»£ç ï¼Œä¹Ÿå°±æ˜¯çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»å®Œæˆç±»åŠ è½½çš„åŠ¨ä½œï¼Œè¿™ç§è¡Œä¸ºå®é™…ä¸Šå°±æ˜¯æ‰“é€šäº†åŒäº²å§”æ´¾æ¨¡å‹å±‚æ¬¡ç»“æ„æ¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå®é™…ä¸Šå·²ç»è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸€èˆ¬æ€§åŸåˆ™ï¼Œä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ã€‚Javaä¸­æ‰€æœ‰æ¶‰åŠSPIçš„åŠ è½½åŠ¨ä½œåŸºæœ¬ä¸Šéƒ½é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚JNDIã€JDBCã€JCEã€JAXBå’ŒJBIç­‰ã€‚</p><h4 id="ç¬¬ä¸‰æ¬¡ç ´å"><a href="#ç¬¬ä¸‰æ¬¡ç ´å" class="headerlink" title="ç¬¬ä¸‰æ¬¡ç ´å"></a>ç¬¬ä¸‰æ¬¡ç ´å</h4><p>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚å¯¼è‡´çš„ï¼Œè¿™é‡Œæ‰€è¯´çš„â€œåŠ¨æ€æ€§â€æŒ‡çš„æ˜¯å½“å‰ä¸€äº›éå¸¸â€œçƒ­é—¨â€çš„åè¯ï¼šä»£ç çƒ­æ›¿æ¢ã€æ¨¡å—çƒ­éƒ¨ç½²ç­‰ï¼Œç®€ç­”çš„è¯´å°±æ˜¯æœºå™¨ä¸ç”¨é‡å¯ï¼Œåªè¦éƒ¨ç½²ä¸Šå°±èƒ½ç”¨ã€‚<br> OSGiå®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®åˆ™æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ã€‚æ¯ä¸€ä¸ªç¨‹åºæ¨¡å—(Bundle)éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“éœ€è¦æ›´æ¢ä¸€ä¸ªBundleæ—¶ï¼Œå°±æŠŠBundleè¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ã€‚åœ¨OSGiå¹»å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ä¸­çš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„ç½‘çŠ¶ç»“æ„ï¼Œå½“å—åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGiå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢ï¼š<br> 1ï¼‰å°†java.ï¼Šå¼€å¤´çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 2ï¼‰å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 3ï¼‰å¦åˆ™ï¼Œå°†Importåˆ—è¡¨ä¸­çš„ç±»å§”æ´¾ç»™Exportè¿™ä¸ªç±»çš„Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 4ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰Bundleçš„ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 5ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„Fragment Bundleä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å§”æ´¾ç»™Fragment Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 6ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾Dynamic Importåˆ—è¡¨çš„Bundleï¼Œå§”æ´¾ç»™å¯¹åº”Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚<br> 7ï¼‰å¦åˆ™ï¼Œç±»åŠ è½½å™¨å¤±è´¥ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä»‹ç»äº†ç±»åŠ è½½è¿‡ç¨‹çš„<strong>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–</strong>äº”ä¸ªé˜¶æ®µä¸­è™šæ‹Ÿæœºè¿›è¡Œäº†å“ªäº›åŠ¨ä½œï¼Œè¿˜ä»‹ç»äº†ç±»åŠ è½½å™¨çš„å·¥ä½œåŸç†åŠå…¶å †è™šæ‹Ÿæœºçš„æ„ä¹‰</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ </li><li><a href="https://www.jianshu.com/p/166c5360a40b">ç ´ååŒäº²å§”æ´¾æ¨¡å‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·</title>
      <link href="/blog/2018/09/13/fea7515.html"/>
      <url>/blog/2018/09/13/fea7515.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå».</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ç»å¸¸ä½¿ç”¨é€‚å½“çš„è™šæ‹Ÿæœºç›‘æ§å’Œåˆ†æçš„å·¥å…·å¯ä»¥åŠ å¿«æˆ‘ä»¬åˆ†ææ•°æ®å’Œå®šä½é—®é¢˜çš„é€Ÿåº¦ï¼Œä½†æˆ‘ä»¬åœ¨å­¦ä¹ å·¥å…·å‰ï¼Œä¹Ÿåº”å½“æ„è¯†åˆ°å·¥å…·æ°¸è¿œéƒ½æ˜¯çŸ¥è¯†æŠ€èƒ½çš„ä¸€å±‚åŒ…è£…ï¼Œæ²¡æœ‰ä»€ä¹ˆå·¥å…·æ˜¯â€œç§˜å¯†æ­¦å™¨â€ï¼Œå­¦ä¼šäº†å°±èƒ½åŒ…æ²»ç™¾ç—…ã€‚</p><h2 id="JDKçš„å‘½ä»¤è¡Œå·¥å…·"><a href="#JDKçš„å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="JDKçš„å‘½ä»¤è¡Œå·¥å…·"></a>JDKçš„å‘½ä»¤è¡Œå·¥å…·</h2><p>Javaå¼€å‘äººå‘˜è‚¯å®šéƒ½çŸ¥é“JDKçš„binç›®å½•ä¸‹æœ‰â€œjava.exeâ€å’Œâ€œjavac.exeâ€è¿™ä¸¤ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä½†å¹¶éæ‰€æœ‰ç¨‹åºå‘˜éƒ½äº†è§£è¿‡JDKçš„binç›®å½•ä¹‹ä¸­å…¶ä»–å‘½ä»¤è¡Œç¨‹åºçš„ä½œç”¨ã€‚</p><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/04/18/uk8XLj.png" alt="Sun JDKä¸­çš„å·¥å…·ç›®å½•"></p><p>è¿™äº›å·¥å…·ä¸­åŒ…å«äº†ç”¨äºç›‘è§†è™šæ‹Ÿæœºå’Œå…¬ç« å¤„ç†çš„å·¥å…·ã€‚è¿™äº›å·¥å…·éƒ½éå¸¸ç¨³å®šè€Œä¸”åŠŸèƒ½å¼ºå¤§ï¼Œèƒ½åœ¨å¤„ç†åº”ç”¨ç¨‹åºåº”èƒ½é—®é¢˜ã€å®šä½æ•…éšœæ—¶å‘æŒ¥å¾ˆå¤§çš„ä½œç”¨ã€‚</p><blockquote><p>JDKå¼€å‘å›¢é˜Ÿé€‰æ‹©é‡‡ç”¨Javaä»£ç æ¥å®ç°è¿™äº›ç›‘æ§å·¥å…·æ—¶æœ‰ç‰¹åˆ«ç”¨æ„çš„ï¼šå½“ç”¨ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒåï¼Œæ— è®ºæ˜¯ç›´æ¥è§£é™¤ç‰©ç†æœåŠ¡å™¨è¿˜æ˜¯è¿œç¨‹Telnetåˆ°æœåŠ¡å™¨ä¸Šéƒ½å¯èƒ½ä¼šæ”¶åˆ°é™åˆ¶ã€‚å€ŸåŠ©tools.jarç±»åº“é‡Œé¢çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°å¼ºå¤§çš„ç›‘æ§åˆ†æåŠŸèƒ½ã€‚</p></blockquote><h3 id="jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·"><a href="#jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·" class="headerlink" title="jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·"></a>jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·</h3><p>JDKçš„å¾ˆå¤šå°å·¥å…·çš„åå­—éƒ½å‚è€ƒäº†Unixå‘½ä»¤çš„å‘½åæ–¹å¼ï¼Œjpsï¼ˆJVM Process Status Toolï¼‰æ˜¯å…¶ä¸­çš„å…¸å‹ã€‚å¯ä»¥åˆ—å‡ºçœŸè¯¥è¿è¡Œçš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºè™šæ‹Ÿæœºæ‰§è¡Œä¸»ç±»ï¼ˆMain Classï¼Œmain() å‡½æ•°æ‰€åœ¨çš„ç±»ï¼‰çš„åç§°ï¼Œä»¥åŠè¿™äº›è¿›ç¨‹çš„æœ¬åœ°è™šæ‹Ÿæœºçš„å”¯ä¸€IDï¼ˆLVMIDï¼ŒLocal Virtual Machine Identifierï¼‰ã€‚<strong>å¯¹äºæœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹æ¥è¯´ï¼ŒLVMIDä¸æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹IDï¼ˆPIDï¼ŒProcess Identifierï¼‰æ˜¯ä¸€è‡´çš„ï¼Œ</strong>ä½¿ç”¨Windowsçš„ä»»åŠ¡ç®¡ç†å™¨æˆ–Unixçš„pså‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥è¯¢åˆ°è™šæ‹Ÿæœºè¿›ç¨‹çš„LVMIDï¼Œä½†<strong>å¦‚æœåŒæ—¶å¯åŠ¨äº†å¤šä¸ªè™šæ‹Ÿæœºè¿›ç¨‹ï¼Œæ— æ³•æ ¹æ®è¿›ç¨‹åç§°å®šä¸ºæ—¶ï¼Œé‚£å°±åªèƒ½ä»¥æ¥jpså‘½ä»¤æ˜¾ç¤ºä¸»ç±»çš„åŠŸèƒ½æ‰èƒ½åŒºåˆ†äº†ã€‚</strong></p><p><strong>jpså‘½ä»¤æ ¼å¼ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jps [ options ] [ hostid ]</span><br></pre></td></tr></table></figure><p><strong>æ ·ä¾‹ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jps -l</span><br></pre></td></tr></table></figure><p>jpså¯ä»¥é€šè¿‡RMIåè®®æŸ¥è¯¢å¼€å¯äº†RMIæœåŠ¡å™¨çš„è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹çŠ¶æ€ï¼Œhostidä¸ºRMIæ³¨å†Œè¡¨ä¸­æ³¨å†Œçš„ä¸»æœºåã€‚</p><p><em>jpså·¥å…·ä¸»è¦é€‰é¡¹</em></p><table><thead><tr><th align="center">é€‰é¡¹</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="center">-q</td><td align="left">åªè¾“å‡ºLVMIDï¼Œçœç•¥ä¸»ç±»çš„åç§°</td></tr><tr><td align="center">-m</td><td align="left">è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶ä¼ é€’ç»™ä¸»ç±»main()å‡½æ•°çš„å‚æ•°</td></tr><tr><td align="center">-l</td><td align="left">è¾“å‡ºä¸»ç±»çš„å…¨åï¼Œå¦‚æœè¿›ç¨‹æ‰§è¡Œçš„æ˜¯JaråŒ…ï¼Œè¾“å‡ºJarè·¯å¾„</td></tr><tr><td align="center">-v</td><td align="left">è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶JVMå‚æ•°</td></tr></tbody></table><p>â€“</p><h3 id="jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·"><a href="#jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·" class="headerlink" title="jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·"></a>jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·</h3><p>jstatï¼ˆJVM Statistics Monitoring Toolï¼‰æ˜¯ç”¨äºç›‘è§†è™šæ‹Ÿæœº<strong>å„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯</strong>çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒå¯ä»¥<strong>æ˜¾ç¤ºæœ¬åœ°æˆ–è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»åŠ è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ï¼Œ</strong>åœ¨æ²¡æœ‰GUIå›¾å½¢ç•Œé¢ï¼Œåªæä¾›äº†çº¯æ–‡æœ¬æ§åˆ¶å°ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒå°†æ˜¯<strong>è¿è¡ŒæœŸå®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜çš„é¦–é€‰å·¥å…·ã€‚</strong></p><p><strong>jstatå‘½ä»¤æ ¼å¼ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jstat [ option vmid [ interval[s|ms] [ count ] ] ]</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°intervalå’Œcountä»£è¡¨æŸ¥è¯¢é—´éš”å’Œæ¬¡æ•°ï¼Œå¦‚æœçœç•¥è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè¯´æ˜åªæŸ¥è¯¢ä¸€æ¬¡ã€‚</strong>å‡è®¾éœ€è¦æ¯250æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›ç¨‹2764åƒåœ¾æ”¶é›†çš„çŠ¶å†µï¼Œä¸€å…±æŸ¥è¯¢20æ­¤ï¼Œé‚£å‘½ä»¤åº”å½“æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jstat -gc 2764 250 20</span><br></pre></td></tr></table></figure><p>é€‰é¡¹optionä»£è¡¨ç€ç”¨æˆ·å¸Œæœ›æŸ¥è¯¢çš„è™šæ‹Ÿæœºä¿¡æ¯ï¼Œä¸»è¦åˆ†3ç±»ï¼š<strong>ç±»è£…è½½ã€åƒåœ¾æ”¶é›†å’Œè¿è¡ŒæœŸç¼–è¯‘çŠ¶å†µï¼Œ</strong>å…·ä½“é€‰é¡¹åŠä½œç”¨å‚è€ƒä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td align="center">-class</td><td>ç›‘è§†ç±»è£…è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´åŠç±»è£…è½½æ‰€è€—è´¹çš„æ—¶é—´</td></tr><tr><td align="center">-gc</td><td>ç›‘è§†Javaå †çŠ¶å†µï¼ŒåŒ…æ‹¬EdenåŒºã€2ä¸ªSurvivoråŒºã€è€å¹´ä»£ã€<br />æ°¸ä¹…ä»£ç­‰çš„å®¹é‡ã€å·²ç”¨ç©ºé—´ã€GCæ—¶é—´åˆè®¡ç­‰ä¿¡æ¯</td></tr><tr><td align="center">-gccapacity</td><td>ç›‘è§†å†…å®¹ä¸-gcåŸºæœ¬ç›¸åŒï¼Œ<br />ä½†è¾“å‡ºä¸»è¦å…³æ³¨Javaå †å„ä¸ªåŒºåŸŸä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´</td></tr><tr><td align="center">-gcutil</td><td>ç›‘è§†å†…å®¹ä¸-gcåŸºæœ¬ç›¸åŒï¼Œ<br />ä½†è¾“å‡ºä¸»è¦å…³æ³¨å·²ä½¿ç”¨ç©ºé—´å æ€»ç©ºé—´çš„ç™¾åˆ†æ¯”</td></tr><tr><td align="center">-gccause</td><td>ä¸-gcutilçš„åŠŸèƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé¢å¤–è¾“å‡ºå¯¼è‡´ä¸Šä¸€æ¬¡GCäº§ç”Ÿçš„åŸå› </td></tr><tr><td align="center">-gcnew</td><td>ç›‘è§†æ–°ç”Ÿä»£GCçš„çŠ¶å†µ</td></tr><tr><td align="center">-gcnewcapacity</td><td>ç›‘è§†å†…å®¹ä¸-gcnewåŸºæœ¬ç›¸åŒï¼Œ<br />è¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´</td></tr><tr><td align="center">-gcold</td><td>ç›‘è§†è€å¹´ä»£GCçš„çŠ¶å†µ</td></tr><tr><td align="center">-gcoldcapacity</td><td>ç›‘è§†å†…å®¹ä¸-gcoldåŸºæœ¬ç›¸åŒï¼Œ<br />è¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´</td></tr><tr><td align="center">-gcpermcapacity</td><td>è¾“å‡ºæ°¸ä¹…ä»£ä½¿ç”¨çš„æœ€å¤§å’Œæœ€å°ç©ºé—´</td></tr><tr><td align="center">-compiler</td><td>è¾“å‡ºJITç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯</td></tr><tr><td align="center">-printcompilation</td><td>è¾“å‡ºå·²ç»è¢«JITç¼–è¯‘çš„æ–¹æ³•</td></tr></tbody></table><p>â€“</p><h3 id="jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·"><a href="#jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·" class="headerlink" title="jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·"></a>jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·</h3><p>jinfoï¼ˆConfiguration Info for Javaï¼‰çš„ä½œç”¨æ˜¯<strong>å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºçš„å„é¡¹å‚æ•°ã€‚</strong></p><p><strong>æ ¼å¼ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jinfo [ option ] pid</span><br></pre></td></tr></table></figure><p><strong>æ ·ä¾‹ï¼š</strong>æŸ¥è¯¢CMSInitiatingOccupancyFractionå‚æ•°å€¼ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jinfo -flag CMSInitiatingOccupancyFraction 1444</span><br></pre></td></tr></table></figure><h3 id="jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·"><a href="#jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·" class="headerlink" title="jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·"></a>jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·</h3><p>jmapï¼ˆMemory Map for Javaï¼‰å‘½ä»¤<strong>ç”¨äºç”Ÿæˆå †è½¬å‚¨å¿«ç…§ï¼ˆä¸€èˆ¬ç§°ä¸ºheapdumpæˆ–dumpæ–‡ä»¶ï¼‰ã€‚</strong>jmapçš„ä½œç”¨å¹¶ä¸ä»…ä»…æ˜¯ä¸ºäº†è·å–dumpæ–‡ä»¶ï¼Œ<strong>å®ƒè¿˜å¯ä»¥æŸ¥è¯¢finalizeæ‰§è¡Œé˜Ÿåˆ—ï¼ŒJavaå †å’Œæ°¸ä¹…ä»£çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ç©ºé—´ä½¿ç”¨ç‡ã€å½“å‰ç”¨çš„æ˜¯å“ªç§æ”¶é›†å™¨ç­‰ã€‚</strong></p><p><strong>æ ¼å¼ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jmap [ option ] vmid</span><br></pre></td></tr></table></figure><p>å‚æ•°è¡¨ï¼š</p><table><thead><tr><th align="center">é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td align="center">-dump</td><td>ç”ŸæˆJavaå †è½¬å‚¨å¿«ç…§ï¼Œ<br />æ ¼å¼ï¼š-dump:[live,]format=b,file=filename,<br />å…¶ä¸­liveå­å‚æ•°è¯´æ˜æ˜¯å¦åªdumpå‡ºå­˜æ´»çš„å¯¹è±¡</td></tr><tr><td align="center">-finalizerinfo</td><td>æ˜¾ç¤ºåœ¨F-Queueä¸­ç­‰å¾…Finalizerçº¿ç¨‹æ‰§è¡Œfinalizeæ–¹æ³•çš„å¯¹è±¡ã€‚<br />åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ</td></tr><tr><td align="center">-heap</td><td>æ˜¾ç¤ºJavaå †è¯¦ç»†ä¿¡æ¯ï¼Œ <br />å¦‚ä½¿ç”¨é‚£ç§å›æ”¶å™¨ã€å‚æ•°é…ç½®åˆ†ä»£çŠ¶å†µç­‰ã€‚<br />åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ</td></tr><tr><td align="center">-histo</td><td>æ˜¾ç¤ºå †ä¸­å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»ã€å®ä¾‹æ•°é‡å’Œåˆè®¡å®¹é‡</td></tr><tr><td align="center">-permstat</td><td>ä»¥ClassLoaderä¸ºç»Ÿè®¡å£å¾„æ˜¾ç¤ºæ°¸ä¹…ä»£çš„å†…å­˜çŠ¶æ€ã€‚<br />åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ</td></tr><tr><td align="center">-F</td><td>å½“è™šæ‹Ÿæœºè¿›ç¨‹å †-dumpé€‰é¡¹æ²¡æœ‰å“åº”æ—¶ï¼Œå¯ä½¿ç”¨è¿™ä¸ªé€‰é¡¹å¼ºåˆ¶ç”Ÿæˆdumpå¿«ç…§ã€‚<br />åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ</td></tr></tbody></table><p>â€“</p><h3 id="jhatï¼šè™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·"><a href="#jhatï¼šè™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·" class="headerlink" title="jhatï¼šè™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·"></a>jhatï¼šè™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·</h3><p>ä¸jmapæ­é…ä½¿ç”¨ï¼Œæ¥<strong>åˆ†æjmapç”Ÿæˆçš„å †è½¬å‚¨å¿«ç…§ã€‚</strong></p><h3 id="jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·"><a href="#jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·" class="headerlink" title="jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·"></a>jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·</h3><p>jstackï¼ˆStack Trace for Javaï¼‰å‘½ä»¤ç”¨äº<strong>ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»å¿«ç…§ã€‚çº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆï¼Œ</strong>ç”Ÿæˆçº¿ç¨‹å¿«ç…§çš„ä¸»è¦ç›®çš„æ˜¯<strong>å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œ</strong>å¦‚çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´ç­‰å¾…éƒ½æ˜¯å¯¼è‡´çº¿ç¨‹é•¿æ—¶é—´åœé¡¿çš„å¸¸è§åŸå› ã€‚</p><p><strong>æ ¼å¼ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jstack [ option ] vmid</span><br></pre></td></tr></table></figure><p>å‚æ•°è¡¨ï¼š</p><table><thead><tr><th align="center">é€‰é¡¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td align="center">-F</td><td>å½“æ­£å¸¸è¾“å‡ºè¯·æ±‚ä¸è¢«å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆ</td></tr><tr><td align="center">-l</td><td>é™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºé”çš„é™„åŠ ä¿¡æ¯</td></tr><tr><td align="center">-m</td><td>å¦‚æœè°ƒç”¨åˆ°æœ¬åœ°æ–¹æ³•çš„è¯ï¼Œå¯ä»¥æ˜¾ç¤ºC/C++çš„å †æ ˆ</td></tr></tbody></table><p>â€“</p><h2 id="JDKçš„å¯è§†åŒ–å·¥å…·"><a href="#JDKçš„å¯è§†åŒ–å·¥å…·" class="headerlink" title="JDKçš„å¯è§†åŒ–å·¥å…·"></a>JDKçš„å¯è§†åŒ–å·¥å…·</h2><p>JDKä¸­é™¤äº†æä¾›å¤§é‡çš„å‘½ä»¤è¡Œå·¥å…·å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–å·¥å…·ï¼š<strong>JConsoleå’ŒVisualVMï¼Œ</strong>è¿™ä¸¤ä¸ªå·¥å…·æ—¶JDKçš„æ­£å¼æˆå‘˜ã€‚</p><h3 id="JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°"><a href="#JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°" class="headerlink" title="JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°"></a>JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°</h3><p>JConsoleæ˜¯ä¸€æ¬¾åŸºäºJMXçš„å¯è§†åŒ–ç›‘è§†ç®¡ç†çš„å·¥å…·ã€‚å®ƒç®¡ç†éƒ¨åˆ†çš„åŠŸèƒ½æ—¶é’ˆå¯¹JMX MBeanè¿›è¡Œç®¡ç†ï¼ŒMBeanå¯ä»¥ä½¿ç”¨ä»£ç ã€ä¸­é—´ä»¶æœåŠ¡å™¨çš„ç®¡ç†æ§åˆ¶å°æˆ–è€…æ‰€æœ‰ç¬¦åˆJMXè§„èŒƒçš„è½¯ä»¶è¿›è¡Œè®¿é—®ã€‚</p><p>å‚è€ƒæ–‡çŒ®ï¼š</p><ul><li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/management/jconsole.html">å®˜æ–¹æ–‡æ¡£</a></li><li><a href="http://jiajun.iteye.com/blog/810150">å¦‚ä½•åˆ©ç”¨ JConsoleè§‚å¯Ÿåˆ†æJavaç¨‹åºçš„è¿è¡Œï¼Œè¿›è¡Œæ’é”™è°ƒä¼˜</a></li><li><a href="https://www.jianshu.com/p/290489f0a495">JVMæ£€æµ‹åˆ†æJConsole</a></li></ul><h3 id="VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·"><a href="#VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·" class="headerlink" title="VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·"></a>VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·</h3><p>VisualVMæ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒéšJDKå‘å¸ƒçš„åŠŸèƒ½æœ€å¼ºå¤§çš„è¿è¡Œç›‘è§†å’Œæ•…éšœå¤„ç†ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥é¢„è§åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…éƒ½æ˜¯å®˜æ–¹ä¸»åŠ›å‘å±•çš„è™šæ‹Ÿæœºæ•…éšœå¤„ç†å·¥å…·ã€‚</p><p>å‚è€ƒæ–‡çŒ®ï¼š</p><ul><li><a href="https://visualvm.github.io/">https://visualvm.github.io/</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-visualvm/index.html">ä½¿ç”¨ VisualVM è¿›è¡Œæ€§èƒ½åˆ†æåŠè°ƒä¼˜</a></li><li><a href="https://www.jianshu.com/p/9b0283fead2b">å­¦ä¹ Java VisualVMçš„ä½¿ç”¨</a></li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä»‹ç»äº†éšJDKå‘å¸ƒçš„6ä¸ªå‘½ä»¤è¡Œå·¥å…·å’Œ2ä¸ªå¯è§†åŒ–çš„æ•…éšœå¤„ç†å·¥å…·ï¼Œçµæ´»ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¯ä»¥ç»™å¤„ç†é—®é¢˜å¸¦æ¥å¾ˆå¤§çš„ä¾¿åˆ©ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ </li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥</title>
      <link href="/blog/2018/09/11/ddb92a08.html"/>
      <url>/blog/2018/09/11/ddb92a08.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå».</p></blockquote><h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>åƒåœ¾æ”¶é›†éœ€è¦å®Œæˆçš„ä¸‰ä»¶äº‹æƒ…ï¼š</p><ul><li>å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ</li><li>ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ</li><li>å¦‚ä½•å›æ”¶ï¼Ÿ</li></ul><p><em>å†…å­˜çš„åŠ¨æ€åˆ†é…å’Œå†…å­˜å›æ”¶æŠ€æœ¯å·²ç»ç›¸å½“æˆç†Ÿï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å»äº†è§£GCå’Œå†…å­˜åˆ†é…å‘¢ï¼Ÿ</em></p><p>ç­”æ¡ˆå¾ˆç®€å•ï¼š<strong>å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æ”¶é›†æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚</strong></p><p>Javaè¿è¡Œæ—¶åŒºåŸŸçš„å„ä¸ªéƒ¨åˆ†ä¸­ï¼Œ<strong>ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ</strong>ä¸‰ä¸ªåŒºåŸŸéšçº¿ç¨‹è€Œç”Ÿï¼Œéšçº¿ç¨‹è€Œç­ï¼›æ ˆä¸­çš„æ ˆå¸§éšç€æ–¹æ³•çš„è¿›å…¥å’Œé€€å‡ºè€Œæœ‰æ¡ä¸ç´Šçš„æ‰§è¡Œç€å‡ºæ ˆå’Œå…¥æ ˆæ“ä½œã€‚æ¯ä¸ªæ ˆå¸§ä¸­åˆ†é…å¤šå°‘å†…å­˜åŸºæœ¬ä¸Šæ˜¯åœ¨ç±»ç»“æ„ç¡®å®šä¸‹æ¥æ—¶å°±æ˜¯å·²ç»çŸ¥é“çš„ï¼Œå› æ­¤è¿™å‡ ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½å…·å¤‡ç¡®å®šæ€§ï¼Œåœ¨è¿™å‡ ä¸ªåŒºåŸŸå†…ä¸éœ€è¦è¿‡å¤šè€ƒè™‘å›æ”¶é—®é¢˜ï¼Œå› ä¸ºåœ¨æ–¹æ³•ç»“æŸæˆ–çº¿ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œå†…å­˜è‡ªç„¶å°±è·Ÿç€å›æ”¶äº†ã€‚</p><p><strong>Javaå †å’Œæ–¹æ³•åŒº</strong>åˆ™ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ¥å£ä¸­çš„å¤šä¸ªå®ç°ç±»éœ€è¦çš„å†…å­˜å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ–¹æ³•ä¸­çš„å¤šä¸ªåˆ†æ”¯éœ€è¦çš„å†…å­˜ä¹Ÿå¯èƒ½ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªæœ‰åœ¨ç¨‹åºå¤„äºè¿è¡ŒæœŸé—´æ—¶æ‰èƒ½çŸ¥é“ä¼šåˆ›å»ºå“ªäº›å¯¹è±¡ï¼Œè¿™éƒ¨åˆ†çš„åˆ†é…å’Œå›æ”¶éƒ½æ˜¯åŠ¨æ€çš„ï¼Œåƒåœ¾æ”¶é›†å™¨æ‰€å…³æ³¨çš„æ˜¯è¿™éƒ¨åˆ†å†…å­˜ã€‚</p><h2 id="äºŒã€å¯¹è±¡å·²æ­»ï¼Ÿ"><a href="#äºŒã€å¯¹è±¡å·²æ­»ï¼Ÿ" class="headerlink" title="äºŒã€å¯¹è±¡å·²æ­»ï¼Ÿ"></a>äºŒã€å¯¹è±¡å·²æ­»ï¼Ÿ</h2><blockquote><p>å †ä¸­å‡ ä¹å­˜æ”¾è¿™Javaä¸–ç•Œä¸­æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼Œåƒåœ¾æ”¶é›†å™¨åœ¨å¯¹å †è¿›è¡Œå›æ”¶å‰ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯è¦ç¡®å®šè¿™äº›å¯¹è±¡æœ‰å“ªäº›è¿˜â€œæ´»ç€â€ï¼Œå“ªäº›å·²ç»â€œæ­»å»â€ã€‚</p></blockquote><h3 id="1ã€å¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#1ã€å¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="1ã€å¼•ç”¨è®¡æ•°ç®—æ³•"></a>1ã€å¼•ç”¨è®¡æ•°ç®—æ³•</h3><p>ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨æ¶ˆå¤±æ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡1ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨éƒ½ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚</p><p><strong>Javaè¯­è¨€ä¸­æ²¡æœ‰é€‰ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•å‘çš„é—®é¢˜ã€‚</strong></p><p>ä¾‹ï¼šå½“ä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œé™¤æ­¤ä¹‹å¤–ä¸¤ä¸ªå¯¹è±¡å†æ— ä»»ä½•å¼•ç”¨ï¼Œå®é™…ä¸Šè¿™ä¸¤ä¸ªå¯¹è±¡å·²ç»ä¸å¯èƒ½å†è¢«è®¿é—®ï¼Œä½†æ˜¯ä»–ä»¬å› ä¸º<strong>äº’ç›¸å¼•ç”¨ç€å¯¹æ–¹ï¼Œå¯¼è‡´ä»–ä»¬çš„å¼•ç”¨è®¡æ•°éƒ½ä¸ä¸º0ï¼Œ</strong>äºæ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•é€šçŸ¥GCæ”¶é›†å™¨å›æ”¶å®ƒä»¬ã€‚</p><h3 id="2ã€æ ¹æœç´¢ç®—æ³•"><a href="#2ã€æ ¹æœç´¢ç®—æ³•" class="headerlink" title="2ã€æ ¹æœç´¢ç®—æ³•"></a>2ã€æ ¹æœç´¢ç®—æ³•</h3><p>åœ¨ä¸»æµçš„å•†ç”¨ç¨‹åºè¯­è¨€ä¸­ï¼ˆJavaå’ŒC#ï¼‰éƒ½ä½¿ç”¨æ ¹æœç´¢ç®—æ³•ï¼ˆGC Roots Tracingï¼‰åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€è·¯å°±æ˜¯<strong>é€šè¿‡ä¸€ç³»åˆ—åä¸ºâ€œGC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€æœ‰èµ°è¿‡çš„è·¯å¾„æˆä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼ˆç”¨å›¾è®ºçš„è¯æ¥è¯´å°±æ˜¯ä»GC Rootsåˆ°è¿™ä¸ªå¯¹è±¡ä¸å¯è¾¾ï¼‰æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚</strong></p><p>åœ¨Javaè¯­è¨€é‡Œï¼Œå¯ä½œä¸ºGC Rootsçš„å¯¹è±¡åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š</p><ul><li>è™šæ‹Ÿæœºæ ˆï¼ˆ<strong>æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨</strong>ï¼‰ä¸­çš„å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„<strong>ç±»é™æ€å±æ€§</strong>å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„<strong>å¸¸é‡</strong>å¼•ç”¨çš„å¯¹è±¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸­<strong>JNI</strong>ï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰çš„å¼•ç”¨çš„å¯¹è±¡</li></ul><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/1.jpg" alt="è·Ÿæœç´¢ç®—æ³•åˆ¤å®šå¯¹è±¡æ˜¯å¦å¯å›æ”¶"></p><h3 id="3ã€å¼•ç”¨"><a href="#3ã€å¼•ç”¨" class="headerlink" title="3ã€å¼•ç”¨"></a>3ã€å¼•ç”¨</h3><p>æ— è®ºæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯ é€šè¿‡æ ¹æœç´¢ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨é“¾æ˜¯å¦å¯è¾¾ï¼Œåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»éƒ½ä¸â€œå¼•ç”¨â€æœ‰å…³ã€‚</p><blockquote><p><strong>åœ¨JDK1.2ä¹‹å‰ï¼ŒJavaä¸­çš„å¼•ç”¨çš„å®šä¹‰å¾ˆä¼ ç»Ÿï¼šå¦‚æœreferenceç±»å‹çš„æ•°æ®ä¸­å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦å¤–ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ç€ä¸€ä¸ªå¼•ç”¨ã€‚</strong></p></blockquote><p>è¿™ç§å®šä¹‰å¾ˆå­˜ç²¹ï¼Œä½†æ˜¯å¤ªè¿‡ç‹­éš˜ï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™ç§å®šä¹‰ä¸‹åªæœ‰è¢«å¼•ç”¨æˆ–è€…æ²¡æœ‰è¢«å¼•ç”¨ä¸¤ç§çŠ¶æ€ã€‚å¸Œæœ›èƒ½æè¿°è¿™æ ·ä¸€ç±»å¯¹è±¡ï¼š<strong>å½“å†…å­˜ç©ºé—´è¿˜è¶³å¤Ÿæ—¶ï¼Œåˆ™èƒ½ä¿ç•™åœ¨å†…å­˜ä¹‹ä¸­ï¼›å¦‚æœå†…å­˜åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†åè¿˜æ˜¯éå¸¸è¿›åœºï¼Œåˆ™å¯ä»¥æŠ›å¼ƒè¿™äº›å¯¹è±¡ã€‚</strong></p><p>Javaå †å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºï¼š<strong>å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ã€è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ã€å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ã€è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰</strong>å››ç§ï¼Œè¿™å››ç§å¼•ç”¨çš„å¼ºåº¦ä¸€æ¬¡ç»„å»ºå‡å¼±ã€‚</p><ul><li><strong>å¼ºå¼•ç”¨ï¼š</strong>åœ¨ç¨‹åºä»£ç ä¹‹é—´æ™®éå­˜åœ¨çš„ï¼Œç±»ä¼¼â€œObject obj = new Object()â€è¿™ç±»çš„å¼•ç”¨ï¼Œ<strong>åªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨æ°¸è¿œä¸ä¼šå›æ”¶è°ƒè¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</strong></li><li><strong>è½¯å¼•ç”¨ï¼š</strong>ç”¨æ¥æè¿°ä¸€äº›è¿˜ç”¨ï¼Œä½†å¹¶éå¿…é¡»çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨<strong>ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­å¹¶è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚</strong>å¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</li><li><strong>å¼±å¼•ç”¨ï¼š</strong>ç”¨æ¥æè¿°éå¿…é¡»çš„å¯¹è±¡çš„ï¼Œå®ƒçš„å¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œ<strong>è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ã€‚</strong>å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</li><li><strong>xuè™šå¼•ç”¨ï¼š</strong>åˆç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚<strong>ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚</strong>ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯å¸Œæœ›èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶å—åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</li></ul><h3 id="4ã€ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡"><a href="#4ã€ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡" class="headerlink" title="4ã€ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡"></a>4ã€ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡</h3><p>åœ¨è·Ÿæœç´¢ç®—æ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ—¶â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™ä¸ªæ—¶å€™ä»–ä»¬å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µï¼Œè¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†<strong>ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š</strong> <em>å¦‚æœå¯¹è±¡åœ¨è¿›è¡Œè·Ÿæœç´¢åå‘ç°æ²¡æœ‰ä¸GC Rootsç›¸è¿æ¥çš„å¼•ç”¨é“¾ï¼Œé‚£å®ƒå°†ä¼šè¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ—¶æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œ<code>finalize()</code>æ–¹æ³•ã€‚</em></p><blockquote><p>å½“å¯¹è±¡æ²¡æœ‰è¦†ç›–<code>finalize()</code>æ–¹æ³•ï¼Œæˆ–è€…<code>finalize()</code>æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºç”¨è¿‡ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µéƒ½è§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ã€‚</p></blockquote><p>å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸ºæœ‰å¿…è¦æ‰§è¡Œ<code>finalize()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªåä¸º<code>F-Queue</code>çš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€æ¡ç”±è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹å»æ‰§è¡Œã€‚</p><p><strong>ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„<code>finalize()</code>æ–¹æ³•éƒ½åªä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå¯¹è±¡é¢ä¸´ä¸‹ä¸€æ¬¡å›æ”¶ï¼Œå®ƒçš„<code>finalize()</code>æ–¹æ³•ä¸ä¼šå†æ¬¡æ‰§è¡Œ</strong></p><blockquote><p><code>finalize()</code>èƒ½åšçš„æ‰€æœ‰å·¥ä½œï¼Œä½¿ç”¨<code>try-finally</code>æˆ–è€…å…¶ä»–æ–¹å¼éƒ½å¯ä»¥åšå¾—æ›´å¥½ã€æ›´åŠæ—¶ã€‚<strong>å®Œå…¨å¯ä»¥å¿˜æ‰Javaè¯­è¨€ä¸­è¿˜æœ‰è¿™ä¸ªæ–¹æ³•å­˜åœ¨ã€‚</strong></p></blockquote><h3 id="5ã€å›æ”¶æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰"><a href="#5ã€å›æ”¶æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰" class="headerlink" title="5ã€å›æ”¶æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰"></a>5ã€å›æ”¶æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰</h3><blockquote><p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯´è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºå†æ–¹æ³•åŒºå®ç°åƒåœ¾æ”¶é›†ï¼Œè€Œä¸”å†æ–¹æ³•åŒºè¿›è¡Œåƒåœ¾æ”¶é›†çš„â€œæ€§ä»·æ¯”â€ä¸€èˆ¬æ¯”è¾ƒä½ï¼šå†å †ä¸­ï¼Œå°¤å…¶æ˜¯å†æ–°ç”Ÿä»£ä¸­ï¼Œå¸¸è§„åº”ç”¨è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†ä¸€èˆ¬å¯ä»¥å›æ”¶70%~95%çš„ç©ºé—´ï¼Œè€Œæ°¸ä¹…ä»£çš„åƒåœ¾æ”¶é›†æ•ˆç‡è¿œä½äºæ­¤ã€‚</p></blockquote><p>æ°¸ä¹…ä»£çš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼š<strong>åºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±»ã€‚</strong></p><p>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦æ˜¯â€œ<strong>åºŸå¼ƒå¸¸é‡</strong>â€æ¯”è¾ƒç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯â€œæ— ç”¨çš„ç±»â€çš„æ¡ä»¶åˆ™ç›¸å¯¹è‹›åˆ»è®¸å¤šã€‚ç±»éœ€è¦æ»¡è¶³3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯â€œ<strong>æ— ç”¨çš„ç±»ï¼š</strong>â€</p><ul><li><strong>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹</strong></li><li><strong>åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶</strong></li><li><strong>è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</strong></li></ul><p>è™šæ‹Ÿæœºå¯ä»¥å †æ»¡è¶³ä¸Šè¿°3ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œä¸ä½¿ç”¨äº†å°±å¿…ç„¶ä¼šè¢«å›æ”¶ã€‚</p><p><em>åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLibç­‰bytecodeæ¡†æ¶çš„åœºæ™¯ï¼Œä»¥åŠåŠ¨æ€ç”ŸæˆJSPå’ŒOSGiè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ClassLoaderçš„åœºæ™¯éƒ½éœ€è¦è™šæ‹Ÿæœºå…·å¤‡ç±»å¸è½½çš„åŠŸèƒ½ï¼Œä»¥ä¿è¯æ°¸ä¹…ä»£ä¸ä¼šæº¢å‡ºã€‚</em></p><h2 id="ä¸‰ã€åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#ä¸‰ã€åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="ä¸‰ã€åƒåœ¾æ”¶é›†ç®—æ³•"></a>ä¸‰ã€åƒåœ¾æ”¶é›†ç®—æ³•</h2><p>ä»‹ç»å‡ ç§ç®—æ³•çš„æ€æƒ³åŠå…¶å‘å±•è¿‡ç¨‹ã€‚</p><h3 id="1ã€æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#1ã€æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="1ã€æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>1ã€æ ‡è®°-æ¸…é™¤ç®—æ³•</h3><p>æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•æ˜¯â€œæ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰â€ç®—æ³•ï¼š<strong>é¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶è°ƒæ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚</strong>å®ƒä¸»è¦ç¼ºç‚¹æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯<strong>æ•ˆç‡é—®é¢˜</strong>ï¼Œæ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›å¦å¤–ä¸€ä¸ªæ˜¯<strong>ç©ºé—´é—®é¢˜</strong>ï¼Œæ ‡è®°æ¸…é™¤ä¹‹åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œç©ºé—´ç¢ç‰‡å¤ªå¤šå¯èƒ½ä¼šå¯¼è‡´ï¼Œå½“ç¨‹åºåœ¨ä»¥åçš„è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶æ— æ³•æ‰¾åˆ°è¶³å¤Ÿçš„è¿ç»­å†…å­˜è€Œä¸å¾—ä¸æå‰è§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/2.jpg" alt="&quot;æ ‡è®°-æ¸…é™¤&quot;ç®—æ³•"></p><h3 id="2ã€å¤åˆ¶ç®—æ³•"><a href="#2ã€å¤åˆ¶ç®—æ³•" class="headerlink" title="2ã€å¤åˆ¶ç®—æ³•"></a>2ã€å¤åˆ¶ç®—æ³•</h3><p>ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œäºæ˜¯å°±æœ‰äº†â€œå¤åˆ¶ï¼ˆCopyingï¼‰â€ç®—æ³•ã€‚<strong>å®ƒå°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚</strong>è¿™æ ·ä½¿å¾—æ¯æ¬¡éƒ½æ˜¯å †å…¶ä¸­çš„ä¸€å—è¿›è¡Œå†…å­˜å›æ”¶ï¼Œå†…å­˜åˆ†é…æ—¶ä¹Ÿå°±ä¸ç”¨è€ƒè™‘å†…å­˜ç¢ç‰‡ç­‰å¤æ‚æƒ…å†µï¼Œåªè¦ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆï¼ŒæŒ‰é¡ºåºåˆ†é…å†…å­˜å³å¯ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚<strong>ä½†æ˜¯è¿™ç§ç®—æ³•çš„ä»£ä»·æ—¶å°†å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€èˆ¬ã€‚</strong></p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/3.jpg" alt="å¤åˆ¶ç®—æ³•"></p><blockquote><p>ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½é‡‡ç”¨è¿™ç§æ”¶é›†ç®—æ³•æ¥å›æ”¶æ–°ç”Ÿä»£ï¼ŒIBMçš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡98%æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æŒ‰ç…§1:1çš„æ¯”ä¾‹æ¥åˆ’åˆ†å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯<strong>å°†å†…å­˜åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„Edenç©ºé—´å’Œä¸¤å—è¾ƒå°çš„Survivorç©ºé—´ï¼Œæ¯æ¬¡ä½¿ç”¨Edenå’Œå…¶ä¸­çš„ä¸€å—Survivorã€‚å½“å›æ”¶æ—¶ï¼Œå°†Edenå’ŒSurvivorä¸­è¿˜æ´»ç€çš„å¯¹è±¡ä¸€æ¬¡æ€§æ‹·è´åˆ°å¦å¤–ä¸€å—Survivorç©ºé—´ä¸Šï¼Œæœ€åæ¸…ç†è°ƒEdenå’Œåˆšæ‰ç”¨è¿‡çš„Survivorçš„ç©ºé—´ã€‚</strong></p><p>Hotspotè™šæ‹Ÿæœºé»˜è®¤Edenå’ŒSurvivorçš„å¤§å°æ¯”ä¾‹æ—¶8:1ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡æ–°ç”Ÿä»£ä¸­å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ•´ä¸ªæ–°ç”Ÿä»£å®¹é‡çš„90%(80%+10%)ï¼Œåªæœ‰10%çš„å†…å­˜æ˜¯ä¼šè¢«â€œæµªè´¹â€çš„ã€‚</p></blockquote><h3 id="3ã€æ ‡è®°-æ•´ç†ç®—æ³•"><a href="#3ã€æ ‡è®°-æ•´ç†ç®—æ³•" class="headerlink" title="3ã€æ ‡è®°-æ•´ç†ç®—æ³•"></a>3ã€æ ‡è®°-æ•´ç†ç®—æ³•</h3><p>å¤åˆ¶æ”¶é›†ç®—æ³•åœ¨å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜æ—¶å°±è¦æ‰§è¡Œè¾ƒå¤šçš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡å°†ä¼šå˜ä½ã€‚æ›´å…³é”®çš„æ˜¯ï¼Œå¦‚æœä¸æƒ³æµªè´¹50%çš„ç©ºé—´ï¼Œå°±éœ€è¦æœ‰é¢å¤–çš„ç©ºé—´è¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œä»¥åº”å¯¹è¢«ä½¿ç”¨çš„å†…å­˜ä¸­æ‰€æœ‰å¯¹è±¡éƒ½100%å­˜æ´»çš„æç«¯æƒ…å†µï¼Œæ‰€ä»¥åœ¨è€å¹´ä»£ä¸€èˆ¬ä¸èƒ½ç›´æ¥é€‰ç”¨è¿™ç§ç®—æ³•ã€‚</p><p>æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹ï¼Œæå‡ºäº†â€æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰â€œç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€æ ‡è®°-æ¸…é™¤â€œç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å †å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯<strong>è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†è°ƒç«¯è¾¹ç•Œæ„å¤–çš„å†…å­˜ã€‚</strong></p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/4.jpg" alt="æ ‡è®°-æ•´ç†(Mark-Compact)"></p><h3 id="4ã€åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#4ã€åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="4ã€åˆ†ä»£æ”¶é›†ç®—æ³•"></a>4ã€åˆ†ä»£æ”¶é›†ç®—æ³•</h3><p>å½“å‰å•†ä¸šè™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨â€åˆ†ä»£æ”¶é›†â€œï¼ˆGenerational Collectionï¼‰ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆæ–°çš„æ€æƒ³ï¼Œåªæ˜¯<strong>æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬æ˜¯æŠŠJavaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é‡‡ç”¨æœ€é€‚åˆçš„æ”¶é›†ç®—æ³•ã€‚</strong></p><ul><li>åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†æ—¶éƒ½å‘ç°æœ‰å¤§æ‰¹å¯¹è±¡æ­»å»ï¼Œåªæœ‰å°‘é‡å­˜æ´»ï¼Œé‚£å°±é€‰ç”¨å¤åˆ¶ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å­˜è´§å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ”¶é›†ã€‚</li><li>åœ¨è€å¹´ä»£ä¸­å› ä¸ºå¯¹è±¡å­˜æ´»ç‡é«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å †å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»ä½¿ç”¨â€æ ‡è®°-æ¸…ç†â€œæˆ–â€æ ‡è®°-æ•´ç†â€œç®—æ³•æ¥è¿›è¡Œå›æ”¶ã€‚</li></ul><h2 id="å››ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"><a href="#å››ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥" class="headerlink" title="å››ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"></a>å››ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥</h2><blockquote><p>Javaè®¡æ•°ä¹ é¢˜ä¸­æ‰€æå€¡çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœ€ç»ˆå¯ä»¥å½’ç»“ä¸ºè‡ªåŠ¨åŒ–åœ°è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š<strong>ç»™å¯¹è±¡åˆ†é…å†…å­˜ä»¥åŠå›æ”¶åˆ†é…ç»™å¯¹è±¡çš„å†…å­˜ã€‚</strong></p></blockquote><p>å¯¹è±¡çš„é‚£å†…å­˜åˆ†é…ï¼Œå¾€å¤§æ–¹å‘ä¸Šè®²ï¼Œå°±æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼Œ<strong>å¯¹è±¡ä¸»è¦åˆ†é…åœ¨æ–°ç”Ÿä»£çš„EdenåŒºä¸Šï¼Œ</strong>å¦‚æœå¯åŠ¨äº†æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼Œå°†æŒ‰çº¿ç¨‹ä¼˜å…ˆåœ¨TLABä¸Šåˆ†é…ã€‚å°‘æ•°æƒ…å†µä¸‹ä¹Ÿå¯èƒ½ä¼šç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ä¸­ï¼Œåˆ†é…çš„è§„åˆ™å¹¶ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾å›ºå®šçš„ï¼Œå…¶ç»†èŠ‚å–å†³äºå½“å‰ä½¿ç”¨çš„æ—¶å“ªä¸€ç§åƒåœ¾æ”¶é›†å™¨ç»„åˆï¼Œè¿˜æœ‰è™šæ‹Ÿæœºä¸­ä¸å†…å­˜ç›¸å…³çš„å‚æ•°çš„è®¾ç½®ã€‚</p><h3 id="1ã€å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…"><a href="#1ã€å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…" class="headerlink" title="1ã€å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…"></a>1ã€å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…</h3><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ å¯¹è±¡å­—æ–°ç”Ÿä»£EdenåŒºä¸­åˆ†é…ã€‚å½“EdenåŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡Minor GCã€‚</p><p><em>Minor GCå’ŒFull GCçš„åŒºåˆ«ï¼Ÿ</em></p><ul><li>æ–°ç”Ÿä»£GCï¼ˆMinor GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œï¼Œå› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚</li><li>è€å¹´ä»£GCï¼ˆMajor GC / Full GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå‡ºç°äº†Major GCï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼‰ã€‚Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10æ¯ä»¥ä¸Šã€‚</li></ul><h3 id="2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"><a href="#2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£" class="headerlink" title="2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"></a>2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</h3><p>æ‰€è°“å¤§å¯¹è±¡æ˜¯æŒ‡ï¼Œéœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„Javaå¯¹è±¡ï¼Œæœ€ç»å…¸çš„å¤§å¯¹è±¡å°±æ˜¯é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²åŠæ•°ç»„ã€‚</p><blockquote><p>å¤§å¯¹è±¡å †è™šæ‹Ÿæœºçš„å†…å­˜åˆ†é…æ¥è¯´å°±æ˜¯ä¸€ä¸ªåæ¶ˆæ¯ï¼Œç»å¸¸å‡ºç°å¤§å¯¹è±¡å®¹æ˜“å¯¼è‡´å†…å­˜è¿˜æœ‰ä¸å°‘ç©ºé—´æ—¶å°±æå‰è§¦å‘åƒåœ¾æ”¶é›†ä»¥è·å–è¶³å¤Ÿçš„è¿ç»­ç©ºé—´æ¥â€œå®‰ç½®â€å®ƒä»¬ã€‚</p></blockquote><h3 id="3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"><a href="#3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£" class="headerlink" title="3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"></a>3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£</h3><p>è™šæ‹Ÿæœºæ—¢ç„¶é‡‡ç”¨äº†åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œé‚£å†…å­˜å›æ”¶æ—¶å°±å¿…é¡»èƒ½è¯†åˆ«å“ªäº›å¯¹è±¡åº”å½“æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œå“ªäº›å¯¹è±¡åº”æ”¾åœ¨è€å¹´ä»£ä¸­ã€‚ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ª<strong>å¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚</strong>å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œ å°†è¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨SurvivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆ15ï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p><h3 id="4ã€åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"><a href="#4ã€åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š" class="headerlink" title="4ã€åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"></a>4ã€åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š</h3><p>ä¸ºäº†èƒ½æ›´å¥½çš„åœ°é€‚åº”ä¸åŒç¨‹åºçš„å†…å­˜çŠ¶å†µï¼Œè™šæ‹Ÿæœºå¹¶ä¸èƒ½æ€»æ˜¯è¦æ±‚å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ°<code>MaxTenuringThreshold</code>æ‰èƒ½æ™‹å‡è€å¹´ä»£ï¼Œ<strong>å¦‚æœåœ¨Survivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚</strong></p><h3 id="5ã€ç©ºé—´åˆ†é…æ‹…ä¿"><a href="#5ã€ç©ºé—´åˆ†é…æ‹…ä¿" class="headerlink" title="5ã€ç©ºé—´åˆ†é…æ‹…ä¿"></a>5ã€ç©ºé—´åˆ†é…æ‹…ä¿</h3><p>åœ¨å‘ç”ŸMinor GCæ—¶ï¼Œè™šæ‹Ÿæœºä¼šæ£€æµ‹ä¹‹å‰æ¯æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹³å‡å¤§å°æ˜¯å¦å¤§äºè€å¹´ä»£çš„ç”Ÿäºç©ºé—´å¤§å°ï¼Œå¦‚æœå¤§äºï¼Œåˆ™æ”¹ä¸ºç›´æ¥è¿›è¡Œä¸€æ¬¡Full GCã€‚å¦‚æœå°äºï¼Œåˆ™æŸ¥çœ‹HandlePromotionFailureè®¾ç½®æ˜¯å¦å…è®¸æ‹…ä¿æ—¶æŠ¥ï¼›å¦‚æœå…è®¸ï¼Œé‚£æŒ‡æŒ¥è¿›è¡ŒMinor GCï¼›å¦‚æœä¸å…è®¸ï¼Œåˆ™ä¹Ÿè¦æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å†…å­˜å›æ”¶ä¸åƒåœ¾æ”¶é›†å™¨åœ¨å¾ˆå¤šæ—¶å€™éƒ½æ—¶å½±å“ç³»ç»Ÿæ€§èƒ½ã€å¹¶å‘èƒ½åŠ›çš„ä¸»è¦å› ç´ ä¹‹ä¸€ï¼Œè™šæ‹Ÿæœºä¹‹æ‰€ä»¥æä¾›å¤šç§ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨åŠå¤§é‡çš„è°ƒèŠ‚å‚æ•°ï¼Œæ˜¯å› ä¸ºåªæœ‰æ ¹æ®å®é™…åº”ç”¨éœ€è¦ã€å®ç°æ–¹å¼é€‰æ‹©æœ€ä¼˜çš„æ”¶é›†æ–¹å¼æ‰èƒ½è·å–æœ€å¥½çš„æ€§èƒ½ã€‚</p><p><strong>æ²¡æœ‰å›ºå®šæ”¶é›†å™¨ã€å‚æ•°ç»„åˆï¼Œä¹Ÿæ²¡æœ‰æœ€ä¼˜çš„è°ƒä¼˜æ–¹æ³•ï¼Œè™šæ‹Ÿæœºä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¿…ç„¶çš„å†…å­˜å›æ”¶è¡Œä¸ºã€‚</strong></p><p>å› æ­¤å­¦ä¹ è™šæ‹Ÿæœºå†…å­˜åªæ˜¯ï¼Œå¦‚æœè¦åˆ°å®è·µè°ƒä¼˜é˜¶æ®µï¼Œå¿…é¡»äº†è§£æ¯ä¸ªå…·ä½“æ”¶é›†å™¨çš„è¡Œä¸ºï¼Œä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€è°ƒèŠ‚å‚æ•°ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å›¾ç‰‡æ¥æºï¼Œ<a href="https://my.oschina.net/winHerson/blog/114391">jvmåƒåœ¾æ”¶é›†ï¼ˆæ ‡è®°-æ¸…é™¤,å¤åˆ¶ï¼Œæ ‡è®°-æ•´ç†ï¼Œåˆ†ä»£ï¼‰ç®—æ³•</a></li><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ </li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå†…å­˜åŒºåŸŸå†…å­˜æº¢å‡ºå¼‚å¸¸</title>
      <link href="/blog/2018/09/08/bc3decee.html"/>
      <url>/blog/2018/09/08/bc3decee.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå».</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>å¯¹äºä»äº‹<code>C</code>å’Œ<code>C++</code>ç¨‹åºå¼€å‘çš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œåœ¨å†…å­˜ç®¡ç†é¢†åŸŸï¼Œä»–ä»¬æ—¢æ˜¯æ‹¥æœ‰æœ€é«˜æƒåŠ›çš„çš‡å¸ï¼Œåˆæ˜¯ä»äº‹æœ€åŸºç¡€å·¥ä½œçš„åŠ³åŠ¨äººæ°‘â€”â€”æ—¢æ‹¥æœ‰æ¯ä¸€ä¸ªå¯¹è±¡çš„â€œæ‰€æœ‰æƒâ€ï¼Œåˆæ‹…è´Ÿç€æ¯ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å¼€å§‹åˆ°ä¸­ç§¯æè€Œçš„ç»´æŠ¤è´£ä»»ã€‚</p><p>ä½†å¯¹äºJavaç¨‹åºå‘˜æ¥è¯´ï¼Œåœ¨è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶çš„å¸®åŠ©ä¸‹ï¼Œä¸å†éœ€è¦ä¸ºæ¯ä¸€ä¸ª<code>new</code>æ“ä½œå»å†™é…å¯¹çš„delete/freeä»£ç ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºå’Œå†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œçœ‹èµ·æ¥ç”±è™šæ‹Ÿæœºç®¡ç†å†…å­˜ä¸€åˆ‡éƒ½å¾ˆç¾å¥½ã€‚</p><p>ä¸è¿‡ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºJavaç¨‹åºå‘˜æŠŠå†…å­˜æ§åˆ¶çš„æƒåŠ›äº¤ç»™äº†Javaè™šæ‹Ÿæœºï¼Œä¸€æ—¦å‡ºç°å†…å­˜æ³„æ¼å’Œæº¢å‡ºæ–¹é¢çš„é—®é¢˜ï¼Œå¦‚æœä¸äº†è§£è™šæ‹Ÿæœºæ˜¯æ€ä¹ˆæ ·ä½¿ç”¨å†…å­˜çš„ï¼Œé‚£æ’æŸ¥é”™è¯¯å°†ä¼šæˆä¸ºä¸€é¡¹å¼‚å¸¸è‰°éš¾çš„å·¥ä½œã€‚</p><h2 id="è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"><a href="#è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ" class="headerlink" title="è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"></a>è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ</h2><blockquote><p>Javaè™šæ‹Ÿæœºåœ¨<strong>æ‰§è¡ŒJavaç¨‹åºçš„è¿‡ç¨‹ä¸­</strong>ä¼šæŠŠ<strong>å®ƒæ‰€ç®¡ç†çš„å†…å­˜</strong>åˆ’åˆ†ä¸ºè‹¥å¹²ä¸åŒçš„æ•°æ®åŒºåŸŸã€‚è¿™äº›åŒºåŸŸéƒ½æœ‰å„è‡ªçš„ç”¨é€”ï¼Œä»¥åŠåˆ›å»ºå’Œé”€æ¯çš„æ—¶é—´ï¼Œæœ‰çš„åŒºåŸŸéšç€è™šæ‹Ÿæœºè¿›ç¨‹çš„å¯åŠ¨è€Œå­˜åœ¨ï¼Œæœ‰äº›åŒºåŸŸåˆ™ä¾èµ–ç”¨æˆ·çº¿ç¨‹çš„å¯åŠ¨å’Œç»“æŸè€Œå»ºç«‹å’Œé”€æ¯ã€‚</p></blockquote><p><img src="https://gitee.com/cayzlh/img-repo/raw/master/uPic/1.png" alt="1"></p><h3 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h3><p>ç¨‹åºè®¡æ•°å™¨ï¼ˆ<code>Program Counter Register</code>ï¼‰æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒçš„ä½œç”¨å¯ä»¥çœ‹æˆæ˜¯<strong>å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚</strong>åœ¨è™šæ‹Ÿæœºçš„<em>æ¦‚å¿µæ¨¡å‹</em>é‡Œï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–å“ä¸€è·³éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œ<code>åˆ†æ”¯</code>ã€<code>å¾ªç¯</code>ã€<code>è·³è½¬</code>ã€<code>å¼‚å¸¸å¤„ç†</code>ã€<code>çº¿ç¨‹æ¢å¤</code>ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</p><p>ç”±äºJavaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡<strong>çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´</strong>çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä¸ºäº†<strong>çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®</strong>ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ã€‚</p><p>å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œ è¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯<strong>Natvie</strong>æ–¹æ³•ï¼Œ è¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™ä¸ºç©ºï¼ˆ<code>Undefined</code>ï¼‰ã€‚æ­¤å†…å­˜åŒºåŸŸæ˜¯<strong>å”¯ä¸€</strong>ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•<strong>OOM</strong>æƒ…å†µçš„åŒºåŸŸã€‚</p><h3 id="Javaè™šæ‹Ÿæœºæ ˆ"><a href="#Javaè™šæ‹Ÿæœºæ ˆ" class="headerlink" title="Javaè™šæ‹Ÿæœºæ ˆ"></a>Javaè™šæ‹Ÿæœºæ ˆ</h3><p><strong>Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚</strong></p><p>è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„<strong>å†…å­˜æ¨¡å‹</strong>ï¼šæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåŒäº‹åˆ›å»ºä¸€ä¸ª<code>æ ˆå¸§ï¼ˆStack Frameï¼‰</code><strong>ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚</strong></p><blockquote><p>æ¯ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­ä»å…¥æ ˆé“å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p></blockquote><p><strong>ç»å¸¸æ‰€è¯´çš„å †å†…å­˜ï¼ˆHeapï¼‰å’Œæ ˆå†…å­˜ï¼ˆStackï¼‰æ˜¯ç§æ¯”è¾ƒç²—ç³™çš„åˆ†å‘ï¼ŒJavaå†…å­˜åŒºåŸŸçš„åˆ’åˆ†å®é™…ä¸Šä¼šå¤æ‚å¾ˆå¤šã€‚</strong>è¿™é‡Œæ‰€æŒ‡çš„â€œ<code>æ ˆ</code>â€å°±æ˜¯è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´è™šæ‹Ÿæœºæ ˆä¸­çš„<code>å±€éƒ¨å˜é‡è¡¨</code>éƒ¨åˆ†ã€‚</p><p><strong>å±€éƒ¨å˜é‡è¡¨</strong>å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œæ ¹æ®ä¸åŒçš„è™šæ‹Ÿæœºå®ç°ï¼Œå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªå¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’Œ<code>returnAddress</code>ç±»å‹ï¼ˆæŒ‡å‘ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</p><blockquote><p>64ä½é•¿åº¦çš„longå’Œdoubleç±»å‹çš„æ•°æ®ä¼šå ç”¨2ä¸ªå±€éƒ¨å˜é‡ç©ºé—´ï¼ˆSlotï¼‰ï¼Œå…¶ä½™çš„æ•°æ®åªå ç”¨ä¸€ä¸ªã€‚</p><p><strong>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€è¦çš„å†…å­˜ç©ºé—´åœ¨<code>ç¼–è¯‘æœŸé—´</code>å®Œæˆåˆ†é…</strong>ã€‚å½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨å¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚</p></blockquote><h4 id="è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š"><a href="#è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š" class="headerlink" title="è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š"></a>è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š</h4><ul><li>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„<strong>æ ˆæ·±åº¦</strong>å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡º<code>StackOverflowError</code>å¼‚å¸¸ï¼›</li><li>å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå½“æ‰©å±•åˆ°æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜æ—¶ä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ï¼›</li></ul><p><em>å½“å‰å¤§éƒ¨åˆ†çš„Javaè™šæ‹Ÿæœºéƒ½å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œåªä¸è¿‡Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿå…è®¸å›ºå®šé•¿åº¦çš„è™šæ‹Ÿæœºæ ˆã€‚</em></p><h3 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h3><p><strong>æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stacksï¼‰</strong>ä¸è™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨æ—¶éå¸¸ç›¸ä¼¼çš„ã€‚</p><h4 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h4><ul><li>è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆåˆ™æ˜¯ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„NativeæœåŠ¡ã€‚</li></ul><p>è™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„æ–¹æ³•ä½¿ç”¨çš„è¯­è¨€ã€ä½¿ç”¨æ–¹å¼ä¸æ•°æ®ç»“æ„å¹¶æ²¡æœ‰å¼ºåˆ¶è§„å®šï¼Œå› æ­¤å…·ä½“çš„è™šæ‹Ÿæœºå¯ä»¥è‡ªç”±å®ç°å®ƒã€‚<em>æœ‰äº›è™šæ‹Ÿæœºï¼ˆSun Hotspotï¼‰</em>ç›´æ¥æŠŠæœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</p><p>ä¸è™šæ‹Ÿæœºæ ˆä¸€æ ·ï¼Œæœ¬åœ°æ–¹æ³•æ ˆåŒºåŸŸä¹Ÿä¼šæŠ›å‡º<code>StackOverflowError</code>å’Œ<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</p><h3 id="Javaå †"><a href="#Javaå †" class="headerlink" title="Javaå †"></a>Javaå †</h3><blockquote><p>å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´ï¼ŒJavaå †ï¼ˆJava Heapï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚</p><p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°ï¼šæ‰€æœ‰å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…ã€‚</p></blockquote><ol><li>Javaå †äº‹è¢«<strong>æ‰€æœ‰çº¿ç¨‹</strong>å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨<strong>è™šæ‹Ÿæœºå¯åŠ¨æ—¶</strong>åˆ›å»ºã€‚</li><li>æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯<strong>å­˜æ”¾å¯¹è±¡å®ä¾‹</strong>ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚</li><li>Javaå †äº‹åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™ä¹Ÿç§°ä½œâ€œGCå †â€ï¼ˆGarbage Collected Heapï¼‰ã€‚</li><li>Javaå †å¯ä»¥å¤„äº<strong>ç‰©ç†ä¸Šä¸è¿ç»­</strong>çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯ï¼Œå°±åƒæˆ‘ä»¬çš„ç£ç›˜ç©ºé—´ä¸€æ ·ã€‚</li></ol><p>ä»å†…å­˜å›æ”¶è§’åº¦çœ‹ï¼Œç”±äºç°åœ¨æ”¶é›†é½åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£æ‰‹æœºç®—æ³•ï¼Œæ‰€ä»¥Javaå †ä¸­è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼›å†ç»†åˆ†æœ‰Edenç©ºé—´ã€From Survivorç©ºé—´ã€To Survivorç©ºé—´ç­‰ã€‚</p><p>ä»å†…å­˜åˆ†é…çš„è§’åº¦çœ‹ï¼Œçº¿ç¨‹å…±äº«çš„Javaå †ä¸­å¯èƒ½åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºã€‚</p><p><strong>æ— è®ºå¦‚ä½•åˆ’åˆ†ï¼Œéƒ½ä¸å­˜æ”¾å†…å®¹æ— å…³ï¼Œæ— è®ºå“ªä¸ªåŒºåŸŸï¼Œå­˜å‚¨çš„éƒ½ä»ç„¶æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿›ä¸€æ­¥åˆ’åˆ†æ˜¯ä¸ºäº†æ›´å¥½çš„å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«çš„åˆ†é…å†…å­˜ã€‚</strong>ä¸»æµçš„è™šæ‹Ÿæœºéƒ½æ˜¯æŒ‰ç…§å¯æ‰©å±•æ¥å®ç°çš„ï¼ˆé€šè¿‡<code>-Xmx</code>å’Œ<code>-Xms</code>æ§åˆ¶ï¼‰ã€‚å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œå°†ä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</p><h3 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h3><p>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰å’ŒJavaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ª<strong>çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸ</strong>ï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹Ÿæœºå®¶åœ¨çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚</p><blockquote><p>è™½ç„¶Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªåˆ«åå«NonHeapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸Javaå †åŒºåˆ†å¼€æ¥ã€‚</p><p>Javaè™šæ‹Ÿæœºè§„èŒƒå †è¿™ä¸ªåŒºåŸŸçš„é™åˆ¶éå¸¸å®½æ¾ï¼Œé™¤äº†å’ŒJavaå †ä¸€æ ·ä¸éœ€è¦è¿ç»­çš„å†…å­˜å’Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©ä¸å®ç°åƒåœ¾æ”¶é›†ã€‚</p><p><em>ç›¸å¯¹è€Œè¨€ï¼Œåƒåœ¾æ”¶é›†è¡Œä¸ºåœ¨è¿™ä¸ªåŒºåŸŸæ˜¯æ¯”è¾ƒå°‘å‡ºç°çš„ï¼Œä½†å¹¶éæ•°æ®è¿›å…¥äº†æ–¹æ³•åŒºå°±å¦‚æ°¸ä¹…ä»£çš„åå­—ä¸€æ ·â€œæ°¸ä¹…â€å­˜åœ¨äº†ã€‚</em></p></blockquote><p>è¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶ç›®æ ‡ä¸»è¦æ˜¯é’ˆå¯¹<strong>å¸¸é‡æ± çš„å›æ”¶</strong>å’Œå¯¹<strong>ç±»å‹çš„å¸è½½</strong>ï¼Œè¿™ä¸ªåŒºåŸŸçš„å›æ”¶â€œæˆç»©â€æ¯”è¾ƒéš¾ä»¥ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶çš„ç¡®æ˜¯æœ‰å¿…è¦çš„ã€‚</p><p><strong>æ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒçš„è§„å®šï¼Œå½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</strong></p><h3 id="è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± "></a>è¿è¡Œæ—¶å¸¸é‡æ± </h3><p><strong>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</strong>Classæ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ—¶å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œ<strong>ç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢äº®å’Œç¬¦å·é¥®ç”¨</strong>ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºè¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</p><p>Javaè™šæ‹Ÿæœºå¯¹Classçš„æ¯ä¸€éƒ¨åˆ†çš„æ ¼å¼éƒ½æœ‰ä¸¥æ ¼çš„è§„å®šï¼Œæ¯ä¸€ä¸ªå­—èŠ‚ç”¨äºå­˜å‚¨å“ªç§æ•°æ®éƒ½å¿…é¡»ç¬¦åˆè§„èŒƒä¸Šçš„è¦æ±‚ï¼Œè¿™æ ·æ‰ä¼šè¢«è™šæ‹Ÿæœºè®¤å¯ã€è£…è½½å’Œæ‰§è¡Œã€‚ä½†æ˜¯å¯¹äºå¸¸é‡æ± ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒæ²¡æœ‰åšä»»ä½•ç»†èŠ‚çš„è¦æ±‚ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé™¤äº†ä¿å­˜Classæ–‡ä»¶ä¸­æè¿°çš„<strong>ç¬¦å·å¼•ç”¨</strong>å¤–ï¼Œè¿˜ä¼šæŠŠç¿»è¯‘å‡ºæ¥çš„ç›´æ¥é¥®ç”¨ä¹Ÿå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·æœ‰åŠ¨æ€æ€§ï¼ŒJavaè¯­è¨€å¹¶ä¸è¦æ±‚å¸¸é‡ä¸€å®šåªèƒ½åœ¨ç¼–è¯‘æœŸäº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯å¹¶éé¢„ç½®å…¥Classæ–‡ä»¶ä¸­å¸¸é‡æ± çš„å†…å®¹æ‰èƒ½è¿›å…¥æ–¹æ³•åŒºè¿è¡Œæ—¶çš„å¸¸é‡æ± ï¼Œ<strong>è¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­ï¼Œ</strong>è¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨çš„æ¯”è¾ƒå¤šçš„ä¾¿æ˜¯**Stringç±»çš„intern()**æ–¹æ³•ã€‚</p><blockquote><p>public String <strong>intern</strong>();</p><p>è¿”å›å­—ç¬¦ä¸²å¯¹è±¡çš„è§„èŒƒåŒ–è¡¨ç¤ºå½¢å¼ã€‚</p><p>ä¸€ä¸ªåˆå§‹æ—¶ä¸ºç©ºçš„å­—ç¬¦ä¸²æ± ï¼Œå®ƒç”±ç±» String ç§æœ‰åœ°ç»´æŠ¤ã€‚</p><p>å½“è°ƒç”¨ intern æ–¹æ³•æ—¶ï¼Œå¦‚æœæ± å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼ˆè¯¥å¯¹è±¡ç”± equals(Object) æ–¹æ³•ç¡®å®šï¼‰ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œå°†æ­¤ String å¯¹è±¡æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶ä¸”è¿”å›æ­¤ String å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>å®ƒéµå¾ªå¯¹äºä»»ä½•ä¸¤ä¸ªå­—ç¬¦ä¸² s å’Œ tï¼Œå½“ä¸”ä»…å½“ s.equals(t) ä¸º true æ—¶ï¼Œs.intern() == t.intern() æ‰ä¸º trueã€‚</p><p>æ‰€æœ‰å­—é¢å€¼å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²èµ‹å€¼å¸¸é‡è¡¨è¾¾å¼éƒ½æ˜¯å†…éƒ¨çš„ã€‚</p><p><strong>è¿”å›ï¼š</strong></p><p>ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†…å®¹ä¸æ­¤å­—ç¬¦ä¸²ç›¸åŒï¼Œä½†å®ƒä¿è¯æ¥è‡ªå­—ç¬¦ä¸²æ± ä¸­ã€‚</p></blockquote><p>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œè‡ªç„¶ä¼šæ”¶åˆ°æ–¹æ³•åŒºå†…çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h3 id="ç›´æ¥å†…å­˜"><a href="#ç›´æ¥å†…å­˜" class="headerlink" title="ç›´æ¥å†…å­˜"></a>ç›´æ¥å†…å­˜</h3><p>ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰<strong>å¹¶ä¸æ˜¯</strong>è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´<code>OutOfMemoryError</code>å¼‚å¸¸å‡ºç°ã€‚</p><p>æœ¬æœºå†…å­˜çš„åˆ†é…ä¸ä¼šæ”¶åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜ï¼Œåˆ™è‚¯å®šè¿˜æ˜¯ä¼šæ”¶åˆ°æœ¬æœºæ€»å†…å­˜ï¼ˆRAMåŠSWAPåŒºæˆ–è€…åˆ†é¡µæ–‡ä»¶ï¼‰çš„å¤§å°åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚åˆ†é…è™šæ‹Ÿæœºå‚æ•°æ—¶ï¼Œå®¹æ˜“å¿½ç•¥æ‰ç›´æ¥å†…å­˜ï¼Œä½¿å¾—å„ä¸ªå†…å­˜åŒºåŸŸçš„æ€»å’Œå¤§äºç‰©ç†å†…å­˜é™åˆ¶ï¼Œä»è€Œå¯¼è‡´åŠ¨æ€æ‰©å±•æ—¶å‡ºç°OutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="å¯¹è±¡è®¿é—®"><a href="#å¯¹è±¡è®¿é—®" class="headerlink" title="å¯¹è±¡è®¿é—®"></a>å¯¹è±¡è®¿é—®</h2><p>å¯¹è±¡çš„è®¿é—®åœ¨<code>Java</code>è¯­è¨€ä¸­æ— å¤„ä¸åœ¨ï¼Œæ—¶æœ€æ™®é€šçš„ç¨‹åºè¡Œä¸ºï¼Œä½†å³ä½¿æ—¶æœ€ç®€å•çš„è®¿é—®ï¼Œä¹Ÿä¼šå»æ¶‰åŠJavaæ ˆã€Javaå †ã€æ–¹æ³•åŒºè¿™ä¸‰ä¸ªæœ€é‡è¦çš„å†…å­˜åŒºåŸŸä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure><p>å‡è®¾è¿™å¥ä»£ç å‡ºç°åœ¨æ–¹æ³•ä½“ä¸­ï¼š</p><ul><li><strong>â€œObject objâ€</strong>è¿™éƒ¨åˆ†çš„è¯­ä¹‰å°†ä¼šåæ˜ åˆ°<strong>Javaæ ˆçš„æœ¬åœ°å˜é‡è¡¨</strong>ä¸­ï¼Œä½œä¸ºä¸€ä¸ª<code>reference</code>ç±»å‹æ•°æ®å‡ºç°ã€‚</li><li><strong>â€œnew Object( )â€</strong>è¿™éƒ¨åˆ†è¯­ä¹‰å°†ä¼šåæ˜ åˆ°<strong>Javaå †</strong>ä¸­</li></ul><p>å½¢æˆä¸€å—å­˜å‚¨äº†Objectç±»å‹æ‰€æœ‰å®ä¾‹æ•°æ®å€¼ï¼ˆ<em>Instance Dataï¼Œå¯¹è±¡ä¸­å„ä¸ªå®ä¾‹å­—æ®µçš„æ•°æ®</em>ï¼‰çš„ç»“æ„åŒ–å†…å­˜ï¼Œæ ¹æ®å…·ä½“ç±»å‹ä»¥åŠè™šæ‹Ÿæœºå®ç°çš„å¯¹è±¡å†…å­˜å¸ƒå±€çš„ä¸åŒï¼Œè¿™å—å†…å­˜çš„é•¿åº¦æ—¶ä¸å›ºå®šçš„ã€‚Javaå †ä¸­è¿˜å¿…é¡»åŒ…å«èƒ½æŸ¥æ‰¾åˆ°æ­¤å¯¹è±¡ç±»å‹æ•°æ®ï¼ˆ<em>å¦‚å¯¹è±¡ç±»å‹ã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ã€æ–¹æ³•ç­‰</em>ï¼‰çš„åœ°å€ä¿¡æ¯ï¼Œè¿™äº›ç±»å‹æ•°æ®åˆ™å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚</p><p>ä¸åŒè™šæ‹Ÿæœºå®ç°çš„å¯¹è±¡è®¿é—®æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒã€‚ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li><p>ä½¿ç”¨å¥æŸ„</p><p>Javaå †ä¸­ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜ä½œä¸ºå¥æŸ„æ± ï¼Œreferenceä¸­å­˜å‚¨çš„å°±æ˜¯<strong>å¯¹è±¡çš„å¥æŸ„åœ°å€</strong>ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®å’Œç±»å‹æ•°æ®å„è‡ªçš„<strong>å…·ä½“åœ°å€ä¿¡æ¯</strong>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/2.png" alt="2">/2.png)</p><blockquote><p>å¥æŸ„è®¿é—®æ–¹å¼æœ€å¤§çš„å¥½å¤„å°±æ˜¯**<code>reference</code>ä¸­å­˜å‚¨çš„äº‹ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨<strong>ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡æ—¶éå¸¸æ™®éçš„è¡Œä¸ºï¼‰</strong>åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œ<code>reference</code>æœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚**</p></blockquote></li><li><p>ç›´æ¥æŒ‡é’ˆ</p><p>Javaå †å¯¹è±¡çš„å¸ƒå±€ä¸­å¿…é¡»è€ƒè™‘<strong>å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œreferenceä¸­ç›´æ¥å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡åœ°å€</strong>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/3.png" alt="3"></p><blockquote><p>æŒ‡é’ˆè®¿é—®æ–¹å¼åœ¨æœ€å¤§å¥½å¤„å°±æ˜¯é€Ÿåº¦æ›´å¿«ï¼Œå®ƒèŠ‚çœäº†ä¸€æ¬¡<strong>æŒ‡é’ˆå®šä½</strong>çš„æ—¶é—´å¼€é”€ï¼Œç”±äºå¯¹è±¡çš„è®¿é—®åœ¨Javaä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤è¿™ç±»å¼€é”€ç§¯å°‘æˆå¤šåä¹Ÿæ˜¯ä¸€é¡¹éå¸¸å¯è§‚çš„æ‰§è¡Œæˆæœ¬ã€‚</p></blockquote></li></ul><h2 id="é‡ç°OOMå¼‚å¸¸"><a href="#é‡ç°OOMå¼‚å¸¸" class="headerlink" title="é‡ç°OOMå¼‚å¸¸"></a>é‡ç°OOMå¼‚å¸¸</h2><p>åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒçš„æè¿°ä¸­ï¼Œ<strong>é™¤äº†ç¨‹åºè®¡æ•°å™¨å¤–ï¼Œè™šæ‹Ÿæœºå†…å­˜çš„å…¶ä»–å‡ ä¸ªè¿è¡Œæ—¶åŒºåŸŸéƒ½æœ‰å‘ç”ŸOOMå¼‚å¸¸çš„å¯èƒ½ã€‚</strong></p><h3 id="Javaå †æº¢å‡º"><a href="#Javaå †æº¢å‡º" class="headerlink" title="Javaå †æº¢å‡º"></a>Javaå †æº¢å‡º</h3><p>Javaå †ç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹ï¼Œæˆ‘ä»¬åªè¦ä¸æ–­çš„åˆ›å»ºå¯¹è±¡ï¼Œå¹¶<strong>ä¿è¯GC Rootsåˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥é¿å…åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤è¿™äº›å¯¹è±¡</strong>ï¼Œå°±ä¼šåœ¨å¯¹è±¡æ•°é‡è¾¾åˆ°æœ€å¤§å †å®¹é‡é™åˆ¶åäº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</p><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMObject</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(Stringp[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;OOMObject&gt; list = <span class="keyword">new</span> ArrayList&lt;OOMObject&gt;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> OOMObject());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä»£ç å°†ä¼šæŠ›å‡ºï¼š<strong>java.lang.OutOfMemoryError: Java heap space</strong>.</p><p>è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ—¶å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆåˆ†æ¸…æ¥šåˆ°åº•æ—¶å‡ºç°äº†å†…å­˜æ³„æ¼è¿˜æ˜¯å†…å­˜æº¢å‡ºã€‚</p><p>å¦‚æœæ—¶å†…å­˜æ³„æ¼ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GC Rootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚</p><p>å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé‚£å°±åº”è¯¥æ£€æŸ¥<strong>è™šæ‹Ÿæœºå †å‚æ•°ï¼ˆ-Xmx å’Œ -Xmsï¼‰</strong>ä¸æœºå™¨æ— åŠ›å†…å­˜å¯¹æ¯”æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨<strong>æŸäº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µã€‚</strong>å°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚</p><h3 id="è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"><a href="#è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º" class="headerlink" title="è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"></a>è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º</h3><blockquote><p>å¯¹äºHotSpotæ¥è¯´ï¼Œ**-Xosså‚æ•°ï¼ˆè®¾ç½®æœ¬åœ°æ–¹æ³•æ ˆå¤§å°ï¼‰è™½ç„¶å­˜åœ¨ï¼Œä½†å®é™…ä¸Šæ˜¯æ— æ•ˆçš„**ï¼Œæ ˆå®¹é‡åªç”±-Xsså‚æ•°è®¾å®šã€‚</p></blockquote><ul><li>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ã€‚</li><li>å¦‚æœè™šæ‹Ÿæœºåœ¨æ‹“å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</li></ul><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-Xss128k</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaVMStackSOF</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> stackLength = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stackLeak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stackLength++;</span><br><span class="line">        stackLeak();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        JavaVMStackSOF oom = <span class="keyword">new</span> JavaVMStackSOF();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oom.stackLeak();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;stack length:&quot;</span> + ooo.stackLength);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p>Stack length:2402</p><p>Exception in thread â€œmainâ€ java.lang.StackOverflowError</p><p>Â Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·åç»­å¼‚å¸¸æ ˆä¿¡æ¯çœç•¥ã€‚</p><p><strong>ç»“æœè¯æ˜ï¼š</strong>åœ¨å•ä¸ªçº¿ç¨‹ä¸‹ï¼Œæ— è®ºæ˜¯ç”±äºæ ˆå¸§å¤ªå¤§ï¼Œè¿˜æ˜¯è™šæ‹Ÿæœºæ ˆå®¹é‡å¤ªå°ï¼Œå½“å†…å­˜æ— æ³•åˆ†é…çš„æ—¶å€™ï¼Œ è™šæ‹ŸæœºæŠ›å‡ºçš„éƒ½æ˜¯StackOverflowErrorå¼‚å¸¸ã€‚</p><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-Xss2M</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaVMStackOOM</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dontStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stackLeakThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                    dontStop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        JavaVMStackOOM oom = <span class="keyword">new</span> JavaVMStackOOM();</span><br><span class="line">        oom.stackLeakThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨ï¼šå¦‚æœè¦è¿è¡Œè¿™é¡¿å•Šä»£ç ï¼Œè®°å¾—è¦å…ˆä¿å­˜å½“å‰çš„å·¥ä½œï¼Œç”±äºåœ¨Windowså¹³å°çš„è™šæ‹Ÿæœºä¸­ï¼ŒJavaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹ä¸Šçš„ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç æ‰§è¡Œæ—¶æœ‰è¾ƒå¤§çš„é£é™©ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå‡æ­»ã€‚</strong></p><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p>Exception in thread â€œmainâ€ java.lang.OutOfMemoryError: unable to create new native thread</p><p><strong>å®éªŒè¯æ˜ï¼š</strong></p><p>é€šè¿‡ä¸æ–­çš„å»ºç«‹çº¿ç¨‹çš„æ–¹å¼å¯ä»¥äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯ï¼Œè¿™æ ·äº§ç”Ÿçš„å†…å­˜æº¢å‡ºå¼‚å¸¸ä¸æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿå¤§å¹¶ä¸å­˜åœ¨ä»»ä½•è”ç³»ï¼Œæˆ–è€…å‡†ç¡®çš„è¯´ï¼Œ<strong>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç»™æ¯ä¸ªçº¿ç¨‹çš„æ ˆåˆ†é…çš„å†…å­˜è¶Šå¤§ï¼Œåè€Œè¶Šå®¹æ˜“äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</strong></p><blockquote><p>å¦‚æœæ˜¯å»ºç«‹è¿‡å¤šçº¿ç¨‹å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼Œåœ¨ä¸èƒ½å‡å°‘çº¿ç¨‹æ•°æˆ–è€…æ›´æ¢64ä½è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼Œå°±åªèƒ½é€šè¿‡å‡å°‘æœ€å¤§å †å’Œå‡å°‘æ ˆå®¹é‡æ¥æ¢å–æ›´å¤šçš„çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰è¿™æ–¹é¢çš„ç»éªŒï¼Œè¿™ç§é€šè¿‡â€œå‡å°‘å†…å­˜â€çš„æ‰‹æ®µæ¥è§£å†³å†…å­˜æº¢å‡ºçš„æ–¹å¼ä¼šæ¯”è¾ƒéš¾ä»¥æƒ³åˆ°ã€‚</p></blockquote><h3 id="è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"><a href="#è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º" class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"></a>è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</h3><p>å¦‚æœè¦å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­æ·»åŠ å†…å®¹ï¼Œ å˜´è´±çš„åšæ³•å°±æ˜¯ä½¿ç”¨String.intern()è¿™ä¸ªNativeæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå¦‚æœæ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤Stringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”ä»£è¡¨æ± ä¸­è¿™ä¸ªå­—ç¬¦ä¸²çš„Stringå¯¹è±¡ï¼›å¦åˆ™ï¼Œå°†æ­¤Stringå¯¹è±¡åŒ…å«çš„å­—ç¬¦ä¸²çš„æ·»åŠ åˆ°å¸¸é‡æ± ä¸­ï¼Œå¹¶ä¸”è¿”å›æ­¤Stringå¯¹è±¡çš„å¼•ç”¨ã€‚</strong></p><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-XXPermSize=10M -XX:MaxPermSize=10M</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeConstantPoolOOM</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨Listä¿å­˜ç€å¸¸é‡æ± å¼•ç”¨ï¼Œé¿å…Full GCå›æ”¶å¸¸é‡æ± è¡Œä¸º</span></span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            list.add(String.valueOf(i++).intern());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p>Exception in thread â€œmainâ€ java.lang.OutOfMemoryError: <strong>PermGen space</strong></p><p><strong>å®éªŒç»“æœï¼š</strong></p><p>è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡ºï¼Œåœ¨OOMåé¢è·Ÿéšç€çš„æç¤ºä¿¡æ¯æ˜¯<strong>PermGen space</strong>ï¼Œè¯´æ˜<strong>è¿è¡Œæ—¶å¸¸é‡æ± å±äºæ–¹æ³•åŒº</strong>ï¼ˆHotSpotè™šæ‹Ÿæœºä¸­çš„æ°¸ä¹…ä»£ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="æ–¹æ³•åŒºæº¢å‡º"><a href="#æ–¹æ³•åŒºæº¢å‡º" class="headerlink" title="æ–¹æ³•åŒºæº¢å‡º"></a>æ–¹æ³•åŒºæº¢å‡º</h3><p><strong>æ–¹æ³•åŒºç”¨äºå­˜æ”¾Classçš„ç›¸å…³ä¿¡æ¯ï¼Œ</strong>å¦‚ç±»åã€è®¿é—®ä¿®é¥°ç¬¦ã€å¸¸é‡æ± ã€å­—æ®µæè¿°ã€æ–¹æ³•æè¿°ç­‰ã€‚è¿™ä¸ªå®éªŒéœ€è¦é€šè¿‡ç”Ÿæˆå¤§é‡çš„åŠ¨æ€ç±»æ¥å®ç°ï¼Œä½¿ç”¨CGLibè¿™ç±»å­—èŠ‚ç æŠ€æœ¯ï¼Œå¢å¼ºçš„ç±»è¶Šå¤šï¼Œå°±éœ€è¦è¶Šå¤§çš„æ–¹æ³•åŒºæ¥ä¿è¯åŠ¨æ€ç”Ÿæˆçš„Classå¯ä»¥åŠ è½½å¦‚å†…å­˜ã€‚</p><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-XX:PermSize=10M -XX:MaxPermSize=10M</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaMethodAreaOOM</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">            enhancer.setSuperclass(OOMObject.class);</span><br><span class="line">            enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">            enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, </span></span></span><br><span class="line"><span class="function"><span class="params">                                        Object[] args, MethodProxy mhodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> proxy.invokeSuper(obj, args);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            enhancer.create();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> class <span class="title">OOMObject</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p>Caused by:  java.lang.OutOfMemoryError: <strong>PermGen space</strong></p><p><strong>å®éªŒç»“æœï¼š</strong></p><p>æ–¹æ³•åŒºæº¢å‡ºä¹Ÿæ˜¯ä¸€ç§å¸¸è§çš„å†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä¸€ä¸ªç±»å¦‚æœè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ‰ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯éå¸¸è‹›åˆ»çš„ã€‚<strong>åœ¨ç»å¸¸åŠ¨æ€ç”Ÿæˆå¤§é‡Classçš„åº”ç”¨ä¸­ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç±»çš„å›æ”¶çŠ¶æ€ã€‚</strong></p><h3 id="æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º"><a href="#æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º" class="headerlink" title="æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º"></a>æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º</h3><p>é€šè¿‡åå°„è·å–Unsafeå®ä¾‹è¿›è¡Œå†…å­˜åˆ†é…ï¼ˆUnsafeç±»çš„getUnSafe()æ–¹æ³•é™åˆ¶äº†åªæœ‰å¼•å¯¼ç±»åŠ è½½å™¨æ‰ä¼šè¿”å›å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è®¾è®¡è€…å¸Œæœ›åªæœ‰rt.jarä¸­çš„ç±»å¯ä»¥ä½¿ç”¨Unsafeçš„åŠŸèƒ½ï¼‰ã€‚å› ä¸ºï¼Œè™½ç„¶ä½¿ç”¨DirectByteBufferåˆ†é…å†…å­˜ä¹Ÿä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä½†å®ƒæŠ›å‡ºå¼‚å¸¸æ—¶å¹¶æ²¡æœ‰çœŸæ­£å‘æ“ä½œç³»ç»Ÿç”³è¯·åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯<strong>é€šè¿‡è®¡ç®—å¾—çŸ¥å†…å­˜æ— æ³•åˆ†é…</strong>ï¼Œäºæ˜¯æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼ŒçœŸæ­£ç”³è¯·åˆ†é…å†…å­˜çš„æ–¹æ³•æ˜¯unsafe.allocateMemory()ã€‚</p><blockquote><p>åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š</p><p>-Xmx20M -XX:MaxDirectMemorySize=10M</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectMemoryOOM</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field unsafeField = Unsafe.class.getDeclaredFields()[<span class="number">0</span>];</span><br><span class="line">        unsafeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Unsafe unsafe = (Unsafe) unsafeField.get(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            unsafe.allocateMemory(_1MB);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p>Exception in thread â€œmainâ€ java.lang.OutOfMemoryError</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><ul><li>å†…å­˜æ˜¯å¦‚ä½•åˆ’åˆ†çš„</li><li>å“ªéƒ¨åˆ†åŒºåŸŸã€ä»€ä¹ˆæ ·çš„ä»£ç å’Œæ“ä½œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºå¼‚å¸¸</li></ul><p>è™½ç„¶Javaæœ‰åƒåœ¾æ”¶é›†æœºåˆ¶ï¼Œä½†å†…å­˜æº¢å‡ºå¼‚å¸¸ç¦»æˆ‘ä»¬å¹¶ä¸é¥è¿œï¼Œæœ¬ç« è®²è§£äº†è§£äº†å„ä¸ªåŒºåŸŸå‡ºç°å†…å­˜æº¢å‡ºå¼‚å¸¸çš„åŸå› ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ </li></ul>]]></content>
      
      
      <categories>
          
          <category> ä¹¦ç± </category>
          
          <category> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
            <tag> ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springäº‹åŠ¡ç®¡ç†</title>
      <link href="/blog/2018/09/03/762945f0.html"/>
      <url>/blog/2018/09/03/762945f0.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ.</p></blockquote><h3 id="äº‹åŠ¡çš„ç‰¹æ€§-ACID"><a href="#äº‹åŠ¡çš„ç‰¹æ€§-ACID" class="headerlink" title="äº‹åŠ¡çš„ç‰¹æ€§(ACID)"></a>äº‹åŠ¡çš„ç‰¹æ€§(ACID)</h3><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018090301/1.png" alt="ACID"></p><p><strong>åŸå­æ€§ï¼š</strong> äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›</p><p><strong>ä¸€è‡´æ€§ï¼š</strong> æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼›</p><p><strong>éš”ç¦»æ€§ï¼š</strong> å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹ç‰©ä¸è¢«å…¶ä»–äº‹ç‰©æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›</p><p><strong>æŒä¹…æ€§:</strong>  ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚</p><h3 id="Springäº‹åŠ¡ç®¡ç†æ¥å£"><a href="#Springäº‹åŠ¡ç®¡ç†æ¥å£" class="headerlink" title="Springäº‹åŠ¡ç®¡ç†æ¥å£"></a>Springäº‹åŠ¡ç®¡ç†æ¥å£</h3><h4 id="PlatformTransactionManagerï¼š-ï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨"><a href="#PlatformTransactionManagerï¼š-ï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨" class="headerlink" title="PlatformTransactionManagerï¼š ï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨"></a><strong>PlatformTransactionManagerï¼š</strong> ï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨</h4><p><strong>Springå¹¶ä¸ç›´æ¥ç®¡ç†äº‹åŠ¡ï¼Œè€Œæ˜¯æä¾›äº†å¤šç§äº‹åŠ¡ç®¡ç†å™¨</strong> ï¼Œä»–ä»¬å°†äº‹åŠ¡ç®¡ç†çš„èŒè´£å§”æ‰˜ç»™Hibernateæˆ–è€…JTAç­‰æŒä¹…åŒ–æœºåˆ¶æ‰€æä¾›çš„ç›¸å…³å¹³å°æ¡†æ¶çš„äº‹åŠ¡æ¥å®ç°ã€‚ Springäº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£æ˜¯ï¼š <strong>org.springframework.transaction.PlatformTransactionManager</strong> ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼ŒSpringä¸ºå„ä¸ªå¹³å°å¦‚JDBCã€Hibernateç­‰éƒ½æä¾›äº†å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°å°±æ˜¯å„ä¸ªå¹³å°è‡ªå·±çš„äº‹æƒ…äº†ã€‚</p><p>PlatformTransactionManageræ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Public interface <span class="title">PlatformTransactionManager</span><span class="params">()</span>...</span>&#123;  </span><br><span class="line">    <span class="comment">// Return a currently active transaction or create a new one, according to the specified propagation behaviorï¼ˆæ ¹æ®æŒ‡å®šçš„ä¼ æ’­è¡Œä¸ºï¼Œè¿”å›å½“å‰æ´»åŠ¨çš„äº‹åŠ¡æˆ–åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ã€‚ï¼‰</span></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>; </span><br><span class="line">    <span class="comment">// Commit the given transaction, with regard to its statusï¼ˆä½¿ç”¨äº‹åŠ¡ç›®å‰çš„çŠ¶æ€æäº¤äº‹åŠ¡ï¼‰</span></span><br><span class="line">    <span class="function">Void <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;  </span><br><span class="line">    <span class="comment">// Perform a rollback of the given transactionï¼ˆå¯¹æ‰§è¡Œçš„äº‹åŠ¡è¿›è¡Œå›æ»šï¼‰</span></span><br><span class="line">    <span class="function">Void <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;  </span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure><blockquote><p>Springä¸­PlatformTransactionManageræ ¹æ®ä¸åŒæŒä¹…å±‚æ¡†æ¶æ‰€å¯¹åº”çš„æ¥å£å®ç°ç±»</p></blockquote><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018090301/2.png" alt="ACID"></p><h4 id="TransactionDefinitionï¼š-äº‹åŠ¡å®šä¹‰ä¿¡æ¯-äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™"><a href="#TransactionDefinitionï¼š-äº‹åŠ¡å®šä¹‰ä¿¡æ¯-äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™" class="headerlink" title="TransactionDefinitionï¼š äº‹åŠ¡å®šä¹‰ä¿¡æ¯(äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™)"></a><strong>TransactionDefinitionï¼š</strong> äº‹åŠ¡å®šä¹‰ä¿¡æ¯(äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™)</h4><p>äº‹åŠ¡ç®¡ç†å™¨æ¥å£ <strong>PlatformTransactionManager</strong> é€šè¿‡ <strong>getTransaction(TransactionDefinition definition)</strong> æ–¹æ³•æ¥å¾—åˆ°ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å‚æ•°æ˜¯ <strong>TransactionDefinitionç±»</strong> ï¼Œè¿™ä¸ªç±»å°±å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„äº‹åŠ¡å±æ€§ã€‚</p><p><strong>é‚£ä¹ˆä»€ä¹ˆæ˜¯äº‹åŠ¡å±æ€§å‘¢ï¼Ÿ</strong></p><p>äº‹åŠ¡å±æ€§å¯ä»¥ç†è§£æˆäº‹åŠ¡çš„ä¸€äº›åŸºæœ¬é…ç½®ï¼Œæè¿°äº†äº‹åŠ¡ç­–ç•¥å¦‚ä½•åº”ç”¨åˆ°æ–¹æ³•ä¸Šã€‚äº‹åŠ¡å±æ€§åŒ…å«äº†5ä¸ªæ–¹é¢ã€‚</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018090301/3.png" alt="ACID"></p><p>TransactionDefinitionæ¥å£ä¸­çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>TransactionDefinitionæ¥å£ä¸­å®šä¹‰äº†5ä¸ªæ–¹æ³•ä»¥åŠä¸€äº›è¡¨ç¤ºäº‹åŠ¡å±æ€§çš„å¸¸é‡æ¯”å¦‚éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰ç­‰çš„å¸¸é‡ã€‚</p><p>æˆ‘ä¸‹é¢åªæ˜¯åˆ—å‡ºäº†TransactionDefinitionæ¥å£ä¸­çš„æ–¹æ³•è€Œæ²¡æœ‰ç»™å‡ºæ¥å£ä¸­å®šä¹‰çš„å¸¸é‡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿”å›äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPropagationBehavior</span><span class="params">()</span></span>; </span><br><span class="line">    <span class="comment">// è¿”å›äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡ç®¡ç†å™¨æ ¹æ®å®ƒæ¥æ§åˆ¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯ä»¥çœ‹åˆ°æœ¬äº‹åŠ¡å†…çš„å“ªäº›æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIsolationLevel</span><span class="params">()</span></span>; </span><br><span class="line">    <span class="comment">// è¿”å›äº‹åŠ¡å¿…é¡»åœ¨å¤šå°‘ç§’å†…å®Œæˆ</span></span><br><span class="line">    <span class="comment">//è¿”å›äº‹åŠ¡çš„åå­—</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span>ï¼›</span></span><br><span class="line"><span class="function">    <span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span></span>;  </span><br><span class="line">    <span class="comment">// è¿”å›æ˜¯å¦ä¼˜åŒ–ä¸ºåªè¯»äº‹åŠ¡ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h4 id="TransactionStatusï¼š-äº‹åŠ¡è¿è¡ŒçŠ¶æ€"><a href="#TransactionStatusï¼š-äº‹åŠ¡è¿è¡ŒçŠ¶æ€" class="headerlink" title="TransactionStatusï¼š äº‹åŠ¡è¿è¡ŒçŠ¶æ€"></a><strong>TransactionStatusï¼š</strong> äº‹åŠ¡è¿è¡ŒçŠ¶æ€</h4><p>TransactionStatusæ¥å£ç”¨æ¥è®°å½•äº‹åŠ¡çš„çŠ¶æ€ è¯¥æ¥å£å®šä¹‰äº†ä¸€ç»„æ–¹æ³•,ç”¨æ¥è·å–æˆ–åˆ¤æ–­äº‹åŠ¡çš„ç›¸åº”çŠ¶æ€ä¿¡æ¯.</p><p>PlatformTransactionManager.getTransaction(â€¦) æ–¹æ³•è¿”å›ä¸€ä¸ª TransactionStatus å¯¹è±¡ã€‚è¿”å›çš„TransactionStatus å¯¹è±¡å¯èƒ½ä»£è¡¨ä¸€ä¸ªæ–°çš„æˆ–å·²ç»å­˜åœ¨çš„äº‹åŠ¡ï¼ˆå¦‚æœåœ¨å½“å‰è°ƒç”¨å †æ ˆæœ‰ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„äº‹åŠ¡ï¼‰ã€‚</p><p>TransactionStatusæ¥å£æ¥å£å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionStatus</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNewTransaction</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æ˜¯æ–°çš„äº‹ç‰©</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasSavepoint</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æœ‰æ¢å¤ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRollbackOnly</span><span class="params">()</span></span>;  <span class="comment">// è®¾ç½®ä¸ºåªå›æ»š</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRollbackOnly</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦ä¸ºåªå›æ»š</span></span><br><span class="line">    <span class="keyword">boolean</span> isCompleted; <span class="comment">// æ˜¯å¦å·²å®Œæˆ</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><strong>æ‰€è°“äº‹åŠ¡ç®¡ç†ï¼Œå…¶å®å°±æ˜¯â€œæŒ‰ç…§ç»™å®šçš„äº‹åŠ¡è§„åˆ™æ¥æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæ“ä½œâ€</strong>ã€‚</p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://juejin.im/post/5b00c52ef265da0b95276091">https://juejin.im/post/5b00c52ef265da0b95276091</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> è½¬è½½ </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>volatile</title>
      <link href="/blog/2018/08/30/fe4c9cb6.html"/>
      <url>/blog/2018/08/30/fe4c9cb6.html</url>
      
        <content type="html"><![CDATA[<h3 id="volatileçš„ç”¨æ³•"><a href="#volatileçš„ç”¨æ³•" class="headerlink" title="volatileçš„ç”¨æ³•"></a>volatileçš„ç”¨æ³•</h3><p><code>volatile</code>é€šå¸¸è¢«æ¯”å–»æˆâ€è½»é‡çº§çš„<code>synchronized</code>â€œï¼Œä¹Ÿæ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå…³é”®å­—ã€‚å’Œ<code>synchronized</code>ä¸åŒï¼Œ<code>volatile</code>æ˜¯ä¸€ä¸ªå˜é‡ä¿®é¥°ç¬¦ï¼Œåªèƒ½ç”¨æ¥ä¿®é¥°å˜é‡ã€‚æ— æ³•ä¿®é¥°æ–¹æ³•åŠä»£ç å—ç­‰ã€‚</p><p><code>volatile</code>çš„ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨å£°æ˜ä¸€ä¸ªå¯èƒ½è¢«å¤šçº¿ç¨‹åŒæ—¶è®¿é—®çš„å˜é‡æ—¶ï¼Œä½¿ç”¨<code>volatile</code>ä¿®é¥°å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton singleton;  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;  </span><br><span class="line">            singleton = <span class="keyword">new</span> Singleton();  </span><br><span class="line">        &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> singleton;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>å¦‚ä»¥ä¸Šä»£ç ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åŒé‡é”æ ¡éªŒçš„å½¢å¼å®ç°å•ä¾‹çš„ï¼Œå…¶ä¸­ä½¿ç”¨<code>volatile</code>å…³é”®å­—ä¿®é¥°å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åˆ°çš„singletonã€‚</p><h3 id="volatileçš„åŸç†"><a href="#volatileçš„åŸç†" class="headerlink" title="volatileçš„åŸç†"></a>volatileçš„åŸç†</h3><blockquote><p>ä¸ºäº†æé«˜å¤„ç†å™¨çš„æ‰§è¡Œé€Ÿåº¦ï¼Œåœ¨å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´å¢åŠ äº†å¤šçº§ç¼“å­˜æ¥æå‡ã€‚ä½†æ˜¯ç”±äºå¼•å…¥äº†å¤šçº§ç¼“å­˜ï¼Œå°±å­˜åœ¨ç¼“å­˜æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p><p>ä½†æ˜¯ï¼Œå¯¹äº<code>volatile</code>å˜é‡ï¼Œå½“å¯¹<code>volatile</code>å˜é‡è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼ŒJVMä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡lockå‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªç¼“å­˜ä¸­çš„å˜é‡å›å†™åˆ°ç³»ç»Ÿä¸»å­˜ä¸­ã€‚</p><p>ä½†æ˜¯å°±ç®—å†™å›åˆ°å†…å­˜ï¼Œå¦‚æœå…¶ä»–å¤„ç†å™¨ç¼“å­˜çš„å€¼è¿˜æ˜¯æ—§çš„ï¼Œå†æ‰§è¡Œè®¡ç®—æ“ä½œå°±ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å¤šå¤„ç†å™¨ä¸‹ï¼Œä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¼šå®ç°<code>ç¼“å­˜ä¸€è‡´æ€§åè®®</code></p></blockquote><h4 id="ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®</h4><p>æ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨è¦å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šå¼ºåˆ¶é‡æ–°ä»ç³»ç»Ÿå†…å­˜é‡ŒæŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜é‡Œã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªå˜é‡è¢«<code>volatile</code>æ‰€ä¿®é¥°çš„è¯ï¼Œåœ¨æ¯æ¬¡æ•°æ®å˜åŒ–ä¹‹åï¼Œå…¶å€¼éƒ½ä¼šè¢«å¼ºåˆ¶åˆ·å…¥ä¸»å­˜ã€‚è€Œå…¶ä»–å¤„ç†å™¨çš„ç¼“å­˜ç”±äºéµå®ˆäº†ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä¹Ÿä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼ä»ä¸»å­˜åŠ è½½åˆ°è‡ªå·±çš„ç¼“å­˜ä¸­ã€‚è¿™å°±ä¿è¯äº†ä¸€ä¸ª<code>volatile</code>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå…¶å€¼åœ¨å¤šä¸ªç¼“å­˜ä¸­æ˜¯å¯è§çš„ã€‚</p><h3 id="volatileä¸å¯è§æ€§"><a href="#volatileä¸å¯è§æ€§" class="headerlink" title="volatileä¸å¯è§æ€§"></a>volatileä¸å¯è§æ€§</h3><p><strong>å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚</strong></p><p><a href="https://blog.cayzlh.com/2018/08/28/2018082801/">Javaå†…å­˜æ¨¡å‹</a>è§„å®šäº†æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä¸­æ˜¯ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ã€‚ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„ä¼ é€’å‡éœ€è¦è‡ªå·±çš„å·¥ä½œå†…å­˜å’Œä¸»å­˜ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥è¿›è¡Œã€‚æ‰€ä»¥ï¼Œå°±å¯èƒ½å‡ºç°çº¿ç¨‹1æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œä½†æ˜¯çº¿ç¨‹2ä¸å¯è§çš„æƒ…å†µã€‚</p><blockquote><p>Javaä¸­çš„<code>volatile</code>å…³é”®å­—æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œè¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡æ˜¯ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨<code>volatile</code>æ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚</p></blockquote><p>volatileå¯¹äºå¯è§æ€§çš„å®ç°ï¼Œ<strong>å†…å­˜å±éšœ</strong>ä¹Ÿèµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚å› ä¸ºå†…å­˜å±éšœç›¸å½“äºä¸€ä¸ªæ•°æ®åŒæ­¥ç‚¹ï¼Œä»–è¦ä¿è¯åœ¨è¿™ä¸ªåŒæ­¥ç‚¹ä¹‹åçš„è¯»å†™æ“ä½œå¿…é¡»åœ¨è¿™ä¸ªç‚¹ä¹‹å‰çš„è¯»å†™æ“ä½œéƒ½æ‰§è¡Œå®Œä¹‹åæ‰å¯ä»¥æ‰§è¡Œã€‚å¹¶ä¸”åœ¨é‡åˆ°å†…å­˜å±éšœçš„æ—¶å€™ï¼Œç¼“å­˜æ•°æ®ä¼šå’Œä¸»å­˜è¿›è¡ŒåŒæ­¥ï¼Œæˆ–è€…æŠŠç¼“å­˜æ•°æ®å†™å…¥ä¸»å­˜ã€æˆ–è€…ä»ä¸»å­˜æŠŠæ•°æ®è¯»å–åˆ°ç¼“å­˜ã€‚</p><p><em>å†…å­˜ä¸€è‡´æ€§æ¨¡å‹çš„å®ç°å¯ä»¥é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®ç°ã€‚åŒæ—¶ï¼Œç•™äº†ä¸€ä¸ªé—®é¢˜ï¼šå·²ç»æœ‰äº†ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦volatileï¼Ÿ</em></p><blockquote><p>1ã€å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶æ¶æ„éƒ½æä¾›äº†ç›¸åŒçš„ä¸€è‡´æ€§ä¿è¯ï¼ŒJavaä½œä¸ºä¸€é—¨è·¨å¹³å°è¯­è¨€ï¼ŒJVMéœ€è¦æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è¯­ä¹‰ã€‚</p><p>2ã€æ“ä½œç³»ç»Ÿä¸­çš„ç¼“å­˜å’ŒJVMä¸­çº¿ç¨‹çš„æœ¬åœ°å†…å­˜å¹¶ä¸æ˜¯ä¸€å›äº‹ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼šMESIå¯ä»¥è§£å†³ç¼“å­˜å±‚é¢çš„å¯è§æ€§é—®é¢˜ã€‚ä½¿ç”¨volatileå…³é”®å­—ï¼Œå¯ä»¥è§£å†³JVMå±‚é¢çš„å¯è§æ€§é—®é¢˜ã€‚</p><p>3ã€ç¼“å­˜å¯è§æ€§é—®é¢˜çš„å»¶ä¼¸ï¼šç”±äºä¼ ç»Ÿçš„MESIåè®®çš„æ‰§è¡Œæˆæœ¬æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥CPUé€šè¿‡Store Bufferå’ŒInvalidate Queueç»„ä»¶æ¥è§£å†³ï¼Œä½†æ˜¯ç”±äºè¿™ä¸¤ä¸ªç»„ä»¶çš„å¼•å…¥ï¼Œä¹Ÿå¯¼è‡´ç¼“å­˜å’Œä¸»å­˜ä¹‹é—´çš„é€šä¿¡å¹¶ä¸æ˜¯å®æ—¶çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ç¼“å­˜ä¸€è‡´æ€§æ¨¡å‹åªèƒ½ä¿è¯ç¼“å­˜å˜æ›´å¯ä»¥ä¿è¯å…¶ä»–ç¼“å­˜ä¹Ÿè·Ÿç€æ”¹å˜ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯ç«‹åˆ»ã€é©¬ä¸Šæ‰§è¡Œã€‚</strong></p></blockquote><p><em>å†™å†…å­˜å±éšœï¼ˆStore Memory Barrierï¼‰</em>å¯ä»¥ä¿ƒä½¿å¤„ç†å™¨å°†å½“å‰store bufferï¼ˆå­˜å‚¨ç¼“å­˜ï¼‰çš„å€¼å†™å›ä¸»å­˜ã€‚</p><p><em>è¯»å†…å­˜å±éšœï¼ˆLoad Memory Barrierï¼‰</em>å¯ä»¥ä¿ƒä½¿å¤„ç†å™¨å¤„ç†invalidate queueï¼ˆå¤±æ•ˆé˜Ÿåˆ—ï¼‰ã€‚</p><p><strong>æ‰€ä»¥ï¼Œå†…å­˜å±éšœä¹Ÿæ˜¯ä¿è¯å¯è§æ€§çš„é‡è¦æ‰‹æ®µï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡å†…å­˜å±éšœä¿è¯ç¼“å­˜é—´çš„å¯è§æ€§ï¼ŒJVMé€šè¿‡ç»™volatileå˜é‡åŠ å…¥å†…å­˜å±éšœä¿è¯çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€‚</strong>è¿›è€Œé¿å…ç”±äºStore Bufferå’ŒInvalidate Queueçš„éå®æ—¶æ€§å¸¦æ¥çš„é—®é¢˜ã€‚</p><h4 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h4><p>Javaä¸­çš„å†…å­˜å±éšœï¼šç”¨äºæ§åˆ¶ç‰¹å®šæ¡ä»¶ä¸‹çš„é‡æ’åºå’Œå†…å­˜å¯è§æ€§é—®é¢˜ã€‚Javaç¼–è¯‘å™¨ä¹Ÿä¼šæ ¹æ®å†…å­˜å±éšœçš„è§„åˆ™ç¦æ­¢é‡æ’åºã€‚</p><h3 id="volatileä¸æœ‰åºæ€§"><a href="#volatileä¸æœ‰åºæ€§" class="headerlink" title="volatileä¸æœ‰åºæ€§"></a>volatileä¸æœ‰åºæ€§</h3><blockquote><p>æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ </p></blockquote><p><a href="https://blog.cayzlh.com/2018/08/28/2018082801/">é™¤äº†å¼•å…¥äº†æ—¶é—´ç‰‡ä»¥å¤–ï¼Œç”±äºå¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ç­‰ï¼ŒCPUè¿˜å¯èƒ½å¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼Œæ¯”å¦‚<code>load-&gt;add-&gt;save</code> æœ‰å¯èƒ½è¢«ä¼˜åŒ–æˆ<code>load-&gt;save-&gt;add</code> ã€‚è¿™å°±æ˜¯å¯èƒ½å­˜åœ¨æœ‰åºæ€§é—®é¢˜</a>ã€‚</p><p>è€Œ<code>volatile</code>é™¤äº†å¯ä»¥ä¿è¯æ•°æ®çš„å¯è§æ€§ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯ä»–å¯ä»¥<strong>ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–</strong>ç­‰ã€‚</p><p>æ™®é€šçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡çš„èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚</p><p>volatileå¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œè¿™å°±ä¿è¯äº†ä»£ç çš„ç¨‹åºä¼šä¸¥æ ¼æŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚è¿™å°±ä¿è¯äº†æœ‰åºæ€§ã€‚è¢«<code>volatile</code>ä¿®é¥°çš„å˜é‡çš„æ“ä½œï¼Œä¼šä¸¥æ ¼æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œï¼Œ<code>load-&gt;add-&gt;save</code> çš„æ‰§è¡Œé¡ºåºå°±æ˜¯ï¼šloadã€addã€saveã€‚</p><p><strong>volatileæ˜¯é€šè¿‡<em>å†…å­˜å±éšœ</em>æ¥æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’çš„ã€‚</strong></p><p><strong>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰</strong>æ˜¯ä¸€ç±»åŒæ­¥å±éšœæŒ‡ä»¤ï¼Œæ˜¯CPUæˆ–ç¼–è¯‘å™¨åœ¨å¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œã€‚ä¸‹è¡¨æè¿°äº†å’Œvolatileæœ‰å…³çš„æŒ‡ä»¤é‡æ’ç¦æ­¢è¡Œä¸ºï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018083001/1.png" alt="å†…å­˜å±éšœ"></p><p>å¯ä»¥çœ‹å‡ºï¼š</p><blockquote><p>å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileå†™ä¹‹åã€‚</p><p>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileè¯»ä¹‹å‰ã€‚</p><p>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚</p></blockquote><p>å…·ä½“å®ç°æ–¹å¼æ˜¯åœ¨ç¼–è¯‘æœŸç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­å¢åŠ å†…å­˜å±éšœæ¥ä¿è¯ï¼Œä¸‹é¢æ˜¯åŸºäºä¿å®ˆç­–ç•¥çš„JMMå†…å­˜å±éšœæ’å…¥ç­–ç•¥ï¼š</p><ul><li><p>åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª<code>StoreStore</code>å±éšœã€‚</p></li><li><ul><li>å¯¹äºè¿™æ ·çš„è¯­å¥Store1; StoreLoad; Store2ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥æ“ä½œå¯¹å…¶å®ƒå¤„ç†å™¨å¯è§ã€‚</li></ul></li><li><p>åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª<code>StoreLoad</code>å±éšœã€‚</p></li><li><ul><li>å¯¹äºè¿™æ ·çš„è¯­å¥Store1; StoreLoad; Load2ï¼Œåœ¨Load2åŠåç»­æ‰€æœ‰è¯»å–æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥å¯¹æ‰€æœ‰å¤„ç†å™¨å¯è§ã€‚</li></ul></li><li><p>åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª<code>LoadLoad</code>å±éšœã€‚</p></li><li><ul><li>å¯¹äºè¿™æ ·çš„è¯­å¥Load1;LoadLoad; Load2ï¼Œåœ¨Load2åŠåç»­è¯»å–æ“ä½œè¦è¯»å–çš„æ•°æ®è¢«è®¿é—®å‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚</li></ul></li><li><p>åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª<code>LoadStore</code>å±éšœã€‚</p></li><li><ul><li>å¯¹äºè¿™æ ·çš„è¯­å¥Load1; LoadStore; Store2ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œè¢«åˆ·å‡ºå‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚</li></ul></li></ul><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/2018083001/2.png" alt="å†…å­˜å±éšœ"></p><p>æ‰€ä»¥ï¼Œvolatileé€šè¿‡åœ¨volatileå˜é‡çš„æ“ä½œå‰åæ’å…¥å†…å­˜å±éšœçš„æ–¹å¼ï¼Œæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œè¿›è€Œä¿è¯å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯¹å…±äº«å˜é‡çš„æœ‰åºæ€§ã€‚</p><h3 id="volatileä¸åŸå­æ€§"><a href="#volatileä¸åŸå­æ€§" class="headerlink" title="volatileä¸åŸå­æ€§"></a>volatileä¸åŸå­æ€§</h3><blockquote><p>åŸå­æ€§æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œè¦å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±éƒ½ä¸æ‰§è¡Œã€‚ </p></blockquote><p><strong>çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚CPUæœ‰æ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œä¼šæ ¹æ®ä¸åŒçš„è°ƒåº¦ç®—æ³•è¿›è¡Œçº¿ç¨‹è°ƒåº¦ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å¾—æ—¶é—´ç‰‡ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œåœ¨æ—¶é—´ç‰‡è€—å°½ä¹‹åï¼Œå°±ä¼šå¤±å»CPUä½¿ç”¨æƒã€‚æ‰€ä»¥åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œç”±äºæ—¶é—´ç‰‡åœ¨çº¿ç¨‹é—´è½®æ¢ï¼Œå°±ä¼šå‘ç”ŸåŸå­æ€§é—®é¢˜ã€‚</strong></p><p><a href="https://blog.cayzlh.com/2018/08/28/2018082802/">synchronized</a>æåˆ°è¿‡ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œéœ€è¦é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤<code>monitorenter</code>å’Œ<code>monitorexit</code>ï¼Œä½†æ˜¯<code>volatile</code>å’Œè¿™ä¸¤ä¸ªæŒ‡ä»¤ä¹‹é—´æ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„ã€‚</p><p><strong>æ‰€ä»¥ï¼Œvolatileæ˜¯ä¸èƒ½ä¿è¯åŸå­æ€§çš„ã€‚</strong></p><p>åœ¨ä»¥ä¸‹ä¸¤ä¸ªåœºæ™¯ä¸­å¯ä»¥ä½¿ç”¨<code>volatile</code>æ¥ä»£æ›¿<code>synchronized</code>ï¼š</p><blockquote><p>1ã€è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¼šä¿®æ”¹å˜é‡çš„å€¼ã€‚</p><p>2ã€å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚</p></blockquote><p>é™¤ä»¥ä¸Šåœºæ™¯å¤–ï¼Œéƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼æ¥ä¿è¯åŸå­æ€§ï¼Œå¦‚<code>synchronized</code>æˆ–è€…<code>concurrentåŒ…</code>ã€‚ </p><p>çœ‹å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000</span>;j++)</span><br><span class="line">                        test.increase();</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(Thread.activeCount()&gt;<span class="number">1</span>)  <span class="comment">//ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">        System.out.println(test.i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œç„¶ååˆ†åˆ«æ‰§è¡Œ1000æ¬¡<code>i++</code>æ“ä½œã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œç¨‹åºçš„è¾“å‡ºç»“æœåº”è¯¥æ˜¯10000ï¼Œä½†æ˜¯ï¼Œå¤šæ¬¡æ‰§è¡Œçš„ç»“æœéƒ½å°äº10000ã€‚è¿™å…¶å®å°±æ˜¯<code>volatile</code>æ— æ³•æ»¡è¶³åŸå­æ€§çš„åŸå› ã€‚</p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Œé‚£å°±æ˜¯å› ä¸ºè™½ç„¶volatileå¯ä»¥ä¿è¯<code>i</code>åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€‚ä½†æ˜¯æ— æ³•ä¿è¯<code>i++</code>çš„åŸå­æ€§ã€‚</p><p><code>i++</code>æ“ä½œï¼Œä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š<code>load i</code> ï¼Œ<code>add i</code> ,<code>save i</code>ã€‚åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œå¦‚æœè¿™ä¸‰ä¸ªæ­¥éª¤æ— æ³•æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p>ç”±äºCPUæŒ‰ç…§æ—¶é—´ç‰‡æ¥è¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„ï¼Œåªè¦æ˜¯åŒ…å«å¤šä¸ªæ­¥éª¤çš„æ“ä½œçš„æ‰§è¡Œï¼Œå¤©ç„¶å°±æ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„ã€‚å› ä¸ºè¿™ç§çº¿ç¨‹æ‰§è¡Œï¼Œåˆä¸åƒæ•°æ®åº“ä¸€æ ·å¯ä»¥å›æ»šã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¦æ‰§è¡Œçš„æ­¥éª¤æœ‰5æ­¥ï¼Œæ‰§è¡Œå®Œ3æ­¥å°±å¤±å»äº†CPUäº†ï¼Œå¤±å»åå°±å¯èƒ½å†ä¹Ÿä¸ä¼šè¢«è°ƒåº¦ï¼Œè¿™æ€ä¹ˆå¯èƒ½ä¿è¯åŸå­æ€§å‘¢ã€‚</p><p>ä¸ºä»€ä¹ˆ<code>synchronized</code>å¯ä»¥ä¿è¯åŸå­æ€§ ï¼Œå› ä¸ºè¢«<code>synchronized</code>ä¿®é¥°çš„ä»£ç ç‰‡æ®µï¼Œåœ¨è¿›å…¥ä¹‹å‰åŠ äº†é”ï¼Œåªè¦ä»–æ²¡æ‰§è¡Œå®Œï¼Œå…¶ä»–çº¿ç¨‹æ˜¯æ— æ³•è·å¾—é”æ‰§è¡Œè¿™æ®µä»£ç ç‰‡æ®µçš„ï¼Œå°±å¯ä»¥ä¿è¯ä»–å†…éƒ¨çš„ä»£ç å¯ä»¥å…¨éƒ¨è¢«æ‰§è¡Œã€‚è¿›è€Œä¿è¯åŸå­æ€§ã€‚</p><p>ä½†æ˜¯<code>synchronized</code>å¯¹åŸå­æ€§ä¿è¯ä¹Ÿä¸ç»å¯¹ï¼Œä¸€æ—¦ä»£ç è¿è¡Œå¼‚å¸¸ï¼Œä¹Ÿæ²¡åŠæ³•å›æ»šã€‚æ‰€ä»¥å‘¢ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼ŒåŸå­æ€§çš„å®šä¹‰ä¸åº”è¯¥å’Œäº‹åŠ¡ä¸­çš„åŸå­æ€§ä¸€æ ·ã€‚ä»–åº”è¯¥å®šä¹‰ä¸ºï¼š<strong>ä¸€æ®µä»£ç ï¼Œæˆ–è€…ä¸€ä¸ªå˜é‡çš„æ“ä½œï¼Œåœ¨æ²¡æœ‰æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚</strong></p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆ<code>volatile</code>ä¸èƒ½ä¿è¯åŸå­æ€§å‘¢ï¼Ÿå› ä¸ºä»–ä¸æ˜¯é”ï¼Œä»–æ²¡åšä»»ä½•å¯ä»¥ä¿è¯åŸå­æ€§çš„å¤„ç†ã€‚å½“ç„¶å°±ä¸èƒ½ä¿è¯åŸå­æ€§äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>synchronized</title>
      <link href="/blog/2018/08/28/edea11bc.html"/>
      <url>/blog/2018/08/28/edea11bc.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>Javaè¯­è¨€ä¸ºäº†è§£å†³å¹¶å‘ç¼–ç¨‹ä¸­å­˜åœ¨çš„åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼Œæä¾›äº†ä¸€ç³»åˆ—å’Œå¹¶å‘å¤„ç†ç›¸å…³çš„å…³é”®å­—ï¼Œæ¯”å¦‚synchronizedã€volatileã€finalã€concurrenåŒ…ç­‰ã€‚</p></blockquote><p>åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p><blockquote><p><code>synchronized</code>å…³é”®å­—åœ¨éœ€è¦åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§è¿™ä¸‰ç§ç‰¹æ€§çš„æ—¶å€™éƒ½å¯ä»¥ä½œä¸ºå…¶ä¸­ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œçœ‹èµ·æ¥æ˜¯â€œä¸‡èƒ½â€çš„ã€‚çš„ç¡®ï¼Œå¤§éƒ¨åˆ†å¹¶å‘æ§åˆ¶æ“ä½œéƒ½èƒ½ä½¿ç”¨synchronizedæ¥å®Œæˆã€‚</p></blockquote><p><code>synchronized</code>åªæ˜¯ä¸ªå…³é”®å­—è€Œå·²ï¼Œç”¨èµ·æ¥å¾ˆç®€å•ã€‚ä¹‹æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å¤„ç†å¤šçº¿ç¨‹é—®é¢˜æ—¶å¯ä»¥ä¸ç”¨è€ƒè™‘å¤ªå¤šï¼Œå°±æ˜¯å› ä¸ºè¿™ä¸ªå…³é”®å­—å¸®æˆ‘ä»¬å±è”½äº†å¾ˆå¤šç»†èŠ‚ã€‚</p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»<code>synchronized</code>çš„ç”¨æ³•ã€åŸç†ï¼Œä»¥åŠå¦‚ä½•æä¾›åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ä¿éšœçš„ç­‰ã€‚</p><h3 id="synchronizedçš„ç”¨æ³•"><a href="#synchronizedçš„ç”¨æ³•" class="headerlink" title="synchronizedçš„ç”¨æ³•"></a>synchronizedçš„ç”¨æ³•</h3><p><code>synchronized</code>æ˜¯Javaæä¾›çš„ä¸€ä¸ªå¹¶å‘æ§åˆ¶çš„å…³é”®å­—ã€‚ä¸»è¦æœ‰ä¸¤ç§ç”¨æ³•ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>synchronized</code>æ—¢å¯ä»¥ä¿®é¥°æ–¹æ³•ä¹Ÿå¯ä»¥ä¿®é¥°ä»£ç å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line">     <span class="comment">//åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŒæ­¥ä»£ç å—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doOtherThing</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SynchronizedDemo.class)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«<code>synchronized</code>ä¿®é¥°çš„ä»£ç å—åŠæ–¹æ³•ï¼Œåœ¨åŒä¸€æ—¶é—´ï¼Œåªèƒ½è¢«å•ä¸ªçº¿ç¨‹è®¿é—®ã€‚ </p><h3 id="synchronizedçš„å®ç°åŸç†"><a href="#synchronizedçš„å®ç°åŸç†" class="headerlink" title="synchronizedçš„å®ç°åŸç†"></a>synchronizedçš„å®ç°åŸç†</h3><blockquote><p><code>synchronized</code>ï¼Œæ˜¯Javaä¸­ç”¨äºè§£å†³å¹¶å‘æƒ…å†µä¸‹æ•°æ®åŒæ­¥è®¿é—®çš„ä¸€ä¸ªå¾ˆé‡è¦çš„å…³é”®å­—ã€‚å½“æˆ‘ä»¬æƒ³è¦ä¿è¯ä¸€ä¸ªå…±äº«èµ„æºåœ¨åŒä¸€æ—¶é—´åªä¼šè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®åˆ°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨<code>synchronized</code>å…³é”®å­—å¯¹ç±»æˆ–è€…å¯¹è±¡åŠ é”ã€‚</p></blockquote><p>æˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œåç¼–è¯‘ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">cayzlh</span>.<span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> com.cayzlh.SynchronizedDemo();</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">       3: ldc           #3                  // String Hello World</span><br><span class="line">       5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">       <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doOtherThing</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: ldc           #5                  // class com/cayzlh/SynchronizedDemo</span><br><span class="line">       <span class="number">2</span>: dup</span><br><span class="line">       <span class="number">3</span>: astore_1</span><br><span class="line">       <span class="number">4</span>: monitorenter</span><br><span class="line">       5: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">       8: ldc           #3                  // String Hello World</span><br><span class="line">      10: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">      <span class="number">13</span>: aload_1</span><br><span class="line">      <span class="number">14</span>: monitorexit</span><br><span class="line">      <span class="number">15</span>: goto          <span class="number">23</span></span><br><span class="line">      <span class="number">18</span>: astore_2</span><br><span class="line">      <span class="number">19</span>: aload_1</span><br><span class="line">      <span class="number">20</span>: monitorexit</span><br><span class="line">      <span class="number">21</span>: aload_2</span><br><span class="line">      <span class="number">22</span>: athrow</span><br><span class="line">      <span class="number">23</span>: <span class="keyword">return</span></span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">           <span class="number">5</span>    <span class="number">15</span>    <span class="number">18</span>   any</span><br><span class="line">          <span class="number">18</span>    <span class="number">21</span>    <span class="number">18</span>   any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼š</p><p>å¯¹äºåŒæ­¥æ–¹æ³•ï¼ŒJVMé‡‡ç”¨<code>ACC_SYNCHRONIZED</code>æ ‡è®°ç¬¦æ¥å®ç°åŒæ­¥ã€‚ </p><p>å¯¹äºåŒæ­¥ä»£ç å—ã€‚JVMé‡‡ç”¨<code>monitorenter</code>ã€<code>monitorexit</code>ä¸¤ä¸ªæŒ‡ä»¤æ¥å®ç°åŒæ­¥ã€‚</p><p>åœ¨The JavaÂ® Virtual Machine Specificationä¸­æœ‰å…³äºåŒæ­¥æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—çš„å®ç°åŸç†çš„ä»‹ç»:</p><blockquote><p>Method-level synchronization is performed implicitly, as part of method invocation and return. A synchronized method is distinguished in the run-time constant poolâ€™s method<em>info structure by the ACC</em>SYNCHRONIZED flag, which is checked by the method invocation instructions. When invoking a method for which ACC_SYNCHRONIZED is set, the executing thread enters a monitor, invokes the method itself, and exits the monitor whether the method invocation completes normally or abruptly. During the time the executing thread owns the monitor, no other thread may enter it. If an exception is thrown during invocation of the synchronized method and the synchronized method does not handle the exception, the monitor for the method is automatically exited before the exception is rethrown out of the synchronized method.</p><p>æ–¹æ³•çº§çš„åŒæ­¥æ˜¯éšå¼çš„ã€‚åŒæ­¥æ–¹æ³•çš„å¸¸é‡æ± ä¸­ä¼šæœ‰ä¸€ä¸ª<code>ACC_SYNCHRONIZED</code>æ ‡å¿—ã€‚å½“æŸä¸ªçº¿ç¨‹è¦è®¿é—®æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰<code>ACC_SYNCHRONIZED</code>ï¼Œå¦‚æœæœ‰è®¾ç½®ï¼Œåˆ™éœ€è¦å…ˆè·å¾—ç›‘è§†å™¨é”ï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ–¹æ³•ï¼Œæ–¹æ³•æ‰§è¡Œä¹‹åå†é‡Šæ”¾ç›‘è§†å™¨é”ã€‚è¿™æ—¶å¦‚æœå…¶ä»–çº¿ç¨‹æ¥è¯·æ±‚æ‰§è¡Œæ–¹æ³•ï¼Œä¼šå› ä¸ºæ— æ³•è·å¾—ç›‘è§†å™¨é”è€Œè¢«é˜»æ–­ä½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<strong>å¦‚æœåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¹¶ä¸”æ–¹æ³•å†…éƒ¨å¹¶æ²¡æœ‰å¤„ç†è¯¥å¼‚å¸¸ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸è¢«æŠ›åˆ°æ–¹æ³•å¤–é¢ä¹‹å‰ç›‘è§†å™¨é”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚</strong></p><p>åŒæ­¥ä»£ç å—ä½¿ç”¨<code>monitorenter</code>å’Œ<code>monitorexit</code>ä¸¤ä¸ªæŒ‡ä»¤å®ç°ã€‚å¯ä»¥æŠŠæ‰§è¡Œ<code>monitorenter</code>æŒ‡ä»¤ç†è§£ä¸ºåŠ é”ï¼Œæ‰§è¡Œ<code>monitorexit</code>ç†è§£ä¸ºé‡Šæ”¾é”ã€‚ æ¯ä¸ªå¯¹è±¡ç»´æŠ¤ç€ä¸€ä¸ªè®°å½•ç€è¢«é”æ¬¡æ•°çš„è®¡æ•°å™¨ã€‚æœªè¢«é”å®šçš„å¯¹è±¡çš„è¯¥è®¡æ•°å™¨ä¸º0ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ï¼ˆæ‰§è¡Œ<code>monitorenter</code>ï¼‰åï¼Œè¯¥è®¡æ•°å™¨è‡ªå¢å˜ä¸º 1 ï¼Œå½“åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å¾—è¯¥å¯¹è±¡çš„é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨å†æ¬¡è‡ªå¢ã€‚å½“åŒä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”ï¼ˆæ‰§è¡Œ<code>monitorexit</code>æŒ‡ä»¤ï¼‰çš„æ—¶å€™ï¼Œè®¡æ•°å™¨å†è‡ªå‡ã€‚å½“è®¡æ•°å™¨ä¸º0çš„æ—¶å€™ã€‚é”å°†è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿å¯ä»¥è·å¾—é”ã€‚</p></blockquote><p>æ— è®ºæ˜¯<code>ACC_SYNCHRONIZED</code>è¿˜æ˜¯<code>monitorenter</code>ã€<code>monitorexit</code>éƒ½æ˜¯åŸºäºMonitorå®ç°çš„ï¼Œåœ¨Javaè™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitoræ˜¯åŸºäºC++å®ç°çš„ï¼Œç”±ObjectMonitorå®ç°ã€‚</p><p><code>ObjectMonitor</code>ç±»ä¸­æä¾›äº†å‡ ä¸ªæ–¹æ³•ï¼Œå¦‚<code>enter</code>ã€<code>exit</code>ã€<code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code>ç­‰ã€‚<code>sychronized</code>åŠ é”çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>objectMonitor</code>çš„<code>enter</code>æ–¹æ³•ï¼Œè§£é”çš„æ—¶å€™ä¼šè°ƒç”¨<code>exit</code>æ–¹æ³•ã€‚</p><h3 id="synchronizedä¸æœ‰åºæ€§"><a href="#synchronizedä¸æœ‰åºæ€§" class="headerlink" title="synchronizedä¸æœ‰åºæ€§"></a>synchronizedä¸æœ‰åºæ€§</h3><p>æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚</p><blockquote><p>ç”±äºå¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ç­‰ï¼ŒCPUè¿˜å¯èƒ½å¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼Œæ¯”å¦‚load-&gt;add-&gt;save æœ‰å¯èƒ½è¢«ä¼˜åŒ–æˆload-&gt;save-&gt;add ã€‚è¿™å°±æ˜¯å¯èƒ½å­˜åœ¨æœ‰åºæ€§é—®é¢˜ã€‚</p></blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>synchronized</code>æ˜¯æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>synchronized</code>æ— æ³•é¿å…ä¸Šè¿°æåˆ°çš„é—®é¢˜ã€‚</p><p><em>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜è¯´<code>synchronized</code>ä¹Ÿæä¾›äº†æœ‰åºæ€§ä¿è¯å‘¢ï¼Ÿ</em></p><p><strong>Javaç¨‹åºä¸­å¤©ç„¶çš„æœ‰åºæ€§å¯ä»¥æ€»ç»“ä¸ºä¸€å¥è¯ï¼šå¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯å¤©ç„¶æœ‰åºçš„ã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚</strong></p><p>ä»¥ä¸Šè¿™å¥è¯ä¹Ÿæ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­çš„åŸå¥ï¼Œè¿™å’Œ<code>as-if-serialè¯­ä¹‰</code>æœ‰å…³ã€‚</p><p><code>as-if-serial</code>è¯­ä¹‰çš„æ„æ€æŒ‡ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œå•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœéƒ½ä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ— è®ºå¦‚ä½•ä¼˜åŒ–ï¼Œéƒ½å¿…é¡»éµå®ˆ<code>as-if-serial</code>è¯­ä¹‰ã€‚</p><p>ç®€å•è¯´å°±æ˜¯ï¼Œ<code>as-if-serialè¯­ä¹‰</code>ä¿è¯äº†å•çº¿ç¨‹ä¸­ï¼ŒæŒ‡ä»¤é‡æ’æ˜¯æœ‰ä¸€å®šçš„é™åˆ¶çš„ï¼Œè€Œåªè¦ç¼–è¯‘å™¨å’Œå¤„ç†å™¨éƒ½éµå®ˆäº†è¿™ä¸ªè¯­ä¹‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚å½“ç„¶ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰é‡æ’çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬æ— é¡»å…³å¿ƒè¿™ç§é‡æ’çš„å¹²æ‰°ã€‚</p><p><strong>æ‰€ä»¥å‘¢ï¼Œç”±äºsynchronizedä¿®é¥°çš„ä»£ç ï¼ŒåŒä¸€æ—¶é—´åªèƒ½è¢«åŒä¸€çº¿ç¨‹è®¿é—®ã€‚é‚£ä¹ˆä¹Ÿå°±æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ä¿è¯å…¶æœ‰åºæ€§ã€‚</strong></p><h3 id="synchronizedä¸é”ä¼˜åŒ–"><a href="#synchronizedä¸é”ä¼˜åŒ–" class="headerlink" title="synchronizedä¸é”ä¼˜åŒ–"></a><strong>synchronizedä¸é”ä¼˜åŒ–</strong></h3><p><code>synchronized</code>å…¶å®æ˜¯å€ŸåŠ©Monitorå®ç°çš„ï¼Œåœ¨åŠ é”æ—¶ä¼šè°ƒç”¨objectMonitorçš„<code>enter</code>æ–¹æ³•ï¼Œè§£é”çš„æ—¶å€™ä¼šè°ƒç”¨<code>exit</code>æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œåªæœ‰åœ¨JDK1.6ä¹‹å‰ï¼Œsynchronizedçš„å®ç°æ‰ä¼šç›´æ¥è°ƒç”¨ObjectMonitorçš„<code>enter</code>å’Œ<code>exit</code>ï¼Œè¿™ç§é”è¢«ç§°ä¹‹ä¸ºé‡é‡çº§é”ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨JDK1.6ä¸­å‡ºç°å¯¹é”è¿›è¡Œäº†å¾ˆå¤šçš„ä¼˜åŒ–ï¼Œè¿›è€Œå‡ºç°è½»é‡çº§é”ï¼Œåå‘é”ï¼Œé”æ¶ˆé™¤ï¼Œé€‚åº”æ€§è‡ªæ—‹é”ï¼Œé”ç²—åŒ–(è‡ªæ—‹é”åœ¨1.4å°±æœ‰ï¼Œåªä¸è¿‡é»˜è®¤çš„æ˜¯å…³é—­çš„ï¼Œjdk1.6æ˜¯é»˜è®¤å¼€å¯çš„)ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆçš„å…±äº«æ•°æ® ï¼Œè§£å†³ç«äº‰é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå†…å­˜æ¨¡å‹çš„å®ç°</title>
      <link href="/blog/2018/08/28/2e82a2db.html"/>
      <url>/blog/2018/08/28/2e82a2db.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨Javaä¸­æä¾›äº†ä¸€ç³»åˆ—å’Œå¹¶å‘å¤„ç†ç›¸å…³çš„å…³é”®å­—ï¼Œæ¯”å¦‚<code>volatile</code>ã€<code>synchronized</code>ã€<code>final</code>ã€<code>concurren</code>åŒ…ç­‰ã€‚å…¶å®è¿™äº›å°±æ˜¯Javaå†…å­˜æ¨¡å‹å°è£…äº†åº•å±‚çš„å®ç°åæä¾›ç»™ç¨‹åºå‘˜ä½¿ç”¨çš„ä¸€äº›å…³é”®å­—ã€‚</p></blockquote><h3 id="ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ ï¼Ÿ</h3><p>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€å¤„ç†å™¨å™¨ä¼˜åŒ–çš„æŒ‡ä»¤é‡æ’é—®é¢˜æ˜¯ç¡¬ä»¶çš„ä¸æ–­å‡çº§å¯¼è‡´çš„ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæœºåˆ¶å¯ä»¥å¾ˆå¥½çš„è§£å†³ä¸Šé¢çš„è¿™äº›é—®é¢˜å‘¢ï¼Ÿ</p><p>æœ€ç®€å•ç›´æ¥çš„åšæ³•å°±æ˜¯åºŸé™¤å¤„ç†å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–æŠ€æœ¯ã€åºŸé™¤CPUç¼“å­˜ï¼Œè®©CPUç›´æ¥å’Œä¸»å­˜äº¤äº’ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆåšè™½ç„¶å¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™å°±æœ‰ç‚¹å› å™åºŸé£Ÿäº†ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯å¹¶å‘ç¼–ç¨‹ä¸­å¯ä»¥æ»¡è¶³åŸå­æ€§ã€å¯è§æ€§åŠæœ‰åºæ€§ã€‚æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯â€”â€”å†…å­˜æ¨¡å‹ã€‚</p><p><strong>ä¸ºäº†ä¿è¯å…±äº«å†…å­˜çš„æ­£ç¡®æ€§ï¼ˆå¯è§æ€§ã€æœ‰åºæ€§ã€åŸå­æ€§ï¼‰ï¼Œå†…å­˜æ¨¡å‹å®šä¹‰äº†å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¤šçº¿ç¨‹ç¨‹åºè¯»å†™æ“ä½œè¡Œä¸ºçš„è§„èŒƒã€‚</strong>é€šè¿‡è¿™äº›è§„åˆ™æ¥è§„èŒƒå¯¹å†…å­˜çš„è¯»å†™æ“ä½œï¼Œä»è€Œä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚å®ƒä¸å¤„ç†å™¨æœ‰å…³ã€ä¸ç¼“å­˜æœ‰å…³ã€ä¸å¹¶å‘æœ‰å…³ã€ä¸ç¼–è¯‘å™¨ä¹Ÿæœ‰å…³ã€‚ä»–è§£å†³äº†CPUå¤šçº§ç¼“å­˜ã€å¤„ç†å™¨ä¼˜åŒ–ã€æŒ‡ä»¤é‡æ’ç­‰å¯¼è‡´çš„å†…å­˜è®¿é—®é—®é¢˜ï¼Œä¿è¯äº†å¹¶å‘åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§ã€‚</p><hr><p>åœ¨å¼€å‘å¤šçº¿ç¨‹çš„ä»£ç çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>synchronized</code>ç­‰å…³é”®å­—æ¥æ§åˆ¶å¹¶å‘ï¼Œä»æ¥å°±ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„ç¼–è¯‘å™¨ä¼˜åŒ–ã€ç¼“å­˜ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚æ‰€ä»¥ï¼Œ<strong>Javaå†…å­˜æ¨¡å‹ï¼Œé™¤äº†å®šä¹‰äº†ä¸€å¥—è§„èŒƒï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—åŸè¯­ï¼Œå°è£…äº†åº•å±‚å®ç°åï¼Œä¾›å¼€å‘è€…ç›´æ¥ä½¿ç”¨ã€‚</strong></p><h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><blockquote><p>åœ¨ä¸€ä¸ªæ“ä½œä¸­å°±æ˜¯cpuä¸å¯ä»¥åœ¨ä¸­é€”æš‚åœç„¶åå†è°ƒåº¦ï¼Œæ—¢ä¸è¢«ä¸­æ–­æ“ä½œï¼Œè¦ä¸æ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±ä¸æ‰§è¡Œ</p></blockquote><p>åœ¨Javaä¸­ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæä¾›äº†ä¸¤ä¸ªé«˜çº§çš„å­—èŠ‚ç æŒ‡ä»¤<code>monitorenter</code>å’Œ<code>monitorexit</code>ã€‚è¿™ä¸¤ä¸ªå­—èŠ‚ç ï¼Œåœ¨Javaä¸­å¯¹åº”çš„å…³é”®å­—å°±æ˜¯<code>synchronized</code>ã€‚</p><p>å› æ­¤ï¼Œåœ¨Javaä¸­å¯ä»¥ä½¿ç”¨<code>synchronized</code>æ¥ä¿è¯æ–¹æ³•å’Œä»£ç å—å†…çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚</p><h3 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h3><blockquote><p>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼</p></blockquote><p>Javaå†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼çš„è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°çš„ã€‚</p><p>Javaä¸­çš„<code>volatile</code>å…³é”®å­—æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯<strong>è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜</strong>ï¼Œè¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡æ˜¯ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨<code>volatile</code>æ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚</p><p>é™¤äº†<code>volatile</code>ï¼ŒJavaä¸­çš„<code>synchronized</code>å’Œ<code>final</code>ä¸¤ä¸ªå…³é”®å­—ä¹Ÿå¯ä»¥å®ç°å¯è§æ€§ã€‚åªä¸è¿‡å®ç°æ–¹å¼ä¸åŒï¼Œè¿™é‡Œä¸å†å±•å¼€äº†ã€‚</p><h3 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h3><blockquote><p>ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œ</p></blockquote><p>åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>synchronized</code>å’Œ<code>volatile</code>æ¥ä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚å®ç°æ–¹å¼æœ‰æ‰€åŒºåˆ«ï¼š</p><p><code>volatile</code>å…³é”®å­—ä¼šç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚<code>synchronized</code>å…³é”®å­—ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œã€‚</p><h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><p><a href="https://blog.cayzlh.com/2018/08/28/2018082802/">synchronizedçš„ä¸€äº›è®°å½•</a>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM (å†…å­˜åŒºåŸŸæ§åˆ¶å‚æ•°åŠå¯¹åº”æº¢å‡ºå¼‚å¸¸)</title>
      <link href="/blog/2018/08/19/95c0309a.html"/>
      <url>/blog/2018/08/19/95c0309a.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ–ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ¯æ¬¡é‡åˆ°OutOfMemoryå¼‚å¸¸æˆ–GCå¼‚å¸¸æˆ–StackOverflowErrorå¼‚å¸¸æˆ‘ä»¬éƒ½æ˜¯ä¸€å †å‚æ•°ä¹±é…ï¼Œ<br>éƒ½æŠŠå€¼è°ƒå¤§ï¼Œåªæ˜¯å¤§ä½“çŸ¥é“æ˜¯è·Ÿjvmå†…å­˜åˆ†é…æœ‰å…³, å…·ä½“åº”è¯¥æ€ä¹ˆè°ƒï¼Œå¯¹åº”çš„å¼‚å¸¸åº”è¯¥è°ƒæ•´é‚£äº›å‚æ•°ï¼Œ<br>æˆ–è€…æ¢å¥è¯è¯´ï¼Œjvmå†…å­˜åˆ†é…åŒºåŸŸä¸­éƒ½åˆ†åˆ«å¯¹åº”é‚£äº›å‚æ•°å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä¸çŸ¥é“çš„ï¼Œåªæ˜¯æŠŠç›¸å…³çš„å‚æ•°è·³ä¸Šå»ï¼Œé¢„æœŸç»“æœéƒ½æ˜¯åº”è¯¥èµ·ä½œç”¨ï¼Œåˆ°åº•èƒ½ä¸èƒ½èµ·ä½œç”¨ï¼Œè‡ªå·±å¿ƒé‡Œä¹Ÿæ²¡åº•ã€‚<br>ä¸‹é¢å°±æ¥è¯´ä¸€ä¸‹jvmå †ã€æ ˆã€æ–¹æ³•åŒºç­‰å†…å­˜åŒºåŸŸå¯¹åº”çš„å‚æ•°ï¼ŒåŠæ¯ä¸ªåŒºåŸŸå¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå‘ç”Ÿå¼‚å¸¸çš„åœºæ™¯åˆ†æã€‚ </p></blockquote><h3 id="å‚æ•°ç±»å‹"><a href="#å‚æ•°ç±»å‹" class="headerlink" title="å‚æ•°ç±»å‹"></a>å‚æ•°ç±»å‹</h3><ul><li>å †ç©ºé—´å‚æ•°</li><li>æ ˆç©ºé—´å‚æ•°</li><li>æ–¹æ³•åŒºç©ºé—´å‚æ•°</li><li>æœ¬æœºç›´æ¥å†…å­˜å‚æ•°</li></ul><h3 id="å¼‚å¸¸ç±»å‹"><a href="#å¼‚å¸¸ç±»å‹" class="headerlink" title="å¼‚å¸¸ç±»å‹"></a>å¼‚å¸¸ç±»å‹</h3><ul><li>1.OutOfMemoryå¼‚å¸¸</li><li>2.StackOverflowErrorå¼‚å¸¸</li></ul><h3 id="è¾…åŠ©å‚æ•°è¯´æ˜"><a href="#è¾…åŠ©å‚æ•°è¯´æ˜" class="headerlink" title="è¾…åŠ©å‚æ•°è¯´æ˜"></a>è¾…åŠ©å‚æ•°è¯´æ˜</h3><ul><li>-XX:+HeapDumpOnOutOfMemoryError æ‰“å°å †å†…å­˜å¼‚å¸¸æ—¶æ‰“å°å‡ºå¿«ç…§ä¿¡æ¯</li><li>-XX:+HeapDumpPath å¿«ç…§è¾“å‡ºè·¯å¾„</li><li>-XmnæŒ‡å®šedenåŒºçš„å¤§å°</li><li>-XX:SurvirorRationæ¥è°ƒæ•´å¹¸å­˜åŒºçš„å¤§å°</li><li>-XX:PretenureSizeThresholdè®¾ç½®è¿›å…¥è€å¹´ä»£çš„é˜€å€¼</li></ul><h3 id="å‚æ•°è¯´æ˜ã€å¯¹åº”åœºæ™¯çš„å¼‚å¸¸"><a href="#å‚æ•°è¯´æ˜ã€å¯¹åº”åœºæ™¯çš„å¼‚å¸¸" class="headerlink" title="å‚æ•°è¯´æ˜ã€å¯¹åº”åœºæ™¯çš„å¼‚å¸¸"></a>å‚æ•°è¯´æ˜ã€å¯¹åº”åœºæ™¯çš„å¼‚å¸¸</h3><h4 id="å †å†…å­˜å‚æ•°"><a href="#å †å†…å­˜å‚æ•°" class="headerlink" title="å †å†…å­˜å‚æ•°"></a>å †å†…å­˜å‚æ•°</h4><p>-Xmsï¼šå †æœ€å°å€¼ï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹å’Œï¼‰</p><p>-Xmxï¼šå †æœ€å¤§å€¼ï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹å’Œï¼‰</p><p>å½“æœ€å°å€¼=æœ€å¤§å€¼æ—¶ï¼Œè¿™æ—¶å †å†…å­˜æ˜¯ä¸å¯æ‰©å±•çš„ã€‚</p><p>ä¾‹ï¼š-Xms80M -Xmx80M</p><p>é€šå¸¸å°†-Xmxå’Œ-Xmsè®¾ç½®ä¸ºä¸€æ ·çš„å¤§å°æ¥å‡å°‘gcçš„æ¬¡æ•°ï¼Œå †å†…å­˜ä¸è¶³æ—¶æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h4 id="æ ˆå†…å­˜å‚æ•°"><a href="#æ ˆå†…å­˜å‚æ•°" class="headerlink" title="æ ˆå†…å­˜å‚æ•°"></a>æ ˆå†…å­˜å‚æ•°</h4><p>-Xss</p><p>ä¾‹ï¼š-Xss128k</p><p>å•çº¿ç¨‹ä¸‹æ— è®ºæ ˆå¸§å¤ªå¤§è¿˜æ˜¯æ ˆå®¹é‡å¤ªå°ï¼ŒåŠå¼•ç”¨æ·±åº¦è¶…è¿‡è™šæ‹Ÿæœºå…è®¸æ·±åº¦éƒ½ä¼šæŠ›å‡ºStackOverflowErroræ¯ä¸ªæ–¹æ³•å‹å…¥æ ˆçš„å¸§å¤§å°æ˜¯ä¸ä¸€è‡´çš„ã€‚<br>å¤šçº¿ç¨‹ä¸‹å½“æ¯ä¸ªçº¿ç¨‹åˆ†é…æ ˆå¸§å¤ªå¤§å†…å­˜ä¸èƒ½å¤Ÿæ‰©å±•æ—¶æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸çº¿ç¨‹æ ˆå¸§è¶Šå¤§ï¼Œå¯åˆ›å»ºçš„çº¿ç¨‹è¶Šå°‘ã€‚</p><h4 id="æ–¹æ³•åŒºå‚æ•°"><a href="#æ–¹æ³•åŒºå‚æ•°" class="headerlink" title="æ–¹æ³•åŒºå‚æ•°"></a>æ–¹æ³•åŒºå‚æ•°</h4><p>-XX:PermSizeæ–¹æ³•åŒºå†…å­˜æœ€å°å€¼</p><p>-XX:MaxPermSize æ–¹æ³•åŒºå†…å­˜æœ€å¤§å€¼</p><p>å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œä¸»è¦ç”¨æ¥å­˜å‚¨ç±»çš„å…ƒæ•°æ®ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®</p><p>ä¾‹ï¼š-XX:PermSize=20M -XX:MaxPermSize=20M</p><p>å¼‚å¸¸ç±»å‹ OutOfMemoryError :</p><p>åŸå› ï¼šå¸¸é‡è¿‡å¤šï¼Œæˆ–ä»£ç†åå°„ç­‰ä½¿ç”¨é¢‘ç¹</p><h4 id="æœ¬æœºç›´æ¥å†…å­˜å‚æ•°"><a href="#æœ¬æœºç›´æ¥å†…å­˜å‚æ•°" class="headerlink" title="æœ¬æœºç›´æ¥å†…å­˜å‚æ•°"></a>æœ¬æœºç›´æ¥å†…å­˜å‚æ•°</h4><p>-XX:MaxDirectMemorySize</p><p>ä¾‹ï¼š-XX:MaxDirectMemorySize=10M</p><p>ä¸è¶³æ—¶æŠ›å‡ºOutOfMemoryå¼‚å¸¸</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM (å¯¹è±¡è®¿é—®å†…éƒ¨å®ç°è¿‡ç¨‹)</title>
      <link href="/blog/2018/08/19/e43d0ef1.html"/>
      <url>/blog/2018/08/19/e43d0ef1.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¯¹è±¡è®¿é—® æ¶‰åŠåˆ°å¯¹è±¡çš„åœ°å€å˜æ›´çŠ¶æ€å˜æ›´ï¼Œå†…å­˜åœ°å€ç§»åŠ¨ï¼Œå˜é‡ã€æ¥å£ã€å®ç°ç±»ã€æ–¹æ³•ã€çˆ¶ç±»å‹ç­‰ã€‚</p></blockquote><h3 id="å¥æŸ„æ–¹å¼-è®¿é—®"><a href="#å¥æŸ„æ–¹å¼-è®¿é—®" class="headerlink" title="å¥æŸ„æ–¹å¼ (è®¿é—®)"></a>å¥æŸ„æ–¹å¼ (è®¿é—®)</h3><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/jubing.png" alt="å¥æŸ„æ–¹å¼"></p><h3 id="æŒ‡é’ˆæ–¹å¼-è®¿é—®"><a href="#æŒ‡é’ˆæ–¹å¼-è®¿é—®" class="headerlink" title="æŒ‡é’ˆæ–¹å¼ (è®¿é—®)"></a>æŒ‡é’ˆæ–¹å¼ (è®¿é—®)</h3><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/zhizhen.png" alt="æŒ‡é’ˆæ–¹å¼"></p><h3 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p>å¥æŸ„è®¿é—®æ–¹å¼ï¼šreferenceä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„åœ°å€ï¼Œå¯¹è±¡å˜æ›´æ—¶åªä¼šæ”¹å˜å¥æŸ„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œå¼•ç”¨æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚</p><p>æŒ‡é’ˆè®¿é—®æ–¹å¼ï¼šä¼˜ç‚¹é€Ÿåº¦å¿«ï¼ŒèŠ‚çœäº†æŒ‡é’ˆå®šä½æ—¶é—´å¼€é”€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM (åƒåœ¾æ”¶é›†)</title>
      <link href="/blog/2018/08/19/99ebe472.html"/>
      <url>/blog/2018/08/19/99ebe472.html</url>
      
        <content type="html"><![CDATA[<h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h2><p>ç»å…¸çš„åƒåœ¾å›æ”¶ç®—æ³•ä»¥ä¸‹å‡ ç§ï¼š</p><h3 id="æ ‡è®°â€“æ¸…é™¤ç®—æ³•-Mark-Sweep"><a href="#æ ‡è®°â€“æ¸…é™¤ç®—æ³•-Mark-Sweep" class="headerlink" title="æ ‡è®°â€“æ¸…é™¤ç®—æ³•(Mark-Sweep)"></a>æ ‡è®°â€“æ¸…é™¤ç®—æ³•(Mark-Sweep)</h3><p>å›æ”¶å‰çŠ¶æ€ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/before.png" alt="å›æ”¶å‰"></p><p>å›æ”¶åçŠ¶æ€ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/before.png" alt="å›æ”¶å"></p><h4 id="ä¼˜ç¼ºç‚¹ï¼š"><a href="#ä¼˜ç¼ºç‚¹ï¼š" class="headerlink" title="ä¼˜ç¼ºç‚¹ï¼š"></a>ä¼˜ç¼ºç‚¹ï¼š</h4><p>ä¼˜ç‚¹ï¼šç®—æ³•æ‰§è¡Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µæ ‡è®°ä¸æ¸…é™¤ï¼Œæ‰€æœ‰çš„å›æ”¶ç®—æ³•ï¼ŒåŸºæœ¬éƒ½åŸºäºæ ‡è®°å›æ”¶ç®—æ³•åšäº†æ·±åº¦ä¼˜åŒ–</p><p>ç¼ºç‚¹ï¼šæ•ˆç‡é—®é¢˜ï¼Œå†…å­˜ç©ºé—´ç¢ç‰‡ï¼ˆä¸è¿ç»­çš„ç©ºé—´ï¼‰</p><h3 id="å¤åˆ¶ç®—æ³•-Copying"><a href="#å¤åˆ¶ç®—æ³•-Copying" class="headerlink" title="å¤åˆ¶ç®—æ³•(Copying)"></a>å¤åˆ¶ç®—æ³•(Copying)</h3><p>å›æ”¶å‰çŠ¶æ€ï¼š</p><p>Edenå†…å­˜ç©ºé—´ 8</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Eden8.png" alt="Edenå†…å­˜ç©ºé—´ 8"></p><p>Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Survivor1.png" alt="Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1"></p><p>Survivor2ç©ºé—´(Toç©ºé—´) 1</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Survivor2.png" alt="Survivor2ç©ºé—´(Toç©ºé—´) 1"></p><p>Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Eden_Survivor_8-1.png" alt="Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1"></p><p>å›æ”¶åçŠ¶æ€ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/aftergc.png" alt="å›æ”¶åçŠ¶æ€"></p><p>Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Survivor11.png" alt="Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1"></p><p>Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/EdenSurvivor8-1.png" alt="Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1"></p><h4 id="ä¼˜ç¼ºç‚¹ï¼š-1"><a href="#ä¼˜ç¼ºç‚¹ï¼š-1" class="headerlink" title="ä¼˜ç¼ºç‚¹ï¼š"></a>ä¼˜ç¼ºç‚¹ï¼š</h4><p>ä¼˜ç‚¹æ¯”è¾ƒæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œé¿å…äº†å›æ”¶é€ æˆçš„å†…å­˜ç¢ç‰‡é—®é¢˜</p><p>ç¼ºç‚¹ï¼šä»¥å±€éƒ¨çš„å†…å­˜ç©ºé—´ç‰ºç‰²ä¸ºä»£ä»·ï¼Œä¸è¿‡ç©ºé—´çš„æµªè´¹æ¯”è¾ƒå°ï¼Œé»˜è®¤8:1çš„æ¯”ä¾‹1æ˜¯æµªè´¹çš„ã€‚å¤åˆ¶ä¹Ÿæœ‰ä¸€å®šçš„æ•ˆç‡ä¸ç©ºé—´æˆæœ¬</p><h3 id="æ ‡è®°æ•´ç†ç®—æ³•-Mark-Compact"><a href="#æ ‡è®°æ•´ç†ç®—æ³•-Mark-Compact" class="headerlink" title="æ ‡è®°æ•´ç†ç®—æ³•(Mark-Compact)"></a>æ ‡è®°æ•´ç†ç®—æ³•(Mark-Compact)</h3><p>å›æ”¶å‰çŠ¶æ€ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/201808190401.png" alt="å›æ”¶å‰çŠ¶æ€"></p><p>å›æ”¶åçŠ¶æ€ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/201808190402.png" alt="å›æ”¶å‰çŠ¶æ€"></p><h4 id="ä¼˜ç¼ºç‚¹ï¼š-2"><a href="#ä¼˜ç¼ºç‚¹ï¼š-2" class="headerlink" title="ä¼˜ç¼ºç‚¹ï¼š"></a>ä¼˜ç¼ºç‚¹ï¼š</h4><p>ä¼˜ç‚¹ï¼šé¿å…äº†ï¼Œç©ºé—´çš„æµªè´¹ï¼Œä¸å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</p><p>ç¼ºç‚¹ï¼šæ•´ç†æ—¶å¤åˆ¶æœ‰æ•ˆç‡æˆæœ¬ã€‚<br>â€‹     </p><h2 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h2><h3 id="ä¸ƒç§åƒåœ¾æ”¶é›†å™¨"><a href="#ä¸ƒç§åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="ä¸ƒç§åƒåœ¾æ”¶é›†å™¨"></a>ä¸ƒç§åƒåœ¾æ”¶é›†å™¨</h3><ul><li>1ã€ Serialï¼ˆä¸²è¡ŒGCï¼‰-XX:+UseSerialGC</li><li>2ã€ ParNewï¼ˆå¹¶è¡ŒGCï¼‰-XX:+UseParNewGC</li><li>3ã€ Parallel Scavengeï¼ˆå¹¶è¡Œå›æ”¶GCï¼‰</li><li>4ã€ Serial Oldï¼ˆMSCï¼‰ï¼ˆä¸²è¡ŒGCï¼‰-XX:+UseSerialGC</li><li>5ã€ CMSï¼ˆå¹¶å‘GCï¼‰-XX:+UseConcMarkSweepGC</li><li>6ã€ Parallel Oldï¼ˆå¹¶è¡ŒGCï¼‰-XX:+UseParallelOldGC</li><li>7ã€ G1ï¼ˆJDK1.7update14æ‰å¯ä»¥æ­£å¼å•†ç”¨ï¼‰</li></ul><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/201808190403.png" alt="ä¸ƒç§åƒåœ¾æ”¶é›†å™¨"></p><h3 id="è°ƒä¼˜æ–¹æ³•"><a href="#è°ƒä¼˜æ–¹æ³•" class="headerlink" title="è°ƒä¼˜æ–¹æ³•"></a>è°ƒä¼˜æ–¹æ³•</h3><h4 id="æ–°å¯¹è±¡é¢„ç•™æ–°ç”Ÿä»£"><a href="#æ–°å¯¹è±¡é¢„ç•™æ–°ç”Ÿä»£" class="headerlink" title="æ–°å¯¹è±¡é¢„ç•™æ–°ç”Ÿä»£"></a>æ–°å¯¹è±¡é¢„ç•™æ–°ç”Ÿä»£</h4><p>ç”±äºfullGC(è€å¹´ä»£)çš„æˆæœ¬è¿œæ¯”minorGCï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼‰çš„æˆæœ¬å¤§ï¼Œæ‰€ä»¥ç»™åº”ç”¨åˆ†é…ä¸€ä¸ªåˆç†çš„æ–°ç”Ÿä»£ç©ºé—´ï¼Œå°½é‡å°†å¯¹è±¡åˆ†é…åˆ°æ–°ç”Ÿä»£å‡å°fullGCçš„é¢‘ç‡</p><h4 id="å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£"><a href="#å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£" class="headerlink" title="å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£"></a>å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£</h4><p>å°†å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼Œä¿æŒæ–°ç”Ÿä»£å¯¹è±¡çš„ç»“æ„çš„å®Œæ•´æ€§ï¼Œä»¥æé«˜GCæ•ˆç‡ï¼Œ ä»¥é€šè¿‡-XX:PretenureSizeThresholdè®¾ç½®è¿›å…¥è€å¹´ä»£çš„é˜€å€¼</p><h4 id="ç¨³å®šä¸éœ‡è¡çš„å †å¤§å°"><a href="#ç¨³å®šä¸éœ‡è¡çš„å †å¤§å°" class="headerlink" title="ç¨³å®šä¸éœ‡è¡çš„å †å¤§å°"></a>ç¨³å®šä¸éœ‡è¡çš„å †å¤§å°</h4><p>ç¨³å®šçš„å¯¹å¤§å°æ˜¯å¯¹åƒåœ¾å›æ”¶æœ‰åˆ©çš„ï¼Œæ–¹æ³•å°†-Xmså’Œ-Xmxçš„å¤§å°ä¸€è‡´</p><h4 id="ååé‡ä¼˜å…ˆ"><a href="#ååé‡ä¼˜å…ˆ" class="headerlink" title="ååé‡ä¼˜å…ˆ"></a>ååé‡ä¼˜å…ˆ</h4><p>å°½å¯èƒ½å‡å°‘ç³»ç»Ÿæ‰§è¡Œåƒåœ¾å›æ”¶çš„æ€»æ—¶é—´ï¼Œæ•…é‡‡ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-XX:+UseParallelGCæˆ–ä½¿ç”¨-XX:+UseParallelOldGC</span><br></pre></td></tr></table></figure><h4 id="é™ä½åœé¡¿"><a href="#é™ä½åœé¡¿" class="headerlink" title="é™ä½åœé¡¿"></a>é™ä½åœé¡¿</h4><p>ä½¿ç”¨CMSå›æ”¶å™¨,åŒæ—¶å‡å°‘fullGCçš„æ¬¡æ•°</p><h3 id="è·å–gcä¿¡æ¯çš„æ–¹æ³•"><a href="#è·å–gcä¿¡æ¯çš„æ–¹æ³•" class="headerlink" title="è·å–gcä¿¡æ¯çš„æ–¹æ³•"></a>è·å–gcä¿¡æ¯çš„æ–¹æ³•</h3><ul><li> <code>-verbose:gcæˆ–è€…-XX:+PrintGC</code>ã€€ã€€è·å–gcä¿¡æ¯</li><li> <code>-XX:+PrintGCDetails</code>ã€€ã€€è·å–æ›´åŠ è¯¦ç»†çš„gcä¿¡æ¯</li><li> <code>-XX:+PrintGCTimeStamps</code>ã€€ã€€è·å–GCçš„é¢‘ç‡å’Œé—´éš”</li><li> <code>-XX:+PrintHeapAtGC</code>ã€€ã€€è·å–å †çš„ä½¿ç”¨æƒ…å†µ</li><li> <code>-Xloggc:D:\gc.log</code>ã€€ã€€æŒ‡å®šæ—¥å¿—æƒ…å†µçš„ä¿å­˜è·¯å¾„</li></ul><h3 id="jvmè°ƒä¼˜å®æˆ˜-tomcatå¯åŠ¨åŠ é€Ÿ"><a href="#jvmè°ƒä¼˜å®æˆ˜-tomcatå¯åŠ¨åŠ é€Ÿ" class="headerlink" title="jvmè°ƒä¼˜å®æˆ˜-tomcatå¯åŠ¨åŠ é€Ÿ"></a>jvmè°ƒä¼˜å®æˆ˜-tomcatå¯åŠ¨åŠ é€Ÿ</h3><p>åœ¨tomcatçš„bin/catalina.batæ–‡ä»¶çš„å¼€å¤´æ·»åŠ ç›¸å…³çš„é…ç½®</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM (è™šæ‹Ÿæœºå†…å­˜)</title>
      <link href="/blog/2018/08/19/b8276f2d.html"/>
      <url>/blog/2018/08/19/b8276f2d.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>JAVAç¨‹åºè¿è¡Œä¸è™šæ‹Ÿæœºä¹‹ä¸Šï¼Œè¿è¡Œæ—¶éœ€è¦å†…å­˜ç©ºé—´ã€‚è™šæ‹Ÿæœºæ‰§è¡ŒJAVAç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºä¸åŒçš„æ•°æ®åŒºåŸŸæ–¹ä¾¿ç®¡ç†ã€‚</p></blockquote><p>è™šæ‹Ÿæœºç®¡ç†å†…å­˜æ•°æ®åŒºåŸŸåˆ’åˆ†å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://github.com/cayzlh/git-img-repository/raw/master/blog/Runtime-data-area.png" alt="è™šæ‹Ÿæœºç®¡ç†å†…å­˜æ•°æ®åŒºåŸŸåˆ’åˆ†"></p><h3 id="æ•°æ®åŒºåŸŸåˆ†ç±»"><a href="#æ•°æ®åŒºåŸŸåˆ†ç±»" class="headerlink" title="æ•°æ®åŒºåŸŸåˆ†ç±»:"></a>æ•°æ®åŒºåŸŸåˆ†ç±»:</h3><ul><li>æ–¹æ³•åŒºï¼š(Method Area)</li><li>è™šæ‹Ÿæœºæ ˆï¼š(VM Stack)</li><li>æœ¬åœ°æ–¹æ³•æ ˆ ï¼š(Native Method Stack)</li><li>å †ï¼š(Heap)</li><li>ç¨‹åºè®¡æ•°å™¨ ï¼š(Program Counter Register)</li><li>ç›´æ¥å†…å­˜ï¼š(Direct Memory)</li></ul><p>è¯´æ˜ï¼š</p><h4 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h4><p>è¡Œå·æŒ‡ç¤ºå™¨ï¼Œå­—èŠ‚ç æŒ‡ä»¤çš„åˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤(CPUåˆ‡æ¢)ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ï¼Œçº¿ç¨‹ç§æœ‰å†…å­˜äº’ä¸å½±å“,è¯¥åŒºåŸŸä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</p><h4 id="è™šæ‹Ÿæœºæ ˆ"><a href="#è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="è™šæ‹Ÿæœºæ ˆ"></a>è™šæ‹Ÿæœºæ ˆ</h4><p>æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå£°æ˜å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œè™šæ‹Ÿæœºæ ˆæ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œå³æ–¹æ³•è¿è¡ŒæœŸé—´çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚<br>æ ˆå¸§ç”¨äºå­˜å‚¨ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ï¼Œæ¯ä¸ªæ–¹æ³•æ‰§è¡Œä¸­éƒ½å¯¹åº”è™šæ‹Ÿæœºæ ˆå¸§ä»å…¥æ ˆåˆ°å¤„æ ˆçš„è¿‡ç¨‹ã€‚</p><p>æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯è™šæ‹Ÿæœºä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼Œå¯¹åº”ç‰©ç†å±‚ä¹‹ä¸Šçš„ç¨‹åºæ•°æ®æ¨¡å‹ã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ï¼Œæ˜¯ä¸€ç§ç¨‹åºè¿è¡Œæ•°æ®æ¨¡å‹ï¼Œå­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»å‹ä¾‹å¦‚ï¼š</p><p>Booleanã€byteã€charã€shortã€intã€floatã€longã€doubleã€å¯¹è±¡å¼•ç”¨ç±»å‹(å¯¹è±¡å†…å­˜åœ°å€å˜é‡ï¼ŒæŒ‡é’ˆæˆ–å¥æŸ„)ã€‚<br>ç¨‹åºè¿è¡Œæ—¶ï¼Œæ ¹æ®å±€éƒ¨å˜é‡è¡¨åˆ†é…æ ˆå¸§ç©ºé—´å¤§å°ï¼Œåœ¨è¿è¡Œä¸­ï¼Œå¤§å°æ˜¯ä¸å˜çš„å¼‚å¸¸ç±»å‹ï¼šstackOverFlowError çº¿ç¨‹è¯·æ±‚æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºå…è®¸æ·±åº¦ OutOfMemory å†…å­˜ç©ºé—´è€—å°½æ— æ³•è¿›è¡Œæ‰©å±•ã€‚</p><h4 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h4><p>ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œè™šæ‹Ÿæœºæ ˆä¸ºJavaç¨‹åºæœåŠ¡ï¼Œæœ¬åœ°æ–¹æ³•æ ˆæ”¯æŒè™šæ‹Ÿæœºçš„è¿è¡ŒæœåŠ¡ï¼Œå…·ä½“å®ç°ç”±è™šæ‹Ÿæœºå‚å•†å†³å®šï¼Œä¹Ÿä¼šæŠ›å‡º stackOverFlowErrorã€OutOfMemoryå¼‚å¸¸ã€‚</p><h4 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h4><p>æ˜¯è™šæ‹Ÿæœºç®¡ç†å†…å­˜ä¸­æœ€å¤§çš„ä¸€éƒ¨åˆ†ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹(å¯¹è±¡ã€æ•°ç»„)ï¼Œç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç”±äºGCæ”¶é›†å™¨ï¼Œåˆ†ä»£æ”¶é›†ã€‚<br>æ‰€ä»¥åˆ’åˆ†ä¸ºï¼šæ–°ç”Ÿä»£ Edenã€From SurVivorç©ºé—´ã€To SurVivorç©ºé—´ï¼Œallot buffer(åˆ†é…ç©ºé—´)ï¼Œå¯èƒ½ä¼šåˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼Œè€å¹´ä»£ã€‚</p><h4 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h4><p>ä¸å †ä¸€æ ·å±äºçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ï¼ˆåŠ¨æ€åŠ è½½OSGIï¼‰ç­‰æ•°æ®ã€‚ç†è®ºä¸Šå±äºjavaè™šæ‹Ÿæœºçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†åŒºåˆ†å¼€æ¥å«åš Non-Heapéå †ã€‚</p><p>è¿™ä¸ªåŒºåŸŸå¯ä»¥é€‰æ‹©ä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¯¥åŒºåŸŸå›æ”¶ç›®çš„ä¸»è¦æ˜¯å¸¸é‡æ± çš„å›æ”¶ï¼ŒåŠç±»å‹çš„å¸è½½class,å†…å­˜åŒºä¸è¶³æ—¶ä¼šæŠ›å‡ºOutOfMemoryå¼‚å¸¸</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼š</p><p>æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼ŒClassçš„ç‰ˆæœ¬ã€å­—æ®µã€æ¥å£ã€æ–¹æ³•ç­‰ï¼ŒåŠç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ã€ç¬¦å·å¼•ç”¨ï¼Œç¼–è¯‘ç±»åŠ è½½åå­˜æ”¾åœ¨è¯¥åŒºåŸŸã€‚ä¼šæŠ›å‡ºOutOfMemoryå¼‚å¸¸ã€‚</p><h4 id="ç›´æ¥å†…å­˜"><a href="#ç›´æ¥å†…å­˜" class="headerlink" title="ç›´æ¥å†…å­˜"></a>ç›´æ¥å†…å­˜</h4><p>ç›´æ¥å†…å­˜ä¸å±äºè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œæ˜¯ä¸€ç§åŸºäºé€šé“ä¸ç¼“å†²åŒºçš„IOæ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°å‡½æ•°ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œåœ¨å †ä¸­å­˜å‚¨å¼•ç”¨çš„å¤–éƒ¨å†…å­˜åœ°å€ï¼Œé€šè¿‡å¼•ç”¨å®Œæˆå¯¹ç›´æ¥å¼•ç”¨å†…å­˜çš„æ“ä½œã€‚<br>1.4ä¹‹åæä¾›çš„NIOæ˜¾è‘—æé«˜æ•ˆç‡ï¼Œé¿å…äº†å †å†…å­˜ä¸Nativeå†…å­˜çš„æ¥å›å¤åˆ¶æ“ä½œï¼Œä¸å—è™šæ‹Ÿæœºå†…å­˜æ§åˆ¶ï¼Œä¼šæŠ›å‡ºOUtOfMemoryå¼‚å¸¸ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
