{"pages":[{"title":"æ–‡ç« åˆ†ç±»","date":"2021-02-20T15:30:20.536Z","path":"categories/index.html","text":""},{"title":"404","date":"2020-10-16T07:19:35.000Z","path":"/404.html","text":"404 Page Not Found | CAYZLH"},{"title":"æ–‡ç« æ ‡ç­¾","date":"2021-02-20T15:30:20.546Z","path":"tags/index.html","text":""},{"title":"Search","date":"2021-02-19T10:27:47.000Z","path":"search/index.html","text":""},{"title":"Tools","date":"2021-02-19T14:13:05.000Z","path":"tools/index.html","text":"å®ç”¨çš„åœ¨çº¿å·¥å…· Jsonåœ¨çº¿å·¥å…· Markdownåœ¨çº¿è½¬æ¢å·¥å…· åœ¨çº¿HASHå·¥å…·"}],"posts":[{"title":"SpringBootå•å…ƒæµ‹è¯•","date":"2021-03-12T06:02:10.000Z","path":"2021/03/12/1832342668.html","text":"ä¸€ã€ å•å…ƒæµ‹è¯•çš„æ¦‚å¿µæ¦‚å¿µï¼š å•å…ƒæµ‹è¯•ï¼ˆunit testingï¼‰ï¼Œæ˜¯æŒ‡å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ã€‚åœ¨Javaä¸­å•å…ƒæµ‹è¯•çš„æœ€å°å•å…ƒæ˜¯ç±»ã€‚ å•å…ƒæµ‹è¯•æ˜¯å¼€å‘è€…ç¼–å†™çš„ä¸€å°æ®µä»£ç ï¼Œç”¨äºæ£€éªŒè¢«æµ‹ä»£ç çš„ä¸€ä¸ªå¾ˆå°çš„ã€å¾ˆæ˜ç¡®çš„åŠŸèƒ½æ˜¯å¦æ­£ç¡®ã€‚æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå°±æ˜¯ä¸ºäº†è¯æ˜è¿™ æ®µä»£ç çš„è¡Œä¸ºå’Œæˆ‘ä»¬æœŸæœ›æ˜¯å¦ä¸€è‡´ã€‚ å•å…ƒæµ‹è¯•å¼•ç”¨ï¼š ä¼—æ‰€å‘¨çŸ¥ï¼Œé€šè¿‡spring initializeåˆ›å»ºçš„Spring Booté¡¹ç›®ä¼šåœ¨Mavenä¸­è‡ªåŠ¨æºå¸¦å¾ˆå¤šstarterä¾èµ–ï¼š å…¶ä¸­åŒ…å«äº†ä¸€ä¸ªåä¸ºspring-boot-starter-testçš„ä¾èµ–ï¼Œæœ¬æ–‡æ˜¯å›´ç»•è¿™ä¸ªä¾èµ–å±•å¼€ã€‚ Spring Bootä¸­å¼•å…¥å•å…ƒæµ‹è¯•å¾ˆç®€å•ï¼Œæ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼ˆå³spring-boot-starter-testä¾èµ–ï¼‰ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt; &lt;scope&gt;test&lt;&#x2F;scope&gt;&lt;&#x2F;dependency&gt; spring-boot-starter-testæœ‰å¦‚ä¸‹å‡ ä¸ªåº“ï¼š spring-boot-starter-testUMLå›¾ï¼š äºŒã€å•å…ƒæµ‹è¯•çš„ä½œç”¨åœ¨æ²¡æœ‰æ¥è§¦å•å…ƒæµ‹è¯•ä¹‹å‰æˆ‘ä»¬æ˜¯æ€ä¹ˆåšæµ‹è¯•çš„ï¼Ÿä¸€èˆ¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š åœ¨æ—¶é—´å…è®¸çš„æƒ…å†µä¸‹ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ˜¯ç¨‹åºå‘˜å¯¹ä»£ç çš„è‡ªæµ‹ï¼Œè¿™æ˜¯å¯¹è‡ªå·±ä»£ç çš„è´Ÿè´£ã€‚ å†™å•å…ƒæµ‹è¯•çš„ä¸¤ä¸ªåŠ¨æœºï¼š ä¿è¯æˆ–éªŒè¯å®ç°åŠŸèƒ½ã€‚ ä¿æŠ¤å·²ç»å®ç°çš„åŠŸèƒ½ä¸è¢«ç ´åã€‚ ä¸‰ã€Spring Bootå¼•å…¥çš„MockMvcçš„æ¦‚å¿µ ä»€ä¹ˆæ˜¯Mock? åœ¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œæ¨¡æ‹Ÿå¯¹è±¡ï¼ˆè‹±è¯­ï¼šmock objectï¼‰æ˜¯ä»¥å¯æ§çš„æ–¹å¼æ¨¡æ‹ŸçœŸå®å¯¹è±¡è¡Œä¸ºçš„å‡å¯¹è±¡ã€‚åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸é€šè¿‡æ¨¡æ‹Ÿä¸€äº›è¾“å…¥æ•°æ®ï¼Œæ¥éªŒè¯ç¨‹åºæ˜¯å¦è¾¾åˆ°é¢„æœŸç»“æœã€‚ ä¸ºä»€ä¹ˆä½¿ç”¨Mockå¯¹è±¡ï¼Ÿ ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤æ‚çš„ã€çœŸå®çš„å¯¹è±¡è¡Œä¸ºã€‚å¦‚æœåœ¨å•å…ƒæµ‹è¯•ä¸­æ— æ³•ä½¿ç”¨çœŸå®å¯¹è±¡ï¼Œå¯é‡‡ç”¨æ¨¡æ‹Ÿå¯¹è±¡è¿›è¡Œæ›¿ä»£ã€‚ MockMvcçš„æ¦‚å¿µ MockMvcæ˜¯ç”±spring-teståŒ…æä¾›ï¼Œå®ç°äº†å¯¹Httpè¯·æ±‚çš„æ¨¡æ‹Ÿï¼Œèƒ½å¤Ÿç›´æ¥ä½¿ç”¨ç½‘ç»œçš„å½¢å¼ï¼Œè½¬æ¢åˆ°Controllerçš„è°ƒç”¨ï¼Œä½¿å¾—æµ‹è¯•é€Ÿåº¦å¿«ã€ä¸ä¾èµ–ç½‘ç»œç¯å¢ƒã€‚åŒæ—¶æä¾›äº†ä¸€å¥—éªŒè¯çš„å·¥å…·ï¼Œç»“æœçš„éªŒè¯ååˆ†æ–¹ä¾¿ã€‚ æ¥å£MockMvcBuilderï¼Œæä¾›ä¸€ä¸ªå”¯ä¸€çš„buildæ–¹æ³•ï¼Œç”¨æ¥æ„é€ MockMvcã€‚ä¸»è¦æœ‰ä¸¤ä¸ªå®ç°ï¼šStandaloneMockMvcBuilderå’ŒDefaultMockMvcBuilderã€‚ MockMVCçš„åŸºæœ¬æ­¥éª¤ (1) mockMvc.performæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ã€‚(2) MockMvcRequestBuilders.get(â€œXXXâ€)æ„é€ ä¸€ä¸ªè¯·æ±‚ã€‚(3) ResultActions.paramæ·»åŠ è¯·æ±‚ä¼ å€¼ (4) ResultActions.accept()è®¾ç½®è¿”å›ç±»å‹ (5) ResultActions.andExpectæ·»åŠ æ‰§è¡Œå®Œæˆåçš„æ–­è¨€ã€‚(6) ResultActions.andDoæ·»åŠ ä¸€ä¸ªç»“æœå¤„ç†å™¨ï¼Œè¡¨ç¤ºè¦å¯¹ç»“æœåšç‚¹ä»€ä¹ˆäº‹æƒ…ï¼Œæ¯”å¦‚å¤„ä½¿ç”¨print()è¾“å‡ºæ•´ä¸ªå“åº”ç»“æœä¿¡æ¯ã€‚(7) ResultActions.andReturnè¡¨ç¤ºæ‰§è¡Œå®Œæˆåè¿”å›ç›¸åº”çš„ç»“æœã€‚ å››ã€Serviceå±‚çš„å•å…ƒæµ‹è¯•ç¬¬ä¸€æ­¥ï¼š Spring Bootä¸­å•å…ƒæµ‹è¯•ç±»å†™åœ¨src/test/javaç›®å½•ä¸‹ï¼Œä½ å¯ä»¥æ‰‹åŠ¨åˆ›å»ºå…·ä½“æµ‹è¯•ç±»ï¼Œä¹Ÿå¯ä»¥é€šè¿‡IDEAè‡ªåŠ¨åˆ›å»ºæµ‹è¯•ç±»ï¼Œå¦‚ä¸‹å›¾ï¼šï¼ˆæ³¨ï¼šç‚¹é€‰å¹¶æ‰“å¼€ç›¸åº”ä»£ç ç•Œé¢ï¼Œå†ç‚¹å‡»èœå•æ çš„Navigateï¼‰ ç¬¬äºŒæ­¥ï¼š æŒ‰ç…§ç¬¬ä¸€æ­¥çš„æ–¹æ³•ï¼Œç‚¹å‡»æµ‹è¯•åï¼Œå‡ºç°å›¾ä¸€ çš„å¯¹è¯æ¡†ï¼ˆå¦‚æœæƒ³è¦æµ‹è¯•çš„ç±»å·²ç»å­˜åœ¨æµ‹è¯•ç±»äº†ä¼šè¢«åˆ—å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•ç±»ï¼‰ï¼Œç‚¹å‡»â€Create New Testâ€¦â€ä¼šå¼¹å‡ºå›¾äºŒ çš„å¯¹è¯æ¡†ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ç”ŸæˆsetUpä»¥åŠè¦æµ‹è¯•çš„æˆå‘˜æ–¹æ³•ç­‰ï¼š å›¾ä¸€ å›¾äºŒ ç¬¬ä¸‰æ­¥ï¼š è‡³æ­¤Serviceå±‚çš„æµ‹è¯•ç±»å°±åˆ›å»ºå¥½äº†ï¼Œæµ‹è¯•ç±»è‡ªåŠ¨ç”Ÿæˆåˆ°äº†src/test/javaç›®å½•ä¸‹é¡¹ç›®çš„åŒçº§ç›®å½•ä¸­ ï¼Œå¦‚ä¸‹å›¾ï¼š Serviceå±‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š @SpringBootTest@RunWith(SpringRunner.class)public class XXXServiceTest &#123;@Resourceprivate XXXService XXXService;@Testpublic void conflictTime() &#123; DateTimeFormatter dtf &#x3D; DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;); LocalDate start &#x3D; LocalDate.parse(&quot;2020-10-26&quot;, dtf); LocalDate end &#x3D; LocalDate.parse(&quot;2020-10-31&quot;, dtf); Integer integer &#x3D; XXXService.ConflictTime(&quot;10000001&quot;, start, end); Assert.assertThat(integer, Matchers.notNullValue());&#x2F;&#x2F;assertThatæ–­è¨€åé¢ä»‹ç» &#125;&#125; æ³¨è§£è§£é‡Šï¼š @SpringBootTestï¼šè·å–å¯åŠ¨ç±»ï¼ŒåŠ è½½é…ç½®ï¼Œå¯»æ‰¾ä¸»é…ç½®å¯åŠ¨ç±»ï¼ˆè¢« @SpringBootApplication æ³¨è§£çš„ï¼‰ @RunWith(SpringRunner.class)ï¼šè®©JUnitè¿è¡ŒSpringçš„æµ‹è¯•ç¯å¢ƒ,è·å¾—Springç¯å¢ƒçš„ä¸Šä¸‹æ–‡çš„æ”¯æŒ äº”ã€Controllerå±‚çš„å•å…ƒæµ‹è¯•åˆ›å»ºæµ‹è¯•ç±»æ­¥éª¤è§ç¬¬å››éƒ¨åˆ†ï¼Œæ­¤å¤„ç•¥ã€‚ ç¬¬å››éƒ¨åˆ†åªæ˜¯é’ˆå¯¹Serviceå±‚åšäº†æµ‹è¯•ï¼Œä½†æ˜¯å’±ä¹ˆä¹Ÿéœ€è¦å¯¹Controllerå±‚ï¼ˆAPIï¼‰åšæµ‹è¯•ï¼Œè¿™æ—¶å€™å°±ç”¨åˆ°MockMvcäº†ï¼Œå®ƒä½¿å¾—ä½ æ— éœ€å¯åŠ¨é¡¹ç›®å·¥ç¨‹å°±èƒ½æµ‹è¯•è¿™äº›æ¥å£ MockMvcå®ç°äº†å¯¹Httpè¯·æ±‚çš„æ¨¡æ‹Ÿï¼Œèƒ½å¤Ÿç›´æ¥ä½¿ç”¨ç½‘ç»œçš„å½¢å¼ï¼Œè½¬æ¢åˆ°Controllerçš„è°ƒç”¨ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æµ‹è¯•é€Ÿåº¦å¿«ã€ä¸ä¾èµ–ç½‘ç»œç¯å¢ƒï¼Œè€Œä¸”æä¾›äº†ä¸€å¥—éªŒè¯çš„å·¥å…·ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—è¯·æ±‚çš„éªŒè¯ç»Ÿä¸€è€Œä¸”å¾ˆæ–¹ä¾¿ã€‚ Controllerå±‚éƒ¨åˆ†çš„ä»£ç å°†åˆ†ä¸ºä¸‰ä¸ªä»£ç å—è®²è§£ï¼Œé‡Œé¢æœ‰çœ‹ä¸æ‡‚çš„ä»£ç å…ˆä¸è¦ç€æ€¥å“¦ğŸ˜„ï¼Œä¼šåœ¨ç¬¬äº”éƒ¨åˆ†ç»“å°¾å¤„ç»™å¤§å®¶æ±‡æ€»è§£ç­”çš„ï¼Œå¤§å®¶è¦åšæŒçœ‹åˆ°æœ€åå“Ÿï¼ğŸ˜ ä»£ç å—ä¸€ï¼š @SpringBootTest@RunWith(SpringRunner.class)@AutoConfigureMockMvcpublic class DfTaskRecordControllerTest &#123;@Autowiredprivate MockMvc mockMvc;@Beforepublic void setUp() throws Exception &#123; System.out.println(&quot;---------------start---------------&quot;); save();get(); System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;); &#125; æ³¨è§£è§£é‡Šï¼š @SpringBootTest&gt;ï¼šè·å–å¯åŠ¨ç±»ï¼ŒåŠ è½½é…ç½®ï¼Œå¯»æ‰¾ä¸»é…ç½®å¯åŠ¨ç±»ï¼ˆè¢« @SpringBootApplication æ³¨è§£çš„ï¼‰ @RunWith(SpringRunner.class)&gt;ï¼šè®©JUnitè¿è¡ŒSpringçš„æµ‹è¯•ç¯å¢ƒ,è·å¾—Springç¯å¢ƒçš„ä¸Šä¸‹æ–‡çš„æ”¯æŒ @AutoConfigureMockMvcï¼šç”¨äºè‡ªåŠ¨é…ç½®MockMvc,é…ç½®åMockMvcç±»å¯ä»¥ç›´æ¥æ³¨å…¥,ç›¸å½“äºnew MockMvc @Before:åˆå§‹åŒ–æ–¹æ³• ,å¯¹äºæ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•éƒ½è¦æ‰§è¡Œä¸€æ¬¡ ä»£ç å—äºŒï¼š @Test@Transactional@Rollback()public void save() throws Exception &#123; String json&quot;&#123;â€¦â€¦&#125;&quot;;&#x2F;&#x2F;æ‰§è¡Œä¸€ä¸ªRequestBuilderè¯·æ±‚ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒSpringMVCçš„æµç¨‹å¹¶æ˜ å°„åˆ°ç›¸åº”çš„æ§åˆ¶å™¨æ‰§è¡Œå¤„ç†ï¼› mockMvc.perform(MockMvcRequestBuilders .post(&quot;&#x2F;XXX&#x2F;save&quot;) .content(json.getBytes()) &#x2F;&#x2F;ä¼ jsonå‚æ•° .accept(MediaType.APPLICATION_JSON) .contentType(MediaType.APPLICATION_JSON_VALUE) .header(&quot;Authorization&quot;,&quot;Bearer ********-****-****-****-************&quot;) ) .andExpect(MockMvcResultMatchers.status().isOk()) .andDo(print()); &#125; æ³¨è§£è§£é‡Šï¼š @Transactional:å¼€å¯äº‹åŠ¡åŠŸèƒ½ @Rollback(): äº‹åŠ¡å›æ»š,é»˜è®¤æ˜¯true ä»£ç å—ä¸‰ï¼š @Testpublic void get() throws Exception&#123; ResultActions resultActions &#x3D; mockMvc.perform(MockMvcRequestBuilders .get(&quot;&#x2F;XXX&#x2F;get&quot;) .param(&quot;id&quot;, &quot;**********&quot;) .header(&quot;Authorization&quot;, &quot;Bearer ********-****-****-****-************&quot;) ); resultActions.andReturn().getResponse().setCharacterEncoding(&quot;UTF-8&quot;); resultActions.andExpect(MockMvcResultMatchers.status().isOk()).andDo(print()); &#125;&#125; /getè¿è¡Œç»“æœå¦‚ä¸‹ï¼š ç°åœ¨å°†ä¸Šé¢çš„ä¸€äº›çç¢çš„çŸ¥è¯†ç‚¹æ±‡æ€»ä¸€ä¸‹ï¼š 1. mockMvc.performï¼šæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ 2. MockMvcRequestBuilders.get(â€œ/XXX/getâ€)ï¼šæ„é€ ä¸€ä¸ªè¯·æ±‚ï¼ŒPostè¯·æ±‚ä½¿ç”¨.postæ–¹æ³• 3. contentType(MediaType.APPLICATION_JSON_VALUE)ï¼šä»£è¡¨å‘é€ç«¯å‘é€çš„æ•°æ®æ ¼å¼æ˜¯application/json;charset=UTF-8 4. accept(MediaType.APPLICATION_JSON)ï¼šä»£è¡¨å®¢æˆ·ç«¯å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹ä¸ºapplication/json;charset=UTF-8 5. header(â€œAuthorizationâ€,â€œBearer XXXXâ€)ï¼šä»£è¡¨åœ¨æŠ¥æ–‡å¤´æ·»åŠ ä¸€äº›å¿…é¡»çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯token 6. ResultActions.andExpectï¼šæ·»åŠ æ‰§è¡Œå®Œæˆåçš„æ–­è¨€ 7. ResultActions.andExpect(MockMvcResultMatchers.status().isOk())ï¼šæ–¹æ³•çœ‹è¯·æ±‚çš„çŠ¶æ€å“åº”ç æ˜¯å¦ä¸º200å¦‚æœä¸æ˜¯åˆ™æŠ›å¼‚å¸¸ï¼Œæµ‹è¯•ä¸é€šè¿‡ 8. ResultActions.andDoï¼šæ·»åŠ ä¸€ä¸ªç»“æœå¤„ç†å™¨ï¼Œè¡¨ç¤ºè¦å¯¹ç»“æœåšç‚¹ä»€ä¹ˆäº‹æƒ…ï¼Œæ¯”å¦‚æ­¤å¤„ä½¿ç”¨print()ï¼šè¾“å‡ºæ•´ä¸ªå“åº”ç»“æœä¿¡æ¯ å…­ã€æ–­è¨€çš„æ¦‚å¿µ æ–­è¨€ï¼ˆassertï¼‰ï¼Œæ˜¯ç¼–ç¨‹æœ¯è¯­ï¼Œè¡¨ç¤ºä¸ºä¸€äº›å¸ƒå°”è¡¨è¾¾å¼ï¼Œç¨‹åºå‘˜ç›¸ä¿¡åœ¨ç¨‹åºä¸­çš„æŸä¸ªç‰¹å®šç‚¹è¯¥è¡¨è¾¾å¼å€¼ä¸ºçœŸã€‚å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å¯ç”¨å’Œç¦ç”¨æ–­è¨€éªŒè¯ï¼Œå› æ­¤å¯ä»¥åœ¨æµ‹è¯•æ—¶å¯ç”¨æ–­è¨€è€Œåœ¨éƒ¨ç½²æ—¶ç¦ç”¨æ–­è¨€ã€‚ ä½¿ç”¨æ–­è¨€æ˜¯åˆ¤æ–­ä¸€ä¸ªå‡½æ•°æˆ–å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•æ‰€äº§ç”Ÿçš„ç»“æœæ˜¯å¦ç¬¦åˆä½ æœŸæœ›é‚£ä¸ªç»“æœã€‚ ä¸ƒã€æ–°æ–­è¨€assertThatä½¿ç”¨JUnit 4.4 ç»“åˆ Hamcrest æä¾›äº†ä¸€ä¸ªå…¨æ–°çš„æ–­è¨€è¯­æ³•â€”â€”assertThatã€‚ç¨‹åºå‘˜å¯ä»¥åªä½¿ç”¨ assertThat ä¸€ä¸ªæ–­è¨€è¯­å¥ï¼Œç»“åˆ Hamcrest æä¾›çš„åŒ¹é…ç¬¦ï¼Œå°±å¯ä»¥è¡¨è¾¾å…¨éƒ¨çš„æµ‹è¯•æ€æƒ³ã€‚ assertThat çš„ä¼˜ç‚¹ï¼š ä¼˜ç‚¹ 1ï¼š ä»¥å‰ JUnit æä¾›äº†å¾ˆå¤šçš„ assertion è¯­å¥ï¼Œå¦‚ï¼šassertEqualsï¼ŒassertNotSameï¼ŒassertFalseï¼ŒassertTrueï¼ŒassertNotNullï¼ŒassertNull ç­‰ï¼Œç°åœ¨æœ‰äº† JUnit 4.4ï¼Œä¸€æ¡ assertThat å³å¯ä»¥æ›¿ä»£æ‰€æœ‰çš„ assertion è¯­å¥ï¼Œè¿™æ ·å¯ä»¥åœ¨æ‰€æœ‰çš„å•å…ƒæµ‹è¯•ä¸­åªä½¿ç”¨ä¸€ä¸ªæ–­è¨€æ–¹æ³•ï¼Œä½¿å¾—ç¼–å†™æµ‹è¯•ç”¨ä¾‹å˜å¾—ç®€å•ï¼Œä»£ç é£æ ¼å˜å¾—ç»Ÿä¸€ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚ ä¼˜ç‚¹ 2ï¼š assertThat ä½¿ç”¨äº† Hamcrest çš„ Matcher åŒ¹é…ç¬¦ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨åŒ¹é…ç¬¦è§„å®šçš„åŒ¹é…å‡†åˆ™ç²¾ç¡®çš„æŒ‡å®šä¸€äº›æƒ³è®¾å®šæ»¡è¶³çš„æ¡ä»¶ï¼Œå…·æœ‰å¾ˆå¼ºçš„æ˜“è¯»æ€§ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»ã€‚ ä¼˜ç‚¹ 3ï¼š assertThat ä¸å†åƒ assertEquals é‚£æ ·ï¼Œä½¿ç”¨æ¯”è¾ƒéš¾æ‡‚çš„â€œè°“å®¾ä¸»â€è¯­æ³•æ¨¡å¼ï¼ˆå¦‚ï¼šassertEquals(3, x);ï¼‰ï¼Œç›¸åï¼ŒassertThat ä½¿ç”¨äº†ç±»ä¼¼äºâ€œä¸»è°“å®¾â€çš„æ˜“è¯»è¯­æ³•æ¨¡å¼ï¼ˆå¦‚ï¼šassertThat(x,is(3));ï¼‰ï¼Œä½¿å¾—ä»£ç æ›´åŠ ç›´è§‚ã€æ˜“è¯»ã€‚ assertThat çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š assertThat( [value], [matcher statement] ); value ï¼šæ¥ä¸‹æ¥æƒ³è¦æµ‹è¯•çš„å˜é‡å€¼ï¼›matcher statement ï¼šä½¿ç”¨ Hamcrest åŒ¹é…ç¬¦æ¥è¡¨è¾¾çš„å¯¹å‰é¢å˜é‡æ‰€æœŸæœ›çš„å€¼çš„å£°æ˜ï¼Œå¦‚æœ value å€¼ä¸ matcher statement æ‰€è¡¨è¾¾çš„æœŸæœ›å€¼ç›¸ç¬¦ï¼Œåˆ™æµ‹è¯•æˆåŠŸï¼Œå¦åˆ™æµ‹è¯•å¤±è´¥ã€‚ å…«ã€Postmanä¸Spring Boot å•å…ƒæµ‹è¯•çš„åŒºåˆ« Spring Bootçš„å•å…ƒæµ‹è¯•ä¸»è¦é’ˆå¯¹æ–¹æ³•å±‚é¢ï¼Œå¯ä»¥æµ‹è¯•Serviceå±‚è¿™ç±»éå¯¹å¤–æš´éœ²çš„æ¥å£çš„ç±»ä¸­æ–¹æ³•ï¼Œå¹¶ä¸”å¯ä¸€æ¬¡æ€§æ‰¹é‡æµ‹è¯•å¤šä¸ªæ–¹æ³•ã€æ”¯æŒäº‹åŠ¡å›æ»šã€‚ Postmané’ˆå¯¹æ¥å£è¿›è¡Œhttpæµ‹è¯•ï¼Œæˆ‘å¹³æ—¶è¿™ä¸ªæ¯”è¾ƒå¤šï¼Œåˆ›å»ºçš„æµ‹è¯•æ¥å£å¯ä¿å­˜ã€åˆ†ç±»ã€‚ ä¹ã€PostmanåŸºæœ¬ç”¨æ³•Postmanæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ç½‘é¡µè°ƒè¯•ä¸å‘é€ç½‘é¡µHTTPè¯·æ±‚çš„å·¥å…·ã€‚Postmanèƒ½å¤Ÿå‘é€ä»»ä½•ç±»å‹çš„HTTPè¯·æ±‚(GET, HEAD, POST,PUT..)ï¼Œé™„å¸¦ä»»ä½•æ•°é‡çš„å‚æ•°å’ŒHTTP headersã€‚æ”¯æŒä¸åŒçš„è®¤è¯æœºåˆ¶ï¼ˆbasic, digest,OAuthï¼‰ï¼Œæ¥æ”¶åˆ°çš„å“åº”è¯­æ³•é«˜äº®ï¼ˆHTMLï¼ŒJSONæˆ–XMLï¼‰ã€‚ å®‰è£…Postman å®˜æ–¹ç½‘ç«™ï¼š https://www.getpostman.com/apps å®‰è£…åï¼ŒPostmanæ˜¯ä»‹æ ·å©¶å„¿æ»´~~ğŸ˜Š","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"}]},{"title":"ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹-åŸºç¡€å…¥é—¨","date":"2021-01-05T07:40:41.000Z","path":"2021/01/05/d2d07489.html","text":"Elasticsearch æ˜¯ä¸€ä¸ªå®æ—¶çš„åˆ†å¸ƒå¼æœç´¢åˆ†æå¼•æ“ï¼Œå®ƒèƒ½è®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å’Œè§„æ¨¡ï¼Œå»æ¢ç´¢ä½ çš„æ•°æ®ã€‚ å®ƒè¢«ç”¨ä½œå…¨æ–‡æ£€ç´¢ã€ç»“æ„åŒ–æœç´¢ã€åˆ†æä»¥åŠè¿™ä¸‰ä¸ªåŠŸèƒ½çš„ç»„åˆã€‚ Elasticsearch ä¸­æ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶æ˜¯å…¨æ–°çš„æˆ–è€…æ˜¯é©å‘½æ€§çš„ã€‚å…¨æ–‡æœç´¢å¾ˆä¹…ä¹‹å‰å°±å·²ç»å¯ä»¥åšåˆ°äº†ï¼Œ å°±åƒå¾ˆæ—©ä¹‹å‰å‡ºç°çš„åˆ†æç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ã€‚ é©å‘½æ€§çš„æˆæœåœ¨äºå°†è¿™äº›å•ç‹¬çš„ï¼Œæœ‰ç”¨çš„ç»„ä»¶èåˆåˆ°ä¸€ä¸ªå•ä¸€çš„ã€ä¸€è‡´çš„ã€å®æ—¶çš„åº”ç”¨ä¸­ã€‚ Elasticsearchæ˜¯ä»€ä¹ˆElasticsearch æ˜¯ä¸€ä¸ªå¼€æºçš„æœç´¢å¼•æ“ï¼Œå»ºç«‹åœ¨ä¸€ä¸ªå…¨æ–‡æœç´¢å¼•æ“åº“ Apache Luceneâ„¢ åŸºç¡€ä¹‹ä¸Šã€‚ Lucene å¯ä»¥è¯´æ˜¯å½“ä¸‹æœ€å…ˆè¿›ã€é«˜æ€§èƒ½ã€å…¨åŠŸèƒ½çš„æœç´¢å¼•æ“åº“â€”æ— è®ºæ˜¯å¼€æºè¿˜æ˜¯ç§æœ‰ã€‚ ä½†æ˜¯ Lucene ä»…ä»…åªæ˜¯ä¸€ä¸ªåº“ã€‚ä¸ºäº†å……åˆ†å‘æŒ¥å…¶åŠŸèƒ½ï¼Œä½ éœ€è¦ä½¿ç”¨ Java å¹¶å°† Lucene ç›´æ¥é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚ æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ‚¨å¯èƒ½éœ€è¦è·å¾—ä¿¡æ¯æ£€ç´¢å­¦ä½æ‰èƒ½äº†è§£å…¶å·¥ä½œåŸç†ã€‚Lucene éå¸¸ å¤æ‚ã€‚ Elasticsearch ä¹Ÿæ˜¯ä½¿ç”¨ Java ç¼–å†™çš„ï¼Œå®ƒçš„å†…éƒ¨ä½¿ç”¨ Lucene åšç´¢å¼•ä¸æœç´¢ï¼Œä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯ä½¿å…¨æ–‡æ£€ç´¢å˜å¾—ç®€å•ï¼Œ é€šè¿‡éšè— Lucene çš„å¤æ‚æ€§ï¼Œå–è€Œä»£ä¹‹çš„æä¾›ä¸€å¥—ç®€å•ä¸€è‡´çš„ RESTful APIã€‚ ç„¶è€Œï¼ŒElasticsearch ä¸ä»…ä»…æ˜¯ Luceneï¼Œå¹¶ä¸”ä¹Ÿä¸ä»…ä»…åªæ˜¯ä¸€ä¸ªå…¨æ–‡æœç´¢å¼•æ“ã€‚ å®ƒå¯ä»¥è¢«ä¸‹é¢è¿™æ ·å‡†ç¡®çš„å½¢å®¹ï¼š ä¸€ä¸ªåˆ†å¸ƒå¼çš„å®æ—¶æ–‡æ¡£å­˜å‚¨ï¼Œæ¯ä¸ªå­—æ®µ å¯ä»¥è¢«ç´¢å¼•ä¸æœç´¢ ä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶åˆ†ææœç´¢å¼•æ“ èƒ½èƒœä»»ä¸Šç™¾ä¸ªæœåŠ¡èŠ‚ç‚¹çš„æ‰©å±•ï¼Œå¹¶æ”¯æŒ PB çº§åˆ«çš„ç»“æ„åŒ–æˆ–è€…éç»“æ„åŒ–æ•°æ® Elasticsearch å°†æ‰€æœ‰çš„åŠŸèƒ½æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„æœåŠ¡ï¼Œè¿™æ ·ä½ å¯ä»¥é€šè¿‡ç¨‹åºä¸å®ƒæä¾›çš„ç®€å•çš„ RESTful API è¿›è¡Œé€šä¿¡ï¼Œ å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€å……å½“ web å®¢æˆ·ç«¯ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œï¼ˆå»å……å½“è¿™ä¸ªå®¢æˆ·ç«¯ï¼‰ã€‚ å®‰è£…å¹¶è¿è¡ŒElasticsearch1ã€å®‰è£…æ­¥éª¤å‚è€ƒDockeréƒ¨ç½²elasticsearchã€‚ 2ã€éªŒè¯æ˜¯å¦è¿è¡ŒæˆåŠŸï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š curl &#x27;http://localhost:9200/?pretty&#x27; å¾—åˆ°ä¸‹é¢ç±»ä¼¼çš„å“åº”åˆ™æˆåŠŸï¼š &#123; &quot;name&quot; : &quot;72Hw8Z7&quot;, &quot;cluster_name&quot; : &quot;elasticsearch&quot;, &quot;cluster_uuid&quot; : &quot;qjNWdKc2TtePsX9apDnatw&quot;, &quot;version&quot; : &#123; &quot;number&quot; : &quot;5.6.12&quot;, &quot;build_hash&quot; : &quot;cfe3d9f&quot;, &quot;build_date&quot; : &quot;2018-09-10T20:12:43.732Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;6.6.1&quot; &#125;, &quot;tagline&quot; : &quot;You Know, for Search&quot;&#125; è¿™å°±æ„å‘³ç€ä½ ç°åœ¨å·²ç»å¯åŠ¨å¹¶è¿è¡Œä¸€ä¸ª Elasticsearch èŠ‚ç‚¹äº†ï¼Œä½ å¯ä»¥ç”¨å®ƒåšå®éªŒäº†ã€‚ å•ä¸ª èŠ‚ç‚¹ å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿è¡Œä¸­çš„ Elasticsearch çš„å®ä¾‹ã€‚ è€Œä¸€ä¸ª é›†ç¾¤ æ˜¯ä¸€ç»„æ‹¥æœ‰ç›¸åŒ cluster.name çš„èŠ‚ç‚¹ï¼Œ ä»–ä»¬èƒ½ä¸€èµ·å·¥ä½œå¹¶å…±äº«æ•°æ®ï¼Œè¿˜æä¾›å®¹é”™ä¸å¯ä¼¸ç¼©æ€§ã€‚(å½“ç„¶ï¼Œä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤) ä½ å¯ä»¥åœ¨ elasticsearch.yml é…ç½®æ–‡ä»¶ä¸­ ä¿®æ”¹ cluster.name ï¼Œè¯¥æ–‡ä»¶ä¼šåœ¨èŠ‚ç‚¹å¯åŠ¨æ—¶åŠ è½½ (è¯‘è€…æ³¨ï¼šè¿™ä¸ªé‡å¯æœåŠ¡åæ‰ä¼šç”Ÿæ•ˆ)ã€‚ ä¸Elasticsearchäº¤äº’é›†ç¾¤å†…çš„åŸç†æ•°æ®è¾“å…¥å’Œè¾“å‡ºåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·æ˜ å°„ä¸åˆ†æè¯·æ±‚ä½“æŸ¥è¯¢æ’åºä¸ç›¸å…³æ€§æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢ç´¢å¼•ç®¡ç†åˆ†ç‰‡å†…éƒ¨ç®¡ç†","tags":[],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹","slug":"ä¹¦ç±/ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AElasticsearch%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/"}]},{"title":"æ ¸å¿ƒå¤„ç†å±‚-SqlNode&SqlSource","date":"2020-08-21T08:43:42.000Z","path":"2020/08/21/bebe404d.html","text":"æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†MyBatisçš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»MyBatisçš„åˆå§‹åŒ–ã€åŠ¨æ€SQLè¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠSQLè¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æMyBatisçš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£MyBatisçš„æ ¸å¿ƒåŸç†ã€‚ æœ¬ç¯‡ä»‹ç»SqINode&amp;SqISource æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„SQLèŠ‚ç‚¹ä¼šè¢«è§£ææˆMappedStatementå¯¹è±¡ï¼Œå…¶ä¸­çš„SQLè¯­å¥ä¼šè¢«è§£ææˆSqlSourceå¯¹è±¡ï¼ŒSQLè¯­å¥ä¸­å®šä¹‰çš„åŠ¨æ€SQLèŠ‚ç‚¹ã€æ–‡æœ¬èŠ‚ç‚¹ç­‰ï¼Œåˆ™ç”±SqlNodeæ¥å£çš„ç›¸åº”å®ç°è¡¨ç¤ºã€‚ SqlSourceæ¥å£çš„å®šä¹‰ï¼š public interface SqlSource &#123; BoundSql getBoundSql(Object parameterObject);&#125; SqlSourceæ¥å£çš„å®ç°ç±»å›¾ï¼š DynamicSqlSourceè´Ÿè´£å¤„ç†åŠ¨æ€SQLè¯­å¥ï¼ŒRawSqlSourceè´Ÿè´£å¤„ç†é™æ€è¯­å¥ï¼Œä¸¤è€…æœ€ç»ˆéƒ½ä¼šå°†å¤„ç†åçš„SQLè¯­å¥å°è£…æˆStaticSqlSourceè¿”å›ã€‚ DynamicSqlSourceä¸StaticSqlSourceçš„ä¸»è¦åŒºåˆ«ï¼š StaticSqlSourceä¸­è®°å½•çš„SQLè¯­å¥ä¸­å¯èƒ½å«æœ‰?å ä½ç¬¦ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥æäº¤ç»™æ•°æ®åº“æ‰§è¡Œ DynamicSqlSourceä¸­å°è£…çš„SQLè¯­å¥è¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—è§£æï¼Œæ‰ä¼šæœ€ç»ˆå½¢æˆæ•°æ®åº“å¯æ‰§è¡Œçš„SQLè¯­å¥ ç»„åˆæ¨¡å¼ç»„åˆæ¨¡å¼æ˜¯å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ï¼Œä»¥è¡¨ç¤ºéƒ¨åˆ†-æ•´ä½“çš„å±‚æ¬¡ç»“æ„(ä¸€èˆ¬æ˜¯æ ‘å½¢ç»“æ„)ï¼Œç”¨æˆ·å¯ä»¥åƒå¤„ç†ä¸€ä¸ªç®€å•å¯¹è±¡ä¸€æ ·æ¥å¤„ç†ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œä»è€Œä½¿å¾—è°ƒç”¨è€…æ— é¡»äº†è§£å¤æ‚å…ƒç´ çš„å†…éƒ¨ç»“æ„ã€‚ ç»„åˆæ¨¡å¼ä¸­çš„å„æ¨¡å¼å¦‚ä¸‹ï¼š æŠ½è±¡ç»„ä»¶(Component) Componentæ¥å£å®šä¹‰äº†æ ‘å½¢ç»“æ„ä¸­æ‰€æœ‰ç±»çš„å…¬å…±è¡Œä¸ºï¼Œä¾‹å¦‚è¿™é‡Œçš„operation()æ–¹æ³•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…¶ä¸­è¿˜ä¼šå®šä¹‰ä¸€äº›ç”¨äºç®¡ç†å­ç»„ä»¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¿™é‡Œçš„add()ã€remove()ã€getChild()æ–¹æ³•ã€‚ æ ‘å¶(Leaf) Leafåœ¨æ ‘å½¢ç»“æ„ä¸­è¡¨ç¤ºå¶èŠ‚ç‚¹å¯¹è±¡ï¼Œå¶èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ã€‚ æ ‘æ(Composite) å®šä¹‰æœ‰å­ç»„ä»¶çš„é‚£äº›ç»„ä»¶çš„è¡Œä¸ºã€‚è¯¥è§’è‰²ç”¨äºç®¡ç†å­ç»„ä»¶ï¼Œå¹¶é€šè¿‡operation()æ–¹æ³•è°ƒç”¨å…¶ç®¡ç†çš„å­ç»„ä»¶çš„ç›¸å…³æ“ä½œã€‚ è°ƒç”¨è€…(Client) é€šè¿‡Componentæ¥å£æ“çºµæ•´ä¸ªæ ‘å½¢ç»“æ„ã€‚ ç»„åˆæ¨¡å¼ä¸»è¦æœ‰ä¸¤ç‚¹å¥½å¤„ï¼Œé¦–å…ˆç»„åˆæ¨¡å¼å¯ä»¥å¸®åŠ©è°ƒç”¨è€…å±è”½å¯¹è±¡çš„å¤æ‚æ€§ã€‚ å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œä½¿ç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸ä½¿ç”¨å•ä¸ªComponentå¯¹è±¡æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨è€…å¹¶ä¸å¿…å…³å¿ƒè‡ªå·±å¤„ç†çš„æ˜¯å•ä¸ªComponentå¯¹è±¡è¿˜æ˜¯æ•´ä¸ªæ ‘å½¢ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥å°†è°ƒç”¨è€…ä¸å¤æ‚å¯¹è±¡è¿›è¡Œè§£è€¦ã€‚ å¦å¤–ï¼Œä½¿ç”¨äº†ç»„åˆæ¨¡å¼ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ æ ‘ä¸­èŠ‚ç‚¹çš„æ–¹å¼ï¼Œæ·»åŠ æ–°çš„Componentå¯¹è±¡ï¼Œä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ï¼Œè¿™ç¬¦åˆå¼€æ”¾-å°é—­åŸåˆ™ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–æ—¥åçš„ç»´æŠ¤å·¥ä½œã€‚ ç»„åˆæ¨¡å¼åœ¨å¸¦æ¥ä¸Šè¿°å¥½å¤„çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¼•å…¥ä¸€äº›é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œæœ‰äº›åœºæ™¯ä¸‹ç¨‹åºå¸Œæœ›ä¸€ä¸ªç»„åˆç»“æ„ä¸­åªèƒ½æœ‰æŸäº›ç‰¹å®šçš„ç»„ä»¶ï¼Œæ­¤æ—¶å°±å¾ˆéš¾ç›´æ¥é€šè¿‡ç»„ä»¶ç±»å‹è¿›è¡Œé™åˆ¶(å› ä¸ºéƒ½æ˜¯Componentæ¥å£çš„å®ç°ç±»)ï¼Œè¿™å°±å¿…é¡»åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æµ‹ã€‚è€Œä¸”ï¼Œåœ¨é€’å½’ç¨‹åºä¸­å®šä½é—®é¢˜ä¹Ÿæ˜¯ä¸€ä»¶æ¯”è¾ƒå¤æ‚çš„äº‹æƒ…ã€‚ MyBatisåœ¨å¤„ç†åŠ¨æ€SQLèŠ‚ç‚¹æ—¶ï¼Œåº”ç”¨åˆ°äº†ç»„åˆè®¾è®¡æ¨¡å¼ã€‚MyBatisä¼šå°†åŠ¨æ€SQLèŠ‚ç‚¹è§£ææˆå¯¹åº”çš„SqlNodeå®ç°ï¼Œå¹¶å½¢æˆæ ‘å½¢ç»“æ„ã€‚ OGNLè¡¨è¾¾å¼OGNL(Object Graphic Navigation Languageï¼Œå¯¹è±¡å›¾å¯¼èˆªè¯­è¨€)è¡¨è¾¾å¼åœ¨Strutsã€MyBatisç­‰å¼€æºé¡¹ç›®ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå…¶ä¸­Strutsæ¡†æ¶æ›´æ˜¯å°†OGNLä½œä¸ºé»˜è®¤çš„è¡¨è¾¾å¼è¯­è¨€ã€‚ åœ¨MyBatisä¸­æ¶‰åŠçš„OGNLè¡¨è¾¾å¼çš„åŠŸèƒ½ä¸»è¦æ˜¯ï¼šå­˜å–Javaå¯¹è±¡æ ‘ä¸­çš„å±æ€§ã€è°ƒç”¨Javaå¯¹è±¡æ ‘ä¸­çš„æ–¹æ³•ç­‰ã€‚ OGNLä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼š è¡¨è¾¾å¼ OGNLè¡¨è¾¾å¼æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ ¹æ®è¡¨è¾¾å¼è§£æå¾—åˆ°çš„ã€‚ ä¾‹å¦‚ï¼š å¯¹è±¡å.æ–¹æ³•åè¡¨ç¤ºè°ƒç”¨æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³• @[ç±»çš„å®Œå…¨é™å®šå]@[é™æ€æ–¹æ³•æˆ–é™æ€å­—æ®µ]è¡¨ç¤ºè°ƒç”¨æŒ‡å®šç±»çš„é™æ€æ–¹æ³•æˆ–è®¿é—®é™æ€å­—æ®µ OGNLè¡¨è¾¾å¼è¿˜å¯ä»¥å®Œæˆå˜é‡èµ‹å€¼ã€æ“ä½œé›†åˆç­‰æ“ä½œã€‚ rootå¯¹è±¡ OGNLè¡¨è¾¾å¼æŒ‡å®šäº†å…·ä½“çš„æ“ä½œï¼Œè€Œrootå¯¹è±¡æŒ‡å®šäº†éœ€è¦æ“ä½œçš„å¯¹è±¡ã€‚ OgnlContextï¼ˆä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰ OgnlContextç±»ç»§æ‰¿äº†Mapæ¥å£ï¼ŒOgnlContextå¯¹è±¡è¯´ç™½äº†ä¹Ÿå°±æ˜¯ä¸€ä¸ªMapå¯¹è±¡ã€‚ æ—¢ç„¶å¦‚æ­¤ï¼ŒOgnIContextå¯¹è±¡ä¸­å°±å¯ä»¥å­˜æ”¾é™¤rootå¯¹è±¡ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡ã€‚ åœ¨ä½¿ç”¨OGNLè¡¨è¾¾å¼æ“ä½œérootå¯¹è±¡æ—¶ï¼Œéœ€è¦ä½¿ç”¨#å‰ç¼€ï¼Œè€Œæ“ä½œrootå¯¹è±¡åˆ™ä¸éœ€è¦ä½¿ç”¨#å‰ç¼€ã€‚ åœ¨MyBatisä¸­ï¼Œä½¿ç”¨OgnlCacheå¯¹åŸç”Ÿçš„OGNLè¿›è¡Œäº†å°è£…ã€‚OGNLè¡¨è¾¾å¼çš„è§£æè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼ŒOgnlCacheä¸­ä½¿ç”¨expressionCacheå­—æ®µ(é™æ€æˆå‘˜ï¼ŒConcurrentHashMap&lt;String,Object&gt;ç±»å‹)å¯¹è§£æåçš„OGNLè¡¨è¾¾å¼è¿›è¡Œç¼“å­˜ã€‚ private static final Map&lt;String, Object&gt; expressionCache = new ConcurrentHashMap&lt;String, Object&gt;();public static Object getValue(String expression, Object root) &#123; try &#123; Map&lt;Object, OgnlClassResolver&gt; context = Ognl.createDefaultContext(root, new OgnlClassResolver()); return Ognl.getValue(parseExpression(expression), context, root); &#125; catch (OgnlException e) &#123; throw new BuilderException(&quot;Error evaluating expression &#x27;&quot; + expression + &quot;&#x27;. Cause: &quot; + e, e); &#125;&#125;private static Object parseExpression(String expression) throws OgnlException &#123; Object node = expressionCache.get(expression); if (node == null) &#123; node = Ognl.parseExpression(expression); expressionCache.put(expression, node); &#125; return node;&#125; DynamicContextDynamicContextä¸»è¦ç”¨äºè®°å½•è§£æåŠ¨æ€SQLè¯­å¥ä¹‹åäº§ç”Ÿçš„SQLè¯­å¥ç‰‡æ®µï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç”¨äºè®°å½•åŠ¨æ€SQLè¯­å¥è§£æç»“æœçš„å®¹å™¨ã€‚ å…¶ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒå­—æ®µï¼š // å‚æ•°ä¸Šä¸‹æ–‡private final ContextMap bindings;// åœ¨SqlNodeè§£æåŠ¨æ€sqlçš„æ—¶å€™ï¼Œä¼šå°†è§£æåçš„sqlè¯­å¥ç‰‡æ®µæ·»åŠ åˆ°è¯¥å±æ€§ä¸­ä¿å­˜ï¼Œæœ€ç»ˆæ‹¼å‡‘å‡ºä¸€æ¡å®Œæ•´çš„sqlè¯­å¥private final StringBuilder sqlBuilder = new StringBuilder(); ContextMapæ˜¯DynamicContextä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†HashMapå¹¶é‡å†™äº†get()æ–¹æ³•ã€‚ static class ContextMap extends HashMap&lt;String, Object&gt; &#123; private static final long serialVersionUID = 2977601501966151582L; // å°†ç”¨æˆ·ä¼ çš„å‚æ•°å°è£…æˆMetaObjectå¯¹è±¡ private MetaObject parameterMetaObject; public ContextMap(MetaObject parameterMetaObject) &#123; this.parameterMetaObject = parameterMetaObject; &#125; @Override public Object get(Object key) &#123; String strKey = (String) key; if (super.containsKey(strKey)) &#123; return super.get(strKey); &#125; if (parameterMetaObject != null) &#123; // issue #61 do not modify the context when reading return parameterMetaObject.getValue(strKey); &#125; return null; &#125;&#125; DynamicContextçš„æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–bindingsé›†åˆï¼Œæ³¨æ„æ„é€ æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°pammeterObjectï¼Œå®ƒæ˜¯è¿è¡Œæ—¶ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ï¼Œå…¶ä¸­åŒ…å«äº†åç»­ç”¨äºæ›¿æ¢#&#123;&#125;å ä½ç¬¦çš„å®å‚ã€‚ public DynamicContext(Configuration configuration, Object parameterObject) &#123; if (parameterObject != null &amp;&amp; !(parameterObject instanceof Map)) &#123; // å¯¹äºä¸æ˜¯Mapç±»å‹çš„å‚æ•°ï¼Œä¼šåˆ›è£…MetaObjectå¯¹è±¡ï¼Œå¹¶å°è£…æˆContextMapå¯¹è±¡ MetaObject metaObject = configuration.newMetaObject(parameterObject); bindings = new ContextMap(metaObject); &#125; else &#123; bindings = new ContextMap(null); &#125; bindings.put(PARAMETER_OBJECT_KEY, parameterObject); bindings.put(DATABASE_ID_KEY, configuration.getDatabaseId());&#125; SqlNodeæ¥ä¸‹æ¥çœ‹çœ‹SqlNodeçš„å®ç°ç±»æ˜¯å¦‚ä½•è§£æå…¶å¯¹åº”çš„SQLèŠ‚ç‚¹ã€‚ public interface SqlNode &#123; // apply()æ˜¯SqlNodeæ¥å£ä¸­å®šä¹‰çš„å”¯ä¸€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å®å‚ï¼Œå‚æ•°è§£æè¯¥SqlNodeæ‰€ // è®°å½•çš„åŠ¨æ€SQLèŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨DynamicContext.appendSql()æ–¹æ³•å°†è§£æåçš„SQLç‰‡æ®µè¿½åŠ åˆ° // DynamicContext.sqlBuilderä¸­ä¿å­˜ // å½“SQLèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰SqlNodeå®Œæˆè§£æåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»DynamicContextä¸­è·å–ä¸€æ¡åŠ¨æ€ç”Ÿæˆçš„ã€ // å®Œæ•´çš„SQLè¯­å¥ boolean apply(DynamicContext context);&#125; SqlNodeæ¥å£æœ‰å¤šä¸ªå®ç°ç±»ï¼Œæ¯ä¸ªå®ç°ç±»å¯¹åº”ä¸€ä¸ªåŠ¨æ€SQLèŠ‚ç‚¹ã€‚æŒ‰ç…§ç»„åˆæ¨¡å¼çš„è§’è‰²æ¥åˆ’åˆ†ï¼ŒSqlNodeæ‰®æ¼”äº†æŠ½è±¡ç»„ä»¶çš„è§’è‰²ï¼ŒMixedSqlNodeæ‰®æ¼”äº†æ ‘æèŠ‚ç‚¹çš„è§’è‰²ï¼ŒTextSqlNodeèŠ‚ç‚¹æ‰®æ¼”äº†æ ‘å¶èŠ‚ç‚¹çš„è§’è‰²ç­‰ç­‰ã€‚ 1ã€StaticTextSqINode&amp;MixedSqINode StaticTextSqINodeä¸­ä½¿ç”¨textå­—æ®µ(Stringç±»å‹)è®°å½•äº†å¯¹åº”çš„éåŠ¨æ€SQLè¯­å¥èŠ‚ç‚¹ï¼Œå…¶apply()æ–¹æ³•ç›´æ¥å°†textå­—æ®µè¿½åŠ åˆ°DynamicContext.sqlBuilderå­—æ®µä¸­ã€‚ MixedSqINodeä¸­ä½¿ç”¨contentså­—æ®µ(List&lt;SqlNode&gt;ç±»å‹)è®°å½•å…¶å­èŠ‚ç‚¹å¯¹åº”çš„SqlNodeå¯¹è±¡é›†åˆï¼Œå…¶apply()æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨contentsé›†åˆä¸­æ‰€æœ‰SqlNodeå¯¹è±¡çš„apply()æ–¹æ³•ã€‚ 2ã€TextSqlNode TextSqlNodeè¡¨ç¤ºçš„æ˜¯åŒ…å«å ä½ç¬¦çš„åŠ¨æ€SQLèŠ‚ç‚¹ã€‚TextSqlNode.apply()æ–¹æ³•ä¼šä½¿ç”¨GenericTokenParserè§£æ$&#123;&#125;å ä½ç¬¦ï¼Œå¹¶ç›´æ¥æ›¿æ¢æˆç”¨æˆ·ç»™å®šçš„å®é™…å‚æ•°å€¼ã€‚ @Overridepublic boolean apply(DynamicContext context) &#123; // åˆ›å»ºGenericTokenParserè§£æå™¨ï¼Œ GenericTokenParser parser = createParser(new BindingTokenParser(context, injectionFilter)); // å°†è§£æåçš„SQLç‰‡æ®µæ·»åŠ åˆ°DynamicContextä¸­ context.appendSql(parser.parse(text)); return true;&#125;private GenericTokenParser createParser(TokenHandler handler) &#123; return new GenericTokenParser(&quot;$&#123;&quot;, &quot;&#125;&quot;, handler);&#125; **BindingTokenParser**æ˜¯TextSqlNodeä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿äº†TokenHandleræ¥å£ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®DynamicContext.bindingsé›†åˆä¸­çš„ä¿¡æ¯è§£æSQLè¯­å¥èŠ‚ç‚¹ä¸­çš„$&#123;&#125;å ä½ç¬¦ã€‚BindingTokenParser.contextå­—æ®µæŒ‡å‘äº†å¯¹åº”çš„DynamicContextå¯¹è±¡ã€‚ private static class BindingTokenParser implements TokenHandler &#123; private DynamicContext context; private Pattern injectionFilter; public BindingTokenParser(DynamicContext context, Pattern injectionFilter) &#123; this.context = context; this.injectionFilter = injectionFilter; &#125; @Override public String handleToken(String content) &#123; Object parameter = context.getBindings().get(&quot;_parameter&quot;); if (parameter == null) &#123; context.getBindings().put(&quot;value&quot;, null); &#125; else if (SimpleTypeRegistry.isSimpleType(parameter.getClass())) &#123; context.getBindings().put(&quot;value&quot;, parameter); &#125; Object value = OgnlCache.getValue(content, context.getBindings()); String srtValue = (value == null ? &quot;&quot; : String.valueOf(value)); // issue #274 return &quot;&quot; instead of &quot;null&quot; checkInjection(srtValue); return srtValue; &#125; private void checkInjection(String value) &#123; if (injectionFilter != null &amp;&amp; !injectionFilter.matcher(value).matches()) &#123; throw new ScriptingException(&quot;Invalid input. Please conform to regex&quot; + injectionFilter.pattern()); &#125; &#125;&#125; 3ã€IfSqlNode IfSqlNodeå¯¹åº”çš„åŠ¨æ€SQLèŠ‚ç‚¹æ˜¯&lt;if&gt;èŠ‚ç‚¹ï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªæ ¸å¿ƒå­—æ®µã€‚ // ç”¨äºè§£æifèŠ‚ç‚¹çš„testè¡¨è¾¾å¼çš„å€¼private final ExpressionEvaluator evaluator;// è®°å½•äº†testè¡¨è¾¾å¼private final String test;// è®°å½•å­èŠ‚ç‚¹private final SqlNode contents; IfSqlNode.apply()æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡ExpressionEvaluator.evaluateBoolean()æ–¹æ³•æ£€æµ‹å…¶testè¡¨è¾¾å¼æ˜¯å¦ä¸ºtrueï¼Œç„¶åæ ¹æ®testè¡¨è¾¾å¼çš„ç»“æœï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œå…¶å­èŠ‚ç‚¹çš„apply()æ–¹æ³•ã€‚ @Overridepublic boolean apply(DynamicContext context) &#123; if (evaluator.evaluateBoolean(test, context.getBindings())) &#123; contents.apply(context); return true; &#125; return false;&#125;public boolean evaluateBoolean(String expression, Object parameterObject) &#123; Object value = OgnlCache.getValue(expression, parameterObject); if (value instanceof Boolean) &#123; return (Boolean) value; &#125; if (value instanceof Number) &#123; return new BigDecimal(String.valueOf(value)).compareTo(BigDecimal.ZERO) != 0; &#125; return value != null;&#125; 4ã€TrimSqINode&amp;WhereSqINode&amp;SetSqINode TrimSqlNodeä¼šæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœï¼Œæ·»åŠ æˆ–åˆ é™¤ç›¸åº”çš„å‰ç¼€æˆ–åç¼€ã€‚å…¶ä¸­å‡ ä¸ªå­—æ®µå¦‚ä¸‹ï¼š // è®°å½•å­èŠ‚ç‚¹private final SqlNode contents;// SQLè¯­å¥æ·»åŠ çš„å‰ç¼€private final String prefix;// SQLè¯­å¥æ·»åŠ çš„åç¼€private final String suffix;// private final List&lt;String&gt; prefixesToOverride;private final List&lt;String&gt; suffixesToOverride; åœ¨TrimSqlNodeçš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨parseOverrides()æ–¹æ³•å¯¹å‚æ•°prefixesToOverride(å¯¹åº”&lt;trim&gt;èŠ‚ç‚¹çš„prefixOverrideså±æ€§)å’Œå‚æ•°suffixesToOverride(å¯¹åº”&lt;trim&gt;èŠ‚ç‚¹çš„suffixOverrideså±æ€§)è¿›è¡Œè§£æï¼Œå¹¶åˆå§‹åŒ–prefixesToOverrideå’ŒsufflxesToOverrideã€‚ private static List&lt;String&gt; parseOverrides(String overrides) &#123; if (overrides != null) &#123; final StringTokenizer parser = new StringTokenizer(overrides, &quot;|&quot;, false); final List&lt;String&gt; list = new ArrayList&lt;String&gt;(parser.countTokens()); while (parser.hasMoreTokens()) &#123; list.add(parser.nextToken().toUpperCase(Locale.ENGLISH)); &#125; return list; &#125; return Collections.emptyList();&#125; TrimSqlNode.apply()æ–¹æ³•é¦–å…ˆè§£æå­èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœå¤„ç†å‰ç¼€å’Œåç¼€ã€‚ public boolean apply(DynamicContext context) &#123; // åˆ›å»ºFilteredDynamicContextå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†DynamicContext FilteredDynamicContext filteredDynamicContext = new FilteredDynamicContext(context); // è°ƒç”¨å­èŠ‚ç‚¹çš„applyæ–¹æ³•è¿›è¡Œè§£æ boolean result = contents.apply(filteredDynamicContext); // å¤„ç†å‰ç¼€å’Œåç¼€ filteredDynamicContext.applyAll(); return result;&#125; å¤„ç†å‰ç¼€å’Œåç¼€çš„ä¸»è¦é€»è¾‘æ˜¯åœ¨FilteredDynamicContextä¸­å®ç°çš„ï¼Œå®ƒç»§æ‰¿äº†DynamicContextï¼ŒåŒæ—¶ä¹Ÿæ˜¯DynamicContextçš„ä»£ç†ç±»ã€‚ FilteredDynamicContexté™¤äº†å°†å¯¹åº”æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™å…¶ä¸­å°è£…çš„DynamicContextå¯¹è±¡ï¼Œè¿˜æä¾›äº†å¤„ç†å‰ç¼€å’Œåç¼€çš„applyAll()æ–¹æ³•ã€‚ private class FilteredDynamicContext extends DynamicContext &#123; // åº•å±‚å°è£…çš„DynamicContextå¯¹è±¡ private DynamicContext delegate; // æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€å’Œåç¼€ private boolean prefixApplied; private boolean suffixApplied; // è®°å½•å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœ private StringBuilder sqlBuffer; // ... // ... public void applyAll() &#123; // è·å–å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœï¼Œå¹¶å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ sqlBuffer = new StringBuilder(sqlBuffer.toString().trim()); String trimmedUppercaseSql = sqlBuffer.toString().toUpperCase(Locale.ENGLISH); if (trimmedUppercaseSql.length() &gt; 0) &#123; applyPrefix(sqlBuffer, trimmedUppercaseSql);// å¤„ç†å‰ç¼€ applySuffix(sqlBuffer, trimmedUppercaseSql);// å¤„ç†åç¼€ &#125; delegate.appendSql(sqlBuffer.toString()); &#125; // ... // ... // å¤„ç†å‰ç¼€ private void applyPrefix(StringBuilder sql, String trimmedUppercaseSql) &#123; if (!prefixApplied) &#123; prefixApplied = true; if (prefixesToOverride != null) &#123; for (String toRemove : prefixesToOverride) &#123; if (trimmedUppercaseSql.startsWith(toRemove)) &#123; sql.delete(0, toRemove.trim().length()); break; &#125; &#125; &#125; if (prefix != null) &#123; sql.insert(0, &quot; &quot;); sql.insert(0, prefix); &#125; &#125; &#125; // å¤„ç†åç¼€ private void applySuffix(StringBuilder sql, String trimmedUppercaseSql) &#123; if (!suffixApplied) &#123; suffixApplied = true; if (suffixesToOverride != null) &#123; for (String toRemove : suffixesToOverride) &#123; if (trimmedUppercaseSql.endsWith(toRemove) || trimmedUppercaseSql.endsWith(toRemove.trim())) &#123; int start = sql.length() - toRemove.trim().length(); int end = sql.length(); sql.delete(start, end); break; &#125; &#125; &#125; if (suffix != null) &#123; sql.append(&quot; &quot;); sql.append(suffix); &#125; &#125; &#125;&#125; WhereSqlNodeå’ŒSetSqlNodeéƒ½ç»§æ‰¿äº†TrimSqlNodeã€‚ å…¶ä¸­WhereSqlNodeæŒ‡å®šäº†prefixå­—æ®µä¸ºWHEREï¼ŒprefixesToOverrideé›†åˆä¸­çš„é¡¹ä¸ºANDå’ŒORï¼Œsuffixå­—æ®µå’ŒsuffixesToOverrideé›†åˆä¸ºnullã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ&lt;where&gt;èŠ‚ç‚¹è§£æåçš„SQLè¯­å¥ç‰‡æ®µå¦‚æœä»¥ANDæˆ–ORå¼€å¤´ï¼Œåˆ™å°†å¼€å¤´å¤„çš„ANDæˆ–ORåˆ é™¤ï¼Œä¹‹åå†å°†WHEREå…³é”®å­—æ·»åŠ åˆ°SQLç‰‡æ®µå¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥&lt;where&gt;èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„SQLç‰‡æ®µã€‚ SetSqlNodeæŒ‡å®šäº†prefixå­—æ®µä¸ºSETï¼ŒsuffixesToOverrideé›†åˆä¸­çš„é¡¹åªæœ‰suffixå­—æ®µå’ŒprefixesToOverrideé›†åˆä¸ºnullã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ&lt;set&gt;èŠ‚ç‚¹è§£æåçš„SQLè¯­å¥ç‰‡æ®µå¦‚æœä»¥,ç»“å°¾ï¼Œåˆ™å°†ç»“å°¾å¤„çš„åˆ é™¤æ‰ï¼Œä¹‹åå†å°†SETå…³é”®å­—æ·»åŠ åˆ°SQLç‰‡æ®µçš„å¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥&lt;set&gt;èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„SQLç‰‡æ®µã€‚ 5ã€ForeachSqINode åœ¨åŠ¨æ€SQLè¯­å¥ä¸­æ„å»ºINæ¡ä»¶è¯­å¥çš„æ—¶å€™ï¼Œé€šå¸¸éœ€è¦å¯¹ä¸€ä¸ªé›†åˆè¿›è¡Œè¿­ä»£ï¼ŒMyBatisæä¾›äº†&lt;foreach&gt;æ ‡ç­¾å®ç°è¯¥åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨&lt;foreach&gt;æ ‡ç­¾è¿­ä»£é›†åˆæ—¶ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨é›†åˆçš„å…ƒç´ å’Œç´¢å¼•å€¼ï¼Œè¿˜å¯ä»¥åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰æˆ–ç»“æŸä¹‹åæ·»åŠ æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå…è®¸åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ·»åŠ æŒ‡å®šçš„åˆ†éš”ç¬¦ã€‚ è§£æ&lt;foreach&gt;èŠ‚ç‚¹å¯¹åº”çš„sqlnodeå®ç°ç±»æ˜¯ForeachSqlNodeï¼Œä»¥ä¸‹æ˜¯å…¶ä¸­å®šä¹‰çš„å­—æ®µï¼š // ç”¨äºåˆ¤æ–­å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ï¼ŒForeachSqlNodeæ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºè¯¥å¯¹è±¡private final ExpressionEvaluator evaluator;// è¿­ä»£çš„é›†åˆè¡¨è¾¾å¼private final String collectionExpression;// å­èŠ‚ç‚¹private final SqlNode contents;// å¾ªç¯å¼€å§‹å‰è¦æ·»åŠ çš„å­—ç¬¦ä¸²private final String open;// å¾ªç¯ç»“æŸæ—¶è¦æ·»åŠ çš„å­—ç¬¦ä¸²private final String close;// åˆ†éš”ç¬¦private final String separator;// æœ¬æ¬¡è¿­ä»£çš„å…ƒç´ private final String item;// å½“å‰è¿­ä»£çš„æ¬¡æ•°private final String index;// é…ç½®private final Configuration configuration; ForeachSqINodeä¸­æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯PrefixedContextå’ŒFilteredDynamicContextï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†DynamicContextï¼ŒåŒæ—¶ä¹Ÿéƒ½æ˜¯DynamicContextçš„ä»£ç†ç±»ã€‚ PreFixedContext private class PrefixedContext extends DynamicContext &#123; private final DynamicContext delegate; private final String prefix; // æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€ private boolean prefixApplied; // ... @Override public void appendSql(String sql) &#123; if (!prefixApplied &amp;&amp; sql != null &amp;&amp; sql.trim().length() &gt; 0) &#123; // æ˜¯å¦éœ€è¦è¿½åŠ å‰ç¼€ delegate.appendSql(prefix); // è¿½åŠ å‰ç¼€ prefixApplied = true; &#125; delegate.appendSql(sql); // è¿½åŠ sql &#125;&#125; FilteredDynamicContext FilteredDynamicContextè´Ÿè´£å¤„ç†#&#123;&#125;å ä½ç¬¦ï¼Œä½†å®ƒå¹¶æœªå®Œå…¨è§£æ#&#123;&#125;å ä½ç¬¦ã€‚ private static class FilteredDynamicContext extends DynamicContext &#123; // DynamicContextå¯¹è±¡ private final DynamicContext delegate; // ç´¢å¼•ä½ç½® private final int index; // å¯¹åº”é›†åˆé¡¹çš„index private final String itemIndex; private final String item; // ... @Override public void appendSql(String sql) &#123; GenericTokenParser parser = new GenericTokenParser(&quot;#&#123;&quot;, &quot;&#125;&quot;, new TokenHandler() &#123; @Override public String handleToken(String content) &#123; String newContent = content.replaceFirst(&quot;^\\\\s*&quot; + item + &quot;(?![^.,:\\\\s])&quot;, itemizeItem(item, index)); if (itemIndex != null &amp;&amp; newContent.equals(content)) &#123; newContent = content.replaceFirst(&quot;^\\\\s*&quot; + itemIndex + &quot;(?![^.,:\\\\s])&quot;, itemizeItem(itemIndex, index)); &#125; return new StringBuilder(&quot;#&#123;&quot;).append(newContent).append(&quot;&#125;&quot;).toString(); &#125; &#125;); delegate.appendSql(parser.parse(sql)); &#125; @Override public int getUniqueNumber() &#123; return delegate.getUniqueNumber(); &#125;&#125; 6ã€ChooseSqlNode å¦‚æœåœ¨ç¼–å†™åŠ¨æ€SQLè¯­å¥æ—¶éœ€è¦ç±»ä¼¼Javaä¸­çš„switchè¯­å¥çš„åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨&lt;choose&gt;ã€&lt;when&gt;å’Œ&lt;otherwise&gt;ä¸‰ä¸ªæ ‡ç­¾çš„ç»„åˆã€‚MyBatisä¼šå°†&lt;choose&gt;æ ‡ç­¾è§£ææˆChooseSqlNodeï¼Œå°†&lt;when&gt;æ ‡ç­¾è§£ææˆIfSqlNodeï¼Œå°†&lt;otherwise&gt;æ ‡ç­¾è§£ææˆMixedSqlNodeã€‚ ChooseSqlNode.apply()æ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆéå†ifSqlNodesé›†åˆå¹¶è°ƒç”¨å…¶ä¸­SqlNodeå¯¹è±¡çš„apply()æ–¹æ³•ï¼Œç„¶åæ ¹æ®å‰é¢çš„å¤„ç†ç»“æœå†³å®šæ˜¯å¦è°ƒç”¨defaultSqlNodeçš„apply()æ–¹æ³•ã€‚ 7ã€VarDecISqINode VarDeclSqlNodeè¡¨ç¤ºçš„æ˜¯åŠ¨æ€SQLè¯­å¥ä¸­çš„&lt;bind&gt;èŠ‚ç‚¹,è¯¥èŠ‚ç‚¹å¯ä»¥ä»OGNLè¡¨è¾¾å¼ä¸­åˆ›å»ºä¸€ä¸ªå˜é‡å¹¶å°†å…¶è®°å½•åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚ åœ¨VarDecISqINodeä¸­é€šè¿‡nameå­—æ®µè®°å½•&lt;bind&gt;èŠ‚ç‚¹çš„nameå±æ€§å€¼ï¼Œexpressionå­—æ®µè®°å½•&lt;bind&gt;èŠ‚ç‚¹çš„valueå±æ€§å€¼ã€‚ SqlSourceBuilderåœ¨ç»è¿‡SqlNode.apply()æ–¹æ³•çš„è§£æä¹‹åï¼ŒSQLè¯­å¥ä¼šè¢«ä¼ é€’åˆ°SqlSourceBuilderä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„è§£æã€‚ SqISourceBuilderä¸»è¦å®Œæˆäº†ä¸¤æ–¹é¢çš„æ“ä½œï¼Œä¸€æ–¹é¢æ˜¯è§£æSQLè¯­å¥ä¸­çš„#&#123;&#125;å ä½ç¬¦ä¸­å®šä¹‰çš„å±æ€§ï¼Œæ ¼å¼ç±»ä¼¼äº#&#123;__frc_item_0,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;ï¼Œå¦ä¸€æ–¹é¢æ˜¯å°†SQLè¯­å¥ä¸­çš„#&#123;&#125;å ä½ç¬¦æ›¿æ¢æˆ?å ä½ç¬¦ã€‚ SqlSourceBuilderä¹Ÿæ˜¯BaseBuilderçš„å­ç±»ä¹‹ä¸€ï¼Œå…¶æ ¸å¿ƒé€»è¾‘ä½äºparse()æ–¹æ³•ä¸­ã€‚ public SqlSource parse( String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters) &#123; // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†ä¹‹åçš„sqlè¯­å¥ // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨æˆ·ä¼ å…¥çš„å®å‚ç±»å‹ // ç¬¬ä¸‰ä¸ªå‚æ•°è®°å½•äº†å½¢å‚ä¸å®å‚çš„å¯¹åº”å…³ç³»ï¼Œå…¶å®å°±æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†åçš„DynamicContext.bindingsé›†åˆ // åˆ›å»ºParameterMappingTokenHandlerå¯¹è±¡ï¼Œ å®ƒæ˜¯è§£æ#&#123;&#125;å ä½ç¬¦ä¸­çš„å‚æ•°å±æ€§ä»¥åŠæ›¿æ¢å ä½ç¬¦çš„æ ¸å¿ƒ ParameterMappingTokenHandler handler = new ParameterMappingTokenHandler(configuration, parameterType, additionalParameters); // é…åˆParameterMappingTokenHandlerè§£æå ä½ç¬¦ GenericTokenParser parser = new GenericTokenParser(&quot;#&#123;&quot;, &quot;&#125;&quot;, handler); String sql = parser.parse(originalSql); return new StaticSqlSource(configuration, sql, handler.getParameterMappings());&#125; DynamicSqlSourceDynamicSqlSourceè´Ÿè´£è§£æåŠ¨æ€SQLè¯­å¥ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„Sqlourceå®ç°ä¹‹ä¸€ã€‚SqlNodeä¸­ä½¿ç”¨äº†ç»„åˆæ¨¡å¼ï¼Œå½¢æˆäº†ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼ŒDynamicSqlSourceä¸­ä½¿ç”¨rootSqlNodeå­—æ®µ(SqlNodeç±»å‹)è®°å½•äº†å¾…è§£æçš„SqlNodeæ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ DynamicSqlSource.getBoundSql()æ–¹æ³•ï¼š public BoundSql getBoundSql(Object parameterObject) &#123; // åˆ›å»ºDynamicContextå¯¹è±¡ DynamicContext context = new DynamicContext(configuration, parameterObject); // é€šè¿‡è°ƒç”¨rootSqlNode.apply()æ–¹æ³•è°ƒç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å…¨éƒ¨SqlNode.apply()æ–¹æ³•ã€‚ // æ¯ä¸ªSqlNodeçš„apply()æ–¹æ³•éƒ½å°†è§£æå¾—åˆ°çš„SQLè¯­å¥ç‰‡æ®µè¿½åŠ åˆ°contextä¸­ï¼Œ // æœ€ç»ˆé€šè¿‡context.getSql()å¾—åˆ°å®Œæ•´çš„SQLè¯­å¥ rootSqlNode.apply(context); SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration); Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass(); SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings()); // åˆ›å»ºBoundSqlå¯¹è±¡ï¼Œå¹¶å°†DynamicContext.bindingsä¸­çš„å‚æ•°ä¿¡æ¯å¤åˆ¶åˆ°å…¶ BoundSql boundSql = sqlSource.getBoundSql(parameterObject); for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123; boundSql.setAdditionalParameter(entry.getKey(), entry.getValue()); &#125; return boundSql;&#125; RawSqISourceRawSqISourceæ˜¯SqlSourceçš„å¦ä¸€ä¸ªå®ç°ï¼Œå…¶é€»è¾‘ä¸DynamicSqlSourceç±»ä¼¼ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶æœºä¸ä¸€æ ·ï¼Œå¤„ç†çš„SQLè¯­å¥ç±»å‹ä¹Ÿä¸ä¸€æ ·ã€‚ å‰é¢ä»‹ç»XMLScriptBuilder.parseDynamicTags()æ–¹æ³•æ—¶æåˆ°è¿‡ï¼Œå¦‚æœèŠ‚ç‚¹åªåŒ…å«#&#123;&#125;å ä½ç¬¦ï¼Œè€Œä¸åŒ…å«åŠ¨æ€SQLèŠ‚ç‚¹æˆ–æœªè§£æçš„$&#123;&#125;å ä½ç¬¦çš„è¯ï¼Œåˆ™ä¸æ˜¯åŠ¨æ€SQLè¯­å¥ï¼Œä¼šåˆ›å»ºç›¸åº”çš„StaticTextSqlNodeå¯¹è±¡ã€‚ åœ¨XMLScriptBuilder.parseScriptNode()æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ•´ä¸ªSQLèŠ‚ç‚¹æ˜¯å¦ä¸ºåŠ¨æ€çš„ï¼Œå¦‚æœä¸æ˜¯åŠ¨æ€çš„SQLèŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºç›¸åº”çš„RawSqlSourceå¯¹è±¡ã€‚ RawSqlSourceåœ¨æ„é€ æ–¹æ³•ä¸­é¦–å…ˆä¼šè°ƒç”¨getSql()æ–¹æ³•ï¼Œå…¶ä¸­é€šè¿‡è°ƒç”¨SqlNode.apply()æ–¹æ³•å®ŒæˆSQLè¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥å¤„ç†ï¼›ä¹‹åä¼šä½¿ç”¨SqlSourceBuilderå®Œæˆå ä½ç¬¦çš„æ›¿æ¢å’ŒParameterMappingé›†åˆçš„åˆ›å»ºï¼Œå¹¶è¿”å›StaticSqlSourceå¯¹è±¡ã€‚ public class RawSqlSource implements SqlSource &#123; private final SqlSource sqlSource; public RawSqlSource(Configuration configuration, SqlNode rootSqlNode, Class&lt;?&gt; parameterType) &#123; // è°ƒç”¨getsql()æ–¹æ³•ï¼Œå®ŒæˆSQLè¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥è§£æ this(configuration, getSql(configuration, rootSqlNode), parameterType); &#125; public RawSqlSource(Configuration configuration, String sql, Class&lt;?&gt; parameterType) &#123; SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration); Class&lt;?&gt; clazz = parameterType == null ? Object.class : parameterType; sqlSource = sqlSourceParser.parse(sql, clazz, new HashMap&lt;String, Object&gt;()); &#125; private static String getSql(Configuration configuration, SqlNode rootSqlNode) &#123; DynamicContext context = new DynamicContext(configuration, null); rootSqlNode.apply(context); return context.getSql(); &#125; @Override public BoundSql getBoundSql(Object parameterObject) &#123; return sqlSource.getBoundSql(parameterObject); &#125;&#125; æ— è®ºæ˜¯StaticSqlSourceã€DynamicSqlSourceè¿˜æ˜¯RawSqlSourceï¼Œæœ€ç»ˆéƒ½ä¼šç»Ÿä¸€ç”ŸæˆBoundSqlå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†å®Œæ•´çš„SQLè¯­å¥(å¯èƒ½åŒ…å«?å ä½ç¬¦)ã€å‚æ•°æ˜ å°„å…³ç³»(parameterMappingsé›†åˆ)ä»¥åŠç”¨æˆ·ä¼ å…¥çš„å‚æ•°(additionalParametersé›†åˆ)ã€‚ å¦å¤–ï¼ŒDynamicSqlSourceè´Ÿè´£å¤„ç†åŠ¨æ€SQLè¯­å¥ï¼ŒRawSqlSourceè´Ÿè´£å¤„ç†é™æ€SQLè¯­å¥ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä¸¤è€…è§£æSQLè¯­å¥çš„æ—¶æœºä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…çš„è§£ææ—¶æœºæ˜¯åœ¨å®é™…æ‰§è¡ŒSQLè¯­å¥ä¹‹å‰ï¼Œè€Œåè€…åˆ™æ˜¯åœ¨MyBatisåˆå§‹åŒ–æ—¶å®ŒæˆSQLè¯­å¥çš„è§£æã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"æ ¸å¿ƒå¤„ç†å±‚","slug":"æ ¸å¿ƒå¤„ç†å±‚","permalink":"https://www.cayzlh.com/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"æ ¸å¿ƒå¤„ç†å±‚-MyBatisåˆå§‹åŒ–","date":"2020-06-22T01:09:42.000Z","path":"2020/06/22/c499e157.html","text":"æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†MyBatisçš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»MyBatisçš„åˆå§‹åŒ–ã€åŠ¨æ€SQLè¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠSQLè¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æMyBatisçš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£MyBatisçš„æ ¸å¿ƒåŸç†ã€‚ æœ¬ç¯‡ä»‹ç»MyBatisçš„åˆå§‹åŒ– åœ¨MyBatisåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¼šè¯»å–mybatis-config.xmlé…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½é…ç½®æ–‡ä»¶æŒ‡å®šçš„ç±»ï¼Œå¤„ç†ç±»ä¸­çš„æ³¨è§£ï¼Œåˆ›å»ºä¸€äº›é…ç½®å¯¹è±¡ï¼Œæœ€ç»ˆå®Œæˆæ¡†æ¶ä¸­å„ä¸ªæ¨¡å—çš„åˆå§‹åŒ–ã€‚ å¦å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨JavaAPIçš„æ–¹å¼å¯¹MyBatisè¿›è¡Œé…ç½®ï¼Œè¿™ç§ç¡¬ç¼–ç çš„é…ç½®æ–¹å¼ä¸»è¦ç”¨åœ¨é…ç½®é‡æ¯”è¾ƒå°‘ä¸”é…ç½®ä¿¡æ¯ä¸å¸¸å˜åŒ–çš„åœºæ™¯ä¸‹ã€‚ å»ºé€ è€…æ¨¡å¼åœ¨MyBatiså¤„ç†mybatis-config.xmlä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºç›¸åº”çš„é…ç½®å¯¹è±¡ï¼Œè¯¥è¿‡ç¨‹çš„è®¾è®¡ä½¿ç”¨åˆ°å»ºé€ è€…æ¨¡å¼çš„ç›¸å…³çŸ¥è¯†ã€‚ å»ºé€ è€…æ¨¡å¼ä¸­çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š å»ºé€ è€…(Builder)æ¥å£ Builderæ¥å£ç”¨äºå®šä¹‰å»ºé€ è€…æ„å»ºäº§å“å¯¹è±¡çš„å„éƒ¨åˆ†çš„è¡Œä¸ºã€‚ å…·ä½“å»ºé€ è€…(ConcreteBuilder)è§’è‰² åœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„æ˜¯å…·ä½“å»ºé€ è€…ã€‚å…·ä½“å»ºé€ è€…ç±»å¿…é¡»å®ç°å»ºé€ è€…æ¥å£æ‰€è¦æ±‚çš„ä¸¤ç±»æ–¹æ³•ï¼š ä¸€ç±»æ˜¯å»ºé€ æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„buildPart1()ã€buildPart2()ç­‰æ–¹æ³•ã€‚ å¦ä¸€ç±»æ˜¯è·å–æ„å»ºå¥½çš„äº§å“å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„getProduct()æ–¹æ³•ã€‚ å¯¼æ¼”(Director)è§’è‰² è¯¥è§’è‰²ä¼šé€šè¿‡è°ƒç”¨å…·ä½“å»ºé€ è€…ï¼Œ åˆ›å»ºéœ€è¦çš„äº§å“å¯¹è±¡ äº§å“(Product)è§’è‰² äº§å“å¯¹è±¡å°±æ˜¯ç”¨æˆ·éœ€è¦ä½¿ç”¨çš„å¤æ‚å¯¹è±¡ å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼š å»ºé€ è€…æ¨¡å¼ä¸­çš„å¯¼æ¼”è§’è‰²å¹¶ä¸éœ€è¦çŸ¥æ™“äº§å“ç±»çš„å†…éƒ¨ç»†èŠ‚ï¼Œå®ƒåªæä¾›éœ€è¦çš„ä¿¡æ¯ç»™å»ºé€ è€…ï¼Œç”±å…·ä½“å»ºé€ è€…å¤„ç†è¿™äº›ä¿¡æ¯(è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚)å¹¶å®Œæˆäº§å“æ„é€ ã€‚è¿™å°±ä½¿äº§å“å¯¹è±¡çš„ä¸Šå±‚ä»£ç ä¸äº§å“å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ã€‚ å»ºé€ è€…æ¨¡å¼å°†å¤æ‚äº§å“çš„åˆ›å»ºè¿‡ç¨‹åˆ†æ•£åˆ°äº†ä¸åŒçš„æ„é€ æ­¥éª¤ä¸­ï¼Œè¿™æ ·å¯ä»¥å¯¹äº§å“åˆ›å»ºè¿‡ç¨‹å®ç°æ›´åŠ ç²¾ç»†çš„æ§åˆ¶ï¼Œä¹Ÿä¼šä½¿åˆ›å»ºè¿‡ç¨‹æ›´åŠ æ¸…æ™°ã€‚ æ¯ä¸ªå…·ä½“å»ºé€ è€…éƒ½å¯ä»¥åˆ›å»ºå‡ºå®Œæ•´çš„äº§å“å¯¹è±¡ï¼Œè€Œä¸”å…·ä½“å»ºé€ è€…ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡ä¸åŒçš„å…·ä½“å»ºé€ è€…ï¼Œå¾—åˆ°ä¸åŒçš„äº§å“å¯¹è±¡ã€‚å½“æœ‰æ–°äº§å“å‡ºç°æ—¶ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„å…·ä½“å»ºé€ è€…å³å¯å®Œæˆæ‰©å±•ï¼Œè¿™ç¬¦åˆå¼€æ”¾-å°é—­åŸåˆ™ã€‚ å»ºé€ è€…æ¨¡å¼ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå®ƒæ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œå¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚æ€§å¾ˆå¤§ï¼Œåˆ™ä¸é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼ã€‚ å¦‚æœäº§å“ç§ç±»è¾ƒå¤šï¼Œä¸”å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå°±éœ€è¦å®šä¹‰å¤šä¸ªå…·ä½“å»ºé€ è€…ç±»æ¥å®ç°è¿™ç§å˜åŒ–ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå˜å¾—å¾ˆå¤æ‚ï¼Œä¸æ˜“äºç†è§£ã€‚ BaseBuilderMyBatisåˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œæ˜¯åŠ è½½å¹¶è§£æmybatis-config.xmlé…ç½®æ–‡ä»¶ã€æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠç›¸å…³çš„æ³¨è§£ä¿¡æ¯ã€‚MyBatisçš„åˆå§‹åŒ–å…¥å£æ˜¯SqlSessionFactoryBuilder.build()æ–¹æ³•ï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹: public SqlSessionFactory build(Reader reader, String environment, Properties properties) &#123; try &#123; // è¯»å–é…ç½®æ–‡ä»¶ XMLConfigBuilder parser = new XMLConfigBuilder(reader, environment, properties); // è§£æé…ç½®æ–‡ä»¶å¾—åˆ°Configurationå¯¹è±¡ï¼Œåˆ›å»ºDefaultSqlSessionFactoryå¯¹è±¡ return build(parser.parse()); &#125; catch (Exception e) &#123; throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e); &#125; finally &#123; ErrorContext.instance().reset(); try &#123; reader.close(); &#125; catch (IOException e) &#123; // Intentionally ignore. Prefer previous error. &#125; &#125;&#125; SqlSessionFactoryBuilder.build()æ–¹æ³•ä¼šåˆ›å»ºXMLConfigBuilderå¯¹è±¡æ¥è§£æmybatis-config.xmlé…ç½®æ–‡ä»¶ï¼Œè€ŒXMLConfigBuilderç»§æ‰¿è‡ªBaseBuilderæŠ½è±¡ç±»ã€‚ MyBatisçš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¿™é‡Œçš„BaseBuilderæŠ½è±¡ç±»å°±æ‰®æ¼”ç€å»ºé€ è€…æ¥å£çš„è§’è‰²ã€‚BaseBuilderä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š // Configurationæ˜¯MyBatisåˆå§‹åŒ–è¿‡ç¨‹çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒMyBatisä¸­å‡ ä¹å…¨éƒ¨çš„é…ç½®ä¿¡æ¯éƒ½ä¼šä¿å­˜åˆ°Configurationä¸­// Configurationå¯¹è±¡æ˜¯åœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­åˆ›å»ºä¸”æ˜¯å…¨å±€å”¯ä¸€çš„ï¼ˆall-in-oneé…ç½®å¯¹è±¡ï¼‰ã€‚protected final Configuration configuration;// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeAliases&gt;æ ‡ç­¾å®šä¹‰åˆ«åï¼Œè¿™äº›å®šä¹‰çš„åˆ«åéƒ½ä¼šè®°å½•åœ¨// TypeAliasRegistryå¯¹è±¡ä¸­protected final TypeAliasRegistry typeAliasRegistry;// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeHandlers&gt;æ ‡ç­¾æ·»åŠ è‡ªå®šä¹‰TypeHandlerå™¨ï¼Œ// å®ŒæˆæŒ‡å®šæ•°æ®åº“ç±»å‹ä¸Javaç±»å‹çš„è½¬æ¢ï¼Œè¿™äº›TypeHandleréƒ½ä¼šè®°å½•åœ¨TypeHandlerRegistryä¸­protected final TypeHandlerRegistry typeHandlerRegistry; BaseBuilderä¸­è®°å½•çš„TypeAliasRegistryå¯¹è±¡å’ŒTypeHandlerRegistryå¯¹è±¡ï¼Œå…¶å®æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨Configurationå¯¹è±¡åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ã€‚ Configurationç±»ä¸­å®šä¹‰äº†è¿™ä¸¤ä¸ªå­—æ®µï¼š protected final TypeHandlerRegistry typeHandlerRegistry = new TypeHandlerRegistry();protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry(); åœ¨BaseBuilderæ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡ç›¸åº”çš„Configuration.get*()æ–¹æ³•å¾—åˆ°TypeAliasRegistryå¯¹è±¡å’ŒTypeHandlerRegistryå¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™BaseBuilderç›¸åº”å­—æ®µã€‚ BaseBuilder.resolveAlias()æ–¹æ³•ä¾èµ–TypeAliasRegistryè§£æåˆ«åï¼ŒBaseBuilder.resolveTypeHandler()æ–¹æ³•ä¾èµ–TypeHandlerRegistryæŸ¥æ‰¾æŒ‡å®šçš„TypeHandlerå¯¹è±¡ã€‚ MyBatisä½¿ç”¨JdbcTypeæšä¸¾ç±»å‹è¡¨ç¤ºJDBCç±»å‹ã€‚MyBatisä¸­å¸¸ç”¨çš„æšä¸¾ç±»å‹è¿˜æœ‰ResultSetTypeå’ŒParameterMode:ResultSetTypeæšä¸¾ç±»å‹è¡¨ç¤ºç»“æœé›†ç±»å‹ï¼Œä½¿ç”¨ParameterModeæšä¸¾ç±»å‹è¡¨ç¤ºå­˜å‚¨è¿‡ç¨‹ä¸­çš„å‚æ•°ç±»å‹ã€‚ åœ¨BaseBuilderä¸­æä¾›äº†ç›¸åº”çš„resolveJdbcType()ã€resolveResultSetType()ã€resolveParameterMode()æ–¹æ³•ï¼Œå°†Stringè½¬æ¢æˆå¯¹åº”çš„æšä¸¾å¯¹è±¡ã€‚ XMLConfigBuilderXMLConfigBuilderæ˜¯BaseBuilderçš„ä¼—å¤šå­ç±»ä¹‹ä¸€ï¼Œå®ƒæ‰®æ¼”çš„æ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚**XMLConfigBuilderä¸»è¦è´Ÿè´£è§£æmybatis-config.xmlé…ç½®ã€‚** æ ¸å¿ƒå­—æ®µï¼š // æ ‡è¯†æ˜¯å¦å·²ç»è§£æè¿‡mybatis-config.xmlæ–‡ä»¶private boolean parsed;// ç”¨äºè§£æmybatis-config.xmlé…ç½®æ–‡ä»¶çš„XpathParserå¯¹è±¡private final XPathParser parser;// æ ‡è¯† &lt;environment&gt; é…ç½®çš„åç§°ï¼Œ é»˜è®¤è¯»å–&lt;environment&gt;æ ‡ç­¾çš„é»˜è®¤å€¼private String environment;// è´Ÿè´£åˆ›å»ºå’Œç¼“å­˜Reflectorå¯¹è±¡private final ReflectorFactory localReflectorFactory = new DefaultReflectorFactory(); XMLConfigBuilder.parse()æ–¹æ³•æ˜¯è§£æmybatis-config.xmlé…ç½®æ–‡ä»¶çš„å…¥å£ï¼Œå®ƒé€šè¿‡è°ƒç”¨XMLConfigBuilder.parseConfiguration()æ–¹æ³•å®ç°æ•´ä¸ªè§£æè¿‡ç¨‹ã€‚ public Configuration parse() &#123; if (parsed) &#123; // æ ¹æ®parsedå˜é‡çš„å€¼åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆäº†å¯¹mybatis-config.xmlé…ç½®æ–‡ä»¶çš„è§£æ throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;); &#125; parsed = true; // æ‰¾åˆ° configuration èŠ‚ç‚¹ï¼Œå¼€å§‹è§£æ parseConfiguration(parser.evalNode(&quot;/configuration&quot;)); return configuration;&#125;private void parseConfiguration(XNode root) &#123; try &#123; // è§£æpropertiesèŠ‚ç‚¹ propertiesElement(root.evalNode(&quot;properties&quot;)); // è§£æsettingsèŠ‚ç‚¹ Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;)); loadCustomVfs(settings); typeAliasesElement(root.evalNode(&quot;typeAliases&quot;)); pluginElement(root.evalNode(&quot;plugins&quot;)); objectFactoryElement(root.evalNode(&quot;objectFactory&quot;)); objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;)); reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;)); settingsElement(settings); // read it after objectFactory and objectWrapperFactory issue #631 environmentsElement(root.evalNode(&quot;environments&quot;)); databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;)); typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;)); mapperElement(root.evalNode(&quot;mappers&quot;)); &#125; catch (Exception e) &#123; throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e); &#125;&#125; è§£æ&lt;properties&gt;èŠ‚ç‚¹ XMLConfigBuilder.propertiesElement()æ–¹æ³•ä¼šè§£æmybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­çš„propertiesèŠ‚ç‚¹å¹¶å½¢æˆjava.util.Propertieså¯¹è±¡ï¼Œä¹‹åå°†è¯¥Propertieså¯¹è±¡è®¾ç½®åˆ°XPathParserå’ŒConfigurationçš„variableså­—æ®µä¸­ã€‚åœ¨åé¢çš„è§£æè¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨è¯¥Propertieså¯¹è±¡ä¸­çš„ä¿¡æ¯æ›¿æ¢å ä½ç¬¦ã€‚ private void propertiesElement(XNode context) throws Exception &#123; if (context != null) &#123; // è§£æ&lt;properties&gt;çš„å­èŠ‚ç‚¹ï¼ˆ&lt;property&gt;æ ‡ç­¾ï¼‰çš„nameå’Œvalueå±æ€§ï¼Œ å¹¶è®°å½•åˆ°Propertiesä¸­ Properties defaults = context.getChildrenAsProperties(); // è§£æ&lt;properties&gt;çš„resourceå’Œurlå±æ€§ï¼Œè¿™ä¸¤ä¸ªå±æ€§ç”¨äºç¡®å®špropertiesé…ç½®æ–‡ä»¶çš„ä½ç½® String resource = context.getStringAttribute(&quot;resource&quot;); String url = context.getStringAttribute(&quot;url&quot;); // resourceå’Œurlå±æ€§ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ if (resource != null &amp;&amp; url != null) &#123; throw new BuilderException(&quot;...&quot;); &#125; if (resource != null) &#123; defaults.putAll(Resources.getResourceAsProperties(resource)); &#125; else if (url != null) &#123; defaults.putAll(Resources.getUrlAsProperties(url)); &#125; Properties vars = configuration.getVariables(); if (vars != null) &#123; defaults.putAll(vars); &#125; // æ›´æ–°XPathParserå’ŒConfigurationçš„variableså­—æ®µ parser.setVariables(defaults); configuration.setVariables(defaults); &#125;&#125; è§£æ&lt;settings&gt;èŠ‚ç‚¹ XMLConfigBuilder.settingsAsProperties()æ–¹æ³•è´Ÿè´£è§£æsettingsèŠ‚ç‚¹ï¼Œåœ¨settingsç‚¹ä¸‹çš„é…ç½®æ˜¯MyBatiså…¨å±€æ€§çš„é…ç½®ï¼Œå®ƒä»¬ä¼šæ”¹å˜MyBatisçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œè¿™äº›å…¨å±€é…ç½®ä¿¡æ¯éƒ½ä¼šè¢«è®°å½•åˆ°Configurationå¯¹è±¡çš„å¯¹åº”å±æ€§ä¸­ã€‚ ä¾‹å¦‚ï¼šå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é…ç½®autoMappingBehaviorä¿®æ”¹MyBatisæ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„çš„åŠŸèƒ½ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ &lt;settings&gt; &lt;!- autoMappingBehavioré…ç½®é¡¹ æ˜¯å†³ å®šMyBatisæ˜¯å¦å¹µ å¯ è‡ªåŠ¨ æ˜ å°„åŠŸèƒ½çš„æ¡ ä»¶ä¹‹ä¸€ --&gt; &lt;setting name=&quot;autoMappingBehavior&quot; value=&quot;PARTIAL&quot; /&gt;&lt;/settings&gt; åœ¨Configurationä¸­å­˜åœ¨ä¸€ä¸ªåŒåçš„ç›¸åº”å­—æ®µï¼š protected AutoMappingBehavior autoMappingBehavior = AutoMappingBehavior.PARTIAL; settingsAsProperties()æ–¹æ³•çš„è§£ææ–¹å¼ä¸propertiesElement()æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯å¤šäº†ä½¿ç”¨MetaClassæ£€æµ‹keyæŒ‡å®šçš„å±æ€§åœ¨Configurationç±»ä¸­æ˜¯å¦æœ‰å¯¹åº”setteræ–¹æ³•çš„æ­¥éª¤ã€‚ private Properties settingsAsProperties(XNode context) &#123; if (context == null) &#123; return new Properties(); &#125; Properties props = context.getChildrenAsProperties(); // Check that all settings are known to the configuration class // åˆ›å»º Configuration å¯¹åº”çš„MetaClasså¯¹è±¡ MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory); // æ£€æµ‹Configurationä¸­æ˜¯å¦å®šä¹‰äº†keyæŒ‡å®šå±æ€§ç›¸åº”çš„setteræ–¹æ³• for (Object key : props.keySet()) &#123; if (!metaConfig.hasSetter(String.valueOf(key))) &#123; throw new BuilderException(&quot;...&quot;); &#125; &#125; return props;&#125; è§£æ&lt;typeAliases&gt;ã€&lt;typeHandlers&gt;èŠ‚ç‚¹ XMLConfigBuilder.typeAliasesElement()æ–¹æ³•è´Ÿè´£è§£ætypeAliasesèŠ‚ç‚¹ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡TypeAliasRegistryå®Œæˆåˆ«åçš„æ³¨å†Œã€‚ private void typeAliasesElement(XNode parent) &#123; if (parent != null) &#123; for (XNode child : parent.getChildren()) &#123; // å¤„ç†å…¨éƒ¨å­èŠ‚ç‚¹ if (&quot;package&quot;.equals(child.getName())) &#123; // å¤„ç†packageèŠ‚ç‚¹ // è·å–æŒ‡å®šåŒ…å String typeAliasPackage = child.getStringAttribute(&quot;name&quot;); // é€šè¿‡TypeAliasRegistryæ‰«ææŒ‡å®šåŒ…ä¸­æ‰€æœ‰çš„ç±»ï¼Œå¹¶è§£æ@Aliasæ³¨è§£ï¼Œå®Œæˆåˆ«åæ³¨å†Œ configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage); &#125; else &#123; // å¤„ç†typeAliasèŠ‚ç‚¹ String alias = child.getStringAttribute(&quot;alias&quot;); // è·å–æŒ‡å®šåˆ«å String type = child.getStringAttribute(&quot;type&quot;); // è·å–åˆ«åå¯¹åº”çš„ç±»å‹ try &#123; Class&lt;?&gt; clazz = Resources.classForName(type); if (alias == null) &#123; typeAliasRegistry.registerAlias(clazz); // æ‰«æ@Aliasæ³¨è§£ï¼Œå®Œæˆæ³¨å†Œ &#125; else &#123; typeAliasRegistry.registerAlias(alias, clazz); // æ³¨å†Œåˆ«å &#125; &#125; catch (ClassNotFoundException e) &#123; throw new BuilderException(&quot;...&quot;); &#125; &#125; &#125; &#125;&#125; XMLConfigBuilder.typeHandlerElement()æ–¹æ³•è´Ÿè´£è§£ætypeHandlersèŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡TypeHandlerRegistryå¯¹è±¡å®ŒæˆTypeHandlerçš„æ³¨å†Œï¼Œè¯¥æ–¹æ³•çš„å®ç°ä¸typeAliasesElement()æ–¹æ³•ç±»ä¼¼ã€‚ è§£æ&lt;plugins&gt;èŠ‚ç‚¹ æ’ä»¶æ˜¯MyBatisæä¾›çš„æ‰©å±•æœºåˆ¶ä¹‹ä¸€ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰æ’ä»¶åœ¨SQLè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸€ç‚¹è¿›è¡Œæ‹¦æˆªã€‚ MyBatisä¸­çš„è‡ªå®šä¹‰æ’ä»¶åªéœ€å®ç°Interceptoræ¥å£ï¼Œå¹¶é€šè¿‡æ³¨è§£æŒ‡å®šæƒ³è¦æ‹¦æˆªçš„æ–¹æ³•ç­¾åå³å¯ã€‚è¿™é‡Œåˆ†æMyBatisä¸­å¦‚ä½•åŠ è½½å’Œç®¡ç†æ’ä»¶ã€‚XMLConfigBuilder.pluginElement()æ–¹æ³•è´Ÿè´£è§£æpluginsèŠ‚ç‚¹ä¸­å®šä¹‰çš„æ’ä»¶ï¼Œå¹¶å®Œæˆå®ä¾‹åŒ–å’Œé…ç½®æ“ä½œã€‚ private void pluginElement(XNode parent) throws Exception &#123; if (parent != null) &#123; for (XNode child : parent.getChildren()) &#123; // è·å–pluginèŠ‚ç‚¹çš„interceptorå±æ€§ String interceptor = child.getStringAttribute(&quot;interceptor&quot;); // è·å–pluginèŠ‚ç‚¹ä¸‹çš„propertiesé…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡ Properties properties = child.getChildrenAsProperties(); // é€šè¿‡TypeAliasRegistryè§£æåˆ«åä¹‹åï¼Œå®ä¾‹åŒ–Interceptorå¯¹è±¡ Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance(); // è®¾ç½®Interceptorçš„å±æ€§ interceptorInstance.setProperties(properties); // è®°å½•Interceptorå¯¹è±¡ configuration.addInterceptor(interceptorInstance); &#125; &#125;&#125; æ‰€æœ‰é…ç½®çš„Interceptorå¯¹è±¡éƒ½æ˜¯é€šè¿‡Configuration.interceptorChainå­—æ®µ(InterceptorChainç±»å‹)ç®¡ç†çš„ï¼ŒInterceptorChainåº•å±‚ä½¿ç”¨ArrayList&lt;Interceptor&gt;å®ç°ã€‚ public class InterceptorChain &#123; private final List&lt;Interceptor&gt; interceptors = new ArrayList&lt;Interceptor&gt;(); public Object pluginAll(Object target) &#123; for (Interceptor interceptor : interceptors) &#123; target = interceptor.plugin(target); &#125; return target; &#125; public void addInterceptor(Interceptor interceptor) &#123; interceptors.add(interceptor); &#125; public List&lt;Interceptor&gt; getInterceptors() &#123; return Collections.unmodifiableList(interceptors); &#125;&#125; è§£æ&lt;objectFactory&gt;èŠ‚ç‚¹ æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰Objectoryå®ç°ç±»ã€ObjectWrapperFactoryå®ç°ç±»ä»¥åŠReflectorFactoryå®ç°ç±»å¯¹MyBatisè¿›è¡Œæ‰©å±•ã€‚XMLConfigBuilder.objectFactoryElement()æ–¹æ³•è´Ÿè´£è§£æå¹¶å®ä¾‹åŒ–&lt;objectFactory&gt;èŠ‚ç‚¹æŒ‡å®šçš„ObjectFactoryå®ç°ç±»ï¼Œä¹‹åå°†è‡ªå®šä¹‰çš„ObjectFactoryå¯¹è±¡è®°å½•åˆ°Configuration.objectFactoryå­—æ®µä¸­ã€‚ private void objectFactoryElement(XNode context) throws Exception &#123; if (context != null) &#123; // è·å–&lt;objectFactory&gt;èŠ‚ç‚¹çš„typeå±æ€§ String type = context.getStringAttribute(&quot;type&quot;); // è·å–&lt;ObjectFactory&gt;èŠ‚ç‚¹ä¸‹é…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡ Properties properties = context.getChildrenAsProperties(); // è¿›è¡Œåˆ«åè§£æåï¼Œå®ä¾‹åŒ–è‡ªå®šä¹‰ObjectFactoryå®ç° ObjectFactory factory = (ObjectFactory) resolveClass(type).newInstance(); // è®¾ç½®è‡ªå®šä¹‰ObjectFactoryå±æ€§ï¼Œ å®Œæˆåˆå§‹åŒ–ç›¸å…³æ“ä½œ factory.setProperties(properties); // å°†è‡ªå®šä¹‰ObjectFactoryå¯¹è±¡è®°å½•åˆ°Configurationå¯¹è±¡çš„ObjectFactoryå­—æ®µä¸­ï¼Œå¾…åç»­ä½¿ç”¨ configuration.setObjectFactory(factory); &#125;&#125; XMLConfigBuilderå¯¹&lt;objectWrapperFactory&gt;èŠ‚ç‚¹ã€&lt;reflectorFactory&gt;èŠ‚ç‚¹çš„è§£æä¸ä¸Šè¿°è¿‡ç¨‹ç±»ä¼¼ï¼Œæœ€ç»ˆä¼šå°†è§£æå¾—åˆ°çš„è‡ªå®šä¹‰å¯¹è±¡è®°å½•åˆ°Configurationçš„ç›¸åº”å­—æ®µä¸­ã€‚ è§£æ&lt;environments&gt;èŠ‚ç‚¹ åœ¨å®é™…ç”Ÿäº§ä¸­ï¼ŒåŒä¸€é¡¹ç›®å¯èƒ½åˆ†ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§å¤šä¸ªä¸åŒçš„ç¯å¢ƒï¼Œæ¯ä¸ªç¯å¢ƒçš„é…ç½®å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒã€‚ MyBatiså¯ä»¥é…ç½®å¤šä¸ª&lt;environment&gt;èŠ‚ç‚¹ï¼Œæ¯ä¸ª&lt;environment&gt;èŠ‚ç‚¹å¯¹åº”ä¸€ç§ç¯å¢ƒçš„é…ç½®ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡å¯ä»¥é…ç½®å¤šä¸ªç¯å¢ƒï¼Œæ¯ä¸ªSqlSessionFactoryå®ä¾‹åªèƒ½é€‰æ‹©å…¶ä¸€ã€‚ XMLConfigBuilder.environmentsElement()æ–¹æ³•è´Ÿè´£è§£æ&lt;environments&gt;çš„ç›¸å…³é…ç½®ï¼Œå®ƒä¼šæ ¹æ®XMLConfigBuilder.environmentå­—æ®µå€¼ç¡®å®šè¦ä½¿ç”¨çš„&lt;environment&gt;é…ç½®ï¼Œä¹‹ååˆ›å»ºå¯¹åº”çš„TransactionFactoryå’ŒDataSourceå¯¹è±¡ï¼Œå¹¶å°è£…è¿›Environmentå¯¹è±¡ä¸­ã€‚ private void environmentsElement(XNode context) throws Exception &#123; if (context != null) &#123; // æœªæŒ‡å®š XMLConfigBuilder.environment å­—æ®µï¼Œåˆ™ä½¿ç”¨defaultå±æ€§æŒ‡å®šçš„&lt;environment&gt; if (environment == null) &#123; environment = context.getStringAttribute(&quot;default&quot;); &#125; for (XNode child : context.getChildren()) &#123; String id = child.getStringAttribute(&quot;id&quot;); if (isSpecifiedEnvironment(id)) &#123; TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;)); DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;)); DataSource dataSource = dsFactory.getDataSource(); Environment.Builder environmentBuilder = new Environment.Builder(id) .transactionFactory(txFactory) .dataSource(dataSource); configuration.setEnvironment(environmentBuilder.build()); &#125; &#125; &#125;&#125; è§£æ&lt;databaseldProvider&gt;èŠ‚ç‚¹ MyBatisä¸èƒ½åƒHibernateé‚£æ ·ï¼Œç›´æ¥å¸®åŠ©å¼€å‘äººå‘˜å±è”½å¤šç§æ•°æ®åº“äº§å“åœ¨SQLè¯­è¨€æ”¯æŒæ–¹é¢çš„å·®å¼‚ã€‚ ä½†æ˜¯åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡&lt;databaseIdProvider&gt;å®šä¹‰æ‰€æœ‰æ”¯æŒçš„æ•°æ®åº“äº§å“çš„databaseld,ç„¶ååœ¨æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰SQLè¯­å¥èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡databaseldæŒ‡å®šè¯¥SQLè¯­å¥åº”ç”¨çš„æ•°æ®åº“äº§å“ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚ åœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®å‰é¢ç¡®å®šçš„DataSourceç¡®å®šå½“å‰ä½¿ç”¨çš„æ•°æ®åº“äº§å“ï¼Œç„¶ååœ¨è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼ŒåŠ è½½ä¸å¸¦databaseldå±æ€§å’Œå¸¦æœ‰åŒ¹é…å½“å‰æ•°æ®åº“databaseldå±æ€§çš„æ‰€æœ‰SQLè¯­å¥ã€‚å¦‚æœåŒæ—¶æ‰¾åˆ°å¸¦æœ‰databaseldå’Œä¸å¸¦databaseldçš„ç›¸åŒè¯­å¥ï¼Œåˆ™åè€…ä¼šè¢«èˆå¼ƒï¼Œä½¿ç”¨å‰è€…ã€‚ XMLConfigBuilder.databaseIdProviderElement()æ–¹æ³•è´Ÿè´£è§£æ&lt;databaseIdProvider&gt;èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºæŒ‡å®šçš„DatabaseldProviderå¯¹è±¡ã€‚DatabaseldProviderä¼šè¿”å›databaseldå€¼ï¼ŒMyBatisä¼šæ ¹æ®databaseldé€‰æ‹©åˆé€‚çš„SQLè¿›è¡Œæ‰§è¡Œã€‚ private void databaseIdProviderElement(XNode context) throws Exception &#123; DatabaseIdProvider databaseIdProvider = null; if (context != null) &#123; String type = context.getStringAttribute(&quot;type&quot;); // awful patch to keep backward compatibility if (&quot;VENDOR&quot;.equals(type)) &#123; type = &quot;DB_VENDOR&quot;; &#125; Properties properties = context.getChildrenAsProperties(); // åˆ›å»ºDatabaseIdProviderå¯¹è±¡ databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance(); // é…ç½®DatabaseIdProviderï¼Œå®Œæˆåˆå§‹åŒ– databaseIdProvider.setProperties(properties); &#125; Environment environment = configuration.getEnvironment(); if (environment != null &amp;&amp; databaseIdProvider != null) &#123; // é€šè¿‡å‰é¢ç¡®å®šçš„DataSourceè·å–databaseldï¼Œå¹¶è®°å½•åˆ°Configuration.databaseldå­—æ®µä¸­ String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource()); configuration.setDatabaseId(databaseId); &#125;&#125; MyBatisæä¾›çš„DatabaseldProvideræ¥å£åŠå…¶å®ç°æ¯”è¾ƒç®€å•ã€‚ DatabaseldProvideræ¥å£çš„æ ¸å¿ƒæ–¹æ³•æ˜¯getDatabaseId()æ–¹æ³•ï¼Œå®ƒä¸»è¦è´Ÿè´£é€šè¿‡ç»™å®šçš„DataSourceæ¥æŸ¥æ‰¾å¯¹åº”çš„databaseldã€‚ MyBatisæä¾›äº†VendorDatabaseldProviderå’ŒDefaukDatabaseldProviderä¸¤ä¸ªå®ç°ï¼Œå…¶ä¸­DefaultDatabaseldProviderå·±è¿‡æ—¶ã€‚ VendorDatabaseIdProvider.getDatabaseId()æ–¹æ³•åœ¨æ¥æ”¶åˆ°DataSourceå¯¹è±¡æ—¶ï¼Œä¼šå…ˆè§£æDataSourceæ‰€è¿æ¥çš„æ•°æ®åº“äº§å“åç§°ï¼Œä¹‹åæ ¹æ®&lt;databaseIdProvider&gt;èŠ‚ç‚¹é…ç½®çš„æ•°æ®åº“äº§å“åç§°ä¸databaseldçš„å¯¹åº”å…³ç³»ç¡®å®šæœ€ç»ˆçš„databaseldã€‚ private String getDatabaseName(DataSource dataSource) throws SQLException &#123; // è§£æDataSourceè¿æ¥çš„æ•°æ®åº“äº§å“çš„åç§° String productName = getDatabaseProductName(dataSource); if (this.properties != null) &#123; for (Map.Entry&lt;Object, Object&gt; property : properties.entrySet()) &#123; if (productName.contains((String) property.getKey())) &#123; return (String) property.getValue(); &#125; &#125; // no match, return null return null; &#125; return productName;&#125;private String getDatabaseProductName(DataSource dataSource) throws SQLException &#123; Connection con = null; try &#123; con = dataSource.getConnection(); DatabaseMetaData metaData = con.getMetaData(); return metaData.getDatabaseProductName(); &#125; finally &#123; if (con != null) &#123; try &#123; con.close(); &#125; catch (SQLException e) &#123; // ignored &#125; &#125; &#125;&#125; è§£æ&lt;mappers&gt;èŠ‚ç‚¹ åœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œé™¤äº†åŠ è½½mybatis-config.xmlé…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½å…¨éƒ¨çš„æ˜ å°„é…ç½®æ–‡ä»¶ï¼Œmybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­çš„&lt;mappers&gt;èŠ‚ç‚¹ä¼šå‘Šè¯‰MyBatiså»å“ªäº›ä½ç½®æŸ¥æ‰¾æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠä½¿ç”¨äº†é…ç½®æ³¨è§£æ ‡è¯†çš„æ¥å£ã€‚XMLConfigBuilder.mapperElement()æ–¹æ³•è´Ÿè´£è§£æ&lt;mappers&gt;èŠ‚ç‚¹ï¼Œå®ƒä¼šåˆ›å»ºXMLMapperBuilderå¯¹è±¡åŠ è½½æ˜ å°„æ–‡ä»¶ï¼Œå¦‚æœæ˜ å°„é…ç½®æ–‡ä»¶å­˜åœ¨ç›¸åº”çš„Mapperæ¥å£ï¼Œä¹Ÿä¼šåŠ è½½ç›¸åº”çš„Mapperæ¥å£ï¼Œè§£æå…¶ä¸­çš„æ³¨è§£å¹¶å®Œæˆå‘MapperRegistryçš„æ³¨å†Œã€‚ private void mapperElement(XNode parent) throws Exception &#123; if (parent != null) &#123; for (XNode child : parent.getChildren()) &#123; // å¤„ç†&lt;mappers&gt;çš„å­èŠ‚ç‚¹ if (&quot;package&quot;.equals(child.getName())) &#123; // &lt;package&gt;å­èŠ‚ç‚¹ String mapperPackage = child.getStringAttribute(&quot;name&quot;); // æ‰«ææŒ‡å®šçš„åŒ…ï¼Œå¹¶å‘MapperRegistryæ³¨å†ŒMapperæ¥å£ configuration.addMappers(mapperPackage); &#125; else &#123; // è· å–&lt;mapper&gt;èŠ‚ç‚¹çš„resourceã€urlã€classå±æ€§ï¼Œè¿™ä¸‰ä¸ªå±æ€§äº’æ–¥ String resource = child.getStringAttribute(&quot;resource&quot;); String url = child.getStringAttribute(&quot;url&quot;); String mapperClass = child.getStringAttribute(&quot;class&quot;); // å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†resourceæˆ–æ˜¯urlå±æ€§ï¼Œåˆ™åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œ // å¹¶é€šè¿‡è¯¥å¯¹è±¡è§£æresourceæˆ–æ˜¯urlå±æ€§æŒ‡å®šçš„Mapperé…ç½®æ–‡ä»¶ if (resource != null &amp;&amp; url == null &amp;&amp; mapperClass == null) &#123; ErrorContext.instance().resource(resource); InputStream inputStream = Resources.getResourceAsStream(resource); // åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶ XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments()); mapperParser.parse(); &#125; else if (resource == null &amp;&amp; url != null &amp;&amp; mapperClass == null) &#123; ErrorContext.instance().resource(url); InputStream inputStream = Resources.getUrlAsStream(url); // åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶ XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments()); mapperParser.parse(); &#125; else if (resource == null &amp;&amp; url == null &amp;&amp; mapperClass != null) &#123; // å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†classå±æ€§ï¼Œåˆ™å‘MapperRegistryæ³¨å†Œè¯¥Mapperæ¥å£ Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass); configuration.addMapper(mapperInterface); &#125; else &#123; throw new BuilderException(&quot;...&quot;); &#125; &#125; &#125; &#125;&#125; XMLMapperBuilderé€šè¿‡å¯¹XMLConfigBuilder.mapperElement()æ–¹æ³•çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼ŒXMLMapperBuilderè´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ï¼Œå®ƒç»§æ‰¿äº†BaseBuilderæŠ½è±¡ç±»ï¼Œä¹Ÿæ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚XMLMapperBuilder.parse()æ–¹æ³•æ˜¯è§£ææ˜ å°„æ–‡ä»¶çš„å…¥å£ã€‚ public void parse() &#123; // åˆ¤æ–­æ˜¯å¦å·²åŠ è½½è¿‡è¯¥æ˜ å°„æ–‡ä»¶ if (!configuration.isResourceLoaded(resource)) &#123; configurationElement(parser.evalNode(&quot;/mapper&quot;)); // å°†resourceæ·»åŠ åˆ°Configurationâ€¢loadedResourcesé›†åˆä¸­ä¿å­˜ï¼Œå®ƒæ˜¯HashSet&lt;String&gt; // ç±»å‹çš„é›†åˆï¼Œå…¶ä¸­è®°å½•äº†å·²ç»åŠ æ ½è¿‡çš„æ˜ å°„æ–‡ä»¶ã€‚ configuration.addLoadedResource(resource); bindMapperForNamespace(); &#125; // å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;resultMap&gt;èŠ‚ç‚¹ parsePendingResultMaps(); // å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;cache-ref&gt;èŠ‚ç‚¹ parsePendingCacheRefs(); // å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„SQLè¯­å¥èŠ‚ç‚¹ parsePendingStatements();&#125; XMLMapperBuilderä¹Ÿæ˜¯å°†æ¯ä¸ªèŠ‚ç‚¹çš„è§£æè¿‡ç¨‹å°è£…æˆäº†ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•ç”±XMLMapperBuilder.configurationElement()æ–¹æ³•è°ƒç”¨ã€‚ private void configurationElement(XNode context) &#123; try &#123; String namespace = context.getStringAttribute(&quot;namespace&quot;); if (namespace == null || namespace.equals(&quot;&quot;)) &#123; throw new BuilderException(&quot;Mapper&#x27;s namespace cannot be empty&quot;); &#125; builderAssistant.setCurrentNamespace(namespace); cacheRefElement(context.evalNode(&quot;cache-ref&quot;)); cacheElement(context.evalNode(&quot;cache&quot;)); parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;)); resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;)); sqlElement(context.evalNodes(&quot;/mapper/sql&quot;)); buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;)); &#125; catch (Exception e) &#123; throw new BuilderException(&quot;...&quot;); &#125;&#125; 1. è§£æ&lt;cache&gt;èŠ‚ç‚¹ MyBatisæ‹¥æœ‰éå¸¸å¼ºå¤§çš„äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œé…ç½®ï¼Œ**MyBatisé»˜è®¤æƒ…**å†µä¸‹æ²¡æœ‰å¼€å¯äºŒçº§ç¼“å­˜ï¼Œå¦‚æœè¦ä¸ºæŸå‘½åç©ºé—´å¼€å¯äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ç›¸åº”æ˜ å°„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ &lt;cache&gt;èŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥é€šè¿‡é…ç½®&lt;cache&gt;èŠ‚ç‚¹çš„ç›¸å…³å±æ€§ï¼Œä¸ºäºŒçº§ç¼“å­˜é…ç½®ç›¸åº”çš„ç‰¹æ€§(æœ¬è´¨ä¸Šå°±æ˜¯æ·»åŠ ç›¸åº”çš„è£…é¥°å™¨)ã€‚ XMLMapperBuilder.cacheElement()æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æ&lt;cache&gt;èŠ‚ç‚¹ï¼š private void cacheElement(XNode context) throws Exception &#123; if (context != null) &#123; String type = context.getStringAttribute(&quot;type&quot;, &quot;PERPETUAL&quot;); Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type); String eviction = context.getStringAttribute(&quot;eviction&quot;, &quot;LRU&quot;); Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction); Long flushInterval = context.getLongAttribute(&quot;flushInterval&quot;); Integer size = context.getIntAttribute(&quot;size&quot;); boolean readWrite = !context.getBooleanAttribute(&quot;readOnly&quot;, false); boolean blocking = context.getBooleanAttribute(&quot;blocking&quot;, false); Properties props = context.getChildrenAsProperties(); builderAssistant.useNewCache( typeClass, evictionClass, flushInterval, size, readWrite, blocking, props); &#125;&#125; MapperBuilderAssistantæ˜¯ä¸€ä¸ªè¾…åŠ©ç±»ï¼Œå…¶useNewCache()æ–¹æ³•è´Ÿè´£åˆ›å»ºCacheå¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°Configuration.cachesé›†åˆä¸­ä¿å­˜ã€‚ Configurationä¸­çš„cacheså­—æ®µæ˜¯StrictMap&lt;Cache&gt;ç±»å‹çš„å­—æ®µï¼Œå®ƒè®°å½•Cacheçš„id(é»˜è®¤æ˜¯æ˜ å°„æ–‡ä»¶çš„namespace)ä¸Cacheå¯¹è±¡(äºŒçº§ç¼“å­˜)ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ StrictMapç»§æ‰¿äº†HashMap,å¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†å°‘è®¸ä¿®æ”¹ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨StrictMap.put()æ–¹æ³•ï¼Œå¦‚æœæ£€æµ‹åˆ°é‡å¤çš„keyåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰é‡å¤çš„keyåˆ™æ·»åŠ keyä»¥åŠvalueï¼ŒåŒæ—¶ä¼šæ ¹æ®keyäº§ç”ŸshortKeyã€‚ public V put(String key, V value) &#123; if (containsKey(key)) &#123; // å¦‚æœå·²ç»åŒ…å«äº†è¯¥keyï¼Œåˆ™ç›´æ¥è¿”å›å¼‚å¸¸ throw new IllegalArgumentException(name + &quot; already contains value for &quot; + key); &#125; if (key.contains(&quot;.&quot;)) &#123; // æŒ‰ç…§å°†keyåˆ‡åˆ†æˆæ•°ç»„ï¼Œå¹¶å°†æ•°ç»„çš„æœ€åä¸€é¡¹ä½œä¸ºshortKey final String shortKey = getShortName(key); if (super.get(shortKey) == null) &#123; // å¦‚æœä¸åŒ…å«æŒ‡å®šçš„sortKeyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹ super.put(shortKey, value); &#125; else &#123; // å¦‚æœshortKeyå·²å­˜åœ¨ï¼Œåˆ™å°†valueä¿®æ”¹æˆAmbiguityå¯¹è±¡ super.put(shortKey, (V) new Ambiguity(shortKey)); &#125; &#125; return super.put(key, value); // å¦‚æœä¸åŒ…å«è¯¥keyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹&#125; Ambiguityæ˜¯StrictMapä¸­å®šä¹‰çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å­˜åœ¨äºŒä¹‰æ€§çš„é”®å€¼å¯¹ã€‚Ambiguityä¸­ä½¿ç”¨subjectå­—æ®µè®°å½•äº†å­˜åœ¨äºŒä¹‰æ€§çš„keyï¼Œå¹¶æä¾›äº†ç›¸åº”çš„getteræ–¹æ³•ã€‚ StrictMap.get()æ–¹æ³•ä¼šæ£€æµ‹valueæ˜¯å¦å­˜åœ¨ä»¥åŠvalueæ˜¯å¦ä¸ºAmbiguityç±»å‹å¯¹è±¡ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ public V get(Object key) &#123; V value = super.get(key); if (value == null) &#123; // å¦‚æœkeyæ²¡æœ‰å¯¹åº”çš„valueï¼Œå°±æŠ¥é”™ throw new IllegalArgumentException(&quot;...&quot;); &#125; if (value instanceof Ambiguity) &#123; throw new IllegalArgumentException(&quot;...&quot;); &#125; return value;&#125; MapperBuilderAssistant. useNewCache()æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š public Cache useNewCache(Class&lt;? extends Cache&gt; typeClass, Class&lt;? extends Cache&gt; evictionClass, Long flushInterval, Integer size, boolean readWrite, boolean blocking, Properties props) &#123; Cache cache = new CacheBuilder(currentNamespace) .implementation(valueOrDefault(typeClass, PerpetualCache.class)) .addDecorator(valueOrDefault(evictionClass, LruCache.class)) .clearInterval(flushInterval) .size(size) .readWrite(readWrite) .blocking(blocking) .properties(props) .build(); configuration.addCache(cache); currentCache = cache; return cache;&#125; CacheBuilderæ˜¯Cacheçš„å»ºé€ è€…ï¼Œå…¶å­—æ®µå¦‚ä¸‹ï¼š // å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯¹åº”çš„æ˜¯æ˜ å°„æ–‡ä»¶ä¸­é…ç½®çš„namespaceprivate final String id;// Cacheå¯¹è±¡çš„çœŸæ­£å®ç°ç±»private Class&lt;? extends Cache&gt; implementation;// è£…é¥°å™¨é›†åˆprivate final List&lt;Class&lt;? extends Cache&gt;&gt; decorators;// ç¼“å­˜å¤§å°private Integer size;// æ¸…ç†æ—¶é—´å‘¨æœŸprivate Long clearInterval;// æ˜¯å¦å¯è¯»å†™private boolean readWrite;// å…¶ä»–é…ç½®ä¿¡æ¯private Properties properties;// æ˜¯å¦é˜»å¡private boolean blocking; CacheBuilder.build()æ–¹æ³•ï¼Œæ ¹æ®CacheBuilderä¸­ä¸Šè¿°å­—æ®µçš„å€¼åˆ›å»ºCacheå¯¹è±¡å¹¶æ·»åŠ åˆé€‚çš„è£…é¥°å™¨ã€‚ public Cache build() &#123; setDefaultImplementations(); Cache cache = newBaseCacheInstance(implementation, id); setCacheProperties(cache); // issue #352, do not apply decorators to custom caches if (PerpetualCache.class.equals(cache.getClass())) &#123; for (Class&lt;? extends Cache&gt; decorator : decorators) &#123; cache = newCacheDecoratorInstance(decorator, cache); setCacheProperties(cache); &#125; cache = setStandardDecorators(cache); &#125; else if (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123; cache = new LoggingCache(cache); &#125; return cache;&#125; CacheBuilder.setCacheProperties()æ–¹æ³•ä¼šæ ¹æ®&lt;cache&gt;èŠ‚ç‚¹ä¸‹é…ç½®çš„&lt;property&gt;ä¿¡æ¯ï¼Œåˆå§‹åŒ–Cacheå¯¹è±¡ã€‚ private void setCacheProperties(Cache cache) &#123; if (properties != null) &#123; MetaObject metaCache = SystemMetaObject.forObject(cache); for (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123; String name = (String) entry.getKey(); String value = (String) entry.getValue(); if (metaCache.hasSetter(name)) &#123; Class&lt;?&gt; type = metaCache.getSetterType(name); if (String.class == type) &#123; metaCache.setValue(name, value); &#125; else if (int.class == type || Integer.class == type) &#123; metaCache.setValue(name, Integer.valueOf(value)); &#125; else if (long.class == type || Long.class == type) &#123; metaCache.setValue(name, Long.valueOf(value)); &#125; else if (short.class == type || Short.class == type) &#123; metaCache.setValue(name, Short.valueOf(value)); &#125; else if (byte.class == type || Byte.class == type) &#123; metaCache.setValue(name, Byte.valueOf(value)); &#125; else if (float.class == type || Float.class == type) &#123; metaCache.setValue(name, Float.valueOf(value)); &#125; else if (boolean.class == type || Boolean.class == type) &#123; metaCache.setValue(name, Boolean.valueOf(value)); &#125; else if (double.class == type || Double.class == type) &#123; metaCache.setValue(name, Double.valueOf(value)); &#125; else &#123; throw new CacheException(&quot;...&quot;); &#125; &#125; &#125; &#125; if (InitializingObject.class.isAssignableFrom(cache.getClass()))&#123; try &#123; ((InitializingObject) cache).initialize(); &#125; catch (Exception e) &#123; throw new CacheException(&quot;...&quot;, e); &#125; &#125;&#125; CacheBuilder.setStandardDecorators()æ–¹æ³•ä¼šæ ¹æ®CacheBuilderä¸­å„ä¸ªå­—æ®µçš„å€¼ï¼Œä¸ºcacheå¯¹è±¡æ·»åŠ å¯¹åº”çš„è£…é¥°å™¨ã€‚ private Cache setStandardDecorators(Cache cache) &#123; try &#123; MetaObject metaCache = SystemMetaObject.forObject(cache); if (size != null &amp;&amp; metaCache.hasSetter(&quot;size&quot;)) &#123; metaCache.setValue(&quot;size&quot;, size); &#125; if (clearInterval != null) &#123; cache = new ScheduledCache(cache); ((ScheduledCache) cache).setClearInterval(clearInterval); &#125; if (readWrite) &#123; cache = new SerializedCache(cache); &#125; cache = new LoggingCache(cache); cache = new SynchronizedCache(cache); if (blocking) &#123; cache = new BlockingCache(cache); &#125; return cache; &#125; catch (Exception e) &#123; throw new CacheException(&quot;...&quot;, e); &#125;&#125; 2. è§£æ&lt;cache-ref&gt;èŠ‚ç‚¹ XMLMapperBuilder.cacheElement()æ–¹æ³•ä¼šä¸ºæ¯ä¸ªnamespaceåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„Cacheå¯¹è±¡ï¼Œå¹¶åœ¨Configuration.cachesé›†åˆä¸­è®°å½•namespaceä¸Cacheå¯¹è±¡ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ å¦‚æœå¸Œæœ›å¤šä¸ªnamespaceå…±ç”¨åŒä¸€ä¸ªäºŒçº§ç¼“å­˜ï¼Œå³åŒä¸€ä¸ªCacheå¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨&lt;cache-ref&gt;ç‚¹è¿›è¡Œé…ç½®ã€‚ XMLMapperBuilder.cacheReffilement()æ–¹æ³•è´Ÿè´£è§£æ&lt;cache-ref&gt;èŠ‚ç‚¹ã€‚ è¿™é‡Œé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯Configuration.cacheRefMapé›†åˆï¼Œè¯¥é›†åˆæ˜¯HashMap&lt;Stringï¼ŒString&gt;ç±»å‹ï¼Œå…¶ä¸­keyæ˜¯&lt;cache-ref&gt;èŠ‚ç‚¹æ‰€åœ¨çš„namespaceï¼Œvalueæ˜¯&lt;cache-ref&gt;èŠ‚ç‚¹çš„namespaceå±æ€§æ‰€æŒ‡å®šçš„namespaceã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰è€…å…±ç”¨åè€…çš„Cacheå¯¹è±¡ï¼Œå¦‚ä¸‹å›¾ï¼Œnamespace2å…±ç”¨äº†namespace1çš„Cacheå¯¹è±¡ã€‚ XMLMapperBuilder.cacheReffilement()ï¼š private void cacheRefElement(XNode context) &#123; if (context != null) &#123; configuration.addCacheRef( builderAssistant.getCurrentNamespace(), context.getStringAttribute(&quot;namespace&quot;)); CacheRefResolver cacheRefResolver = new CacheRefResolver( builderAssistant, context.getStringAttribute(&quot;namespace&quot;)); try &#123; cacheRefResolver.resolveCacheRef(); &#125; catch (IncompleteElementException e) &#123; //å¦‚æœè§£æè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™æ·»åŠ åˆ°Configuration.incompleteCacheRefsé›†åˆï¼Œç¨åå†è§£æ configuration.addIncompleteCacheRef(cacheRefResolver); &#125; &#125;&#125; CacheRefResolveræ˜¯ä¸€ä¸ªç®€å•çš„Cacheå¼•ç”¨è§£æå™¨ï¼Œå…¶ä¸­å°è£…äº†è¢«å¼•ç”¨çš„namespaceä»¥åŠå½“å‰XMLMapperBuilderå¯¹åº”çš„MapperBuilderAssistantå¯¹è±¡ã€‚ CacheRefResolver.resolveCacheRef()æ–¹æ³•ä¼šè°ƒç”¨MapperBuilderAssistant.useCacheRef()æ–¹æ³•ã€‚åœ¨MapperBuilderAssistant.useCacheRef()æ–¹æ³•ä¸­ä¼šé€šè¿‡namespaceæŸ¥æ‰¾è¢«å¼•ç”¨çš„Cacheå¯¹è±¡ã€‚ public Cache useCacheRef(String namespace) &#123; if (namespace == null) &#123; throw new BuilderException(&quot;...&quot;); &#125; try &#123; unresolvedCacheRef = true; Cache cache = configuration.getCache(namespace); if (cache == null) &#123; throw new IncompleteElementException(&quot;...&quot;); &#125; currentCache = cache; unresolvedCacheRef = false; return cache; &#125; catch (IllegalArgumentException e) &#123; throw new IncompleteElementException(&quot;...&quot;, e); &#125; &#125; å¦ä¸€ä¸ªéœ€è¦äº†è§£çš„Configurationå­—æ®µæ˜¯incompleteCacheRefsé›†åˆï¼Œå®ƒæ˜¯LinkedList&lt;CacheRefResolver&gt;ç±»å‹ï¼Œå…¶ä¸­è®°å½•äº†å½“å‰è§£æå‡ºç°å¼‚å¸¸çš„CacheRefResolverå¯¹è±¡ã€‚ 3. è§£æ&lt;resultMap&gt;èŠ‚ç‚¹ selectè¯­å¥æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†æ˜¯ä¸€å¼ äºŒç»´è¡¨ï¼Œæ°´å¹³æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€ä¸ªä¸ªå­—æ®µï¼Œå‚ç›´æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€æ¡æ¡è®°å½•ã€‚ è€ŒJavaæ˜¯é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå¯¹è±¡æ˜¯æ ¹æ®ç±»å®šä¹‰åˆ›å»ºçš„ï¼Œç±»ä¹‹é—´çš„å¼•ç”¨å…³ç³»å¯ä»¥è®¤ä¸ºæ˜¯åµŒå¥—çš„ç»“æ„ã€‚ åœ¨JDBCç¼–ç¨‹ä¸­ï¼Œä¸ºäº†å°†ç»“æœé›†ä¸­çš„æ•°æ®æ˜ å°„æˆå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å†™ä»£ç ä»ç»“æœé›†ä¸­è·å–æ•°æ®ï¼Œç„¶åå°è£…æˆå¯¹åº”çš„å¯¹è±¡å¹¶è®¾ç½®å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œè¿™äº›éƒ½æ˜¯å¤§é‡çš„é‡å¤æ€§ä»£ç ã€‚ ä¸ºäº†å‡å°‘è¿™äº›é‡å¤çš„ä»£ç ï¼ŒMyBatisä½¿ç”¨&lt;resultMap&gt;èŠ‚ç‚¹å®šä¹‰äº†ç»“æœé›†ä¸ç»“æœå¯¹è±¡(JavaBeanå¯¹è±¡)ä¹‹é—´çš„æ˜ å°„è§„åˆ™ï¼Œ&lt;resultMap&gt;èŠ‚ç‚¹å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†çš„æ˜ å°„éœ€æ±‚ï¼Œä»è€Œå‡å°‘å¼€å‘äººå‘˜çš„é‡å¤æ€§åŠ³åŠ¨ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚ æ¯ä¸ªResultMappingå¯¹è±¡è®°å½•äº†ç»“æœé›†ä¸­çš„ä¸€åˆ—ä¸JavaBeanä¸­ä¸€ä¸ªå±æ€§ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚&lt;resultMap&gt;èŠ‚ç‚¹ä¸‹é™¤äº†&lt;discriminator&gt;å­èŠ‚ç‚¹çš„å…¶ä»–å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šè¢«è§£ææˆå¯¹åº”çš„ResultMappingå¯¹è±¡ã€‚æ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š // Configurationå¯¹è±¡private Configuration configuration;// åº” èŠ‚ ç‚¹çš„propertyå± æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸ è¯¥ åˆ—è¿› è¡Œæ˜ å°„çš„å± æ€§private String property;// æ•°æ®åº“è·å–çš„åˆ—åæˆ–åˆ«åprivate String column;// å¯¹åº”çš„javaç±»å‹ï¼ŒJavaBeançš„å®Œå…¨é™å®šåprivate Class&lt;?&gt; javaType;// JDBCç±»å‹private JdbcType jdbcType;// å¯¹åº”èŠ‚ç‚¹çš„typeHandlerå±æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ç±»å‹å¤„ç†å™¨ï¼Œå®ƒä¼šè¦†ç›–é»˜è®¤çš„ç±»å‹å¤„ç†å™¨ï¼Œåé¢ä¼šä»‹ç»è¯¥å­—æ®µçš„ä½œç”¨private TypeHandler&lt;?&gt; typeHandler;// å¯¹åº”èŠ‚ç‚¹çš„resultMapå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;resultMap&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒè´Ÿè´£å°†ç»“æœé›†ä¸­çš„ä¸€éƒ¨// åˆ†åˆ—æ˜ å°„æˆå…¶ä»–å…³è”çš„ç»“æœå¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡joinæ–¹å¼è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œç„¶åç›´æ¥æ˜ å°„æˆå¤šä¸ªå¯¹è±¡ï¼Œ// å¹¶åŒæ—¶è®¾ç½®è¿™äº›å¯¹è±¡ä¹‹é—´çš„ç»„åˆå…³ç³»private String nestedResultMapId;// å¯¹åº”èŠ‚ç‚¹çš„selectå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;select&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒä¼šæŠŠæŒ‡å®šçš„åˆ—çš„å€¼ä¼ å…¥// selectå±æ€§æŒ‡å®šçš„selectè¯­å¥ä¸­ä½œä¸ºå‚æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚ä½¿ç”¨selectå±æ€§å¯èƒ½ä¼šå¯¼è‡´N+1é—®é¢˜private String nestedQueryId;// éç©ºå­—æ®µé›†åˆprivate Set&lt;String&gt; notNullColumns;// private String columnPrefix;//private List&lt;ResultFlag&gt; flags;//private List&lt;ResultMapping&gt; composites;//private String resultSet;// private String foreignColumn;// æ˜¯å¦å»¶è¿ŸåŠ è½½private boolean lazy; ResultMappingä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨Builderç±»ï¼Œä¹Ÿåº”ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¯¥Builderç±»ä¸»è¦ç”¨äºæ•°æ®æ•´ç†å’Œæ•°æ®æ ¡éªŒæ ¡éªŒã€‚ å¦ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»æ˜¯ResultMapï¼Œæ¯ä¸ª&lt;resultMap&gt;èŠ‚ç‚¹éƒ½ä¼šè¢«è§£ææˆä¸€ä¸ªResultMapå¯¹è±¡ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ‰€å®šä¹‰çš„æ˜ å°„å…³ç³»ï¼Œåˆ™ä½¿ç”¨ResultMappingå¯¹è±¡è¡¨ç¤ºã€‚ ResultMapå­—æ®µå®šä¹‰ï¼š // Configurationå¯¹è±¡private Configuration configuration;// å¯¹åº”èŠ‚ç‚¹çš„idå±æ€§private String id;// å¯¹åº”èŠ‚ç‚¹çš„typeå±æ€§private Class&lt;?&gt; type;// ResultMappingå¯¹è±¡é›†åˆprivate List&lt;ResultMapping&gt; resultMappings;// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰IDæ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;id&gt;èŠ‚ç‚¹å’Œ&lt;constructor&gt;èŠ‚ç‚¹çš„&lt;idArg&gt;å­èŠ‚ç‚¹private List&lt;ResultMapping&gt; idResultMappings;// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;constructor&gt;æ‰€æœ‰å­å…ƒç´ private List&lt;ResultMapping&gt; constructorResultMappings;// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­ä¸å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»private List&lt;ResultMapping&gt; propertyResultMappings;// è®°å½•æ‰€æœ‰æ˜ å°„å…³ç³»ä¸­æ¶‰åŠçš„columnå±æ€§çš„é›†åˆprivate Set&lt;String&gt; mappedColumns;//private Set&lt;String&gt; mappedProperties;// é‰´åˆ«å™¨private Discriminator discriminator;// æ˜¯å¦å«æœ‰åµŒå¥—çš„ç»“æœæ˜ å°„ï¼Œå¦‚æœæŸä¸ªæ˜ å°„å…³ç³»ä¸­å­˜åœ¨resultMapå±æ€§ï¼Œä¸”ä¸å­˜åœ¨resultSetå±æ€§ï¼Œåˆ™ä¸ºtrueprivate boolean hasNestedResultMaps;// æ˜¯å¦å«æœ‰åµŒå¥—æŸ¥è¯¢ï¼Œå¦‚æœæŸä¸ªå±æ€§æ˜ å°„å­˜åœ¨selectå±æ€§ï¼Œåˆ™ä¸ºtrueprivate boolean hasNestedQueries;// æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„private Boolean autoMapping; åœ¨XMLMapperBuilderä¸­é€šè¿‡resultMapElements()æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„å…¨éƒ¨&lt;resultMap&gt;èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨resultMapElement()æ–¹æ³•å¤„ç†æ¯ä¸ª&lt;resultMap&gt;èŠ‚ç‚¹ã€‚ private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings) throws Exception &#123; ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier()); String id = resultMapNode.getStringAttribute( &quot;id&quot;, resultMapNode.getValueBasedIdentifier()); String type = resultMapNode.getStringAttribute( &quot;type&quot;,resultMapNode.getStringAttribute( &quot;ofType&quot;,resultMapNode.getStringAttribute(&quot;resultType&quot;, resultMapNode.getStringAttribute(&quot;javaType&quot;)))); String extend = resultMapNode.getStringAttribute(&quot;extends&quot;); Boolean autoMapping = resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;); Class&lt;?&gt; typeClass = resolveClass(type); Discriminator discriminator = null; List&lt;ResultMapping&gt; resultMappings = new ArrayList&lt;ResultMapping&gt;(); resultMappings.addAll(additionalResultMappings); List&lt;XNode&gt; resultChildren = resultMapNode.getChildren(); for (XNode resultChild : resultChildren) &#123; if (&quot;constructor&quot;.equals(resultChild.getName())) &#123; processConstructorElement(resultChild, typeClass, resultMappings); &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123; discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings); &#125; else &#123; List&lt;ResultFlag&gt; flags = new ArrayList&lt;ResultFlag&gt;(); if (&quot;id&quot;.equals(resultChild.getName())) &#123; flags.add(ResultFlag.ID); &#125; resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags)); &#125; &#125; ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping); try &#123; return resultMapResolver.resolve(); &#125; catch (IncompleteElementException e) &#123; configuration.addIncompleteResultMap(resultMapResolver); throw e; &#125;&#125; åœ¨å¤„ç†&lt;resultMap&gt;èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥è¿‡ç¨‹åœ¨æ‰§è¡Œè·å–åˆ°idå±æ€§å’Œtypeå±æ€§ä¹‹åï¼Œå°±ä¼šé€šè¿‡XMLMapperBuilder.buildResultMappingFromContext()æ–¹æ³•ä¸º&lt;result&gt;èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„ResultMappingå¯¹è±¡ã€‚ private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) throws Exception &#123; String property; // è·å–propertyçš„å±æ€§å€¼ if (flags.contains(ResultFlag.CONSTRUCTOR)) &#123; property = context.getStringAttribute(&quot;name&quot;); &#125; else &#123; property = context.getStringAttribute(&quot;property&quot;); &#125; String column = context.getStringAttribute(&quot;column&quot;); String javaType = context.getStringAttribute(&quot;javaType&quot;); String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;); String nestedSelect = context.getStringAttribute(&quot;select&quot;); String nestedResultMap = context.getStringAttribute( &quot;resultMap&quot;,processNestedResultMappings(context, Collections.&lt;ResultMapping&gt;emptyList())); String notNullColumn = context.getStringAttribute(&quot;notNullColumn&quot;); String columnPrefix = context.getStringAttribute(&quot;columnPrefix&quot;); String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;); String resultSet = context.getStringAttribute(&quot;resultSet&quot;); String foreignColumn = context.getStringAttribute(&quot;foreignColumn&quot;); boolean lazy = &quot;lazy&quot;.equals( context.getStringAttribute(&quot;fetchType&quot;, configuration.isLazyLoadingEnabled() ? &quot;lazy&quot; : &quot;eager&quot;)); Class&lt;?&gt; javaTypeClass = resolveClass(javaType); @SuppressWarnings(&quot;unchecked&quot;) Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler); JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType); return builderAssistant.buildResultMapping( resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);&#125; MapperBuilderAssistant.buildResultMapping()çš„å…·ä½“å®ç°ï¼š public ResultMapping buildResultMapping( Class&lt;?&gt; resultType, String property, String column, Class&lt;?&gt; javaType, JdbcType jdbcType, String nestedSelect, String nestedResultMap, String notNullColumn, String columnPrefix, Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler, List&lt;ResultFlag&gt; flags, String resultSet, String foreignColumn, boolean lazy) &#123; Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType); TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler); List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column); return new ResultMapping.Builder(configuration, property, column, javaTypeClass) .jdbcType(jdbcType) .nestedQueryId(applyCurrentNamespace(nestedSelect, true)) .nestedResultMapId(applyCurrentNamespace(nestedResultMap, true)) .resultSet(resultSet) .typeHandler(typeHandlerInstance) .flags(flags == null ? new ArrayList&lt;ResultFlag&gt;() : flags) .composites(composites) .notNullColumns(parseMultipleColumnNames(notNullColumn)) .columnPrefix(columnPrefix) .foreignColumn(foreignColumn) .lazy(lazy) .build();&#125; å¾—åˆ°ResultMappingå¯¹è±¡é›†åˆä¹‹åï¼Œä¼šè°ƒç”¨ResultMapResolver.resolve()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨MapperBuilderAssistant.addResultMap()æ–¹æ³•åˆ›å»ºResultMapå¯¹è±¡ï¼Œå¹¶å°†ResultMapå¯¹è±¡æ·»åŠ åˆ°Configuration.resultMapsé›†åˆä¸­ä¿å­˜ã€‚ public ResultMap addResultMap( String id, Class&lt;?&gt; type, String extend, Discriminator discriminator, List&lt;ResultMapping&gt; resultMappings, Boolean autoMapping) &#123; id = applyCurrentNamespace(id, false); extend = applyCurrentNamespace(extend, true); if (extend != null) &#123; if (!configuration.hasResultMap(extend)) &#123; throw new IncompleteElementException(&quot;...&quot;); &#125; ResultMap resultMap = configuration.getResultMap(extend); List&lt;ResultMapping&gt; extendedResultMappings = new ArrayList&lt;ResultMapping&gt;(resultMap.getResultMappings()); extendedResultMappings.removeAll(resultMappings); // Remove parent constructor if this resultMap declares a constructor. boolean declaresConstructor = false; for (ResultMapping resultMapping : resultMappings) &#123; if (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123; declaresConstructor = true; break; &#125; &#125; if (declaresConstructor) &#123; Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator(); while (extendedResultMappingsIter.hasNext()) &#123; if (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123; extendedResultMappingsIter.remove(); &#125; &#125; &#125; resultMappings.addAll(extendedResultMappings); &#125; ResultMap resultMap = new ResultMap.Builder(configuration, id, type, resultMappings, autoMapping) .discriminator(discriminator) .build(); configuration.addResultMap(resultMap); return resultMap;&#125; &lt;constructor&gt;èŠ‚ç‚¹çš„è§£æï¼Œç”±XMLMapperBuilder.processConstructorElement()æ–¹æ³•å®Œæˆã€‚ private void processConstructorElement(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings) throws Exception &#123; List&lt;XNode&gt; argChildren = resultChild.getChildren(); for (XNode argChild : argChildren) &#123; List&lt;ResultFlag&gt; flags = new ArrayList&lt;ResultFlag&gt;(); flags.add(ResultFlag.CONSTRUCTOR); if (&quot;idArg&quot;.equals(argChild.getName())) &#123; flags.add(ResultFlag.ID); &#125; resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags)); &#125;&#125; ä¹‹åä¼šè§£æ&lt;association&gt;èŠ‚ç‚¹ï¼Œæ­£å¦‚å‰é¢å¯¹XMLMapperBuilder.resultMapElement()æ–¹æ³•çš„ä»‹ç»ï¼Œ&lt;association&gt;èŠ‚ç‚¹ä¹Ÿæ˜¯åœ¨XMLMapperBuilder.buildResultMappingFromContext()æ–¹æ³•ä¸­å®Œæˆè§£æçš„ã€‚ &lt;discriminator&gt;èŠ‚ç‚¹çš„è§£æï¼Œè¯¥è§£æè¿‡ç¨‹ç”±XMLMapperBuilder.processDiscriminatorElement()æ–¹æ³•å®Œæˆã€‚ private Discriminator processDiscriminatorElement(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings) throws Exception &#123; String column = context.getStringAttribute(&quot;column&quot;); String javaType = context.getStringAttribute(&quot;javaType&quot;); String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;); String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;); Class&lt;?&gt; javaTypeClass = resolveClass(javaType); @SuppressWarnings(&quot;unchecked&quot;) Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler); JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType); Map&lt;String, String&gt; discriminatorMap = new HashMap&lt;String, String&gt;(); for (XNode caseChild : context.getChildren()) &#123; String value = caseChild.getStringAttribute(&quot;value&quot;); String resultMap = caseChild.getStringAttribute(&quot;resultMap&quot;, processNestedResultMappings(caseChild, resultMappings)); discriminatorMap.put(value, resultMap); &#125; return builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);&#125; 4. è§£æ&lt;sql&gt;èŠ‚ç‚¹ XMLMapperBuilder.sqlElement()æ–¹æ³•è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨éƒ¨&lt;sql&gt;èŠ‚ç‚¹ã€‚ private void sqlElement(List&lt;XNode&gt; list) throws Exception &#123; if (configuration.getDatabaseId() != null) &#123; sqlElement(list, configuration.getDatabaseId()); &#125; sqlElement(list, null);&#125;private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) throws Exception &#123; for (XNode context : list) &#123; String databaseId = context.getStringAttribute(&quot;databaseId&quot;); String id = context.getStringAttribute(&quot;id&quot;); id = builderAssistant.applyCurrentNamespace(id, false); if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123; sqlFragments.put(id, context); &#125; &#125;&#125; XMLStatementBuilderé™¤äº†èŠ‚ç‚¹è§£æï¼Œæ˜ å°„æ–‡ä»¶ä¸­è¿˜æœ‰ä¸€ç±»æ¯”è¾ƒé‡è¦çš„èŠ‚ç‚¹éœ€è¦è§£æï¼Œä¹Ÿå°±æ˜¯SQLèŠ‚ç‚¹ã€‚SQLèŠ‚ç‚¹ä¸»è¦ç”¨äºå®šä¹‰SQLè¯­å¥ï¼ŒSQLèŠ‚ç‚¹ç”±XMLStatementBuilderè´Ÿè´£è§£æã€‚ MyBatisä½¿ç”¨SqlSourceæ¥å£è¡¨ç¤ºæ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£ä¸­å®šä¹‰çš„SQLè¯­å¥ï¼Œä½†å®ƒè¡¨ç¤ºçš„SQLè¯­å¥æ˜¯ä¸èƒ½ç›´æ¥è¢«æ•°æ®åº“æ‰§è¡Œçš„ï¼Œå› ä¸ºå…¶ä¸­å¯èƒ½å«æœ‰åŠ¨æ€SQLè¯­å¥ç›¸å…³çš„èŠ‚ç‚¹æˆ–æ˜¯å ä½ç¬¦ç­‰éœ€è¦è§£æçš„å…ƒç´ ã€‚ public interface SqlSource &#123; // getBoundSql()æ–¹æ³•ä¼šæ ¹æ®æ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£æè¿°çš„SQLè¯­å¥ï¼Œä»¥åŠä¼ å…¥çš„å‚æ•°ï¼Œè¿”å›å¯æ‰§è¡Œçš„SQL BoundSql getBoundSql(Object parameterObject);&#125; MyBatisä½¿ç”¨MappedStatementè¡¨ç¤ºæ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„SQLèŠ‚ç‚¹ï¼ŒMappedStatementåŒ…å«äº†è¿™äº›èŠ‚ç‚¹çš„å¾ˆå¤šå±æ€§ã€‚ // idå±æ€§private String resource;private Configuration configuration;private String id;private Integer fetchSize;private Integer timeout;private StatementType statementType;private ResultSetType resultSetType;// å¯¹åº”ä¸€æ¡sqlè¯­å¥private SqlSource sqlSource;private Cache cache;private ParameterMap parameterMap;private List&lt;ResultMap&gt; resultMaps;private boolean flushCacheRequired;private boolean useCache;private boolean resultOrdered;// sqlç±»å‹private SqlCommandType sqlCommandType;private KeyGenerator keyGenerator;private String[] keyProperties;private String[] keyColumns;private boolean hasNestedResultMaps;private String databaseId;private Log statementLog;private LanguageDriver lang;private String[] resultSets; XMLStatementBuilder.parseStatementNode()æ–¹æ³•æ˜¯è§£æSQLèŠ‚ç‚¹çš„å…¥å£å‡½æ•°ã€‚ public void parseStatementNode() &#123; String id = context.getStringAttribute(&quot;id&quot;); String databaseId = context.getStringAttribute(&quot;databaseId&quot;); if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123; return; &#125; Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;); Integer timeout = context.getIntAttribute(&quot;timeout&quot;); String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;); String parameterType = context.getStringAttribute(&quot;parameterType&quot;); Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType); String resultMap = context.getStringAttribute(&quot;resultMap&quot;); String resultType = context.getStringAttribute(&quot;resultType&quot;); String lang = context.getStringAttribute(&quot;lang&quot;); LanguageDriver langDriver = getLanguageDriver(lang); Class&lt;?&gt; resultTypeClass = resolveClass(resultType); String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;); StatementType statementType = StatementType.valueOf( context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString())); ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType); // æ ¹æ®èŠ‚ç‚¹åç§°å†³å®šSqlCommandType String nodeName = context.getNode().getNodeName(); SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH)); boolean isSelect = sqlCommandType == SqlCommandType.SELECT; boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect); boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect); boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false); // Include Fragments before parsing XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant); includeParser.applyIncludes(context.getNode()); // Parse selectKey after includes and remove them. processSelectKeyNodes(id, parameterTypeClass, langDriver); // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed) SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass); String resultSets = context.getStringAttribute(&quot;resultSets&quot;); String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;); String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;); KeyGenerator keyGenerator; String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX; keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true); if (configuration.hasKeyGenerator(keyStatementId)) &#123; keyGenerator = configuration.getKeyGenerator(keyStatementId); &#125; else &#123; keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;, configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType)) ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE; &#125; builderAssistant.addMappedStatement( id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,resultSetTypeEnum, flushCache, useCache, resultOrdered, keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);&#125; 1. è§£æ&lt;include&gt;èŠ‚ç‚¹ åœ¨è§£æSQLèŠ‚ç‚¹ä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡XMLIncludeTransformerè§£æSQLè¯­å¥ä¸­çš„&lt;include&gt;èŠ‚ç‚¹ï¼Œè¯¥è¿‡ç¨‹ä¼šå°†&lt;include&gt;èŠ‚ç‚¹æ›¿æ¢æˆ&lt;sql&gt;èŠ‚ç‚¹ä¸­å®šä¹‰çš„SQLç‰‡æ®µï¼Œå¹¶å°†å…¶ä¸­çš„$&#123;xxx&#125;å ä½ç¬¦æ›¿æ¢æˆçœŸå®çš„å‚æ•°ï¼Œè¯¥è§£æè¿‡ç¨‹åœ¨XMLIncludeTransformer.applyIncludes()æ–¹æ³•ä¸­å®ç°ã€‚ public void applyIncludes(Node source) &#123; // è·å–mybatis-config.xmlä¸­&lt;properties&gt;èŠ‚ç‚¹ä¸‹å®šä¹‰çš„å˜é‡é›†åˆ Properties variablesContext = new Properties(); Properties configurationVariables = configuration.getVariables(); if (configurationVariables != null) &#123; variablesContext.putAll(configurationVariables); &#125; applyIncludes(source, variablesContext, false);&#125;// å¤„ç†&lt;include&gt;èŠ‚ç‚¹çš„é‡è½½æ–¹æ³•private void applyIncludes(Node source, final Properties variablesContext, boolean included) &#123; if (source.getNodeName().equals(&quot;include&quot;)) &#123; Node toInclude = findSqlFragment(getStringAttribute(source, &quot;refid&quot;), variablesContext); Properties toIncludeContext = getVariablesContext(source, variablesContext); applyIncludes(toInclude, toIncludeContext, true); if (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123; toInclude = source.getOwnerDocument().importNode(toInclude, true); &#125; source.getParentNode().replaceChild(toInclude, source); while (toInclude.hasChildNodes()) &#123; toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude); &#125; toInclude.getParentNode().removeChild(toInclude); &#125; else if (source.getNodeType() == Node.ELEMENT_NODE) &#123; if (included &amp;&amp; !variablesContext.isEmpty()) &#123; // replace variables in attribute values NamedNodeMap attributes = source.getAttributes(); for (int i = 0; i &lt; attributes.getLength(); i++) &#123; Node attr = attributes.item(i); attr.setNodeValue(PropertyParser.parse(attr.getNodeValue(), variablesContext)); &#125; &#125; NodeList children = source.getChildNodes(); for (int i = 0; i &lt; children.getLength(); i++) &#123; applyIncludes(children.item(i), variablesContext, included); &#125; &#125; else if (included &amp;&amp; source.getNodeType() == Node.TEXT_NODE &amp;&amp; !variablesContext.isEmpty()) &#123; // replace variables in text node source.setNodeValue(PropertyParser.parse(source.getNodeValue(), variablesContext)); &#125;&#125; &lt;inClude&gt;èŠ‚ç‚¹å’Œ&lt;sql&gt;èŠ‚ç‚¹å¯ä»¥é…åˆä½¿ç”¨ã€å¤šå±‚åµŒå¥—ï¼Œå®ç°æ›´åŠ å¤æ‚çš„sqlç‰‡æ®µçš„é‡ç”¨ï¼Œè¿™æ ·çš„è¯ï¼Œè§£æè¿‡ç¨‹å°±ä¼šé€’å½’æ›´å¤šå±‚ï¼Œæµç¨‹å˜å¾—æ›´åŠ å¤æ‚ã€‚ 2. è§£æ&lt;selectKey&gt;èŠ‚ç‚¹ åœ¨&lt;insert&gt;ã€&lt;update&gt;èŠ‚ç‚¹ä¸­å¯ä»¥å®šä¹‰&lt;selectKey&gt;èŠ‚ç‚¹æ¥è§£å†³ä¸»é”®è‡ªå¢é—®é¢˜ï¼Œ&lt;selectKey&gt;èŠ‚ç‚¹å¯¹åº”çš„KeyGeneratoræ¥å£åœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œç°åœ¨é‡ç‚¹å…³èŠ‚ç‚¹çš„è§£æã€‚ XMLStatementBuilder.processSelectKeyNodes()æ–¹æ³•è´Ÿè´£è§£æSQLèŠ‚ç‚¹ä¸­å­èŠ‚ç‚¹ã€‚ private void processSelectKeyNodes(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver) &#123; // è·å–å…¨éƒ¨selectKeyèŠ‚ç‚¹ List&lt;XNode&gt; selectKeyNodes = context.evalNodes(&quot;selectKey&quot;); // è§£æselectKeyèŠ‚ç‚¹ if (configuration.getDatabaseId() != null) &#123; parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId()); &#125; parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null); removeSelectKeyNodes(selectKeyNodes);&#125; åœ¨parseSelectKeyNodes()æ–¹æ³•ä¸­ä¼šä¸º&lt;selectKey&gt;èŠ‚ç‚¹ç”Ÿæˆidï¼Œæ£€æµ‹databaseldæ˜¯å¦åŒ¹é…ä»¥åŠæ˜¯å¦å·±ç»åŠ è½½è¿‡ç›¸åŒidä¸”databaseldä¸ä¸ºç©ºçš„&lt;selectKey&gt;èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨parseSelectKeyNode()æ–¹æ³•å¤„ç†æ¯ä¸ª&lt;selectKey&gt;èŠ‚ç‚¹ã€‚åœ¨parseSelectKeyNode()æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè¯»å–&lt;selectKey&gt;èŠ‚ç‚¹çš„ä¸€ç³»åˆ—å±æ€§ï¼Œç„¶åè°ƒç”¨LanguageDriver.createSqlSource()æ–¹æ³•åˆ›å»ºå¯¹åº”çš„SqlSourceå¯¹è±¡ï¼Œæœ€ååˆ›å»ºMappedStatementå¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°Configuration.mappedStatementsé›†åˆä¸­ä¿å­˜ã€‚ private void parseSelectKeyNode(String id, XNode nodeToHandle, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String databaseId) &#123; String resultType = nodeToHandle.getStringAttribute(&quot;resultType&quot;); Class&lt;?&gt; resultTypeClass = resolveClass(resultType); StatementType statementType = StatementType.valueOf( nodeToHandle.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString())); String keyProperty = nodeToHandle.getStringAttribute(&quot;keyProperty&quot;); String keyColumn = nodeToHandle.getStringAttribute(&quot;keyColumn&quot;); boolean executeBefore = &quot;BEFORE&quot;.equals(nodeToHandle.getStringAttribute(&quot;order&quot;, &quot;AFTER&quot;)); //defaults boolean useCache = false; boolean resultOrdered = false; KeyGenerator keyGenerator = NoKeyGenerator.INSTANCE; Integer fetchSize = null; Integer timeout = null; boolean flushCache = false; String parameterMap = null; String resultMap = null; ResultSetType resultSetTypeEnum = null; SqlSource sqlSource = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass); SqlCommandType sqlCommandType = SqlCommandType.SELECT; builderAssistant.addMappedStatement( id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass, resultSetTypeEnum, flushCache, useCache, resultOrdered, keyGenerator, keyProperty, keyColumn, databaseId, langDriver, null); id = builderAssistant.applyCurrentNamespace(id, false); MappedStatement keyStatement = configuration.getMappedStatement(id, false); configuration.addKeyGenerator(id, new SelectKeyGenerator(keyStatement, executeBefore));&#125; LanguageDriveræ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ã€‚ åœ¨Configurationçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬ç”±æ­¤å¯ä»¥åˆ¤æ–­é»˜è®¤ä½¿ç”¨çš„XMLLanguageDriverå®ç°ç±»ã€‚ languageRegistry.setDefaultDriverClass(XMLLanguageDriver.class); ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„LanguageDriverå®ç°ï¼Œå¹¶åœ¨mybatis-config.xmlä¸­é€šè¿‡defaultScriptingLanguageé…ç½®æŒ‡å®šä½¿ç”¨è¯¥è‡ªå®šä¹‰å®ç°ã€‚åœ¨XMLLanguageDriver.createSqlSource()æ–¹æ³•ä¸­ä¼šåˆ›å»ºXMLScriptBuilderå¯¹è±¡å¹¶XMLScriptBuilder.parseScriptNode()æ–¹æ³•åˆ›å»ºSqlSourceå¯¹è±¡ã€‚ public SqlSource parseScriptNode() &#123; MixedSqlNode rootSqlNode = parseDynamicTags(context); SqlSource sqlSource = null; if (isDynamic) &#123; sqlSource = new DynamicSqlSource(configuration, rootSqlNode); &#125; else &#123; sqlSource = new RawSqlSource(configuration, rootSqlNode, parameterType); &#125; return sqlSource;&#125; åœ¨XMLScriptBuilder.parseDynamicTags()æ–¹æ³•ä¸­ï¼Œä¼šéå†&lt;selectKey&gt;ä¸‹çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœåŒ…å«ä»»ä½•æ ‡ç­¾èŠ‚ç‚¹ï¼Œåˆ™è®¤ä¸ºæ˜¯åŠ¨æ€SQLè¯­å¥ï¼›å¦‚æœæ–‡æœ¬èŠ‚ç‚¹ä¸­å«æœ‰$&#123;&#125;å ä½ç¬¦ï¼Œä¹Ÿè®¤ä¸ºå…¶ä¸ºåŠ¨æ€SQLè¯­å¥ã€‚ protected MixedSqlNode parseDynamicTags(XNode node) &#123; List&lt;SqlNode&gt; contents = new ArrayList&lt;SqlNode&gt;(); NodeList children = node.getNode().getChildNodes(); for (int i = 0; i &lt; children.getLength(); i++) &#123; XNode child = node.newXNode(children.item(i)); if (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE || child.getNode().getNodeType() == Node.TEXT_NODE) &#123; String data = child.getStringBody(&quot;&quot;); TextSqlNode textSqlNode = new TextSqlNode(data); if (textSqlNode.isDynamic()) &#123; contents.add(textSqlNode); isDynamic = true; &#125; else &#123; contents.add(new StaticTextSqlNode(data)); &#125; &#125; else if (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; // issue #628 String nodeName = child.getNode().getNodeName(); NodeHandler handler = nodeHandlerMap.get(nodeName); if (handler == null) &#123; throw new BuilderException(&quot;Unknown element &lt;&quot; + nodeName + &quot;&gt; in SQL statement.&quot;); &#125; handler.handleNode(child, contents); isDynamic = true; &#125; &#125; return new MixedSqlNode(contents);&#125; ä¸Šé¢é‡åˆ°çš„TextSqlNodeã€StaticTextSqlNodeç­‰éƒ½æ˜¯SqlNodeæ¥å£çš„å®ç°ï¼ŒSqlNodeæ¥å£çš„æ¯ä¸ªå®ç°éƒ½å¯¹åº”äºä¸åŒçš„åŠ¨æ€SQLèŠ‚ç‚¹ç±»å‹ï¼Œæ¯ä¸ªå®ç°çš„å…·ä½“ä»£ç åé¢é‡åˆ°äº†å†è¯¦ç»†åˆ†æã€‚ TextSqlNode.isDynamic()æ–¹æ³•ä¸­ä¼šé€šè¿‡GenericTokenParserå’ŒDynamicCheckerTokenParseré…åˆè§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦ä¸ºåŠ¨æ€SQLã€‚ public boolean isDynamic() &#123; DynamicCheckerTokenParser checker = new DynamicCheckerTokenParser(); GenericTokenParser parser = createParser(checker); parser.parse(text); return checker.isDynamic();&#125;@Overridepublic String handleToken(String content) &#123; this.isDynamic = true; return null;&#125; 3. è§£æSQLèŠ‚ç‚¹ ç»è¿‡ä¸Šè¿°ä¸¤ä¸ªè§£æè¿‡ç¨‹ä¹‹åï¼Œ&lt;include&gt;èŠ‚ç‚¹å’Œ&lt;selectKey&gt;èŠ‚ç‚¹å·±ç»è¢«è§£æå¹¶åˆ é™¤æ‰äº†ã€‚XMLStatementBuilder.parseStatementNode()æ–¹æ³•å‰©ä½™çš„æ“ä½œå°±æ˜¯è§£æSQLèŠ‚ç‚¹ã€‚ public void parseStatementNode() &#123; String id = context.getStringAttribute(&quot;id&quot;); String databaseId = context.getStringAttribute(&quot;databaseId&quot;); if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123; return; &#125; Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;); Integer timeout = context.getIntAttribute(&quot;timeout&quot;); String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;); String parameterType = context.getStringAttribute(&quot;parameterType&quot;); Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType); String resultMap = context.getStringAttribute(&quot;resultMap&quot;); String resultType = context.getStringAttribute(&quot;resultType&quot;); String lang = context.getStringAttribute(&quot;lang&quot;); LanguageDriver langDriver = getLanguageDriver(lang); Class&lt;?&gt; resultTypeClass = resolveClass(resultType); String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;); StatementType statementType = StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString())); ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType); String nodeName = context.getNode().getNodeName(); SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH)); boolean isSelect = sqlCommandType == SqlCommandType.SELECT; boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect); boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect); boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false); // Include Fragments before parsing XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant); includeParser.applyIncludes(context.getNode()); // Parse selectKey after includes and remove them. processSelectKeyNodes(id, parameterTypeClass, langDriver); // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed) SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass); String resultSets = context.getStringAttribute(&quot;resultSets&quot;); String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;); String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;); KeyGenerator keyGenerator; String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX; keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true); if (configuration.hasKeyGenerator(keyStatementId)) &#123; keyGenerator = configuration.getKeyGenerator(keyStatementId); &#125; else &#123; keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;, configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType)) ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE; &#125; builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass, resultSetTypeEnum, flushCache, useCache, resultOrdered, keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);&#125; ç»‘å®šMapperæ¥å£æ¯ä¸ªæ˜ å°„é…ç½®æ–‡ä»¶çš„å‘½åç©ºé—´å¯ä»¥ç»‘å®šä¸€ä¸ªMapperæ¥å£ï¼Œå¹¶æ³¨å†Œåˆ°MapperRegistryä¸­ã€‚ åœ¨XMLMapperBuilder.bindMapperForNamespace()æ–¹æ³•ä¸­ï¼Œå®Œæˆäº†æ˜ å°„é…ç½®æ–‡ä»¶ä¸å¯¹åº”Mapperæ¥å£çš„ç»‘å®šã€‚ private void bindMapperForNamespace() &#123; String namespace = builderAssistant.getCurrentNamespace(); if (namespace != null) &#123; Class&lt;?&gt; boundType = null; try &#123; boundType = Resources.classForName(namespace); &#125; catch (ClassNotFoundException e) &#123; //ignore, bound type is not required &#125; if (boundType != null) &#123; if (!configuration.hasMapper(boundType)) &#123; // Spring may not know the real resource name so we set a flag // to prevent loading again this resource from the mapper interface // look at MapperAnnotationBuilder#loadXmlResource configuration.addLoadedResource(&quot;namespace:&quot; + namespace); configuration.addMapper(boundType); &#125; &#125; &#125;&#125; åœ¨ä»‹ç»MapperRegistry.addMapper()æ–¹æ³•æ—¶ï¼Œåªæåˆ°äº†è¯¥æ–¹æ³•ä¼šå‘MapperRegistry.knownMappersé›†åˆæ³¨å†ŒæŒ‡å®šçš„Mapperæ¥å£ï¼Œå…¶å®è¯¥æ–¹æ³•è¿˜ä¼šåˆ›å»ºMapperAnnotationBuilderï¼Œå¹¶è°ƒç”¨MapperAnnotationBuilder.parse()æ–¹æ³•è§£æMapperæ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ã€‚ public void parse() &#123; String resource = type.toString(); if (!configuration.isResourceLoaded(resource)) &#123; loadXmlResource(); configuration.addLoadedResource(resource); assistant.setCurrentNamespace(type.getName()); parseCache(); parseCacheRef(); Method[] methods = type.getMethods(); for (Method method : methods) &#123; try &#123; // issue #237 if (!method.isBridge()) &#123; parseStatement(method); &#125; &#125; catch (IncompleteElementException e) &#123; configuration.addIncompleteMethod(new MethodResolver(this, method)); &#125; &#125; &#125; parsePendingMethods();&#125; å¤„ç†incomplete*é›†åˆXMLMapperBuilder.configurationElement()æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œæ˜¯æŒ‰ç…§ä»æ–‡ä»¶å¤´åˆ°æ–‡ä»¶å°¾çš„é¡ºåºè§£æçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åœ¨è§£æä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šå¼•ç”¨å®šä¹‰åœ¨è¯¥èŠ‚ç‚¹ä¹‹åçš„ã€è¿˜æœªè§£æçš„èŠ‚ç‚¹ï¼Œè¿™å°±ä¼šå¯¼è‡´è§£æå¤±è´¥å¹¶æŠ›å‡ºIncompleteElementExceptionã€‚ æ ¹æ®æŠ›å‡ºå¼‚å¸¸çš„èŠ‚ç‚¹ä¸åŒï¼ŒMyBatisä¼šåˆ›å»ºä¸åŒçš„*Resolverå¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°Configurationçš„ä¸åŒincomplete*é›†åˆä¸­ã€‚ ä¾‹å¦‚ï¼Œ è§£æMapperæ¥å£ä¸­çš„æ–¹æ³•å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šåˆ›å»ºMethodResolverå¯¹è±¡ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ°Configuration.incompleteMethodsé›†åˆ(LinkedList&lt;MethodResolver&gt;ç±»å‹)ä¸­æš‚å­˜; è§£æ&lt;resultMap&gt;èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„ResultMapResolverå¯¹è±¡è¿½åŠ åˆ°incompleteResultMaps(LinkedList&lt;ResultMapResolver&gt;ç±»å‹)é›†åˆä¸­æš‚å­˜; è§£æ&lt;cache-ref&gt;èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„CacheRefResolverå¯¹è±¡è¿½åŠ åˆ°incompleteCacheRefs(LinkedList&lt;CacheRefResolver&gt;ç±»å‹)é›†åˆä¸­æš‚å­˜; è§£æSQLè¯­å¥èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„XMLStatementBuilderå¯¹è±¡è¿½åŠ åˆ°incompleteStatements(LinkedList&lt;XMLStatementBuilder&gt;ç±»å‹)é›†åˆä¸­æš‚å­˜ã€‚ åœ¨XMLMapperBuilder.parse()æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡configurationElement()æ–¹æ³•å®Œäº†ä¸€æ¬¡æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æåï¼Œè¿˜ä¼šè°ƒç”¨parsePendingResultMaps()æ–¹æ³•ã€parsePendingChacheRefs()æ–¹æ³•ã€parsePendingStatements()æ–¹æ³•ä¸‰ä¸ªparsePending*()æ–¹æ³•å¤„ç†Configurationä¸­å¯¹åº”çš„ä¸‰ä¸ªincomplete*é›†åˆã€‚æ‰€æœ‰parsePending*()æ–¹æ³•çš„é€»è¾‘éƒ½æ˜¯åŸºæœ¬ç±»ä¼¼çš„ï¼Œè¿™é‡Œä»¥parsePendingStatements()æ–¹æ³•ä¸ºä¾‹è¿›è¡Œåˆ†æ private void parsePendingStatements() &#123; Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements(); synchronized (incompleteStatements) &#123; Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator(); while (iter.hasNext()) &#123; try &#123; iter.next().parseStatementNode(); iter.remove(); &#125; catch (IncompleteElementException e) &#123; // Statement is still missing a resource... &#125; &#125; &#125;&#125; åˆ°æ­¤ä¸ºæ­¢ï¼ŒMyBatisçš„åˆå§‹åŒ–è¿‡ç¨‹å°±å…¨éƒ¨ä»‹ç»å®Œäº†ï¼Œå…¶ä¸­åˆ†æäº†mybatis-config.xmlé…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ã€æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ä»¥åŠMapperæ¥å£ä¸­ç›¸å…³æ³¨è§£çš„è§£æè¿‡ç¨‹ã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"æ ¸å¿ƒå¤„ç†å±‚","slug":"æ ¸å¿ƒå¤„ç†å±‚","permalink":"https://www.cayzlh.com/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"Springé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆçŸ¥è¯†æ¢³ç†ï¼‰","date":"2020-03-31T03:03:22.000Z","path":"2020/03/31/741621cd.html","text":"Aspect Oriented Programming with Spring é¢å‘åˆ‡é¢çš„ç¼–ç¨‹ï¼ˆAOPï¼‰é€šè¿‡æä¾›å¦ä¸€ç§æ€è€ƒç¨‹åºç»“æ„çš„æ–¹å¼æ¥è¡¥å……é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼ˆOOPï¼‰ã€‚ OOPä¸­æ¨¡å—åŒ–çš„å…³é”®å•å…ƒæ˜¯ç±»ï¼Œè€Œåœ¨AOPä¸­æ¨¡å—åŒ–æ˜¯æ–¹é¢ã€‚åˆ‡é¢ä½¿å…³æ³¨ç‚¹ï¼ˆä¾‹å¦‚äº‹åŠ¡ç®¡ç†ï¼‰çš„æ¨¡å—åŒ–è·¨è¶Šäº†å¤šä¸ªç±»å‹å’Œå¯¹è±¡ã€‚ ï¼ˆè¿™ç§å…³æ³¨åœ¨AOPæ–‡çŒ®ä¸­é€šå¸¸è¢«ç§°ä¸ºâ€œè·¨é¢†åŸŸâ€å…³æ³¨ã€‚ï¼‰ Springçš„å…³é”®ç»„ä»¶ä¹‹ä¸€æ˜¯AOPæ¡†æ¶ã€‚å°½ç®¡Spring IoCå®¹å™¨ä¸ä¾èµ–äºAOPï¼Œä½†AOPæ˜¯å¯¹Spring IoCçš„è¡¥å……ï¼Œå¯ä»¥æä¾›åŠŸèƒ½å¼ºå¤§çš„ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆã€‚ Spring AOP with AspectJ pointcuts Spring provides simple and powerful ways of writing custom aspects by using either a schema-based approach or the @AspectJ annotation style. Both of these styles offer fully typed advice and use of the AspectJ pointcut language while still using Spring AOP for weaving. å…·æœ‰AspectJåˆ‡å…¥ç‚¹çš„Spring AOPé€šè¿‡ä½¿ç”¨åŸºäºæ¨¡å¼çš„æ–¹æ³•æˆ–**@AspectJæ³¨è§£æ ·å¼**ï¼ŒSpringæä¾›äº†ç¼–å†™è‡ªå®šä¹‰åˆ‡é¢çš„ç®€å•è€Œå¼ºå¤§çš„æ–¹æ³•ã€‚è¿™ä¸¤ç§æ ·å¼éƒ½æä¾›äº†å®Œå…¨ç±»å‹åŒ–çš„å»ºè®®ï¼Œå¹¶ä½¿ç”¨äº†AspectJåˆ‡å…¥ç‚¹è¯­è¨€ï¼ŒåŒæ—¶ä»ç„¶ä½¿ç”¨Spring AOPè¿›è¡Œç¼–ç¨‹ã€‚ Spring AOPæ¦‚å¿µä¸€äº›é‡è¦çš„AOPæ¦‚å¿µå’Œæœ¯è¯­ã€‚è¿™äº›æœ¯è¯­ä¸æ˜¯ç‰¹å®šäºSpringçš„ã€‚ åˆ‡é¢ï¼ˆAspectï¼‰ ç±»æ˜¯å¯¹ç‰©ä½“ç‰¹å¾çš„æŠ½è±¡ï¼Œåˆ‡é¢å°±æ˜¯å¯¹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æŠ½è±¡ã€‚ åœ¨Spring AOPä¸­ï¼Œåˆ‡é¢æ˜¯é€šè¿‡ä½¿ç”¨å¸¸è§„ç±»ï¼ˆåŸºäºæ¶æ„çš„æ–¹æ³•ï¼‰æˆ–ä½¿ç”¨@Aspectæ³¨é‡Šï¼ˆ@AspectJæ ·å¼ï¼‰æ³¨é‡Šçš„å¸¸è§„ç±»æ¥å®ç°çš„ã€‚ aspect ç”± pointcount å’Œ advice ç»„æˆ, å®ƒæ—¢åŒ…å«äº†æ¨ªåˆ‡é€»è¾‘çš„å®šä¹‰, ä¹ŸåŒ…æ‹¬äº†è¿æ¥ç‚¹çš„å®šä¹‰. Spring AOPå°±æ˜¯è´Ÿè´£å®æ–½åˆ‡é¢çš„æ¡†æ¶, å®ƒå°†åˆ‡é¢æ‰€å®šä¹‰çš„æ¨ªåˆ‡é€»è¾‘ç»‡å…¥åˆ°åˆ‡é¢æ‰€æŒ‡å®šçš„è¿æ¥ç‚¹ä¸­.AOPçš„å·¥ä½œé‡å¿ƒåœ¨äºå¦‚ä½•å°†å¢å¼ºç»‡å…¥ç›®æ ‡å¯¹è±¡çš„è¿æ¥ç‚¹ä¸Š, è¿™é‡ŒåŒ…å«ä¸¤ä¸ªå·¥ä½œ: å¦‚ä½•é€šè¿‡ pointcut å’Œ advice å®šä½åˆ°ç‰¹å®šçš„ joinpoint ä¸Š å¦‚ä½•åœ¨ advice ä¸­ç¼–å†™åˆ‡é¢ä»£ç . è¿æ¥ç‚¹ï¼ˆJoin pointï¼‰ A point during the execution of a program, such as the execution of a method or the handling of an exception. In Spring AOP, a join point always represents a method execution. ç¨‹åºè¿è¡Œä¸­çš„ä¸€äº›æ—¶é—´ç‚¹ï¼Œä¾‹å¦‚ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¼‚å¸¸çš„å¤„ç†ã€‚åœ¨ Spring AOP ä¸­, join point æ€»æ˜¯æ–¹æ³•çš„æ‰§è¡Œç‚¹, å³åªæœ‰æ–¹æ³•è¿æ¥ç‚¹. å¢å¼ºï¼ˆAdviceï¼‰ Action taken by an aspect at a particular join point. Different types of advice include â€œaroundâ€, â€œbeforeâ€ and â€œafterâ€ advice. (Advice types are discussed later.) Many AOP frameworks, including Spring, model an advice as an interceptor and maintain a chain of interceptors around the join point. åˆ‡é¢åœ¨ç‰¹å®šçš„è¿æ¥ç‚¹å¤„é‡‡å–çš„æ“ä½œã€‚ä¸åŒç±»å‹çš„å»ºè®®åŒ…æ‹¬aroundï¼Œbeforeå’Œafteré€šçŸ¥ã€‚ åŒ…æ‹¬Springåœ¨å†…çš„è®¸å¤šAOPæ¡†æ¶éƒ½å°†é€šçŸ¥å»ºæ¨¡ä¸ºæ‹¦æˆªå™¨ï¼Œå¹¶åœ¨è¿æ¥ç‚¹å‘¨å›´ç»´æŠ¤ä¸€ç³»åˆ—æ‹¦æˆªå™¨ã€‚ ç”± aspect æ·»åŠ åˆ°ç‰¹å®šçš„ join point(å³æ»¡è¶³ point cut è§„åˆ™çš„ join point) çš„ä¸€æ®µä»£ç .è®¸å¤š AOPæ¡†æ¶, åŒ…æ‹¬ Spring AOP, ä¼šå°† advice æ¨¡æ‹Ÿä¸ºä¸€ä¸ªæ‹¦æˆªå™¨(interceptor), å¹¶ä¸”åœ¨ join point ä¸Šç»´æŠ¤å¤šä¸ª advice, è¿›è¡Œå±‚å±‚æ‹¦æˆª.ä¾‹å¦‚ HTTP é‰´æƒçš„å®ç°, æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªä½¿ç”¨ RequestMapping æ ‡æ³¨çš„æ–¹æ³•ç»‡å…¥ advice, å½“ HTTP è¯·æ±‚åˆ°æ¥æ—¶, é¦–å…ˆè¿›å…¥åˆ° advice ä»£ç ä¸­, åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ†æè¿™ä¸ª HTTP è¯·æ±‚æ˜¯å¦æœ‰ç›¸åº”çš„æƒé™, å¦‚æœæœ‰, åˆ™æ‰§è¡Œ Controller, å¦‚æœæ²¡æœ‰, åˆ™æŠ›å‡ºå¼‚å¸¸. è¿™é‡Œçš„ advice å°±æ‰®æ¼”ç€é‰´æƒæ‹¦æˆªå™¨çš„è§’è‰²äº†. åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰ A predicate that matches join points. Advice is associated with a pointcut expression and runs at any join point matched by the pointcut (for example, the execution of a method with a certain name). The concept of join points as matched by pointcut expressions is central to AOP, and Spring uses the AspectJ pointcut expression language by default. åŒ¹é…è¿æ¥ç‚¹çš„è°“è¯ã€‚é€šçŸ¥ä¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å…³è”ï¼Œå¹¶åœ¨ä¸è¯¥åˆ‡å…¥ç‚¹åŒ¹é…çš„ä»»ä½•è¿æ¥ç‚¹å¤„è¿è¡Œï¼ˆä¾‹å¦‚ï¼Œæ‰§è¡Œå…·æœ‰ç‰¹å®šåç§°çš„æ–¹æ³•ï¼‰ã€‚ä½¿ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ¥åŒ¹é…è¿æ¥ç‚¹æ˜¯AOPçš„æ ¸å¿ƒï¼Œå¹¶ä¸”Springé»˜è®¤ä½¿ç”¨AspectJåˆ‡å…¥ç‚¹è¡¨è¾¾è¯­è¨€ã€‚ åœ¨ Spring ä¸­, æ‰€æœ‰çš„æ–¹æ³•éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ joinpoint, ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸å¸Œæœ›åœ¨æ‰€æœ‰çš„æ–¹æ³•ä¸Šéƒ½æ·»åŠ  Advice, è€Œ pointcut çš„ä½œç”¨å°±æ˜¯æä¾›ä¸€ç»„è§„åˆ™(ä½¿ç”¨ AspectJ pointcut expression language æ¥æè¿°) æ¥åŒ¹é…joinpoint, ç»™æ»¡è¶³è§„åˆ™çš„ joinpoint æ·»åŠ  Advice. å¼•å…¥ï¼ˆIntroductionï¼‰ Declaring additional methods or fields on behalf of a type. Spring AOP lets you introduce new interfaces (and a corresponding implementation) to any advised object. For example, you could use an introduction to make a bean implement an IsModified interface, to simplify caching. (An introduction is known as an inter-type declaration in the AspectJ community.) ä»£è¡¨ç±»å‹å£°æ˜å…¶ä»–æ–¹æ³•æˆ–å­—æ®µã€‚ Spring AOPå…è®¸æ‚¨å‘ä»»ä½•å»ºè®®çš„å¯¹è±¡å¼•å…¥æ–°çš„æ¥å£ï¼ˆå’Œç›¸åº”çš„å®ç°ï¼‰ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¼•å…¥ä½¿Beanå®ç°IsModifiedæ¥å£ï¼Œä»¥ç®€åŒ–ç¼“å­˜ã€‚ ï¼ˆåœ¨AspectJç¤¾åŒºä¸­ï¼Œå¼•å…¥è¢«ç§°ä¸ºç±»å‹é—´å£°æ˜ã€‚ï¼‰ ä¸ºä¸€ä¸ªç±»å‹æ·»åŠ é¢å¤–çš„æ–¹æ³•æˆ–å­—æ®µ. Spring AOP å…è®¸æˆ‘ä»¬ä¸º ç›®æ ‡å¯¹è±¡ å¼•å…¥æ–°çš„æ¥å£(å’Œå¯¹åº”çš„å®ç°). ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ introduction æ¥ä¸ºä¸€ä¸ª bean å®ç° IsModified æ¥å£, å¹¶ä»¥æ­¤æ¥ç®€åŒ– caching çš„å®ç°. ç›®æ ‡å¯¹è±¡ï¼ˆTarget objectï¼‰ An object being advised by one or more aspects. Also referred to as the â€œadvised objectâ€. Since Spring AOP is implemented by using runtime proxies, this object is always a proxied object. ä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢é€šçŸ¥çš„å¯¹è±¡ã€‚ä¹Ÿç§°ä¸ºâ€œç›®æ ‡å¯¹è±¡â€ã€‚ç”±äºSpring AOPæ˜¯ä½¿ç”¨è¿è¡Œæ—¶ä»£ç†å®ç°çš„ï¼Œå› æ­¤è¯¥å¯¹è±¡å§‹ç»ˆæ˜¯ä»£ç†å¯¹è±¡ã€‚ å› ä¸º Spring AOP ä½¿ç”¨è¿è¡Œæ—¶ä»£ç†çš„æ–¹å¼æ¥å®ç° aspect, å› æ­¤ adviced object æ€»æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡(proxied object)ã€‚ æ³¨æ„, adviced object æŒ‡çš„ä¸æ˜¯åŸæ¥çš„ç±», è€Œæ˜¯ç»‡å…¥ advice åæ‰€äº§ç”Ÿçš„ä»£ç†ç±» ä»£ç†ï¼ˆAOP proxyï¼‰ An object created by the AOP framework in order to implement the aspect contracts (advise method executions and so on). In the Spring Framework, an AOP proxy is a JDK dynamic proxy or a CGLIB proxy. ä¸€ä¸ªç±»è¢« AOP ç»‡å…¥ adviceï¼Œ å°±ä¼šäº§ç”Ÿä¸€ä¸ªç»“æœç±», å®ƒæ˜¯èåˆäº†åŸç±»å’Œå¢å¼ºé€»è¾‘çš„ä»£ç†ç±»ã€‚åœ¨ Spring AOP ä¸­, ä¸€ä¸ª AOP ä»£ç†æ˜¯ä¸€ä¸ª JDK åŠ¨æ€ä»£ç†å¯¹è±¡æˆ– CGLIB ä»£ç†å¯¹è±¡ã€‚ ç»‡å…¥ï¼ˆWeavingï¼‰ linking aspects with other application types or objects to create an advised object. This can be done at compile time (using the AspectJ compiler, for example), load time, or at runtime. Spring AOP, like other pure Java AOP frameworks, performs weaving at runtime. å°†åˆ‡é¢ä¸å…¶ä»–åº”ç”¨ç¨‹åºç±»å‹æˆ–å¯¹è±¡é“¾æ¥ä»¥åˆ›å»ºå»ºè®®çš„å¯¹è±¡ï¼ˆå°† aspect å’Œå…¶ä»–å¯¹è±¡è¿æ¥èµ·æ¥, å¹¶åˆ›å»º adviced object çš„è¿‡ç¨‹ï¼‰ã€‚è¿™å¯ä»¥åœ¨ç¼–è¯‘æ—¶ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨AspectJç¼–è¯‘å™¨ï¼‰ï¼ŒåŠ è½½æ—¶æˆ–åœ¨è¿è¡Œæ—¶å®Œæˆã€‚åƒå…¶ä»–çº¯Java AOPæ¡†æ¶ä¸€æ ·ï¼ŒSpring AOPåœ¨è¿è¡Œæ—¶æ‰§è¡Œç¼–ç»‡ã€‚æ ¹æ®ä¸åŒçš„å®ç°æŠ€æœ¯, AOPç»‡å…¥æœ‰ä¸‰ç§æ–¹å¼: ç¼–è¯‘å™¨ç»‡å…¥, è¿™è¦æ±‚æœ‰ç‰¹æ®Šçš„Javaç¼–è¯‘å™¨. ç±»è£…è½½æœŸç»‡å…¥, è¿™éœ€è¦æœ‰ç‰¹æ®Šçš„ç±»è£…è½½å™¨. åŠ¨æ€ä»£ç†ç»‡å…¥, åœ¨è¿è¡ŒæœŸä¸ºç›®æ ‡ç±»æ·»åŠ å¢å¼º(Advice)ç”Ÿæˆå­ç±»çš„æ–¹å¼.Spring é‡‡ç”¨åŠ¨æ€ä»£ç†ç»‡å…¥, è€ŒAspectJé‡‡ç”¨ç¼–è¯‘å™¨ç»‡å…¥å’Œç±»è£…è½½æœŸç»‡å…¥. adviceçš„å‡ ç§ç±»å‹ å‰ç½®é€šçŸ¥ï¼ˆBefore adviceï¼‰ åœ¨è¿æ¥ç‚¹ä¹‹å‰è¿è¡Œä½†æ— æ³•é˜»æ­¢æ‰§è¡Œæµå‰è¿›åˆ°è¿æ¥ç‚¹çš„é€šçŸ¥ï¼ˆé™¤éå®ƒå¼•å‘å¼‚å¸¸ï¼‰ã€‚ åç½®é€šçŸ¥ï¼ˆAfter returning adviceï¼‰ è¿æ¥ç‚¹æ­£å¸¸å®Œæˆåè¦è¿è¡Œçš„é€šçŸ¥ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ–¹æ³•è¿”å›è€Œæ²¡æœ‰å¼•å‘å¼‚å¸¸ï¼‰ã€‚ æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼ˆAfter throwing adviceï¼‰ å¦‚æœå­˜åœ¨æ–¹æ³•åˆ™é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥æ‰§è¡Œçš„é€šçŸ¥ã€‚ åœ¨finallyæ‰§è¡Œåé€šçŸ¥ï¼ˆAfter (finally) adviceï¼‰ æ— è®ºè¿æ¥ç‚¹é€€å‡ºçš„æ–¹å¼å¦‚ä½•ï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸è¿”å›ï¼‰ï¼Œéƒ½å°†æ‰§è¡Œé€šçŸ¥ã€‚ ç¯ç»•é€šçŸ¥ï¼ˆAround adviceï¼‰ å›´ç»•è”æ¥ç‚¹çš„é€šçŸ¥ï¼Œä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€‚è¿™æ˜¯æœ€æœ‰åŠ›çš„é€šçŸ¥ã€‚ç¯ç»•é€šçŸ¥å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰å’Œä¹‹åæ‰§è¡Œè‡ªå®šä¹‰è¡Œä¸ºã€‚å®ƒè¿˜è´Ÿè´£é€‰æ‹©æ˜¯è¿”å›è¿æ¥ç‚¹è¿˜æ˜¯é€šè¿‡è¿”å›å…¶è‡ªèº«çš„è¿”å›å€¼æˆ–å¼•å‘å¼‚å¸¸æ¥è¿›è¡Œé€šçŸ¥çš„æ–¹æ³•æ‰§è¡Œã€‚ AOPä»£ç†Spring AOPé»˜è®¤å°†æ ‡å‡†JDKåŠ¨æ€ä»£ç†ç”¨äºAOPä»£ç†ã€‚è¿™ä½¿å¾—å¯ä»¥ä»£ç†ä»»ä½•æ¥å£ï¼ˆæˆ–ä¸€ç»„æ¥å£ï¼‰ã€‚ Spring AOPä¹Ÿå¯ä»¥ä½¿ç”¨CGLIBä»£ç†ã€‚è¿™å¯¹äºä»£ç†ç±»è€Œä¸æ˜¯æ¥å£æ˜¯å¿…éœ€çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸šåŠ¡å¯¹è±¡æœªå®ç°æ¥å£ï¼Œåˆ™ä½¿ç”¨CGLIBã€‚ç”±äºå¯¹æ¥å£è€Œä¸æ˜¯å¯¹ç±»è¿›è¡Œç¼–ç¨‹æ˜¯ä¸€ç§å¥½ä¹ æƒ¯ï¼Œå› æ­¤ä¸šåŠ¡ç±»é€šå¸¸å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡æ¥å£ã€‚åœ¨é‚£äº›éœ€è¦å»ºè®®åœ¨æ¥å£ä¸Šæœªå£°æ˜çš„æ–¹æ³•æˆ–éœ€è¦å°†ä»£ç†å¯¹è±¡ä½œä¸ºå…·ä½“ç±»å‹ä¼ é€’ç»™æ–¹æ³•çš„æƒ…å†µä¸‹ï¼ˆåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼‰ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ç”¨CGLIBã€‚ Spring Beançš„ç”Ÿå‘½å‘¨æœŸ æ’æ’­ä¸€ä¸‹Spring Beançš„ç”Ÿå‘½å‘¨æœŸ ä¸¤ä¸ªæ¦‚å¿µï¼šSpring Bean å’Œ å¯¹è±¡ï¼š spring beanâ€”â€”å—springå®¹å™¨ç®¡ç†çš„å¯¹è±¡ï¼Œå¯èƒ½ç»è¿‡äº†å®Œæ•´çš„spring beanç”Ÿå‘½å‘¨æœŸï¼ˆä¸ºä»€ä¹ˆæ˜¯å¯èƒ½ï¼Ÿéš¾é“è¿˜æœ‰beanæ˜¯æ²¡æœ‰ç»è¿‡beanç”Ÿå‘½å‘¨æœŸçš„ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå…·ä½“æˆ‘ä»¬åé¢æ–‡ç« åˆ†æï¼‰ï¼Œæœ€ç»ˆå­˜åœ¨springå®¹å™¨å½“ä¸­ï¼›ä¸€ä¸ªbeanä¸€å®šæ˜¯ä¸ªå¯¹è±¡ å¯¹è±¡â€”â€”ä»»ä½•ç¬¦åˆjavaè¯­æ³•è§„åˆ™å®ä¾‹åŒ–å‡ºæ¥çš„å¯¹è±¡ï¼Œä½†æ˜¯ä¸€ä¸ªå¯¹è±¡å¹¶ä¸ä¸€å®šæ˜¯spring beanï¼› æ‰€è°“çš„beançš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ç£ç›˜ä¸Šçš„ç±»é€šè¿‡Springæ‰«æï¼Œç„¶åå®ä¾‹åŒ–ï¼Œè·Ÿç€åˆå§‹åŒ–ï¼Œç»§è€Œæ”¾åˆ°å®¹å™¨å½“ä¸­çš„è¿‡ç¨‹ã€‚ä¸‹å›¾å±•ç¤ºSpring Beançš„ç”Ÿå‘½å‘¨æœŸå¤§æ¦‚æœ‰å“ªäº›æ­¥éª¤ï¼š å…¶ä¸­AOPçš„ä»£ç†ä¹Ÿæ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆçš„ã€‚ AOPçš„ä½¿ç”¨AspectJä¸@AspectJ@AspectJæ˜¯ä¸€ç§å°†åˆ‡é¢å£°æ˜ä¸ºå¸¦æœ‰æ³¨è§£çš„å¸¸è§„Javaç±»çš„æ ·å¼ã€‚ @AspectJæ ·å¼æ˜¯AspectJé¡¹ç›®åœ¨AspectJ 5ç‰ˆæœ¬ä¸­å¼•å…¥çš„ã€‚ Springä½¿ç”¨AspectJæä¾›çš„ç”¨äºåˆ‡å…¥ç‚¹è§£æå’ŒåŒ¹é…çš„åº“æ¥è§£é‡Šä¸AspectJ 5ç›¸åŒçš„æ³¨è§£ã€‚ä½†æ˜¯ï¼ŒAOPè¿è¡Œæ—¶ä»ç„¶æ˜¯çº¯Spring AOPï¼Œå¹¶ä¸”ä¸ä¾èµ–äºAspectJç¼–è¯‘å™¨æˆ–ç¼–ç»‡å™¨ã€‚ ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒSpringå€Ÿé‰´äº†AspectJçš„è¯­æ³•ã€‚ ä½¿ç”¨AspectJç¼–è¯‘å™¨å’Œweaverå¯ä»¥ä½¿ç”¨å®Œæ•´çš„AspectJè¯­æ³•ã€‚ AspectJ æ˜¯æœ€æ—©ã€åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§çš„ AOP å®ç°ä¹‹ä¸€ï¼Œå¯¹æ•´å¥— AOP æœºåˆ¶éƒ½æœ‰è¾ƒå¥½çš„å®ç°ï¼Œå¾ˆå¤šå…¶ä»–è¯­è¨€çš„ AOP å®ç°ï¼Œä¹Ÿå€Ÿé‰´æˆ–é‡‡çº³äº† AspectJ ä¸­å¾ˆå¤šè®¾è®¡ã€‚ å¯ç”¨@AspectJæ”¯æŒ é€šè¿‡Javaé…ç½®å¯ç”¨@AspectJæ”¯æŒ åœ¨é…ç½®ç±»åŠ ä¸Š@EnableAspectJAutoProxyæ³¨è§£ä»¥å¯ç”¨@AspectJæ”¯æŒ @Configuration@EnableAspectJAutoProxypublic class AppConfig &#123;&#125; é€šè¿‡XMLé…ç½®å¯ç”¨@AspectJæ”¯æŒ &lt;aop:aspectj-autoproxy/&gt; å£°æ˜ä¸€ä¸ªåˆ‡é¢å¯ç”¨@AspectJæ”¯æŒåï¼ŒSpringä¼šè‡ªåŠ¨æ£€æµ‹åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨@AspectJåˆ‡é¢ï¼ˆå…·æœ‰@Aspectæ‰¹æ³¨ï¼‰çš„ç±»å®šä¹‰çš„beanï¼Œå¹¶ç”¨äºé…ç½®Spring AOPã€‚ ä½¿ç”¨xmlé…ç½®å£°æ˜åˆ‡é¢ &lt;bean id=&quot;myAspect&quot; class=&quot;org.xyz.NotVeryUsefulAspect&quot;&gt; &lt;!-- configure properties of the aspect here --&gt;&lt;/bean&gt; ä½¿ç”¨æ³¨è§£å£°æ˜åˆ‡é¢ package org.xyz;import org.aspectj.lang.annotation.Aspect;@Aspectpublic class NotVeryUsefulAspect &#123;&#125; å£°æ˜åˆ‡å…¥ç‚¹åˆ‡å…¥ç‚¹ç¡®å®šäº†å…³æ³¨çš„çš„è¿æ¥ç‚¹ï¼Œä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶æ‰§è¡Œé€šçŸ¥çš„æ—¶æœºã€‚ Spring AOPä»…æ”¯æŒSpring Beançš„æ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹ï¼Œå¯ä»¥å°†åˆ‡å…¥ç‚¹è§†ä¸ºä¸Spring Beanä¸Šçš„æ–¹æ³•æ‰§è¡ŒåŒ¹é…ã€‚ åˆ‡å…¥ç‚¹å£°æ˜ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªåŒ…å«åç§°å’Œä»»ä½•å‚æ•°çš„ç­¾åï¼Œä»¥åŠä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¯¥åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç²¾ç¡®åœ°ç¡®å®šæˆ‘ä»¬å…³æ³¨çš„æ–¹æ³•æ‰§è¡Œã€‚åœ¨AOPçš„@AspectJæ‰¹æ³¨æ ·å¼ä¸­ï¼Œå¸¸è§„æ–¹æ³•å®šä¹‰æä¾›äº†åˆ‡å…¥ç‚¹ç­¾åã€‚ å¹¶é€šè¿‡ä½¿ç”¨@Pointcutæ³¨è§£å£°æ˜åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼ˆç”¨ä½œåˆ‡å…¥ç‚¹ç­¾åçš„æ–¹æ³•å¿…é¡»å…·æœ‰voidè¿”å›ç±»å‹ï¼‰ã€‚ ä¸€ä¸ªä¾‹å­ï¼š @Pointcut(&quot;execution(* transfer(..))&quot;) // åˆ‡å…¥ç‚¹è¡¨è¾¾å¼private void anyOldTransfer() &#123;&#125; // åˆ‡å…¥ç‚¹æ–¹æ³•ç­¾å æ”¯æŒçš„åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦Spring AOPæ”¯æŒä»¥ä¸‹åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„AspectJåˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦ï¼ˆPCDï¼‰ï¼š executionï¼šåŒ¹é…æ–¹æ³•æ‰§è¡Œçš„è¿æ¥ç‚¹ï¼Œè¿™æ˜¯ä½ å°†ä¼šç”¨åˆ°çš„Springçš„æœ€ä¸»è¦çš„åˆ‡å…¥ç‚¹æŒ‡å®šè€…ã€‚ æè¿°çš„æœ€å°ç²’åº¦ç²¾ç¡®åˆ°æ–¹æ³•ï¼ˆç”šè‡³æ–¹æ³•çš„å‚æ•°ï¼‰ withinï¼šé™å®šåŒ¹é…ç‰¹å®šç±»å‹çš„è¿æ¥ç‚¹ï¼ˆåœ¨ä½¿ç”¨SpringAOPçš„æ—¶å€™ï¼Œåœ¨åŒ¹é…çš„ç±»å‹ä¸­å®šä¹‰çš„æ–¹æ³•çš„æ‰§è¡Œï¼‰ã€‚ æè¿°çš„æœ€å°ç²’åº¦ä»…ä»…åˆ°ä¸€ä¸ªç±» thisï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨Spring AOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­bean referenceï¼ˆSpring AOP ä»£ç†ï¼‰æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚ï¼ˆä»£ç†çš„å¯¹è±¡æœ¬èº«ï¼‰ targetï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­ç›®æ ‡å¯¹è±¡ï¼ˆè¢«ä»£ç†çš„appolication objectï¼‰æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚ï¼ˆè¢«ä»£ç†çš„å¯¹è±¡ï¼‰ argsï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨Spring AOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­å‚æ•°æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚ @targetï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­æ‰§è¡Œçš„å¯¹è±¡çš„ç±»å·²ç»æœ‰æŒ‡å®šç±»å‹çš„æ³¨è§£ã€‚ @argsï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­å®é™…ä¼ å…¥å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹æœ‰æŒ‡å®šç±»å‹çš„æ³¨è§£ã€‚ @withinï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼Œå…¶ä¸­è¿æ¥ç‚¹æ‰€åœ¨ç±»å‹å·²æŒ‡å®šæ³¨è§£ï¼ˆåœ¨ä½¿ç”¨Spring AOPçš„æ—¶å€™ï¼Œæ‰€æ‰§è¡Œçš„æ–¹æ³•æ‰€åœ¨ç±»å‹å·²æŒ‡å®šæ³¨è§£ï¼‰ã€‚ @annotationï¼šé™å®šåŒ¹é…ç‰¹å®šçš„è¿æ¥ç‚¹ï¼ˆä½¿ç”¨SpringAOPçš„æ—¶å€™æ–¹æ³•çš„æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­è¿æ¥ç‚¹çš„ä¸»é¢˜æœ‰æŸç§ç»™å®šçš„æ³¨è§£åˆå¹¶åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ ç»„åˆåˆ‡å…¥ç‚¹æ‚¨å¯ä»¥ä½¿ç”¨&amp;&amp;ï¼Œ||ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼å’Œï¼æ‚¨ä¹Ÿå¯ä»¥æŒ‰åç§°å¼•ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸‰ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š @Pointcut(&quot;execution(public * *(..))&quot;)private void anyPublicOperation() &#123;&#125; // 1âƒ£ï¸ åŒ¹é…æ‰€æœ‰å…¬å…±æ–¹æ³•@Pointcut(&quot;within(com.xyz.someapp.trading..*)&quot;)private void inTrading() &#123;&#125; // 2âƒ£ï¸ åŒ¹é…æŒ‡å®šåŒ…é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•@Pointcut(&quot;anyPublicOperation() &amp;&amp; inTrading()&quot;)private void tradingOperation() &#123;&#125; // 3âƒ£ï¸ åŒ¹é…æŒ‡å®šåŒ…é‡Œé¢çš„æ‰€æœ‰å…¬å…±æ–¹æ³• å…±äº«é€šç”¨åˆ‡å…¥ç‚¹å®šä¹‰åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œå¼€å‘äººå‘˜é€šå¸¸å¸Œæœ›ä»å¤šä¸ªæ–¹é¢å¼•ç”¨åº”ç”¨ç¨‹åºçš„æ¨¡å—å’Œç‰¹å®šçš„æ“ä½œé›†ã€‚æˆ‘ä»¬å»ºè®®ä¸ºæ­¤å®šä¹‰ä¸€ä¸ª SystemArchitectureåˆ‡é¢ï¼Œä»¥æ•è·å¸¸è§çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚è¿™æ ·çš„æ–¹é¢é€šå¸¸ç±»ä¼¼äºä»¥ä¸‹ç¤ºä¾‹ï¼š package com.xyz.someapp;import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Pointcut;@Aspectpublic class SystemArchitecture &#123; /** * A join point is in the web layer if the method is defined * in a type in the com.xyz.someapp.web package or any sub-package * under that. */ @Pointcut(&quot;within(com.xyz.someapp.web..*)&quot;) public void inWebLayer() &#123;&#125; /** * A join point is in the service layer if the method is defined * in a type in the com.xyz.someapp.service package or any sub-package * under that. */ @Pointcut(&quot;within(com.xyz.someapp.service..*)&quot;) public void inServiceLayer() &#123;&#125; /** * A join point is in the data access layer if the method is defined * in a type in the com.xyz.someapp.dao package or any sub-package * under that. */ @Pointcut(&quot;within(com.xyz.someapp.dao..*)&quot;) public void inDataAccessLayer() &#123;&#125; /** * A business service is the execution of any method defined on a service * interface. This definition assumes that interfaces are placed in the * &quot;service&quot; package, and that implementation types are in sub-packages. * * If you group service interfaces by functional area (for example, * in packages com.xyz.someapp.abc.service and com.xyz.someapp.def.service) then * the pointcut expression &quot;execution(* com.xyz.someapp..service.*.*(..))&quot; * could be used instead. * * Alternatively, you can write the expression using the &#x27;bean&#x27; * PCD, like so &quot;bean(*Service)&quot;. (This assumes that you have * named your Spring service beans in a consistent fashion.) */ @Pointcut(&quot;execution(* com.xyz.someapp..service.*.*(..))&quot;) public void businessService() &#123;&#125; /** * A data access operation is the execution of any method defined on a * dao interface. This definition assumes that interfaces are placed in the * &quot;dao&quot; package, and that implementation types are in sub-packages. */ @Pointcut(&quot;execution(* com.xyz.someapp.dao.*.*(..))&quot;) public void dataAccessOperation() &#123;&#125;&#125; å¯ä»¥åœ¨éœ€è¦åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ä»»ä½•åœ°æ–¹å¼•ç”¨åˆ‡é¢ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹ã€‚ä¾‹å¦‚ï¼Œè¦ä½¿æœåŠ¡å±‚å…·æœ‰äº‹åŠ¡æ€§ï¼š &lt;aop:config&gt; &lt;aop:advisor pointcut=&quot;com.xyz.someapp.SystemArchitecture.businessService()&quot; advice-ref=&quot;tx-advice&quot;/&gt;&lt;/aop:config&gt;&lt;tx:advice id=&quot;tx-advice&quot;&gt; &lt;tx:attributes&gt; &lt;tx:method name=&quot;*&quot; propagation=&quot;REQUIRED&quot;/&gt; &lt;/tx:attributes&gt;&lt;/tx:advice&gt; Examples è¯­æ³•ï¼š execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) throws-pattern?) é—®å·è¡¨ç¤ºå½“å‰é¡¹æœ‰ä¹Ÿå¯ä»¥æ²¡æœ‰ å…¶ä¸­å„é¡¹è¯­ä¹‰å¦‚ä¸‹ï¼š modifiers- patternï¼šæ–¹æ³•çš„å¯è§æ€§ï¼Œå¦‚ public, protected ret-type- patternï¼šæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œå¦‚ int, void ç­‰ declaring-type- patternï¼šæ–¹æ³•æ‰€åœ¨ç±»çš„å…¨è·¯å¾„åï¼Œå¦‚ com, spring, Aspect name- patternï¼šæ–¹æ³•åï¼Œå¦‚ bui sinessservice () param- patternï¼šæ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œå¦‚ java. Lang String throws- pattern: æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå¦‚ java.Lang. Exception ä¸€äº›å¸¸è§çš„è¡¨è¾¾å¼ï¼š åŒ¹é…ä»»æ„publicæ–¹æ³• execution(public * *(..)) åŒ¹é…æ‰€æœ‰ä»¥setå¼€å¤´çš„æ–¹æ³• execution(* set*(..)) åŒ¹é…AccountServiceæ¥å£å®šä¹‰çš„ä»»ä½•æ–¹æ³• execution(* com.xyz.service.AccountService.*(..)) åŒ¹é…æŒ‡å®šåŒ…ä¸‹çš„æ–¹æ³• execution(* com.xyz.service.*.*(..)) åŒ¹é…æŒ‡å®šåŒ…ä¸‹é¢çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­åŒ…ä¸‹çš„ç±»æ–¹æ³• execution(* com.xyz.service..*.*(..)) åŒ¹é…serviceåŒ…ä¸­çš„æ‰€æœ‰è¿æ¥ç‚¹ within(com.xyz.service.*) åŒ¹é…serviceä¸€ä¸ªæˆ–å¤šä¸ªå­åŒ…ä¸­çš„æ‰€æœ‰è¿æ¥ç‚¹ within(com.xyz.service..*) ä»£ç†å®ç°AccountServiceæ¥å£çš„ä»»ä½•è¿æ¥ç‚¹ this(com.xyz.service.AccountService) ç›®æ ‡å¯¹è±¡å®ç°AccountServiceæ¥å£çš„ä»»ä½•è¿æ¥ç‚¹ target(com.xyz.service.AccountService) ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°å¹¶ä¸”åœ¨è¿è¡Œæ—¶ä¼ é€’çš„å‚æ•°ä¸ºSerializableçš„è¿æ¥ç‚¹ args(java.io.Serializable) ç›®æ ‡å¯¹è±¡å…·æœ‰@Transactionalæ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹ @target(org.springframework.transaction.annotation.Transactional) ç›®æ ‡å¯¹è±¡çš„å£°æ˜ç±»å‹å…·æœ‰@Transactionalæ³¨è§£çš„ä»»ä½•è¿æ¥ç‚¹ @within(org.springframework.transaction.annotation.Transactional) ä»»ä½•æ‰§è¡Œæ–¹æ³•å¸¦æœ‰@Transactionalæ‰¹æ³¨çš„è¿æ¥ç‚¹ @annotation(org.springframework.transaction.annotation.Transactional) ä»»ä½•é‡‡ç”¨å•ä¸ªå‚æ•°çš„è”æ¥ç‚¹ï¼Œå¹¶ä¸”ä¼ é€’çš„å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹å…·æœ‰Classifiedæ³¨è§£ @args(com.xyz.security.Classified) åä¸ºtradeServiceçš„Spring beanä¸Šçš„ä»»ä½•è¿æ¥ç‚¹ bean(tradeService) Spring Beanä¸Šå…·æœ‰ä¸é€šé…ç¬¦è¡¨è¾¾å¼* ServiceåŒ¹é…çš„åç§°çš„ä»»ä½•è¿æ¥ç‚¹ bean(*Service) å£°æ˜é€šçŸ¥é€šçŸ¥ç”¨æ¥å£°æ˜æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…çš„æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œä¹‹åæˆ–å‘¨å›´è¿è¡Œã€‚åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å¯ä»¥æ˜¯å¯¹å‘½ååˆ‡å…¥ç‚¹çš„ç®€å•å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å°±åœ°å£°æ˜çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚ Before Adviceä½¿ç”¨@Beforeæ³¨è§£åœ¨åˆ‡é¢ä¸­å£°æ˜é€šçŸ¥ã€‚ import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Before;@Aspectpublic class BeforeExample &#123; @Before(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;) public void doAccessCheck() &#123; // ... &#125;&#125; å£°æ˜é€šçŸ¥çš„åŒæ—¶å£°æ˜åˆ‡å…¥ç‚¹ï¼š import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Before;@Aspectpublic class BeforeExample &#123; @Before(&quot;execution(* com.xyz.myapp.dao.*.*(..))&quot;) public void doAccessCheck() &#123; // ... &#125;&#125; After Returning Adviceimport org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.AfterReturning;@Aspectpublic class AfterReturningExample &#123; @AfterReturning(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;) public void doAccessCheck() &#123; // ... &#125;&#125; æœ‰æ—¶ï¼Œæ‚¨éœ€è¦åœ¨é€šçŸ¥æ­£æ–‡ä¸­è®¿é—®è¿”å›çš„å®é™…å€¼ã€‚æ‚¨å¯ä»¥ä½¿ç”¨@AfterReturningçš„å½¢å¼ç»‘å®šè¿”å›å€¼ä»¥è·å–è¯¥è®¿é—®æƒé™ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.AfterReturning;@Aspectpublic class AfterReturningExample &#123; @AfterReturning( pointcut=&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;, returning=&quot;retVal&quot;) public void doAccessCheck(Object retVal) &#123; // ... &#125;&#125; After Throwing Adviceimport org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.AfterThrowing;@Aspectpublic class AfterThrowingExample &#123; @AfterThrowing(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;) public void doRecoveryActions() &#123; // ... &#125;&#125; æŒ‡å®šå¼‚å¸¸ç±»å‹ï¼š import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.AfterThrowing;@Aspectpublic class AfterThrowingExample &#123; @AfterThrowing( pointcut=&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;, throwing=&quot;ex&quot;) public void doRecoveryActions(DataAccessException ex) &#123; // ... &#125;&#125; After (Finally) Adviceimport org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.After;@Aspectpublic class AfterFinallyExample &#123; @After(&quot;com.xyz.myapp.SystemArchitecture.dataAccessOperation()&quot;) public void doReleaseLock() &#123; // ... &#125;&#125; Around Adviceimport org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.ProceedingJoinPoint;@Aspectpublic class AroundExample &#123; @Around(&quot;com.xyz.myapp.SystemArchitecture.businessService()&quot;) public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable &#123; // start stopwatch Object retVal = pjp.proceed(); // stop stopwatch return retVal; &#125;&#125; å¼•å…¥å¼•å…¥ï¼ˆIntroductionsï¼‰ï¼ˆåœ¨AspectJä¸­ç§°ä¸ºç±»å‹é—´å£°æ˜ï¼‰ä½¿åˆ‡é¢å¯ä»¥å£°æ˜é€šçŸ¥å¯¹è±¡å®ç°ç»™å®šçš„æ¥å£ï¼Œå¹¶ä»£è¡¨é‚£äº›å¯¹è±¡æä¾›è¯¥æ¥å£çš„å®ç°ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨@DeclareParentsæ‰¹æ³¨è¿›è¡Œä»‹ç»ã€‚æ­¤æ‰¹æ³¨ç”¨äºå£°æ˜åŒ¹é…ç±»å‹å…·æœ‰æ–°çš„çˆ¶ä»£ï¼ˆå› æ­¤è€Œå¾—åï¼‰ã€‚ä¾‹å¦‚ï¼Œç»™å®šä¸€ä¸ªåä¸ºUsageTrackedçš„æ¥å£å’Œè¯¥æ¥å£åä¸ºDefaultUsageTrackedçš„å®ç°ï¼Œä»¥ä¸‹æ–¹é¢å£°æ˜æœåŠ¡æ¥å£çš„æ‰€æœ‰å®ç°è€…ä¹Ÿéƒ½å®ç°äº†UsageTrackedæ¥å£ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡JMXå…¬å¼€ç»Ÿè®¡ä¿¡æ¯ï¼‰ï¼š @Aspectpublic class UsageTracking &#123; @DeclareParents(value=&quot;com.xzy.myapp.service.*+&quot;, defaultImpl=DefaultUsageTracked.class) public static UsageTracked mixin; @Before(&quot;com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)&quot;) public void recordUsage(UsageTracked usageTracked) &#123; usageTracked.incrementUseCount(); &#125;&#125; Spring AOPå®ä¾‹ä»£ç åœ°å€ï¼šhttps://github.com/cayzlh/cayzlh-demos æ€»ç»“ Springå€Ÿé‰´äº†AspectJçš„è¯­æ³• Springé€šè¿‡åŠ¨æ€ä»£ç†æ¥å®ç°aop å¯¹æ¥å£åˆ›å»ºä»£ç†ä¼˜äºå¯¹ç±»åˆ›å»ºä»£ç†ï¼Œå› ä¸ºä¼šäº§ç”Ÿæ›´åŠ æ¾è€¦åˆçš„ç³»ç»Ÿï¼Œæ‰€ä»¥springé»˜è®¤æ˜¯ä½¿ç”¨JDKä»£ç†ã€‚å¯¹ç±»ä»£ç†æ˜¯è®©é—ç•™ç³»ç»Ÿæˆ–æ— æ³•å®ç°æ¥å£çš„ç¬¬ä¸‰æ–¹ç±»åº“åŒæ ·å¯ä»¥å¾—åˆ°é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼åº”è¯¥æ˜¯å¤‡ç”¨æ–¹æ¡ˆ æ ‡è®°ä¸ºfinalçš„æ–¹æ³•ä¸èƒ½å¤Ÿè¢«é€šçŸ¥ã€‚springæ˜¯ä¸ºç›®æ ‡ç±»äº§ç”Ÿå­ç±»ã€‚ä»»ä½•éœ€è¦è¢«é€šçŸ¥çš„æ–¹æ³•éƒ½è¢«å¤å†™ï¼Œå°†é€šçŸ¥ç»‡å…¥ã€‚finalæ–¹æ³•æ˜¯ä¸å…è®¸é‡å†™çš„ springåªæ”¯æŒæ–¹æ³•è¿æ¥ç‚¹ï¼šä¸æä¾›å±æ€§æ¥å…¥ç‚¹ï¼Œspringçš„è§‚ç‚¹æ˜¯å±æ€§æ‹¦æˆªç ´åäº†å°è£…ã€‚é¢å‘å¯¹è±¡çš„æ¦‚å¿µæ˜¯å¯¹è±¡è‡ªå·±å¤„ç†å·¥ä½œï¼Œå…¶ä»–å¯¹è±¡åªèƒ½é€šè¿‡æ–¹æ³•è°ƒç”¨çš„å¾—åˆ°çš„ç»“æœ springåœ¨è¿è¡ŒæœŸï¼Œç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨ Spring AOP ä¼˜å…ˆå¯¹æ¥å£è¿›è¡Œä»£ç† ï¼ˆä½¿ç”¨JdkåŠ¨æ€ä»£ç†ï¼‰å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œæ‰ä¼šå¯¹ç±»è¿›è¡Œä»£ç† ï¼ˆä½¿ç”¨cglibåŠ¨æ€ä»£ç†ï¼‰ å‚è€ƒ Springå®˜ç½‘(aop) Spring AOPç®€ä»‹ä¸åº•å±‚å®ç°æœºåˆ¶â€”â€”åŠ¨æ€ä»£ç† springæºç ç³»åˆ—ï¼ˆä¸€ï¼‰â€”â€”springå¾ªç¯å¼•ç”¨ å½»åº•å¾æœ Spring AOP ä¹‹ ç†è®ºç¯‡","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"}]},{"title":"Mybatisä¸­ç”¨åˆ°çš„å‡ ç§è®¾è®¡æ¨¡å¼","date":"2020-03-23T12:50:34.000Z","path":"2020/03/23/26b455b4.html","text":"æœ¬æ–‡è½¬è½½è‡ªï¼šhttp://www.crazyant.net/2022.html Mybatisè‡³å°‘é‡åˆ°äº†ä»¥ä¸‹çš„è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ï¼š Builderæ¨¡å¼ï¼Œä¾‹å¦‚SqlSessionFactoryBuilderã€XMLConfigBuilderã€XMLMapperBuilderã€XMLStatementBuilderã€CacheBuilderï¼› å·¥å‚æ¨¡å¼ï¼Œä¾‹å¦‚SqlSessionFactoryã€ObjectFactoryã€MapperProxyFactoryï¼› å•ä¾‹æ¨¡å¼ï¼Œä¾‹å¦‚ErrorContextå’ŒLogFactoryï¼› ä»£ç†æ¨¡å¼ï¼ŒMybatiså®ç°çš„æ ¸å¿ƒï¼Œæ¯”å¦‚MapperProxyã€ConnectionLoggerï¼Œç”¨çš„jdkçš„åŠ¨æ€ä»£ç†ï¼›è¿˜æœ‰executor.loaderåŒ…ä½¿ç”¨äº†cglibæˆ–è€…javassistè¾¾åˆ°å»¶è¿ŸåŠ è½½çš„æ•ˆæœï¼› ç»„åˆæ¨¡å¼ï¼Œä¾‹å¦‚SqlNodeå’Œå„ä¸ªå­ç±»ChooseSqlNodeç­‰ï¼› æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œä¾‹å¦‚BaseExecutorå’ŒSimpleExecutorï¼Œè¿˜æœ‰BaseTypeHandlerå’Œæ‰€æœ‰çš„å­ç±»ä¾‹å¦‚IntegerTypeHandlerï¼› é€‚é…å™¨æ¨¡å¼ï¼Œä¾‹å¦‚Logçš„Mybatisæ¥å£å’Œå®ƒå¯¹jdbcã€log4jç­‰å„ç§æ—¥å¿—æ¡†æ¶çš„é€‚é…å®ç°ï¼› è£…é¥°è€…æ¨¡å¼ï¼Œä¾‹å¦‚CacheåŒ…ä¸­çš„cache.decoratorså­åŒ…ä¸­ç­‰å„ä¸ªè£…é¥°è€…çš„å®ç°ï¼› è¿­ä»£å™¨æ¨¡å¼ï¼Œä¾‹å¦‚è¿­ä»£å™¨æ¨¡å¼PropertyTokenizerï¼› æ¥ä¸‹æ¥æŒ¨ä¸ªæ¨¡å¼è¿›è¡Œè§£è¯»ï¼Œå…ˆä»‹ç»æ¨¡å¼è‡ªèº«çš„çŸ¥è¯†ï¼Œç„¶åè§£è¯»åœ¨Mybatisä¸­æ€æ ·åº”ç”¨äº†è¯¥æ¨¡å¼ã€‚ Builderæ¨¡å¼Builderæ¨¡å¼çš„å®šä¹‰æ˜¯â€œå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºâ€ï¼Œå®ƒå±äºåˆ›å»ºç±»æ¨¡å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡çš„æ„å»ºæ¯”è¾ƒå¤æ‚ï¼Œè¶…å‡ºäº†æ„é€ å‡½æ•°æ‰€èƒ½åŒ…å«çš„èŒƒå›´ï¼Œå°±å¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼å’ŒBuilderæ¨¡å¼ï¼Œç›¸å¯¹äºå·¥å‚æ¨¡å¼ä¼šäº§å‡ºä¸€ä¸ªå®Œæ•´çš„äº§å“ï¼ŒBuilderåº”ç”¨äºæ›´åŠ å¤æ‚çš„å¯¹è±¡çš„æ„å»ºï¼Œç”šè‡³åªä¼šæ„å»ºäº§å“çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚ åœ¨Mybatisç¯å¢ƒçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒSqlSessionFactoryBuilderä¼šè°ƒç”¨XMLConfigBuilderè¯»å–æ‰€æœ‰çš„MybatisMapConfig.xmlå’Œæ‰€æœ‰çš„*Mapper.xmlæ–‡ä»¶ï¼Œæ„å»ºMybatisè¿è¡Œçš„æ ¸å¿ƒå¯¹è±¡Configurationå¯¹è±¡ï¼Œç„¶åå°†è¯¥Configurationå¯¹è±¡ä½œä¸ºå‚æ•°æ„å»ºä¸€ä¸ªSqlSessionFactoryå¯¹è±¡ã€‚ å…¶ä¸­XMLConfigBuilderåœ¨æ„å»ºConfigurationå¯¹è±¡æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨XMLMapperBuilderç”¨äºè¯»å–*Mapperæ–‡ä»¶ï¼Œè€ŒXMLMapperBuilderä¼šä½¿ç”¨XMLStatementBuilderæ¥è¯»å–å’Œbuildæ‰€æœ‰çš„SQLè¯­å¥ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªç›¸ä¼¼çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯è¿™äº›Builderä¼šè¯»å–æ–‡ä»¶æˆ–è€…é…ç½®ï¼Œç„¶ååšå¤§é‡çš„XpathParserè§£æã€é…ç½®æˆ–è¯­æ³•çš„è§£æã€åå°„ç”Ÿæˆå¯¹è±¡ã€å­˜å…¥ç»“æœç¼“å­˜ç­‰æ­¥éª¤ï¼Œè¿™ä¹ˆå¤šçš„å·¥ä½œéƒ½ä¸æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°æ‰€èƒ½åŒ…æ‹¬çš„ï¼Œå› æ­¤å¤§é‡é‡‡ç”¨äº†Builderæ¨¡å¼æ¥è§£å†³ã€‚ å¯¹äºbuilderçš„å…·ä½“ç±»ï¼Œæ–¹æ³•éƒ½å¤§éƒ½ç”¨build*å¼€å¤´ï¼Œæ¯”å¦‚SqlSessionFactoryBuilderä¸ºä¾‹ï¼Œå®ƒåŒ…å«ä»¥ä¸‹æ–¹æ³•ï¼š å³æ ¹æ®ä¸åŒçš„è¾“å…¥å‚æ•°æ¥æ„å»ºSqlSessionFactoryè¿™ä¸ªå·¥å‚å¯¹è±¡ã€‚ å·¥å‚æ¨¡å¼åœ¨Mybatisä¸­æ¯”å¦‚SqlSessionFactoryä½¿ç”¨çš„æ˜¯å·¥å‚æ¨¡å¼ï¼Œè¯¥å·¥å‚æ²¡æœ‰é‚£ä¹ˆå¤æ‚çš„é€»è¾‘ï¼Œæ˜¯ä¸€ä¸ªç®€å•å·¥å‚æ¨¡å¼ã€‚ ç®€å•å·¥å‚æ¨¡å¼(Simple Factory Pattern)ï¼šåˆç§°ä¸ºé™æ€å·¥å‚æ–¹æ³•(Static Factory Method)æ¨¡å¼ï¼Œå®ƒå±äºç±»åˆ›å»ºå‹æ¨¡å¼ã€‚åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ï¼Œå¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒè¿”å›ä¸åŒç±»çš„å®ä¾‹ã€‚ç®€å•å·¥å‚æ¨¡å¼ä¸“é—¨å®šä¹‰ä¸€ä¸ªç±»æ¥è´Ÿè´£åˆ›å»ºå…¶ä»–ç±»çš„å®ä¾‹ï¼Œè¢«åˆ›å»ºçš„å®ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„çˆ¶ç±»ã€‚ SqlSessionå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªMybatiså·¥ä½œçš„æ ¸å¿ƒçš„æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥æ‰§è¡Œæ‰§è¡ŒSQLè¯­å¥ã€è·å–Mappersã€ç®¡ç†äº‹åŠ¡ã€‚ç±»ä¼¼äºè¿æ¥MySQLçš„Connectionå¯¹è±¡ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œè¯¥Factoryçš„openSessionæ–¹æ³•é‡è½½äº†å¾ˆå¤šä¸ªï¼Œåˆ†åˆ«æ”¯æŒautoCommitã€Executorã€Transactionç­‰å‚æ•°çš„è¾“å…¥ï¼Œæ¥æ„å»ºæ ¸å¿ƒçš„SqlSessionå¯¹è±¡ã€‚ åœ¨DefaultSqlSessionFactoryçš„é»˜è®¤å·¥å‚å®ç°é‡Œï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºå·¥å‚æ€ä¹ˆäº§å‡ºä¸€ä¸ªäº§å“ï¼š private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123; Transaction tx = null; try &#123; final Environment environment = configuration.getEnvironment(); final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment); tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit); final Executor executor = configuration.newExecutor(tx, execType); return new DefaultSqlSession(configuration, executor, autoCommit); &#125; catch (Exception e) &#123; closeTransaction(tx); // may have fetched a connection so lets call // close() throw ExceptionFactory.wrapException(&quot;Error opening session. Cause: &quot; + e, e); &#125; finally &#123; ErrorContext.instance().reset(); &#125; &#125; è¿™æ˜¯ä¸€ä¸ªopenSessionè°ƒç”¨çš„åº•å±‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…ˆä»configurationè¯»å–å¯¹åº”çš„ç¯å¢ƒé…ç½®ï¼Œç„¶ååˆå§‹åŒ–TransactionFactoryè·å¾—ä¸€ä¸ªTransactionå¯¹è±¡ï¼Œç„¶åé€šè¿‡Transactionè·å–ä¸€ä¸ªExecutorå¯¹è±¡ï¼Œæœ€åé€šè¿‡configurationã€Executorã€æ˜¯å¦autoCommitä¸‰ä¸ªå‚æ•°æ„å»ºäº†SqlSessionã€‚ åœ¨è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥çœ‹åˆ°ç«¯å€ªï¼ŒSqlSessionçš„æ‰§è¡Œï¼Œå…¶å®æ˜¯å§”æ‰˜ç»™å¯¹åº”çš„Executoræ¥è¿›è¡Œçš„ã€‚ è€Œå¯¹äºLogFactoryï¼Œå®ƒçš„å®ç°ä»£ç ï¼š public final class LogFactory &#123; private static Constructor&lt;? extends Log&gt; logConstructor; private LogFactory() &#123; // disable construction &#125; public static Log getLog(Class&lt;?&gt; aClass) &#123; return getLog(aClass.getName()); &#125; è¿™é‡Œæœ‰ä¸ªç‰¹åˆ«çš„åœ°æ–¹ï¼Œæ˜¯Logå˜é‡çš„çš„ç±»å‹æ˜¯Constructorï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å·¥å‚ç”Ÿäº§çš„ä¸åªæ˜¯ä¸€ä¸ªäº§å“ï¼Œè€Œæ˜¯å…·æœ‰Logå…¬å…±æ¥å£çš„ä¸€ç³»åˆ—äº§å“ï¼Œæ¯”å¦‚Log4jImplã€Slf4jImplç­‰å¾ˆå¤šå…·ä½“çš„Logã€‚ å•ä¾‹æ¨¡å¼å•ä¾‹æ¨¡å¼(Singleton Pattern)ï¼šå•ä¾‹æ¨¡å¼ç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªç±»ç§°ä¸ºå•ä¾‹ç±»ï¼Œå®ƒæä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•ã€‚ å•ä¾‹æ¨¡å¼çš„è¦ç‚¹æœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼›äºŒæ˜¯å®ƒå¿…é¡»è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹ï¼›ä¸‰æ˜¯å®ƒå¿…é¡»è‡ªè¡Œå‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼ã€‚å•ä¾‹æ¨¡å¼åˆåå•ä»¶æ¨¡å¼æˆ–å•æ€æ¨¡å¼ã€‚ åœ¨Mybatisä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°å•ä¾‹æ¨¡å¼ï¼ŒErrorContextå’ŒLogFactoryï¼Œå…¶ä¸­ErrorContextæ˜¯ç”¨åœ¨æ¯ä¸ªçº¿ç¨‹èŒƒå›´å†…çš„å•ä¾‹ï¼Œç”¨äºè®°å½•è¯¥çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒé”™è¯¯ä¿¡æ¯ï¼Œè€ŒLogFactoryåˆ™æ˜¯æä¾›ç»™æ•´ä¸ªMybatisä½¿ç”¨çš„æ—¥å¿—å·¥å‚ï¼Œç”¨äºè·å¾—é’ˆå¯¹é¡¹ç›®é…ç½®å¥½çš„æ—¥å¿—å¯¹è±¡ã€‚ ErrorContextçš„å•ä¾‹å®ç°ä»£ç ï¼š public class ErrorContext &#123; private static final ThreadLocal&lt;ErrorContext&gt; LOCAL = new ThreadLocal&lt;ErrorContext&gt;(); private ErrorContext() &#123; &#125; public static ErrorContext instance() &#123; ErrorContext context = LOCAL.get(); if (context == null) &#123; context = new ErrorContext(); LOCAL.set(context); &#125; return context; &#125; æ„é€ å‡½æ•°æ˜¯privateä¿®é¥°ï¼Œå…·æœ‰ä¸€ä¸ªstaticçš„å±€éƒ¨instanceå˜é‡å’Œä¸€ä¸ªè·å–instanceå˜é‡çš„æ–¹æ³•ï¼Œåœ¨è·å–å®ä¾‹çš„æ–¹æ³•ä¸­ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç©ºå¦‚æœæ˜¯çš„è¯å°±å…ˆåˆ›å»ºï¼Œç„¶åè¿”å›æ„é€ å¥½çš„å¯¹è±¡ã€‚ åªæ˜¯è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„åœ°æ–¹æ˜¯ï¼ŒLOCALçš„é™æ€å®ä¾‹å˜é‡ä½¿ç”¨äº†ThreadLocalä¿®é¥°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå±äºæ¯ä¸ªçº¿ç¨‹å„è‡ªçš„æ•°æ®ï¼Œè€Œåœ¨instance()æ–¹æ³•ä¸­ï¼Œå…ˆè·å–æœ¬çº¿ç¨‹çš„è¯¥å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºè¯¥çº¿ç¨‹ç‹¬æœ‰çš„ErrorContextã€‚ ä»£ç†æ¨¡å¼ä»£ç†æ¨¡å¼å¯ä»¥è®¤ä¸ºæ˜¯Mybatisçš„æ ¸å¿ƒä½¿ç”¨çš„æ¨¡å¼ï¼Œæ­£æ˜¯ç”±äºè¿™ä¸ªæ¨¡å¼ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™Mapper.javaæ¥å£ï¼Œä¸éœ€è¦å®ç°ï¼Œç”±Mybatisåå°å¸®æˆ‘ä»¬å®Œæˆå…·ä½“SQLçš„æ‰§è¡Œã€‚ ä»£ç†æ¨¡å¼(Proxy Pattern) ï¼šç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ ç†ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå¯¹è±¡çš„å¼•ç”¨ã€‚ä»£ç†æ¨¡å¼çš„è‹± æ–‡å«åšProxyæˆ–Surrogateï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚ ä»£ç†æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š Subject: æŠ½è±¡ä¸»é¢˜è§’è‰² Proxy: ä»£ç†ä¸»é¢˜è§’è‰² RealSubject: çœŸå®ä¸»é¢˜è§’è‰² è¿™é‡Œæœ‰ä¸¤ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€ä¸ªæ˜¯æå‰åˆ›å»ºä¸€ä¸ªProxyï¼Œç¬¬äºŒä¸ªæ˜¯ä½¿ç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è¯·æ±‚Proxyï¼Œç„¶åç”±Proxyæ¥æ‰§è¡Œå…·ä½“äº‹åŠ¡ï¼› å½“æˆ‘ä»¬ä½¿ç”¨Configurationçš„getMapperæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨mapperRegistry.getMapperæ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•åˆä¼šè°ƒç”¨mapperProxyFactory.newInstance(sqlSession)æ¥ç”Ÿæˆä¸€ä¸ªå…·ä½“çš„ä»£ç†ï¼š return mapperInterface; &#125; public Map&lt;Method, MapperMethod&gt; getMethodCache() &#123; return methodCache; &#125; @SuppressWarnings(&quot;unchecked&quot;) protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123; return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy); &#125; public T newInstance(SqlSession sqlSession) &#123; final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache); return newInstance(mapperProxy); &#125;&#125; åœ¨è¿™é‡Œï¼Œå…ˆé€šè¿‡T newInstance(SqlSession sqlSession)æ–¹æ³•ä¼šå¾—åˆ°ä¸€ä¸ªMapperProxyå¯¹è±¡ï¼Œç„¶åè°ƒç”¨T newInstance(MapperProxy mapperProxy)ç”Ÿæˆä»£ç†å¯¹è±¡ç„¶åè¿”å›ã€‚ è€ŒæŸ¥çœ‹MapperProxyçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š public class MapperProxy&lt;T&gt; implements InvocationHandler, Serializable &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123; if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, args); &#125; else if (isDefaultMethod(method)) &#123; return invokeDefaultMethod(proxy, method, args); &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; final MapperMethod mapperMethod = cachedMapperMethod(method); return mapperMethod.execute(sqlSession, args); &#125; éå¸¸å…¸å‹çš„ï¼Œè¯¥MapperProxyç±»å®ç°äº†InvocationHandleræ¥å£ï¼Œå¹¶ä¸”å®ç°äº†è¯¥æ¥å£çš„invokeæ–¹æ³•ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™Mapper.javaæ¥å£ç±»ï¼Œå½“çœŸæ­£æ‰§è¡Œä¸€ä¸ªMapperæ¥å£çš„æ—¶å€™ï¼Œå°±ä¼šè½¬å‘ç»™MapperProxy.invokeæ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•åˆ™ä¼šè°ƒç”¨åç»­çš„sqlSession.cud&gt;executor.execute&gt;prepareStatementç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå®ŒæˆSQLçš„æ‰§è¡Œå’Œè¿”å›ã€‚ ç»„åˆæ¨¡å¼ç»„åˆæ¨¡å¼ç»„åˆå¤šä¸ªå¯¹è±¡å½¢æˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œæ•´ä½“-éƒ¨åˆ†â€çš„ç»“æ„å±‚æ¬¡ã€‚ ç»„åˆæ¨¡å¼å¯¹å•ä¸ªå¯¹è±¡(å¶å­å¯¹è±¡)å’Œç»„åˆå¯¹è±¡(ç»„åˆå¯¹è±¡)å…·æœ‰ä¸€è‡´æ€§ï¼Œå®ƒå°†å¯¹è±¡ç»„ç»‡åˆ°æ ‘ç»“æ„ä¸­ï¼Œå¯ä»¥ç”¨æ¥æè¿°æ•´ä½“ä¸éƒ¨åˆ†çš„å…³ç³»ã€‚åŒæ—¶å®ƒä¹Ÿæ¨¡ç³Šäº†ç®€å•å…ƒç´ (å¶å­å¯¹è±¡)å’Œå¤æ‚å…ƒç´ (å®¹å™¨å¯¹è±¡)çš„æ¦‚å¿µï¼Œä½¿å¾—å®¢æˆ·èƒ½å¤Ÿåƒå¤„ç†ç®€å•å…ƒç´ ä¸€æ ·æ¥å¤„ç†å¤æ‚å…ƒç´ ï¼Œä»è€Œä½¿å®¢æˆ·ç¨‹åºèƒ½å¤Ÿä¸å¤æ‚å…ƒç´ çš„å†…éƒ¨ç»“æ„è§£è€¦ã€‚ åœ¨ä½¿ç”¨ç»„åˆæ¨¡å¼ä¸­éœ€è¦æ³¨æ„ä¸€ç‚¹ä¹Ÿæ˜¯ç»„åˆæ¨¡å¼æœ€å…³é”®çš„åœ°æ–¹ï¼šå¶å­å¯¹è±¡å’Œç»„åˆå¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£ã€‚è¿™å°±æ˜¯ç»„åˆæ¨¡å¼èƒ½å¤Ÿå°†å¶å­èŠ‚ç‚¹å’Œå¯¹è±¡èŠ‚ç‚¹è¿›è¡Œä¸€è‡´å¤„ç†çš„åŸå› ã€‚ Mybatisæ”¯æŒåŠ¨æ€SQLçš„å¼ºå¤§åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™ä¸ªSQLï¼š &lt;update id=&quot;update&quot; parameterType=&quot;org.format.dynamicproxy.mybatis.bean.User&quot;&gt; UPDATE users &lt;trim prefix=&quot;SET&quot; prefixOverrides=&quot;,&quot;&gt; &lt;if test=&quot;name != null and name != &#x27;&#x27;&quot;&gt; name = #&#123;name&#125; &lt;/if&gt; &lt;if test=&quot;age != null and age != &#x27;&#x27;&quot;&gt; , age = #&#123;age&#125; &lt;/if&gt; &lt;if test=&quot;birthday != null and birthday != &#x27;&#x27;&quot;&gt; , birthday = #&#123;birthday&#125; &lt;/if&gt; &lt;/trim&gt; where id = $&#123;id&#125;&lt;/update&gt; åœ¨è¿™é‡Œé¢ä½¿ç”¨åˆ°äº†trimã€ifç­‰åŠ¨æ€å…ƒç´ ï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶æ¥ç”Ÿæˆä¸åŒæƒ…å†µä¸‹çš„SQLï¼› åœ¨DynamicSqlSource.getBoundSqlæ–¹æ³•é‡Œï¼Œè°ƒç”¨äº†rootSqlNode.apply(context)æ–¹æ³•ï¼Œapplyæ–¹æ³•æ˜¯æ‰€æœ‰çš„åŠ¨æ€èŠ‚ç‚¹éƒ½å®ç°çš„æ¥å£ï¼š public interface SqlNode &#123; boolean apply(DynamicContext context);&#125; å¯¹äºå®ç°è¯¥SqlSourceæ¥å£çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°±æ˜¯æ•´ä¸ªç»„åˆæ¨¡å¼æ ‘çš„å„ä¸ªèŠ‚ç‚¹ï¼š ç»„åˆæ¨¡å¼çš„ç®€å•ä¹‹å¤„åœ¨äºï¼Œæ‰€æœ‰çš„å­èŠ‚ç‚¹éƒ½æ˜¯åŒä¸€ç±»èŠ‚ç‚¹ï¼Œå¯ä»¥é€’å½’çš„å‘ä¸‹æ‰§è¡Œï¼Œæ¯”å¦‚å¯¹äºTextSqlNodeï¼Œå› ä¸ºå®ƒæ˜¯æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç›´æ¥å°†å¯¹åº”çš„å†…å®¹appendåˆ°SQLè¯­å¥ä¸­ï¼š @Overridepublic boolean apply(DynamicContext context) &#123; GenericTokenParser parser = createParser(new BindingTokenParser(context, injectionFilter)); context.appendSql(parser.parse(text)); return true;&#125; ä½†æ˜¯å¯¹äºIfSqlNodeï¼Œå°±éœ€è¦å…ˆåšåˆ¤æ–­ï¼Œå¦‚æœåˆ¤æ–­é€šè¿‡ï¼Œä»ç„¶ä¼šè°ƒç”¨å­å…ƒç´ çš„SqlNodeï¼Œå³contents.applyæ–¹æ³•ï¼Œå®ç°é€’å½’çš„è§£æã€‚ @Overridepublic boolean apply(DynamicContext context) &#123; if (evaluator.evaluateBoolean(test, context.getBindings())) &#123; contents.apply(context); return true; &#125; return false;&#125; æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯æ‰€æœ‰æ¨¡å¼ä¸­æœ€ä¸ºå¸¸è§çš„å‡ ä¸ªæ¨¡å¼ä¹‹ä¸€ï¼Œæ˜¯åŸºäºç»§æ‰¿çš„ä»£ç å¤ç”¨çš„åŸºæœ¬æŠ€æœ¯ã€‚ æ¨¡æ¿æ–¹æ³•æ¨¡å¼éœ€è¦å¼€å‘æŠ½è±¡ç±»å’Œå…·ä½“å­ç±»çš„è®¾è®¡å¸ˆä¹‹é—´çš„åä½œã€‚ä¸€ä¸ªè®¾è®¡å¸ˆè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ï¼Œå¦ä¸€äº›è®¾è®¡å¸ˆåˆ™è´Ÿè´£ç»™å‡ºè¿™ä¸ªç®—æ³•çš„å„ä¸ªé€»è¾‘æ­¥éª¤ã€‚ä»£è¡¨è¿™äº›å…·ä½“é€»è¾‘æ­¥éª¤çš„æ–¹æ³•ç§°åšåŸºæœ¬æ–¹æ³•(primitive method)ï¼›è€Œå°†è¿™äº›åŸºæœ¬æ–¹æ³•æ±‡æ€»èµ·æ¥çš„æ–¹æ³•å«åšæ¨¡æ¿æ–¹æ³•(template method)ï¼Œè¿™ä¸ªè®¾è®¡æ¨¡å¼çš„åå­—å°±æ˜¯ä»æ­¤è€Œæ¥ã€‚ æ¨¡æ¿ç±»å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚ åœ¨Mybatisä¸­ï¼ŒsqlSessionçš„SQLæ‰§è¡Œï¼Œéƒ½æ˜¯å§”æ‰˜ç»™Executorå®ç°çš„ï¼ŒExecutoråŒ…å«ä»¥ä¸‹ç»“æ„ï¼š å…¶ä¸­çš„BaseExecutorå°±é‡‡ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå®ƒå®ç°äº†å¤§éƒ¨åˆ†çš„SQLæ‰§è¡Œé€»è¾‘ï¼Œç„¶åæŠŠä»¥ä¸‹å‡ ä¸ªæ–¹æ³•äº¤ç»™å­ç±»å®šåˆ¶åŒ–å®Œæˆï¼š @Override public boolean apply(DynamicContext context) &#123; if (evaluator.evaluateBoolean(test, context.getBindings())) &#123; contents.apply(context); return true; &#125; return false; &#125; è¯¥æ¨¡æ¿æ–¹æ³•ç±»æœ‰å‡ ä¸ªå­ç±»çš„å…·ä½“å®ç°ï¼Œä½¿ç”¨äº†ä¸åŒçš„ç­–ç•¥ï¼š ç®€å•SimpleExecutorï¼šæ¯æ‰§è¡Œä¸€æ¬¡updateæˆ–selectï¼Œå°±å¼€å¯ä¸€ä¸ªStatementå¯¹è±¡ï¼Œç”¨å®Œç«‹åˆ»å…³é—­Statementå¯¹è±¡ã€‚ï¼ˆå¯ä»¥æ˜¯Statementæˆ–PrepareStatementå¯¹è±¡ï¼‰ é‡ç”¨ReuseExecutorï¼šæ‰§è¡Œupdateæˆ–selectï¼Œä»¥sqlä½œä¸ºkeyæŸ¥æ‰¾Statementå¯¹è±¡ï¼Œå­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºï¼Œç”¨å®Œåï¼Œä¸å…³é—­Statementå¯¹è±¡ï¼Œè€Œæ˜¯æ”¾ç½®äºMapå†…ï¼Œä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨ã€‚ï¼ˆå¯ä»¥æ˜¯Statementæˆ–PrepareStatementå¯¹è±¡ï¼‰ æ‰¹é‡BatchExecutorï¼šæ‰§è¡Œupdateï¼ˆæ²¡æœ‰selectï¼ŒJDBCæ‰¹å¤„ç†ä¸æ”¯æŒselectï¼‰ï¼Œå°†æ‰€æœ‰sqléƒ½æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­ï¼ˆaddBatch()ï¼‰ï¼Œç­‰å¾…ç»Ÿä¸€æ‰§è¡Œï¼ˆexecuteBatch()ï¼‰ï¼Œå®ƒç¼“å­˜äº†å¤šä¸ªStatementå¯¹è±¡ï¼Œæ¯ä¸ªStatementå¯¹è±¡éƒ½æ˜¯addBatch()å®Œæ¯•åï¼Œç­‰å¾…é€ä¸€æ‰§è¡ŒexecuteBatch()æ‰¹å¤„ç†çš„ï¼›BatchExecutorç›¸å½“äºç»´æŠ¤äº†å¤šä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶é‡Œéƒ½è£…äº†å¾ˆå¤šå±äºè‡ªå·±çš„SQLï¼Œå°±åƒè‹¹æœè“é‡Œè£…äº†å¾ˆå¤šè‹¹æœï¼Œç•ªèŒ„è“é‡Œè£…äº†å¾ˆå¤šç•ªèŒ„ï¼Œæœ€åï¼Œå†ç»Ÿä¸€å€’è¿›ä»“åº“ã€‚ï¼ˆå¯ä»¥æ˜¯Statementæˆ–PrepareStatementå¯¹è±¡ï¼‰ æ¯”å¦‚åœ¨SimpleExecutorä¸­è¿™æ ·å®ç°updateæ–¹æ³•ï¼š @Overridepublic int doUpdate(MappedStatement ms, Object parameter) throws SQLException &#123; Statement stmt = null; try &#123; Configuration configuration = ms.getConfiguration(); StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null); stmt = prepareStatement(handler, ms.getStatementLog()); return handler.update(stmt); &#125; finally &#123; closeStatement(stmt); &#125;&#125; é€‚é…å™¨æ¨¡å¼é€‚é…å™¨æ¨¡å¼(Adapter Pattern) ï¼šå°†ä¸€ä¸ªæ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œé€‚é…å™¨æ¨¡å¼ä½¿æ¥å£ä¸å…¼å®¹çš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œï¼Œå…¶åˆ«åä¸ºåŒ…è£…å™¨(Wrapper)ã€‚é€‚é…å™¨æ¨¡å¼æ—¢å¯ä»¥ä½œä¸ºç±»ç»“æ„å‹æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚ åœ¨Mybatsiçš„loggingåŒ…ä¸­ï¼Œæœ‰ä¸€ä¸ªLogæ¥å£ï¼š public interface Log &#123; boolean isDebugEnabled(); boolean isTraceEnabled(); void error(String s, Throwable e); void error(String s); void debug(String s); void trace(String s); void warn(String s);&#125; è¯¥æ¥å£å®šä¹‰äº†Mybatisç›´æ¥ä½¿ç”¨çš„æ—¥å¿—æ–¹æ³•ï¼Œè€ŒLogæ¥å£å…·ä½“ç”±è°æ¥å®ç°å‘¢ï¼ŸMybatisæä¾›äº†å¤šç§æ—¥å¿—æ¡†æ¶çš„å®ç°ï¼Œè¿™äº›å®ç°éƒ½åŒ¹é…è¿™ä¸ªLogæ¥å£æ‰€å®šä¹‰çš„æ¥å£æ–¹æ³•ï¼Œæœ€ç»ˆå®ç°äº†æ‰€æœ‰å¤–éƒ¨æ—¥å¿—æ¡†æ¶åˆ°Mybatisæ—¥å¿—åŒ…çš„é€‚é…ï¼š æ¯”å¦‚å¯¹äºLog4jImplçš„å®ç°æ¥è¯´ï¼Œè¯¥å®ç°æŒæœ‰äº†org.apache.log4j.Loggerçš„å®ä¾‹ï¼Œç„¶åæ‰€æœ‰çš„æ—¥å¿—æ–¹æ³•ï¼Œå‡å§”æ‰˜è¯¥å®ä¾‹æ¥å®ç°ã€‚ public class Log4jImpl implements Log &#123; private static final String FQCN = Log4jImpl.class.getName(); private Logger log; public Log4jImpl(String clazz) &#123; log = Logger.getLogger(clazz); &#125; @Override public boolean isDebugEnabled() &#123; return log.isDebugEnabled(); &#125; @Override public boolean isTraceEnabled() &#123; return log.isTraceEnabled(); &#125; @Override public void error(String s, Throwable e) &#123; log.log(FQCN, Level.ERROR, s, e); &#125; @Override public void error(String s) &#123; log.log(FQCN, Level.ERROR, s, null); &#125; @Override public void debug(String s) &#123; log.log(FQCN, Level.DEBUG, s, null); &#125; @Override public void trace(String s) &#123; log.log(FQCN, Level.TRACE, s, null); &#125; @Override public void warn(String s) &#123; log.log(FQCN, Level.WARN, s, null); &#125;&#125; è£…é¥°è€…æ¨¡å¼è£…é¥°æ¨¡å¼(Decorator Pattern) ï¼šåŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ ä¸€äº›é¢å¤–çš„èŒè´£(Responsibility)ï¼Œå°±å¢åŠ å¯¹è±¡åŠŸèƒ½æ¥è¯´ï¼Œè£…é¥°æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»å®ç°æ›´ä¸ºçµæ´»ã€‚å…¶åˆ«åä¹Ÿå¯ä»¥ç§°ä¸ºåŒ…è£…å™¨(Wrapper)ï¼Œä¸é€‚é…å™¨æ¨¡å¼çš„åˆ«åç›¸åŒï¼Œä½†å®ƒä»¬é€‚ç”¨äºä¸åŒçš„åœºåˆã€‚æ ¹æ®ç¿»è¯‘çš„ä¸åŒï¼Œè£…é¥°æ¨¡å¼ä¹Ÿæœ‰äººç§°ä¹‹ä¸ºâ€œæ²¹æ¼†å·¥æ¨¡å¼â€ï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚ åœ¨mybatisä¸­ï¼Œç¼“å­˜çš„åŠŸèƒ½ç”±æ ¹æ¥å£Cacheï¼ˆorg.apache.ibatis.cache.Cacheï¼‰å®šä¹‰ã€‚æ•´ä¸ªä½“ç³»é‡‡ç”¨è£…é¥°å™¨è®¾è®¡æ¨¡å¼ï¼Œæ•°æ®å­˜å‚¨å’Œç¼“å­˜çš„åŸºæœ¬åŠŸèƒ½ç”±PerpetualCacheï¼ˆorg.apache.ibatis.cache.impl.PerpetualCacheï¼‰æ°¸ä¹…ç¼“å­˜å®ç°ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ—çš„è£…é¥°å™¨æ¥å¯¹PerpetualCacheæ°¸ä¹…ç¼“å­˜è¿›è¡Œç¼“å­˜ç­–ç•¥ç­‰æ–¹ä¾¿çš„æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š ç”¨äºè£…é¥°PerpetualCacheçš„æ ‡å‡†è£…é¥°å™¨å…±æœ‰8ä¸ªï¼ˆå…¨éƒ¨åœ¨org.apache.ibatis.cache.decoratorsåŒ…ä¸­ï¼‰ï¼š FifoCacheï¼šå…ˆè¿›å…ˆå‡ºç®—æ³•ï¼Œç¼“å­˜å›æ”¶ç­–ç•¥ LoggingCacheï¼šè¾“å‡ºç¼“å­˜å‘½ä¸­çš„æ—¥å¿—ä¿¡æ¯ LruCacheï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œç¼“å­˜å›æ”¶ç­–ç•¥ ScheduledCacheï¼šè°ƒåº¦ç¼“å­˜ï¼Œè´Ÿè´£å®šæ—¶æ¸…ç©ºç¼“å­˜ SerializedCacheï¼šç¼“å­˜åºåˆ—åŒ–å’Œååºåˆ—åŒ–å­˜å‚¨ SoftCacheï¼šåŸºäºè½¯å¼•ç”¨å®ç°çš„ç¼“å­˜ç®¡ç†ç­–ç•¥ SynchronizedCacheï¼šåŒæ­¥çš„ç¼“å­˜è£…é¥°å™¨ï¼Œç”¨äºé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘è®¿é—® WeakCacheï¼šåŸºäºå¼±å¼•ç”¨å®ç°çš„ç¼“å­˜ç®¡ç†ç­–ç•¥ å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è£…é¥°å™¨TransactionalCacheï¼šäº‹åŠ¡æ€§çš„ç¼“å­˜æ­£å¦‚å¤§å¤šæ•°æŒä¹…å±‚æ¡†æ¶ä¸€æ ·ï¼Œmybatisç¼“å­˜åŒæ ·åˆ†ä¸ºä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ ä¸€çº§ç¼“å­˜ï¼Œåˆå«æœ¬åœ°ç¼“å­˜ï¼Œæ˜¯PerpetualCacheç±»å‹çš„æ°¸ä¹…ç¼“å­˜ï¼Œä¿å­˜åœ¨æ‰§è¡Œå™¨ä¸­ï¼ˆBaseExecutorï¼‰ï¼Œè€Œæ‰§è¡Œå™¨åˆåœ¨SqlSessionï¼ˆDefaultSqlSessionï¼‰ä¸­ï¼Œæ‰€ä»¥ä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸä¸SqlSessionæ˜¯ç›¸åŒçš„ã€‚ äºŒçº§ç¼“å­˜ï¼Œåˆå«è‡ªå®šä¹‰ç¼“å­˜ï¼Œå®ç°äº†Cacheæ¥å£çš„ç±»éƒ½å¯ä»¥ä½œä¸ºäºŒçº§ç¼“å­˜ï¼Œæ‰€ä»¥å¯é…ç½®å¦‚encacheç­‰çš„ç¬¬ä¸‰æ–¹ç¼“å­˜ã€‚äºŒçº§ç¼“å­˜ä»¥namespaceåç§°ç©ºé—´ä¸ºå…¶å”¯ä¸€æ ‡è¯†ï¼Œè¢«ä¿å­˜åœ¨Configurationæ ¸å¿ƒé…ç½®å¯¹è±¡ä¸­ã€‚ äºŒçº§ç¼“å­˜å¯¹è±¡çš„é»˜è®¤ç±»å‹ä¸ºPerpetualCacheï¼Œå¦‚æœé…ç½®çš„ç¼“å­˜æ˜¯é»˜è®¤ç±»å‹ï¼Œåˆ™mybatisä¼šæ ¹æ®é…ç½®è‡ªåŠ¨è¿½åŠ ä¸€ç³»åˆ—è£…é¥°å™¨ã€‚ Cacheå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨é¡ºåºä¸ºï¼š SynchronizedCacheâ€“&gt;LoggingCacheâ€“&gt;SerializedCacheâ€“&gt;ScheduledCacheâ€“&gt;LruCacheâ€“&gt;PerpetualCache è¿­ä»£å™¨æ¨¡å¼è¿­ä»£å™¨ï¼ˆIteratorï¼‰æ¨¡å¼ï¼Œåˆå«åšæ¸¸æ ‡ï¼ˆCursorï¼‰æ¨¡å¼ã€‚GOFç»™å‡ºçš„å®šä¹‰ä¸ºï¼šæä¾›ä¸€ç§æ–¹æ³•è®¿é—®ä¸€ä¸ªå®¹å™¨ï¼ˆcontainerï¼‰å¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨ç»†èŠ‚ã€‚ Javaçš„Iteratorå°±æ˜¯è¿­ä»£å™¨æ¨¡å¼çš„æ¥å£ï¼Œåªè¦å®ç°äº†è¯¥æ¥å£ï¼Œå°±ç›¸å½“äºåº”ç”¨äº†è¿­ä»£å™¨æ¨¡å¼ï¼š æ¯”å¦‚Mybatisçš„PropertyTokenizeræ˜¯propertyåŒ…ä¸­çš„é‡é‡çº§ç±»ï¼Œè¯¥ç±»ä¼šè¢«reflectionåŒ…ä¸­å…¶ä»–çš„ç±»é¢‘ç¹çš„å¼•ç”¨åˆ°ã€‚è¿™ä¸ªç±»å®ç°äº†Iteratoræ¥å£ï¼Œåœ¨ä½¿ç”¨æ—¶ç»å¸¸è¢«ç”¨åˆ°çš„æ˜¯Iteratoræ¥å£ä¸­çš„hasNextè¿™ä¸ªå‡½æ•°ã€‚ public class PropertyTokenizer implements Iterator&lt;PropertyTokenizer&gt; &#123; private String name; private String indexedName; private String index; private String children; public PropertyTokenizer(String fullname) &#123; int delim = fullname.indexOf(&#x27;.&#x27;); if (delim &gt; -1) &#123; name = fullname.substring(0, delim); children = fullname.substring(delim + 1); &#125; else &#123; name = fullname; children = null; &#125; indexedName = name; delim = name.indexOf(&#x27;[&#x27;); if (delim &gt; -1) &#123; index = name.substring(delim + 1, name.length() - 1); name = name.substring(0, delim); &#125; &#125; public String getName() &#123; return name; &#125; public String getIndex() &#123; return index; &#125; public String getIndexedName() &#123; return indexedName; &#125; public String getChildren() &#123; return children; &#125; @Override public boolean hasNext() &#123; return children != null; &#125; @Override public PropertyTokenizer next() &#123; return new PropertyTokenizer(children); &#125; @Override public void remove() &#123; throw new UnsupportedOperationException( &quot;Remove is not supported, as it has no meaning in the context of properties.&quot;); &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²åˆ°æ„é€ å‡½æ•°ï¼Œç„¶åæä¾›äº†iteratoræ–¹æ³•å¯¹è§£æåçš„å­ä¸²è¿›è¡Œéå†ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„æ–¹æ³•ç±»ã€‚ å‚è€ƒèµ„æ–™ å›¾è¯´è®¾è®¡æ¨¡å¼ æ·±å…¥æµ…å‡ºMybatisç³»åˆ—ï¼ˆåï¼‰â€”SQLæ‰§è¡Œæµç¨‹åˆ†æï¼ˆæºç ç¯‡ï¼‰ è®¾è®¡æ¨¡å¼è¯»ä¹¦ç¬”è®°â€”â€“ç»„åˆæ¨¡å¼ Mybatis3.3.xæŠ€æœ¯å†…å¹•ï¼ˆå››ï¼‰ï¼šäº”é¼ é—¹ä¸œäº¬ä¹‹æ‰§è¡Œå™¨Executorè®¾è®¡åŸæœ¬ mybatisç¼“å­˜æœºåˆ¶è¯¦è§£ï¼ˆä¸€ï¼‰â€”â€”Cache","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"}],"categories":[{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.cayzlh.com/categories/%E6%A1%86%E6%9E%B6/"},{"name":"MyBatis","slug":"æ¡†æ¶/MyBatis","permalink":"https://www.cayzlh.com/categories/%E6%A1%86%E6%9E%B6/MyBatis/"}]},{"title":"Spring AOPå’ŒSpring Transactionæºç èµ„æ–™æ•´ç†","date":"2020-01-27T09:07:23.000Z","path":"2020/01/27/9cf21717.html","text":"å‰ç½®å‰é¢å­¦ä¹ äº†Spring AOPçš„æºç ï¼Œæ¥ä¸‹æ¥å‡†å¤‡çœ‹AOPç›¸å…³æºç ã€‚Spring AOPåŸºäºSpring IOCæœºåˆ¶ã€‚ åœ¨å­¦ä¹ å®ŒSpring AOPä¹‹åå¯ä»¥ç»§ç»­çœ‹çœ‹Spring Transactionæºç ã€‚ è°ƒè¯•Spring AOPé€šè¿‡è°ƒè¯• org.springframework.aop.aspectj.autoproxy.AspectJAutoProxyCreatorTests è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•ï¼Œæ¥è·Ÿæºç ã€‚ Spring Transaction è°ƒè¯• &lt;tx:advice /&gt; æ ‡ç­¾çš„è§£æçš„æµç¨‹ å¯è°ƒè¯• org.springframework.transaction.TxNamespaceHandlerTests è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•ã€‚ #invokeTransactional() æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚ #rollbackRules() æ–¹æ³•ï¼Œå›æ»šäº‹åŠ¡ã€‚ è°ƒè¯• @Transactional æ³¨è§£çš„è§£æçš„æµç¨‹ ä½¿ç”¨çš„è¿˜æ˜¯ org.springframework.transaction.TxNamespaceHandlerTests è¿™ä¸ªå•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³• èµ„æ–™æ•´ç†Spring AOP Spring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ) - AOPéƒ¨åˆ† ã€Šã€Springæºç åˆ†æã€‘AOPæºç è§£æï¼ˆä¸Šç¯‡ï¼‰ã€‹ ï¼Œå¯¹ Spring AOP XML é…ç½®çš„æ–¹å¼è¿›è¡Œæºç è§£æã€‚ ã€Šã€Springæºç åˆ†æã€‘AOPæºç è§£æï¼ˆä¸‹ç¯‡ï¼‰ã€‹ ï¼Œå’ŒSpring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ) çš„å†…å®¹ç›¸äº’è¡¥å…… Spring Transaction Spring æºç æ·±åº¦è§£æ(ç¬¬2ç‰ˆ) - äº‹åŠ¡ç›¸å…³éƒ¨åˆ† ã€ŠåŸåˆ› Spring æºç è§£æä¹‹äº‹åŠ¡ç¯‡ã€‹ ã€ŠSpring-äº‹åŠ¡çš„æºç åˆ†æï¼ˆä¸ƒï¼‰ã€‹ ã€Šå¯èƒ½æ˜¯æœ€æ¼‚äº®çš„ Spring äº‹åŠ¡ç®¡ç†è¯¦è§£ã€‹ åç½®Spring MVC","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://www.cayzlh.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ","date":"2020-01-26T07:08:04.000Z","path":"2020/01/26/101fc769.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4045 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE bean çš„è½¬æ¢è¿‡ç¨‹ä¸‹é¢è¿™å¼ å›¾æ¼”ç¤ºäº†ä¸€ä¸ªå¯ç”¨çš„beanæ˜¯å¦‚ä½•ä»xmlé…ç½®æ–‡ä»¶ä¸­æ¼”å˜è¿‡æ¥çš„. ApplicationContext çš„æ¶æ„å›¾ loadBean çš„å…¨æµç¨‹ getBean çš„å…¨æµç¨‹","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"æ·±å…¥åˆ†æApplicationContextçš„refresh()","date":"2020-01-26T06:53:43.000Z","path":"2020/01/26/ea3a33da.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4043 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE ä¸Šç¯‡åšå®¢å¯¹ ApplicationContext ç›¸å…³çš„æ¥å£åšäº†ä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œä½œä¸ºä¸€ä¸ªé«˜å¯Œå¸…çº§åˆ«çš„ Spring å®¹å™¨ï¼Œå®ƒæ¶‰åŠçš„æ–¹æ³•å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå…¨éƒ¨ä»‹ç»æ˜¯ä¸å¯èƒ½çš„ï¼Œè€Œä¸”å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½å·²ç»åœ¨å‰é¢ç³»åˆ—åšå®¢ä¸­åšäº†è¯¦ç»†çš„ä»‹ç»ï¼Œæ‰€ä»¥è¿™ç¯‡åšé—®ä»‹ç» ApplicationContext æœ€é‡è¦çš„æ–¹æ³•ï¼ˆå°ç¼–è®¤ä¸ºçš„ï¼‰ ï¼šrefresh()ã€‚ refresh() æ˜¯å®šä¹‰åœ¨ ConfigurableApplicationContext ç±»ä¸­çš„ï¼Œå¦‚ä¸‹ï¼š /** * Load or refresh the persistent representation of the configuration, * which might an XML file, properties file, or relational database schema. * As this is a startup method, it should destroy already created singletons * if it fails, to avoid dangling resources. In other words, after invocation * of that method, either all or no singletons at all should be instantiated. * @throws BeansException if the bean factory could not be initialized * @throws IllegalStateException if already initialized and multiple refresh * attempts are not supported */void refresh() throws BeansException, IllegalStateException; ä½œç”¨å°±æ˜¯ï¼šåˆ·æ–° Spring çš„åº”ç”¨ä¸Šä¸‹æ–‡ã€‚å…¶å®ç°æ˜¯åœ¨ AbstractApplicationContext ä¸­å®ç°ã€‚å¦‚ä¸‹ï¼š @Overridepublic void refresh() throws BeansException, IllegalStateException &#123; synchronized (this.startupShutdownMonitor) &#123; // å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡ç¯å¢ƒ prepareRefresh(); // åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // å¡«å……BeanFactoryåŠŸèƒ½ prepareBeanFactory(beanFactory); try &#123; // æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess postProcessBeanFactory(beanFactory); // æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨ invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor registerBeanPostProcessors(beanFactory); // åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰ initMessageSource(); // åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨ initApplicationEventMulticaster(); // ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean onRefresh(); // åœ¨æ‰€æœ‰beanä¸­æŸ¥æ‰¾listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­ registerListeners(); // åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„) finishBeanFactoryInitialization(beanFactory); // å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨lifecycleProcessoråˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡ºContextRefreshEventé€šçŸ¥åˆ«äºº finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); &#125; // é”€æ¯å·²ç»åˆ›å»ºçš„Bean destroyBeans(); // é‡ç½®å®¹å™¨æ¿€æ´»æ ‡ç­¾ cancelRefresh(ex); // æŠ›å‡ºå¼‚å¸¸ throw ex; &#125; finally &#123; // Reset common introspection caches in Spring&#x27;s core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); &#125; &#125;&#125; è¿™é‡Œæ¯ä¸€ä¸ªæ–¹æ³•éƒ½éå¸¸é‡è¦ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªåœ°è§£é‡Šè¯´æ˜ã€‚ prepareRefresh() åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¯¹ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡æˆ–è€…ç³»ç»Ÿå±æ€§è¿›è¡Œå‡†å¤‡å’Œæ ¡éªŒ,å¦‚ç¯å¢ƒå˜é‡ä¸­å¿…é¡»è®¾ç½®æŸä¸ªå€¼æ‰èƒ½è¿è¡Œï¼Œå¦åˆ™ä¸èƒ½è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨è¿™é‡ŒåŠ è¿™ä¸ªæ ¡éªŒï¼Œé‡å†™initPropertySourcesæ–¹æ³•å°±å¥½äº† protected void prepareRefresh() &#123; // è®¾ç½®å¯åŠ¨æ—¥æœŸ this.startupDate = System.currentTimeMillis(); // è®¾ç½® context å½“å‰çŠ¶æ€ this.closed.set(false); this.active.set(true); if (logger.isInfoEnabled()) &#123; logger.info(&quot;Refreshing &quot; + this); &#125; // åˆå§‹åŒ–context environmentï¼ˆä¸Šä¸‹æ–‡ç¯å¢ƒï¼‰ä¸­çš„å ä½ç¬¦å±æ€§æ¥æº initPropertySources(); // å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯ getEnvironment().validateRequiredProperties(); this.earlyApplicationEvents = new LinkedHashSet&lt;&gt;();&#125; è¯¥æ–¹æ³•ä¸»è¦æ˜¯åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå¦‚ï¼š è®¾ç½® context å¯åŠ¨æ—¶é—´ è®¾ç½® context çš„å½“å‰çŠ¶æ€ åˆå§‹åŒ– context environment ä¸­å ä½ç¬¦ å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯ obtainFreshBeanFactory() åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; // åˆ·æ–° BeanFactory refreshBeanFactory(); // è·å– BeanFactory ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory); &#125; return beanFactory;&#125; æ ¸å¿ƒæ–¹æ³•å°±åœ¨ refreshBeanFactory() ï¼Œè¯¥æ–¹æ³•çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯åˆ›å»º BeanFactory å¹¶å¯¹å…¶å°±è¡Œä¸€ç•ªåˆå§‹åŒ–ã€‚å¦‚ä¸‹ï¼š protected final void refreshBeanFactory() throws BeansException &#123; if (hasBeanFactory()) &#123; destroyBeans(); closeBeanFactory(); &#125; try &#123; DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); customizeBeanFactory(beanFactory); loadBeanDefinitions(beanFactory); synchronized (this.beanFactoryMonitor) &#123; this.beanFactory = beanFactory; &#125; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); &#125;&#125; åˆ¤æ–­å½“å‰å®¹å™¨æ˜¯å¦å­˜åœ¨ä¸€ä¸ª BeanFactoryï¼Œå¦‚æœå­˜åœ¨åˆ™å¯¹å…¶è¿›è¡Œé”€æ¯å’Œå…³é—­ è°ƒç”¨ createBeanFactory() åˆ›å»ºä¸€ä¸ª BeanFactory å®ä¾‹ï¼Œå…¶å®å°±æ˜¯ DefaultListableBeanFactory è‡ªå®šä¹‰ BeanFactory åŠ è½½ BeanDefinition å°†åˆ›å»ºå¥½çš„ bean å·¥å‚çš„å¼•ç”¨äº¤ç»™çš„ context æ¥ç®¡ç† ä¸Šé¢ 5 ä¸ªæ­¥éª¤ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯æœ‰å¿…è¦è®²è§£ä¸‹ç¬¬ 4 æ­¥ï¼šåŠ è½½ BeanDefinitionã€‚å¦‚æœå„ä½çœ‹è¿‡ ã€æ­»ç£• Springã€‘ç³»åˆ—çš„è¯ï¼Œåœ¨åˆšåˆšå¼€å§‹åˆ†ææºç çš„æ—¶å€™ï¼Œå°ç¼–å°±æ˜¯ä»¥ loadBeanDefinitions() ä¸ºå…¥å£æ¥åˆ†æçš„ï¼Œå¦‚ä¸‹ï¼š ClassPathResource resource = new ClassPathResource(&quot;bean.xml&quot;);DefaultListableBeanFactory factory = new DefaultListableBeanFactory();XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);reader.loadBeanDefinitions(resource); åªä¸è¿‡è¿™æ®µä»£ç çš„ loadBeanDefinitions() æ˜¯å®šä¹‰åœ¨ BeanDefinitionReader ä¸­ï¼Œè€Œæ­¤å¤„çš„ loadBeanDefinitions() åˆ™æ˜¯å®šä¹‰åœ¨ AbstractRefreshableApplicationContext ä¸­ï¼Œå¦‚ä¸‹ï¼š protected abstract void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException ç”±å…·ä½“çš„å­ç±»å®ç°ï¼Œæˆ‘ä»¬ä»¥ AbstractXmlApplicationContext ä¸ºä¾‹ï¼Œå®ç°å¦‚ä¸‹ï¼š protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123; // Create a new XmlBeanDefinitionReader for the given BeanFactory. XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context&#x27;s // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // then proceed with actually loading the bean definitions. initBeanDefinitionReader(beanDefinitionReader); loadBeanDefinitions(beanDefinitionReader);&#125; æ–°å»º XmlBeanDefinitionReader å®ä¾‹å¯¹è±¡ beanDefinitionReaderï¼Œè°ƒç”¨ initBeanDefinitionReader() å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ loadBeanDefinitions() åŠ è½½ BeanDefinitionã€‚ protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123; Resource[] configResources = getConfigResources(); if (configResources != null) &#123; reader.loadBeanDefinitions(configResources); &#125; String[] configLocations = getConfigLocations(); if (configLocations != null) &#123; reader.loadBeanDefinitions(configLocations); &#125;&#125; åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®å†…éƒ¨ä¾ç„¶æ˜¯è°ƒç”¨ BeanDefinitionReader#loadBeanDefinitionn() è¿›è¡Œ BeanDefinition çš„åŠ è½½è¿›ç¨‹ã€‚ prepareBeanFactory(beanFactory) å¡«å…… BeanFactory åŠŸèƒ½ ä¸Šé¢è·å–è·å–çš„ BeanFactory é™¤äº†åŠ è½½äº†ä¸€äº› BeanDefinition å°±æ²¡æœ‰å…¶ä»–ä»»ä½•ä¸œè¥¿äº†ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®è¿˜ä¸èƒ½æŠ•å…¥ç”Ÿäº§ï¼Œå› ä¸ºè¿˜å°‘é…ç½®äº†ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚ contextçš„ ClassLoader å’Œ åç½®å¤„ç†å™¨ç­‰ç­‰ã€‚ protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // è®¾ç½®beanFactoryçš„classLoader beanFactory.setBeanClassLoader(getClassLoader()); // è®¾ç½®beanFactoryçš„è¡¨è¾¾å¼è¯­è¨€å¤„ç†å™¨,Spring3å¼€å§‹å¢åŠ äº†å¯¹è¯­è¨€è¡¨è¾¾å¼çš„æ”¯æŒ,é»˜è®¤å¯ä»¥ä½¿ç”¨#&#123;bean.xxx&#125;çš„å½¢å¼æ¥è°ƒç”¨ç›¸å…³å±æ€§å€¼ beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); // ä¸ºbeanFactoryå¢åŠ ä¸€ä¸ªé»˜è®¤çš„propertyEditor beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // æ·»åŠ ApplicationContextAwareProcessor beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); // è®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£ beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); // è®¾ç½®å‡ ä¸ªè‡ªåŠ¨è£…é…çš„ç‰¹æ®Šè§„åˆ™ beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // Register early post-processor for detecting inner beans as ApplicationListeners. beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // å¢åŠ å¯¹AspectJçš„æ”¯æŒ if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // Set a temporary ClassLoader for type matching. beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125; // æ³¨å†Œé»˜è®¤çš„ç³»ç»Ÿç¯å¢ƒbean if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); &#125;&#125; çœ‹ä¸Šé¢çš„æºç çŸ¥é“è¿™ä¸ªå°±æ˜¯å¯¹ BeanFactory è®¾ç½®å„ç§å„ç§çš„åŠŸèƒ½ã€‚ postProcessBeanFactory() æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess protected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; beanFactory.addBeanPostProcessor(new ServletContextAwareProcessor(this.servletContext, this.servletConfig)); beanFactory.ignoreDependencyInterface(ServletContextAware.class); beanFactory.ignoreDependencyInterface(ServletConfigAware.class); WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, this.servletContext); WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, this.servletContext, this.servletConfig);&#125; æ·»åŠ  ServletContextAwareProcessor åˆ° BeanFactory å®¹å™¨ä¸­ï¼Œè¯¥ processor å®ç° BeanPostProcessor æ¥å£ï¼Œä¸»è¦ç”¨äºå°†ServletContext ä¼ é€’ç»™å®ç°äº† ServletContextAware æ¥å£çš„ bean å¿½ç•¥ ServletContextAwareã€ServletConfigAware æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„åŸŸï¼ˆscopeï¼‰åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿ WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚æ¯”å¦‚ â€œrequestâ€ , â€œsessionâ€ , â€œglobalSessionâ€ , â€œapplicationâ€ æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„ Environment bean åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚å¦‚ï¼šâ€contextParametersâ€, â€œcontextAttributesâ€ invokeBeanFactoryPostProcessors() æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨ public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123; // å®šä¹‰ä¸€ä¸ª set ä¿å­˜æ‰€æœ‰çš„ BeanFactoryPostProcessors Set&lt;String&gt; processedBeans = new HashSet&lt;&gt;(); // å¦‚æœå½“å‰ BeanFactory ä¸º BeanDefinitionRegistry if (beanFactory instanceof BeanDefinitionRegistry) &#123; BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; // BeanFactoryPostProcessor é›†åˆ List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new ArrayList&lt;&gt;(); // BeanDefinitionRegistryPostProcessor é›†åˆ List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = new ArrayList&lt;&gt;(); // è¿­ä»£æ³¨å†Œçš„ beanFactoryPostProcessors for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123; // å¦‚æœæ˜¯ BeanDefinitionRegistryPostProcessorï¼Œåˆ™è°ƒç”¨ postProcessBeanDefinitionRegistry è¿›è¡Œæ³¨å†Œï¼Œ // åŒæ—¶åŠ å…¥åˆ° registryProcessors é›†åˆä¸­ if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123; BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; registryProcessor.postProcessBeanDefinitionRegistry(registry); registryProcessors.add(registryProcessor); &#125; else &#123; // å¦åˆ™å½“åšæ™®é€šçš„ BeanFactoryPostProcessor å¤„ç† // æ·»åŠ åˆ° regularPostProcessors é›†åˆä¸­å³å¯ï¼Œä¾¿äºåé¢åšåç»­å¤„ç† regularPostProcessors.add(postProcessor); &#125; &#125; // ç”¨äºä¿å­˜å½“å‰å¤„ç†çš„ BeanDefinitionRegistryPostProcessor List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = new ArrayList&lt;&gt;(); // é¦–å…ˆå¤„ç†å®ç°äº† PriorityOrdered (æœ‰é™æ’åºæ¥å£)çš„ BeanDefinitionRegistryPostProcessor String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; // æ’åº sortPostProcessors(currentRegistryProcessors, beanFactory); // åŠ å…¥registryProcessorsé›†åˆ registryProcessors.addAll(currentRegistryProcessors); // è°ƒç”¨æ‰€æœ‰å®ç°äº† PriorityOrdered çš„ BeanDefinitionRegistryPostProcessors çš„ postProcessBeanDefinitionRegistry() invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); // æ¸…ç©ºï¼Œä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ currentRegistryProcessors.clear(); // å…¶æ¬¡ï¼Œè°ƒç”¨æ˜¯å®ç°äº† Orderedï¼ˆæ™®é€šæ’åºæ¥å£ï¼‰çš„ BeanDefinitionRegistryPostProcessors // é€»è¾‘å’Œ ä¸Šé¢ä¸€æ · postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); // æœ€åè°ƒç”¨å…¶ä»–çš„ BeanDefinitionRegistryPostProcessors boolean reiterate = true; while (reiterate) &#123; reiterate = false; // è·å– BeanDefinitionRegistryPostProcessor postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; // æ²¡æœ‰åŒ…å«åœ¨ processedBeans ä¸­çš„ï¼ˆå› ä¸ºåŒ…å«äº†çš„éƒ½å·²ç»å¤„ç†äº†ï¼‰ if (!processedBeans.contains(ppName)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); reiterate = true; &#125; &#125; // ä¸ä¸Šé¢å¤„ç†é€»è¾‘ä¸€è‡´ sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); &#125; // è°ƒç”¨æ‰€æœ‰ BeanDefinitionRegistryPostProcessor (åŒ…æ‹¬æ‰‹åŠ¨æ³¨å†Œå’Œé€šè¿‡é…ç½®æ–‡ä»¶æ³¨å†Œ) // å’Œ BeanFactoryPostProcessor(åªæœ‰æ‰‹åŠ¨æ³¨å†Œ)çš„å›è°ƒå‡½æ•°(postProcessBeanFactory()) invokeBeanFactoryPostProcessors(registryProcessors, beanFactory); invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory); &#125; else &#123; // å¦‚æœä¸æ˜¯ BeanDefinitionRegistry åªéœ€è¦è°ƒç”¨å…¶å›è°ƒå‡½æ•°ï¼ˆpostProcessBeanFactory()ï¼‰å³å¯ invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory); &#125; // String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false); // è¿™é‡ŒåŒæ ·éœ€è¦åŒºåˆ† PriorityOrdered ã€Ordered å’Œ no Ordered List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; // å·²ç»å¤„ç†è¿‡äº†çš„ï¼Œè·³è¿‡ if (processedBeans.contains(ppName)) &#123; // skip - already processed in first phase above &#125; // PriorityOrdered else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); &#125; // Ordered else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; // no Ordered else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, PriorityOrdered æ¥å£ sortPostProcessors(priorityOrderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory); // Next, Ordered æ¥å£ List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(); for (String postProcessorName : orderedPostProcessorNames) &#123; orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; sortPostProcessors(orderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory); // Finally, no ordered List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(); for (String postProcessorName : nonOrderedPostProcessorNames) &#123; nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory); // Clear cached merged bean definitions since the post-processors might have // modified the original metadata, e.g. replacing placeholders in values... beanFactory.clearMetadataCache();&#125; ä¸Šè¿°ä»£ç è¾ƒé•¿ï¼Œä½†æ˜¯å¤„ç†é€»è¾‘è¾ƒä¸ºå•ä¸€ï¼Œå°±æ˜¯å¯¹æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessors ã€æ‰‹åŠ¨æ³¨å†Œçš„ BeanFactoryPostProcessor ä»¥åŠé€šè¿‡é…ç½®æ–‡ä»¶æ–¹å¼çš„ BeanFactoryPostProcessor æŒ‰ç…§ PriorityOrdered ã€ Orderedã€no ordered ä¸‰ç§æ–¹å¼åˆ†å¼€å¤„ç†ã€è°ƒç”¨ã€‚ registerBeanPostProcessors æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor ä¸ BeanFactoryPostProcessor ä¸€æ ·ï¼Œä¹Ÿæ˜¯å§”æ‰˜ç»™ PostProcessorRegistrationDelegate æ¥å®ç°çš„ã€‚ public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123; // æ‰€æœ‰çš„ BeanPostProcessors String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // æ³¨å†Œ BeanPostProcessorChecker // ä¸»è¦ç”¨äºè®°å½•ä¸€äº› bean çš„ä¿¡æ¯ï¼Œè¿™äº› bean ä¸ç¬¦åˆæ‰€æœ‰ BeanPostProcessors å¤„ç†çš„èµ„æ ¼æ—¶ int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // åŒºåˆ† PriorityOrderedã€Ordered ã€ no ordered List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); // MergedBeanDefinition List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, PriorityOrdered sortPostProcessors(priorityOrderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // Next, Ordered List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(); for (String ppName : orderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // onOrdered List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(); for (String ppName : nonOrderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // Finally, all internal BeanPostProcessors. sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); // é‡æ–°æ³¨å†Œç”¨æ¥è‡ªåŠ¨æ¢æµ‹å†…éƒ¨ApplicationListenerçš„post-processorï¼Œè¿™æ ·å¯ä»¥å°†ä»–ä»¬ç§»åˆ°å¤„ç†å™¨é“¾æ¡çš„æœ«å°¾ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));&#125; initMessageSource åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰ å…¶å®è¯¥æ–¹æ³•å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ª MessageSource æ¥å£çš„å®ç°ç±»ï¼Œä¸»è¦ç”¨äºå›½é™…åŒ–/i18nã€‚ protected void initMessageSource() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); // åŒ…å« â€œmessageSourceâ€ bean if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123; this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class); // å¦‚æœæœ‰çˆ¶ç±» // HierarchicalMessageSource åˆ†çº§å¤„ç†çš„ MessageSource if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) &#123; HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource; if (hms.getParentMessageSource() == null) &#123; // å¦‚æœæ²¡æœ‰æ³¨å†Œçˆ¶ MessageSourceï¼Œåˆ™è®¾ç½®ä¸ºçˆ¶ç±»ä¸Šä¸‹æ–‡çš„çš„ MessageSource hms.setParentMessageSource(getInternalParentMessageSource()); &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125; else &#123; // ä½¿ç”¨ ç©º MessageSource DelegatingMessageSource dms = new DelegatingMessageSource(); dms.setParentMessageSource(getInternalParentMessageSource()); this.messageSource = dms; beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Unable to locate MessageSource with name &#x27;&quot; + MESSAGE_SOURCE_BEAN_NAME + &quot;&#x27;: using default [&quot; + this.messageSource + &quot;]&quot;); &#125; &#125;&#125; initApplicationEventMulticaster åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨ protected void initApplicationEventMulticaster() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); // å¦‚æœå­˜åœ¨ applicationEventMulticaster beanï¼Œåˆ™è·å–èµ‹å€¼ if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123; this.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;); &#125; &#125; else &#123; // æ²¡æœ‰åˆ™æ–°å»º SimpleApplicationEventMulticasterï¼Œå¹¶å®Œæˆ bean çš„æ³¨å†Œ this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory); beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot; + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + &quot;&#x27;: using default [&quot; + this.applicationEventMulticaster + &quot;]&quot;); &#125; &#125;&#125; å¦‚æœå½“å‰å®¹å™¨ä¸­å­˜åœ¨ applicationEventMulticaster çš„ beanï¼Œåˆ™å¯¹ applicationEventMulticaster èµ‹å€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ª SimpleApplicationEventMulticaster çš„å¯¹è±¡ï¼ˆé»˜è®¤çš„ï¼‰ï¼Œå¹¶å®Œæˆæ³¨å†Œã€‚ onRefresh ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean é¢„ç•™ç»™ AbstractApplicationContext çš„å­ç±»ç”¨äºåˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šçš„ beanï¼Œè¯¥æ–¹æ³•éœ€è¦åœ¨æ‰€æœ‰å•ä¾‹ bean åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚ registerListeners åœ¨æ‰€æœ‰ bean ä¸­æŸ¥æ‰¾ listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­ protected void registerListeners() &#123; // æ³¨å†Œé™æ€ ç›‘å¬å™¨ for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123; getApplicationEventMulticaster().addApplicationListener(listener); &#125; String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false); for (String listenerBeanName : listenerBeanNames) &#123; getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); &#125; // è‡³æ­¤ï¼Œå·²ç»å®Œæˆå°†ç›‘å¬å™¨æ³¨å†Œåˆ°ApplicationEventMulticasterä¸­ï¼Œä¸‹é¢å°†å‘å¸ƒå‰æœŸçš„äº‹ä»¶ç»™ç›‘å¬å™¨ã€‚ Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents; this.earlyApplicationEvents = null; if (earlyEventsToProcess != null) &#123; for (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123; getApplicationEventMulticaster().multicastEvent(earlyEvent); &#125; &#125;&#125; finishBeanFactoryInitialization åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„) protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // åˆå§‹åŒ–è½¬æ¢å™¨ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // å¦‚æœä¹‹å‰æ²¡æœ‰æ³¨å†Œ bean åç½®å¤„ç†å™¨ï¼ˆä¾‹å¦‚PropertyPlaceholderConfigurerï¼‰ï¼Œåˆ™æ³¨å†Œé»˜è®¤çš„è§£æå™¨ if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal)); &#125; // åˆå§‹åŒ– Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early. String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ ClassLoader beanFactory.setTempClassLoader(null); // beanFactory.freezeConfiguration(); // åˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰ beanFactory.preInstantiateSingletons();&#125; finishRefresh å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ lifecycleProcessor åˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡º ContextRefreshEvent é€šçŸ¥åˆ«äºº ä¸»è¦æ˜¯è°ƒç”¨ LifecycleProcessor#onRefresh() ï¼Œå¹¶ä¸”å‘å¸ƒäº‹ä»¶ï¼ˆContextRefreshedEventï¼‰ã€‚ protected void finishRefresh() &#123; // Clear context-level resource caches (such as ASM metadata from scanning). clearResourceCaches(); // Initialize lifecycle processor for this context. initLifecycleProcessor(); // Propagate refresh to lifecycle processor first. getLifecycleProcessor().onRefresh(); // Publish the final event. publishEvent(new ContextRefreshedEvent(this)); // Participate in LiveBeansView MBean, if active. LiveBeansView.registerApplicationContext(this);&#125;","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"ApplicationContextç›¸å…³æ¥å£æ¶æ„åˆ†æ","date":"2020-01-26T06:31:24.000Z","path":"2020/01/26/1a84ff95.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4036 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE å‰é¢çš„æ–‡ç« éƒ½æ˜¯åŸºäº BeanFactory è¿™ä¸ªå®¹å™¨æ¥è¿›è¡Œåˆ†æçš„ï¼ŒBeanFactory å®¹å™¨æœ‰ç‚¹å„¿ç®€å•ï¼Œå¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒæˆ‘ä»¬é€šå¸¸ä¼šé€‰æ‹© ApplicationContext ï¼Œç›¸å¯¹äºå¤§å¤šæ•°äººè€Œè¨€ï¼Œå®ƒæ‰æ˜¯æ­£è§„å†›ï¼Œç›¸æ¯”äº BeanFactory è¿™ä¸ªæ‚ç‰Œå†›è€Œè¨€ï¼Œå®ƒç”±å¦‚ä¸‹å‡ ä¸ªåŒºåˆ«ï¼š ç»§æ‰¿ MessageSourceï¼Œæä¾›å›½é™…åŒ–çš„æ ‡å‡†è®¿é—®ç­–ç•¥ã€‚ ç»§æ‰¿ ApplicationEventPublisher ï¼Œæä¾›å¼ºå¤§çš„äº‹ä»¶æœºåˆ¶ã€‚ æ‰©å±• ResourceLoaderï¼Œå¯ä»¥ç”¨æ¥åŠ è½½å¤šä¸ª Resourceï¼Œå¯ä»¥çµæ´»è®¿é—®ä¸åŒçš„èµ„æºã€‚ å¯¹ Web åº”ç”¨çš„æ”¯æŒã€‚ ApplicationContextä¸‹å›¾æ˜¯ ApplicationContext ç»“æ„ç±»å›¾ï¼š BeanFactoryï¼šSpring ç®¡ç† Bean çš„é¡¶å±‚æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºä»–æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ Spring å®¹å™¨ã€‚ ApplicationContext ç»§æ‰¿ BeanFactory çš„ä¸¤ä¸ªå­ç±»ï¼šHierarchicalBeanFactory å’Œ ListableBeanFactoryã€‚HierarchicalBeanFactory æ˜¯ä¸€ä¸ªå…·æœ‰å±‚çº§å…³ç³»çš„ BeanFactoryï¼Œæ‹¥æœ‰å±æ€§ parentBeanFactoryã€‚ListableBeanFactory å®ç°äº†æšä¸¾æ–¹æ³•å¯ä»¥åˆ—ä¸¾å‡ºå½“å‰ BeanFactory ä¸­æ‰€æœ‰çš„ bean å¯¹è±¡è€Œä¸å¿…æ ¹æ® name ä¸€ä¸ªä¸€ä¸ªçš„è·å–ã€‚ ApplicationEventPublisherï¼šç”¨äºå°è£…äº‹ä»¶å‘å¸ƒåŠŸèƒ½çš„æ¥å£ï¼Œå‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆListenerï¼‰å‘é€äº‹ä»¶æ¶ˆæ¯ã€‚ ResourceLoaderï¼šSpring åŠ è½½èµ„æºçš„é¡¶å±‚æ¥å£ï¼Œç”¨äºä»ä¸€ä¸ªæºåŠ è½½èµ„æºæ–‡ä»¶ã€‚ ApplicationContext ç»§æ‰¿ ResourceLoader çš„å­ç±» ResourcePatternResolverï¼Œè¯¥æ¥å£æ˜¯å°† location è§£æä¸º Resource å¯¹è±¡çš„ç­–ç•¥æ¥å£ã€‚ MessageSourceï¼šè§£æ message çš„ç­–ç•¥æ¥å£ï¼Œç”¨ä¸æ”¯æ’‘å›½é™…åŒ–ç­‰åŠŸèƒ½ã€‚ EnvironmentCapableï¼šç”¨äºè·å– Environment çš„æ¥å£ã€‚ ApplicationContext çš„å­æ¥å£ApplicationContext æœ‰ä¸¤ä¸ªç›´æ¥å­ç±»ï¼šWebApplicationContext å’Œ ConfigurableApplicationContextã€‚ WebApplicationContextpublic interface WebApplicationContext extends ApplicationContext &#123; ServletContext getServletContext();&#125; è¯¥æ¥å£åªæœ‰ä¸€ä¸ª getServletContext() ï¼Œç”¨äºç»™ servlet æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ ConfigurableApplicationContextpublic interface ConfigurableApplicationContext extends ApplicationContext, Lifecycle, Closeable &#123; // ä¸º ApplicationContext è®¾ç½®å”¯ä¸€ ID void setId(String id); // ä¸º ApplicationContext è®¾ç½® parent // çˆ¶ç±»ä¸åº”è¯¥è¢«ä¿®æ”¹ï¼šå¦‚æœåˆ›å»ºçš„å¯¹è±¡ä¸å¯ç”¨æ—¶ï¼Œåˆ™åº”è¯¥åœ¨æ„é€ å‡½æ•°å¤–éƒ¨è®¾ç½®å®ƒ void setParent(@Nullable ApplicationContext parent); // è®¾ç½® Environment void setEnvironment(ConfigurableEnvironment environment); // è·å– Environment @Override ConfigurableEnvironment getEnvironment(); // æ·»åŠ  BeanFactoryPostProcessor void addBeanFactoryPostProcessor(BeanFactoryPostProcessor postProcessor); // æ·»åŠ  ApplicationListener void addApplicationListener(ApplicationListener&lt;?&gt; listener); // æ·»åŠ  ProtocolResolver void addProtocolResolver(ProtocolResolver resolver); // åŠ è½½æˆ–è€…åˆ·æ–°é…ç½® // è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³• void refresh() throws BeansException, IllegalStateException; // æ³¨å†Œ shutdown hook void registerShutdownHook(); // å…³é—­ ApplicationContext @Override void close(); // ApplicationContext æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€ boolean isActive(); // è·å–å½“å‰ä¸Šä¸‹æ–‡çš„ BeanFactory ConfigurableListableBeanFactory getBeanFactory() throws IllegalStateException;&#125; ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ° ConfigurableApplicationContext æ¥å£æä¾›çš„æ–¹æ³•éƒ½æ˜¯å¯¹ ApplicationContext è¿›è¡Œé…ç½®çš„ï¼Œä¾‹å¦‚ setEnvironment()ã€addBeanFactoryPostProcessorï¼ŒåŒæ—¶å®ƒè¿˜ç»§æ‰¿äº†å¦‚ä¸‹ä¸¤ä¸ªæ¥å£ï¼š Lifecycleï¼šå¯¹ context ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œå®ƒæä¾› start() å’Œ stop() æ–¹æ³•å¯åŠ¨å’Œæš‚åœç»„ä»¶ã€‚ Closeableï¼šæ ‡å‡† JDK æ‰€æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºæœ€åå…³é—­ç»„ä»¶é‡Šæ”¾èµ„æºç­‰ã€‚ WebApplicationContext æ¥å£å’Œ ConfigurableApplicationContext æ¥å£æœ‰ä¸€ä¸ªå…±åŒçš„å­ç±»æ¥å£ ConfigurableWebApplicationContextï¼Œè¯¥æ¥å£å°†è¿™ä¸¤ä¸ªæ¥å£è¿›è¡Œåˆå¹¶ï¼Œæä¾›äº†ä¸€ä¸ªå¯é…ç½®ã€å¯ç®¡ç†ã€å¯å…³é—­çš„WebApplicationContextï¼ŒåŒæ—¶è¯¥æ¥å£è¿˜å¢åŠ äº† setServletContext()ï¼ŒsetServletConfig()ç­‰æ–¹æ³•ï¼Œç”¨äºè£…é…WebApplicationContextã€‚ public interface ConfigurableWebApplicationContext extends WebApplicationContext, ConfigurableApplicationContext &#123; void setServletContext(@Nullable ServletContext servletContext); void setServletConfig(@Nullable ServletConfig servletConfig); ServletConfig getServletConfig(); void setNamespace(@Nullable String namespace); String getNamespace(); void setConfigLocation(String configLocation); void setConfigLocations(String... configLocations); String[] getConfigLocations();&#125; ä¸Šé¢ä¸‰ä¸ªæ¥å£å°±å¯ä»¥æ„æˆä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ Spring å®¹å™¨ï¼Œæ•´ä¸ª Spring å®¹å™¨ä½“ç³»æ¶‰åŠçš„æ¥å£è¾ƒå¤šï¼Œæ‰€ä»¥ä¸‹é¢å°ç¼–å°±ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»æ¥çœ‹çœ‹ ApplicationContext çš„å®ç°ï¼ˆå…¶å®åœ¨å‰é¢ä¸€ç³»åˆ—çš„æ–‡ç« ä¸­ï¼Œå°ç¼–å¯¹æ¶‰åŠçš„å¤§éƒ¨åˆ†æ¥å£éƒ½å·²ç»åˆ†æäº†å…¶åŸç†ï¼‰ï¼Œå½“ç„¶ä¸å¯èƒ½æ¯ä¸ªæ–¹æ³•éƒ½æ¶‰åŠåˆ°ï¼Œä½†å°ç¼–ä¼šæŠŠå…¶ä¸­æœ€ä¸ºé‡è¦çš„å®ç°æ–¹æ³•è´´å‡ºæ¥åˆ†æã€‚ ApplicationContext çš„å®ç°ç±»è¾ƒå¤šï¼Œå°±ä»¥ ClassPathXmlApplicationContext æ¥åˆ†æ ApplicationContextã€‚ ClassPathXmlApplicationContextClassPathXmlApplicationContext æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹  Spring è¿‡ç¨‹ä¸­ç”¨çš„éå¸¸å¤šçš„ä¸€ä¸ªç±»ï¼Œå¾ˆå¤šäººç¬¬ä¸€ä¸ªæ¥è§¦çš„ Spring å®¹å™¨å°±æ˜¯å®ƒï¼ŒåŒ…æ‹¬å°ç¼–è‡ªå·±ï¼Œä¸‹é¢ä»£ç æˆ‘æƒ³å¾ˆå¤šäººä¾ç„¶è¿˜è®°å¾—å§ã€‚ ApplicationContext ac = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);StudentService studentService = (StudentService)ac.getBean(&quot;studentService&quot;); ä¸‹å›¾æ˜¯ ClassPathXmlApplicationContext çš„ç»“æ„ç±»å›¾ï¼š ä¸»è¦çš„çš„ç±»å±‚çº§å…³ç³»å¦‚ä¸‹ï¼š org.springframework.context.support.AbstractApplicationContext org.springframework.context.support.AbstractRefreshableApplicationContext org.springframework.context.support.AbstractRefreshableConfigApplicationContext org.springframework.context.support.AbstractXmlApplicationContext org.springframework.context.support.ClassPathXmlApplicationContext è¿™ç§è®¾è®¡æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å…¸å‹çš„åº”ç”¨ï¼ŒAbstractApplicationContext å®ç°äº† ConfigurableApplicationContext è¿™ä¸ªå…¨å®¶æ¡¶æ¥å£ï¼Œå…¶å­ç±» AbstractRefreshableConfigApplicationContext åˆå®ç°äº† BeanNameAware å’Œ InitializingBean æ¥å£ã€‚æ‰€ä»¥ ClassPathXmlApplicationContext è®¾è®¡çš„é¡¶çº§æ¥å£æœ‰ï¼š BeanFactoryï¼šSpring å®¹å™¨ Bean çš„ç®¡ç† MessageSourceï¼šç®¡ç† message ï¼Œå®ç°å›½é™…åŒ–ç­‰åŠŸèƒ½ ApplicationEventPublisherï¼šäº‹ä»¶å‘å¸ƒ ResourcePatternResolverï¼šèµ„æºåŠ è½½ EnvironmentCapableï¼šç³»ç»Ÿ Environmentï¼ˆprofile + Propertiesï¼‰ ç›¸å…³ Lifecycleï¼šç®¡ç†ç”Ÿå‘½å‘¨æœŸ Closeableï¼šå…³é—­ï¼Œé‡Šæ”¾èµ„æº InitializingBeanï¼šè‡ªå®šä¹‰åˆå§‹åŒ– BeanNameAwareï¼šè®¾ç½® beanName çš„ Aware æ¥å£ ä¸‹é¢å°±è¿™äº›æ¥å£æ¥ä¸€ä¸€åˆ†æã€‚ MessageSourceMessageSource å®šä¹‰äº†è·å– message çš„ç­–ç•¥æ–¹æ³• getMessage()ï¼Œåœ¨ ApplicationContext ä½“ç³»ä¸­ï¼Œè¯¥æ–¹æ³• AbstractApplicationContext å®ç°ï¼Œåœ¨ AbstractApplicationContext ä¸­ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª MessageSource å®ä¾‹ï¼Œå°† getMessage() çš„å®ç°ç»™è¯¥å®ä¾‹æ¥å®ç°ï¼Œå¦‚ä¸‹ï¼š private MessageSource messageSource;// å®ç° getMessage()public String getMessage(String code, @Nullable Object[] args, @Nullable String defaultMessage, Locale locale) &#123; // å§”æ‰˜ç»™ messageSource å®ç° return getMessageSource().getMessage(code, args, defaultMessage, locale);&#125;private MessageSource getMessageSource() throws IllegalStateException &#123; if (this.messageSource == null) &#123; throw new IllegalStateException(&quot;MessageSource not initialized - &quot; + &quot;call &#x27;refresh&#x27; before accessing messages via the context: &quot; + this); &#125; return this.messageSource;&#125; çœŸæ­£å®ç° æ˜¯åœ¨ AbstractMessageSource ä¸­ï¼Œå¦‚ä¸‹ï¼š public final String getMessage(String code, @Nullable Object[] args, @Nullable String defaultMessage, Locale locale) &#123; String msg = getMessageInternal(code, args, locale); if (msg != null) &#123; return msg; &#125; if (defaultMessage == null) &#123; return getDefaultMessage(code); &#125; return renderDefaultMessage(defaultMessage, args, locale);&#125; å…·ä½“çš„å®ç°è¿™é‡Œå°±ä¸åˆ†æäº†ã€‚ ApplicationEventPublisherç”¨äºå°è£…äº‹ä»¶å‘å¸ƒåŠŸèƒ½çš„æ¥å£ï¼Œå‘äº‹ä»¶ç›‘å¬å™¨ï¼ˆListenerï¼‰å‘é€äº‹ä»¶æ¶ˆæ¯ã€‚ è¯¥æ¥å£æä¾›äº†ä¸€ä¸ª publishEvent() ç”¨äºé€šçŸ¥åœ¨æ­¤åº”ç”¨ç¨‹åºä¸­æ³¨å†Œçš„æ‰€æœ‰çš„ç›‘å¬å™¨ã€‚ è¯¥æ–¹æ³•åœ¨ AbstractApplicationContext ä¸­å®ç°ã€‚ @Overridepublic void publishEvent(Object event) &#123; publishEvent(event, null);&#125;protected void publishEvent(Object event, @Nullable ResolvableType eventType) &#123; Assert.notNull(event, &quot;Event must not be null&quot;); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Publishing event in &quot; + getDisplayName() + &quot;: &quot; + event); &#125; ApplicationEvent applicationEvent; if (event instanceof ApplicationEvent) &#123; applicationEvent = (ApplicationEvent) event; &#125; else &#123; applicationEvent = new PayloadApplicationEvent&lt;&gt;(this, event); if (eventType == null) &#123; eventType = ((PayloadApplicationEvent) applicationEvent).getResolvableType(); &#125; &#125; if (this.earlyApplicationEvents != null) &#123; this.earlyApplicationEvents.add(applicationEvent); &#125; else &#123; getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType); &#125; if (this.parent != null) &#123; if (this.parent instanceof AbstractApplicationContext) &#123; ((AbstractApplicationContext) this.parent).publishEvent(event, eventType); &#125; else &#123; this.parent.publishEvent(event); &#125; &#125;&#125; å¦‚æœæŒ‡å®šçš„äº‹ä»¶ä¸æ˜¯ApplicationEventï¼Œåˆ™å®ƒå°†åŒ…è£…åœ¨PayloadApplicationEventä¸­ã€‚å¦‚æœå­˜åœ¨çˆ¶çº§ ApplicationContext ï¼Œåˆ™åŒæ ·è¦å°† event å‘å¸ƒç»™çˆ¶çº§ ApplicationContextã€‚ ResourcePatternResolverResourcePatternResolver æ¥å£ç»§æ‰¿ ResourceLoader æ¥å£ï¼Œä¸ºå°† location è§£æä¸º Resource å¯¹è±¡çš„ç­–ç•¥æ¥å£ã€‚ä»–æä¾›çš„ getResources() åœ¨ AbstractApplicationContext ä¸­å®ç°ï¼Œåœ¨ AbstractApplicationContext ä¸­ä»–æŒæœ‰ä¸€ä¸ª ResourcePatternResolver çš„å®ä¾‹å¯¹è±¡ã€‚ å¦‚ä¸‹ï¼š public Resource[] getResources(String locationPattern) throws IOException &#123; return this.resourcePatternResolver.getResources(locationPattern);&#125; å¦‚æœå°ä¼™ä¼´å¯¹ Spring çš„ ResourceLoader æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œä½ ä¼šå‘ç°æœ€ç»ˆæ˜¯åœ¨ PathMatchingResourcePatternResolver ä¸­å®ç°ï¼Œè¯¥ç±»æ˜¯ ResourcePatternResolver æ¥å£çš„å®ç°è€…ã€‚ EnvironmentCapableæä¾›å½“å‰ç³»ç»Ÿç¯å¢ƒ Environment ç»„ä»¶ã€‚æä¾›äº†ä¸€ä¸ª getEnvironment() ç”¨äºè¿”å› Environment å®ä¾‹å¯¹è±¡ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractApplicationContext å®ç°ã€‚ public ConfigurableEnvironment getEnvironment() &#123; if (this.environment == null) &#123; this.environment = createEnvironment(); &#125; return this.environment;&#125; å¦‚æœæŒæœ‰çš„ environment å®ä¾‹å¯¹è±¡ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ createEnvironment() åˆ›å»ºä¸€ä¸ªã€‚ protected ConfigurableEnvironment createEnvironment() &#123; return new StandardEnvironment();&#125; StandardEnvironment æ˜¯ä¸€ä¸ªé€‚ç”¨äºé WEB åº”ç”¨çš„ Environmentã€‚ Lifecycleä¸€ä¸ªç”¨äºç®¡ç†å£°æ˜å‘¨æœŸçš„æ¥å£ã€‚ åœ¨ AbstractApplicationContext ä¸­å­˜åœ¨ä¸€ä¸ª LifecycleProcessor ç±»å‹çš„å®ä¾‹å¯¹è±¡ lifecycleProcessorï¼ŒAbstractApplicationContext ä¸­å…³äº Lifecycle æ¥å£çš„å®ç°éƒ½æ˜¯å§”æ‰˜ç»™ lifecycleProcessor å®ç°çš„ã€‚å¦‚ä¸‹ï¼š @Overridepublic void start() &#123; getLifecycleProcessor().start(); publishEvent(new ContextStartedEvent(this));&#125;@Overridepublic void stop() &#123; getLifecycleProcessor().stop(); publishEvent(new ContextStoppedEvent(this));&#125;@Overridepublic boolean isRunning() &#123; return (this.lifecycleProcessor != null &amp;&amp; this.lifecycleProcessor.isRunning());&#125; åœ¨å¯åŠ¨ã€åœæ­¢çš„æ—¶å€™ä¼šåˆ†åˆ«å‘å¸ƒ ContextStartedEvent å’Œ ContextStoppedEvent äº‹ä»¶ã€‚ CloseableCloseable æ¥å£ç”¨äºå…³é—­å’Œé‡Šæ”¾èµ„æºï¼Œæä¾›äº† close() ä»¥é‡Šæ”¾å¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºã€‚åœ¨ ApplicationContext ä½“ç³»ä¸­ç”±AbstractApplicationContext å®ç°ï¼Œç”¨äºå…³é—­ ApplicationContext é”€æ¯æ‰€æœ‰ bean ï¼Œæ­¤å¤–å¦‚æœæ³¨å†Œæœ‰ JVM shutdown hookï¼ŒåŒæ ·è¦å°†å…¶ç§»é™¤ã€‚å¦‚ä¸‹ï¼š public void close() &#123; synchronized (this.startupShutdownMonitor) &#123; doClose(); // If we registered a JVM shutdown hook, we don&#x27;t need it anymore now: // We&#x27;ve already explicitly closed the context. if (this.shutdownHook != null) &#123; try &#123; Runtime.getRuntime().removeShutdownHook(this.shutdownHook); &#125; catch (IllegalStateException ex) &#123; // ignore - VM is already shutting down &#125; &#125; &#125;&#125; è°ƒç”¨ doClose() å‘å¸ƒ ContextClosedEvent äº‹ä»¶ï¼Œé”€æ¯æ‰€æœ‰ beanï¼ˆå•ä¾‹ï¼‰ï¼Œå…³é—­ BeanFactory ã€‚å¦‚ä¸‹ï¼š protected void doClose() &#123; // çœç•¥éƒ¨åˆ†ä»£ç  try &#123; // Publish shutdown event. publishEvent(new ContextClosedEvent(this)); &#125; catch (Throwable ex) &#123; logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex); &#125; // çœç•¥éƒ¨åˆ†ä»£ç  destroyBeans(); closeBeanFactory(); onClose(); this.active.set(false);&#125;&#125; InitializingBeanInitializingBean ä¸º bean æä¾›äº†åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒæä¾›çš„ afterPropertiesSet() ç”¨äºæ‰§è¡Œåˆå§‹åŒ–åŠ¨ä½œã€‚åœ¨ ApplicationContext ä½“ç³»ä¸­ï¼Œè¯¥æ–¹æ³•ç”± AbstractRefreshableConfigApplicationContext å®ç°ï¼Œå¦‚ä¸‹ï¼š public void afterPropertiesSet() &#123; if (!isActive()) &#123; refresh(); &#125;&#125; æ‰§è¡Œ refresh() ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractApplicationContext ä¸­æ‰§è¡Œï¼Œæ‰§è¡Œæ•´ä¸ª Spring å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¯¥æ–¹æ³•å°†åœ¨ä¸‹ç¯‡æ–‡ç« è¿›è¡Œè¯¦ç»†åˆ†æè¯´æ˜ã€‚ BeanNameAwareè®¾ç½® bean name çš„æ¥å£ã€‚æ¥å£åœ¨ AbstractRefreshableConfigApplicationContext ä¸­å®ç°ã€‚ public void setBeanName(String name) &#123; if (!this.setIdCalled) &#123; super.setId(name); setDisplayName(&quot;ApplicationContext &#x27;&quot; + name + &quot;&#x27;&quot;); &#125;&#125; ç”±äºç¯‡å¹…é—®é¢˜å†åŠ ä¸Šå¤§éƒ¨åˆ†æ¥å£éƒ½å·²ç»åœ¨å‰é¢æ–‡ç« è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦æ˜¯ä»¥ Spring Framework çš„ ApplicationContext ä¸ºä¸­å¿ƒï¼Œå¯¹å…¶ç»“æ„å’ŒåŠŸèƒ½çš„å®ç°è¿›è¡Œäº†ç®€è¦çš„è¯´æ˜ã€‚ è¿™é‡Œä¸å¾—ä¸è¯´ Spring çœŸçš„æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„æ¡†æ¶ï¼Œå…·æœ‰è‰¯å¥½çš„ç»“æ„è®¾è®¡å’Œæ¥å£æŠ½è±¡ï¼Œå®ƒçš„æ¯ä¸€ä¸ªæ¥å£èŒèƒ½å•ä¸€ï¼Œä¸”éƒ½æ˜¯å…·ä½“åŠŸèƒ½åˆ°å„ä¸ªæ¨¡å—çš„é«˜åº¦æŠ½è±¡ï¼Œä¸”å‡ ä¹æ¯å¥—æ¥å£éƒ½æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å®ç°ï¼ˆdefaultXXXï¼‰ã€‚ å¯¹äº ApplicationContext ä½“ç³»è€Œè¨€ï¼Œä»–ç»§æ‰¿ Spring ä¸­ä¼—å¤šçš„æ ¸å¿ƒæ¥å£ï¼Œèƒ½å¤Ÿä¸ºå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„ Spring å®¹å™¨ï¼Œæ¥å£ ConfigurableApplicationContext å¯¹ ApplicationContext æ¥å£å†æ¬¡è¿›è¡Œæ‰©å±•ï¼Œæä¾›äº†ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†åŠŸèƒ½ã€‚ æŠ½è±¡ç±» ApplicationContext å¯¹æ•´å¥—æ¥å£æä¾›äº†å¤§éƒ¨åˆ†çš„é»˜è®¤å®ç°ï¼Œå°†å…¶ä¸­â€œä¸æ˜“å˜åŠ¨â€çš„éƒ¨åˆ†è¿›è¡Œäº†å°è£…ï¼Œé€šè¿‡â€œç»„åˆâ€çš„æ–¹å¼å°†â€œå®¹æ˜“å˜åŠ¨â€çš„åŠŸèƒ½å§”æ‰˜ç»™å…¶ä»–ç±»æ¥å®ç°ï¼ŒåŒæ—¶åˆ©ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°†ä¸€äº›æ–¹æ³•çš„å®ç°å¼€æ”¾å‡ºå»ç”±å­ç±»å®ç°ï¼Œä»è€Œå®ç°â€œ**å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­**â€çš„è®¾è®¡åŸåˆ™ã€‚ æœ€åæˆ‘ä»¬å†æ¥é¢†ç•¥ä¸‹å›¾çš„é£é‡‡ï¼š","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹åˆ†æbeançš„ç”Ÿå‘½å‘¨æœŸ","date":"2020-01-26T01:21:09.000Z","path":"2020/01/26/90c034e1.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4034 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨åˆ†æ Spring Bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­æåˆ° Spring å¹¶ä¸æ˜¯ä¸€å¯åŠ¨å®¹å™¨å°±å¼€å¯ bean çš„å®ä¾‹åŒ–è¿›ç¨‹ï¼Œåªæœ‰å½“å®¢æˆ·ç«¯é€šè¿‡æ˜¾ç¤ºæˆ–è€…éšå¼çš„æ–¹å¼è°ƒç”¨ BeanFactory çš„ getBean() æ–¹æ³•æ¥è¯·æ±‚æŸä¸ªå®ä¾‹å¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šè§¦å‘ç›¸åº” bean çš„å®ä¾‹åŒ–è¿›ç¨‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥ä½¿ç”¨ ApplicationContext å®¹å™¨ï¼Œå› ä¸ºè¯¥å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šç«‹åˆ»è°ƒç”¨æ³¨å†Œåˆ°è¯¥å®¹å™¨æ‰€æœ‰ bean å®šä¹‰çš„å®ä¾‹åŒ–æ–¹æ³•ã€‚å½“ç„¶å¯¹äº BeanFactory å®¹å™¨è€Œè¨€å¹¶ä¸æ˜¯æ‰€æœ‰çš„ getBean() æ–¹æ³•éƒ½ä¼šè§¦å‘å®ä¾‹åŒ–è¿›ç¨‹ï¼Œæ¯”å¦‚ signleton ç±»å‹çš„ beanï¼Œè¯¥ç±»å‹çš„ bean åªä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ getBean() çš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œè€Œåç»­çš„è°ƒç”¨åˆ™ä¼šç›´æ¥è¿”å›å®¹å™¨ç¼“å­˜ä¸­çš„å®ä¾‹å¯¹è±¡ã€‚ getBean() åªæ˜¯ bean å®ä¾‹åŒ–è¿›ç¨‹çš„å…¥å£ï¼ŒçœŸæ­£çš„å®ç°é€»è¾‘å…¶å®æ˜¯åœ¨ AbstractAutowireCapableBeanFactory çš„ doCreateBean() å®ç°ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š åŸæ¥æˆ‘ä»¬é‡‡ç”¨ new çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç”¨å®Œè¯¥å¯¹è±¡åœ¨å…¶è„±ç¦»ä½œç”¨åŸŸåå°±ä¼šè¢«å›æ”¶ï¼Œå¯¹äºåç»­æ“ä½œæˆ‘ä»¬æ— æƒä¹Ÿæ²¡æ³•å¹²æ¶‰ï¼Œä½†æ˜¯é‡‡ç”¨ Spring å®¹å™¨åï¼Œæˆ‘ä»¬å®Œå…¨æ‘†è„±äº†è¿™ç§å‘½è¿ï¼ŒSpring å®¹å™¨å°†ä¼šå¯¹å…¶æ‰€æœ‰ç®¡ç†çš„ Bean å¯¹è±¡å…¨éƒ¨ç»™äºˆä¸€ä¸ªç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œå¹²æ¶‰ï¼ˆæ¯”å¦‚å¯¹ bean è¿›è¡Œå¢å¼ºå¤„ç†ï¼Œå¯¹ bean è¿›è¡Œç¯¡æ”¹ï¼‰ï¼Œå¦‚ä¸Šå›¾ã€‚ bean å®ä¾‹åŒ–åœ¨ doCreateBean() ä¸­é¦–å…ˆè¿›è¡Œ bean å®ä¾‹åŒ–å·¥ä½œï¼Œä¸»è¦ç”± createBeanInstance() å®ç°ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª BeanWrapper å¯¹è±¡ã€‚BeanWrapper å¯¹è±¡æ˜¯ Spring çš„ä¸€ä¸ªä½çº§ Bean åŸºç¡€ç»“æ„çš„æ ¸å¿ƒæ¥å£ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯ä½çº§å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªæ—¶å€™çš„ Bean è¿˜ä¸èƒ½å¤Ÿè¢«æˆ‘ä»¬ä½¿ç”¨ï¼Œè¿æœ€åŸºæœ¬çš„å±æ€§éƒ½æ²¡æœ‰è®¾ç½®ã€‚è€Œä¸”åœ¨æˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¸€èˆ¬éƒ½ä¸ä¼šç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œè€Œæ˜¯é€šè¿‡ BeanFactory éšå¼ä½¿ç”¨ã€‚ BeanWrapper æ¥å£æœ‰ä¸€ä¸ªé»˜è®¤å®ç°ç±» BeanWrapperImplï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¯¹ Bean è¿›è¡Œâ€œåŒ…è£¹â€ï¼Œç„¶åå¯¹è¿™ä¸ªåŒ…è£¹çš„ bean è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚åç»­æ³¨å…¥ bean å±æ€§ã€‚ åœ¨å®ä¾‹åŒ– bean è¿‡ç¨‹ä¸­ï¼ŒSpring é‡‡ç”¨â€œç­–ç•¥æ¨¡å¼â€æ¥å†³å®šé‡‡ç”¨å“ªç§æ–¹å¼æ¥å®ä¾‹åŒ– beanï¼Œä¸€èˆ¬æœ‰åå°„å’Œ CGLIB åŠ¨æ€å­—èŠ‚ç ä¸¤ç§æ–¹å¼ã€‚ InstantiationStrategy å®šä¹‰äº† Bean å®ä¾‹åŒ–ç­–ç•¥çš„æŠ½è±¡æ¥å£ï¼Œå…¶å­ç±» SimpleInstantiationStrategy æä¾›äº†åŸºäºåå°„æ¥å®ä¾‹åŒ–å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸æ”¯æŒæ–¹æ³•æ³¨å…¥æ–¹å¼çš„å¯¹è±¡å®ä¾‹åŒ–ã€‚ CglibSubclassingInstantiationStrategy ç»§æ‰¿ SimpleInstantiationStrategyï¼Œä»–é™¤äº†æ‹¥æœ‰çˆ¶ç±»ä»¥åå°„å®ä¾‹åŒ–å¯¹è±¡çš„åŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†é€šè¿‡ CGLIB çš„åŠ¨æ€å­—èŠ‚ç çš„åŠŸèƒ½è¿›è€Œæ”¯æŒæ–¹æ³•æ³¨å…¥æ‰€éœ€çš„å¯¹è±¡å®ä¾‹åŒ–éœ€æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring é‡‡ç”¨ CglibSubclassingInstantiationStrategyã€‚ æ¿€æ´» Awareå½“ Spring å®Œæˆ bean å¯¹è±¡å®ä¾‹åŒ–å¹¶ä¸”è®¾ç½®å®Œç›¸å…³å±æ€§å’Œä¾èµ–åï¼Œåˆ™ä¼šå¼€å§‹ bean çš„åˆå§‹åŒ–è¿›ç¨‹ï¼ˆinitializeBean()ï¼‰ï¼Œåˆå§‹åŒ–ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯æ£€æŸ¥å½“å‰ bean å¯¹è±¡æ˜¯å¦å®ç°äº†ä¸€ç³»åˆ—ä»¥ Aware ç»“å°¾çš„çš„æ¥å£ã€‚ Aware æ¥å£ä¸º Spring å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œæ˜¯ä¸€ä¸ªå…·æœ‰æ ‡è¯†ä½œç”¨çš„è¶…çº§æ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ bean æ˜¯å…·æœ‰è¢« Spring å®¹å™¨é€šçŸ¥çš„èƒ½åŠ›ï¼Œé€šçŸ¥çš„æ–¹å¼æ˜¯é‡‡ç”¨å›è°ƒçš„æ–¹å¼ã€‚ åœ¨åˆå§‹åŒ–é˜¶æ®µä¸»è¦æ˜¯æ„ŸçŸ¥ BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAware ï¼š private void invokeAwareMethods(final String beanName, final Object bean) &#123; if (bean instanceof Aware) &#123; if (bean instanceof BeanNameAware) &#123; ((BeanNameAware) bean).setBeanName(beanName); &#125; if (bean instanceof BeanClassLoaderAware) &#123; ClassLoader bcl = getBeanClassLoader(); if (bcl != null) &#123; ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); &#125; &#125; if (bean instanceof BeanFactoryAware) &#123; ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); &#125; &#125;&#125; BeanNameAwareï¼šå¯¹è¯¥ bean å¯¹è±¡å®šä¹‰çš„ beanName è®¾ç½®åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­ BeanClassLoaderAwareï¼šå°†å½“å‰ bean å¯¹è±¡ç›¸åº”çš„ ClassLoader æ³¨å…¥åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­ BeanFactoryAwareï¼šBeanFactory å®¹å™¨ä¼šå°†è‡ªèº«æ³¨å…¥åˆ°å½“å‰å¯¹è±¡å®ä¾‹ä¸­ï¼Œè¿™æ ·å½“å‰å¯¹è±¡å°±ä¼šæ‹¥æœ‰ä¸€ä¸ª BeanFactory å®¹å™¨çš„å¼•ç”¨ã€‚ å½“ç„¶ï¼ŒSpring ä¸ä»…ä»…åªæ˜¯æä¾›äº†ä¸Šé¢ä¸‰ä¸ª Aware æ¥å£ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—ï¼š LoadTimeWeaverAwareï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ BootstrapContextAwareï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI ResourceLoaderAwareï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨ PortletConfigAwareï¼šPortletConfig PortletContextAwareï¼šPortletContext ServletConfigAwareï¼šServletConfig ServletContextAwareï¼šServletContext MessageSourceAwareï¼šå›½é™…åŒ– ApplicationEventPublisherAwareï¼šåº”ç”¨äº‹ä»¶ NotificationPublisherAwareï¼šJMXé€šçŸ¥ BeanPostProcessoråˆå§‹åŒ–ç¬¬äºŒä¸ªé˜¶æ®µåˆ™æ˜¯ BeanPostProcessor å¢å¼ºå¤„ç†ï¼Œåœ¨è¯¥é˜¶æ®µ BeanPostProcessor ä¼šå¤„ç†å½“å‰å®¹å™¨å†…æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å®ä¾‹åŒ–åçš„ bean å¯¹è±¡ã€‚ å®ƒä¸»è¦æ˜¯å¯¹ Spring å®¹å™¨æä¾›çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œæœ‰æ•ˆçš„æ‰©å±•ï¼Œå…è®¸ Spring åœ¨åˆå§‹åŒ– bean é˜¶æ®µå¯¹å…¶è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œå¦‚å¤„ç†æ ‡è®°æ¥å£æˆ–è€…ä¸ºå…¶æä¾›ä»£ç†å®ç°ã€‚ BeanPostProcessor æ¥å£æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåœ¨ä¸åŒçš„æ—¶æœºæ‰§è¡Œï¼Œåˆ†åˆ«å¯¹åº”ä¸Šå›¾çš„å‰ç½®å¤„ç†å’Œåç½®å¤„ç†ã€‚ public interface BeanPostProcessor &#123; @Nullable default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125; @Nullable default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125;&#125; InitializingBean å’Œ init-methodInitializingBean æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒä¸º Spring Bean çš„åˆå§‹åŒ–æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå®ƒæœ‰ä¸€ä¸ª afterPropertiesSet() æ–¹æ³•ï¼Œåœ¨ bean çš„åˆå§‹åŒ–è¿›ç¨‹ä¸­ä¼šåˆ¤æ–­å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBeanï¼Œå¦‚æœå®ç°äº†åˆ™è°ƒç”¨ afterPropertiesSet() è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚ç„¶åå†æ£€æŸ¥æ˜¯å¦ä¹ŸæŒ‡å®šäº† init-method()ï¼Œå¦‚æœæŒ‡å®šäº†åˆ™é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æŒ‡å®šçš„ init-method()ã€‚ protected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd) throws Throwable &#123; boolean isInitializingBean = (bean instanceof InitializingBean); if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; if (System.getSecurityManager() != null) &#123; try &#123; AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123; ((InitializingBean) bean).afterPropertiesSet(); return null; &#125;, getAccessControlContext()); &#125; catch (PrivilegedActionException pae) &#123; throw pae.getException(); &#125; &#125; else &#123; ((InitializingBean) bean).afterPropertiesSet(); &#125; &#125; if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123; String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) &amp;&amp; !(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123; invokeCustomInitMethod(beanName, bean, mbd); &#125; &#125;&#125; å¯¹äº Spring è€Œè¨€ï¼Œè™½ç„¶ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å®ç°åˆå§‹åŒ–å®šåˆ¶åŒ–ï¼Œä½†æ˜¯æ›´åŠ æ¨å´‡ init-method æ–¹å¼ï¼Œå› ä¸ºå¯¹äº InitializingBean æ¥å£è€Œè¨€ï¼Œä»–éœ€è¦ bean å»å®ç°æ¥å£ï¼Œè¿™æ ·å°±ä¼šæ±¡æŸ“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæ˜¾å¾— Spring å…·æœ‰ä¸€å®šçš„ä¾µå…¥æ€§ã€‚ä½†æ˜¯ç”±äº init-method æ˜¯é‡‡ç”¨åå°„çš„æ–¹å¼ï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡ä¸Šç›¸å¯¹äº InitializingBean æ¥å£å›è°ƒçš„æ–¹å¼å¯èƒ½ä¼šä½ä¸€äº›ã€‚ DisposableBean å’Œ destroy-methodä¸ InitializingBean å’Œ init-method ç”¨äºå¯¹è±¡çš„è‡ªå®šä¹‰åˆå§‹åŒ–å·¥ä½œç›¸ä¼¼ï¼ŒDisposableBeanå’Œ destroy-method åˆ™ç”¨äºå¯¹è±¡çš„è‡ªå®šä¹‰é”€æ¯å·¥ä½œã€‚ å½“ä¸€ä¸ª bean å¯¹è±¡ç»å†äº†å®ä¾‹åŒ–ã€è®¾ç½®å±æ€§ã€åˆå§‹åŒ–é˜¶æ®µ,é‚£ä¹ˆè¯¥ bean å¯¹è±¡å°±å¯ä»¥ä¾›å®¹å™¨ä½¿ç”¨äº†ï¼ˆè°ƒç”¨çš„è¿‡ç¨‹ï¼‰ã€‚å½“å®Œæˆè°ƒç”¨åï¼Œå¦‚æœæ˜¯ singleton ç±»å‹çš„ bean ï¼Œåˆ™ä¼šçœ‹å½“å‰ bean æ˜¯å¦åº”å®ç°äº† DisposableBean æ¥å£æˆ–è€…é…ç½®äº† destroy-method å±æ€§ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™ä¼šä¸ºè¯¥å®ä¾‹æ³¨å†Œä¸€ä¸ªç”¨äºå¯¹è±¡é”€æ¯çš„å›è°ƒæ–¹æ³•ï¼Œä¾¿äºåœ¨è¿™äº› singleton ç±»å‹çš„ bean å¯¹è±¡é”€æ¯ä¹‹å‰æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚ ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯å¯¹è±¡å®Œæˆè°ƒç”¨åå°±ä¼šç«‹åˆ»æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ Spring å®¹å™¨è¿˜å¤„äºè¿è¡Œé˜¶æ®µï¼Œåªæœ‰å½“ Spring å®¹å™¨å…³é—­çš„æ—¶å€™æ‰ä¼šå»è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œ Spring å®¹å™¨ä¸ä¼šè¿™ä¹ˆèªæ˜ä¼šè‡ªåŠ¨å»è°ƒç”¨è¿™äº›é”€æ¯æ–¹æ³•ï¼Œè€Œæ˜¯éœ€è¦æˆ‘ä»¬ä¸»åŠ¨å»å‘ŠçŸ¥ Spring å®¹å™¨ã€‚ å¯¹äº BeanFactory å®¹å™¨è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦ä¸»åŠ¨è°ƒç”¨ destroySingletons() é€šçŸ¥ BeanFactory å®¹å™¨å»æ‰§è¡Œç›¸åº”çš„é”€æ¯æ–¹æ³•ã€‚ å¯¹äº ApplicationContext å®¹å™¨è€Œè¨€è°ƒç”¨ registerShutdownHook() æ–¹æ³•ã€‚ å®è·µéªŒè¯ä¸‹é¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥çœŸå®çœ‹çœ‹çœ‹ä¸Šé¢æ‰§è¡Œçš„é€»è¾‘ï¼Œæ¯•ç«Ÿç†è®ºæ˜¯ä¸èƒ½ç¼ºå°‘å®è·µçš„ï¼š public class lifeCycleBean implements BeanNameAware,BeanFactoryAware,BeanClassLoaderAware,BeanPostProcessor, InitializingBean,DisposableBean &#123; private String test; public String getTest() &#123; return test; &#125; public void setTest(String test) &#123; System.out.println(&quot;å±æ€§æ³¨å…¥....&quot;); this.test = test; &#125; public lifeCycleBean()&#123; System.out.println(&quot;æ„é€ å‡½æ•°è°ƒç”¨...&quot;); &#125; public void display()&#123; System.out.println(&quot;æ–¹æ³•è°ƒç”¨...&quot;); &#125; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; System.out.println(&quot;BeanFactoryAware è¢«è°ƒç”¨...&quot;); &#125; @Override public void setBeanName(String name) &#123; System.out.println(&quot;BeanNameAware è¢«è°ƒç”¨...&quot;); &#125; @Override public void setBeanClassLoader(ClassLoader classLoader) &#123; System.out.println(&quot;BeanClassLoaderAware è¢«è°ƒç”¨...&quot;); &#125; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;BeanPostProcessor postProcessBeforeInitialization è¢«è°ƒç”¨...&quot;); return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;BeanPostProcessor postProcessAfterInitialization è¢«è°ƒç”¨...&quot;); return bean; &#125; @Override public void destroy() throws Exception &#123; System.out.println(&quot;DisposableBean destroy è¢«è°ƒåŠ¨...&quot;); &#125; @Override public void afterPropertiesSet() throws Exception &#123; System.out.println(&quot;InitializingBean afterPropertiesSet è¢«è°ƒåŠ¨...&quot;); &#125; public void initMethod()&#123; System.out.println(&quot;init-method è¢«è°ƒç”¨...&quot;); &#125; public void destroyMethdo()&#123; System.out.println(&quot;destroy-method è¢«è°ƒç”¨...&quot;); &#125;&#125; lifeCycleBean ç»§æ‰¿äº† BeanNameAware , BeanFactoryAware , BeanClassLoaderAware , BeanPostProcessor , InitializingBean , DisposableBean å…­ä¸ªæ¥å£ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸€ä¸ª test å±æ€§ç”¨äºéªŒè¯å±æ€§æ³¨å…¥å’Œæä¾›ä¸€ä¸ª display() ç”¨äºæ¨¡æ‹Ÿè°ƒç”¨ã€‚ é…ç½®å¦‚ä¸‹ï¼š &lt;bean id=&quot;lifeCycle&quot; class=&quot;org.springframework.core.test.lifeCycleBean&quot; init-method=&quot;initMethod&quot; destroy-method=&quot;destroyMethdo&quot;&gt; &lt;property name=&quot;test&quot; value=&quot;test&quot;/&gt;&lt;/bean&gt; é…ç½® init-method å’Œ destroy-methodã€‚æµ‹è¯•æ–¹æ³•å¦‚ä¸‹ï¼š // BeanFactory å®¹å™¨ä¸€å®šè¦è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œ BeanPostProcessor æ³¨å†Œfactory.addBeanPostProcessor(new lifeCycleBean());lifeCycleBean lifeCycleBean = (lifeCycleBean) factory.getBean(&quot;lifeCycle&quot;);lifeCycleBean.display();System.out.println(&quot;æ–¹æ³•è°ƒç”¨å®Œæˆï¼Œå®¹å™¨å¼€å§‹å…³é—­....&quot;);// å…³é—­å®¹å™¨factory.destroySingletons(); è¿è¡Œç»“æœï¼š æ„é€ å‡½æ•°è°ƒç”¨...æ„é€ å‡½æ•°è°ƒç”¨...å±æ€§æ³¨å…¥....BeanNameAware è¢«è°ƒç”¨...BeanClassLoaderAware è¢«è°ƒç”¨...BeanFactoryAware è¢«è°ƒç”¨...BeanPostProcessor postProcessBeforeInitialization è¢«è°ƒç”¨...InitializingBean afterPropertiesSet è¢«è°ƒåŠ¨...init-method è¢«è°ƒç”¨...BeanPostProcessor postProcessAfterInitialization è¢«è°ƒç”¨...æ–¹æ³•è°ƒç”¨...æ–¹æ³•è°ƒç”¨å®Œæˆï¼Œå®¹å™¨å¼€å§‹å…³é—­....DisposableBean destroy è¢«è°ƒåŠ¨...destroy-method è¢«è°ƒç”¨... æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°è°ƒç”¨æ˜¯å› ä¸ºè¦æ³¨å…¥ä¸€ä¸ª BeanPostProcessorï¼ˆä½ ä¹Ÿå¯ä»¥å¦å¤–æä¾›ä¸€ä¸ª BeanPostProcessor å®ä¾‹ï¼‰ã€‚ æ ¹æ®æ‰§è¡Œçš„ç»“æœå·²ç»ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ Spring Bean çš„å£°æ˜å‘¨æœŸè¿‡ç¨‹å¦‚ä¸‹ï¼ˆæ–¹æ³•çº§åˆ«ï¼‰ï¼š Spring å®¹å™¨æ ¹æ®å®ä¾‹åŒ–ç­–ç•¥å¯¹ Bean è¿›è¡Œå®ä¾‹åŒ–ã€‚ å®ä¾‹åŒ–å®Œæˆåï¼Œå¦‚æœè¯¥ bean è®¾ç½®äº†ä¸€äº›å±æ€§çš„è¯ï¼Œåˆ™åˆ©ç”¨ set æ–¹æ³•è®¾ç½®ä¸€äº›å±æ€§ã€‚ å¦‚æœè¯¥ Bean å®ç°äº† BeanNameAware æ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanName() æ–¹æ³•ã€‚ å¦‚æœè¯¥ bean å®ç°äº† BeanClassLoaderAware æ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanClassLoader() æ–¹æ³•ã€‚ å¦‚æœè¯¥ bean å®ç°äº† BeanFactoryAwareæ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanFactory() æ–¹æ³•ã€‚ å¦‚æœè¯¥å®¹å™¨æ³¨å†Œäº† BeanPostProcessorï¼Œåˆ™ä¼šè°ƒç”¨postProcessBeforeInitialization() æ–¹æ³•å®Œæˆ bean å‰ç½®å¤„ç† å¦‚æœè¯¥ bean å®ç°äº† InitializingBean æ¥å£ï¼Œåˆ™è°ƒç”¨ ã€‚afterPropertiesSet() æ–¹æ³•ã€‚ å¦‚æœè¯¥ bean é…ç½®äº† init-method æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ init-method æŒ‡å®šçš„æ–¹æ³•ã€‚ åˆå§‹åŒ–å®Œæˆåï¼Œå¦‚æœè¯¥å®¹å™¨æ³¨å†Œäº† BeanPostProcessor åˆ™ä¼šè°ƒç”¨ postProcessAfterInitialization() æ–¹æ³•å®Œæˆ bean çš„åç½®å¤„ç†ã€‚ å¯¹è±¡å®Œæˆåˆå§‹åŒ–ï¼Œå¼€å§‹æ–¹æ³•è°ƒç”¨ã€‚ åœ¨å®¹å™¨è¿›è¡Œå…³é—­ä¹‹å‰ï¼Œå¦‚æœè¯¥ bean å®ç°äº† DisposableBean æ¥å£ï¼Œåˆ™è°ƒç”¨ destroy() æ–¹æ³•ã€‚ åœ¨å®¹å™¨è¿›è¡Œå…³é—­ä¹‹å‰ï¼Œå¦‚æœè¯¥ bean é…ç½®äº† destroy-mehodï¼Œåˆ™è°ƒç”¨å…¶æŒ‡å®šçš„æ–¹æ³•ã€‚ åˆ°è¿™é‡Œä¸€ä¸ª bean ä¹Ÿå°±å®Œæˆäº†å®ƒçš„ä¸€ç”Ÿã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"Springçš„ç¯å¢ƒ&å±æ€§ï¼šPropertySourceã€Environmentã€Profile","date":"2020-01-25T14:09:19.000Z","path":"2020/01/25/8ce6797f.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4032 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE spring.profiles.active å’Œ @Profile è¿™ä¸¤ä¸ªæˆ‘ç›¸ä¿¡å„ä½éƒ½ç†Ÿæ‚‰å§ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¯ä»¥å®ç°ä¸åŒç¯å¢ƒä¸‹ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰å‚æ•°é…ç½®çš„åˆ‡æ¢ã€‚ å…¶å®å…³äºç¯å¢ƒçš„åˆ‡æ¢ï¼Œåœ¨åšå®¢ IOC ä¹‹ PropertyPlaceholderConfigurer çš„åº”ç”¨ å·²ç»ä»‹ç»äº†åˆ©ç”¨ PropertyPlaceholderConfigurer æ¥å®ç°åŠ¨æ€åˆ‡æ¢é…ç½®ç¯å¢ƒï¼Œå½“ç„¶è¿™ç§æ–¹æ³•éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæœ‰ç‚¹å„¿éº»çƒ¦ã€‚ä½†æ˜¯å¯¹äºè¿™ç§éå¸¸å®é™…çš„éœ€æ±‚ï¼ŒSpring æ€ä¹ˆå¯èƒ½æ²¡æœ‰æä¾›å‘¢ï¼Ÿä¸‹é¢å°±è¿™ä¸ªé—®é¢˜æ¥å¯¹ Spring çš„ç¯å¢ƒ &amp; å±æ€§æ¥åšä¸€ä¸ªåˆ†æè¯´æ˜ã€‚ æ¦‚æ‹¬Spring ç¯å¢ƒ &amp; å±æ€§ç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼šPropertySourceã€PropertyResolverã€Profile å’Œ Environmentã€‚ PropertySourceï¼šå±æ€§æºï¼Œkey-value å±æ€§å¯¹æŠ½è±¡ï¼Œç”¨äºé…ç½®æ•°æ®ã€‚ PropertyResolverï¼šå±æ€§è§£æå™¨ï¼Œç”¨äºè§£æå±æ€§é…ç½® Profileï¼šå‰–é¢ï¼Œåªæœ‰æ¿€æ´»çš„å‰–é¢çš„ç»„ä»¶/é…ç½®æ‰ä¼šæ³¨å†Œåˆ° Spring å®¹å™¨ï¼Œç±»ä¼¼äº Spring Boot ä¸­çš„ profile Environmentï¼šç¯å¢ƒï¼ŒProfile å’Œ PropertyResolver çš„ç»„åˆã€‚ ä¸‹é¢æ˜¯æ•´ä¸ªä½“ç³»çš„ç»“æ„å›¾ï¼š ä¸‹é¢å°±é’ˆå¯¹ä¸Šé¢ç»“æ„å›¾å¯¹ Spring çš„ Properties &amp; Environment åšä¸€ä¸ªè¯¦ç»†çš„åˆ†æã€‚ PropertiesPropertyResolver å±æ€§è§£æå™¨ï¼Œç”¨äºè§£æä»»ä½•åŸºç¡€æºçš„å±æ€§çš„æ¥å£ public interface PropertyResolver &#123; // æ˜¯å¦åŒ…å«æŸä¸ªå±æ€§ boolean containsProperty(String key); // è·å–å±æ€§å€¼ å¦‚æœæ‰¾ä¸åˆ°è¿”å›null @Nullable String getProperty(String key); // è·å–å±æ€§å€¼ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¿”å›é»˜è®¤å€¼ String getProperty(String key, String defaultValue); // è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°è¿”å›null @Nullable &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType); // è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°è¿”å›é»˜è®¤å€¼ &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType, T defaultValue); // è·å–å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalStateException String getRequiredProperty(String key) throws IllegalStateException; // è·å–æŒ‡å®šç±»å‹çš„å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalStateException &lt;T&gt; T getRequiredProperty(String key, Class&lt;T&gt; targetType) throws IllegalStateException; // æ›¿æ¢æ–‡æœ¬ä¸­çš„å ä½ç¬¦ï¼ˆ$&#123;key&#125;ï¼‰åˆ°å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°ä¸è§£æ String resolvePlaceholders(String text); // æ›¿æ¢æ–‡æœ¬ä¸­çš„å ä½ç¬¦ï¼ˆ$&#123;key&#125;ï¼‰åˆ°å±æ€§å€¼ï¼Œæ‰¾ä¸åˆ°æŠ›å‡ºå¼‚å¸¸IllegalArgumentException String resolveRequiredPlaceholders(String text) throws IllegalArgumentException;&#125; ä» API ä¸Šé¢æˆ‘ä»¬å°±çŸ¥é“å±æ€§è§£æå™¨ PropertyResolver çš„ä½œç”¨äº†ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è¿ç”¨ã€‚ PropertyResolver propertyResolver = new PropertySourcesPropertyResolver(propertySources);System.out.println(propertyResolver.getProperty(&quot;name&quot;));System.out.println(propertyResolver.getProperty(&quot;name&quot;, &quot;chenssy&quot;));System.out.println(propertyResolver.resolvePlaceholders(&quot;my name is $&#123;name&#125;&quot;)); ä¸‹å›¾æ˜¯ PropertyResolver ä½“ç³»ç»“æ„å›¾ï¼š ConfigurablePropertyResolverï¼šä¾›å±æ€§ç±»å‹è½¬æ¢çš„åŠŸèƒ½ AbstractPropertyResolverï¼šè§£æå±æ€§æ–‡ä»¶çš„æŠ½è±¡åŸºç±» PropertySourcesPropertyResolverï¼šPropertyResolver çš„å®ç°è€…ï¼Œä»–å¯¹ä¸€ç»„ PropertySources æä¾›å±æ€§è§£ææœåŠ¡ ConfigurablePropertyResolver æä¾›å±æ€§ç±»å‹è½¬æ¢çš„åŠŸèƒ½ é€šä¿—ç‚¹è¯´å°±æ˜¯ ConfigurablePropertyResolver æä¾›å±æ€§å€¼ç±»å‹è½¬æ¢æ‰€éœ€è¦çš„ ConversionServiceã€‚ public interface ConfigurablePropertyResolver extends PropertyResolver &#123; // è¿”å›æ‰§è¡Œç±»å‹è½¬æ¢æ—¶ä½¿ç”¨çš„ ConfigurableConversionService ConfigurableConversionService getConversionService(); // è®¾ç½® ConfigurableConversionService void setConversionService(ConfigurableConversionService conversionService); // è®¾ç½®å ä½ç¬¦å‰ç¼€ void setPlaceholderPrefix(String placeholderPrefix); // è®¾ç½®å ä½ç¬¦åç¼€ void setPlaceholderSuffix(String placeholderSuffix); // è®¾ç½®å ä½ç¬¦ä¸é»˜è®¤å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦ void setValueSeparator(@Nullable String valueSeparator); // è®¾ç½®å½“é‡åˆ°åµŒå¥—åœ¨ç»™å®šå±æ€§å€¼å†…çš„ä¸å¯è§£æçš„å ä½ç¬¦æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸ // å½“å±æ€§å€¼åŒ…å«ä¸å¯è§£æçš„å ä½ç¬¦æ—¶ï¼ŒgetProperty(String)åŠå…¶å˜ä½“çš„å®ç°å¿…é¡»æ£€æŸ¥æ­¤å¤„è®¾ç½®çš„å€¼ä»¥ç¡®å®šæ­£ç¡®çš„è¡Œä¸ºã€‚ void setIgnoreUnresolvableNestedPlaceholders(boolean ignoreUnresolvableNestedPlaceholders); // æŒ‡å®šå¿…é¡»å­˜åœ¨å“ªäº›å±æ€§ï¼Œä»¥ä¾¿ç”±validateRequiredPropertiesï¼ˆï¼‰éªŒè¯ void setRequiredProperties(String... requiredProperties); // éªŒè¯setRequiredPropertiesæŒ‡å®šçš„æ¯ä¸ªå±æ€§æ˜¯å¦å­˜åœ¨å¹¶è§£æä¸ºénullå€¼ void validateRequiredProperties() throws MissingRequiredPropertiesException;&#125; ä» ConfigurablePropertyResolver æ‰€æä¾›çš„æ–¹æ³•æ¥çœ‹ï¼Œé™¤äº†è®¿é—®å’Œè®¾ç½® ConversionService å¤–ï¼Œä¸»è¦è¿˜æä¾›äº†ä¸€äº›è§£æè§„åˆ™ä¹‹ç±»çš„æ–¹æ³•ã€‚ å°± Properties ä½“ç³»è€Œè¨€ï¼ŒPropertyResolver å®šä¹‰äº†è®¿é—® Properties å±æ€§å€¼çš„æ–¹æ³•ï¼Œè€Œ ConfigurablePropertyResolver åˆ™å®šä¹‰äº†è§£æ Properties ä¸€äº›ç›¸å…³çš„è§„åˆ™å’Œå€¼è¿›è¡Œç±»å‹è½¬æ¢æ‰€éœ€è¦çš„ Serviceã€‚ è¯¥ä½“ç³»æœ‰ä¸¤ä¸ªå®ç°è€…ï¼šAbstractPropertyResolver å’Œ PropertySourcesPropertyResolverï¼Œå…¶ä¸­ AbstractPropertyResolver ä¸ºå®ç°çš„æŠ½è±¡åŸºç±»ï¼ŒPropertySourcesPropertyResolver ä¸ºçœŸæ­£çš„å®ç°è€…ã€‚ AbstractPropertyResolver è§£æå±æ€§æ–‡ä»¶çš„æŠ½è±¡åŸºç±» AbstractPropertyResolver ä½œä¸ºåŸºç±»å®ƒä»…ä»…åªæ˜¯è®¾ç½®äº†ä¸€äº›è§£æå±æ€§æ–‡ä»¶æ‰€éœ€è¦é…ç½®æˆ–è€…è½¬æ¢å™¨ï¼Œå¦‚ setConversionService()ã€setPlaceholderPrefix()ã€setValueSeparator()ï¼Œå…¶å®è¿™äº›æ–¹æ³•çš„å®ç°éƒ½æ¯”è¾ƒç®€å•éƒ½æ˜¯è®¾ç½®æˆ–è€…è·å– AbstractPropertyResolver æ‰€æä¾›çš„å±æ€§ï¼Œå¦‚ä¸‹ï¼š // ç±»å‹è½¬æ¢å»private volatile ConfigurableConversionService conversionService;// å ä½ç¬¦private PropertyPlaceholderHelper nonStrictHelper;//private PropertyPlaceholderHelper strictHelper;// è®¾ç½®æ˜¯å¦æŠ›å‡ºå¼‚å¸¸private boolean ignoreUnresolvableNestedPlaceholders = false;// å ä½ç¬¦å‰ç¼€private String placeholderPrefix = SystemPropertyUtils.PLACEHOLDER_PREFIX;// å ä½ç¬¦åç¼€private String placeholderSuffix = SystemPropertyUtils.PLACEHOLDER_SUFFIX;// ä¸é»˜è®¤å€¼çš„åˆ†å‰²private String valueSeparator = SystemPropertyUtils.VALUE_SEPARATOR;// å¿…é¡»è¦æœ‰çš„å­—æ®µå€¼private final Set&lt;String&gt; requiredProperties = new LinkedHashSet&lt;&gt;(); è¿™äº›å±æ€§éƒ½æ˜¯ ConfigurablePropertyResolver æ¥å£æ‰€æä¾›æ–¹æ³•éœ€è¦çš„å±æ€§ï¼Œä»–æ‰€æä¾›çš„æ–¹æ³•éƒ½æ˜¯è®¾ç½®å’Œè¯»å–è¿™äº›å€¼ï¼Œå¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š public ConfigurableConversionService getConversionService() &#123; // éœ€è¦æä¾›ç‹¬ç«‹çš„DefaultConversionServiceï¼Œè€Œä¸æ˜¯PropertySourcesPropertyResolver ä½¿ç”¨çš„å…±äº«DefaultConversionServiceã€‚ ConfigurableConversionService cs = this.conversionService; if (cs == null) &#123; synchronized (this) &#123; cs = this.conversionService; if (cs == null) &#123; cs = new DefaultConversionService(); this.conversionService = cs; &#125; &#125; &#125; return cs;&#125;@Overridepublic void setConversionService(ConfigurableConversionService conversionService) &#123; Assert.notNull(conversionService, &quot;ConversionService must not be null&quot;); this.conversionService = conversionService;&#125;public void setPlaceholderPrefix(String placeholderPrefix) &#123; Assert.notNull(placeholderPrefix, &quot;&#x27;placeholderPrefix&#x27; must not be null&quot;); this.placeholderPrefix = placeholderPrefix;&#125;public void setPlaceholderSuffix(String placeholderSuffix) &#123; Assert.notNull(placeholderSuffix, &quot;&#x27;placeholderSuffix&#x27; must not be null&quot;); this.placeholderSuffix = placeholderSuffix;&#125; è€Œå¯¹å±æ€§çš„è®¿é—®åˆ™å§”æ‰˜ç»™å­ç±» PropertySourcesPropertyResolver å®ç°ã€‚ public String getProperty(String key) &#123; return getProperty(key, String.class);&#125;public String getProperty(String key, String defaultValue) &#123; String value = getProperty(key); return (value != null ? value : defaultValue);&#125;public &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType, T defaultValue) &#123; T value = getProperty(key, targetType); return (value != null ? value : defaultValue);&#125;public String getRequiredProperty(String key) throws IllegalStateException &#123; String value = getProperty(key); if (value == null) &#123; throw new IllegalStateException(&quot;Required key &#x27;&quot; + key + &quot;&#x27; not found&quot;); &#125; return value;&#125;public &lt;T&gt; T getRequiredProperty(String key, Class&lt;T&gt; valueType) throws IllegalStateException &#123; T value = getProperty(key, valueType); if (value == null) &#123; throw new IllegalStateException(&quot;Required key &#x27;&quot; + key + &quot;&#x27; not found&quot;); &#125; return value; PropertySourcesPropertyResolver PropertyResolver çš„å®ç°è€…ï¼Œä»–å¯¹ä¸€ç»„ PropertySources æä¾›å±æ€§è§£ææœåŠ¡ å®ƒä»…æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼šPropertySourcesã€‚è¯¥æˆå‘˜å˜é‡å†…éƒ¨å­˜å‚¨ç€ä¸€ç»„ PropertySourceï¼Œè¡¨ç¤º key-value é”®å€¼å¯¹çš„æºçš„æŠ½è±¡åŸºç±»ï¼Œå³ä¸€ä¸ª PropertySource å¯¹è±¡åˆ™æ˜¯ä¸€ä¸ª key-value é”®å€¼å¯¹ã€‚å¦‚ä¸‹ï¼š public abstract class PropertySource&lt;T&gt; &#123; protected final Log logger = LogFactory.getLog(getClass()); protected final String name; protected final T source; //......&#125; å¯¹å¤–å…¬å¼€çš„ getProperty() éƒ½æ˜¯å§”æ‰˜ç»™ getProperty(String key, Class&lt;T&gt; targetValueType, boolean resolveNestedPlaceholders) å®ç°ï¼Œä»–æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸ºï¼š keyï¼šè·å–çš„ key targetValueTypeï¼š ç›®æ ‡ value çš„ç±»å‹ resolveNestedPlaceholdersï¼šæ˜¯å¦è§£å†³åµŒå¥—å ä½ç¬¦ æºç å¦‚ä¸‹ï¼š protected &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetValueType, boolean resolveNestedPlaceholders) &#123; if (this.propertySources != null) &#123; for (PropertySource&lt;?&gt; propertySource : this.propertySources) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Searching for key &#x27;&quot; + key + &quot;&#x27; in PropertySource &#x27;&quot; + propertySource.getName() + &quot;&#x27;&quot;); &#125; Object value = propertySource.getProperty(key); if (value != null) &#123; if (resolveNestedPlaceholders &amp;&amp; value instanceof String) &#123; value = resolveNestedPlaceholders((String) value); &#125; logKeyFound(key, propertySource, value); return convertValueIfNecessary(value, targetValueType); &#125; &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Could not find key &#x27;&quot; + key + &quot;&#x27; in any property source&quot;); &#125; return null;&#125; é¦–å…ˆä» propertySource ä¸­è·å–æŒ‡å®š key çš„ value å€¼ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåµŒå¥—å ä½ç¬¦è§£æï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨ resolveNestedPlaceholders() è¿›è¡ŒåµŒå¥—å ä½ç¬¦è§£æï¼Œç„¶åè°ƒç”¨ convertValueIfNecessary() è¿›è¡Œç±»å‹è½¬æ¢ã€‚ resolveNestedPlaceholders() è¯¥æ–¹æ³•ç”¨äºè§£æç»™å®šå­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ï¼ŒåŒæ—¶æ ¹æ® ignoreUnresolvableNestedPlaceholders çš„å€¼ï¼Œæ¥ç¡®å®šæ˜¯å¦å¯¹ä¸å¯è§£æçš„å ä½ç¬¦çš„å¤„ç†æ–¹æ³•ï¼šæ˜¯å¿½ç•¥è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ˆè¯¥å€¼ç”± setIgnoreUnresolvableNestedPlaceholders() è®¾ç½®ï¼‰ã€‚ protected String resolveNestedPlaceholders(String value) &#123; return (this.ignoreUnresolvableNestedPlaceholders ? resolvePlaceholders(value) : resolveRequiredPlaceholders(value));&#125; å¦‚æœ this.ignoreUnresolvableNestedPlaceholders ä¸º trueï¼Œåˆ™è°ƒç”¨ resolvePlaceholders() ï¼Œå¦åˆ™è°ƒç”¨ resolveRequiredPlaceholders()ä½†æ˜¯æ— è®ºæ˜¯å“ªä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šåˆ° doResolvePlaceholders()ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š String ç±»å‹çš„ textï¼šå¾…è§£æçš„å­—ç¬¦ä¸² PropertyPlaceholderHelper ç±»å‹çš„ helperï¼šç”¨äºè§£æå ä½ç¬¦çš„å·¥å…·ç±»ã€‚ private String doResolvePlaceholders(String text, PropertyPlaceholderHelper helper) &#123; return helper.replacePlaceholders(text, this::getPropertyAsRawString);&#125; PropertyPlaceholderHelper æ˜¯ç”¨äºå¤„ç†åŒ…å«å ä½ç¬¦å€¼çš„å­—ç¬¦ä¸²ï¼Œæ„é€ è¯¥å®ä¾‹éœ€è¦å››ä¸ªå‚æ•°ï¼š placeholderPrefixï¼šå ä½ç¬¦å‰ç¼€ placeholderSuffixï¼šå ä½ç¬¦åç¼€ valueSeparatorï¼šå ä½ç¬¦å˜é‡ä¸å…³è”çš„é»˜è®¤å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦ ignoreUnresolvablePlaceholdersï¼šæŒ‡ç¤ºæ˜¯å¦å¿½ç•¥ä¸å¯è§£æçš„å ä½ç¬¦ï¼ˆtrueï¼‰æˆ–æŠ›å‡ºå¼‚å¸¸ï¼ˆfalseï¼‰ æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š public PropertyPlaceholderHelper(String placeholderPrefix, String placeholderSuffix, @Nullable String valueSeparator, boolean ignoreUnresolvablePlaceholders) &#123; Assert.notNull(placeholderPrefix, &quot;&#x27;placeholderPrefix&#x27; must not be null&quot;); Assert.notNull(placeholderSuffix, &quot;&#x27;placeholderSuffix&#x27; must not be null&quot;); this.placeholderPrefix = placeholderPrefix; this.placeholderSuffix = placeholderSuffix; String simplePrefixForSuffix = wellKnownSimplePrefixes.get(this.placeholderSuffix); if (simplePrefixForSuffix != null &amp;&amp; this.placeholderPrefix.endsWith(simplePrefixForSuffix)) &#123; this.simplePrefix = simplePrefixForSuffix; &#125; else &#123; this.simplePrefix = this.placeholderPrefix; &#125; this.valueSeparator = valueSeparator; this.ignoreUnresolvablePlaceholders = ignoreUnresolvablePlaceholders;&#125; å°± PropertySourcesPropertyResolver è€Œè¨€ï¼Œå…¶çˆ¶ç±» AbstractPropertyResolver å·²ç»å¯¹ä¸Šè¿°å››ä¸ªå€¼åšäº†å®šä¹‰ï¼šplaceholderPrefix ä¸º $&#123;ï¼ŒplaceholderSuffix ä¸º &#125;ï¼ŒvalueSeparator ä¸º :ï¼ŒignoreUnresolvablePlaceholders é»˜è®¤ä¸º falseï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸åº”çš„ setter æ–¹æ³•è‡ªå®šä¹‰ã€‚ è°ƒç”¨ PropertyPlaceholderHelper çš„ replacePlaceholders() å¯¹å ä½ç¬¦è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¾…è§£æçš„å­—ç¬¦ä¸² value ï¼Œä¸€ä¸ªæ˜¯ PlaceholderResolver ç±»å‹çš„ placeholderResolverï¼Œä»–æ˜¯å®šä¹‰å ä½ç¬¦è§£æçš„ç­–ç•¥ç±»ã€‚å¦‚ä¸‹ï¼š public String replacePlaceholders(String value, PlaceholderResolver placeholderResolver) &#123; Assert.notNull(value, &quot;&#x27;value&#x27; must not be null&quot;); return parseStringValue(value, placeholderResolver, new HashSet&lt;&gt;());&#125; å†…éƒ¨å§”æ‰˜ç»™ parseStringValue() å®ç°ï¼š protected String parseStringValue( String value, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders) &#123; StringBuilder result = new StringBuilder(value); // æ£€ç´¢å‰ç¼€ï¼Œ$&#123; int startIndex = value.indexOf(this.placeholderPrefix); while (startIndex != -1) &#123; // æ£€ç´¢åç¼€ ,&#125; int endIndex = findPlaceholderEndIndex(result, startIndex); if (endIndex != -1) &#123; // å‰ç¼€å’Œåç¼€ä¹‹é—´çš„å­—ç¬¦ä¸² String placeholder = result.substring(startIndex + this.placeholderPrefix.length(), endIndex); String originalPlaceholder = placeholder; // å¾ªç¯å ä½ç¬¦ // åˆ¤æ–­è¯¥å ä½ç¬¦æ˜¯å¦å·²ç»å¤„ç†äº† if (!visitedPlaceholders.add(originalPlaceholder)) &#123; throw new IllegalArgumentException( &quot;Circular placeholder reference &#x27;&quot; + originalPlaceholder + &quot;&#x27; in property definitions&quot;); &#125; // é€’å½’è°ƒç”¨ï¼Œè§£æå ä½ç¬¦ placeholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders); // è·å–å€¼ String propVal = placeholderResolver.resolvePlaceholder(placeholder); // propval ä¸ºç©ºï¼Œåˆ™æå–é»˜è®¤å€¼ if (propVal == null &amp;&amp; this.valueSeparator != null) &#123; int separatorIndex = placeholder.indexOf(this.valueSeparator); if (separatorIndex != -1) &#123; String actualPlaceholder = placeholder.substring(0, separatorIndex); String defaultValue = placeholder.substring(separatorIndex + this.valueSeparator.length()); propVal = placeholderResolver.resolvePlaceholder(actualPlaceholder); if (propVal == null) &#123; propVal = defaultValue; &#125; &#125; &#125; if (propVal != null) &#123; // é€’å½’è°ƒç”¨ï¼Œè§£æå…ˆå‰è§£æçš„å ä½ç¬¦å€¼ä¸­åŒ…å«çš„å ä½ç¬¦ propVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders); result.replace(startIndex, endIndex + this.placeholderSuffix.length(), propVal); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Resolved placeholder &#x27;&quot; + placeholder + &quot;&#x27;&quot;); &#125; startIndex = result.indexOf(this.placeholderPrefix, startIndex + propVal.length()); &#125; else if (this.ignoreUnresolvablePlaceholders) &#123; // Proceed with unprocessed value. startIndex = result.indexOf(this.placeholderPrefix, endIndex + this.placeholderSuffix.length()); &#125; else &#123; throw new IllegalArgumentException(&quot;Could not resolve placeholder &#x27;&quot; + placeholder + &quot;&#x27;&quot; + &quot; in value \\&quot;&quot; + value + &quot;\\&quot;&quot;); &#125; // visitedPlaceholders.remove(originalPlaceholder); &#125; else &#123; startIndex = -1; &#125; &#125; return result.toString();&#125; å…¶å®å°±æ˜¯è·å–å ä½ç¬¦ $&#123;&#125; ä¸­é—´çš„å€¼ï¼Œè¿™é‡Œé¢ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œå› ä¸ºå¯èƒ½ä¼šå­˜åœ¨è¿™ç§æƒ…å†µ $&#123;$&#123;name&#125;&#125;ã€‚ convertValueIfNecessary() è¯¥æ–¹æ³•æ˜¯ä¸æ˜¯æ„Ÿè§‰åˆ°éå¸¸çš„ç†Ÿæ‚‰ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å®Œæˆç±»å‹è½¬æ¢çš„ã€‚å¦‚ä¸‹ï¼š protected &lt;T&gt; T convertValueIfNecessary(Object value, @Nullable Class&lt;T&gt; targetType) &#123; if (targetType == null) &#123; return (T) value; &#125; ConversionService conversionServiceToUse = this.conversionService; if (conversionServiceToUse == null) &#123; // Avoid initialization of shared DefaultConversionService if // no standard type conversion is needed in the first place... if (ClassUtils.isAssignableValue(targetType, value)) &#123; return (T) value; &#125; conversionServiceToUse = DefaultConversionService.getSharedInstance(); &#125; return conversionServiceToUse.convert(value, targetType);&#125; é¦–å…ˆè·å–ç±»å‹è½¬æ¢æœåŠ¡ conversionService ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¯ä»¥é€šè¿‡åå°„æ¥è®¾ç½®ï¼Œå¦‚æœå¯ä»¥åˆ™ç›´æ¥å¼ºè½¬è¿”å›ï¼Œå¦åˆ™æ„é€ ä¸€ä¸ª DefaultConversionService å®ä¾‹ï¼Œæœ€åè°ƒç”¨å…¶ convert() å®Œæˆç±»å‹è½¬æ¢ï¼Œåç»­å°±æ˜¯ Spring ç±»å‹è½¬æ¢ä½“ç³»çš„äº‹æƒ…äº†ï¼Œå¦‚æœå¯¹å…¶ä¸äº†è§£ï¼Œå¯ä»¥å‚è€ƒå°ç¼–è¿™ç¯‡åšå®¢ï¼šIOC ä¹‹æ·±å…¥åˆ†æ Bean çš„ç±»å‹è½¬æ¢ä½“ç³» Environment è¡¨ç¤ºå½“å‰åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œçš„ç¯å¢ƒ åº”ç”¨ç¨‹åºçš„ç¯å¢ƒæœ‰ä¸¤ä¸ªå…³é”®æ–¹é¢ï¼šprofile å’Œ propertiesã€‚ properties çš„æ–¹æ³•ç”± PropertyResolver å®šä¹‰ã€‚ profile åˆ™è¡¨ç¤ºå½“å‰çš„è¿è¡Œç¯å¢ƒï¼Œå¯¹äºåº”ç”¨ç¨‹åºä¸­çš„ properties è€Œè¨€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„éƒ½ä¼šåŠ è½½åˆ°ç³»ç»Ÿä¸­ï¼Œåªæœ‰å…¶å±æ€§ä¸ profile ä¸€ç›´æ‰ä¼šè¢«æ¿€æ´»åŠ è½½ï¼Œ æ‰€ä»¥ Environment å¯¹è±¡çš„ä½œç”¨æ˜¯ç¡®å®šå“ªäº›é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰å½“å‰å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä»¥åŠé»˜è®¤æƒ…å†µä¸‹å“ªäº›é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰åº”å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚properties åœ¨å‡ ä¹æ‰€æœ‰åº”ç”¨ç¨‹åºä¸­éƒ½å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œå¹¶ä¸”æœ‰å¤šç§æ¥æºï¼šå±æ€§æ–‡ä»¶ï¼ŒJVM ç³»ç»Ÿå±æ€§ï¼Œç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒJNDIï¼Œservlet ä¸Šä¸‹æ–‡å‚æ•°ï¼Œad-hoc å±æ€§å¯¹è±¡ï¼Œæ˜ å°„ç­‰ã€‚åŒæ—¶å®ƒç»§æ‰¿ PropertyResolver æ¥å£ï¼Œæ‰€ä»¥ä¸å±æ€§ç›¸å…³çš„ Environment å¯¹è±¡å…¶ä¸»è¦æ˜¯ä¸ºç”¨æˆ·æä¾›æ–¹ä¾¿çš„æœåŠ¡æ¥å£ï¼Œç”¨äºé…ç½®å±æ€§æºå’Œä»ä¸­å±æ€§æºä¸­è§£æå±æ€§ã€‚ public interface Environment extends PropertyResolver &#123; // è¿”å›æ­¤ç¯å¢ƒä¸‹æ¿€æ´»çš„é…ç½®æ–‡ä»¶é›† String[] getActiveProfiles(); // å¦‚æœæœªè®¾ç½®æ¿€æ´»é…ç½®æ–‡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„æ¿€æ´»çš„é…ç½®æ–‡ä»¶é›† String[] getDefaultProfiles(); boolean acceptsProfiles(String... profiles);&#125; Environment ä½“ç³»ç»“æ„å›¾å¦‚ä¸‹ï¼š PropertyResolverï¼šæä¾›å±æ€§è®¿é—®åŠŸèƒ½ Environmentï¼šæä¾›è®¿é—®å’Œåˆ¤æ–­ profiles çš„åŠŸèƒ½ ConfigurableEnvironmentï¼šæä¾›è®¾ç½®æ¿€æ´»çš„ profile å’Œé»˜è®¤çš„ profile çš„åŠŸèƒ½ä»¥åŠæ“ä½œ Properties çš„å·¥å…· ConfigurableWebEnvironmentï¼šæä¾›é…ç½® Servlet ä¸Šä¸‹æ–‡å’Œ Servlet å‚æ•°çš„åŠŸèƒ½ AbstractEnvironmentï¼šå®ç°äº† ConfigurableEnvironment æ¥å£ï¼Œé»˜è®¤å±æ€§å’Œå­˜å‚¨å®¹å™¨çš„å®šä¹‰ï¼Œå¹¶ä¸”å®ç°äº† ConfigurableEnvironment çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºå­ç±»é¢„ç•™å¯è¦†ç›–äº†æ‰©å±•æ–¹æ³• StandardEnvironmentï¼šç»§æ‰¿è‡ª AbstractEnvironment ï¼Œé Servlet(Web) ç¯å¢ƒä¸‹çš„æ ‡å‡† Environment å®ç° StandardServletEnvironmentï¼šç»§æ‰¿è‡ª StandardEnvironment ï¼ŒServlet(Web) ç¯å¢ƒä¸‹çš„æ ‡å‡† Environment å®ç° ConfigurableEnvironment æä¾›è®¾ç½®æ¿€æ´»çš„ profile å’Œé»˜è®¤çš„ profile çš„åŠŸèƒ½ä»¥åŠæ“ä½œ Properties çš„å·¥å…· è¯¥ç±»é™¤äº†ç»§æ‰¿ Environment æ¥å£å¤–è¿˜ç»§æ‰¿äº† ConfigurablePropertyResolver æ¥å£ï¼Œæ‰€ä»¥å®ƒå³å…·å¤‡äº†è®¾ç½® profile çš„åŠŸèƒ½ä¹Ÿå…·å¤‡äº†æ“ä½œ Properties çš„åŠŸèƒ½ã€‚åŒæ—¶è¿˜å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¾ç½®å’ŒéªŒè¯æ‰€éœ€è¦çš„å±æ€§ï¼Œè‡ªå®šä¹‰è½¬æ¢æœåŠ¡ç­‰åŠŸèƒ½ã€‚å¦‚ä¸‹ï¼š public interface ConfigurableEnvironment extends Environment, ConfigurablePropertyResolver &#123; // æŒ‡å®šè¯¥ç¯å¢ƒä¸‹çš„ profile é›† void setActiveProfiles(String... profiles); // å¢åŠ æ­¤ç¯å¢ƒçš„ profile void addActiveProfile(String profile); // è®¾ç½®é»˜è®¤çš„ profile void setDefaultProfiles(String... profiles); // è¿”å›æ­¤ç¯å¢ƒçš„ PropertySources MutablePropertySources getPropertySources(); // å°è¯•è¿”å› System.getenv() çš„å€¼ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›é€šè¿‡ System.getenv(string) çš„æ¥è®¿é—®å„ä¸ªé”®çš„æ˜ å°„ Map&lt;String, Object&gt; getSystemEnvironment(); // å°è¯•è¿”å› System.getProperties() çš„å€¼ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›é€šè¿‡ System.getProperties(string) çš„æ¥è®¿é—®å„ä¸ªé”®çš„æ˜ å°„ Map&lt;String, Object&gt; getSystemProperties(); void merge(ConfigurableEnvironment parent);&#125; AbstractEnvironment Environment çš„åŸºç¡€å®ç° å…è®¸é€šè¿‡è®¾ç½® ACTIVE_PROFILES_PROPERTY_NAME å’ŒDEFAULT_PROFILES_PROPERTY_NAME å±æ€§æŒ‡å®šæ´»åŠ¨å’Œé»˜è®¤é…ç½®æ–‡ä»¶ã€‚å­ç±»çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬é»˜è®¤æ·»åŠ çš„ PropertySource å¯¹è±¡ã€‚è€Œ AbstractEnvironment åˆ™æ²¡æœ‰æ·»åŠ ä»»ä½•å†…å®¹ã€‚å­ç±»åº”è¯¥é€šè¿‡å—ä¿æŠ¤çš„ customizePropertySources(MutablePropertySources) é’©å­æä¾›å±æ€§æºï¼Œè€Œå®¢æˆ·ç«¯åº”è¯¥ä½¿ç”¨ConfigurableEnvironment.getPropertySources()è¿›è¡Œè‡ªå®šä¹‰å¹¶å¯¹MutablePropertySources APIè¿›è¡Œæ“ä½œã€‚ åœ¨ AbstractEnvironment æœ‰ä¸¤å¯¹å˜é‡ï¼Œè¿™ä¸¤å¯¹å˜é‡ç»´æŠ¤ç€æ¿€æ´»å’Œé»˜è®¤é…ç½® profileã€‚å¦‚ä¸‹ï¼š public static final String ACTIVE_PROFILES_PROPERTY_NAME = &quot;spring.profiles.active&quot;;private final Set&lt;String&gt; activeProfiles = new LinkedHashSet&lt;&gt;();public static final String DEFAULT_PROFILES_PROPERTY_NAME = &quot;spring.profiles.default&quot;;private final Set&lt;String&gt; defaultProfiles = new LinkedHashSet&lt;&gt;(getReservedDefaultProfiles()); ç”±äºå®ç°æ–¹æ³•è¾ƒå¤šï¼Œè¿™é‡Œåªå…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼šsetActiveProfiles() å’Œ getActiveProfiles()ã€‚ setActiveProfiles() public void setActiveProfiles(String... profiles) &#123; Assert.notNull(profiles, &quot;Profile array must not be null&quot;); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Activating profiles &quot; + Arrays.asList(profiles)); &#125; synchronized (this.activeProfiles) &#123; this.activeProfiles.clear(); for (String profile : profiles) &#123; validateProfile(profile); this.activeProfiles.add(profile); &#125; &#125;&#125; è¯¥æ–¹æ³•å…¶å®å°±æ˜¯æ“ä½œ activeProfiles é›†åˆï¼Œåœ¨æ¯æ¬¡è®¾ç½®ä¹‹å‰éƒ½ä¼šå°†è¯¥é›†åˆæ¸…ç©ºé‡æ–°æ·»åŠ ï¼Œæ·»åŠ ä¹‹å‰è°ƒç”¨ validateProfile() å¯¹æ·»åŠ çš„ profile è¿›è¡Œæ ¡éªŒï¼Œå¦‚ä¸‹ï¼š protected void validateProfile(String profile) &#123; if (!StringUtils.hasText(profile)) &#123; throw new IllegalArgumentException(&quot;Invalid profile [&quot; + profile + &quot;]: must contain text&quot;); &#125; if (profile.charAt(0) == &#x27;!&#x27;) &#123; throw new IllegalArgumentException(&quot;Invalid profile [&quot; + profile + &quot;]: must not begin with ! operator&quot;); &#125;&#125; è¿™ä¸ªæ ¡éªŒè¿‡ç¨‹æ¯”è¾ƒå¼±ï¼Œå­ç±»å¯ä»¥æä¾›æ›´åŠ ä¸¥æ ¼çš„æ ¡éªŒè§„åˆ™ã€‚ getActiveProfiles() ä» getActiveProfiles() ä¸­æˆ‘ä»¬å¯ä»¥çŒœå‡ºè¿™ä¸ªæ–¹æ³•å®ç°çš„é€»è¾‘ï¼šè·å– activeProfiles é›†åˆå³å¯ã€‚ public String[] getActiveProfiles() &#123; return StringUtils.toStringArray(doGetActiveProfiles());&#125; å§”æ‰˜ç»™ doGetActiveProfiles() å®ç°ï¼š protected Set&lt;String&gt; doGetActiveProfiles() &#123; synchronized (this.activeProfiles) &#123; if (this.activeProfiles.isEmpty()) &#123; String profiles = getProperty(ACTIVE_PROFILES_PROPERTY_NAME); if (StringUtils.hasText(profiles)) &#123; setActiveProfiles(StringUtils.commaDelimitedListToStringArray( StringUtils.trimAllWhitespace(profiles))); &#125; &#125; return this.activeProfiles; &#125;&#125; å¦‚æœ activeProfiles ä¸ºç©ºï¼Œåˆ™ä» Properties ä¸­è·å– spring.profiles.active é…ç½®ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ setActiveProfiles() è®¾ç½® profileï¼Œæœ€åè¿”å›ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹BeanDefinitionæ³¨å†Œæœºï¼šBeanDefinitionRegistry","date":"2020-01-25T13:56:16.000Z","path":"2020/01/25/86c712d3.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4026 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE å°†å®šä¹‰ bean çš„èµ„æºæ–‡ä»¶è§£ææˆ BeanDefinition åéœ€è¦å°†å…¶æ³¨å…¥å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± BeanDefinitionRegistry æ¥å®Œæˆã€‚ BeanDefinitionRegistryï¼šå‘æ³¨å†Œè¡¨ä¸­æ³¨å†Œ BeanDefinition å®ä¾‹ï¼Œå®Œæˆæ³¨å†Œçš„è¿‡ç¨‹ã€‚ ä¸‹å›¾æ˜¯ BeanDefinitionRegistry ç±»ç»“æ„å›¾ï¼š BeanDefinitionRegistry ç»§æ‰¿äº† AliasRegistry æ¥å£ï¼Œå…¶æ ¸å¿ƒå­ç±»æœ‰ä¸‰ä¸ªï¼šSimpleBeanDefinitionRegistryã€DefaultListableBeanFactoryã€GenericApplicationContextã€‚ AliasRegistryç”¨äºåˆ«åç®¡ç†çš„é€šç”¨å‹æ¥å£ï¼Œä½œä¸º BeanDefinitionRegistry çš„é¡¶å±‚æ¥å£ã€‚ AliasRegistry å®šä¹‰äº†ä¸€äº›åˆ«åç®¡ç†çš„æ–¹æ³•ã€‚ public interface AliasRegistry &#123; void registerAlias(String name, String alias); void removeAlias(String alias); boolean isAlias(String name); String[] getAliases(String name);&#125; BeanDefinitionRegistryBeanDefinition çš„æ³¨å†Œæ¥å£ï¼Œå¦‚ RootBeanDefinition å’Œ ChildBeanDefinitionã€‚å®ƒé€šå¸¸ç”± BeanFactories å®ç°ï¼Œåœ¨ Spring ä¸­å·²çŸ¥çš„å®ç°è€…ä¸ºï¼šDefaultListableBeanFactory å’Œ GenericApplicationContextã€‚BeanDefinitionRegistry æ˜¯ Spring çš„ Bean å·¥å‚åŒ…ä¸­å”¯ä¸€å°è£… BeanDefinition æ³¨å†Œçš„æ¥å£ã€‚ BeanDefinitionRegistry æ¥å£å®šä¹‰äº†å…³äº BeanDefinition æ³¨å†Œã€æ³¨é”€ã€æŸ¥è¯¢ç­‰ä¸€ç³»åˆ—çš„æ“ä½œã€‚ public interface BeanDefinitionRegistry extends AliasRegistry &#123; // å¾€æ³¨å†Œè¡¨ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ BeanDefinition å®ä¾‹ void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException; // ç§»é™¤æ³¨å†Œè¡¨ä¸­å·²æ³¨å†Œçš„ BeanDefinition å®ä¾‹ void removeBeanDefinition(String beanName) throws NoSuchBeanDefinitionException; // ä»æ³¨å†Œä¸­å–å¾—æŒ‡å®šçš„ BeanDefinition å®ä¾‹ BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException; // åˆ¤æ–­ BeanDefinition å®ä¾‹æ˜¯å¦åœ¨æ³¨å†Œè¡¨ä¸­ï¼ˆæ˜¯å¦æ³¨å†Œï¼‰ boolean containsBeanDefinition(String beanName); // å–å¾—æ³¨å†Œè¡¨ä¸­æ‰€æœ‰ BeanDefinition å®ä¾‹çš„ beanNameï¼ˆæ ‡è¯†ï¼‰ String[] getBeanDefinitionNames(); // è¿”å›æ³¨å†Œè¡¨ä¸­ BeanDefinition å®ä¾‹çš„æ•°é‡ int getBeanDefinitionCount(); // beanNameï¼ˆæ ‡è¯†ï¼‰æ˜¯å¦è¢«å ç”¨ boolean isBeanNameInUse(String beanName);&#125; SimpleBeanDefinitionRegistrySimpleBeanDefinitionRegistry æ˜¯ BeanDefinitionRegistry ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œå®ƒè¿˜ç»§æ‰¿ SimpleAliasRegistryï¼ˆ AliasRegistry çš„ç®€å•å®ç°ï¼‰ï¼Œå®ƒä»…ä»…åªæä¾›æ³¨å†Œè¡¨åŠŸèƒ½ï¼Œæ— å·¥å‚åŠŸèƒ½ã€‚ SimpleBeanDefinitionRegistry ä½¿ç”¨ ConcurrentHashMap æ¥å­˜å‚¨æ³¨å†Œçš„ BeanDefinitionã€‚ private final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(64); ä»–å¯¹æ³¨å†Œå…¶ä¸­çš„ BeanDefinition éƒ½æ˜¯åŸºäº beanDefinitionMap è¿™ä¸ªé›†åˆæ¥å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š @Overridepublic void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123; Assert.hasText(beanName, &quot;&#x27;beanName&#x27; must not be empty&quot;); Assert.notNull(beanDefinition, &quot;BeanDefinition must not be null&quot;); this.beanDefinitionMap.put(beanName, beanDefinition);&#125;@Overridepublic void removeBeanDefinition(String beanName) throws NoSuchBeanDefinitionException &#123; if (this.beanDefinitionMap.remove(beanName) == null) &#123; throw new NoSuchBeanDefinitionException(beanName); &#125;&#125;@Overridepublic BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException &#123; BeanDefinition bd = this.beanDefinitionMap.get(beanName); if (bd == null) &#123; throw new NoSuchBeanDefinitionException(beanName); &#125; return bd;&#125; å®ç°ç®€å•ã€ç²—æš´ã€‚ DefaultListableBeanFactoryDefaultListableBeanFactoryï¼ŒConfigurableListableBeanFactoryï¼ˆå…¶å®å°±æ˜¯ BeanFactory ï¼‰ å’Œ BeanDefinitionRegistry æ¥å£çš„é»˜è®¤å®ç°ï¼šä¸€ä¸ªåŸºäº BeanDefinition å…ƒæ•°æ®çš„å®Œæ•´ bean å·¥å‚ã€‚ æ‰€ä»¥ç›¸å¯¹äº SimpleBeanDefinitionRegistry è€Œè¨€ï¼ŒDefaultListableBeanFactory åˆ™æ˜¯ä¸€ä¸ªå…·æœ‰æ³¨å†ŒåŠŸèƒ½çš„å®Œæ•´ bean å·¥å‚ã€‚å®ƒåŒæ ·æ˜¯ç”¨ ConcurrentHashMap æ•°æ®ç»“æ„æ¥å­˜å‚¨æ³¨å†Œçš„ BeanDefinitionã€‚ // æ³¨å†Œè¡¨ï¼Œç”± BeanDefinition çš„æ ‡è¯† ï¼ˆbeanNameï¼‰ ä¸å…¶å®ä¾‹ç»„æˆprivate final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;String, bean&gt;(64);// æ ‡è¯†ï¼ˆbeanNameï¼‰é›†åˆprivate final List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;String&gt;(64); åœ¨çœ‹ registerBeanDefinition()ï¼š public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123; // çœç•¥å…¶ä»–ä»£ç  else &#123; if (hasBeanCreationStarted()) &#123; // Cannot modify startup-time collection elements anymore (for stable iteration) synchronized (this.beanDefinitionMap) &#123; this.beanDefinitionMap.put(beanName, beanDefinition); List&lt;String&gt; updatedDefinitions = new ArrayList&lt;&gt;(this.beanDefinitionNames.size() + 1); updatedDefinitions.addAll(this.beanDefinitionNames); updatedDefinitions.add(beanName); this.beanDefinitionNames = updatedDefinitions; if (this.manualSingletonNames.contains(beanName)) &#123; Set&lt;String&gt; updatedSingletons = new LinkedHashSet&lt;&gt;(this.manualSingletonNames); updatedSingletons.remove(beanName); this.manualSingletonNames = updatedSingletons; &#125; &#125; &#125; else &#123; // æ³¨å†Œ BeanDefinition this.beanDefinitionMap.put(beanName, beanDefinition); this.beanDefinitionNames.add(beanName); this.manualSingletonNames.remove(beanName); &#125; this.frozenBeanDefinitionNames = null; &#125; if (existingDefinition != null || containsSingleton(beanName)) &#123; resetBeanDefinition(beanName); &#125;&#125; å…¶å®ä¸Šé¢ä¸€å †ä»£ç æœ€é‡è¦å°±åªæœ‰ä¸€å¥ï¼š this.beanDefinitionMap.put(beanName, beanDefinition); removeBeanDefinition() å…¶å®ä¹Ÿæ˜¯è°ƒç”¨ beanDefinitionMap.remove(beanName)ã€‚ å¯¹äºç±» GenericApplicationContext ï¼ŒæŸ¥çœ‹æºç ä½ ä¼šå‘ç°ä»–å®ç°æ³¨å†Œã€æ³¨é”€åŠŸèƒ½éƒ½æ˜¯å§”æ‰˜ DefaultListableBeanFactory å®ç°çš„ã€‚ æ‰€ä»¥ BeanDefinition æ³¨å†Œå¹¶ä¸æ˜¯éå¸¸é«˜å¤§ä¸Šçš„åŠŸèƒ½ï¼Œå†…éƒ¨å°±æ˜¯ç”¨ä¸€ä¸ª Map å®ç° ï¼Œå¹¶ä¸æ˜¯å¤šä¹ˆé«˜å¤§ä¸Šçš„éªšæ“ä½œï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæ½œæ„è¯†åœ°è®¤ä¸ºæŸäº›æŠ€æœ¯å¾ˆé«˜å¤§ä¸Šå°±è§‰å¾—ä»–å¾ˆæ·±å¥¥ï¼Œå¦‚æœè¯•ç€å»ä¸€æ¢ç©¶ç«Ÿä½ ä¼šå‘ç°ï¼ŒåŸæ¥è¿™ä¹ˆç®€å•ã€‚è™½ç„¶ BeanDefinitionRegistry å®ç°ç®€å•ï¼Œä½†æ˜¯å®ƒä½œä¸º Spring IOC å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œå…¶åœ°ä½è¿˜æ˜¯å¾ˆé‡çš„ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy","date":"2020-01-24T12:59:40.000Z","path":"2020/01/24/25302edf.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4022 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨å¼€å§‹åˆ†æ InstantiationStrategy ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•å›é¡¾ä¸‹ bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼š bean çš„åˆ›å»ºï¼Œä¸»è¦æ˜¯ AbstractAutowireCapableBeanFactory.doCreateBean() ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ bean çš„å®ä¾‹åŒ–ã€å±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯¹äº bean çš„å®ä¾‹åŒ–è¿‡ç¨‹è¿™æ˜¯æ ¹æ® bean çš„ç±»å‹æ¥åˆ¤æ–­çš„ï¼Œå¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™ç›´æ¥ä» factoryBeanInstanceCache ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è°ƒç”¨ createBeanInstance() åˆ›å»ºã€‚ åœ¨ createBeanInstance() ä¸­ï¼Œå¦‚æœ Supplier ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ obtainFromSupplier() å®ä¾‹åŒ– beanã€‚å¦‚æœ factory ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ instantiateUsingFactoryMethod() å®ä¾‹åŒ– bean ï¼Œå¦‚æœéƒ½ä¸æ˜¯åˆ™è°ƒç”¨ instantiateBean() å®ä¾‹åŒ–bean ã€‚ä½†æ˜¯æ— è®ºæ˜¯ instantiateUsingFactoryMethod() è¿˜æ˜¯ instantiateBean() æœ€åéƒ½ä¸€å®šä¼šè°ƒç”¨åˆ° InstantiationStrategy æ¥å£çš„ instantiate()ã€‚ InstantiationStrategyInstantiationStrategy æ¥å£å®šä¹‰äº† Spring Bean å®ä¾‹åŒ–çš„ç­–ç•¥ï¼Œæ ¹æ®åˆ›å»ºå¯¹è±¡æƒ…å†µçš„ä¸åŒï¼Œæä¾›äº†ä¸‰ç§ç­–ç•¥ï¼šæ— å‚æ„é€ æ–¹æ³•ã€æœ‰å‚æ„é€ æ–¹æ³•ã€å·¥å‚æ–¹æ³•ã€‚å¦‚ä¸‹ï¼š public interface InstantiationStrategy &#123; /** * é»˜è®¤æ„é€ æ–¹æ³• */ Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) throws BeansException; /** * æŒ‡å®šæ„é€ æ–¹æ³• */ Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, Constructor&lt;?&gt; ctor, @Nullable Object... args) throws BeansException; /** * å·¥å‚æ–¹æ³• */ Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, @Nullable Object factoryBean, Method factoryMethod, @Nullable Object... args) throws BeansException;&#125; SimpleInstantiationStrategyInstantiationStrategy æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼šSimpleInstantiationStrategy å’Œ CglibSubclassingInstantiationStrategyã€‚ SimpleInstantiationStrategy å¯¹ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•éƒ½åšäº†ç®€å•çš„å®ç°ã€‚ å¦‚æœæ˜¯å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™ç›´æ¥ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, @Nullable Object factoryBean, final Method factoryMethod, @Nullable Object... args) &#123; try &#123; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; ReflectionUtils.makeAccessible(factoryMethod); return null; &#125;); &#125; else &#123; ReflectionUtils.makeAccessible(factoryMethod); &#125; Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get(); try &#123; currentlyInvokedFactoryMethod.set(factoryMethod); Object result = factoryMethod.invoke(factoryBean, args); if (result == null) &#123; result = new NullBean(); &#125; return result; &#125; finally &#123; if (priorInvokedFactoryMethod != null) &#123; currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod); &#125; else &#123; currentlyInvokedFactoryMethod.remove(); &#125; &#125; &#125; // çœç•¥ catch&#125; å¦‚æœæ˜¯æ„é€ æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ MethodOverridesï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¯ç›´æ¥ä½¿ç”¨åå°„ï¼Œå¦‚æœæœ‰åˆ™å°±éœ€è¦ CGLIB å®ä¾‹åŒ–å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; // Don&#x27;t override the class with CGLIB if no overrides. if (!bd.hasMethodOverrides()) &#123; Constructor&lt;?&gt; constructorToUse; synchronized (bd.constructorArgumentLock) &#123; constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod; if (constructorToUse == null) &#123; final Class&lt;?&gt; clazz = bd.getBeanClass(); if (clazz.isInterface()) &#123; throw new BeanInstantiationException(clazz, &quot;Specified class is an interface&quot;); &#125; try &#123; if (System.getSecurityManager() != null) &#123; constructorToUse = AccessController.doPrivileged( (PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor); &#125; else &#123; constructorToUse = clazz.getDeclaredConstructor(); &#125; bd.resolvedConstructorOrFactoryMethod = constructorToUse; &#125; catch (Throwable ex) &#123; throw new BeanInstantiationException(clazz, &quot;No default constructor found&quot;, ex); &#125; &#125; &#125; return BeanUtils.instantiateClass(constructorToUse); &#125; else &#123; // Must generate CGLIB subclass. return instantiateWithMethodInjection(bd, beanName, owner); &#125;&#125;public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, final Constructor&lt;?&gt; ctor, @Nullable Object... args) &#123; if (!bd.hasMethodOverrides()) &#123; if (System.getSecurityManager() != null) &#123; // use own privileged to change accessibility (when security is on) AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; ReflectionUtils.makeAccessible(ctor); return null; &#125;); &#125; return (args != null ? BeanUtils.instantiateClass(ctor, args) : BeanUtils.instantiateClass(ctor)); &#125; else &#123; return instantiateWithMethodInjection(bd, beanName, owner, ctor, args); &#125;&#125; SimpleInstantiationStrategy å¯¹ instantiateWithMethodInjection() çš„å®ç°ä»»åŠ¡äº¤ç»™äº†å­ç±» CglibSubclassingInstantiationStrategyã€‚ MethodOverrideså¯¹äº MethodOverridesï¼Œåœ¨ BeanDefinitionParserDelegate ç±»è§£æ &lt;bean/&gt; çš„æ—¶å€™æ˜¯å¦è¿˜è®°å¾—è¿™ä¸¤ä¸ªæ–¹æ³•ï¼šparseLookupOverrideSubElements() å’Œ parseReplacedMethodSubElements() è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºè§£æ lookup-method å’Œ replaced-methodã€‚parseLookupOverrideSubElements() æºç å¦‚ä¸‹ï¼š æ›´å¤šå…³äº lookup-method å’Œ replaced-method è¯·çœ‹ï¼šIOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method CGLIB å®ä¾‹åŒ–ç­–ç•¥ç±» CglibSubclassingInstantiationStrategy ä¸º Spring å®ä¾‹åŒ– bean çš„é»˜è®¤å®ä¾‹åŒ–ç­–ç•¥ï¼Œå…¶ä¸»è¦åŠŸèƒ½è¿˜æ˜¯å¯¹çˆ¶ç±»åŠŸèƒ½è¿›è¡Œè¡¥å……ï¼šå…¶çˆ¶ç±»å°† CGLIB çš„å®ä¾‹åŒ–ç­–ç•¥å§”æ‰˜å…¶å®ç°ã€‚ // SimpleInstantiationStrategyprotected Object instantiateWithMethodInjection(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; throw new UnsupportedOperationException(&quot;Method Injection not supported in SimpleInstantiationStrategy&quot;);&#125;// CglibSubclassingInstantiationStrategy@Overrideprotected Object instantiateWithMethodInjection(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; return instantiateWithMethodInjection(bd, beanName, owner, null);&#125; CglibSubclassingInstantiationStrategy å®ä¾‹åŒ– bean ç­–ç•¥æ˜¯é€šè¿‡å…¶å†…éƒ¨ç±» CglibSubclassCreator æ¥å®ç°çš„ã€‚ protected Object instantiateWithMethodInjection(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, @Nullable Constructor&lt;?&gt; ctor, @Nullable Object... args) &#123; return new CglibSubclassCreator(bd, owner).instantiate(ctor, args);&#125; åˆ›å»º CglibSubclassCreator å®ä¾‹ç„¶åè°ƒç”¨å…¶ instantiate()ï¼Œè¯¥æ–¹æ³•ç”¨äºåŠ¨æ€åˆ›å»ºå­ç±»å®ä¾‹ï¼ŒåŒæ—¶å®ç°æ‰€éœ€è¦çš„ lookupsï¼ˆlookup-methodã€replace-methodï¼‰ã€‚ public Object instantiate(@Nullable Constructor&lt;?&gt; ctor, @Nullable Object... args) &#123; Class&lt;?&gt; subclass = createEnhancedSubclass(this.beanDefinition); Object instance; if (ctor == null) &#123; instance = BeanUtils.instantiateClass(subclass); &#125; else &#123; try &#123; Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes()); instance = enhancedSubclassConstructor.newInstance(args); &#125; catch (Exception ex) &#123; throw new BeanInstantiationException(this.beanDefinition.getBeanClass(), &quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot; + subclass.getName() + &quot;]&quot;, ex); &#125; &#125; //è¿™ä¸ªåœ°æ–¹è§£å†³ä¸€ä¸ªbugï¼Œbugæäº¤æŠ¥å‘Šhttps://jira.spring.io/browse/SPR-10785 // SPR-10785: set callbacks directly on the instance instead of in the // enhanced class (via the Enhancer) in order to avoid memory leaks. Factory factory = (Factory) instance; factory.setCallbacks(new Callback[] &#123;NoOp.INSTANCE, new LookupOverrideMethodInterceptor(this.beanDefinition, this.owner), new ReplaceOverrideMethodInterceptor(this.beanDefinition, this.owner)&#125;); return instance;&#125; è°ƒç”¨ createEnhancedSubclass() ä¸ºæä¾›çš„ BeanDefinition åˆ›å»º bean ç±»çš„å¢å¼ºå­ç±»ã€‚ private Class&lt;?&gt; createEnhancedSubclass(RootBeanDefinition beanDefinition) &#123; // cglibé‡Œé¢çš„ç”¨æ³•ï¼Œå¯¹åŸå§‹classè¿›è¡Œå¢å¼ºï¼Œå¹¶è®¾ç½®callback Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(beanDefinition.getBeanClass()); enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE); if (this.owner instanceof ConfigurableBeanFactory) &#123; ClassLoader cl = ((ConfigurableBeanFactory) this.owner).getBeanClassLoader(); enhancer.setStrategy(new ClassLoaderAwareGeneratorStrategy(cl)); &#125; // è¿‡æ»¤ï¼Œè‡ªå®šä¹‰é€»è¾‘æ¥æŒ‡å®šè°ƒç”¨çš„callbackä¸‹æ ‡ enhancer.setCallbackFilter(new MethodOverrideCallbackFilter(beanDefinition)); enhancer.setCallbackTypes(CALLBACK_TYPES); return enhancer.createClass();&#125; è·å–å­ç±»å¢å¼º class åï¼Œå¦‚æœ Constructor å®ä¾‹ ctr ä¸ºç©ºï¼Œåˆ™è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼ˆBeanUtils.instantiateClass()ï¼‰æ¥å®ä¾‹åŒ–ç±»ï¼Œå¦åˆ™åˆ™æ ¹æ®æ„é€ å‡½æ•°ç±»å‹è·å–å…·ä½“çš„æ„é€ å™¨ï¼Œè°ƒç”¨ newInstance() å®ä¾‹åŒ–ç±»ã€‚åœ¨ createEnhancedSubclass() æˆ‘ä»¬æ³¨æ„ä¸¤è¡Œä»£ç ï¼š enhancer.setCallbackFilter(new MethodOverrideCallbackFilter(beanDefinition));enhancer.setCallbackTypes(CALLBACK_TYPES); é€šè¿‡ MethodOverrideCallbackFilter æ¥å®šä¹‰è°ƒç”¨ callback ç±»å‹ï¼ŒMethodOverrideCallbackFilter æ˜¯ç”¨æ¥å®šä¹‰ CGLIB å›è°ƒè¿‡æ»¤æ–¹æ³•çš„æ‹¦æˆªå™¨è¡Œä¸ºï¼Œå®ƒç»§æ‰¿ CglibIdentitySupport å®ç° CallbackFilter æ¥å£ï¼Œ CallbackFilter æ˜¯ CGLIB çš„ä¸€ä¸ªå›è°ƒè¿‡æ»¤å™¨ï¼ŒCglibIdentitySupport åˆ™ä¸º CGLIB æä¾› hashCode() å’Œ equals() æ–¹æ³•ï¼Œä»¥ç¡®ä¿ CGLIB ä¸ä¼šä¸ºæ¯ä¸ª bean ç”Ÿæˆä¸åŒçš„ç±»ã€‚MethodOverrideCallbackFilter å®ç° CallbackFilter accept()ï¼š public int accept(Method method) &#123; MethodOverride methodOverride = getBeanDefinition().getMethodOverrides().getOverride(method); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Override for &#x27;&quot; + method.getName() + &quot;&#x27; is [&quot; + methodOverride + &quot;]&quot;); &#125; if (methodOverride == null) &#123; return PASSTHROUGH; &#125; else if (methodOverride instanceof LookupOverride) &#123; return LOOKUP_OVERRIDE; &#125; else if (methodOverride instanceof ReplaceOverride) &#123; return METHOD_REPLACER; &#125; throw new UnsupportedOperationException(&quot;Unexpected MethodOverride subclass: &quot; + methodOverride.getClass().getName());&#125; æ ¹æ® BeanDefinition ä¸­å®šä¹‰çš„ MethodOverride ä¸åŒï¼Œè¿”å›ä¸åŒçš„å€¼ï¼Œ è¿™é‡Œè¿”å›çš„ PASSTHROUGH ã€LOOKUP_OVERRIDEã€METHOD_REPLACER éƒ½æ˜¯ Callbak æ•°ç»„çš„ä¸‹æ ‡ï¼Œè¿™é‡Œå¯¹åº”çš„æ•°ç»„ä¸º CALLBACK_TYPES æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š private static final Class&lt;?&gt;[] CALLBACK_TYPES = new Class&lt;?&gt;[] &#123;NoOp.class, LookupOverrideMethodInterceptor.class, ReplaceOverrideMethodInterceptor.class&#125;; è¿™é‡Œåˆå®šä¹‰äº†ä¸¤ä¸ªç†Ÿæ‚‰çš„æ‹¦æˆªå™¨ ï¼šLookupOverrideMethodInterceptor å’Œ ReplaceOverrideMethodInterceptorï¼Œä¸¤ä¸ªæ‹¦æˆªå™¨åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ callback ä¸šåŠ¡ï¼š LookupOverrideMethodInterceptor private static class LookupOverrideMethodInterceptor extends CglibIdentitySupport implements MethodInterceptor &#123; private final BeanFactory owner; public LookupOverrideMethodInterceptor(RootBeanDefinition beanDefinition, BeanFactory owner) &#123; super(beanDefinition); this.owner = owner; &#125; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy mp) throws Throwable &#123; // Cast is safe, as CallbackFilter filters are used selectively. LookupOverride lo = (LookupOverride) getBeanDefinition().getMethodOverrides().getOverride(method); Assert.state(lo != null, &quot;LookupOverride not found&quot;); Object[] argsToUse = (args.length &gt; 0 ? args : null); // if no-arg, don&#x27;t insist on args at all if (StringUtils.hasText(lo.getBeanName())) &#123; return (argsToUse != null ? this.owner.getBean(lo.getBeanName(), argsToUse) : this.owner.getBean(lo.getBeanName())); &#125; else &#123; return (argsToUse != null ? this.owner.getBean(method.getReturnType(), argsToUse) : this.owner.getBean(method.getReturnType())); &#125; &#125;&#125; ReplaceOverrideMethodInterceptor private static class ReplaceOverrideMethodInterceptor extends CglibIdentitySupport implements MethodInterceptor &#123; private final BeanFactory owner; public ReplaceOverrideMethodInterceptor(RootBeanDefinition beanDefinition, BeanFactory owner) &#123; super(beanDefinition); this.owner = owner; &#125; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy mp) throws Throwable &#123; ReplaceOverride ro = (ReplaceOverride) getBeanDefinition().getMethodOverrides().getOverride(method); Assert.state(ro != null, &quot;ReplaceOverride not found&quot;); // TODO could cache if a singleton for minor performance optimization MethodReplacer mr = this.owner.getBean(ro.getMethodReplacerBeanName(), MethodReplacer.class); return mr.reimplement(obj, method, args); &#125;&#125; é€šè¿‡è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œå†åŠ ä¸Šè¿™ç¯‡åšå®¢ï¼šIOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-methodï¼Œæ˜¯ä¸æ˜¯ä¸€é“ç»ä½³çš„ç¾é£Ÿã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹åˆ†æBeanWrapper","date":"2020-01-24T09:45:53.000Z","path":"2020/01/24/fcc18cc7.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=4020 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨å®ä¾‹åŒ– bean é˜¶æ®µï¼Œæˆ‘ä»¬ä» BeanDefinition å¾—åˆ°çš„å¹¶ä¸æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ Bean å®ä¾‹ï¼Œè€Œæ˜¯ BeanWrapper å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š æ‰€ä»¥è¿™é‡Œ BeanWrapper æ˜¯ä¸€ä¸ªä» BeanDefinition åˆ° Bean ç›´æ¥çš„ä¸­é—´äº§ç‰©ï¼Œæˆ‘ä»¬å¯ä»¥ç§°å®ƒä¸ºâ€ä½çº§ beanâ€œï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨å®é™…é¡¹ç›®ä¸­ç”¨åˆ°å®ƒã€‚ BeanWrapper æ˜¯ Spring æ¡†æ¶ä¸­é‡è¦çš„ç»„ä»¶ç±»ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªä»£ç†ç±»ï¼ŒSpring å§”æ‰˜ BeanWrapper å®Œæˆ Bean å±æ€§çš„å¡«å……å·¥ä½œã€‚ åœ¨ bean å®ä¾‹è¢« InstantiatioonStrategy åˆ›å»ºå‡ºæ¥åï¼ŒSpring å®¹å™¨ä¼šå°† Bean å®ä¾‹é€šè¿‡ BeanWrapper åŒ…è£¹èµ·æ¥ï¼Œæ˜¯é€šè¿‡ BeanWrapper.setWrappedInstance() å®Œæˆçš„ï¼Œå¦‚ä¸‹ï¼š beanInstance å°±æ˜¯æˆ‘ä»¬å®ä¾‹å‡ºæ¥çš„ bean å®ä¾‹ï¼Œé€šè¿‡æ„é€ ä¸€ä¸ª BeanWrapper å®ä¾‹å¯¹è±¡è¿›è¡ŒåŒ…è£¹ï¼Œå¦‚ä¸‹ï¼š public BeanWrapperImpl(Object object) &#123; super(object);&#125;protected AbstractNestablePropertyAccessor(Object object) &#123; registerDefaultEditors(); setWrappedInstance(object);&#125; ä¸‹é¢å°ç¼–å°± BeanWrapper æ¥è¿›è¡Œåˆ†æè¯´æ˜ï¼Œå…ˆçœ‹æ•´ä½“çš„ç»“æ„ï¼š ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º BeanWrapper ä¸»è¦ç»§æ‰¿ä¸‰ä¸ªæ ¸å¿ƒæ¥å£ï¼šPropertyAccessorã€PropertyEditorRegistryã€TypeConverterã€‚ PropertyAccessor å¯ä»¥è®¿é—®å±æ€§çš„é€šç”¨å‹æ¥å£ï¼ˆä¾‹å¦‚å¯¹è±¡çš„ bean å±æ€§æˆ–è€…å¯¹è±¡ä¸­çš„å­—æ®µï¼‰ï¼Œä½œä¸º BeanWrapper çš„åŸºç¡€æ¥å£ã€‚ public interface PropertyAccessor &#123; String NESTED_PROPERTY_SEPARATOR = &quot;.&quot;; char NESTED_PROPERTY_SEPARATOR_CHAR = &#x27;.&#x27;; String PROPERTY_KEY_PREFIX = &quot;[&quot;; char PROPERTY_KEY_PREFIX_CHAR = &#x27;[&#x27;; String PROPERTY_KEY_SUFFIX = &quot;]&quot;; char PROPERTY_KEY_SUFFIX_CHAR = &#x27;]&#x27;; boolean isReadableProperty(String propertyName); boolean isWritableProperty(String propertyName); Class&lt;?&gt; getPropertyType(String propertyName) throws BeansException; TypeDescriptor getPropertyTypeDescriptor(String propertyName) throws BeansException; Object getPropertyValue(String propertyName) throws BeansException; void setPropertyValue(String propertyName, @Nullable Object value) throws BeansException; void setPropertyValue(PropertyValue pv) throws BeansException; void setPropertyValues(Map&lt;?, ?&gt; map) throws BeansException; void setPropertyValues(PropertyValues pvs) throws BeansException; void setPropertyValues(PropertyValues pvs, boolean ignoreUnknown) throws BeansException; void setPropertyValues(PropertyValues pvs, boolean ignoreUnknown, boolean ignoreInvalid) throws BeansException;&#125; å°±ä¸Šé¢çš„æºç æˆ‘ä»¬å¯ä»¥åˆ†è§£ä¸ºå››ç±»æ–¹æ³•ï¼š isReadableProperty()ï¼šåˆ¤æ–­æŒ‡å®š property æ˜¯å¦å¯è¯»ï¼Œæ˜¯å¦åŒ…å« getter æ–¹æ³• isWritableProperty()ï¼šåˆ¤æ–­æŒ‡å®š property æ˜¯å¦å¯å†™,æ˜¯å¦åŒ…å« setter æ–¹æ³• getPropertyType()ï¼šè·å–æŒ‡å®š propertyName çš„ç±»å‹ setPropertyValue()ï¼šè®¾ç½®æŒ‡å®š propertyValue PropertyEditorRegistry ç”¨äºæ³¨å†Œ JavaBean çš„ PropertyEditorsï¼Œå¯¹ PropertyEditorRegistrar èµ·æ ¸å¿ƒä½œç”¨çš„ä¸­å¿ƒæ¥å£ã€‚ç”± BeanWrapper æ‰©å±•ï¼ŒBeanWrapperImpl å’Œ DataBinder å®ç°ã€‚ public interface PropertyEditorRegistry &#123; void registerCustomEditor(Class&lt;?&gt; requiredType, PropertyEditor propertyEditor); void registerCustomEditor(@Nullable Class&lt;?&gt; requiredType, @Nullable String propertyPath, PropertyEditor propertyEditor); @Nullable PropertyEditor findCustomEditor(@Nullable Class&lt;?&gt; requiredType, @Nullable String propertyPath);&#125; æ ¹æ®æ¥å£æä¾›çš„æ–¹æ³•ï¼ŒPropertyEditorRegistry å°±æ˜¯ç”¨äº PropertyEditor çš„æ³¨å†Œå’Œå‘ç°ï¼Œè€Œ PropertyEditor æ˜¯ Java å†…çœé‡Œé¢çš„æ¥å£ï¼Œç”¨äºæ”¹å˜æŒ‡å®š property å±æ€§çš„ç±»å‹ã€‚ TypeConverter å®šä¹‰ç±»å‹è½¬æ¢çš„æ¥å£ï¼Œé€šå¸¸ä¸ PropertyEditorRegistry æ¥å£ä¸€èµ·å®ç°ï¼ˆä½†ä¸æ˜¯å¿…é¡»ï¼‰ï¼Œä½†ç”±äº TypeConverter æ˜¯åŸºäºçº¿ç¨‹ä¸å®‰å…¨çš„ PropertyEditors ï¼Œå› æ­¤ TypeConverters æœ¬èº«ä¹Ÿä¸è¢«è§†ä¸ºçº¿ç¨‹å®‰å…¨ã€‚ è¿™é‡Œå°ç¼–è§£é‡Šä¸‹ï¼Œåœ¨ Spring 3 åï¼Œä¸åœ¨é‡‡ç”¨ PropertyEditors ç±»ä½œä¸º Spring é»˜è®¤çš„ç±»å‹è½¬æ¢æ¥å£ï¼Œè€Œæ˜¯é‡‡ç”¨ ConversionService ä½“ç³»ï¼Œä½† ConversionService æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åœ¨ Spring 3 åï¼Œå¦‚æœä½ æ‰€é€‰æ‹©çš„ç±»å‹è½¬æ¢å™¨æ˜¯ ConversionService è€Œä¸æ˜¯ PropertyEditors é‚£ä¹ˆ TypeConverters åˆ™æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ public interface TypeConverter &#123; &lt;T&gt; T convertIfNecessary(Object value, Class&lt;T&gt; requiredType) throws TypeMismatchException; &lt;T&gt; T convertIfNecessary(Object value, Class&lt;T&gt; requiredType, MethodParameter methodParam) throws TypeMismatchException; &lt;T&gt; T convertIfNecessary(Object value, Class&lt;T&gt; requiredType, Field field) throws TypeMismatchException;&#125; BeanWrapper ç»§æ‰¿ä¸Šè¿°ä¸‰ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå®ƒå°±å…·æœ‰ä¸‰é‡èº«ä»½ï¼š å±æ€§ç¼–è¾‘å™¨ å±æ€§ç¼–è¾‘å™¨æ³¨å†Œè¡¨ ç±»å‹è½¬æ¢å™¨ BeanWrapper ç»§æ‰¿ ConfigurablePropertyAccessor æ¥å£ï¼Œè¯¥æ¥å£é™¤äº†ç»§æ‰¿ä¸Šé¢ä»‹ç»çš„ä¸‰ä¸ªæ¥å£å¤–è¿˜é›†æˆäº† Spring çš„ ConversionService ç±»å‹è½¬æ¢ä½“ç³»ã€‚ public interface ConfigurablePropertyAccessor extends PropertyAccessor, PropertyEditorRegistry, TypeConverter &#123; void setConversionService(@Nullable ConversionService conversionService); @Nullable ConversionService getConversionService(); void setExtractOldValueForEditor(boolean extractOldValueForEditor); boolean isExtractOldValueForEditor(); void setAutoGrowNestedPaths(boolean autoGrowNestedPaths); boolean isAutoGrowNestedPaths();&#125; setConversionService() å’Œ getConversionService() åˆ™æ˜¯ç”¨äºé›†æˆ Spring çš„ ConversionService ç±»å‹è½¬æ¢ä½“ç³»ã€‚ BeanWrapper Spring çš„ ä½çº§ JavaBean åŸºç¡€ç»“æ„çš„æ¥å£ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ BeanFactory æˆ–è€… DataBinder éšå¼ä½¿ç”¨ã€‚å®ƒæä¾›åˆ†æå’Œæ“ä½œæ ‡å‡† JavaBeans çš„æ“ä½œï¼šè·å–å’Œè®¾ç½®å±æ€§å€¼ã€è·å–å±æ€§æè¿°ç¬¦ä»¥åŠæŸ¥è¯¢å±æ€§çš„å¯è¯»æ€§/å¯å†™æ€§çš„èƒ½åŠ›ã€‚ public interface BeanWrapper extends ConfigurablePropertyAccessor &#123; void setAutoGrowCollectionLimit(int autoGrowCollectionLimit); int getAutoGrowCollectionLimit(); Object getWrappedInstance(); Class&lt;?&gt; getWrappedClass(); PropertyDescriptor[] getPropertyDescriptors(); PropertyDescriptor getPropertyDescriptor(String propertyName) throws InvalidPropertyException;&#125; ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ¯”è¾ƒé‡è¦ï¼š ä¸ªå¯¹è±¡æœ‰4ä¸ªæ–¹æ³•æ¯”è¾ƒé‡è¦: getWrappedInstance()ï¼šè·å–åŒ…è£…å¯¹è±¡çš„å®ä¾‹ã€‚ getWrappedClass()ï¼šè·å–åŒ…è£…å¯¹è±¡çš„ç±»å‹ã€‚ getPropertyDescriptors()ï¼šè·å–åŒ…è£…å¯¹è±¡æ‰€æœ‰å±æ€§çš„ PropertyDescriptor å°±æ˜¯è¿™ä¸ªå±æ€§çš„ä¸Šä¸‹æ–‡ã€‚ getPropertyDescriptor()ï¼šè·å–åŒ…è£…å¯¹è±¡æŒ‡å®šå±æ€§çš„ä¸Šä¸‹æ–‡ã€‚ BeanWrapperImpl BeanWrapper æ¥å£çš„é»˜è®¤å®ç°ï¼Œç”¨äºå¯¹Beançš„åŒ…è£…ï¼Œå®ç°ä¸Šé¢æ¥å£æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œè·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨ BeanWrapper ä½“ç³»ç›¸æ¯”äº Spring ä¸­å…¶ä»–ä½“ç³»æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå®ƒä½œä¸º BeanDefinition å‘ Bean è½¬æ¢è¿‡ç¨‹ä¸­çš„ä¸­é—´äº§ç‰©ï¼Œæ‰¿è½½äº† bean å®ä¾‹çš„åŒ…è£…ã€ç±»å‹è½¬æ¢ã€å±æ€§çš„è®¾ç½®ä»¥åŠè®¿é—®ç­‰é‡è¦ä½œç”¨ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨","date":"2020-01-24T06:34:54.000Z","path":"2020/01/24/10825e64.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3985 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨ä¸Šç¯‡æ–‡ç« ä¸­åˆ†æäº† Spring ConversionService ç±»å‹è½¬æ¢ä½“ç³»ï¼Œè¿™ç¯‡åšå®¢å°†åˆ©ç”¨ ConversionService ä½“ç³»æ¥å®ç°è‡ªå·±çš„ç±»å‹è½¬æ¢å™¨ã€‚ ConversionService æ˜¯ Spring ç±»å‹è½¬æ¢å™¨ä½“ç³»ä¸­çš„æ ¸å¿ƒæ¥å£ï¼Œå®ƒå®šä¹‰äº†æ˜¯å¦å¯ä»¥å®Œæˆè½¬æ¢ï¼ˆcanConvert()ï¼‰ ä¸ ç±»å‹è½¬æ¢ï¼ˆconvert()ï¼‰ä¸¤ç±»æ¥å£ã€‚ ConversionService æœ‰ä¸‰ä¸ªå­ç±»ï¼Œæ¯ä¸ªå­ç±»é’ˆå¯¹ä¸åŒçš„ç±»å‹è½¬æ¢ï¼š Converter&lt;S,T&gt;: å°† S ç±»å‹å¯¹è±¡è½¬ä¸º T ç±»å‹å¯¹è±¡ã€‚ GenericConverter: ä¼šæ ¹æ®æºç±»å¯¹è±¡åŠç›®æ ‡ç±»å¯¹è±¡æ‰€åœ¨çš„å®¿ä¸»ç±»ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œç±»å‹è½¬æ¢ã€‚ ConverterFactory: å°†ç›¸åŒç³»åˆ—å¤šä¸ª â€œåŒè´¨â€ Converter å°è£…åœ¨ä¸€èµ·ã€‚ å¦‚æœå¸Œæœ›å°†ä¸€ç§ç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹åŠå…¶å­ç±»çš„å¯¹è±¡(ä¾‹å¦‚å°† String è½¬æ¢ä¸º Number åŠ Number å­ç±»(Integerã€Longã€Double ç­‰)å¯¹è±¡)å¯ä½¿ç”¨è¯¥è½¬æ¢å™¨å·¥å‚ç±»ã€‚ å¦‚ä½•è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ï¼Ÿåˆ†ä¸¤æ­¥èµ°ï¼š å®ç° Converter / GenericConverter / ConverterFactory æ¥å£ å°†è¯¥ç±»æ³¨å†Œåˆ° ConversionServiceFactoryBean ä¸­ã€‚ ConversionServiceFactoryBean å®ç°äº† InitializingBean æ¥å£å®ç° afterPropertiesSet() ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ Bean å®ä¾‹åŒ– bean é˜¶æ®µï¼ŒSpring å®¹å™¨ä¼šæ£€æŸ¥å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ï¼ˆå…³äº InitializingBean è¯¦æƒ…è¯·å‚è€ƒï¼š IOC ä¹‹ æ·±å…¥åˆ†æ InitializingBean å’Œ init-methodï¼‰ã€‚ afterPropertiesSet() æºç å¦‚ä¸‹ï¼š public void afterPropertiesSet() &#123; this.conversionService = createConversionService(); ConversionServiceFactory.registerConverters(this.converters, this.conversionService);&#125; é¦–å…ˆè°ƒç”¨ createConversionService() åˆå§‹åŒ– conversionService ç„¶åè°ƒç”¨ ConversionServiceFactory.registerConverters() å°†å®šä¹‰çš„ converters æ³¨å…¥åˆ°ç±»å‹è½¬æ¢ä½“ç³»ä¸­ã€‚createConversionService() å…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ª DefaultConversionService å®ä¾‹å¯¹è±¡ï¼Œå¯¹äº DefaultConversionService åœ¨ä¸Šç¯‡åšå®¢å·²ç»åˆ†æäº†ï¼Œå¦‚æœ‰ä¸äº†è§£çš„è¯·ç§»æ­¥ä¸Šç¯‡åšæ–‡ã€‚è¿™é‡Œç›´æ¥åˆ†æ ConversionServiceFactory.registerConverters()ï¼Œè¯¥æ–¹æ³•æ˜¯å°†å®šä¹‰çš„ converter æ³¨å†Œåˆ°ç›®æ ‡ ConverterRegistry ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ ConverterRegistry æ˜¯ä¸€ä¸ª Converter æ³¨å†Œå™¨ï¼Œä»–å®šä¹‰äº†ä¸€ç³»åˆ—æ³¨å†Œæ–¹æ³•ã€‚ public static void registerConverters(@Nullable Set&lt;?&gt; converters, ConverterRegistry registry) &#123; if (converters != null) &#123; for (Object converter : converters) &#123; if (converter instanceof GenericConverter) &#123; registry.addConverter((GenericConverter) converter); &#125; else if (converter instanceof Converter&lt;?, ?&gt;) &#123; registry.addConverter((Converter&lt;?, ?&gt;) converter); &#125; else if (converter instanceof ConverterFactory&lt;?, ?&gt;) &#123; registry.addConverterFactory((ConverterFactory&lt;?, ?&gt;) converter); &#125; else &#123; throw new IllegalArgumentException(&quot;Each converter object must implement one of the &quot; + &quot;Converter, ConverterFactory, or GenericConverter interfaces&quot;); &#125; &#125; &#125;&#125; è°ƒç”¨ ConverterRegistry çš„ addConverter() æ–¹æ³•å°†è½¬æ¢å™¨æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬ä½¿ç”¨ Spring å®¹å™¨çš„æ—¶å€™ï¼ŒSpring å°†ä¼šè‡ªåŠ¨è¯†åˆ«å‡º IOC å®¹å™¨ä¸­æ³¨å†Œçš„ ConversionService å¹¶ä¸”åœ¨ bean å±æ€§æ³¨å…¥é˜¶æ®µä½¿ç”¨è‡ªå®šä¹‰çš„è½¬æ¢å™¨å®Œæˆå±æ€§çš„è½¬æ¢äº†ã€‚ å®ä¾‹å®šä¹‰ StudentConversionService è½¬æ¢å™¨ï¼š public class StudentConversionService implements Converter&lt;String,StudentService&gt;&#123; @Override public StudentService convert(String source) &#123; if(StringUtils.hasLength(source))&#123; String[] sources = source.split(&quot;#&quot;); StudentService studentService = new StudentService(); studentService.setAge(Integer.parseInt(sources[0])); studentService.setName(sources[1]); return studentService; &#125; return null; &#125;&#125; é…ç½®ï¼š &lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;&gt; &lt;property name=&quot;converters&quot;&gt; &lt;set&gt; &lt;ref bean=&quot;studentConversionService&quot;/&gt; &lt;/set&gt; &lt;/property&gt; &lt;/bean&gt;&lt;bean id=&quot;studentConversionService&quot; class=&quot;org.springframework.core.conversion.StudentConversionService&quot;/&gt;&lt;bean id=&quot;student&quot; class=&quot;org.springframework.core.conversion.Student&quot;&gt; &lt;property name=&quot;studentService&quot; value=&quot;18#chenssy&quot;/&gt;&lt;/bean&gt;","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æBeançš„ç±»å‹è½¬æ¢ä½“ç³»","date":"2020-01-24T01:38:37.000Z","path":"2020/01/24/683bb448.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3983 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE æˆ‘ä»¬çŸ¥é“ä¸ç®¡ bean å¯¹è±¡é‡Œé¢çš„å±æ€§æ—¶ä»€ä¹ˆç±»å‹ï¼Œä»–ä»¬éƒ½æ˜¯é€šè¿‡ XML ã€Properties æˆ–è€…å…¶ä»–æ–¹å¼æ¥é…ç½®è¿™äº›å±æ€§å¯¹è±¡ç±»å‹çš„ã€‚åœ¨ Spring å®¹å™¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œè¿™äº›å±æ€§éƒ½æ˜¯ä»¥ String ç±»å‹åŠ è½½è¿›å®¹å™¨çš„ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½éœ€è¦å°†è¿™äº› String ç±»å‹çš„å±æ€§è½¬æ¢ Bean å¯¹è±¡å±æ€§æ‰€å¯¹åº”çœŸæ­£çš„ç±»å‹ï¼Œè¦æƒ³å®Œæˆè¿™ç§ç”±å­—ç¬¦ä¸²åˆ°å…·ä½“å¯¹è±¡çš„è½¬æ¢ï¼Œå°±éœ€è¦è¿™ç§è½¬æ¢è§„åˆ™ç›¸å…³çš„ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¿¡æ¯ä»¥åŠè½¬æ¢è¿‡ç¨‹ç”± Spring ç±»å‹è½¬æ¢ä½“ç³»æ¥å®Œæˆã€‚ æˆ‘ä»¬ä¾ç„¶ä»¥ xml ä¸ºä¾‹ï¼Œåœ¨ Spring å®¹å™¨åŠ è½½é˜¶æ®µï¼Œå®¹å™¨å°† xml æ–‡ä»¶ä¸­å®šä¹‰çš„ &lt;bean&gt; è§£æä¸º BeanDefinitionï¼ŒBeanDefinition ä¸­å­˜å‚¨ç€æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª bean éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å±æ€§ï¼Œè¿™äº›å±æ€§æ˜¯ä»¥ String ç±»å‹çš„å­˜å‚¨çš„ã€‚ å½“ç”¨æˆ·è§¦å‘ Bean å®ä¾‹åŒ–é˜¶æ®µæ—¶ï¼ŒSpring å®¹å™¨ä¼šå°†è¿™äº›å±æ€§è½¬æ¢ä¸ºè¿™äº›å±æ€§çœŸæ­£å¯¹åº”çš„ç±»å‹ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ bean å®ä¾‹åŒ–é˜¶æ®µï¼Œå±æ€§çš„æ³¨å…¥æ˜¯åœ¨å®ä¾‹åŒ– bean é˜¶æ®µçš„å±æ€§æ³¨å…¥é˜¶æ®µï¼Œå³ populateBean() æ–¹æ³•ã€‚åœ¨ populateBean() ä¸­ä¼šå°† BeanDefinition ä¸­å®šä¹‰çš„å±æ€§å€¼ç¿»è¯‘ä¸º PropertyValue ç„¶åè°ƒç”¨ applyPropertyValues() è¿›è¡Œå±æ€§åº”ç”¨ã€‚å…¶ä¸­ PropertyValue ç”¨äºä¿å­˜å•ä¸ª bean å±æ€§çš„ä¿¡æ¯å’Œå€¼çš„å¯¹è±¡ã€‚åœ¨ applyPropertyValues() ä¸­ä¼šè°ƒç”¨ convertForProperty() è¿›è¡Œå±æ€§è½¬æ¢ï¼Œå¦‚ä¸‹ï¼š private Object convertForProperty( @Nullable Object value, String propertyName, BeanWrapper bw, TypeConverter converter) &#123; if (converter instanceof BeanWrapperImpl) &#123; return ((BeanWrapperImpl) converter).convertForProperty(value, propertyName); &#125; else &#123; PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName); MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd); return converter.convertIfNecessary(value, pd.getPropertyType(), methodParam); &#125;&#125; è‹¥ TypeConverter ä¸º BeanWrapperImpl ç±»å‹ï¼Œåˆ™ä½¿ç”¨ BeanWrapperImpl æ¥è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™é‡Œä¸»è¦æ˜¯å› ä¸º BeanWrapperImpl å®ç°äº† PropertyEditorRegistry æ¥å£ã€‚å¦åˆ™åˆ™è°ƒç”¨ TypeConverter çš„ convertIfNecessary() è¿›è¡Œç±»å‹è½¬æ¢ã€‚TypeConverter æ˜¯å®šä¹‰ç±»å‹è½¬æ¢æ–¹æ³•çš„æ¥å£ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸ PropertyEditorRegistry é…åˆä½¿ç”¨å®ç°ç±»å‹è½¬æ¢ã€‚ convertIfNecessary() çš„å®ç°è€…æœ‰ä¸¤ä¸ªï¼šDataBinder å’Œ TypeConverterSupport ï¼Œå…¶ä¸­ DataBinder ä¸»è¦ç”¨äºå‚æ•°ç»‘å®šï¼ˆç†Ÿæ‚‰ Spring MVC çš„éƒ½åº”è¯¥çŸ¥é“è¿™ä¸ªç±»ï¼‰ï¼ŒTypeConverterSupport åˆ™æ˜¯ TypeConverter çš„åŸºæœ¬å®ç°ï¼Œä½¿ç”¨çš„æ˜¯ package-private ç­–ç•¥ã€‚ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ TypeConverterSupport çš„ convertIfNecessary()ï¼Œå¦‚ä¸‹ï¼š public &lt;T&gt; T convertIfNecessary(@Nullable Object value, @Nullable Class&lt;T&gt; requiredType, @Nullable MethodParameter methodParam) throws TypeMismatchException &#123; return doConvert(value, requiredType, methodParam, null);&#125;private &lt;T&gt; T doConvert(@Nullable Object value,@Nullable Class&lt;T&gt; requiredType, @Nullable MethodParameter methodParam, @Nullable Field field) throws TypeMismatchException &#123; Assert.state(this.typeConverterDelegate != null, &quot;No TypeConverterDelegate&quot;); try &#123; if (field != null) &#123; return this.typeConverterDelegate.convertIfNecessary(value, requiredType, field); &#125; else &#123; return this.typeConverterDelegate.convertIfNecessary(value, requiredType, methodParam); &#125; &#125; catch (ConverterNotFoundException | IllegalStateException ex) &#123; throw new ConversionNotSupportedException(value, requiredType, ex); &#125; catch (ConversionException | IllegalArgumentException ex) &#123; throw new TypeMismatchException(value, requiredType, ex); &#125;&#125; æˆ‘ä»¬ä¸€ç›´å¾€ä¸‹è·Ÿä¼šè·Ÿè¸ªåˆ° TypeConverterDelegate çš„ convertIfNecessary() ï¼Œä¼šå‘ç°å¦‚ä¸‹ä»£ç æ®µï¼š å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„ç¼–è¾‘å™¨åˆ™ä½¿ç”¨ ConversionService ã€‚ConversionService æ˜¯ Spring è‡ª 3 åæ¨å‡ºæ¥ç”¨æ¥æ›¿ä»£ PropertyEditor è½¬æ¢æ¨¡å¼çš„è½¬æ¢ä½“ç³»ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š public interface ConversionService &#123; boolean canConvert(@Nullable Class&lt;?&gt; sourceType, Class&lt;?&gt; targetType); boolean canConvert(@Nullable TypeDescriptor sourceType, TypeDescriptor targetType); @Nullable &lt;T&gt; T convert(@Nullable Object source, Class&lt;T&gt; targetType); @Nullable Object convert(@Nullable Object source, @Nullable TypeDescriptor sourceType, TypeDescriptor targetType);&#125; å…¶ UML ç±»å›¾å¦‚ä¸‹ï¼š ConfigurableConversionServiceï¼šConversionService çš„é…ç½®æ¥å£ï¼Œç»§æ‰¿ ConversionService å’Œ ConverterRegistry ä¸¤ä¸ªæ¥å£ï¼Œç”¨äºåˆå¹¶ä»–ä»¬ä¸¤è€…çš„æ“ä½œï¼Œä»¥ä¾¿äºé€šè¿‡ add å’Œ remove çš„æ–¹å¼æ·»åŠ å’Œåˆ é™¤è½¬æ¢å™¨ã€‚ GenericConversionServiceï¼šConversionService æ¥å£çš„åŸºç¡€å®ç°ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†æ¡ä»¶ä¸‹çš„è½¬æ¢å·¥ä½œï¼Œé€šè¿‡ ConfigurableConversionService æ¥å£é—´æ¥åœ°å°† ConverterRegistry å®ç°ä¸ºæ³¨å†Œ API ã€‚ DefaultConversionServiceï¼šConversionService æ¥å£çš„é»˜è®¤å®ç°ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†æ¡ä»¶ä¸‹çš„è½¬æ¢å·¥ä½œã€‚ å›å½’åˆ° convertIfNecessary()ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„å±æ€§ç¼–è¾‘å™¨åˆ™è°ƒç”¨ ConversionService æ¥å£çš„ convert()ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š Object convert(@Nullable Object source, @Nullable TypeDescriptor sourceType, TypeDescriptor targetType); sourceï¼šè¦è½¬æ¢çš„æºå¯¹è±¡ï¼Œå¯ä»¥ä¸º null sourceTypeï¼šsource çš„ç±»å‹çš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœ source ä¸º nullï¼Œåˆ™å¯ä»¥ä¸º null targetTypeï¼šsource è¦è½¬æ¢çš„ç±»å‹çš„ä¸Šä¸‹æ–‡ã€‚ convert() å°†ç»™å®šçš„æºå¯¹è±¡ source è½¬æ¢ä¸ºæŒ‡å®šçš„ targetTypeã€‚ TypeDescriptors æä¾›æœ‰å…³å‘ç”Ÿè½¬æ¢çš„æºä½ç½®å’Œç›®æ ‡ä½ç½®çš„é™„åŠ ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸æ˜¯å¯¹è±¡å­—æ®µæˆ–å±æ€§ä½ç½®ã€‚æ–¹æ³•ç”±å­ç±» GenericConversionService å®ç°ï¼š public Object convert(@Nullable Object source, @Nullable TypeDescriptor sourceType, TypeDescriptor targetType) &#123; // åˆ æ‰ if ï¼Œå…¶å®å°±æ˜¯ä¸Šé¢çš„ null åˆ¤æ–­ GenericConverter converter = getConverter(sourceType, targetType); if (converter != null) &#123; Object result = ConversionUtils.invokeConverter(converter, source, sourceType, targetType); return handleResult(sourceType, targetType, result); &#125; return handleConverterNotFound(source, sourceType, targetType);&#125; é¦–å…ˆæ ¹æ® sourceType å’Œ targetType è°ƒç”¨ getConverter() è·å– GenericConverter å¯¹è±¡ converter ï¼Œå¦‚æœ converter ä¸º nullï¼Œåˆ™è°ƒç”¨ handleConverterNotFound()ï¼Œå¦åˆ™è°ƒç”¨ handleResult() æ–¹æ³•ã€‚getConverter() å¦‚ä¸‹ï¼š protected GenericConverter getConverter(TypeDescriptor sourceType, TypeDescriptor targetType) &#123; ConverterCacheKey key = new ConverterCacheKey(sourceType, targetType); GenericConverter converter = this.converterCache.get(key); if (converter != null) &#123; return (converter != NO_MATCH ? converter : null); &#125; converter = this.converters.find(sourceType, targetType); if (converter == null) &#123; converter = getDefaultConverter(sourceType, targetType); &#125; if (converter != null) &#123; this.converterCache.put(key, converter); return converter; &#125; this.converterCache.put(key, NO_MATCH); return null;&#125; è¿™æ®µä»£ç æ„å›¾éå¸¸æ˜ç¡®ï¼Œä» converterCache ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœå­˜åœ¨è¿”å›ï¼Œå¦åˆ™ä» converters ä¸­è·å–ï¼Œç„¶ååŠ å…¥åˆ° converterCache ç¼“å­˜ä¸­ã€‚converterCache å’Œ converters æ˜¯ GenericConversionService ç»´æŠ¤çš„ä¸¤ä¸ªå¾ˆé‡è¦çš„å¯¹è±¡ï¼Œå…¶ä¸­ converterCache ç”¨äºå­˜å‚¨ GenericConverter ï¼Œconverters å¯¹è±¡ä¸º GenericConversionService çš„å†…éƒ¨ç±»ã€‚ private final Converters converters = new Converters();private final Map&lt;ConverterCacheKey, GenericConverter&gt; converterCache = new ConcurrentReferenceHashMap&lt;&gt;(64); Converters ç”¨äºç®¡ç†æ‰€æœ‰æ³¨å†Œçš„è½¬æ¢å™¨ï¼Œå…¶å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª Set å’Œ Map çš„æ•°æ®ç»“æ„ç”¨äºç®¡ç†è½¬æ¢å™¨ï¼Œå¦‚ä¸‹ï¼š private final Set&lt;GenericConverter&gt; globalConverters = new LinkedHashSet&lt;&gt;();private final Map&lt;ConvertiblePair, ConvertersForPair&gt; converters = new LinkedHashMap&lt;&gt;(36); åŒæ—¶æä¾›äº†ç›¸åº”çš„æ–¹æ³•ï¼ˆå¦‚ addã€removeï¼‰æ“ä½œè¿™ä¸¤ä¸ªé›†åˆã€‚åœ¨ getConverter() ä¸­å¦‚æœç¼“å­˜ converterCache ä¸­ ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ Converters å¯¹è±¡çš„ find() æ–¹æ³•è·å–ç›¸åº”çš„ GenericConverterï¼Œå¦‚ä¸‹ï¼š public GenericConverter find(TypeDescriptor sourceType, TypeDescriptor targetType) &#123; // Search the full type hierarchy List&lt;Class&lt;?&gt;&gt; sourceCandidates = getClassHierarchy(sourceType.getType()); List&lt;Class&lt;?&gt;&gt; targetCandidates = getClassHierarchy(targetType.getType()); for (Class&lt;?&gt; sourceCandidate : sourceCandidates) &#123; for (Class&lt;?&gt; targetCandidate : targetCandidates) &#123; ConvertiblePair convertiblePair = new ConvertiblePair(sourceCandidate, targetCandidate); GenericConverter converter = getRegisteredConverter(sourceType, targetType, convertiblePair); if (converter != null) &#123; return converter; &#125; &#125; &#125; return null;&#125;private GenericConverter getRegisteredConverter(TypeDescriptor sourceType, TypeDescriptor targetType, ConvertiblePair convertiblePair) &#123; // Check specifically registered converters ConvertersForPair convertersForPair = this.converters.get(convertiblePair); if (convertersForPair != null) &#123; GenericConverter converter = convertersForPair.getConverter(sourceType, targetType); if (converter != null) &#123; return converter; &#125; &#125; // Check ConditionalConverters for a dynamic match for (GenericConverter globalConverter : this.globalConverters) &#123; if (((ConditionalConverter) globalConverter).matches(sourceType, targetType)) &#123; return globalConverter; &#125; &#125; return null;&#125; åœ¨ find() ä¸­ä¼šæ ¹æ® sourceType å’Œ targetType å»æŸ¥è¯¢ Converters ä¸­ç»´æŠ¤çš„ Map ä¸­æ˜¯å¦åŒ…æ‹¬æ”¯æŒçš„æ³¨å†Œç±»å‹ï¼Œå¦‚æœå­˜åœ¨è¿”å› GenericConverter ï¼Œå¦‚æœæ²¡æœ‰å­˜åœ¨è¿”å› nullã€‚ å½“å¾—åˆ° GenericConverter åï¼Œåˆ™è°ƒç”¨å…¶ convert() è¿›è¡Œç±»å‹è½¬æ¢ã€‚ Object convert(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType); åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ° bean å±æ€§å®šä¹‰çš„çœŸæ­£ç±»å‹äº†ã€‚ GenericConverter æ¥å£ GenericConverter æ˜¯ä¸€ä¸ªè½¬æ¢æ¥å£ï¼Œä¸€ä¸ªç”¨äºåœ¨ä¸¤ç§æˆ–æ›´å¤šç§ç±»å‹ä¹‹é—´è½¬æ¢çš„é€šç”¨å‹è½¬æ¢å™¨æ¥å£ã€‚å®ƒæ˜¯ Converter SPI ä½“ç³»ä¸­æœ€çµæ´»çš„ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„æ¥å£ï¼Œçµæ´»æ€§åœ¨äº GenericConverter å¯ä»¥æ”¯æŒåœ¨å¤šä¸ªæº/ç›®æ ‡ç±»å‹å¯¹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­è®¿é—®æº/ç›®æ ‡å­—æ®µä¸Šä¸‹æ–‡ã€‚ç”±äºè¯¥æ¥å£è¶³å¤Ÿå¤æ‚ï¼Œæ‰€æœ‰å½“æ›´ç®€å•çš„ Converter æˆ– ConverterFactory æ¥å£è¶³å¤Ÿä½¿ç”¨æ—¶ï¼Œé€šå¸¸ä¸åº”ä½¿ç”¨æ­¤æ¥å£ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š public interface GenericConverter &#123; @Nullable Set&lt;ConvertiblePair&gt; getConvertibleTypes(); @Nullable Object convert(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType);&#125; GenericConverter çš„å­ç±»æœ‰è¿™ä¹ˆå¤šï¼ˆçœ‹ç±»åå°±çŸ¥é“æ˜¯å¹²å˜›çš„äº†ï¼‰ï¼š æˆ‘ä»¬çœ‹ä¸€ä¸ªå­ç±»çš„å®ç° StringToArrayConverterï¼Œè¯¥å­ç±»å°†é€—å·åˆ†éš”çš„ String è½¬æ¢ä¸º Arrayã€‚å¦‚ä¸‹ï¼š public Object convert(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType) &#123; if (source == null) &#123; return null; &#125; String string = (String) source; String[] fields = StringUtils.commaDelimitedListToStringArray(string); TypeDescriptor targetElementType = targetType.getElementTypeDescriptor(); Assert.state(targetElementType != null, &quot;No target element type&quot;); Object target = Array.newInstance(targetElementType.getType(), fields.length); for (int i = 0; i &lt; fields.length; i++) &#123; String sourceElement = fields[i]; Object targetElement = this.conversionService.convert(sourceElement.trim(), sourceType, targetElementType); Array.set(target, i, targetElement); &#125; return target;&#125; åœ¨ç±»å‹è½¬æ¢ä½“ç³»ä¸­ï¼ŒSpring æä¾›äº†éå¸¸å¤šçš„ç±»å‹è½¬æ¢å™¨ï¼Œé™¤äº†ä¸Šé¢çš„ GenericConverterï¼Œè¿˜æœ‰ Converterã€ConditionalConverterã€ConverterFactoryã€‚ Converter Converter æ˜¯ä¸€ä¸ªå°† S ç±»å‹çš„æºå¯¹è±¡è½¬æ¢ä¸º T ç±»å‹çš„ç›®æ ‡å¯¹è±¡çš„è½¬æ¢å™¨ã€‚è¯¥æ¥å£æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯ä»¥å…±äº«ã€‚ public interface Converter&lt;S, T&gt; &#123; @Nullable T convert(S source);&#125; å­ç±»å¦‚ä¸‹ï¼š ConditionalConverter ConditionalConverter æ¥å£ç”¨äºè¡¨ç¤ºæœ‰æ¡ä»¶çš„ç±»å‹è½¬æ¢ï¼Œé€šè¿‡è½¬å…¥çš„sourceType ä¸ targetType åˆ¤æ–­è½¬æ¢èƒ½å¦åŒ¹é…ï¼Œåªæœ‰å¯åŒ¹é…çš„è½¬æ¢æ‰ä¼šè°ƒç”¨convert æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œå¦‚ä¸‹ï¼š public interface ConditionalConverter &#123; boolean matches(TypeDescriptor sourceType, TypeDescriptor targetType);&#125; ConditionalConverter çš„å­ç±»å¦‚ä¸‹ï¼š ConverterFactory ä¸€ä¸ªç”¨äºâ€œè¿œç¨‹â€è½¬æ¢çš„è½¬æ¢å·¥å‚ï¼Œå¯ä»¥å°†å¯¹è±¡ä» S è½¬æ¢ä¸º R çš„å­ç±»å‹ã€‚ public interface ConverterFactory&lt;S, R&gt; &#123; &lt;T extends R&gt; Converter&lt;S, T&gt; getConverter(Class&lt;T&gt; targetType);&#125; å­ç±»å¦‚ä¸‹ï¼š å››ç§ä¸åŒçš„è½¬æ¢å™¨æ‰¿è½½ç€ä¸åŒçš„è½¬æ¢è¿‡ç¨‹ï¼š Converterï¼šç”¨äº 1:1 çš„ source -&gt; target ç±»å‹è½¬æ¢ ConverterFactoryï¼šç”¨äº 1:N çš„ source -&gt; target ç±»å‹è½¬æ¢ GenericConverterç”¨äº N:N çš„ source -&gt; target ç±»å‹è½¬æ¢ ConditionalConverterï¼šæœ‰æ¡ä»¶çš„ source -&gt; target ç±»å‹è½¬æ¢ GenericConversionService è½¬æ¢å™¨ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬å†æ¬¡å›å½’åˆ° ConversionService æ¥å£ä¸­å»ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸¤ç±»æ–¹æ³• canConvert() å’Œ convert()ï¼Œå…¶ä¸­ canConvert() ç”¨äºåˆ¤ sourceType èƒ½å¦è½¬æˆ targetType ,è€Œ convert() ç”¨äºå°† source è½¬æˆè½¬å…¥çš„ TargetType ç±»å‹å®ä¾‹ã€‚è¿™ä¸¤ç±»æ–¹æ³•éƒ½æ˜¯åœ¨ GenericConversionService ä¸­å®ç°ã€‚ç±» GenericConversionService å®ç° ConfigurableConversionService æ¥å£ï¼Œè€Œ ConfigurableConversionService æ¥å£ç»§æ‰¿ ConversionService å’Œ ConverterRegistryã€‚ConverterRegistry æä¾›äº†ç±»å‹è½¬æ¢å™¨çš„ç®¡ç†åŠŸèƒ½ï¼Œä»–æä¾›äº†å››ä¸ª add å’Œ ä¸€ä¸ª remove æ–¹æ³•ï¼Œæ”¯æŒæ³¨å†Œ/åˆ é™¤ç›¸åº”çš„ç±»å‹è½¬æ¢å™¨ã€‚GenericConversionService ä½œä¸ºä¸€ä¸ªåŸºç¡€å®ç°ç±»ï¼Œå®ƒå³æ”¯æŒäº†ä¸åŒç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¹Ÿå¯¹å„ç±»å‹è½¬æ¢å™¨è¿›è¡Œç®¡ç†ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ª Map ç±»å‹çš„ converterCache å’Œä¸€ä¸ªå†…éƒ¨ç±» Convertersã€‚åœ¨ä¸Šé¢å·²ç»åˆ†æäº† GenericConversionService æ‰§è¡Œç±»å‹è½¬æ¢çš„è¿‡ç¨‹ cover()ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä¸€ä¸ª addConverter() æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®Œæˆè½¬æ¢å™¨çš„æ³¨å…¥å·¥ä½œçš„ã€‚ public void addConverter(Converter&lt;?, ?&gt; converter) &#123; ResolvableType[] typeInfo = getRequiredTypeInfo(converter.getClass(), Converter.class); if (typeInfo == null &amp;&amp; converter instanceof DecoratingProxy) &#123; typeInfo = getRequiredTypeInfo(((DecoratingProxy) converter).getDecoratedClass(), Converter.class); &#125; if (typeInfo == null) &#123; throw new IllegalArgumentException(&quot;Unable to determine source type &lt;S&gt; and target type &lt;T&gt; for your &quot; + &quot;Converter [&quot; + converter.getClass().getName() + &quot;]; does the class parameterize those types?&quot;); &#125; addConverter(new ConverterAdapter(converter, typeInfo[0], typeInfo[1]));&#125; é¦–å…ˆæ ¹æ® converter è·å– ResolvableTypeï¼Œç„¶åå°†å…¶ä¸ converter å°è£…æˆä¸€ä¸ª ConverterAdapter å®ä¾‹ï¼Œæœ€åè°ƒç”¨ addConverter()ã€‚ResolvableType ç”¨äºå°è£… Java çš„ç±»å‹ã€‚ConverterAdapter åˆ™æ˜¯ Converter çš„ä¸€ä¸ªé€‚é…å™¨ï¼Œ å®ƒå®ç°äº† GenericConverter å’Œ ConditionalConverter ä¸¤ä¸ªç±»å‹è½¬æ¢å™¨ã€‚ addConverter() å¦‚ä¸‹ï¼š public void addConverter(GenericConverter converter) &#123; this.converters.add(converter); invalidateCache();&#125; ç›´æ¥è°ƒç”¨å†…éƒ¨ç±» Converters çš„ add() æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š public void add(GenericConverter converter) &#123; Set&lt;ConvertiblePair&gt; convertibleTypes = converter.getConvertibleTypes(); if (convertibleTypes == null) &#123; Assert.state(converter instanceof ConditionalConverter, &quot;Only conditional converters may return null convertible types&quot;); this.globalConverters.add(converter); &#125; else &#123; for (ConvertiblePair convertiblePair : convertibleTypes) &#123; ConvertersForPair convertersForPair = getMatchableConverters(convertiblePair); convertersForPair.add(converter); &#125; &#125;&#125; é¦–å…ˆè°ƒç”¨ getConvertibleTypes() è·å– ConvertiblePair é›†åˆï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åŠ å…¥åˆ° globalConverters é›†åˆä¸­ï¼Œå¦åˆ™é€šè¿‡è¿­ä»£çš„æ–¹å¼ä¾æ¬¡æ·»åŠ ã€‚ConvertiblePair ä¸º source-to-targer çš„æŒæœ‰è€…ï¼Œå®ƒæŒæœ‰ source å’Œ target çš„ class ç±»å‹ï¼Œå¦‚ä¸‹ï¼š final class ConvertiblePair &#123; private final Class&lt;?&gt; sourceType; private final Class&lt;?&gt; targetType; // å…¶ä»–ä»£ç  &#125; åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¼šæ ¹æ® ConvertiblePair è·å–ç›¸åº”çš„ ConvertersForPair ï¼Œç„¶å converter è½¬æ¢å™¨åŠ å…¥å…¶ä¸­ï¼ŒConvertiblePair ç”¨äºç®¡ç†ä½¿ç”¨ç‰¹å®šGenericConverter.ConvertiblePair æ³¨å†Œçš„è½¬æ¢å™¨ã€‚å¦‚ä¸‹ï¼š private static class ConvertersForPair &#123; private final LinkedList&lt;GenericConverter&gt; converters = new LinkedList&lt;&gt;(); public void add(GenericConverter converter) &#123; this.converters.addFirst(converter); &#125; @Nullable public GenericConverter getConverter(TypeDescriptor sourceType, TypeDescriptor targetType) &#123; for (GenericConverter converter : this.converters) &#123; if (!(converter instanceof ConditionalGenericConverter) || ((ConditionalGenericConverter) converter).matches(sourceType, targetType)) &#123; return converter; &#125; &#125; return null; &#125;&#125; å…¶å®å†…éƒ¨å°±æ˜¯ç»´æŠ¤ä¸€ä¸ª LinkedList é›†åˆã€‚ä»–å†…éƒ¨æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šadd() å’Œ getConverter()ï¼Œå®ç°è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚ DefaultConversionService DefaultConversionService æ˜¯ ConversionService çš„é»˜è®¤å®ç°ï¼Œå®ƒç»§æ‰¿ GenericConversionServiceï¼ŒGenericConversionService ä¸»è¦ç”¨äºè½¬æ¢å™¨çš„æ³¨å†Œå’Œè°ƒç”¨ï¼ŒDefaultConversionService åˆ™æ˜¯ä¸º ConversionService ä½“ç³»æä¾›ä¸€äº›é»˜è®¤çš„è½¬æ¢å™¨ã€‚åœ¨ DefaultConversionService æ„é€ æ–¹æ³•ä¸­å°±ä¼šæ·»åŠ é»˜è®¤çš„ Converter ï¼Œå¦‚ä¸‹ï¼š public DefaultConversionService() &#123; addDefaultConverters(this);&#125;public static void addDefaultConverters(ConverterRegistry converterRegistry) &#123; addScalarConverters(converterRegistry); addCollectionConverters(converterRegistry); converterRegistry.addConverter(new ByteBufferConverter((ConversionService) converterRegistry)); if (jsr310Available) &#123; Jsr310ConverterRegistrar.registerJsr310Converters(converterRegistry); &#125; converterRegistry.addConverter(new ObjectToObjectConverter()); converterRegistry.addConverter(new IdToEntityConverter((ConversionService) converterRegistry)); converterRegistry.addConverter(new FallbackObjectToStringConverter()); if (javaUtilOptionalClassAvailable) &#123; converterRegistry.addConverter(new ObjectToOptionalConverter((ConversionService) converterRegistry)); &#125;&#125; å½“ç„¶å®ƒè¿˜æä¾›äº†ä¸€äº›å…¶ä»–çš„æ–¹æ³•å¦‚ addCollectionConverters()ã€addScalarConverters() ç”¨äºæ³¨å†Œå…¶ä»–ç±»å‹çš„è½¬æ¢å™¨ã€‚ è‡³æ­¤ï¼Œä» bean å±æ€§çš„è½¬æ¢ï¼Œåˆ° Spring ConversionService ä½“ç³»çš„è½¬æ¢å™¨ Converter ä»¥åŠè½¬æ¢å™¨çš„ç®¡ç†éƒ½ä»‹ç»å®Œæ¯•äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æPropertyOverrideConfigurer","date":"2020-01-24T01:26:38.000Z","path":"2020/01/24/e5d90f02.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3924 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨æ–‡ç«  IOC ä¹‹ æ·±å…¥åˆ†æ BeanFactoryPostProcessor ä¸­æåˆ°ï¼ŒBeanFactoryPostProcessor ä½œç”¨ä¸ bean å®ŒæˆåŠ è½½ä¹‹åä¸ bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ˜¯ Spring æä¾›çš„ä¸€ç§å¼ºå¤§çš„æ‰©å±•æœºåˆ¶ï¼Œä»–æœ‰ä¸¤ä¸ªé‡è¦çš„å­ç±»ï¼Œä¸€ä¸ªæ˜¯ PropertyPlaceholderConfigurerï¼Œå¦ä¸€ä¸ªæ˜¯ PropertyOverrideConfigurer ï¼Œå…¶ä¸­ PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬é€šè¿‡é…ç½® Properties çš„æ–¹å¼æ¥å–ä»£ bean ä¸­å®šä¹‰çš„å ä½ç¬¦ï¼Œè€Œ PropertyOverrideConfigurer å‘¢ï¼Ÿæ­£æ˜¯æˆ‘ä»¬è¿™ç¯‡åšå®¢ä»‹ç»çš„ã€‚ PropertyOverrideConfigurer å…è®¸æˆ‘ä»¬å¯¹ Spring å®¹å™¨ä¸­é…ç½®çš„ä»»ä½•æˆ‘ä»¬æƒ³å¤„ç†çš„ bean å®šä¹‰çš„ property ä¿¡æ¯è¿›è¡Œè¦†ç›–æ›¿æ¢ã€‚ è¿™ä¸ªå®šä¹‰å¬èµ·æ¥æœ‰ç‚¹å„¿ç„ä¹ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ PropertyOverrideConfigurer æ¥è¦†ç›–ä»»ä½• bean ä¸­çš„ä»»ä½•å±æ€§ï¼Œåªè¦æˆ‘ä»¬æƒ³ã€‚ PropertyOverrideConfigurer çš„ä½¿ç”¨è§„åˆ™æ˜¯ beanName.propertyName=valueï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ beanNameï¼ŒpropertyName åˆ™æ˜¯è¯¥ bean ä¸­å­˜åœ¨çš„å±æ€§ã€‚ ä½¿ç”¨ä¾ç„¶ä½¿ç”¨ä»¥å‰çš„ä¾‹å­ï¼ŒStudent.classï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸‹é…ç½®æ–‡ä»¶ï¼Œå£°æ˜ä¸‹ PropertyOverrideConfigurer ä»¥åŠå…¶åŠ è½½çš„é…ç½®æ–‡ä»¶ã€‚å¦‚ä¸‹ï¼š &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyOverrideConfigurer&quot;&gt; &lt;property name=&quot;locations&quot;&gt; &lt;list&gt; &lt;value&gt;classpath:application.properties&lt;/value&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;student&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;chenssy&quot;/&gt;&lt;/bean&gt; æŒ‡å®š student çš„ name å±æ€§å€¼ä¸º chenssyï¼Œå£°æ˜ PropertyOverrideConfigurer åŠ è½½çš„æ–‡ä»¶ä¸º application.propertiesï¼Œå†…å®¹å¦‚ä¸‹ï¼š student.name = chenssy-PropertyOverrideConfigurer æŒ‡å®š beanName ä¸º student çš„ bean çš„ name å±æ€§å€¼ä¸º chenssy-PropertyOverrideConfigurerã€‚ æµ‹è¯•æ‰“å° student ä¸­çš„ name å±æ€§å€¼ï¼Œå¦‚ä¸‹ï¼š ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);StudentService studentService = (StudentService) context.getBean(&quot;student&quot;);System.out.println(&quot;student name:&quot; + studentService.getName()); è¿è¡Œç»“æœä¸ºï¼š ä»ä¸­å¯ä»¥çœ‹å‡º PropertyOverrideConfigurer å®šä¹‰çš„æ–‡ä»¶å–ä»£äº† bean ä¸­é»˜è®¤çš„å€¼ã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä¸€ä¸ª bean ä¸­ PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer éƒ½ä½¿ç”¨å‘¢ï¼Ÿé‚£æ˜¯æ˜¾ç¤ºè°å®šä¹‰çš„å€¼å‘¢ï¼Ÿ è¿™é‡Œå…ˆç®€å•åˆ†æä¸‹ï¼šå¦‚æœPropertyOverrideConfigurer å…ˆä½œç”¨ï¼Œé‚£ä¹ˆ PropertyPlaceholderConfigurer åœ¨åŒ¹é…å ä½ç¬¦çš„æ—¶å€™å°±æ‰¾ä¸åˆ°äº†ï¼Œå¦‚æœ PropertyOverrideConfigurer åä½œç”¨ï¼Œä¹Ÿä¼šç›´æ¥å–ä»£ PropertyPlaceholderConfigurer å®šä¹‰çš„å€¼ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½ä¼šæ˜¾ç¤º PropertyOverrideConfigurer å®šä¹‰çš„å€¼ã€‚ æ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿçœ‹å¦‚ä¸‹ä¾‹å­ï¼š xml é…ç½®æ–‡ä»¶è°ƒæ•´å¦‚ä¸‹ï¼š &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyOverrideConfigurer&quot;&gt; &lt;property name=&quot;locations&quot;&gt; &lt;list&gt; &lt;value&gt;classpath:application1.properties&lt;/value&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt;&lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt; &lt;property name=&quot;locations&quot;&gt; &lt;list&gt; &lt;value&gt;classpath:application2.properties&lt;/value&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;student&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;$&#123;studentService.name&#125;&quot;/&gt;&lt;/bean&gt; æŒ‡å®š PropertyPlaceholderConfigurer åŠ è½½æ–‡ä»¶ä¸º application1.propertiesï¼ŒPropertyPlaceholderConfigurer åŠ è½½æ–‡ä»¶ä¸º application2.propertiesï¼Œstudent çš„ name å±æ€§ä½¿ç”¨å ä½ç¬¦ $&#123;studentService.name&#125;ã€‚é…ç½®æ–‡ä»¶å†…å®¹ä¸ºï¼š # application1.propertiesï¼šstudent.name = chenssy-PropertyOverrideConfigurer# application2.propertiesï¼šstudentService.name = chenssy-PropertyPlaceholderConfigurer æµ‹è¯•ç¨‹åºä¾ç„¶æ˜¯æ‰“å° name å±æ€§å€¼ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š æ‰€ä»¥ï¼Œä¸Šé¢çš„åˆ†ææ²¡æœ‰é”™ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æ PropertyOverrideConfigurer å®ç°åŸç†ã€‚å…¶å®å¦‚æœäº†è§£ PropertyPlaceholderConfigurer çš„å®ç°æœºåˆ¶çš„è¯ï¼Œé‚£ä¹ˆ PropertyOverrideConfigurer ä¹Ÿä¸éš¾çŒœæµ‹ï¼šåŠ è½½æŒ‡å®š Propertiesï¼Œè¿­ä»£å…¶ä¸­çš„å±æ€§å€¼ï¼Œä¾æ® â€œ.â€ æ¥å¾—åˆ° beanNameï¼ˆsplit(â€œ.â€)[0]ï¼‰ï¼Œä»å®¹å™¨ä¸­è·å–æŒ‡å®šçš„ BeanDefinitionï¼Œç„¶åå¾—åˆ° name å±æ€§ï¼Œè¿›è¡Œæ›¿æ¢å³å¯ã€‚ å®ç°åŸç†UML ç»“æ„å›¾å¦‚ä¸‹ï¼š ä¸ PropertyPlaceholderConfigurer ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç»§æ‰¿ PropertyResourceConfigurerï¼Œæˆ‘ä»¬çŸ¥é“ PropertyResourceConfigurer å¯¹ BeanFactoryPostProcessor çš„ postProcessBeanFactory() æä¾›äº†å®ç°ï¼Œåœ¨è¯¥å®ç°ä¸­å®ƒä¼šå»è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œç„¶å processProperties() ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°ç”±å­ç±»æ¥å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªéœ€è¦çœ‹ PropertyOverrideConfigurer ä¸­ processProperties() ä¸­çš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹: protected void processProperties(ConfigurableListableBeanFactory beanFactory, Properties props) throws BeansException &#123; // è¿­ä»£é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ for (Enumeration&lt;?&gt; names = props.propertyNames(); names.hasMoreElements();) &#123; String key = (String) names.nextElement(); try &#123; processKey(beanFactory, key, props.getProperty(key)); &#125; catch (BeansException ex) &#123; String msg = &quot;Could not process key &#x27;&quot; + key + &quot;&#x27; in PropertyOverrideConfigurer&quot;; if (!this.ignoreInvalidKeys) &#123; throw new BeanInitializationException(msg, ex); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(msg, ex); &#125; &#125; &#125;&#125; è¿­ä»£ props å†…å®¹ï¼Œä¾æ¬¡è°ƒç”¨ processKey()ï¼Œå¦‚ä¸‹: protected void processKey(ConfigurableListableBeanFactory factory, String key, String value) throws BeansException &#123; // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ &quot;.&quot; // è·å–å…¶ç´¢å¼•ä½ç½® int separatorIndex = key.indexOf(this.beanNameSeparator); // å¦‚æœä¸å­˜åœ¨ï¼Œ. åˆ™æŠ›å‡ºå¼‚å¸¸ if (separatorIndex == -1) &#123; throw new BeanInitializationException(&quot;Invalid key &#x27;&quot; + key + &quot;&#x27;: expected &#x27;beanName&quot; + this.beanNameSeparator + &quot;property&#x27;&quot;); &#125; // å¾—åˆ° beanName String beanName = key.substring(0, separatorIndex); // å¾—åˆ°å±æ€§å€¼ String beanProperty = key.substring(separatorIndex+1); this.beanNames.add(beanName); // æ›¿æ¢ applyPropertyValue(factory, beanName, beanProperty, value); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Property &#x27;&quot; + key + &quot;&#x27; set to value [&quot; + value + &quot;]&quot;); &#125;&#125; è·å–åˆ†å‰²ç¬¦ â€œ.â€ çš„ç´¢å¼•ä½ç½®ï¼Œå¾—åˆ° beanName ä»¥åŠç›¸åº”çš„å±æ€§ï¼Œç„¶åè°ƒç”¨ applyPropertyValue()ï¼Œå¦‚ä¸‹ï¼š protected void applyPropertyValue( ConfigurableListableBeanFactory factory, String beanName, String property, String value) &#123; BeanDefinition bd = factory.getBeanDefinition(beanName); BeanDefinition bdToUse = bd; while (bd != null) &#123; bdToUse = bd; bd = bd.getOriginatingBeanDefinition(); &#125; PropertyValue pv = new PropertyValue(property, value); pv.setOptional(this.ignoreInvalidKeys); bdToUse.getPropertyValues().addPropertyValue(pv);&#125; ä»å®¹å™¨ä¸­è·å– BeanDefinition ï¼Œç„¶åæ ¹æ®å±æ€§ property å’Œ å…¶å€¼ value æ„é€ æˆä¸€ä¸ª PropertyValue å¯¹è±¡ï¼Œæœ€åè°ƒç”¨ addPropertyValue() æ–¹æ³•ã€‚PropertyValue æ˜¯ç”¨äºä¿å­˜ä¸€ç»„beanå±æ€§çš„ä¿¡æ¯å’Œå€¼çš„å¯¹åƒã€‚ public MutablePropertyValues addPropertyValue(PropertyValue pv) &#123; for (int i = 0; i &lt; this.propertyValueList.size(); i++) &#123; PropertyValue currentPv = this.propertyValueList.get(i); if (currentPv.getName().equals(pv.getName())) &#123; pv = mergeIfRequired(pv, currentPv); setPropertyValueAt(pv, i); return this; &#125; &#125; this.propertyValueList.add(pv); return this;&#125; æ·»åŠ  PropertyValue å¯¹è±¡ï¼Œæ›¿æ¢æˆ–è€…åˆå¹¶ç›¸åŒçš„å±æ€§å€¼ã€‚æ•´ä¸ªè¿‡ç¨‹å…¶å®ä¸ä¸Šé¢çŒœæµ‹ç›¸å·®ä¸æ˜¯å¾ˆå¤§ã€‚ è‡³æ­¤ï¼ŒPropertyOverrideConfigurer åˆ°è¿™é‡Œä¹Ÿå°±åˆ†æå®Œæ¯•äº†ã€‚æœ€åçœ‹ä¸‹ PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer æ•´ä½“çš„ç»“æ„å›¾ï¼š","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹PropertyPlaceholderConfigurerçš„åº”ç”¨","date":"2020-01-23T14:28:46.000Z","path":"2020/01/23/cd2eaad8.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3839 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨åšå®¢ IOC ä¹‹ æ·±å…¥åˆ†æ PropertyPlaceholderConfigurer ä¸­äº†è§£äº† PropertyPlaceholderConfigurer å†…éƒ¨å®ç°åŸç†ï¼Œå¥¹å…è®¸æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å ä½ç¬¦å¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºå•ç‹¬é…ç½®åˆ°ç®€å•çš„ properties æ–‡ä»¶ä¸­æ¥åŠ è½½ã€‚ è¿™ä¸ªç‰¹æ€§éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒæˆ‘ä»¬å¯¹ Bean å®ä¾‹å±æ€§çš„é…ç½®å˜å¾—éå¸¸å®¹æ˜“æ§åˆ¶äº†ï¼Œä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ï¼š åŠ¨æ€åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¤šç¯å¢ƒåˆ‡æ¢ å±æ€§åŠ è§£å¯† ä¸‹é¢æˆ‘ä»¬å°±ç¬¬ä¸€ä¸ªåº”ç”¨åœºæ™¯æ¥åšè¯´æ˜ã€‚ åˆ©ç”¨ PropertyPlaceholderConfigurer å®ç°å¤šç¯å¢ƒåˆ‡æ¢ åœ¨æˆ‘ä»¬é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šå­˜åœ¨å¤šä¸ªç¯å¢ƒï¼Œå¦‚ dev ã€test ã€prod ç­‰ç­‰ï¼Œå„ä¸ªç¯å¢ƒçš„é…ç½®éƒ½ä¼šä¸ä¸€æ ·ï¼Œåœ¨ä¼ ç»Ÿçš„å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬éƒ½æ˜¯åœ¨è¿›è¡Œæ‰“åŒ…çš„æ—¶å€™è¿›è¡Œäººå·¥å¹²é¢„ï¼Œæˆ–è€…å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ç³»ç»Ÿå¤–éƒ¨ï¼ŒåŠ è½½çš„æ—¶å€™æŒ‡å®šåŠ è½½ç›®å½•ï¼Œè¿™ç§æ–¹å¼å®¹æ˜“å‡ºé”™ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒå¥½çš„æ–¹å¼æ¥è§£å†³è¿™ç§æƒ…å†µå‘¢ï¼Ÿ æœ‰ï¼Œåˆ©ç”¨ PropertyPlaceholderConfigurer çš„ç‰¹æ€§æ¥åŠ¨æ€åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå®ç°å¤šç¯å¢ƒåˆ‡æ¢ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰å››ä¸ª Properties æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š å†…å®¹å¦‚ä¸‹ï¼š # application-dev.propertiesstudent.name=chenssy-dev# application-test.propertiesstudent.name=chenssy-test# application-prod.propertiesstudent.name=chenssy-prod ç„¶åå®ç°ä¸€ä¸ªç±»ï¼Œè¯¥ç±»ç»§æ‰¿ PropertyPlaceholderConfigurerï¼Œå®ç° loadProperties()ï¼Œæ ¹æ®ç¯å¢ƒçš„ä¸åŒåŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š public class CustomPropertyConfig extends PropertyPlaceholderConfigurer &#123; private Resource[] locations; private PropertiesPersister propertiesPersister = new DefaultPropertiesPersister(); @Override public void setLocations(Resource[] locations) &#123; this.locations = locations; &#125; @Override public void setLocalOverride(boolean localOverride) &#123; this.localOverride = localOverride; &#125; /** * è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œæ ¹æ®å¯åŠ¨å‚æ•°ï¼ŒåŠ¨æ€è¯»å–é…ç½®æ–‡ä»¶ * @param props * @throws IOException */ @Override protected void loadProperties(Properties props) throws IOException &#123; if (locations != null) &#123; // locations é‡Œé¢å°±å·²ç»åŒ…å«äº†é‚£ä¸‰ä¸ªå®šä¹‰çš„æ–‡ä»¶ for (Resource location : this.locations) &#123; InputStream is = null; try &#123; String filename = location.getFilename(); String env = &quot;application-&quot; + System.getProperty(&quot;spring.profiles.active&quot;, &quot;dev&quot;) + &quot;.properties&quot;; // æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶ï¼ŒåŠ è½½ if (filename.contains(env)) &#123; logger.info(&quot;Loading properties file from &quot; + location); is = location.getInputStream(); this.propertiesPersister.load(props, is); &#125; &#125; catch (IOException ex) &#123; logger.info(&quot;è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥.....&quot;); throw ex; &#125; finally &#123; if (is != null) &#123; is.close(); &#125; &#125; &#125; &#125; &#125;&#125; é…ç½®æ–‡ä»¶ï¼š &lt;bean id=&quot;PropertyPlaceholderConfigurer&quot; class=&quot;org.springframework.core.custom.CustomPropertyConfig&quot;&gt; &lt;property name=&quot;locations&quot;&gt; &lt;list&gt; &lt;value&gt;classpath:config/application-dev.properties&lt;/value&gt; &lt;value&gt;classpath:config/application-test.properties&lt;/value&gt; &lt;value&gt;classpath:config/application-prod.properties&lt;/value&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;$&#123;student.name&#125;&quot;/&gt;&lt;/bean&gt; åœ¨ idea çš„ VM options é‡Œé¢å¢åŠ  -Dspring.profiles.active=devï¼Œæ ‡å¿—å½“å‰ç¯å¢ƒä¸º dev ç¯å¢ƒã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);StudentService studentService = (StudentService) context.getBean(&quot;studentService&quot;);System.out.println(&quot;student name:&quot; + studentService.getName()); è¿è¡Œç»“æœï¼š student name:chenssy-dev å½“å°† -Dspring.profiles.active è°ƒæ•´ä¸º testï¼Œåˆ™æ‰“å°ç»“æœåˆ™æ˜¯ chenssy-testï¼Œè¿™æ ·å°±å®Œå…¨å®ç°äº†æ ¹æ®ä¸åŒçš„ç¯å¢ƒåŠ è½½ä¸åŒçš„é…ç½®ï¼Œå¦‚æœå„ä½ç”¨è¿‡ Spring Boot çš„è¯ï¼Œè¿™ä¸ªå°±å®Œå…¨æ˜¯ Spring Boot é‡Œé¢çš„ profiles.active ã€‚ å¯ä»¥çœ‹åˆ°ï¼ŒPropertyPlaceholderConfigurer å¯¹äºå±æ€§çš„é…ç½®éå¸¸çµæ´»ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æPropertyPlaceholderConfigurer","date":"2020-01-23T14:22:02.000Z","path":"2020/01/23/99d35216.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3837 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨ä¸Šæ–‡ IOC ä¹‹ æ·±å…¥åˆ†æ BeanFactoryPostProcessor ä»‹ç»äº† BeanFactoryPostProcessorï¼ŒçŸ¥é“ BeanFactoryPostProcessor ä½œç”¨åŸŸå®¹å™¨å¯åŠ¨é˜¶æ®µï¼Œå¯ä»¥å¯¹è§£æå¥½çš„ BeanDefinition è¿›è¡Œå®šåˆ¶åŒ–å¤„ç†ï¼Œè€Œå…¶ä¸­ PropertyPlaceholderConfigurer æ˜¯å…¶ä¸€ä¸ªéå¸¸é‡è¦çš„åº”ç”¨ï¼Œä¹Ÿæ˜¯å…¶å­ç±»ï¼Œä»‹ç»å¦‚ä¸‹ï¼š PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬ç”¨ Properties æ–‡ä»¶ä¸­çš„å±æ€§æ¥å®šä¹‰åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆé…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£ï¼‰ ä»€ä¹ˆæ„æ€ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ï¼ˆæˆ–è€…å…¶ä»–æ–¹å¼ï¼Œå¦‚æ³¨è§£æ–¹å¼ï¼‰ä¸­ä½¿ç”¨å ä½ç¬¦çš„æ–¹å¼æ¥å®šä¹‰ä¸€äº›èµ„æºï¼Œå¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºé…ç½®åˆ° Properties ä¸­ï¼Œè¿™æ ·åªéœ€è¦å¯¹ Properties æ–‡ä»¶è¿›è¡Œä¿®æ”¹å³å¯ï¼Œè¿™ä¸ªç‰¹æ€§éå¸¸ï¼Œåœ¨åé¢æ¥ä»‹ç»ä¸€ç§æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ç”¨åˆ°åœºæ™¯ã€‚ ä» PropertyPlaceholderConfigurer çš„ç»“æ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå®ƒé—´æ¥å®ç°äº† Aware å’Œ BeanFactoryPostProcessor ä¸¤å¤§æ‰©å±•æ¥å£ï¼Œè¿™é‡Œåªéœ€è¦å…³æ³¨ BeanFactoryPostProcessor å³å¯ã€‚ æˆ‘ä»¬çŸ¥é“ BeanFactoryPostProcessor æä¾›äº† postProcessBeanFactory()ï¼Œåœ¨è¿™ä¸ªä½“ç³»ä¸­è¯¥æ–¹æ³•çš„æ˜¯åœ¨ PropertyResourceConfigurer ä¸­å®ç°ï¼Œè¯¥ç±»ä¸ºå±æ€§èµ„æºçš„é…ç½®ç±»ï¼Œä»–å®ç°äº† BeanFactoryPostProcessor æ¥å£ï¼Œå¦‚ä¸‹ï¼š public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; try &#123; Properties mergedProps = mergeProperties(); // è½¬æ¢åˆå¹¶å±æ€§ convertProperties(mergedProps); // å­ç±»å¤„ç† processProperties(beanFactory, mergedProps); &#125; catch (IOException ex) &#123; throw new BeanInitializationException(&quot;Could not load properties&quot;, ex); &#125;&#125; mergeProperties()ï¼šè¿”å›åˆå¹¶çš„ Properties å®ä¾‹ï¼ŒProperties å®ä¾‹ç»´æŠ¤è¿™ä¸€ç»„ key-value ï¼Œå…¶å®å°±æ˜¯ Properties é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚ convertProperties()ï¼šè½¬æ¢åˆå¹¶çš„å€¼ï¼Œå…¶å®å°±æ˜¯å°†åŸå§‹å€¼æ›¿æ¢ä¸ºçœŸæ­£çš„å€¼ processProperties()ï¼šå‰é¢ä¸¤ä¸ªæ­¥éª¤å·²ç»å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼è¿›è¡Œäº†å¤„ç†ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±æ˜¯çœŸæ­£çš„æ›¿æ¢è¿‡ç¨‹ï¼Œè¯¥æ–¹æ³•ç”±å­ç±»å®ç°ã€‚ åœ¨ PropertyPlaceholderConfigurer é‡å†™ processProperties(): protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess, Properties props) throws BeansException &#123; StringValueResolver valueResolver = new PlaceholderResolvingStringValueResolver(props); doProcessProperties(beanFactoryToProcess, valueResolver);&#125; é¦–å…ˆæ„é€ ä¸€ä¸ª PlaceholderResolvingStringValueResolver ç±»å‹çš„ StringValueResolver å®ä¾‹ã€‚StringValueResolver ä¸ºä¸€ä¸ªè§£æ String ç±»å‹å€¼çš„ç­–ç•¥æ¥å£ï¼Œè¯¥æ¥å£æä¾›äº† resolveStringValue() æ–¹æ³•ç”¨äºè§£æ String å€¼ã€‚PlaceholderResolvingStringValueResolver ä¸ºå…¶ä¸€ä¸ªè§£æç­–ç•¥ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š public PlaceholderResolvingStringValueResolver(Properties props) &#123; this.helper = new PropertyPlaceholderHelper( placeholderPrefix, placeholderSuffix, valueSeparator, ignoreUnresolvablePlaceholders); this.resolver = new PropertyPlaceholderConfigurerResolver(props);&#125; åœ¨æ„é€  String å€¼è§£æå™¨ StringValueResolver æ—¶ï¼Œå°†å·²ç»è§£æçš„ Properties å®ä¾‹å¯¹è±¡å°è£…åœ¨ PlaceholderResolver å®ä¾‹ resolver ä¸­ã€‚PlaceholderResolver æ˜¯ä¸€ä¸ªç”¨äºè§£æå­—ç¬¦ä¸²ä¸­åŒ…å«å ä½ç¬¦çš„æ›¿æ¢å€¼çš„ç­–ç•¥æ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸€ä¸ª resolvePlaceholder() æ–¹æ³•ï¼Œç”¨äºè¿”å›å ä½ç¬¦çš„æ›¿æ¢å€¼ã€‚è¿˜æœ‰ä¸€ä¸ª PropertyPlaceholderHelper å·¥å…·ï¼Œä»åå­—ä¸Šé¢çœ‹åº”è¯¥æ˜¯è¿›è¡Œæ›¿æ¢çš„ã€‚ å¾—åˆ° String è§£æå™¨çš„å®ä¾‹ valueResolver åï¼Œåˆ™ä¼šè°ƒç”¨ doProcessProperties() æ–¹æ³•æ¥è¿›è¡Œè¯Šæ²»çš„æ›¿æ¢æ“ä½œï¼Œè¯¥æ–¹æ³•åœ¨çˆ¶ç±» PlaceholderConfigurerSupport ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š protected void doProcessProperties(ConfigurableListableBeanFactory beanFactoryToProcess, StringValueResolver valueResolver) &#123; BeanDefinitionVisitor visitor = new BeanDefinitionVisitor(valueResolver); String[] beanNames = beanFactoryToProcess.getBeanDefinitionNames(); for (String curName : beanNames) &#123; // æ ¡éªŒ // 1. å½“å‰å®ä¾‹ PlaceholderConfigurerSupport ä¸åœ¨è§£æèŒƒå›´å†… // 2. åŒä¸€ä¸ª Spring å®¹å™¨ if (!(curName.equals(this.beanName) &amp;&amp; beanFactoryToProcess.equals(this.beanFactory))) &#123; BeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName); try &#123; visitor.visitBeanDefinition(bd); &#125; catch (Exception ex) &#123; throw new BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex); &#125; &#125; &#125; // åˆ«åçš„å ä½ç¬¦ beanFactoryToProcess.resolveAliases(valueResolver); // è§£æåµŒå…¥å€¼çš„å ä½ç¬¦ï¼Œä¾‹å¦‚æ³¨é‡Šå±æ€§ beanFactoryToProcess.addEmbeddedValueResolver(valueResolver);&#125; æµç¨‹å¦‚ä¸‹ï¼š æ ¹æ® String å€¼è§£æç­–ç•¥ valueResolver å¾—åˆ° BeanDefinitionVisitor å®ä¾‹ã€‚BeanDefinitionVisitor æ˜¯ BeanDefinition çš„è®¿é—®è€…ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒå¯ä»¥å®ç°å¯¹ BeanDefinition å†…å®¹çš„è¿›è¡Œè®¿é—®ï¼Œå†…å®¹å¾ˆå¤šï¼Œä¾‹å¦‚Scopeã€PropertyValuesã€FactoryMethodName ç­‰ç­‰ã€‚ å¾—åˆ°è¯¥å®¹å™¨çš„æ‰€æœ‰ BeanNameï¼Œç„¶åå¯¹å…¶è¿›è¡Œè®¿é—®ï¼ˆvisitBeanDefinition()ï¼‰ã€‚ è§£æåˆ«åçš„å ä½ç¬¦ è§£æåµŒå…¥å€¼çš„å ä½ç¬¦ï¼Œä¾‹å¦‚æ³¨é‡Šå±æ€§ è¿™ä¸ªæ–¹æ³•æ ¸å¿ƒåœ¨äº visitBeanDefinition() çš„è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š public void visitBeanDefinition(BeanDefinition beanDefinition) &#123; visitParentName(beanDefinition); visitBeanClassName(beanDefinition); visitFactoryBeanName(beanDefinition); visitFactoryMethodName(beanDefinition); visitScope(beanDefinition); if (beanDefinition.hasPropertyValues()) &#123; visitPropertyValues(beanDefinition.getPropertyValues()); &#125; if (beanDefinition.hasConstructorArgumentValues()) &#123; ConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues(); visitIndexedArgumentValues(cas.getIndexedArgumentValues()); visitGenericArgumentValues(cas.getGenericArgumentValues()); &#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•åŸºæœ¬è®¿é—®äº† BeanDefinition ä¸­æ‰€æœ‰å€¼å¾—è®¿é—®çš„ä¸œè¥¿äº†ï¼ŒåŒ…æ‹¬ parent ã€class ã€factory-bean ã€factory-method ã€scope ã€property ã€constructor-arg ï¼Œæœ¬ç¯‡æ–‡ç« çš„ä¸»é¢˜æ˜¯ propertyï¼Œæ‰€ä»¥å…³æ³¨ visitPropertyValues() å³å¯ã€‚å¦‚ä¸‹ï¼š protected void visitPropertyValues(MutablePropertyValues pvs) &#123; PropertyValue[] pvArray = pvs.getPropertyValues(); for (PropertyValue pv : pvArray) &#123; Object newVal = resolveValue(pv.getValue()); if (!ObjectUtils.nullSafeEquals(newVal, pv.getValue())) &#123; pvs.add(pv.getName(), newVal); &#125; &#125;&#125; è¿‡ç¨‹å°±æ˜¯å¯¹å±æ€§æ•°ç»„è¿›è¡Œéå†ï¼Œè°ƒç”¨ resolveValue() å¯¹å±æ€§è¿›è¡Œè§£æè·å–æœ€æ–°å€¼ï¼Œå¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸ç­‰ï¼Œåˆ™ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼ã€‚resolveValue() å®ç°å¦‚ä¸‹ï¼š protected Object resolveValue(@Nullable Object value) &#123; // ç”±äº Properties ä¸­çš„æ˜¯ Stringï¼Œæ‰€ä»¥æŠŠå‰é¢ä¸€å † if å»æ‰ else if (value instanceof String) &#123; return resolveStringValue((String) value); &#125; return value;&#125; ç”±äºé…ç½®çš„æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹ String ç›¸å…³çš„ï¼ŒresolveStringValue() å®ç°å¦‚ä¸‹ï¼š protected String resolveStringValue(String strVal) &#123; if (this.valueResolver == null) &#123; throw new IllegalStateException(&quot;No StringValueResolver specified - pass a resolver &quot; + &quot;object into the constructor or override the &#x27;resolveStringValue&#x27; method&quot;); &#125; String resolvedValue = this.valueResolver.resolveStringValue(strVal); return (strVal.equals(resolvedValue) ? strVal : resolvedValue);&#125; valueResolver æ˜¯æˆ‘ä»¬åœ¨æ„é€  BeanDefinitionVisitor å®ä¾‹æ—¶ä¼ å…¥çš„ String ç±»å‹è§£æå™¨ PlaceholderResolvingStringValueResolverï¼Œè°ƒç”¨å…¶ resolveStringValue() å¦‚ä¸‹ï¼š public String resolveStringValue(String strVal) throws BeansException &#123; String resolved = this.helper.replacePlaceholders(strVal, this.resolver); if (trimValues) &#123; resolved = resolved.trim(); &#125; return (resolved.equals(nullValue) ? null : resolved);&#125; helper ä¸º PropertyPlaceholderHelper å®ä¾‹å¯¹è±¡ï¼Œè€Œ PropertyPlaceholderHelper åˆ™æ˜¯å¤„ç†åº”ç”¨ç¨‹åºä¸­åŒ…å«å ä½ç¬¦çš„å­—ç¬¦ä¸²å·¥å…·ç±»ã€‚åœ¨æ„é€  helper å®ä¾‹å¯¹è±¡æ—¶éœ€è¦ä¼ å…¥äº†å‡ ä¸ªå‚æ•°ï¼šplaceholderPrefixã€placeholderSuffixã€valueSeparatorï¼Œè¿™äº›å€¼åœ¨ PlaceholderConfigurerSupport ä¸­å®šä¹‰å¦‚ä¸‹ï¼š protected String placeholderPrefix = &quot;$&#123;&quot;;protected String placeholderSuffix = &quot;&#125;&quot;;protected String valueSeparator = &quot;:&quot;; è°ƒç”¨ replacePlaceholders() è¿›è¡Œå ä½ç¬¦æ›¿æ¢ï¼Œå¦‚ä¸‹ï¼š public String replacePlaceholders(String value, PlaceholderResolver placeholderResolver) &#123; Assert.notNull(value, &quot;&#x27;value&#x27; must not be null&quot;); return parseStringValue(value, placeholderResolver, new HashSet&lt;&gt;());&#125; è°ƒç”¨ parseStringValue()ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¿™ç¯‡åšå®¢æœ€æ ¸å¿ƒçš„åœ°æ–¹ï¼Œ$&#123;&#125; å ä½ç¬¦çš„æ›¿æ¢ï¼š protected String parseStringValue( String value, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders) &#123; StringBuilder result = new StringBuilder(value); // è·å–å‰ç¼€ &quot;$&#123;&quot; çš„ç´¢å¼•ä½ç½® int startIndex = value.indexOf(this.placeholderPrefix); while (startIndex != -1) &#123; // è·å– åç¼€ &quot;&#125;&quot; çš„ç´¢å¼•ä½ç½® int endIndex = findPlaceholderEndIndex(result, startIndex); if (endIndex != -1) &#123; // æˆªå– &quot;$&#123;&quot; å’Œ &quot;&#125;&quot; ä¸­é—´çš„å†…å®¹ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„å€¼ String placeholder = result.substring(startIndex + this.placeholderPrefix.length(), endIndex); String originalPlaceholder = placeholder; if (!visitedPlaceholders.add(originalPlaceholder)) &#123; throw new IllegalArgumentException( &quot;Circular placeholder reference &#x27;&quot; + originalPlaceholder + &quot;&#x27; in property definitions&quot;); &#125; // è§£æå ä½ç¬¦é”®ä¸­åŒ…å«çš„å ä½ç¬¦ï¼ŒçœŸæ­£çš„å€¼ placeholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders); // ä» Properties ä¸­è·å– placeHolder å¯¹åº”çš„å€¼ propVal String propVal = placeholderResolver.resolvePlaceholder(placeholder); // å¦‚æœä¸å­˜åœ¨ if (propVal == null &amp;&amp; this.valueSeparator != null) &#123; // æŸ¥è¯¢ : çš„ä½ç½® int separatorIndex = placeholder.indexOf(this.valueSeparator); // å¦‚æœå­˜åœ¨ : if (separatorIndex != -1) &#123; // è·å– : å‰é¢éƒ¨åˆ† actualPlaceholder String actualPlaceholder = placeholder.substring(0, separatorIndex); // è·å– : åé¢éƒ¨åˆ† defaultValue String defaultValue = placeholder.substring(separatorIndex + this.valueSeparator.length()); // ä» Properties ä¸­è·å– actualPlaceholder å¯¹åº”çš„å€¼ propVal = placeholderResolver.resolvePlaceholder(actualPlaceholder); // å¦‚æœä¸å­˜åœ¨ åˆ™è¿”å› defaultValue if (propVal == null) &#123; propVal = defaultValue; &#125; &#125; &#125; if (propVal != null) &#123; propVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders); result.replace(startIndex, endIndex + this.placeholderSuffix.length(), propVal); if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Resolved placeholder &#x27;&quot; + placeholder + &quot;&#x27;&quot;); &#125; startIndex = result.indexOf(this.placeholderPrefix, startIndex + propVal.length()); &#125; else if (this.ignoreUnresolvablePlaceholders) &#123; // å¿½ç•¥å€¼ startIndex = result.indexOf(this.placeholderPrefix, endIndex + this.placeholderSuffix.length()); &#125; else &#123; throw new IllegalArgumentException(&quot;Could not resolve placeholder &#x27;&quot; + placeholder + &quot;&#x27;&quot; + &quot; in value \\&quot;&quot; + value + &quot;\\&quot;&quot;); &#125; // visitedPlaceholders.remove(originalPlaceholder); &#125; else &#123; startIndex = -1; &#125; &#125; // è¿”å›propValï¼Œå°±æ˜¯æ›¿æ¢ä¹‹åçš„å€¼ return result.toString();&#125; æµç¨‹å¦‚ä¸‹ è·å–å ä½ç¬¦å‰ç¼€ â€œ${â€œ çš„ç´¢å¼•ä½ç½® startIndex å¦‚æœå‰ç¼€ â€œ${â€œ å­˜åœ¨ï¼Œåˆ™ä» â€œ{â€ åé¢å¼€å§‹è·å–å ä½ç¬¦åç¼€ â€œ}â€ çš„ç´¢å¼•ä½ç½® endIndex å¦‚æœå‰ç¼€ â€œ${â€ å’Œåç¼€ â€œ}â€ éƒ½å­˜åœ¨ï¼Œåˆ™æˆªå–ä¸­é—´éƒ¨åˆ† placeholder ä» Properties ä¸­è·å– placeHolder å¯¹åº”çš„å€¼ propVal å¦‚æœ propVal ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­å ä½ç¬¦ä¸­æ˜¯å¦å­˜åœ¨ â€œ:â€ï¼Œå¦‚æœå­˜åœ¨åˆ™å¯¹å ä½ç¬¦è¿›è¡Œåˆ†å‰²å¤„ç†ï¼Œå…¨é¢éƒ¨åˆ†ä¸º actualPlaceholderï¼Œåé¢éƒ¨åˆ† defaultValueï¼Œå°è¯•ä» Properties ä¸­è·å– actualPlaceholder å¯¹åº”çš„å€¼ propValï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°† defaultValue çš„å€¼èµ‹å€¼ç»™ propVal è¿”å› propValï¼Œä¹Ÿå°±æ˜¯ Properties ä¸­å¯¹åº”çš„å€¼","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æBeanFactoryPostProcessor","date":"2020-01-23T14:12:56.000Z","path":"2020/01/23/81b83a69.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3342 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚ Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨åšå®¢ IOC ä¹‹ æ·±å…¥åˆ†æ BeanPostProcessor æ·±å…¥ä»‹ç»äº† BeanPostProcessor çš„å®ç°æœºåˆ¶ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­æåˆ° BeanPostProcessor æ˜¯ Spring æä¾›ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸æˆ‘ä»¬åœ¨ Bean å®ä¾‹åŒ–ä¹‹ååˆå§‹åŒ–ä¹‹é™…å¯¹ Bean è¿›è¡Œå¢å¼ºå¤„ç†ï¼ˆå‰ã€åç½®å¤„ç†ï¼‰ã€‚ åŒæ ·åœ¨ Spring å®¹å™¨å¯åŠ¨é˜¶æ®µï¼ŒSpring ä¹Ÿæä¾›äº†ä¸€ç§å®¹å™¨æ‰©å±•æœºåˆ¶ï¼šBeanFactoryPostProcessorï¼Œè¯¥æœºåˆ¶ä½œç”¨äºå®¹å™¨å¯åŠ¨é˜¶æ®µï¼Œå…è®¸æˆ‘ä»¬åœ¨å®¹å™¨å®ä¾‹åŒ– Bean ä¹‹å‰å¯¹æ³¨å†Œåˆ°è¯¥å®¹å™¨çš„ BeanDefinition åšå‡ºä¿®æ”¹ã€‚ BeanFactoryPostProcessorBeanFactoryPostProcessor çš„æœºåˆ¶å°±ç›¸å½“äºç»™äº†æˆ‘ä»¬åœ¨ bean å®ä¾‹åŒ–ä¹‹å‰æœ€åä¸€æ¬¡ä¿®æ”¹ BeanDefinition çš„æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºä¼šå¯¹ BeanDefinition æ¥è¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚æ›´æ”¹æŸäº› bean çš„ä¸€äº›å±æ€§ï¼Œç»™æŸäº› Bean å¢åŠ ä¸€äº›å…¶ä»–çš„ä¿¡æ¯ç­‰ç­‰æ“ä½œã€‚ å®šä¹‰å¦‚ä¸‹ public interface BeanFactoryPostProcessor &#123; /** * 1ã€Modify the application context&#x27;s internal bean factory after its standard initialization. * * 2ã€All bean definitions will have been loaded, but no beans will have been instantiated yet. This allows for overriding or adding properties even to eager-initializing beans. * * @param beanFactory the bean factory used by the application context * @throws org.springframework.beans.BeansException in case of errors */ void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException;&#125; BeanFactoryPostProcessor æ¥å£ä»…æœ‰ä¸€ä¸ª postProcessBeanFactory æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ª ConfigurableListableBeanFactory ç±»å‹çš„ beanFactory å‚æ•°ã€‚ä¸Šé¢æœ‰ä¸¤è¡Œæ³¨é‡Šï¼š 1ã€è¡¨ç¤ºäº†è¯¥æ–¹æ³•çš„ä½œç”¨ï¼šåœ¨ standard initializationï¼ˆå®åœ¨æ˜¯ä¸çŸ¥é“è¿™ä¸ªæ€ä¹ˆç¿»è¯‘ï¼šæ ‡å‡†åˆå§‹åŒ–ï¼Ÿï¼‰ ä¹‹åï¼ˆå·²ç»å°±æ˜¯å·²ç»å®Œæˆäº† BeanDefinition çš„åŠ è½½ï¼‰å¯¹ bean factory å®¹å™¨è¿›è¡Œä¿®æ”¹ã€‚å…¶ä¸­å‚æ•° beanFactory åº”è¯¥å°±æ˜¯å·²ç»å®Œæˆäº† standard initialization çš„ BeanFactoryã€‚ 2ã€è¡¨ç¤ºä½œç”¨æ—¶æœºï¼šæ‰€æœ‰çš„ BeanDefinition å·²ç»å®Œæˆäº†åŠ è½½å³åŠ è½½è‡³ BeanFactory ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚ æ‰€ä»¥è¿™é‡Œæ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼š**postProcessBeanFactory() å·¥ä½œäºBeanDefinition åŠ è½½å®Œæˆä¹‹åï¼ŒBean å®ä¾‹åŒ–ä¹‹å‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¯¹åŠ è½½ BeanDefinition è¿›è¡Œä¿®æ”¹ã€‚** æœ‰ä¸€ç‚¹éœ€è¦éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ postProcessBeanFactory() ä¸­åƒä¸‡ä¸èƒ½è¿›è¡Œ Bean çš„å®ä¾‹åŒ–å·¥ä½œï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´ bean è¿‡æ—©å®ä¾‹åŒ–ï¼Œä¼šäº§ç”Ÿä¸¥é‡åæœï¼Œæˆ‘ä»¬å§‹ç»ˆéœ€è¦æ³¨æ„çš„æ˜¯ BeanFactoryPostProcessor æ˜¯ä¸ BeanDefinition æ‰“äº¤é“çš„ï¼Œå¦‚æœæƒ³è¦ä¸ Bean æ‰“äº¤é“ï¼Œè¯·ä½¿ç”¨ BeanPostProcessorã€‚ ä¸ BeanPostProcessor ä¸€æ ·ï¼ŒBeanFactoryPostProcessor åŒæ ·æ”¯æŒæ’åºï¼Œä¸€ä¸ªå®¹å™¨å¯ä»¥åŒæ—¶æ‹¥æœ‰å¤šä¸ª BeanFactoryPostProcessorï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬æ¯”è¾ƒåœ¨ä¹ä»–ä»¬çš„é¡ºåºçš„è¯ï¼Œå¯ä»¥å®ç° Ordered æ¥å£ã€‚ å¦‚æœè¦è‡ªå®šä¹‰ BeanFactoryPostProcessor ç›´æ¥å®ç°è¯¥æ¥å£å³å¯ã€‚ å®ä¾‹public class BeanFactoryPostProcessor_1 implements BeanFactoryPostProcessor,Ordered&#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; System.out.println(&quot;è°ƒç”¨ BeanFactoryPostProcessor_1 ...&quot;); System.out.println(&quot;å®¹å™¨ä¸­æœ‰ BeanDefinition çš„ä¸ªæ•°ï¼š&quot; + beanFactory.getBeanDefinitionCount()); // è·å–æŒ‡å®šçš„ BeanDefinition BeanDefinition bd = beanFactory.getBeanDefinition(&quot;studentService&quot;); MutablePropertyValues pvs = bd.getPropertyValues(); pvs.addPropertyValue(&quot;name&quot;,&quot;chenssy1&quot;); pvs.addPropertyValue(&quot;age&quot;,15); &#125; @Override public int getOrder() &#123; return 1; &#125;&#125;public class BeanFactoryPostProcessor_2 implements BeanFactoryPostProcessor , Ordered&#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; System.out.println(&quot;è°ƒç”¨ BeanFactoryPostProcessor_2 ...&quot;); // è·å–æŒ‡å®šçš„ BeanDefinition BeanDefinition bd = beanFactory.getBeanDefinition(&quot;studentService&quot;); MutablePropertyValues pvs = bd.getPropertyValues(); pvs.addPropertyValue(&quot;age&quot;,18); &#125; @Override public int getOrder() &#123; return 2; &#125;&#125; æä¾›äº†ä¸¤ä¸ªè‡ªå®šä¹‰çš„ BeanFactoryPostProcessor ï¼Œéƒ½ç»§æ‰¿ BeanFactoryPostProcessor å’Œ Orderedï¼Œå…¶ä¸­ BeanFactoryPostProcessor_1 æ”¹å˜ name å’Œ age çš„å€¼ï¼ŒBeanFactoryPostProcessor_2 è¯¥å˜ age çš„å€¼ã€‚Ordered åˆ†åˆ«ä¸º 1 å’Œ 2ã€‚ &lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;chenssy&quot;/&gt; &lt;property name=&quot;age&quot; value=&quot;10&quot;/&gt;&lt;/bean&gt;&lt;bean class=&quot;org.springframework.core.test.BeanFactoryPostProcessor_1&quot;/&gt;&lt;bean class=&quot;org.springframework.core.test.BeanFactoryPostProcessor_2&quot;/&gt; studentService è®¾ç½® name å’Œ age åˆ†åˆ«ä¸º chenss å’Œ 10ã€‚ ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);StudentService studentService = (StudentService) context.getBean(&quot;studentService&quot;);System.out.println(&quot;student name:&quot; + studentService.getName() + &quot;-- age:&quot; + studentService.getAge()); è¿è¡Œç»“æœï¼š è°ƒç”¨ BeanFactoryPostProcessor_1 ...å®¹å™¨ä¸­æœ‰ BeanDefinition çš„ä¸ªæ•°ï¼š3è°ƒç”¨ BeanFactoryPostProcessor_2 ...student name:chenssy1-- age:18 çœ‹åˆ°è¿è¡Œç»“æœï¼Œå…¶å®å¯¹ä¸Šé¢çš„è¿è¡Œæµç¨‹å°±å·²ç»ä¸€æ¸…äºŒæ¥šäº†ã€‚è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ã€‚ åœ¨ä¸Šé¢æµ‹è¯•æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ ApplicationContext ï¼Œå¯¹äº ApplicationContext æ¥è¯´ï¼Œä½¿ç”¨ BeanFactoryPostProcessor éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºä»–ä¼šè‡ªåŠ¨è¯†åˆ«é…ç½®æ–‡ä»¶ä¸­çš„ BeanFactoryPostProcessor å¹¶ä¸”å®Œæˆæ³¨å†Œå’Œè°ƒç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•çš„é…ç½®å£°æ˜å³å¯ã€‚ è€Œå¯¹äº BeanFactory å®¹å™¨æ¥è¯´åˆ™ä¸è¡Œï¼Œä»–å’Œ BeanPostProcessor ä¸€æ ·éœ€è¦å®¹å™¨ä¸»åŠ¨å»è¿›è¡Œæ³¨å†Œè°ƒç”¨ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š BeanFactoryPostProcessor_1 beanFactoryPostProcessor1 = new BeanFactoryPostProcessor_1();beanFactoryPostProcessor1.postProcessBeanFactory(factory); è‡³äº ApplicationContext æ˜¯å¦‚ä½•è‡ªåŠ¨è¯†åˆ«å’Œè°ƒç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­åœ¨åˆ†æ ApplicationContext æ—¶ä¼šåšè¯¦ç»†è¯´æ˜çš„ï¼Œå½“ç„¶ï¼Œå¦‚æœæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æå‰çœ‹ã€‚ è¯šç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯ä¸ä¼šä¸»åŠ¨å»è‡ªå®šä¹‰ BeanFactoryPostProcessor ï¼Œå…¶å® Spring ä¸ºæˆ‘ä»¬æä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„ BeanFactoryPostProcessorï¼Œä»–ä»¬æ˜¯PropertyPlaceholderConfigurer å’Œ PropertyOverrideConfigurer ï¼Œå…¶ä¸­ PropertyPlaceholderConfigurer å…è®¸æˆ‘ä»¬åœ¨ XML é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å ä½ç¬¦å¹¶å°†è¿™äº›å ä½ç¬¦æ‰€ä»£è¡¨çš„èµ„æºå•ç‹¬é…ç½®åˆ°ç®€å•çš„ properties æ–‡ä»¶ä¸­æ¥åŠ è½½ï¼ŒPropertyOverrideConfigurer åˆ™å…è®¸æˆ‘ä»¬ä½¿ç”¨å ä½ç¬¦æ¥æ˜ç¡®è¡¨æ˜bean å®šä¹‰ä¸­çš„ property ä¸ properties æ–‡ä»¶ä¸­çš„å„é…ç½®é¡¹ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œè¿™ä¸¤ä¸ªç±»åœ¨æˆ‘ä»¬å¤§å‹é¡¹ç›®ä¸­æœ‰éå¸¸é‡è¦çš„ä½œç”¨ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æInitializingBeanå’Œinit-method","date":"2020-01-23T13:57:33.000Z","path":"2020/01/23/3af7524a.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3340 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE Spring åœ¨ bean åˆå§‹åŒ–æ—¶è¿›è¡Œä¸‰ä¸ªæ£€æµ‹æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å¯¹ bean è¿›è¡Œä¸‰ä¸ªä¸åŒçš„å®šåˆ¶åŒ–å¤„ç†ï¼Œå‰é¢ä¸¤ç¯‡åšå®¢ IOC ä¹‹ æ·±å…¥åˆ†æ Aware æ¥å£ å’Œ IOC ä¹‹ æ·±å…¥åˆ†æ BeanPostProcessor å·²ç»åˆ†æäº† Aware æ¥å£æ— å’Œ BeanPostProcessor æ¥å£ï¼Œè¿™ç¯‡åˆ†æ InitializingBean æ¥å£å’Œ init-method æ–¹æ³•ã€‚ InitializingBeanSpring çš„ InitializingBean æ¥å£ä¸º bean æä¾›äº†å®šä¹‰åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒä»…åŒ…å«äº†ä¸€ä¸ªæ–¹æ³•ï¼šafterPropertiesSet()ã€‚ public interface InitializingBean &#123; /** * è¯¥æ–¹æ³•åœ¨ BeanFactory è®¾ç½®å®Œäº†æ‰€æœ‰å±æ€§ä¹‹åè¢«è°ƒç”¨ * è¯¥æ–¹æ³•å…è®¸ bean å®ä¾‹è®¾ç½®äº†æ‰€æœ‰ bean å±æ€§æ—¶æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå¦‚æœè¯¥è¿‡ç¨‹å‡ºç°äº†é”™è¯¯åˆ™éœ€è¦æŠ›å‡ºå¼‚å¸¸ */ void afterPropertiesSet() throws Exception;&#125; Spring åœ¨å®Œæˆå®ä¾‹åŒ–åï¼Œè®¾ç½®å®Œæ‰€æœ‰å±æ€§ï¼Œè¿›è¡Œ â€œAware æ¥å£â€ å’Œ â€œBeanPostProcessor å‰ç½®å¤„ç†â€ä¹‹åï¼Œä¼šæ¥ç€æ£€æµ‹å½“å‰ bean å¯¹è±¡æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè°ƒç”¨å…¶ afterPropertiesSet() è¿›ä¸€æ­¥è°ƒæ•´ bean å®ä¾‹å¯¹è±¡çš„çŠ¶æ€ã€‚ public class InitializingBeanTest implements InitializingBean &#123; private String name; @Override public void afterPropertiesSet() throws Exception &#123; System.out.println(&quot;InitializingBeanTest initializing...&quot;); this.name = &quot;chenssy 2 å·&quot;; &#125; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125;&#125;// é…ç½®é¡¹&lt;bean id=&quot;initializingBeanTest&quot; class=&quot;org.springframework.core.test.InitializingBeanTest&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;chenssy 1 å·&quot;/&gt;&lt;/bean&gt;// æµ‹è¯•ä»£ç InitializingBeanTest test = (InitializingBeanTest) factory.getBean(&quot;initializingBeanTest&quot;);System.out.println(&quot;name ï¼š&quot; + test.getName()); æ‰§è¡Œç»“æœï¼š åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­æ”¹å˜äº† InitializingBeanTest ç¤ºä¾‹çš„ name å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ åœ¨ afterPropertiesSet() ä¸­æˆ‘ä»¬æ˜¯å¯ä»¥æ”¹å˜ bean çš„å±æ€§çš„ï¼Œè¿™ç›¸å½“äº Spring å®¹å™¨åˆç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§å¯ä»¥æ”¹å˜ bean å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ã€‚ ä¸Šé¢æåˆ° bean åˆå§‹åŒ–é˜¶æ®µï¼ˆinitializeBean() ï¼‰ Spring å®¹å™¨ä¼šä¸»åŠ¨æ£€æŸ¥å½“å‰ bean æ˜¯å¦å·²ç»å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™ä¼šè°ƒç”¨å…¶ afterPropertiesSet() ,è¿™ä¸ªä¸»åŠ¨æ£€æŸ¥ã€è°ƒç”¨çš„åŠ¨ä½œæ˜¯ç”± invokeInitMethods() æ¥å®Œæˆçš„ã€‚ protected void invokeInitMethods( String beanName, final Object bean, @Nullable RootBeanDefinition mbd) throws Throwable &#123; // æ˜¯å¦å®ç° InitializingBean // å¦‚æœå®ç°äº† InitializingBean æ¥å£ï¼Œåˆ™åªæ‰è°ƒç”¨beançš„ afterPropertiesSet() boolean isInitializingBean = (bean instanceof InitializingBean); if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; if (System.getSecurityManager() != null) &#123; try &#123; AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123; ((InitializingBean) bean).afterPropertiesSet(); return null; &#125;, getAccessControlContext()); &#125; catch (PrivilegedActionException pae) &#123; throw pae.getException(); &#125; &#125; else &#123; // ç›´æ¥è°ƒç”¨ afterPropertiesSet() ((InitializingBean) bean).afterPropertiesSet(); &#125; &#125; if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123; // åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº† init-method()ï¼Œ // å¦‚æœæŒ‡å®šäº† init-method()ï¼Œåˆ™å†è°ƒç”¨åˆ¶å®šçš„init-method String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) &amp;&amp; !(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123; // åˆ©ç”¨åå°„æœºåˆ¶æ‰§è¡Œ invokeCustomInitMethod(beanName, bean, mbd); &#125; &#125;&#125; é¦–å…ˆæ£€æµ‹å½“å‰ bean æ˜¯å¦å®ç°äº† InitializingBean æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™è°ƒç”¨å…¶ afterPropertiesSet()ï¼Œç„¶åå†æ£€æŸ¥æ˜¯å¦ä¹ŸæŒ‡å®šäº† init-method()ï¼Œå¦‚æœæŒ‡å®šäº†åˆ™é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨æŒ‡å®šçš„ init-method()ã€‚ è™½ç„¶è¯¥æ¥å£ä¸º Spring å®¹å™¨çš„æ‰©å±•æ€§ç«‹ä¸‹äº†æ±—é©¬åŠŸåŠ³ï¼Œä½†æ˜¯å¦‚æœçœŸçš„è®©æˆ‘ä»¬çš„ä¸šåŠ¡å¯¹è±¡æ¥å®ç°è¿™ä¸ªæ¥å£å°±æ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆçš„å‹å¥½äº†ï¼ŒSpring çš„ä¸€ä¸ªæ ¸å¿ƒç†å¿µå°±æ˜¯æ— ä¾µå…¥æ€§ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸šåŠ¡ç±»å®ç°è¿™ä¸ªæ¥å£å°±æ˜¾å¾— Spring å®¹å™¨å…·æœ‰ä¾µå…¥æ€§äº†ã€‚ æ‰€ä»¥ Spring è¿˜æä¾›äº†å¦å¤–ä¸€ç§å®ç°çš„æ–¹å¼ï¼šinit-method æ–¹æ³• init-method()åœ¨åˆ†æåˆ†æ &lt;bean&gt; æ ‡ç­¾è§£æè¿‡ç¨‹ä¸­æˆ‘ä»¬æåˆ°äº†æœ‰å…³äº init-method å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºåœ¨ bean åˆå§‹åŒ–æ—¶æŒ‡å®šæ‰§è¡Œæ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥æ›¿ä»£å®ç° InitializingBean æ¥å£ã€‚ public class InitializingBeanTest &#123; private String name; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public void setOtherName()&#123; System.out.println(&quot;InitializingBeanTest setOtherName...&quot;); this.name = &quot;chenssy 3 å·&quot;; &#125;&#125; é…ç½®æ–‡ä»¶ï¼š &lt;bean id=&quot;initializingBeanTest&quot; class=&quot;org.springframework.core.test.InitializingBeanTest&quot; init-method=&quot;setOtherName&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;chenssy 1 å·&quot;/&gt;&lt;/bean&gt; æ‰§è¡Œç»“æœ: å®Œå…¨å¯ä»¥è¾¾åˆ°å’Œ InitializingBean ä¸€æ ·çš„æ•ˆæœï¼Œè€Œä¸”åœ¨ä»£ç ä¸­æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°ä¸æ¯« Spring ä¾µå…¥çš„ç°è±¡ã€‚ æ‰€ä»¥é€šè¿‡ init-method æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸šåŠ¡å¯¹è±¡ä¸­å®šä¹‰çš„ä»»ä½•æ–¹æ³•æ¥å®ç° bean å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–å®šåˆ¶åŒ–ï¼Œè€Œä¸å†å—åˆ¶äº InitializingBeançš„ afterPropertiesSet()ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;beans&gt; æ ‡ç­¾çš„ default-init-method å±æ€§æ¥ç»Ÿä¸€æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™æ ·å°±çœäº†éœ€è¦åœ¨æ¯ä¸ª &lt;bean&gt; æ ‡ç­¾ä¸­éƒ½è®¾ç½® init-method è¿™æ ·çš„ç¹çå·¥ä½œäº†ã€‚ æ¯”å¦‚åœ¨ default-init-method è§„å®šæ‰€æœ‰åˆå§‹åŒ–æ“ä½œå…¨éƒ¨ä»¥ initBean() å‘½åã€‚å¦‚ä¸‹ï¼š ä» invokeInitMethods() ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ init-method æŒ‡å®šçš„æ–¹æ³•ä¼šåœ¨ afterPropertiesSet() ä¹‹åæ‰§è¡Œï¼Œå¦‚æœ afterPropertiesSet() ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™ init-method æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œè€Œä¸”ç”±äº init-method é‡‡ç”¨çš„æ˜¯åå°„æ‰§è¡Œçš„æ–¹å¼ï¼Œæ‰€ä»¥ afterPropertiesSet() çš„æ‰§è¡Œæ•ˆç‡ä¸€èˆ¬ä¼šé«˜äº›ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ’é™¤æˆ‘ä»¬è¦ä¼˜å…ˆä½¿ç”¨ init-methodï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæ¶ˆé™¤äº† bean å¯¹ Spring çš„ä¾èµ–ï¼ŒSpring æ²¡æœ‰ä¾µå…¥åˆ°æˆ‘ä»¬ä¸šåŠ¡ä»£ç ï¼Œè¿™æ ·ä¼šæ›´åŠ ç¬¦åˆ Spring çš„ç†å¿µã€‚ è¯šç„¶ï¼Œinit-method æ˜¯åŸºäº xml é…ç½®æ–‡ä»¶çš„ï¼Œå°±ç›®å‰è€Œè¨€ï¼Œæˆ‘ä»¬çš„å·¥ç¨‹å‡ ä¹éƒ½æ‘’å¼ƒäº†é…ç½®ï¼Œè€Œé‡‡ç”¨æ³¨é‡Šçš„æ–¹å¼ï¼Œé‚£ä¹ˆ @PreDestory å¯èƒ½é€‚åˆä½ ï¼Œå½“ç„¶è¿™ä¸ªæ³¨è§£æˆ‘ä»¬åé¢åˆ†æã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æBeanPostProcessor","date":"2020-01-22T01:36:11.000Z","path":"2020/01/22/aa8c9efa.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3338 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE Spring ä½œä¸ºä¼˜ç§€çš„å¼€æºæ¡†æ¶ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸°å¯Œçš„å¯æ‰©å±•ç‚¹ï¼Œé™¤äº†å‰é¢æåˆ°çš„ Aware æ¥å£ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„å°±æ˜¯ BeanPostProcessorã€‚ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» BeanPostProcessor çš„ä½¿ç”¨ä»¥åŠå…¶å®ç°åŸç†ã€‚æˆ‘ä»¬å…ˆçœ‹ BeanPostProcessor çš„å®šä½ï¼š BeanPostProcessor çš„ä½œç”¨ï¼šåœ¨ Bean å®Œæˆå®ä¾‹åŒ–åï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œä¸€äº›é…ç½®ã€å¢åŠ ä¸€äº›è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ BeanPostProcessorã€‚ BeanPostProcessor å®ä¾‹é¦–å…ˆå®šä¹‰ä¸€ä¸ªç±»ï¼Œè¯¥ç±»å®ç° BeanPostProcessor æ¥å£ï¼Œå¦‚ä¸‹ï¼š public class BeanPostProcessorTest implements BeanPostProcessor&#123; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;Bean [&quot; + beanName + &quot;] å¼€å§‹åˆå§‹åŒ–&quot;); // è¿™é‡Œä¸€å®šè¦è¿”å› beanï¼Œä¸èƒ½è¿”å› null return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; System.out.println(&quot;Bean [&quot; + beanName + &quot;] å®Œæˆåˆå§‹åŒ–&quot;); return bean; &#125; public void display()&#123; System.out.println(&quot;hello BeanPostProcessor!!!&quot;); &#125;&#125; æµ‹è¯•æ–¹æ³•å¦‚ä¸‹ï¼š ClassPathResource resource = new ClassPathResource(&quot;spring.xml&quot;);DefaultListableBeanFactory factory = new DefaultListableBeanFactory();XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);reader.loadBeanDefinitions(resource);BeanPostProcessorTest test = (BeanPostProcessorTest) factory.getBean(&quot;beanPostProcessorTest&quot;);test.display(); è¿è¡Œç»“æœï¼š è¿è¡Œç»“æœæ¯”è¾ƒå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡Œ postProcessBeforeInitialization() å’Œ postProcessAfterInitialization() å‘¢ï¼Ÿ æˆ‘ä»¬ debug è·Ÿè¸ªä¸‹ä»£ç ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ initializeBean() æ–¹æ³•å¤„è°ƒç”¨ä¸‹ï¼Œå¦‚ä¸‹ï¼š debugï¼Œåœ¨ postProcessBeforeInitialization()æ–¹æ³•ä¸­ç»“æœå¦‚ä¸‹ï¼š è¿™æ®µä»£ç æ˜¯é€šè¿‡è¿­ä»£ getBeanPostProcessors() è¿”å›çš„ç»“æœé›†æ¥è°ƒç”¨ postProcessBeforeInitialization()ï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°è¯¥æ–¹æ³•è¿”å›çš„ç»“æœé›†ä¸ºç©ºï¼Œæ‰€ä»¥è‚¯å®šä¸ä¼šæ‰§è¡Œç›¸åº”çš„ postProcessBeforeInitialization() æ–¹æ³•å’¯ã€‚æ€ä¹ˆåŠï¼Ÿ ç­”æ¡ˆä¸è¨€è€Œå–»ï¼šåªéœ€è¦ getBeanPostProcessors() è¿”å›çš„ç»“æœé›†ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªå…ƒç´ å³å¯ï¼Œè¯¥æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š public List&lt;BeanPostProcessor&gt; getBeanPostProcessors() &#123; return this.beanPostProcessors;&#125; è¿”å›çš„ beanPostProcessors æ˜¯ä¸€ä¸ª private çš„ List ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦è¯¥ç±»ä¸­å­˜åœ¨ beanPostProcessors.add() çš„è°ƒç”¨æˆ‘ä»¬å°±æ‰¾åˆ°äº†å…¥å£ï¼Œåœ¨ç±» AbstractBeanFactory ä¸­æ‰¾åˆ°äº†å¦‚ä¸‹ä»£ç ï¼š @Overridepublic void addBeanPostProcessor(BeanPostProcessor beanPostProcessor) &#123; Assert.notNull(beanPostProcessor, &quot;BeanPostProcessor must not be null&quot;); this.beanPostProcessors.remove(beanPostProcessor); this.beanPostProcessors.add(beanPostProcessor); if (beanPostProcessor instanceof InstantiationAwareBeanPostProcessor) &#123; this.hasInstantiationAwareBeanPostProcessors = true; &#125; if (beanPostProcessor instanceof DestructionAwareBeanPostProcessor) &#123; this.hasDestructionAwareBeanPostProcessors = true; &#125;&#125; è¯¥æ–¹æ³•æ˜¯ç”± AbstractBeanFactory çš„çˆ¶ç±» ConfigurableBeanFactory å®šä¹‰ï¼Œå®ƒçš„æ ¸å¿ƒæ„æ€å°±æ˜¯å°†æŒ‡å®š BeanPostProcessor æ³¨å†Œåˆ°è¯¥ BeanFactory åˆ›å»ºçš„ bean ä¸­ï¼ŒåŒæ—¶å®ƒæ˜¯æŒ‰ç…§æ’å…¥çš„é¡ºåºè¿›è¡Œæ³¨å†Œçš„ï¼Œå®Œå…¨å¿½ç•¥ Ordered æ¥å£æ‰€è¡¨è¾¾ä»»ä½•æ’åºè¯­ä¹‰ï¼ˆåœ¨ BeanPostProcessor ä¸­æˆ‘ä»¬æä¾›ä¸€ä¸ª Ordered é¡ºåºï¼Œè¿™ä¸ªåé¢è®²è§£ï¼‰ã€‚ åˆ°è¿™é‡Œåº”è¯¥å°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå…¶å®åªéœ€è¦æ˜¾ç¤ºè°ƒç”¨ addBeanPostProcessor() å°±å¯ä»¥äº†ï¼ŒåŠ å…¥å¦‚ä¸‹ä»£ç ã€‚ BeanPostProcessorTest beanPostProcessorTest = new BeanPostProcessorTest();factory.addBeanPostProcessor(beanPostProcessorTest); è¿è¡Œç»“æœï¼š å…¶å®è¿˜æœ‰ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢å†è¯´ï¼Œå…ˆçœ‹ BeanPostProcessor çš„åŸç†ã€‚ BeanPostProcessor åŸºæœ¬åŸç†BeanPostProcessor æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š public interface BeanPostProcessor &#123; @Nullable default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125; @Nullable default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125;&#125; BeanPostProcessor å¯ä»¥ç†è§£ä¸ºæ˜¯ Spring çš„ä¸€ä¸ªå·¥å‚é’©å­ï¼ˆå…¶å® Spring æä¾›ä¸€ç³»åˆ—çš„é’©å­ï¼Œå¦‚ Aware ã€InitializingBeanã€DisposableBeanï¼‰ï¼Œå®ƒæ˜¯ Spring æä¾›çš„å¯¹è±¡å®ä¾‹åŒ–é˜¶æ®µå¼ºæœ‰åŠ›çš„æ‰©å±•ç‚¹ï¼Œå…è®¸ Spring åœ¨å®ä¾‹åŒ– bean é˜¶æ®µå¯¹å…¶è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œæ¯”è¾ƒå¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯å¤„ç†æ ‡è®°æ¥å£å®ç°ç±»æˆ–è€…ä¸ºå½“å‰å¯¹è±¡æä¾›ä»£ç†å®ç°ï¼ˆä¾‹å¦‚AOPï¼‰ã€‚ ä¸€èˆ¬æ™®é€šçš„ BeanFactory æ˜¯ä¸æ”¯æŒè‡ªåŠ¨æ³¨å†Œ BeanPostProcessor çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨ addBeanPostProcessor() è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œåçš„ BeanPostProcessor é€‚ç”¨äºæ‰€æœ‰è¯¥ BeanFactory åˆ›å»ºçš„ beanï¼Œä½†æ˜¯ ApplicationContext å¯ä»¥åœ¨å…¶ bean å®šä¹‰ä¸­è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰çš„ BeanPostProcessor å¹¶è‡ªåŠ¨å®Œæˆæ³¨å†Œï¼ŒåŒæ—¶å°†ä»–ä»¬åº”ç”¨åˆ°éšååˆ›å»ºçš„ä»»ä½• bean ä¸­ã€‚ postProcessBeforeInitialization() å’Œ postProcessAfterInitialization() ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª Object ç±»å‹çš„ beanï¼Œä¸€ä¸ª String ç±»å‹çš„ beanNameï¼Œå…¶ä¸­ bean æ˜¯å·²ç»å®ä¾‹åŒ–äº†çš„ instanceBeanï¼Œèƒ½æ‹¿åˆ°è¿™ä¸ªä½ æ˜¯ä¸æ˜¯å¯ä»¥å¯¹å®ƒä¸ºæ‰€æ¬²ä¸ºäº†ï¼Ÿ è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯åˆå§‹åŒ– bean çš„å‰åç½®å¤„ç†å™¨ï¼Œä»–ä»¬åº”ç”¨ invokeInitMethods() å‰åã€‚å¦‚ä¸‹å›¾ï¼š ä»£ç å±‚æ¬¡ä¸Šé¢å·²ç»è´´å‡ºæ¥ï¼Œè¿™é‡Œå†è´´ä¸€æ¬¡ï¼š ä¸¤è€…æºç å¦‚ä¸‹ï¼š @Overridepublic Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123; Object current = beanProcessor.postProcessBeforeInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125;@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123; Object current = beanProcessor.postProcessAfterInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; getBeanPostProcessors() è¿”å›çš„æ˜¯ beanPostProcessors é›†åˆï¼Œè¯¥é›†åˆé‡Œé¢å­˜æ”¾å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ BeanPostProcessorï¼Œå¦‚æœè¯¥é›†åˆä¸­å­˜åœ¨å…ƒç´ åˆ™è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ï¼Œå¦åˆ™å°±ç›´æ¥è¿”å› bean äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ BeanFactory å®¹å™¨æ˜¯æ— æ³•è¾“å‡ºè‡ªå®šä¹‰ BeanPostProcessor é‡Œé¢çš„å†…å®¹ï¼Œå› ä¸ºåœ¨ BeanFactory.getBean() çš„è¿‡ç¨‹ä¸­æ ¹æœ¬å°±æ²¡æœ‰å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ BeanPostProcessor æ³¨å…¥è¿›æ¥ï¼Œæ‰€ä»¥è¦æƒ³ BeanFactory å®¹å™¨ çš„ BeanPostProcessor ç”Ÿæ•ˆæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ addBeanPostProcessor() å°†å®šä¹‰çš„ BeanPostProcessor æ³¨å†Œåˆ°ç›¸åº”çš„ BeanFactory ä¸­ã€‚ä½†æ˜¯ ApplicationContext ä¸éœ€è¦æ‰‹åŠ¨ï¼Œå› ä¸º ApplicationContext ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å®Œæˆæ³¨å†Œã€‚ ApplicationContext å®ç°è‡ªåŠ¨æ³¨å†Œçš„åŸå› åœ¨äºæˆ‘ä»¬æ„é€ ä¸€ä¸ª ApplicationContext å®ä¾‹å¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨ registerBeanPostProcessors() æ–¹æ³•å°†æ£€æµ‹åˆ°çš„ BeanPostProcessor æ³¨å…¥åˆ° ApplicationContext å®¹å™¨ä¸­ï¼ŒåŒæ—¶åº”ç”¨åˆ°è¯¥å®¹å™¨åˆ›å»ºçš„ bean ä¸­ã€‚ /** * å®ä¾‹åŒ–å¹¶è°ƒç”¨å·²ç»æ³¨å…¥çš„ BeanPostProcessor * å¿…é¡»åœ¨åº”ç”¨ä¸­ bean å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ */protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);&#125;public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123; // è·å–æ‰€æœ‰çš„ BeanPostProcessor çš„ beanName // è¿™äº› beanName éƒ½å·²ç»å…¨éƒ¨åŠ è½½åˆ°å®¹å™¨ä¸­å»ï¼Œä½†æ˜¯æ²¡æœ‰å®ä¾‹åŒ– String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // è®°å½•æ‰€æœ‰çš„beanProcessoræ•°é‡ int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; // æ³¨å†Œ BeanPostProcessorCheckerï¼Œå®ƒä¸»è¦æ˜¯ç”¨äºåœ¨ BeanPostProcessor å®ä¾‹åŒ–æœŸé—´è®°å½•æ—¥å¿— // å½“ Spring ä¸­é«˜é…ç½®çš„åç½®å¤„ç†å™¨è¿˜æ²¡æœ‰æ³¨å†Œå°±å·²ç»å¼€å§‹äº† bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ä¾¿ä¼šæ‰“å° BeanPostProcessorChecker ä¸­çš„å†…å®¹ beanFactory.addBeanPostProcessor(new PostProcessorRegistrationDelegate.BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // PriorityOrdered ä¿è¯é¡ºåº List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); // MergedBeanDefinitionPostProcessor List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;(); // ä½¿ç”¨ Ordered ä¿è¯é¡ºåº List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); // æ²¡æœ‰é¡ºåº List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; // PriorityOrdered if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; // è°ƒç”¨ getBean è·å– bean å®ä¾‹å¯¹è±¡ BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; // Ordered else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; // æ— åº nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // ç¬¬ä¸€æ­¥æ³¨å†Œæ‰€æœ‰å®ç°äº† PriorityOrdered çš„BeanPostProcessor // å…ˆæ’åº sortPostProcessors(priorityOrderedPostProcessors, beanFactory); // åæ³¨å†Œ registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // ç¬¬äºŒæ­¥æ³¨å†Œæ‰€æœ‰å®ç°äº† Ordered çš„ BeanPostProcessor List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(); for (String ppName : orderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // ç¬¬ä¸‰æ­¥æ³¨å†Œæ‰€æœ‰æ— åºçš„ BeanPostProcessor List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(); for (String ppName : nonOrderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // æœ€åï¼Œæ³¨å†Œæ‰€æœ‰çš„ MergedBeanDefinitionPostProcessor ç±»å‹çš„ BeanPostProcessor sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); // åŠ å…¥ApplicationListenerDetectorï¼ˆæ¢æµ‹å™¨ï¼‰ // é‡æ–°æ³¨å†Œ BeanPostProcessor ä»¥æ£€æµ‹å†…éƒ¨ beanï¼Œå› ä¸º ApplicationListeners å°†å…¶ç§»åŠ¨åˆ°å¤„ç†å™¨é“¾çš„æœ«å°¾ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));&#125; æ–¹æ³•é¦–å…ˆ beanFactory è·å–æ³¨å†Œåˆ°è¯¥ BeanFactory ä¸­æ‰€æœ‰ BeanPostProcessor ç±»å‹çš„ beanNameï¼Œå…¶å®å°±æ˜¯æ‰¾æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ bean ï¼Œç„¶åè¿­ä»£è¿™äº› beanï¼Œå°†å…¶æŒ‰ç…§PriorityOrderedã€Orderedã€æ— åºçš„é¡ºåºæ·»åŠ è‡³ç›¸åº”çš„ List é›†åˆä¸­ï¼Œæœ€åä¾æ¬¡è°ƒç”¨ sortPostProcessors() è¿›è¡Œæ’åºå¤„ç†å’Œ registerBeanPostProcessors() å®Œæˆæ³¨å†Œã€‚æ’åºå¾ˆç®€å•ï¼Œå¦‚æœ beanFactory ä¸º DefaultListableBeanFactory åˆ™è¿”å› BeanFactory æ‰€ä¾èµ–çš„æ¯”è¾ƒå™¨ï¼Œå¦åˆ™åæ­£é»˜è®¤çš„æ¯”è¾ƒå™¨(OrderComparator)ï¼Œç„¶åè°ƒç”¨ sort() å³å¯ã€‚å¦‚ä¸‹ï¼š private static void sortPostProcessors(List&lt;?&gt; postProcessors, ConfigurableListableBeanFactory beanFactory) &#123; Comparator&lt;Object&gt; comparatorToUse = null; if (beanFactory instanceof DefaultListableBeanFactory) &#123; comparatorToUse = ((DefaultListableBeanFactory) beanFactory).getDependencyComparator(); &#125; if (comparatorToUse == null) &#123; comparatorToUse = OrderComparator.INSTANCE; &#125; postProcessors.sort(comparatorToUse);&#125; è€Œå¯¹äºæ³¨å†ŒåŒæ ·æ˜¯è°ƒç”¨ AbstractBeanFactory.addBeanPostProcessor() æ–¹æ³•å®Œæˆæ³¨å†Œï¼Œå¦‚ä¸‹ï¼š private static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors) &#123; for (BeanPostProcessor postProcessor : postProcessors) &#123; beanFactory.addBeanPostProcessor(postProcessor); &#125;&#125; è‡³æ­¤ï¼ŒBeanPostProcessor å·²ç»åˆ†æå®Œæ¯•äº†ï¼Œè¿™é‡Œç®€å•æ€»ç»“ä¸‹ï¼š BeanPostProcessor çš„ä½œç”¨åŸŸæ˜¯å®¹å™¨çº§åˆ«çš„ï¼Œå®ƒåªå’Œæ‰€åœ¨çš„å®¹å™¨ç›¸å…³ ï¼Œå½“ BeanPostProcessor å®Œæˆæ³¨å†Œåï¼Œå®ƒä¼šåº”ç”¨äºæ‰€æœ‰è·Ÿå®ƒåœ¨åŒä¸€ä¸ªå®¹å™¨å†…çš„ beanã€‚ BeanFactory å’Œ ApplicationContext å¯¹ BeanPostProcessor çš„å¤„ç†ä¸åŒï¼ŒApplicationContext ä¼šè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ beanï¼Œå¹¶å®Œæˆæ³¨å†Œï¼Œä½†æ˜¯ä½¿ç”¨ BeanFactory å®¹å™¨æ—¶åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ addBeanPostProcessor() å®Œæˆæ³¨å†Œ ApplicationContext çš„ BeanPostProcessor æ”¯æŒ Orderedï¼Œè€Œ BeanFactory çš„ BeanPostProcessor æ˜¯ä¸æ”¯æŒçš„ï¼ŒåŸå› åœ¨äºApplicationContext ä¼šå¯¹ BeanPostProcessor è¿›è¡Œ Ordered æ£€æµ‹å¹¶å®Œæˆæ’åºï¼Œè€Œ BeanFactory ä¸­çš„ BeanPostProcessor åªè·Ÿæ³¨å†Œçš„é¡ºåºæœ‰å…³ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥åˆ†æAwareæ¥å£","date":"2020-01-22T01:20:19.000Z","path":"2020/01/22/26a31db5.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=3335 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE doCreateBean() æ–¹æ³•ä¸»è¦å¹²ä¸‰ä»¶äº‹æƒ…ï¼š å®ä¾‹åŒ– bean å¯¹è±¡ï¼šcreateBeanInstance() å±æ€§æ³¨å…¥ï¼špopulateBean() åˆå§‹åŒ– bean å¯¹è±¡ï¼šinitializeBean() è€Œåˆå§‹åŒ– bean å¯¹è±¡æ—¶ä¹Ÿæ˜¯å¹²äº†ä¸‰ä»¶äº‹æƒ…ï¼š æ¿€æ´» Aware æ–¹æ³• åç½®å¤„ç†å™¨çš„åº”ç”¨ æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³• æ¥ä¸‹æ¥å°†ä¼šè¯¦ç»†åˆ†æè¿™ä¸‰ä»¶äº‹æƒ…ï¼Œè¿™ç¯‡ä¸»è¦åˆ†æ Aware æ¥å£ã€‚ Aware æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š /** * Marker superinterface indicating that a bean is eligible to be * notified by the Spring container of a particular framework object * through a callback-style method. Actual method signature is * determined by individual subinterfaces, but should typically * consist of just one void-returning method that accepts a single * argument. * * &lt;p&gt;Note that merely implementing &#123;@link Aware&#125; provides no default * functionality. Rather, processing must be done explicitly, for example * in a &#123;@link org.springframework.beans.factory.config.BeanPostProcessor BeanPostProcessor&#125;. * Refer to &#123;@link org.springframework.context.support.ApplicationContextAwareProcessor&#125; * and &#123;@link org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory&#125; * for examples of processing &#123;@code *Aware&#125; interface callbacks. * * @author Chris Beams * @since 3.1 */public interface Aware &#123;&#125; Aware æ¥å£ä¸º Spring å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œæ˜¯ä¸€ä¸ªå…·æœ‰æ ‡è¯†ä½œç”¨çš„è¶…çº§æ¥å£ï¼Œå®ç°äº†è¯¥æ¥å£çš„ bean æ˜¯å…·æœ‰è¢« Spring å®¹å™¨é€šçŸ¥çš„èƒ½åŠ›ï¼Œé€šçŸ¥çš„æ–¹å¼æ˜¯é‡‡ç”¨å›è°ƒçš„æ–¹å¼ã€‚ Aware æ¥å£æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œå®é™…çš„æ–¹æ³•ç­¾åç”±å„ä¸ªå­æ¥å£æ¥ç¡®å®šï¼Œä¸”è¯¥æ¥å£é€šå¸¸åªä¼šæœ‰ä¸€ä¸ªæ¥æ”¶å•å‚æ•°çš„ set æ–¹æ³•ï¼Œè¯¥ set æ–¹æ³•çš„å‘½åæ–¹å¼ä¸º set + å»æ‰æ¥å£åä¸­çš„ Aware åç¼€ï¼Œå³ XxxAware æ¥å£ï¼Œåˆ™æ–¹æ³•å®šä¹‰ä¸º setXxx()ï¼Œä¾‹å¦‚ BeanNameAwareï¼ˆsetBeanNameï¼‰ï¼ŒApplicationContextAwareï¼ˆsetApplicationContextï¼‰ã€‚ Aware çš„å­æ¥å£éœ€è¦æä¾›ä¸€ä¸ª setXxx æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ set æ˜¯è®¾ç½®å±æ€§å€¼çš„æ–¹æ³•ï¼Œå³ Aware ç±»æ¥å£çš„ setXxx æ–¹æ³•å…¶å®å°±æ˜¯è®¾ç½® xxx å±æ€§å€¼çš„ã€‚ Aware çš„å«ä¹‰æ˜¯æ„ŸçŸ¥çš„ã€æ„Ÿåº”çš„ï¼Œé‚£ä¹ˆåœ¨ Spring å®¹å™¨ä¸­æ˜¯å¦‚ä½•å®ç°æ„ŸçŸ¥å¹¶è®¾ç½®å±æ€§å€¼å¾—å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»åˆå§‹åŒ– bean ä¸­çš„æ¿€æ´» Aware çš„æ–¹æ³• invokeAwareMethods() ä¸­çœ‹åˆ°ä¸€ç‚¹ç‚¹ï¼Œå¦‚ä¸‹ï¼š private void invokeAwareMethods(final String beanName, final Object bean) &#123; if (bean instanceof Aware) &#123; if (bean instanceof BeanNameAware) &#123; ((BeanNameAware) bean).setBeanName(beanName); &#125; if (bean instanceof BeanClassLoaderAware) &#123; ClassLoader bcl = getBeanClassLoader(); if (bcl != null) &#123; ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); &#125; &#125; if (bean instanceof BeanFactoryAware) &#123; ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); &#125; &#125;&#125; é¦–å…ˆåˆ¤æ–­ bean å®ä¾‹æ˜¯å¦å±äº Aware æ¥å£çš„èŒƒç•´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è°ƒç”¨å®ä¾‹çš„ setXxx() æ–¹æ³•ç»™å®ä¾‹è®¾ç½® xxx å±æ€§å€¼ï¼Œåœ¨ invokeAwareMethods() æ–¹æ³•ä¸»è¦æ˜¯è®¾ç½® beanNameï¼ŒbeanClassLoaderã€BeanFactory ä¸­ä¸‰ä¸ªå±æ€§å€¼ã€‚ Spring æä¾›äº†ä¸€ç³»åˆ—çš„ Aware æ¥å£ï¼Œå¦‚ä¸‹å›¾ï¼ˆéƒ¨åˆ†ï¼‰ï¼š ä¸Šé¢åªæ˜¯ä¸€éƒ¨åˆ†å­ç±»ï¼Œä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Spring æä¾›çš„ Aware æ¥å£æ˜¯æ˜¯ä½•å…¶å¤šã€‚åŒæ—¶ä»ä¸Šå›¾æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†å‡ ä¸ªæ¯”è¾ƒç†Ÿæ‚‰çš„æ¥å£ï¼Œå¦‚ BeanClassLoaderAwareã€BeanFactoryAwareã€BeanNameAwareï¼Œä¸‹é¢å°±è¿™ä¸‰ä¸ªæ¥å£æ¥åšä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼Œå…ˆçœ‹å„è‡ªçš„å®šä¹‰ï¼š public interface BeanClassLoaderAware extends Aware &#123; /** * å°† BeanClassLoader æä¾›ç»™ bean å®ä¾‹å›è°ƒ * åœ¨ bean å±æ€§å¡«å……ä¹‹åã€åˆå§‹åŒ–å›è°ƒä¹‹å‰å›è°ƒï¼Œ * ä¾‹å¦‚InitializingBeançš„InitializingBean.afterPropertiesSetï¼ˆï¼‰æ–¹æ³•æˆ–è‡ªå®šä¹‰initæ–¹æ³• */ void setBeanClassLoader(ClassLoader classLoader);&#125;public interface BeanFactoryAware extends Aware &#123; /** * å°† BeanFactory æä¾›ç»™ bean å®ä¾‹å›è°ƒ * è°ƒç”¨æ—¶æœºå’Œ setBeanClassLoader ä¸€æ · */ void setBeanFactory(BeanFactory beanFactory) throws BeansException;&#125;public interface BeanNameAware extends Aware &#123; /** * åœ¨åˆ›å»ºæ­¤ bean çš„ beanå·¥å‚ä¸­è®¾ç½® beanName */ void setBeanName(String name);&#125;public interface ApplicationContextAware extends Aware &#123; /** * è®¾ç½®æ­¤ bean å¯¹è±¡çš„ ApplicationContextï¼Œé€šå¸¸ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆå§‹åŒ–å¯¹è±¡ */ void setApplicationContext(ApplicationContext applicationContext) throws BeansException;&#125; ä¸‹é¢ç®€å•æ¼”ç¤ºä¸‹ä¸Šé¢å››ä¸ªæ¥å£çš„ä½¿ç”¨æ–¹æ³•ï¼š public class MyApplicationAware implements BeanNameAware,BeanFactoryAware,BeanClassLoaderAware,ApplicationContextAware&#123; private String beanName; private BeanFactory beanFactory; private ClassLoader classLoader; private ApplicationContext applicationContext; @Override public void setBeanClassLoader(ClassLoader classLoader) &#123; System.out.println(&quot;è°ƒç”¨äº† BeanClassLoaderAware çš„ setBeanClassLoader æ–¹æ³•&quot;); this.classLoader = classLoader; &#125; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; System.out.println(&quot;è°ƒç”¨äº† BeanFactoryAware çš„ setBeanFactory æ–¹æ³•&quot;); this.beanFactory = beanFactory; &#125; @Override public void setBeanName(String name) &#123; System.out.println(&quot;è°ƒç”¨äº† BeanNameAware çš„ setBeanName æ–¹æ³•&quot;); this.beanName = name; &#125; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; System.out.println(&quot;è°ƒç”¨äº† ApplicationContextAware çš„ setApplicationContext æ–¹æ³•&quot;); this.applicationContext = applicationContext; &#125; public void display()&#123; System.out.println(&quot;beanName:&quot; + beanName); System.out.println(&quot;æ˜¯å¦ä¸ºå•ä¾‹ï¼š&quot; + beanFactory.isSingleton(beanName)); System.out.println(&quot;ç³»ç»Ÿç¯å¢ƒä¸ºï¼š&quot; + applicationContext.getEnvironment()); &#125;&#125; æµ‹è¯•æ–¹æ³•å¦‚ä¸‹: public static void main(String[] args) &#123; ClassPathResource resource = new ClassPathResource(&quot;spring.xml&quot;); DefaultListableBeanFactory factory = new DefaultListableBeanFactory(); XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory); reader.loadBeanDefinitions(resource); MyApplicationAware applicationAware = (MyApplicationAware) factory.getBean(&quot;myApplicationAware&quot;); applicationAware.display();&#125; è¿è¡Œç»“æœï¼š ä»è¯¥è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œåªæ‰§è¡Œäº†ä¸‰ä¸ª Aware æ¥å£çš„ set æ–¹æ³•ï¼ŒåŸå› å°±æ˜¯ç—› getBean() è°ƒç”¨æ—¶åœ¨æ¿€æ´» Aware æ¥å£æ—¶åªæ£€æµ‹äº† BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAware ä¸‰ä¸ª Aware æ¥å£ã€‚å¦‚æœå°†æµ‹è¯•æ–¹æ³•è°ƒæ•´ä¸ºä¸‹é¢ï¼š public static void main(String[] args) &#123; ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;); MyApplicationAware applicationAware = (MyApplicationAware) applicationContext.getBean(&quot;myApplicationAware&quot;); applicationAware.display();&#125; åˆ™è¿è¡Œç»“æœå¦‚ä¸‹ï¼š ä»è¿™äº†æˆ‘ä»¬åŸºæœ¬ä¸Šå°±å¯ä»¥ Aware çœŸæ­£çš„å«ä¹‰æ˜¯ä»€ä¹ˆäº†ï¼Ÿ æ„ŸçŸ¥ï¼Œå…¶å®æ˜¯ Spring å®¹å™¨åœ¨åˆå§‹åŒ–ä¸»åŠ¨æ£€æµ‹å½“å‰ bean æ˜¯å¦å®ç°äº† Aware æ¥å£ï¼Œå¦‚æœå®ç°äº†åˆ™å›è°ƒå…¶ set æ–¹æ³•å°†ç›¸åº”çš„å‚æ•°è®¾ç½®ç»™è¯¥ bean ï¼Œè¿™ä¸ªæ—¶å€™è¯¥ bean å°±ä» Spring å®¹å™¨ä¸­å–å¾—ç›¸åº”çš„èµ„æºã€‚ æœ€ååˆ—å‡ºéƒ¨åˆ†å¸¸ç”¨çš„ Aware å­æ¥å£ï¼Œä¾¿äºæ—¥åæŸ¥è¯¢ï¼š LoadTimeWeaverAwareï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ BeanClassLoaderAwareï¼šåŠ è½½Spring Beançš„ç±»åŠ è½½å™¨ BootstrapContextAwareï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI ResourceLoaderAwareï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨ BeanFactoryAwareï¼šå£°æ˜BeanFactory PortletConfigAwareï¼šPortletConfig PortletContextAwareï¼šPortletContext ServletConfigAwareï¼šServletConfig ServletContextAwareï¼šServletContext MessageSourceAwareï¼šå›½é™…åŒ– ApplicationEventPublisherAwareï¼šåº”ç”¨äº‹ä»¶ NotificationPublisherAwareï¼šJMXé€šçŸ¥ BeanNameAwareï¼šå£°æ˜Spring Beançš„åå­—","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹åŠ è½½Beanâ€”â€”æ€»ç»“ç¯‡","date":"2020-01-21T03:29:39.000Z","path":"2020/01/21/abeafe18.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2905 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨Spring bean è§£æç¯‡æ·±å…¥åˆ†æäº†ä¸€ä¸ªé…ç½®æ–‡ä»¶ç»å†äº†å“ªäº›è¿‡ç¨‹è½¬å˜æˆäº† BeanDefinitionï¼Œä½†æ˜¯è¿™ä¸ª BeanDefinition å¹¶ä¸æ˜¯æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æƒ³è¦çš„ beanï¼Œå› ä¸ºå®ƒè¿˜ä»…ä»…åªæ˜¯æ‰¿è½½äº†æˆ‘ä»¬éœ€è¦çš„ç›®æ ‡ bean çš„ä¿¡æ¯ï¼Œä» BeanDefinition åˆ°æˆ‘ä»¬éœ€è¦çš„ç›®æ ‡è¿˜éœ€è¦ä¸€ä¸ªæ¼«é•¿çš„ bean çš„åˆå§‹åŒ–é˜¶æ®µã€‚ åœ¨ Spring bean åŠ è½½é˜¶æ®µå·²ç»è¯¦ç»†åˆ†æäº†åˆå§‹åŒ– bean çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œåšä¸€ä¸ªæ¦‚æ‹¬æ€§çš„æ€»ç»“ã€‚ bean çš„åˆå§‹åŒ–èŠ‚ç‚¹ç”±ç¬¬ä¸€æ¬¡è°ƒç”¨ getBean()(æ˜¾å¼æˆ–è€…éšå¼)å¼€å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»è¿™ä¸ªæ–¹æ³•å¼€å§‹ã€‚ public Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false);&#125;protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType, @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException &#123; // è·å– beanNameï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªè½¬æ¢åŠ¨ä½œï¼Œå°† name è½¬æ¢Wie beanName final String beanName = transformedBeanName(name); Object bean; // ä»ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­è·å– bean // *** è¿™é‡Œä¼šæ¶‰åŠåˆ°è§£å†³å¾ªç¯ä¾èµ– bean çš„é—®é¢˜ Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.debug(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; // å› ä¸º Spring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œåœ¨åŸå‹æ¨¡å¼ä¸‹å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ // **å…³äºå¾ªç¯ä¾èµ–åç»­ä¼šå•ç‹¬å‡ºæ–‡è¯¦ç»†è¯´æ˜** if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; // å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä»çˆ¶ç±»å®¹å™¨ä¸­åŠ è½½ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; &#125; // å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œè¿™é‡Œéœ€è¦è®°å½• if (!typeCheckOnly) &#123; markBeanAsCreated(beanName); &#125; try &#123; // ä»å®¹å™¨ä¸­è·å– beanName ç›¸åº”çš„ GenericBeanDefinitionï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º RootBeanDefinition final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); // æ£€æŸ¥ç»™å®šçš„åˆå¹¶çš„ BeanDefinition checkMergedBeanDefinition(mbd, beanName, args); // å¤„ç†æ‰€ä¾èµ–çš„ bean String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; // è‹¥ç»™å®šçš„ä¾èµ– bean å·²ç»æ³¨å†Œä¸ºä¾èµ–ç»™å®šçš„b ean // å¾ªç¯ä¾èµ–çš„æƒ…å†µ if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; // ç¼“å­˜ä¾èµ–è°ƒç”¨ registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125; // bean å®ä¾‹åŒ– // å•ä¾‹æ¨¡å¼ if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // æ˜¾ç¤ºä»å•åˆ©ç¼“å­˜ä¸­åˆ é™¤ bean å®ä¾‹ // å› ä¸ºå•ä¾‹æ¨¡å¼ä¸‹ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯èƒ½ä»–å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥é”€æ¯å®ƒ destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // åŸå‹æ¨¡å¼ else if (mbd.isPrototype()) &#123; // It&#x27;s a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; // ä»æŒ‡å®šçš„ scope ä¸‹åˆ›å»º bean String scopeName = mbd.getScope(); final Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(&quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;); &#125; try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException(beanName, &quot;Scope &#x27;&quot; + scopeName + &quot;&#x27; is not active for the current thread; consider &quot; + &quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;, ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; // æ£€æŸ¥éœ€è¦çš„ç±»å‹æ˜¯å¦ç¬¦åˆ bean çš„å®é™…ç±»å‹ if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) &#123; try &#123; T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType); if (convertedBean == null) &#123; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; return convertedBean; &#125; catch (TypeMismatchException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Failed to convert bean &#x27;&quot; + name + &quot;&#x27; to required type &#x27;&quot; + ClassUtils.getQualifiedName(requiredType) + &quot;&#x27;&quot;, ex); &#125; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; &#125; return (T) bean;&#125; å†…éƒ¨è°ƒç”¨ doGetBean() æ–¹æ³•ï¼ŒdoGetBean() çš„ä»£ç é‡æ¯”è¾ƒå¤šï¼Œä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡º bean çš„åŠ è½½è¿‡ç¨‹æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¿‡ç¨‹ï¼Œä¼šæ¶‰åŠåˆ°å„ç§å„æ ·çš„æƒ…å†µå¤„ç†ã€‚doGetBean() å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ã€‚ è½¬æ¢ beanNameã€‚å› ä¸ºæˆ‘ä»¬è°ƒç”¨ getBean() æ–¹æ³•ä¼ å…¥çš„ name å¹¶ä¸ä¸€å®šå°±æ˜¯ beanNameï¼Œå¯ä»¥ä¼ å…¥ aliasNameï¼ŒFactoryBeanï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œç®€å•çš„è½¬æ¢è¿‡ç¨‹ã€‚ å°è¯•ä»ç¼“å­˜ä¸­åŠ è½½å•ä¾‹ beanã€‚ bean çš„å®ä¾‹åŒ–ã€‚ åŸå‹æ¨¡å¼çš„ä¾èµ–æ£€æŸ¥ã€‚å› ä¸º Spring åªä¼šè§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–éƒ½æ˜¯ç›´æ¥æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚ å°è¯•ä» parentBeanFactory è·å– bean å®ä¾‹ã€‚å¦‚æœ parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName) åˆ™å°è¯•ä» parentBeanFactory ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå› ä¸º !containsBeanDefinition(beanName) å°±æ„å‘³ç€å®šä¹‰çš„ xml æ–‡ä»¶ä¸­æ²¡æœ‰ beanName ç›¸åº”çš„é…ç½®ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½ä» parentBeanFactory ä¸­è·å–ã€‚ è·å– RootBeanDefinitionï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆå¹¶æ£€æŸ¥ã€‚ä»ç¼“å­˜ä¸­è·å–å·²ç»è§£æçš„ RootBeanDefinitionï¼ŒåŒæ—¶å¦‚æœçˆ¶ç±»ä¸ä¸º null çš„è¯ï¼Œåˆ™ä¼šåˆå¹¶çˆ¶ç±»çš„å±æ€§ã€‚ ä¾èµ–æ£€æŸ¥ã€‚æŸä¸ª bean ä¾èµ–å…¶ä»– bean ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½ä¾èµ–çš„ beanã€‚ å¯¹ä¸åŒçš„ scope è¿›è¡Œå¤„ç†ã€‚ ç±»å‹è½¬æ¢å¤„ç†ã€‚å¦‚æœä¼ é€’çš„ requiredType ä¸ä¸º nullï¼Œåˆ™éœ€è¦æ£€æµ‹æ‰€å¾—åˆ° bean çš„ç±»å‹æ˜¯å¦ä¸è¯¥ requiredType ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™å°è¯•è½¬æ¢ï¼Œå½“ç„¶ä¹Ÿè¦èƒ½å¤Ÿè½¬æ¢æˆåŠŸï¼Œå¦åˆ™æŠ›å‡º BeanNotOfRequiredTypeException å¼‚å¸¸ã€‚ ä¸‹é¢å°±ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œé˜è¿°ï¼Œè¯´æ˜ Spring bean çš„åŠ è½½è¿‡ç¨‹ã€‚ ä»ç¼“å­˜ä¸­è·å– bean åˆ›å»º bean å®ä¾‹å¯¹è±¡ ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡ ä»ç¼“å­˜ä¸­è·å– beanSpring ä¸­æ ¹æ® scope å¯ä»¥å°† bean åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼šsingletonã€prototype å’Œ å…¶ä»–ï¼Œè¿™æ ·åˆ†çš„åŸå› åœ¨äº Spring åœ¨å¯¹ä¸åŒ scope å¤„ç†çš„æ—¶å€™æ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚ singletonï¼šåœ¨ Spring çš„ IoC å®¹å™¨ä¸­åªå­˜åœ¨ä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼Œæ‰€æœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨éƒ½å…±äº«è¿™ä¸ªå®ä¾‹ã€‚Spring å®¹å™¨åªä¼šåˆ›å»ºè¯¥ bean å®šä¹‰çš„å”¯ä¸€å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ä¼šè¢«ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”å¯¹è¯¥beançš„æ‰€æœ‰åç»­è¯·æ±‚å’Œå¼•ç”¨éƒ½å°†è¿”å›è¯¥ç¼“å­˜ä¸­çš„å¯¹è±¡å®ä¾‹ã€‚ prototypeï¼šæ¯æ¬¡å¯¹è¯¥beançš„è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ å…¶ä»–ï¼šå…¶ä»–åŒ…æ‹¬ requestã€sessionã€global sessionï¼š requestï¼šæ¯æ¬¡ http è¯·æ±‚å°†ä¼šæœ‰å„è‡ªçš„ bean å®ä¾‹ã€‚ sessionï¼šåœ¨ä¸€ä¸ª http session ä¸­ï¼Œä¸€ä¸ª bean å®šä¹‰å¯¹åº”ä¸€ä¸ª bean å®ä¾‹ã€‚ global sessionï¼šåœ¨ä¸€ä¸ªå…¨å±€çš„ http session ä¸­ï¼Œä¸€ä¸ª bean å®šä¹‰å¯¹åº”ä¸€ä¸ª bean å®ä¾‹ã€‚ æ‰€ä»¥ä»ç¼“å­˜ä¸­è·å–çš„ bean ä¸€å®šæ˜¯ singleton beanï¼Œè¿™ä¹Ÿæ˜¯ Spring ä¸ºä½•åªè§£å†³ singleton bean çš„å¾ªç¯ä¾èµ–ã€‚è°ƒç”¨ getSingleton() ä»ç¼“å­˜ä¸­è·å– singleton beanã€‚ public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true);&#125;protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; synchronized (this.singletonObjects) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; return singletonObject;&#125; getSingleton() å°±æ˜¯ä» singletonObjectsã€earlySingletonObjectsã€ singletonFactories ä¸‰ä¸ªç¼“å­˜ä¸­è·å–ï¼Œè¿™é‡Œä¹Ÿæ˜¯ Spring è§£å†³ bean å¾ªç¯ä¾èµ–çš„å…³é”®ä¹‹å¤„ã€‚è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹å¦‚ä¸‹å†…å®¹ï¼š IOCä¹‹ä»å•ä¾‹ç¼“å­˜ä¸­è·å–å•ä¾‹ bean åˆ›å»º bean å®ä¾‹å¯¹è±¡å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä¹Ÿæ²¡æœ‰ parentBeanFactory ï¼Œåˆ™ä¼šè°ƒç”¨ createBean() åˆ›å»º bean å®ä¾‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯åœ¨å¤„ç†ä¸åŒ scope çš„ bean çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ã€‚ protected abstract Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException è¯¥æ–¹æ³•æ˜¯å®šä¹‰åœ¨ AbstractBeanFactory ä¸­çš„è™šæ‹Ÿæ–¹æ³•ï¼Œå…¶å«ä¹‰æ˜¯æ ¹æ®ç»™å®šçš„ BeanDefinition å’Œ argså®ä¾‹åŒ–ä¸€ä¸ª bean å¯¹è±¡ï¼Œå¦‚æœè¯¥ BeanDefinition å­˜åœ¨çˆ¶ç±»ï¼Œåˆ™è¯¥ BeanDefinition å·²ç»åˆå¹¶äº†çˆ¶ç±»çš„å±æ€§ã€‚æ‰€æœ‰ Bean å®ä¾‹çš„åˆ›å»ºéƒ½ä¼šå§”æ‰˜ç»™è¯¥æ–¹æ³•å®ç°ã€‚ æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š beanNameï¼šbean çš„åå­— mbdï¼šå·²ç»åˆå¹¶äº†çˆ¶ç±»å±æ€§çš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰BeanDefinition argsï¼šç”¨äºæ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•åˆ›å»º bean å®ä¾‹å¯¹è±¡çš„å‚æ•° è¯¥æŠ½è±¡æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯åœ¨ç±» AbstractAutowireCapableBeanFactory ä¸­å®ç°ï¼Œè¯¥æ–¹æ³•å…¶å®åªæ˜¯åšä¸€äº›æ£€æŸ¥å’ŒéªŒè¯å·¥ä½œï¼ŒçœŸæ­£çš„åˆå§‹åŒ–å·¥ä½œæ˜¯ç”± doCreateBean() å®ç°ï¼Œå¦‚ä¸‹ï¼š protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args) throws BeanCreationException &#123; // BeanWrapperæ˜¯å¯¹Beançš„åŒ…è£…ï¼Œå…¶æ¥å£ä¸­æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œè·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨ BeanWrapper instanceWrapper = null; // å•ä¾‹æ¨¡å‹ï¼Œåˆ™ä»æœªå®Œæˆçš„ FactoryBean ç¼“å­˜ä¸­åˆ é™¤ if (mbd.isSingleton()) &#123;anceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; // ä½¿ç”¨åˆé€‚çš„å®ä¾‹åŒ–ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ã€ç®€å•åˆå§‹åŒ– if (instanceWrapper == null) &#123; instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; // åŒ…è£…çš„å®ä¾‹å¯¹è±¡ final Object bean = instanceWrapper.getWrappedInstance(); // åŒ…è£…çš„å®ä¾‹å¯¹è±¡çš„ç±»å‹ Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) &#123; mbd.resolvedTargetType = beanType; &#125; // æ£€æµ‹æ˜¯å¦æœ‰åç½®å¤„ç† // å¦‚æœæœ‰åç½®å¤„ç†ï¼Œåˆ™å…è®¸åç½®å¤„ç†ä¿®æ”¹ BeanDefinition synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; // applyMergedBeanDefinitionPostProcessors // åç½®å¤„ç†ä¿®æ”¹ BeanDefinition applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // è§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ– // å•ä¾‹æ¨¡å¼ &amp; è¿è¡Œå¾ªç¯ä¾èµ–&amp;å½“å‰å•ä¾‹ bean æ˜¯å¦æ­£åœ¨è¢«åˆ›å»º boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; // æå‰å°†åˆ›å»ºçš„ bean å®ä¾‹åŠ å…¥åˆ°ectFactory ä¸­ // è¿™é‡Œæ˜¯ä¸ºäº†åæœŸé¿å…å¾ªç¯ä¾èµ– addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); &#125; /* * å¼€å§‹åˆå§‹åŒ– bean å®ä¾‹å¯¹è±¡ */ Object exposedObject = bean; try &#123; // å¯¹ bean è¿›è¡Œå¡«å……ï¼Œå°†å„ä¸ªå±æ€§å€¼æ³¨å…¥ï¼Œå…¶ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»– bean çš„å±æ€§ // åˆ™ä¼šé€’å½’åˆå§‹ä¾èµ– bean populateBean(beanName, mbd, instanceWrapper); // è°ƒç”¨åˆå§‹åŒ–æ–¹æ³• exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; /** * å¾ªç¯ä¾èµ–å¤„ç† */ if (earlySingletonExposure) &#123; // è·å– earlySingletonReference Object earlySingletonReference = getSingleton(beanName, false); // åªæœ‰åœ¨å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼ŒearlySingletonReference æ‰ä¸ä¼šä¸ºç©º if (earlySingletonReference != null) &#123; // å¦‚æœ exposedObject æ²¡æœ‰åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¢«æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«å¢å¼º if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; // å¤„ç†ä¾èµ– else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name &#x27;&quot; + beanName + &quot;&#x27; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; try &#123; // æ³¨å†Œ bean registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;&#125; doCreateBean() æ˜¯åˆ›å»º bean å®ä¾‹çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå®ƒçš„æ•´ä½“æ€è·¯æ˜¯ï¼š å¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™æ¸…é™¤ factoryBeanInstanceCache ç¼“å­˜ï¼ŒåŒæ—¶è¿”å› BeanWrapper å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶å¦‚æœå­˜åœ¨ã€‚ å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper æˆ–è€…ä¸æ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™è°ƒç”¨ createBeanInstance() å®ä¾‹åŒ– beanï¼Œä¸»è¦æ˜¯å°† BeanDefinition è½¬æ¢ä¸º BeanWrapper MergedBeanDefinitionPostProcessor çš„åº”ç”¨ å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç† è°ƒç”¨ populateBean() è¿›è¡Œå±æ€§å¡«å……ã€‚å°†æ‰€æœ‰å±æ€§å¡«å……è‡³ bean çš„å®ä¾‹ä¸­ è°ƒç”¨ initializeBean() åˆå§‹åŒ– bean ä¾èµ–æ£€æŸ¥ æ³¨å†Œ DisposableBean å®ä¾‹åŒ– beanå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper å®ä¾‹å¯¹è±¡æˆ–è€…è¯¥ bean ä¸æ˜¯ singletonï¼Œåˆ™è°ƒç”¨ createBeanInstance() åˆ›å»º bean å®ä¾‹ã€‚è¯¥æ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®å‚æ•° BeanDefinitionã€args[] æ¥è°ƒç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ– bean å¯¹è±¡ã€‚è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ï¼Œå¦‚ä¸‹ï¼š protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) &#123; // è§£æ beanï¼Œå°† bean ç±»åè§£æä¸º class å¼•ç”¨ Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName); if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot; + beanClass.getName()); &#125; // å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„å›è°ƒæ–¹æ³•åˆå§‹åŒ–ç­–ç•¥ Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier(); if (instanceSupplier != null) &#123; return obtainFromSupplier(instanceSupplier, beanName); &#125; // å¦‚æœå·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•åˆå§‹åŒ–ç­–ç•¥ if (mbd.getFactoryMethodName() != null) &#123; return instantiateUsingFactoryMethod(beanName, mbd, args); &#125; boolean resolved = false; boolean autowireNecessary = false; if (args == null) &#123; // constructorArgumentLock æ„é€ å‡½æ•°çš„å¸¸ç”¨é” synchronized (mbd.constructorArgumentLock) &#123; // å¦‚æœå·²ç¼“å­˜çš„è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ„é€ å‡½æ•°è§£æ // å› ä¸ºéœ€è¦æ ¹æ®å‚æ•°ç¡®è®¤åˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥è¿‡ç¨‹æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€æœ‰é‡‡ç”¨ç¼“å­˜æœºåˆ¶ if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125; &#125; // å·²ç»è§£æå¥½äº†ï¼Œç›´æ¥æ³¨å…¥å³å¯ if (resolved) &#123; // è‡ªåŠ¨æ³¨å…¥ï¼Œè°ƒç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ if (autowireNecessary) &#123; return autowireConstructor(beanName, mbd, null, null); &#125; else &#123; // ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€  return instantiateBean(beanName, mbd); &#125; &#125; // ç¡®å®šè§£æçš„æ„é€ å‡½æ•° // ä¸»è¦æ˜¯æ£€æŸ¥å·²ç»æ³¨å†Œçš„ SmartInstantiationAwareBeanPostProcessor Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); if (ctors != null || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; // æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ return autowireConstructor(beanName, mbd, ctors, args); &#125; //ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ return instantiateBean(beanName, mbd);&#125; å®ä¾‹åŒ– bean æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå…¶ä¸»è¦çš„é€»è¾‘ä¸ºï¼š å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™è°ƒç”¨ obtainFromSupplier() è¿›è¡Œåˆå§‹åŒ– å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•è¿›è¡Œåˆå§‹åŒ– é¦–å…ˆåˆ¤æ–­ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œå³å·²ç»è§£æè¿‡äº†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å·²ç»è§£æäº†çš„ï¼Œæ ¹æ® constructorArgumentsResolved å‚æ•°æ¥åˆ¤æ–­æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥è¿˜æ˜¯é»˜è®¤æ„é€ å‡½æ•° å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆç¡®å®šåˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°æ¥å®Œæˆè§£æå·¥ä½œï¼Œå› ä¸ºä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°éƒ½æœ‰ä¸åŒçš„æ„é€ å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®å‚æ•°æ¥é”å®šæ„é€ å‡½æ•°å¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¦‚æœå­˜åœ¨å‚æ•°åˆ™ä½¿ç”¨ç›¸åº”çš„å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚ å…¶å®æ ¸å¿ƒæ€æƒ³è¿˜æ˜¯åœ¨äºæ ¹æ®ä¸åŒçš„æƒ…å†µæ‰§è¡Œä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œä¸»è¦æ˜¯åŒ…æ‹¬å¦‚ä¸‹å››ç§ç­–ç•¥ï¼š Supplier å›è°ƒ instantiateUsingFactoryMethod() å·¥å‚æ–¹æ³•åˆå§‹åŒ– autowireConstructor()ï¼Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ– instantiateBean()ï¼Œé»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ å…¶å®æ— è®ºå“ªç§ç­–ç•¥ï¼Œä»–ä»¬çš„å®ç°é€»è¾‘éƒ½å·®ä¸å¤šï¼šç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ æ–¹æ³•ï¼Œç„¶åå®ä¾‹åŒ–ã€‚åªä¸è¿‡ç›¸å¯¹äº Supplier å›è°ƒå’Œé»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥è€Œè¨€ï¼Œå·¥å‚æ–¹æ³•åˆå§‹åŒ–å’Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ä¼šæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºä»–ä»¬æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°çš„ä¸ç¡®å®šæ€§ï¼ŒSpring éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›æ¥ç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°ï¼Œå¦‚æœç¡®å®šäº†åˆ™å¥½åŠï¼Œç›´æ¥é€‰æ‹©å®ä¾‹åŒ–ç­–ç•¥å³å¯ã€‚å½“ç„¶åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ ¹æ®æ˜¯å¦æœ‰éœ€è¦è¦†ç›–æˆ–è€…åŠ¨æ€æ›¿æ¢æ‰çš„æ–¹æ³•ï¼Œå› ä¸ºå­˜åœ¨è¦†ç›–æˆ–è€…ç»‡å…¥çš„è¯éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å°†æ–¹æ³•ç»‡å…¥ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½é€‰æ‹© CGLIB çš„æ–¹å¼æ¥å®ä¾‹åŒ–ï¼Œå¦åˆ™ç›´æ¥åˆ©ç”¨åå°„çš„æ–¹å¼å³å¯ã€‚ å±æ€§å¡«å……å±æ€§å¡«å……å…¶å®å°±æ˜¯å°† BeanDefinition çš„å±æ€§å€¼èµ‹å€¼ç»™ BeanWrapper å®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ã€‚åœ¨å¡«å……çš„è¿‡ç¨‹éœ€è¦æ ¹æ®æ³¨å…¥çš„ç±»å‹ä¸åŒæ¥åŒºåˆ†æ˜¯æ ¹æ®ç±»å‹æ³¨å…¥è¿˜æ˜¯åå­—æ³¨å…¥ï¼Œå½“ç„¶åœ¨è¿™ä¸ªè¿‡ç¨‹è¿˜ä¼šæ¶‰åŠå¾ªç¯ä¾èµ–çš„é—®é¢˜çš„ã€‚ protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) &#123; // æ²¡æœ‰å®ä¾‹åŒ–å¯¹è±¡ if (bw == null) &#123; // æœ‰å±æ€§æŠ›å‡ºå¼‚å¸¸ if (mbd.hasPropertyValues()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;); &#125; else &#123; // æ²¡æœ‰å±æ€§ç›´æ¥è¿”å› return; &#125; &#125; // åœ¨è®¾ç½®å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼š boolean continueWithPropertyPopulation = true; // bena ä¸æ˜¯&quot;åˆæˆ&quot;çš„ï¼Œå³æœªç”±åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰ // æ˜¯å¦æŒæœ‰ InstantiationAwareBeanPostProcessor if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; // è¿­ä»£æ‰€æœ‰çš„ BeanPostProcessors for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; // å¦‚æœä¸º InstantiationAwareBeanPostProcessor if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // è¿”å›å€¼ä¸ºæ˜¯å¦ç»§ç»­å¡«å…… bean // postProcessAfterInstantiationï¼šå¦‚æœåº”è¯¥åœ¨ beanä¸Šé¢è®¾ç½®å±æ€§åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false // ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯è¿”å›trueï¼Œè¿”å› false çš„è¯ï¼Œ // å°†ä¼šé˜»æ­¢åœ¨æ­¤ Bean å®ä¾‹ä¸Šè°ƒç”¨ä»»ä½•åç»­çš„ InstantiationAwareBeanPostProcessor å®ä¾‹ã€‚ if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123; continueWithPropertyPopulation = false; break; &#125; &#125; &#125; &#125; // å¦‚æœåç»­å¤„ç†å™¨å‘å‡ºåœæ­¢å¡«å……å‘½ä»¤ï¼Œåˆ™ç»ˆæ­¢åç»­æ“ä½œ if (!continueWithPropertyPopulation) &#123; return; &#125; // bean çš„å±æ€§å€¼ PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null); if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; // å°† PropertyValues å°è£…æˆ MutablePropertyValues å¯¹è±¡ // MutablePropertyValues å…è®¸å¯¹å±æ€§è¿›è¡Œç®€å•çš„æ“ä½œï¼Œ // å¹¶æä¾›æ„é€ å‡½æ•°ä»¥æ”¯æŒMapçš„æ·±åº¦å¤åˆ¶å’Œæ„é€ ã€‚ MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // æ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123; autowireByName(beanName, mbd, bw, newPvs); &#125; // æ ¹æ®ç±»å‹è‡ªåŠ¨æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; autowireByType(beanName, mbd, bw, newPvs); &#125; pvs = newPvs; &#125; // æ˜¯å¦å·²ç»æ³¨å†Œäº† InstantiationAwareBeanPostProcessors boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); // æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€æŸ¥ boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE); if (hasInstAwareBpps || needsDepCheck) &#123; if (pvs == null) &#123; pvs = mbd.getPropertyValues(); &#125; // ä» bw å¯¹è±¡ä¸­æå– PropertyDescriptor ç»“æœé›† // PropertyDescriptorï¼šå¯ä»¥é€šè¿‡ä¸€å¯¹å­˜å–æ–¹æ³•æå–ä¸€ä¸ªå±æ€§ PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); if (hasInstAwareBpps) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // å¯¹æ‰€æœ‰éœ€è¦ä¾èµ–æ£€æŸ¥çš„å±æ€§è¿›è¡Œåå¤„ç† pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvs == null) &#123; return; &#125; &#125; &#125; &#125; if (needsDepCheck) &#123; // ä¾èµ–æ£€æŸ¥ï¼Œå¯¹åº” depends-on å±æ€§ checkDependencies(beanName, mbd, filteredPds, pvs); &#125; &#125; if (pvs != null) &#123; // å°†å±æ€§åº”ç”¨åˆ° bean ä¸­ applyPropertyValues(beanName, mbd, bw, pvs); &#125;&#125; å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š æ ¹æ® hasInstantiationAwareBeanPostProcessors å±æ€§æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨æ³¨å…¥å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼šï¼Œæ­¤è¿‡ç¨‹å¯ä»¥æ§åˆ¶ Spring æ˜¯å¦ç»§ç»­è¿›è¡Œå±æ€§å¡«å……ã€‚ æ ¹æ®æ³¨å…¥ç±»å‹çš„ä¸åŒæ¥åˆ¤æ–­æ˜¯æ ¹æ®åç§°æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆautowireByName()ï¼‰è¿˜æ˜¯æ ¹æ®ç±»å‹æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆautowireByType()ï¼‰ï¼Œç»Ÿä¸€å­˜å…¥åˆ° PropertyValues ä¸­ï¼ŒPropertyValues ç”¨äºæè¿° bean çš„å±æ€§ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ BeanPostProcessor å’Œ ä¾èµ–æ£€æµ‹ã€‚ å°†æ‰€æœ‰ PropertyValues ä¸­çš„å±æ€§å¡«å……åˆ° BeanWrapper ä¸­ã€‚ åˆå§‹åŒ– beanåˆå§‹åŒ– bean ä¸º createBean() çš„æœ€åä¸€ä¸ªè¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¸»è¦åšä¸‰ä»¶äº‹æƒ…ï¼š æ¿€æ´» Aware æ–¹æ³• åç½®å¤„ç†å™¨çš„åº”ç”¨ æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³• protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) &#123; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; // æ¿€æ´» Aware æ–¹æ³• invokeAwareMethods(beanName, bean); return null; &#125;, getAccessControlContext()); &#125; else &#123; // å¯¹ç‰¹æ®Šçš„ bean å¤„ç†ï¼šAwareã€BeanClassLoaderAwareã€BeanFactoryAware invokeAwareMethods(beanName, bean); &#125; Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; // åå¤„ç†å™¨ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; // æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ init æ–¹æ³• invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; // åå¤„ç†å™¨ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡æ— è®ºæ˜¯ä»å•ä¾‹ç¼“å­˜ä¸­è·å–çš„ bean å®ä¾‹ è¿˜æ˜¯é€šè¿‡ createBean() åˆ›å»ºçš„ bean å®ä¾‹ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ getObjectForBeanInstance() ï¼Œè¯¥æ–¹æ³•æ˜¯æ ¹æ®ä¼ å…¥çš„ bean å®ä¾‹è·å–å¯¹è±¡ï¼ŒæŒ‰ç…§ Spring çš„ä¼ ç»Ÿï¼Œè¯¥æ–¹æ³•ä¹Ÿåªæ˜¯åšä¸€äº›æ£€æµ‹å·¥ä½œï¼ŒçœŸæ­£çš„å®ç°é€»è¾‘æ˜¯å§”æ‰˜ç»™ getObjectFromFactoryBean() å®ç°ã€‚ protected Object getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess) &#123; // ä¸ºå•ä¾‹æ¨¡å¼ä¸”ç¼“å­˜ä¸­å­˜åœ¨ if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123; synchronized (getSingletonMutex()) &#123; // ä»ç¼“å­˜ä¸­è·å–æŒ‡å®šçš„ factoryBean Object object = this.factoryBeanObjectCache.get(beanName); if (object == null) &#123; // ä¸ºç©ºï¼Œåˆ™ä» FactoryBean ä¸­è·å–å¯¹è±¡ object = doGetObjectFromFactoryBean(factory, beanName); // ä»ç¼“å­˜ä¸­è·å– Object alreadyThere = this.factoryBeanObjectCache.get(beanName); // **æˆ‘å®åœ¨æ˜¯ä¸æ˜ç™½è¿™é‡Œè¿™ä¹ˆåšçš„åŸå› ï¼Œè¿™é‡Œæ˜¯å¹²å˜›ï¼Ÿï¼Ÿï¼Ÿ** if (alreadyThere != null) &#123; object = alreadyThere; &#125; else &#123; // éœ€è¦åç»­å¤„ç† if (shouldPostProcess) &#123; // è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ if (isSingletonCurrentlyInCreation(beanName)) &#123; return object; &#125; // å‰ç½®å¤„ç† beforeSingletonCreation(beanName); try &#123; // å¯¹ä» FactoryBean è·å–çš„å¯¹è±¡è¿›è¡Œåå¤„ç† // ç”Ÿæˆçš„å¯¹è±¡å°†æš´éœ²ç»™beanå¼•ç”¨ object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;, ex); &#125; finally &#123; // åç½®å¤„ç† afterSingletonCreation(beanName); &#125; &#125; // ç¼“å­˜ if (containsSingleton(beanName)) &#123; this.factoryBeanObjectCache.put(beanName, object); &#125; &#125; &#125; return object; &#125; &#125; else &#123; // éå•ä¾‹ Object object = doGetObjectFromFactoryBean(factory, beanName); if (shouldPostProcess) &#123; try &#123; object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&#x27;s object failed&quot;, ex); &#125; &#125; return object; &#125;&#125; ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š è‹¥ä¸ºå•ä¾‹ä¸”å•ä¾‹ bean ç¼“å­˜ä¸­å­˜åœ¨ beanNameï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†ï¼ˆè·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼‰ï¼Œå¦åˆ™åˆ™ä» FactoryBean ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ¥å—åç½®å¤„ç†ï¼Œåˆ™è°ƒç”¨ postProcessObjectFromFactoryBean() è¿›è¡Œåç½®å¤„ç†ã€‚ é¦–å…ˆè·å–é”ï¼ˆå…¶å®æˆ‘ä»¬åœ¨å‰é¢ç¯‡å¹…ä¸­å‘ç°äº†å¤§é‡çš„åŒæ­¥é”ï¼Œé”ä½çš„å¯¹è±¡éƒ½æ˜¯ this.singletonObjectsï¼Œ ä¸»è¦æ˜¯å› ä¸ºåœ¨å•ä¾‹æ¨¡å¼ä¸­å¿…é¡»è¦ä¿è¯å…¨å±€å”¯ä¸€ï¼‰ï¼Œç„¶åä» factoryBeanObjectCache ç¼“å­˜ä¸­è·å–å®ä¾‹å¯¹è±¡ objectï¼Œè‹¥ object ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ doGetObjectFromFactoryBean()æ–¹æ³•ä» FactoryBean è·å–å¯¹è±¡ï¼Œå…¶å®å†…éƒ¨å°±æ˜¯è°ƒç”¨ FactoryBean.getObject()ã€‚ å¦‚æœéœ€è¦åç»­å¤„ç†ï¼Œåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼ˆisSingletonCurrentlyInCreationï¼‰ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ è°ƒç”¨ beforeSingletonCreation() è¿›è¡Œåˆ›å»ºä¹‹å‰çš„å¤„ç†ã€‚é»˜è®¤å®ç°å°†è¯¥ bean æ ‡å¿—ä¸ºå½“å‰åˆ›å»ºçš„ã€‚ è°ƒç”¨ postProcessObjectFromFactoryBean() å¯¹ä» FactoryBean è·å–çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯æŒ‰ç…§åŸæ ·ç›´æ¥è¿”å›ï¼Œå…·ä½“å®ç°æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­å®ç°çš„ï¼Œå½“ç„¶å­ç±»ä¹Ÿå¯ä»¥é‡å†™å®ƒï¼Œæ¯”å¦‚åº”ç”¨åç½®å¤„ç† è°ƒç”¨ afterSingletonCreation() è¿›è¡Œåˆ›å»º bean ä¹‹åçš„å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯å°†è¯¥ bean æ ‡è®°ä¸ºä¸å†åœ¨åˆ›å»ºä¸­ã€‚ æœ€ååŠ å…¥åˆ° FactoryBeans ç¼“å­˜ä¸­ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹Beançš„åˆå§‹åŒ–","date":"2020-01-21T03:19:45.000Z","path":"2020/01/21/e8e94997.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2890 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE ä¸€ä¸ª bean ç»å†äº† createBeanInstance() è¢«åˆ›å»ºå‡ºæ¥ï¼Œç„¶ååˆç»è¿‡ä¸€ç•ªå±æ€§æ³¨å…¥ï¼Œä¾èµ–å¤„ç†ï¼Œå†ç»åƒè¾›ä¸‡è‹¦ï¼Œåƒé”¤ç™¾ç‚¼ï¼Œç»ˆäºæœ‰ç‚¹å„¿ bean å®ä¾‹çš„æ ·å­ï¼Œèƒ½å ªå¤§ä»»äº†ï¼Œåªéœ€è¦ç»å†æœ€åä¸€æ­¥å°±ç ´èŒ§æˆè¶äº†ã€‚ è¿™æœ€åä¸€æ­¥å°±æ˜¯åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ initializeBean()ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æˆ‘ä»¬åˆ†æ doCreateBean() ä¸­æœ€åä¸€æ­¥ï¼šåˆå§‹åŒ– beanã€‚ protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) &#123; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; // æ¿€æ´» Aware æ–¹æ³• invokeAwareMethods(beanName, bean); return null; &#125;, getAccessControlContext()); &#125; else &#123; // å¯¹ç‰¹æ®Šçš„ bean å¤„ç†ï¼šAwareã€BeanClassLoaderAwareã€BeanFactoryAware invokeAwareMethods(beanName, bean); &#125; Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; // åå¤„ç†å™¨ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; // æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ init æ–¹æ³• invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; // åå¤„ç†å™¨ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; åˆå§‹åŒ– bean çš„æ–¹æ³•å…¶å®å°±æ˜¯ä¸‰ä¸ªæ­¥éª¤çš„å¤„ç†ï¼Œè€Œè¿™ä¸‰ä¸ªæ­¥éª¤ä¸»è¦è¿˜æ˜¯æ ¹æ®ç”¨æˆ·è®¾å®šçš„æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸‰ä¸ªè¿‡ç¨‹ä¸ºï¼š æ¿€æ´» Aware æ–¹æ³• åç½®å¤„ç†å™¨çš„åº”ç”¨ æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³• æ¿€æ´» Aware æ–¹æ³• Aware ,è‹±æ–‡ç¿»è¯‘æ˜¯æ„è¯†åˆ°çš„ï¼Œæ„ŸçŸ¥çš„ï¼ŒSpring æä¾›äº†è¯¸å¤šç±»ä¼¼xxxxAware çš„æ¥å£ç”¨äºè¾…åŠ© Spring Bean ä»¥ç¼–ç¨‹çš„æ–¹å¼è°ƒç”¨ Spring å®¹å™¨ï¼Œé€šè¿‡å®ç°è¿™äº›æ¥å£ï¼Œå¯ä»¥å¢å¼º Spring Bean çš„åŠŸèƒ½ã€‚ Spring æä¾›äº†å¦‚ä¸‹ç³»åˆ—çš„ Aware æ¥å£ï¼š LoadTimeWeaverAwareï¼šåŠ è½½Spring Beanæ—¶ç»‡å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚AspectJ BeanClassLoaderAwareï¼šåŠ è½½Spring Beançš„ç±»åŠ è½½å™¨ BootstrapContextAwareï¼šèµ„æºé€‚é…å™¨BootstrapContextï¼Œå¦‚JCA,CCI ResourceLoaderAwareï¼šåº•å±‚è®¿é—®èµ„æºçš„åŠ è½½å™¨ BeanFactoryAwareï¼šå£°æ˜BeanFactory PortletConfigAwareï¼šPortletConfig PortletContextAwareï¼šPortletContext ServletConfigAwareï¼šServletConfig ServletContextAwareï¼šServletContext MessageSourceAwareï¼šå›½é™…åŒ– ApplicationEventPublisherAwareï¼šåº”ç”¨äº‹ä»¶ NotificationPublisherAwareï¼šJMXé€šçŸ¥ BeanNameAwareï¼šå£°æ˜Spring Beançš„åå­— invokeAwareMethods() æºç å¦‚ä¸‹ï¼š private void invokeAwareMethods(final String beanName, final Object bean) &#123; if (bean instanceof Aware) &#123; if (bean instanceof BeanNameAware) &#123; ((BeanNameAware) bean).setBeanName(beanName); &#125; if (bean instanceof BeanClassLoaderAware) &#123; ClassLoader bcl = getBeanClassLoader(); if (bcl != null) &#123; ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); &#125; &#125; if (bean instanceof BeanFactoryAware) &#123; ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); &#125; &#125;&#125; è¿™é‡Œä»£ç å°±æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦æ˜¯å¤„ç† BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareã€‚ åç½®å¤„ç†å™¨çš„åº”ç”¨ BeanPostProcessor åœ¨å‰é¢ä»‹ç» bean åŠ è½½çš„è¿‡ç¨‹æ›¾å¤šæ¬¡é‡åˆ°ï¼Œè¿™æ˜¯ Spring ä¸­å¼€æ”¾å¼æ¡†æ¶ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªäº®ç‚¹ã€‚ BeanPostProcessor çš„ä½œç”¨æ˜¯ï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ Spring å®¹å™¨å®Œæˆ Bean çš„å®ä¾‹åŒ–ï¼Œé…ç½®å’Œå…¶ä»–çš„åˆå§‹åŒ–åæ·»åŠ ä¸€äº›è‡ªå·±çš„é€»è¾‘å¤„ç†ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨è¯¥æ¥å£ï¼Œè¿™ä¸ªæ¥å£ç»™ä¸äº†ç”¨æˆ·å……è¶³çš„æƒé™å»æ›´æ”¹æˆ–è€…æ‰©å±• Springï¼Œæ˜¯æˆ‘ä»¬å¯¹ Spring è¿›è¡Œæ‰©å±•å’Œå¢å¼ºå¤„ç†ä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ¥å£ã€‚ public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123; Object current = beanProcessor.postProcessBeforeInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125;@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123; Object current = beanProcessor.postProcessAfterInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; å…¶å®é€»è¾‘å°±æ˜¯é€šè¿‡ getBeanPostProcessors() è·å–å®šä¹‰çš„ BeanPostProcessor ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨å…¶ postProcessBeforeInitialization()ã€postProcessAfterInitialization() è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚ æ¿€æ´»è‡ªå®šä¹‰çš„ init æ–¹æ³• å¦‚æœç†Ÿæ‚‰ &lt;bean&gt; æ ‡ç­¾çš„é…ç½®ï¼Œä¸€å®šä¸ä¼šå¿˜è®° init-method æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ‰§è¡Œå°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ã€‚ protected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd) throws Throwable &#123; // é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦æ˜¯ InitializingBean ï¼Œå¦‚æœæ˜¯çš„è¯éœ€è¦è°ƒç”¨ afterPropertiesSet() boolean isInitializingBean = (bean instanceof InitializingBean); if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; if (System.getSecurityManager() != null) &#123; try &#123; AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123; ((InitializingBean) bean).afterPropertiesSet(); return null; &#125;, getAccessControlContext()); &#125; catch (PrivilegedActionException pae) &#123; throw pae.getException(); &#125; &#125; else &#123; // å±æ€§åˆå§‹åŒ–çš„å¤„ç† ((InitializingBean) bean).afterPropertiesSet(); &#125; &#125; if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123; String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) &amp;&amp; !(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123; // æ¿€æ´»ç”¨æˆ·è‡ªå®šä¹‰çš„ åˆå§‹åŒ–æ–¹æ³• invokeCustomInitMethod(beanName, bean, mbd); &#125; &#125;&#125; é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¸º InitializingBean ï¼Œå¦‚æœæ˜¯çš„è¯éœ€è¦æ‰§è¡Œ afterPropertiesSet()ï¼Œå› ä¸ºæˆ‘ä»¬é™¤äº†å¯ä»¥ä½¿ç”¨ init-method æ¥è‡ªå®šåˆå§‹åŒ–æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥å®ç° InitializingBean æ¥å£ï¼Œè¯¥æ¥å£ä»…æœ‰ä¸€ä¸ª afterPropertiesSet() æ–¹æ³•ï¼Œè€Œä¸¤è€…çš„æ‰§è¡Œå…ˆåé¡ºåºæ˜¯å…ˆ afterPropertiesSet() å init-methodã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹å¾ªç¯ä¾èµ–","date":"2020-01-21T02:41:04.000Z","path":"2020/01/21/7ee1f554.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2887 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE è¿™ç¯‡åˆ†æ doCreateBean() ç¬¬ä¸‰ä¸ªè¿‡ç¨‹ï¼šå¾ªç¯ä¾èµ–å¤„ç†ã€‚ å…¶å®å¾ªç¯ä¾èµ–å¹¶ä¸ä»…ä»…åªæ˜¯åœ¨ doCreateBean() ä¸­å¤„ç†ï¼Œå…¶å®åœ¨æ•´ä¸ªåŠ è½½ bean çš„è¿‡ç¨‹ä¸­éƒ½æœ‰æ¶‰åŠï¼Œæ‰€ä»¥ä¸‹ç¯‡å†…å®¹å¹¶ä¸ä»…ä»…åªå±€é™äº doCreateBean()ï¼Œè€Œæ˜¯ä»æ•´ä¸ª Bean çš„åŠ è½½è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚ ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–å¾ªç¯ä¾èµ–å…¶å®å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œå°±æ˜¯ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„ bean äº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªé—­ç¯ï¼Œå¦‚ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼ŒC ä¾èµ– Aï¼Œå¦‚ä¸‹ï¼š å¾ªç¯ä¾èµ– å…¶å®å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯çš„è¿‡ç¨‹ï¼Œåœ¨åˆå§‹åŒ– A çš„æ—¶å€™å‘ç°å¼•ç”¨äº† Bï¼Œè¿™æ—¶å°±ä¼šå»åˆå§‹åŒ– Bï¼Œç„¶ååˆå‘ç° B å¼•ç”¨ Cï¼Œè·‘å»åˆå§‹åŒ– Cï¼Œåˆå§‹åŒ– C çš„æ—¶å€™å‘ç°å¼•ç”¨äº† Aï¼Œåˆ™åˆä¼šå»åˆå§‹åŒ– Aï¼Œä¾æ¬¡å¾ªç¯æ°¸ä¸é€€å‡ºï¼Œé™¤éæœ‰ç»ˆç»“æ¡ä»¶ã€‚ Spring å¾ªç¯ä¾èµ–çš„åœºæ™¯æœ‰ä¸¤ç§ï¼š æ„é€ å™¨çš„å¾ªç¯ä¾èµ– field å±æ€§çš„å¾ªç¯ä¾èµ– å¯¹äºæ„é€ å™¨çš„å¾ªç¯ä¾èµ–ï¼ŒSpring æ˜¯æ— æ³•è§£å†³çš„ï¼Œåªèƒ½æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸è¡¨ç¤ºå¾ªç¯ä¾èµ–ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åˆ†æçš„éƒ½æ˜¯åŸºäº field å±æ€§çš„å¾ªç¯ä¾èµ–ã€‚ åœ¨åšå®¢ IOC ä¹‹å¼€å¯ bean çš„åŠ è½½ ä¸­æåˆ°ï¼ŒSpring åªè§£å†³ scope ä¸º singleton çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºscope ä¸º prototype çš„ bean Spring æ— æ³•è§£å†³ï¼Œç›´æ¥æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚ ä¸ºä»€ä¹ˆ Spring ä¸å¤„ç† prototype beanï¼Œå…¶å®å¦‚æœç†è§£ Spring æ˜¯å¦‚ä½•è§£å†³ singleton bean çš„å¾ªç¯ä¾èµ–å°±æ˜ç™½äº†ã€‚ è§£å†³å¾ªç¯ä¾èµ–æˆ‘ä»¬å…ˆä»åŠ è½½ bean æœ€åˆå§‹çš„æ–¹æ³• doGetBean() å¼€å§‹ã€‚ åœ¨ doGetBean() ä¸­ï¼Œé¦–å…ˆä¼šæ ¹æ® beanName ä»å•ä¾‹ bean ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥è¿”å›ã€‚ Object sharedInstance = getSingleton(beanName); è°ƒç”¨ getSingleton() æ–¹æ³•ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ï¼Œå¦‚ä¸‹ï¼š protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; synchronized (this.singletonObjects) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; return singletonObject;&#125; è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ä»ä¸‰ä¸ªç¼“å­˜ä¸­è·å–ï¼Œåˆ†åˆ«æ˜¯ï¼šsingletonObjectsã€earlySingletonObjectsã€singletonFactoriesï¼Œä¸‰è€…å®šä¹‰å¦‚ä¸‹ï¼š /** Cache of singleton objects: bean name --&gt; bean instance */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);/** Cache of singleton factories: bean name --&gt; ObjectFactory */private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);/** Cache of early singleton objects: bean name --&gt; bean instance */private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16); æ„ä¹‰å¦‚ä¸‹ï¼š singletonObjectsï¼šå•ä¾‹å¯¹è±¡çš„cache singletonFactories ï¼š å•ä¾‹å¯¹è±¡å·¥å‚çš„cache earlySingletonObjects ï¼šæå‰æš´å…‰çš„å•ä¾‹å¯¹è±¡çš„Cache ä»–ä»¬å°±æ˜¯ Spring è§£å†³ singleton bean å¾ªç¯ä¾èµ–çš„å…³é”®å› ç´ æ‰€åœ¨ï¼Œæˆ‘ç§°ä»–ä»¬ä¸ºä¸‰çº§ç¼“å­˜ï¼Œç¬¬ä¸€çº§ä¸º singletonObjectsï¼Œç¬¬äºŒçº§ä¸º earlySingletonObjectsï¼Œç¬¬ä¸‰çº§ä¸º singletonFactoriesã€‚ è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ getSingleton() çœ‹åˆ°ä»–ä»¬æ˜¯å¦‚ä½•é…åˆçš„ï¼Œè¿™åˆ†æè¯¥æ–¹æ³•ä¹‹å‰ï¼Œæä¸‹å…¶ä¸­çš„ isSingletonCurrentlyInCreation() å’Œ allowEarlyReferenceã€‚ isSingletonCurrentlyInCreation()ï¼šåˆ¤æ–­å½“å‰ singleton bean æ˜¯å¦å¤„äºåˆ›å»ºä¸­ã€‚bean å¤„äºåˆ›å»ºä¸­ä¹Ÿå°±æ˜¯è¯´ bean åœ¨åˆå§‹åŒ–ä½†æ˜¯æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ï¼Œæœ‰ä¸€ä¸ªè¿™æ ·çš„è¿‡ç¨‹å…¶å®å’Œ Spring è§£å†³ bean å¾ªç¯ä¾èµ–çš„ç†å¿µç›¸è¾…ç›¸æˆï¼Œå› ä¸º Spring è§£å†³ singleton bean çš„æ ¸å¿ƒå°±åœ¨äºæå‰æ›å…‰ beanã€‚ allowEarlyReferenceï¼šä»å­—é¢æ„æ€ä¸Šé¢ç†è§£å°±æ˜¯å…è®¸æå‰æ‹¿åˆ°å¼•ç”¨ã€‚å…¶å®çœŸæ­£çš„æ„æ€æ˜¯æ˜¯å¦å…è®¸ä» singletonFactories ç¼“å­˜ä¸­é€šè¿‡ getObject() æ‹¿åˆ°å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·ä¸€ä¸ªå­—æ®µå‘¢ï¼ŸåŸå› å°±åœ¨äº singletonFactories æ‰æ˜¯ Spring è§£å†³ singleton bean çš„è¯€çªæ‰€åœ¨ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­åˆ†æã€‚ getSingleton() æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š é¦–å…ˆä»ä¸€çº§ç¼“å­˜ singletonObjects è·å– å¦‚æœæ²¡æœ‰ä¸”å½“å‰æŒ‡å®šçš„ beanName æ­£åœ¨åˆ›å»ºï¼Œå°±å†ä»äºŒçº§ç¼“å­˜ä¸­ earlySingletonObjects è·å– å¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°ä¸”è¿è¡Œ singletonFactories é€šè¿‡ getObject() è·å–ï¼Œåˆ™ä»ä¸‰çº§ç¼“å­˜ singletonFactories è·å– å¦‚æœè·å–åˆ°åˆ™ï¼Œé€šè¿‡å…¶ getObject() è·å–å¯¹è±¡ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­ ä»ä¸‰çº§ç¼“å­˜ singletonFactories åˆ é™¤ï¼Œå¦‚ä¸‹ï¼š singletonObject = singletonFactory.getObject();this.earlySingletonObjects.put(beanName, singletonObject);this.singletonFactories.remove(beanName); è¿™æ ·å°±ä»ä¸‰çº§ç¼“å­˜å‡çº§åˆ°äºŒçº§ç¼“å­˜äº†ã€‚ ä¸Šé¢æ˜¯ä»ç¼“å­˜ä¸­è·å–ï¼Œä½†æ˜¯ç¼“å­˜ä¸­çš„æ•°æ®ä»å“ªé‡Œæ·»åŠ è¿›æ¥çš„å‘¢ï¼Ÿä¸€ç›´å¾€ä¸‹è·Ÿä¼šå‘ç°åœ¨ doCreateBean() ( AbstractAutowireCapableBeanFactory ) ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName));if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));&#125; å¦‚æœ earlySingletonExposure == true çš„è¯ï¼Œåˆ™è°ƒç”¨ addSingletonFactory() å°†ä»–ä»¬æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œä½†æ˜¯ä¸€ä¸ª bean è¦å…·å¤‡å¦‚ä¸‹æ¡ä»¶æ‰ä¼šæ·»åŠ è‡³ç¼“å­˜ä¸­ï¼š å•ä¾‹ è¿è¡Œæå‰æš´éœ² bean å½“å‰ bean æ­£åœ¨åˆ›å»ºä¸­ addSingletonFactory() ä»£ç å¦‚ä¸‹ï¼š protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;); synchronized (this.singletonObjects) &#123; if (!this.singletonObjects.containsKey(beanName)) &#123; this.singletonFactories.put(beanName, singletonFactory); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName); &#125; &#125;&#125; ä»è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡º singletonFactories è¿™ä¸ªä¸‰çº§ç¼“å­˜æ‰æ˜¯è§£å†³ Spring Bean å¾ªç¯ä¾èµ–çš„è¯€çªæ‰€åœ¨ã€‚ åŒæ—¶è¿™æ®µä»£ç å‘ç”Ÿåœ¨ createBeanInstance() æ–¹æ³•ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª bean å…¶å®å·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†ï¼Œä½†æ˜¯å®ƒè¿˜ä¸æ˜¯å¾ˆå®Œç¾ï¼ˆæ²¡æœ‰è¿›è¡Œå±æ€§å¡«å……å’Œåˆå§‹åŒ–ï¼‰ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–ä¾èµ–å®ƒçš„å¯¹è±¡è€Œè¨€å·²ç»è¶³å¤Ÿäº†ï¼ˆå¯ä»¥æ ¹æ®å¯¹è±¡å¼•ç”¨å®šä½åˆ°å †ä¸­å¯¹è±¡ï¼‰ï¼Œèƒ½å¤Ÿè¢«è®¤å‡ºæ¥äº†ï¼Œæ‰€ä»¥ Spring åœ¨è¿™ä¸ªæ—¶å€™é€‰æ‹©å°†è¯¥å¯¹è±¡æå‰æ›å…‰å‡ºæ¥è®©å¤§å®¶è®¤è¯†è®¤è¯†ã€‚ ä»‹ç»åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ä¸‰çº§ç¼“å­˜ singletonFactories å’Œ äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­çš„å€¼éƒ½æœ‰å‡ºå¤„äº†ï¼Œé‚£ä¸€çº§ç¼“å­˜åœ¨å“ªé‡Œè®¾ç½®çš„å‘¢ï¼Ÿåœ¨ç±» DefaultSingletonBeanRegistry ä¸­å¯ä»¥å‘ç°è¿™ä¸ª addSingleton() æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š protected void addSingleton(String beanName, Object singletonObject) &#123; synchronized (this.singletonObjects) &#123; this.singletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName); &#125;&#125; æ·»åŠ è‡³ä¸€çº§ç¼“å­˜ï¼ŒåŒæ—¶ä»äºŒçº§ã€ä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤ã€‚è¿™ä¸ªæ–¹æ³•åœ¨æˆ‘ä»¬åˆ›å»º bean çš„é“¾è·¯ä¸­æœ‰å“ªä¸ªåœ°æ–¹å¼•ç”¨å‘¢ï¼Ÿ åœ¨ doGetBean() å¤„ç†ä¸åŒ scope æ—¶ï¼Œå¦‚æœæ˜¯ singletonï¼Œåˆ™è°ƒç”¨ getSingleton()ï¼Œå¦‚ä¸‹ï¼š å‰é¢å‡ ç¯‡åšå®¢å·²ç»åˆ†æäº† createBean()ï¼Œè¿™é‡Œå°±ä¸å†é˜è¿°äº†ï¼Œæˆ‘ä»¬å…³æ³¨æ–¹æ³• getSingleton() ä»£ç å¦‚ä¸‹ï¼š public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(beanName, &quot;Bean name must not be null&quot;); synchronized (this.singletonObjects) &#123; Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; //.... try &#123; singletonObject = singletonFactory.getObject(); newSingleton = true; &#125; //..... if (newSingleton) &#123; addSingleton(beanName, singletonObject); &#125; &#125; return singletonObject; &#125;&#125; è‡³æ­¤ï¼ŒSpring å…³äº singleton bean å¾ªç¯ä¾èµ–å·²ç»åˆ†æå®Œæ¯•äº†ã€‚ æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥ç¡®å®š Spring è§£å†³å¾ªç¯ä¾èµ–çš„æ–¹æ¡ˆäº†ï¼š Spring åœ¨åˆ›å»º bean çš„æ—¶å€™å¹¶ä¸æ˜¯ç­‰å®ƒå®Œå…¨å®Œæˆï¼Œè€Œæ˜¯åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å°†åˆ›å»ºä¸­çš„ bean çš„ ObjectFactory æå‰æ›å…‰ï¼ˆå³åŠ å…¥åˆ° singletonFactories ç¼“å­˜ä¸­ï¼‰ï¼Œè¿™æ ·ä¸€æ—¦ä¸‹ä¸€ä¸ª bean åˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ– bean ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ ObjectFactory çš„ getObject() è·å–äº†ï¼Œä¹Ÿå°±æ˜¯ getSingleton() ä¸­çš„ä»£ç ç‰‡æ®µäº†ã€‚ åˆ°è¿™é‡Œï¼Œå…³äº Spring è§£å†³ bean å¾ªç¯ä¾èµ–å°±å·²ç»åˆ†æå®Œæ¯•äº†ã€‚ æœ€åæ¥æè¿°ä¸‹å°±ä¸Šé¢é‚£ä¸ªå¾ªç¯ä¾èµ– Spring è§£å†³çš„è¿‡ç¨‹ï¼š é¦–å…ˆ A å®Œæˆåˆå§‹åŒ–ç¬¬ä¸€æ­¥å¹¶å°†è‡ªå·±æå‰æ›å…‰å‡ºæ¥ï¼ˆé€šè¿‡ ObjectFactory å°†è‡ªå·±æå‰æ›å…‰ï¼‰ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±ä¾èµ–å¯¹è±¡ Bï¼Œæ­¤æ—¶å°±ä¼šå»å°è¯• get(B)ï¼Œè¿™ä¸ªæ—¶å€™å‘ç° B è¿˜æ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œç„¶å B å°±èµ°åˆ›å»ºæµç¨‹ï¼Œåœ¨ B åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒåŒæ ·å‘ç°è‡ªå·±ä¾èµ– Cï¼ŒC ä¹Ÿæ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™ C åˆå¼€å§‹åˆå§‹åŒ–è¿›ç¨‹ï¼Œä½†æ˜¯åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­å‘ç°è‡ªå·±ä¾èµ– Aï¼Œäºæ˜¯å°è¯• get(A)ï¼Œè¿™ä¸ªæ—¶å€™ç”±äº A å·²ç»æ·»åŠ è‡³ç¼“å­˜ä¸­ï¼ˆä¸€èˆ¬éƒ½æ˜¯æ·»åŠ è‡³ä¸‰çº§ç¼“å­˜ singletonFactories ï¼‰ï¼Œé€šè¿‡ ObjectFactory æå‰æ›å…‰ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ ObjectFactory.getObject() æ‹¿åˆ° A å¯¹è±¡ï¼ŒC æ‹¿åˆ° A å¯¹è±¡åé¡ºåˆ©å®Œæˆåˆå§‹åŒ–ï¼Œç„¶åå°†è‡ªå·±æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œå›åˆ° B ï¼ŒB ä¹Ÿå¯ä»¥æ‹¿åˆ° C å¯¹è±¡ï¼Œå®Œæˆåˆå§‹åŒ–ï¼ŒA å¯ä»¥é¡ºåˆ©æ‹¿åˆ° B å®Œæˆåˆå§‹åŒ–ã€‚åˆ°è¿™é‡Œæ•´ä¸ªé“¾è·¯å°±å·²ç»å®Œæˆäº†åˆå§‹åŒ–è¿‡ç¨‹äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹å±æ€§å¡«å……","date":"2020-01-20T02:51:28.000Z","path":"2020/01/20/1293fb33.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2885 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE doCreateBean() ä¸»è¦ç”¨äºå®Œæˆ bean çš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸ºå››ä¸ªè¿‡ç¨‹ï¼š ç¬¬ä¸€ä¸ªè¿‡ç¨‹å®ä¾‹åŒ– bean å·²ç»åœ¨å‰é¢ä¸¤ç¯‡åšå®¢åˆ†æå®Œæ¯•äº†ï¼Œè¿™ç¯‡åšå®¢å¼€å§‹åˆ†æ å±æ€§å¡«å……ï¼Œä¹Ÿå°±æ˜¯ populateBean()ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å°† BeanDefinition ä¸­çš„å±æ€§å€¼èµ‹å€¼ç»™ BeanWrapper å®ä¾‹å¯¹è±¡ã€‚ protected void populateBean( ]String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) &#123; // æ²¡æœ‰å®ä¾‹åŒ–å¯¹è±¡ if (bw == null) &#123; // æœ‰å±æ€§æŠ›å‡ºå¼‚å¸¸ if (mbd.hasPropertyValues()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;); &#125; else &#123; // æ²¡æœ‰å±æ€§ç›´æ¥è¿”å› return; &#125; &#125; // åœ¨è®¾ç½®å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼š boolean continueWithPropertyPopulation = true; // bena ä¸æ˜¯&quot;åˆæˆ&quot;çš„ï¼Œå³æœªç”±åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰ // æ˜¯å¦æŒæœ‰ InstantiationAwareBeanPostProcessor if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; // è¿­ä»£æ‰€æœ‰çš„ BeanPostProcessors for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; // å¦‚æœä¸º InstantiationAwareBeanPostProcessor if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // è¿”å›å€¼ä¸ºæ˜¯å¦ç»§ç»­å¡«å…… bean // postProcessAfterInstantiationï¼šå¦‚æœåº”è¯¥åœ¨ beanä¸Šé¢è®¾ç½®å±æ€§åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false // ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯è¿”å›trueï¼Œè¿”å› false çš„è¯ï¼Œ // å°†ä¼šé˜»æ­¢åœ¨æ­¤ Bean å®ä¾‹ä¸Šè°ƒç”¨ä»»ä½•åç»­çš„ InstantiationAwareBeanPostProcessor å®ä¾‹ã€‚ if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123; continueWithPropertyPopulation = false; break; &#125; &#125; &#125; &#125; // å¦‚æœåç»­å¤„ç†å™¨å‘å‡ºåœæ­¢å¡«å……å‘½ä»¤ï¼Œåˆ™ç»ˆæ­¢åç»­æ“ä½œ if (!continueWithPropertyPopulation) &#123; return; &#125; // bean çš„å±æ€§å€¼ PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null); if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; // å°† PropertyValues å°è£…æˆ MutablePropertyValues å¯¹è±¡ // MutablePropertyValues å…è®¸å¯¹å±æ€§è¿›è¡Œç®€å•çš„æ“ä½œï¼Œ // å¹¶æä¾›æ„é€ å‡½æ•°ä»¥æ”¯æŒMapçš„æ·±åº¦å¤åˆ¶å’Œæ„é€ ã€‚ MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // æ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123; autowireByName(beanName, mbd, bw, newPvs); &#125; // æ ¹æ®ç±»å‹è‡ªåŠ¨æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; autowireByType(beanName, mbd, bw, newPvs); &#125; pvs = newPvs; &#125; // æ˜¯å¦å·²ç»æ³¨å†Œäº† InstantiationAwareBeanPostProcessors boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); // æ˜¯å¦éœ€è¦è¿›è¡Œä¾èµ–æ£€æŸ¥ boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE); if (hasInstAwareBpps || needsDepCheck) &#123; if (pvs == null) &#123; pvs = mbd.getPropertyValues(); &#125; // ä» bw å¯¹è±¡ä¸­æå– PropertyDescriptor ç»“æœé›† // PropertyDescriptorï¼šå¯ä»¥é€šè¿‡ä¸€å¯¹å­˜å–æ–¹æ³•æå–ä¸€ä¸ªå±æ€§ PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); if (hasInstAwareBpps) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; // å¯¹æ‰€æœ‰éœ€è¦ä¾èµ–æ£€æŸ¥çš„å±æ€§è¿›è¡Œåå¤„ç† pvs = ibp.postProcessPropertyValues( pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvs == null) &#123; return; &#125; &#125; &#125; &#125; if (needsDepCheck) &#123; // ä¾èµ–æ£€æŸ¥ï¼Œå¯¹åº” depends-on å±æ€§ checkDependencies(beanName, mbd, filteredPds, pvs); &#125; &#125; if (pvs != null) &#123; // å°†å±æ€§åº”ç”¨åˆ° bean ä¸­ applyPropertyValues(beanName, mbd, bw, pvs); &#125;&#125; å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š æ ¹æ® hasInstantiationAwareBeanPostProcessors å±æ€§æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨æ³¨å…¥å±æ€§ä¹‹å‰ç»™ InstantiationAwareBeanPostProcessors æœ€åä¸€æ¬¡æ”¹å˜ bean çš„æœºä¼šï¼Œæ­¤è¿‡ç¨‹å¯ä»¥æ§åˆ¶ Spring æ˜¯å¦ç»§ç»­è¿›è¡Œå±æ€§å¡«å……ã€‚ æ ¹æ®æ³¨å…¥ç±»å‹çš„ä¸åŒæ¥åˆ¤æ–­æ˜¯æ ¹æ®åç§°æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆautowireByName()ï¼‰è¿˜æ˜¯æ ¹æ®ç±»å‹æ¥è‡ªåŠ¨æ³¨å…¥ï¼ˆautowireByType()ï¼‰ï¼Œç»Ÿä¸€å­˜å…¥åˆ° PropertyValues ä¸­ï¼ŒPropertyValues ç”¨äºæè¿° bean çš„å±æ€§ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ BeanPostProcessor å’Œ ä¾èµ–æ£€æµ‹ã€‚ å°†æ‰€æœ‰ PropertyValues ä¸­çš„å±æ€§å¡«å……åˆ° BeanWrapper ä¸­ã€‚ è‡ªåŠ¨æ³¨å…¥Spring ä¼šæ ¹æ®æ³¨å…¥ç±»å‹ï¼ˆ byName / byType ï¼‰çš„ä¸åŒï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼ˆautowireByName() / autowireByType()ï¼‰æ¥æ³¨å…¥å±æ€§å€¼ã€‚ autowireByName() æ–¹æ³• autowireByName() æ˜¯æ ¹æ®å±æ€§åç§°å®Œæˆè‡ªåŠ¨ä¾èµ–æ³¨å…¥çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š protected void autowireByName( String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123; // å¯¹ Bean å¯¹è±¡ä¸­éç®€å•å±æ€§ String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw); for (String propertyName : propertyNames) &#123; // å¦‚æœå®¹å™¨ä¸­åŒ…å«æŒ‡å®šåç§°çš„ beanï¼Œåˆ™å°†è¯¥ bean æ³¨å…¥åˆ° beanä¸­ if (containsBean(propertyName)) &#123; // é€’å½’åˆå§‹åŒ–ç›¸å…³ bean Object bean = getBean(propertyName); // ä¸ºæŒ‡å®šåç§°çš„å±æ€§èµ‹äºˆå±æ€§å€¼ pvs.add(propertyName, bean); // å±æ€§ä¾èµ–æ³¨å…¥ registerDependentBean(propertyName, beanName); if (logger.isDebugEnabled()) &#123; logger.debug( &quot;Added autowiring by name from bean name &#x27;&quot; + beanName + &quot;&#x27; via property &#x27;&quot; + propertyName + &quot;&#x27; to bean named &#x27;&quot; + propertyName + &quot;&#x27;&quot;); &#125; &#125; else &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Not autowiring property &#x27;&quot; + propertyName + &quot;&#x27; of bean &#x27;&quot; + beanName + &quot;&#x27; by name: no matching bean found&quot;); &#125; &#125; &#125;&#125; è¯¥æ–¹æ³•é€»è¾‘å¾ˆç®€å•ï¼Œè·å–è¯¥ bean çš„éç®€å•å±æ€§ï¼Œä»€ä¹ˆå«åšéç®€å•å±æ€§å‘¢ï¼Ÿå°±æ˜¯ç±»å‹ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸æ˜¯å°†æ‰€æœ‰çš„å¯¹è±¡ç±»å‹éƒ½éƒ½ä¼šæ‰¾åˆ°ï¼Œæ¯”å¦‚ 8 ä¸ªåŸå§‹ç±»å‹ï¼ŒString ç±»å‹ ï¼ŒNumberç±»å‹ã€Dateç±»å‹ã€URLç±»å‹ã€URIç±»å‹ç­‰éƒ½ä¼šè¢«å¿½ç•¥ï¼Œå¦‚ä¸‹ï¼š protected String[] unsatisfiedNonSimpleProperties( AbstractBeanDefinition mbd, BeanWrapper bw) &#123; Set&lt;String&gt; result = new TreeSet&lt;&gt;(); PropertyValues pvs = mbd.getPropertyValues(); PropertyDescriptor[] pds = bw.getPropertyDescriptors(); for (PropertyDescriptor pd : pds) &#123; if (pd.getWriteMethod() != null &amp;&amp; !isExcludedFromDependencyCheck(pd) &amp;&amp; !pvs.contains(pd.getName()) &amp;&amp; !BeanUtils.isSimpleProperty(pd.getPropertyType())) &#123; result.add(pd.getName()); &#125; &#125; return StringUtils.toStringArray(result);&#125; è¿‡æ»¤æ¡ä»¶ä¸ºï¼šæœ‰å¯å†™æ–¹æ³•ã€ä¾èµ–æ£€æµ‹ä¸­æ²¡æœ‰è¢«å¿½ç•¥ã€ä¸æ˜¯ç®€å•å±æ€§ç±»å‹ã€‚å…¶å®è¿™é‡Œè·å–çš„å°±æ˜¯éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§ã€‚ è·å–éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§åï¼Œé€šè¿‡è¿­ä»£ã€é€’å½’çš„æ–¹å¼åˆå§‹åŒ–ç›¸å…³çš„ beanï¼Œç„¶åè°ƒç”¨ registerDependentBean() å®Œæˆæ³¨å†Œä¾èµ–ï¼Œå¦‚ä¸‹ï¼š public void registerDependentBean(String beanName, String dependentBeanName) &#123; String canonicalName = canonicalName(beanName); synchronized (this.dependentBeanMap) &#123; Set&lt;String&gt; dependentBeans = this.dependentBeanMap.computeIfAbsent(canonicalName, k -&gt; new LinkedHashSet&lt;&gt;(8)); if (!dependentBeans.add(dependentBeanName)) &#123; return; &#125; &#125; synchronized (this.dependenciesForBeanMap) &#123; Set&lt;String&gt; dependenciesForBean = this.dependenciesForBeanMap.computeIfAbsent(dependentBeanName, k -&gt; new LinkedHashSet&lt;&gt;(8)); dependenciesForBean.add(canonicalName); &#125;&#125; autowireByType() protected void autowireByType( String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123; // è·å– TypeConverter å®ä¾‹ // ä½¿ç”¨è‡ªå®šä¹‰çš„ TypeConverterï¼Œç”¨äºå–ä»£é»˜è®¤çš„ PropertyEditor æœºåˆ¶ TypeConverter converter = getCustomTypeConverter(); if (converter == null) &#123; converter = bw; &#125; Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(4); // è·å–éç®€å•å±æ€§ String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw); for (String propertyName : propertyNames) &#123; try &#123; // è·å– PropertyDescriptor å®ä¾‹ PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName); // ä¸è¦å°è¯•æŒ‰ç±»å‹ if (Object.class != pd.getPropertyType()) &#123; // æ¢æµ‹æŒ‡å®šå±æ€§çš„ set æ–¹æ³• MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd); boolean eager = !PriorityOrdered.class.isInstance(bw.getWrappedInstance()); DependencyDescriptor desc = new AbstractAutowireCapableBeanFactory .AutowireByTypeDependencyDescriptor(methodParam, eager); // è§£ææŒ‡å®š beanName çš„å±æ€§æ‰€åŒ¹é…çš„å€¼ï¼Œå¹¶æŠŠè§£æåˆ°çš„å±æ€§åç§°å­˜å‚¨åœ¨ autowiredBeanNames ä¸­ // å½“å±æ€§å­˜åœ¨è¿‡ä¸ªå°è£… bean æ—¶å°†ä¼šæ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ bean å¹¶å°†å…¶æ³¨å…¥ Object autowiredArgument = resolveDependency(desc, beanName, autowiredBeanNames, converter); if (autowiredArgument != null) &#123; pvs.add(propertyName, autowiredArgument); &#125; // è¿­ä»£æ–¹å¼æ³¨å…¥ bean for (String autowiredBeanName : autowibeanredBeanNames) &#123; registerDependentBean(autowiredBeanName, beanName); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Autowiring by type from bean name &#x27;&quot; + beanName + &quot;&#x27; via property &#x27;&quot; + propertyName + &quot;&#x27; to bean named &#x27;&quot; + autowiredBeanName + &quot;&#x27;&quot;); &#125; &#125; autowiredBeanNames.clear(); &#125; &#125; catch (BeansException ex) &#123; throw new UnsatisfiedDependencyException( mbd.getResourceDescription(), beanName, propertyName, ex); &#125; &#125;&#125; å…¶å®ä¸»è¦è¿‡ç¨‹å’Œæ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥å·®ä¸å¤šéƒ½æ˜¯æ‰¾åˆ°éœ€è¦ä¾èµ–æ³¨å…¥çš„å±æ€§ï¼Œç„¶åé€šè¿‡è¿­ä»£çš„æ–¹å¼å¯»æ‰¾æ‰€åŒ¹é…çš„ beanï¼Œæœ€åè°ƒç”¨ registerDependentBean() æ³¨å†Œä¾èµ–ã€‚ä¸è¿‡ç›¸å¯¹äº autowireByName() è€Œè¨€ï¼Œæ ¹æ®ç±»å‹å¯»æ‰¾ç›¸åŒ¹é…çš„ bean è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢æˆ‘ä»¬å°±åˆ†æè¿™ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š public Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName, @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException &#123; // åˆå§‹åŒ–å‚æ•°åç§°å‘ç°å™¨ï¼Œè¯¥æ–¹æ³•å¹¶ä¸ä¼šåœ¨è¿™ä¸ªæ—¶å€™å°è¯•æ£€ç´¢å‚æ•°åç§° // getParameterNameDiscoverer è¿”å› parameterNameDiscoverer å®ä¾‹ï¼ŒparameterNameDiscoverer æ–¹æ³•å‚æ•°åç§°çš„è§£æå™¨ descriptor.initParameterNameDiscovery(getParameterNameDiscoverer()); // ä¾èµ–ç±»å‹ä¸º Optional ç±»å‹ if (Optional.class == descriptor.getDependencyType()) &#123; // åˆ›å»º Optional å®ä¾‹ä¾èµ–ç±»å‹ return createOptionalDependency(descriptor, requestingBeanName); &#125; // ä¾èµ–ç±»å‹ä¸ºObjectFactoryã€ObjectProvider else if (ObjectFactory.class == descriptor.getDependencyType() || ObjectProvider.class == descriptor.getDependencyType()) &#123; // ObjectFactory / ObjectProvider ç”¨äº ç”¨äºå»¶è¿Ÿè§£æä¾èµ–é¡¹ return new DefaultListableBeanFactory.DependencyObjectProvider(descriptor, requestingBeanName); &#125; else if (javaxInjectProviderClass == descriptor.getDependencyType()) &#123; // javaxInjectProviderClass ç±»æ³¨å…¥çš„ç‰¹æ®Šå¤„ç† return new DefaultListableBeanFactory.Jsr330ProviderFactory().createDependencyProvider(descriptor, requestingBeanName); &#125; else &#123; // ä¸ºå®é™…ä¾èµ–å…³ç³»ç›®æ ‡çš„å»¶è¿Ÿè§£ææ„å»ºä»£ç† // é»˜è®¤å®ç°è¿”å› null Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary( descriptor, requestingBeanName); if (result == null) &#123; // é€šç”¨å¤„ç†é€»è¾‘ result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter); &#125; return result; &#125;&#125; è¿™é‡Œæˆ‘ä»¬å…³æ³¨é€šç”¨å¤„ç†é€»è¾‘ï¼šdoResolveDependency()ï¼Œå¦‚ä¸‹ï¼š public Object doResolveDependency( DependencyDescriptor descriptor, @Nullable String beanName, @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException &#123; // æ³¨å…¥ç‚¹ InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor); try &#123; // é’ˆå¯¹ç»™å®šçš„å·¥å‚ç»™å®šä¸€ä¸ªå¿«æ·å®ç°çš„æ–¹å¼ï¼Œä¾‹å¦‚è€ƒè™‘ä¸€äº›é¢„å…ˆè§£æçš„ä¿¡æ¯ // åœ¨è¿›å…¥æ‰€æœ‰beançš„å¸¸è§„ç±»å‹åŒ¹é…ç®—æ³•ä¹‹å‰ï¼Œè§£æç®—æ³•å°†é¦–å…ˆå°è¯•é€šè¿‡æ­¤æ–¹æ³•è§£æå¿«æ·æ–¹å¼ã€‚ // å­ç±»å¯ä»¥è¦†ç›–æ­¤æ–¹æ³• Object shortcut = descriptor.resolveShortcut(this); if (shortcut != null) &#123; // è¿”å›å¿«æ·çš„è§£æä¿¡æ¯ return shortcut; &#125; // ä¾èµ–çš„ç±»å‹ Class&lt;?&gt; type = descriptor.getDependencyType(); // æ”¯æŒ Spring çš„æ³¨è§£ @value Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor); if (value != null) &#123; if (value instanceof String) &#123; String strVal = resolveEmbeddedValue((String) value); BeanDefinition bd = (beanName != null &amp;&amp; containsBean(beanName) ? getMergedBeanDefinition(beanName) : null); value = evaluateBeanDefinitionString(strVal, bd); &#125; TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter()); return (descriptor.getField() != null ? converter.convertIfNecessary(value, type, descriptor.getField()) : converter.convertIfNecessary(value, type, descriptor.getMethodParameter())); &#125; // è§£æå¤åˆ beanï¼Œå…¶å®å°±æ˜¯å¯¹ bean çš„å±æ€§è¿›è¡Œè§£æ // åŒ…æ‹¬ï¼šæ•°ç»„ã€Collection ã€Map ç±»å‹ Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter); if (multipleBeans != null) &#123; return multipleBeans; &#125; // æŸ¥æ‰¾ä¸ç±»å‹ç›¸åŒ¹é…çš„ bean // è¿”å›å€¼æ„æˆä¸ºï¼škey = åŒ¹é…çš„ beanNameï¼Œvalue = beanName å¯¹åº”çš„å®ä¾‹åŒ– bean Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor); // æ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€éªŒ @autowire çš„ require æ˜¯å¦ä¸º true if (matchingBeans.isEmpty()) &#123; // å¦‚æœ @autowire çš„ require å±æ€§ä¸º true ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„åŒ¹é…é¡¹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if (isRequired(descriptor)) &#123; raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor); &#125; return null; &#125; String autowiredBeanName; Object instanceCandidate; if (matchingBeans.size() &gt; 1) &#123; // ç¡®è®¤ç»™å®š bean autowire çš„å€™é€‰è€… // æŒ‰ç…§ @Primary å’Œ @Priority çš„é¡ºåº autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor); if (autowiredBeanName == null) &#123; if (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123; // å”¯ä¸€æ€§å¤„ç† return descriptor.resolveNotUnique(type, matchingBeans); &#125; else &#123; // åœ¨å¯é€‰çš„Collection / Mapçš„æƒ…å†µä¸‹ï¼Œ // é»˜é»˜åœ°å¿½ç•¥ä¸€ä¸ªéå”¯ä¸€çš„æƒ…å†µï¼šå¯èƒ½å®ƒæ˜¯ä¸€ä¸ªå¤šä¸ªå¸¸è§„beançš„ç©ºé›†åˆ return null; &#125; &#125; instanceCandidate = matchingBeans.get(autowiredBeanName); &#125; else &#123; // We have exactly one match. Map.Entry&lt;Staring, Object&gt; entry = matchingBeans.entrySet().iterator().next(); autowiredBeanName = entry.getKey(); instanceCandidate = entry.getValue(); &#125; if (autowiredBeanNames != null) &#123; autowiredBeanNames.add(autowiredBeanName); &#125; if (instanceCandidate instanceof Class) &#123; instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this); &#125; Object result = instanceCandidate; if (result instanceof NullBean) &#123; if (isRequired(descriptor)) &#123; raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor); &#125; result = null; &#125; if (!ClassUtils.isAssignableValue(type, result)) &#123; throw new BeanNotOfRequiredTypeException( autowiredBeanName, type, instanceCandidate.getClass()); &#125; return result; &#125; finally &#123; ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint); &#125;&#125; åˆ°è¿™é‡Œå°±å·²ç»å®Œæˆäº†æ‰€æœ‰å±æ€§çš„æ³¨å…¥äº†ã€‚populateBean() è¯¥æ–¹æ³•å°±å·²ç»å®Œæˆäº†ä¸€å¤§åŠå·¥ä½œäº†ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯å¯¹ä¾èµ– bean çš„æ£€æµ‹å’Œ PostProcessor å¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢åˆ†æï¼Œä¸‹é¢åˆ†æè¯¥æ–¹æ³•çš„æœ€åä¸€æ­¥ï¼šapplyPropertyValues() applyPropertyValueså…¶å®ä¸Šé¢åªæ˜¯å®Œæˆäº†æ‰€æœ‰æ³¨å…¥å±æ€§çš„è·å–ï¼Œå°†è·å–çš„å±æ€§å°è£…åœ¨ PropertyValues çš„å®ä¾‹å¯¹è±¡ pvs ä¸­ï¼Œå¹¶æ²¡æœ‰åº”ç”¨åˆ°å·²ç»å®ä¾‹åŒ–çš„ bean ä¸­ï¼Œè€Œ applyPropertyValues() åˆ™æ˜¯å®Œæˆè¿™ä¸€æ­¥éª¤çš„ã€‚ protected void applyPropertyValues( String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123; if (pvs.isEmpty()) &#123; return; &#125; if (System.getSecurityManager() != null &amp;&amp; bw instanceof BeanWrapperImpl) &#123; ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext()); &#125; // MutablePropertyValues ç±»å‹å±æ€§ MutablePropertyValues mpvs = null; // åŸå§‹ç±»å‹ List&lt;PropertyValue&gt; original; if (pvs instanceof MutablePropertyValues) &#123; mpvs = (MutablePropertyValues) pvs; if (mpvs.isConverted()) &#123; try &#123; // è®¾ç½®åˆ° BeanWrapper ä¸­å» bw.setPropertyValues(mpvs); return; &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); &#125; &#125; original = mpvs.getPropertyValueList(); &#125; else &#123; // å¦‚æœ pvs ä¸æ˜¯ MutablePropertyValues ç±»å‹ï¼Œåˆ™ç›´æ¥ä½¿ç”¨åŸå§‹ç±»å‹ original = Arrays.asList(pvs.getPropertyValues()); &#125; // è·å– TypeConverter TypeConverter converter = getCustomTypeConverter(); if (converter == null) &#123; converter = bw; &#125; // è·å–å¯¹åº”çš„è§£æå™¨ BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter); // Create a deep copy, resolving any references for values. List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;&gt;(original.size()); boolean resolveNecessary = false; // éå†å±æ€§ï¼Œå°†å±æ€§è½¬æ¢ä¸ºå¯¹åº”ç±»çš„å¯¹åº”å±æ€§çš„ç±»å‹ for (PropertyValue pv : original) &#123; if (pv.isConverted()) &#123; deepCopy.add(pv); &#125; else &#123; String propertyName = pv.getName(); Object originalValue = pv.getValue(); Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue); Object convertedValue = resolvedValue; boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp; !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName); if (convertible) &#123; convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter); &#125; // Possibly store converted value in merged bean definition, // in order to avoid re-conversion for every created bean instance. if (resolvedValue == originalValue) &#123; if (convertible) &#123; pv.setConvertedValue(convertedValue); &#125; deepCopy.add(pv); &#125; else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp; !((TypedStringValue) originalValue).isDynamic() &amp;&amp; !(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) &#123; pv.setConvertedValue(convertedValue); deepCopy.add(pv); &#125; else &#123; resolveNecessary = true; deepCopy.add(new PropertyValue(pv, convertedValue)); &#125; &#125; &#125; if (mpvs != null &amp;&amp; !resolveNecessary) &#123; mpvs.setConverted(); &#125; // Set our (possibly massaged) deep copy. try &#123; bw.setPropertyValues(new MutablePropertyValues(deepCopy)); &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); &#125;&#125; è‡³æ­¤ï¼ŒdoCreateBean() ç¬¬äºŒä¸ªè¿‡ç¨‹ï¼šå±æ€§å¡«å…… å·²ç»åˆ†æå®Œæˆäº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ„é€ å‡½æ•°å®ä¾‹åŒ–bean","date":"2020-01-20T01:20:08.000Z","path":"2020/01/20/cdc6fa32.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2850 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE createBeanInstance() ç”¨äºå®ä¾‹åŒ– beanï¼Œå®ƒä¼šæ ¹æ®ä¸åŒæƒ…å†µé€‰æ‹©ä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥æ¥å®Œæˆ bean çš„åˆå§‹åŒ–ï¼Œä¸»è¦åŒ…æ‹¬ï¼š Supplier å›è°ƒï¼šobtainFromSupplier() å·¥å‚æ–¹æ³•åˆå§‹åŒ–ï¼šinstantiateUsingFactoryMethod() æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ï¼šautowireConstructor() é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ï¼šinstantiateBean() åœ¨( IOC ä¹‹ Factory å®ä¾‹åŒ– bean) ä¸­åˆ†æäº† Supplier å›è°ƒå’Œå·¥å‚æ–¹æ³•åˆå§‹åŒ–ï¼Œè¿™ç¯‡åˆ†æä¸¤ä¸ªæ„é€ å‡½æ•°æ³¨å…¥ã€‚ autowireConstructor()è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•æˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸ºæ˜¯å¸¦æœ‰å‚æ•°çš„åˆå§‹åŒ– bean ã€‚ä»£ç æ®µå¦‚ä¸‹ï¼š public BeanWrapper autowireConstructor( final String beanName, final RootBeanDefinition mbd, @Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable final Object[] explicitArgs) &#123; // å°è£… BeanWrapperImpl å¹¶å®Œæˆåˆå§‹åŒ– BeanWrapperImpl bw = new BeanWrapperImpl(); this.beanFactory.initBeanWrapper(bw); // æ„é€ å‡½æ•° Constructor&lt;?&gt; constructorToUse = null; // æ„é€ å‚æ•° ArgumentsHolder argsHolderToUse = null; Object[] argsToUse = null; /* * ç¡®å®šæ„é€ å‚æ•° */ // å¦‚æœ getBean() å·²ç»ä¼ é€’ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ if (explicitArgs != null) &#123; argsToUse = explicitArgs; &#125; else &#123; /* * å°è¯•ä»ç¼“å­˜ä¸­è·å– */ Object[] argsToResolve = null; synchronized (mbd.constructorArgumentLock) &#123; // ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³• constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod; if (constructorToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123; // ç¼“å­˜ä¸­çš„æ„é€ å‚æ•° argsToUse = mbd.resolvedConstructorArguments; if (argsToUse == null) &#123; argsToResolve = mbd.preparedConstructorArguments; &#125; &#125; &#125; // ç¼“å­˜ä¸­å­˜åœ¨,åˆ™è§£æå­˜å‚¨åœ¨ BeanDefinition ä¸­çš„å‚æ•° // å¦‚ç»™å®šæ–¹æ³•çš„æ„é€ å‡½æ•° A(int ,int )ï¼Œåˆ™é€šè¿‡æ­¤æ–¹æ³•åå°±ä¼šæŠŠé…ç½®æ–‡ä»¶ä¸­çš„(&quot;1&quot;,&quot;1&quot;)è½¬æ¢ä¸º (1,1) // ç¼“å­˜ä¸­çš„å€¼å¯èƒ½æ˜¯åŸå§‹å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼ if (argsToResolve != null) &#123; argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve); &#125; &#125; /* * æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™å°è¯•ä»é…ç½®æ–‡ä»¶ä¸­è·å– */ if (constructorToUse == null) &#123; // æ˜¯å¦éœ€è¦è§£ææ„é€ å™¨ boolean autowiring = ( chosenCtors != null || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR); // ç”¨äºæ‰¿è½½è§£æåçš„æ„é€ å‡½æ•°å‚æ•°çš„å€¼ ConstructorArgumentValues resolvedValues = null; int minNrOfArgs; if (explicitArgs != null) &#123; minNrOfArgs = explicitArgs.length; &#125; else &#123; // ä» BeanDefinition ä¸­è·å–æ„é€ å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä»é…ç½®æ–‡ä»¶ä¸­æå–æ„é€ å‚æ•° ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues(); resolvedValues = new ConstructorArgumentValues(); // è§£ææ„é€ å‡½æ•°çš„å‚æ•° // å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues); &#125; /* * è·å–æŒ‡å®šçš„æ„é€ å‡½æ•° */ // æ ¹æ®å‰é¢çš„åˆ¤æ–­ï¼ŒchosenCtors åº”è¯¥ä¸º null Constructor&lt;?&gt;[] candidates = chosenCtors; if (candidates == null) &#123; // è·å– bean çš„ class Class&lt;?&gt; beanClass = mbd.getBeanClass(); try &#123; // æ ¹æ® class è·å–æ‰€æœ‰çš„æ„é€ å‡½æ•° candidates = (mbd.isNonPublicAccessAllowed() ? beanClass.getDeclaredConstructors() : beanClass.getConstructors()); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Resolution of declared constructors on bean Class [&quot; + beanClass.getName() + &quot;] from ClassLoader [&quot; + beanClass.getClassLoader() + &quot;] failed&quot;, ex); &#125; &#125; // å¯¹æ„é€ å‡½æ•°è¿›è¡Œæ’åºå¤„ç† // public æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºï¼Œépublic æ„é€ å‡½æ•°å‚æ•°æ•°é‡é™åº AutowireUtils.sortConstructors(candidates); // æœ€å°å‚æ•°ç±»å‹æƒé‡ int minTypeDiffWeight = Integer.MAX_VALUE; Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = null; LinkedList&lt;UnsatisfiedDependencyException&gt; causes = null; // è¿­ä»£æ‰€æœ‰æ„é€ å‡½æ•° for (Constructor&lt;?&gt; candidate : candidates) &#123; // è·å–è¯¥æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹ Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes(); // å¦‚æœå·²ç»æ‰¾åˆ°é€‰ç”¨çš„æ„é€ å‡½æ•°æˆ–è€…éœ€è¦çš„å‚æ•°ä¸ªæ•°å°äºå½“å‰çš„æ„é€ å‡½æ•°å‚æ•°ä¸ªæ•°ï¼Œåˆ™ç»ˆæ­¢ // å› ä¸ºå·²ç»æŒ‰ç…§å‚æ•°ä¸ªæ•°é™åºæ’åˆ—äº† if (constructorToUse != null &amp;&amp; argsToUse.length &gt; paramTypes.length) &#123; break; &#125; // å‚æ•°ä¸ªæ•°ä¸ç­‰ï¼Œç»§ç»­ if (paramTypes.length &lt; minNrOfArgs) &#123; continue; &#125; // å‚æ•°æŒæœ‰è€… ArgumentsHolder argsHolder; // æœ‰å‚æ•° if (resolvedValues != null) &#123; try &#123; // æ³¨é‡Šä¸Šè·å–å‚æ•°åç§° String[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, paramTypes.length); if (paramNames == null) &#123; // è·å–æ„é€ å‡½æ•°ã€æ–¹æ³•å‚æ•°çš„æ¢æµ‹å™¨ ParameterNameDiscoverer pnd = this.beanFactory.getParameterNameDiscoverer(); if (pnd != null) &#123; // é€šè¿‡æ¢æµ‹å™¨è·å–æ„é€ å‡½æ•°çš„å‚æ•°åç§° paramNames = pnd.getParameterNames(candidate); &#125; &#125; // æ ¹æ®æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°åˆ›å»ºå‚æ•°æŒæœ‰è€… argsHolder = createArgumentArray( beanName, mbd, resolvedValues, bw, paramTypes, paramNames, getUserDeclaredConstructor(candidate), autowiring); &#125; catch (UnsatisfiedDependencyException ex) &#123; if (this.beanFactory.logger.isTraceEnabled()) &#123; this.beanFactory.logger.trace( &quot;Ignoring constructor [&quot; + candidate + &quot;] of bean &#x27;&quot; + beanName + &quot;&#x27;: &quot; + ex); &#125; // Swallow and try next constructor. if (causes == null) &#123; causes = new LinkedList&lt;&gt;(); &#125; causes.add(ex); continue; &#125; &#125; else &#123; // æ„é€ å‡½æ•°æ²¡æœ‰å‚æ•° if (paramTypes.length != explicitArgs.length) &#123; continue; &#125; argsHolder = new ArgumentsHolder(explicitArgs); &#125; // isLenientConstructorResolution åˆ¤æ–­è§£ææ„é€ å‡½æ•°çš„æ—¶å€™æ˜¯å¦ä»¥å®½æ¾æ¨¡å¼è¿˜æ˜¯ä¸¥æ ¼æ¨¡å¼ // ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰çš„éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ // å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰&quot;æœ€æ¥è¿‘çš„æ¨¡å¼&quot;è¿›è¡ŒåŒ¹é… // typeDiffWeightï¼šç±»å‹å·®å¼‚æƒé‡ int typeDiffWeight = (mbd.isLenientConstructorResolution() ? argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes)); // å¦‚æœå®ƒä»£è¡¨ç€å½“å‰æœ€æ¥è¿‘çš„åŒ¹é…åˆ™é€‰æ‹©å…¶ä½œä¸ºæ„é€ å‡½æ•° if (typeDiffWeight &lt; minTypeDiffWeight) &#123; constructorToUse = candidate; argsHolderToUse = argsHolder; argsToUse = argsHolder.arguments; minTypeDiffWeight = typeDiffWeight; ambiguousConstructors = null; &#125; else if (constructorToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123; if (ambiguousConstructors == null) &#123; ambiguousConstructors = new LinkedHashSet&lt;&gt;(); ambiguousConstructors.add(constructorToUse); &#125; ambiguousConstructors.add(candidate); &#125; &#125; if (constructorToUse == null) &#123; if (causes != null) &#123; UnsatisfiedDependencyException ex = causes.removeLast(); for (Exception cause : causes) &#123; this.beanFactory.onSuppressedException(cause); &#125; throw ex; &#125; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Could not resolve matching constructor &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;); &#125; else if (ambiguousConstructors != null &amp;&amp; !mbd.isLenientConstructorResolution()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Ambiguous constructor matches found in bean &#x27;&quot; + beanName + &quot;&#x27; &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot; + ambiguousConstructors); &#125; // å°†æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ä¿å­˜åˆ°ç¼“å­˜ä¸­ if (explicitArgs == null) &#123; argsHolderToUse.storeCache(mbd, constructorToUse); &#125; &#125; try &#123; // è·å–åˆ›å»º bean çš„ç­–ç•¥ final InstantiationStrategy strategy = beanFactory.getInstantiationStrategy(); Object beanInstance; if (System.getSecurityManager() != null) &#123; final Constructor&lt;?&gt; ctorToUse = constructorToUse; final Object[] argumentsToUse = argsToUse; // å®ä¾‹åŒ– bean beanInstance = AccessController.doPrivileged( (PrivilegedAction&lt;Object&gt;) () -&gt; strategy.instantiate(mbd, beanName, beanFactory, ctorToUse, argumentsToUse), beanFactory.getAccessControlContext()); &#125; else &#123; // å®ä¾‹åŒ–bean beanInstance = strategy.instantiate( mbd, beanName, this.beanFactory, constructorToUse, argsToUse); &#125; // å°†æ„é€ çš„ bean åŠ å…¥åˆ° BeanWrapper å®ä¾‹ä¸­ bw.setBeanInstance(beanInstance); return bw; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Bean instantiation via constructor failed&quot;, ex); &#125;&#125; ä»£ç ä¸ instantiateUsingFactoryMethod() ä¸€æ ·ï¼Œåˆé•¿åˆéš¾æ‡‚ï¼Œä½†æ˜¯å¦‚æœç†è§£äº† instantiateUsingFactoryMethod() åˆå§‹åŒ– bean çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆ autowireConstructor() ä¹Ÿä¸å­˜åœ¨ä»€ä¹ˆéš¾çš„åœ°æ–¹äº†ï¼Œä¸€å¥è¯æ¦‚æ‹¬ï¼šé¦–å…ˆç¡®å®šæ„é€ å‡½æ•°å‚æ•°ã€æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„åˆå§‹åŒ–ç­–ç•¥è¿›è¡Œ bean çš„åˆå§‹åŒ–ã€‚å…³äºå¦‚ä½•ç¡®å®šæ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ï¼Œè¯¥éƒ¨åˆ†é€»è¾‘å’Œ instantiateUsingFactoryMethod() åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†é‡å¤é˜è¿°äº†ï¼Œå…·ä½“è¿‡ç¨‹è¯·ç§»æ­¥IOC ä¹‹ Factory å®ä¾‹åŒ– beanï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹åˆ†æåˆå§‹åŒ–ç­–ç•¥ã€‚ å¯¹äºåˆå§‹åŒ–ç­–ç•¥ï¼Œé¦–å…ˆæ˜¯è·å–å®ä¾‹åŒ– bean çš„ç­–ç•¥ï¼Œå¦‚ä¸‹ï¼š final InstantiationStrategy strategy = beanFactory.getInstantiationStrategy(); ç„¶åæ˜¯è°ƒç”¨å…¶ instantiate()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ SimpleInstantiationStrategy ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š public Object instantiate( RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; // æ²¡æœ‰è¦†ç›– // ç›´æ¥ä½¿ç”¨åå°„å®ä¾‹åŒ–å³å¯ if (!bd.hasMethodOverrides()) &#123; // é‡æ–°æ£€æµ‹è·å–ä¸‹æ„é€ å‡½æ•° // è¯¥æ„é€ å‡½æ•°æ˜¯ç»è¿‡å‰é¢ N å¤šå¤æ‚è¿‡ç¨‹ç¡®è®¤çš„æ„é€ å‡½æ•° Constructor&lt;?&gt; constructorToUse; synchronized (bd.constructorArgumentLock) &#123; // è·å–å·²ç»è§£æçš„æ„é€ å‡½æ•° constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod; // å¦‚æœä¸º nullï¼Œä» class ä¸­è§£æè·å–ï¼Œå¹¶è®¾ç½® if (constructorToUse == null) &#123; final Class&lt;?&gt; clazz = bd.getBeanClass(); if (clazz.isInterface()) &#123; throw new BeanInstantiationException(clazz, &quot;Specified class is an interface&quot;); &#125; try &#123; if (System.getSecurityManager() != null) &#123; constructorToUse = AccessController.doPrivileged( (PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor); &#125; else &#123; constructorToUse = clazz.getDeclaredConstructor(); &#125; bd.resolvedConstructorOrFactoryMethod = constructorToUse; &#125; catch (Throwable ex) &#123; throw new BeanInstantiationException(clazz, &quot;No default constructor found&quot;, ex); &#125; &#125; &#125; // é€šè¿‡BeanUtilsç›´æ¥ä½¿ç”¨æ„é€ å™¨å¯¹è±¡å®ä¾‹åŒ–bean return BeanUtils.instantiateClass(constructorToUse); &#125; else &#123; // ç”ŸæˆCGLIBåˆ›å»ºçš„å­ç±»å¯¹è±¡ return instantiateWithMethodInjection(bd, beanName, owner); &#125;&#125; å¦‚æœè¯¥ bean æ²¡æœ‰é…ç½® lookup-methodã€replaced-method æ ‡ç­¾æˆ–è€… @Lookup æ³¨è§£ï¼Œåˆ™ç›´æ¥é€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ– bean å³å¯ï¼Œæ–¹ä¾¿å¿«æ·ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨éœ€è¦è¦†ç›–çš„æ–¹æ³•æˆ–è€…åŠ¨æ€æ›¿æ¢çš„æ–¹æ³•åˆ™éœ€è¦ä½¿ç”¨ CGLIB è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå› ä¸ºå¯ä»¥åœ¨åˆ›å»ºä»£ç†çš„åŒæ—¶å°†åŠ¨æ€æ–¹æ³•ç»‡å…¥ç±»ä¸­ã€‚ åå°„ è°ƒç”¨å·¥å…·ç±» BeanUtils çš„ instantiateClass() æ–¹æ³•å®Œæˆåå°„å·¥ä½œï¼š public static &lt;T&gt; T instantiateClass(Constructor&lt;T&gt; ctor, Object... args) throws BeanInstantiationException &#123; Assert.notNull(ctor, &quot;Constructor must not be null&quot;); try &#123; ReflectionUtils.makeAccessible(ctor); return (KotlinDetector.isKotlinType(ctor.getDeclaringClass()) ? KotlinDelegate.instantiateClass(ctor, args) : ctor.newInstance(args)); &#125; // çœç•¥ä¸€äº› catch &#125; CGLIB protected Object instantiateWithMethodInjection( RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; throw new UnsupportedOperationException( &quot;Method Injection not supported in SimpleInstantiationStrategy&quot;);&#125; æ–¹æ³•é»˜è®¤æ˜¯æ²¡æœ‰å®ç°çš„ï¼Œå…·ä½“è¿‡ç¨‹ç”±å…¶å­ç±» CglibSubclassingInstantiationStrategy å®ç°ï¼š protected Object instantiateWithMethodInjection( RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) &#123; return instantiateWithMethodInjection(bd, beanName, owner, null);&#125;protected Object instantiateWithMethodInjection (RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, @Nullable Constructor&lt;?&gt; ctor, @Nullable Object... args) &#123; // é€šè¿‡CGLIBç”Ÿæˆä¸€ä¸ªå­ç±»å¯¹è±¡ return new CglibSubclassCreator(bd, owner).instantiate(ctor, args);&#125; åˆ›å»ºä¸€ä¸ª CglibSubclassCreator å¯¹è±¡ï¼Œè°ƒç”¨å…¶ instantiate() æ–¹æ³•ç”Ÿæˆå…¶å­ç±»å¯¹è±¡ï¼š public Object instantiate(@Nullable Constructor&lt;?&gt; ctor, @Nullable Object... args) &#123; // é€šè¿‡ Cglib åˆ›å»ºä¸€ä¸ªä»£ç†ç±» Class&lt;?&gt; subclass = createEnhancedSubclass(this.beanDefinition); Object instance; // æ²¡æœ‰æ„é€ å™¨ï¼Œé€šè¿‡ BeanUtils ä½¿ç”¨é»˜è®¤æ„é€ å™¨åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹ if (ctor == null) &#123; instance = BeanUtils.instantiateClass(subclass); &#125; else &#123; try &#123; // è·å–ä»£ç†ç±»å¯¹åº”çš„æ„é€ å™¨å¯¹è±¡ï¼Œå¹¶å®ä¾‹åŒ– bean Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes()); instance = enhancedSubclassConstructor.newInstance(args); &#125; catch (Exception ex) &#123; throw new BeanInstantiationException( this.beanDefinition.getBeanClass(), &quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot; + subclass.getName() + &quot;]&quot;, ex); &#125; &#125; // ä¸ºäº†é¿å…memory leakså¼‚å¸¸ï¼Œç›´æ¥åœ¨beanå®ä¾‹ä¸Šè®¾ç½®å›è°ƒå¯¹è±¡ Factory factory = (Factory) instance; factory.setCallbacks(new Callback[] &#123; NoOp.INSTANCE, new CglibSubclassingInstantiationStrategy .LookupOverrideMethodInterceptor( this.beanDefinition, this.owner), new CglibSubclassingInstantiationStrategy .ReplaceOverrideMethodInterceptor(this.beanDefinition, this.owner)&#125;); return instance;&#125; åˆ°è¿™ç±» CGLIB çš„æ–¹å¼åˆ†æå®Œæ¯•äº†ï¼Œå½“ç„¶è¿™é‡Œè¿˜æ²¡æœ‰å…·ä½“åˆ†æ CGLIB ç”Ÿæˆå­ç±»çš„è¯¦ç»†è¿‡ç¨‹ï¼Œå…·ä½“çš„è¿‡ç¨‹ç­‰åç»­åˆ†æ AOP çš„æ—¶å€™å†è¯¦ç»†åœ°ä»‹ç»ã€‚ instantiateBean()protected BeanWrapper instantiateBean( final String beanName, final RootBeanDefinition mbd) &#123; try &#123; Object beanInstance; final BeanFactory parent = this; if (System.getSecurityManager() != null) &#123; beanInstance = AccessController .doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; getInstantiationStrategy() .instantiate(mbd, beanName, parent), getAccessControlContext()); &#125; else &#123; beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent); &#125; BeanWrapper bw = new BeanWrapperImpl(beanInstance); initBeanWrapper(bw); return bw; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Instantiation of bean failed&quot;, ex); &#125;&#125; è¿™ä¸ªæ–¹æ³•ç›¸æ¯”äº instantiateUsingFactoryMethod() ã€ autowireConstructor() æ–¹æ³•å®åœ¨æ˜¯å¤ªç®€å•äº†ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥ä¸éœ€è¦ç¡®è®¤ç»è¿‡å¤æ‚çš„è¿‡æ¥æ¥ç¡®å®šæ„é€ å™¨ã€æ„é€ å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ã€‚ å¯¹äº createBeanInstance() è€Œè¨€ï¼Œä»–å°±æ˜¯é€‰æ‹©åˆé€‚å®ä¾‹åŒ–ç­–ç•¥æ¥ä¸º bean åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œå…·ä½“çš„ç­–ç•¥æœ‰ï¼šSupplier å›è°ƒæ–¹å¼ã€å·¥å‚æ–¹æ³•åˆå§‹åŒ–ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ã€é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ã€‚ å…¶ä¸­å·¥å‚æ–¹æ³•åˆå§‹åŒ–å’Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥åˆå§‹åŒ–ä¸¤ç§æ–¹å¼æœ€ä¸ºå¤æ‚ï¼Œä¸»è¦æ˜¯å› ä¸ºæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°çš„ä¸ç¡®å®šæ€§ï¼ŒSpring éœ€è¦èŠ±å¤§é‡çš„ç²¾åŠ›æ¥ç¡®å®šæ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°ï¼Œå¦‚æœç¡®å®šäº†åˆ™å¥½åŠï¼Œç›´æ¥é€‰æ‹©å®ä¾‹åŒ–ç­–ç•¥å³å¯ã€‚å½“ç„¶åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ ¹æ®æ˜¯å¦æœ‰éœ€è¦è¦†ç›–æˆ–è€…åŠ¨æ€æ›¿æ¢æ‰çš„æ–¹æ³•ï¼Œå› ä¸ºå­˜åœ¨è¦†ç›–æˆ–è€…ç»‡å…¥çš„è¯éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å°†æ–¹æ³•ç»‡å…¥ï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½é€‰æ‹© CGLIB çš„æ–¹å¼æ¥å®ä¾‹åŒ–ï¼Œå¦åˆ™ç›´æ¥åˆ©ç”¨åå°„çš„æ–¹å¼å³å¯ï¼Œæ–¹ä¾¿å¿«æ·ã€‚ åˆ°è¿™é‡Œ createBeanInstance() çš„è¿‡ç¨‹å°±å·²ç»åˆ†æå®Œæ¯•äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹Factoryå®ä¾‹åŒ–bean","date":"2020-01-19T03:19:07.000Z","path":"2020/01/19/6271d9d2.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2848 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE è¿™ç¯‡æˆ‘ä»¬å…³æ³¨åˆ›å»º bean è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼šå®ä¾‹åŒ– beanï¼Œå¯¹åº”çš„æ–¹æ³•ä¸ºï¼šcreateBeanInstance()ï¼Œå¦‚ä¸‹ï¼š protected BeanWrapper createBeanInstance( String beanName, RootBeanDefinition mbd, @Nullable Object[] args) &#123; // è§£æ beanï¼Œå°† bean ç±»åè§£æä¸º class å¼•ç”¨ Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName); if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot; + beanClass.getName()); &#125; // å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„å›è°ƒæ–¹æ³•åˆå§‹åŒ–ç­–ç•¥ Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier(); if (instanceSupplier != null) &#123; return obtainFromSupplier(instanceSupplier, beanName); &#125; // å¦‚æœå·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•åˆå§‹åŒ–ç­–ç•¥ if (mbd.getFactoryMethodName() != null) &#123; return instantiateUsingFactoryMethod(beanName, mbd, args); &#125; boolean resolved = false; boolean autowireNecessary = false; if (args == null) &#123; // constructorArgumentLock æ„é€ å‡½æ•°çš„å¸¸ç”¨é” synchronized (mbd.constructorArgumentLock) &#123; // å¦‚æœå·²ç¼“å­˜çš„è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ„é€ å‡½æ•°è§£æ // å› ä¸ºéœ€è¦æ ¹æ®å‚æ•°ç¡®è®¤åˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥è¿‡ç¨‹æ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œæ‰€æœ‰é‡‡ç”¨ç¼“å­˜æœºåˆ¶ if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125; &#125; // å·²ç»è§£æå¥½äº†ï¼Œç›´æ¥æ³¨å…¥å³å¯ if (resolved) &#123; // è‡ªåŠ¨æ³¨å…¥ï¼Œè°ƒç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ if (autowireNecessary) &#123; return autowireConstructor(beanName, mbd, null, null); &#125; else &#123; // ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€  return instantiateBean(beanName, mbd); &#125; &#125; // ç¡®å®šè§£æçš„æ„é€ å‡½æ•° // ä¸»è¦æ˜¯æ£€æŸ¥å·²ç»æ³¨å†Œçš„ SmartInstantiationAwareBeanPostProcessor Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); if (ctors != null || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; // æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ return autowireConstructor(beanName, mbd, ctors, args); &#125; //ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°æ³¨å…¥ return instantiateBean(beanName, mbd);&#125; å®ä¾‹åŒ– bean æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå…¶ä¸»è¦çš„é€»è¾‘ä¸ºï¼š å¦‚æœå­˜åœ¨ Supplier å›è°ƒï¼Œåˆ™è°ƒç”¨ obtainFromSupplier() è¿›è¡Œåˆå§‹åŒ– å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•è¿›è¡Œåˆå§‹åŒ– é¦–å…ˆåˆ¤æ–­ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œå³å·²ç»è§£æè¿‡äº†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å·²ç»è§£æäº†çš„ï¼Œæ ¹æ® constructorArgumentsResolved å‚æ•°æ¥åˆ¤æ–­æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥è¿˜æ˜¯é»˜è®¤æ„é€ å‡½æ•° å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆç¡®å®šåˆ°åº•ä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•°æ¥å®Œæˆè§£æå·¥ä½œï¼Œå› ä¸ºä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°éƒ½æœ‰ä¸åŒçš„æ„é€ å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®å‚æ•°æ¥é”å®šæ„é€ å‡½æ•°å¹¶å®Œæˆåˆå§‹åŒ–ï¼Œå¦‚æœå­˜åœ¨å‚æ•°åˆ™ä½¿ç”¨ç›¸åº”çš„å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚ ä¸‹é¢å°±ä¸Šé¢å››ç§æƒ…å†µåšåˆ†åˆ«è¯´æ˜ã€‚ obtainFromSupplier()Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();if (instanceSupplier != null) &#123; return obtainFromSupplier(instanceSupplier, beanName);&#125; é¦–å…ˆä» BeanDefinition ä¸­è·å– Supplierï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ obtainFromSupplier() ã€‚é‚£ä¹ˆ Supplier æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™ä¹‹å‰ä¹Ÿæ²¡æœ‰æåˆ°è¿‡è¿™ä¸ªå­—æ®µã€‚ public interface Supplier&lt;T&gt; &#123; T get();&#125; Supplier æ¥å£ä»…æœ‰ä¸€ä¸ªåŠŸèƒ½æ€§çš„ get()ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª T ç±»å‹çš„å¯¹è±¡ï¼Œæœ‰ç‚¹å„¿ç±»ä¼¼å·¥å‚æ–¹æ³•ã€‚è¿™ä¸ªæ¥å£æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿç”¨äºæŒ‡å®šåˆ›å»º bean çš„å›è°ƒï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†è¿™æ ·çš„å›è°ƒï¼Œé‚£ä¹ˆå…¶ä»–çš„æ„é€ å™¨æˆ–è€…å·¥å‚æ–¹æ³•éƒ½ä¼šæ²¡æœ‰ç”¨ã€‚åœ¨ä»€ä¹ˆè®¾ç½®è¯¥å‚æ•°å‘¢ï¼ŸSpring æä¾›äº†ç›¸åº”çš„ setter æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š public void setInstanceSupplier(@Nullable Supplier&lt;?&gt; instanceSupplier) &#123; this.instanceSupplier = instanceSupplier;&#125; åœ¨æ„é€  BeanDefinition çš„æ—¶å€™è®¾ç½®äº†è¯¥å€¼ï¼Œå¦‚ä¸‹ï¼ˆä»¥ RootBeanDefinition ä¸ºä¾‹ï¼‰ï¼š public &lt;T&gt; RootBeanDefinition(@Nullable Class&lt;T&gt; beanClass, String scope, @Nullable Supplier&lt;T&gt; instanceSupplier) &#123; super(); setBeanClass(beanClass); setScope(scope); setInstanceSupplier(instanceSupplier);&#125; å¦‚æœè®¾ç½®äº† instanceSupplier åˆ™è°ƒç”¨ obtainFromSupplier() å®Œæˆ bean çš„åˆå§‹åŒ–ï¼Œå¦‚ä¸‹ï¼š protected BeanWrapper obtainFromSupplier(Supplier&lt;?&gt; instanceSupplier, String beanName) &#123; String outerBean = this.currentlyCreatedBean.get(); this.currentlyCreatedBean.set(beanName); Object instance; try &#123; // è°ƒç”¨ Supplier çš„ get()ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ instance = instanceSupplier.get(); &#125; finally &#123; if (outerBean != null) &#123; this.currentlyCreatedBean.set(outerBean); &#125; else &#123; this.currentlyCreatedBean.remove(); &#125; &#125; // æ ¹æ®å¯¹è±¡æ„é€  BeanWrapper å¯¹è±¡ BeanWrapper bw = new BeanWrapperImpl(instance); // åˆå§‹åŒ– BeanWrapper initBeanWrapper(bw); return bw;&#125; ä»£ç å¾ˆç®€å•ï¼Œè°ƒç”¨ è°ƒç”¨ Supplier çš„ get() æ–¹æ³•ï¼Œè·å¾—ä¸€ä¸ª bean å®ä¾‹å¯¹è±¡ï¼Œç„¶åæ ¹æ®è¯¥å®ä¾‹å¯¹è±¡æ„é€ ä¸€ä¸ª BeanWrapper å¯¹è±¡ bwï¼Œæœ€ååˆå§‹åŒ–è¯¥å¯¹è±¡ã€‚æœ‰å…³äº BeanWrapper åé¢ä¸“é—¨å‡ºæ–‡è®²è§£ã€‚ instantiateUsingFactoryMethod()å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ instantiateUsingFactoryMethod() å®Œæˆ bean çš„åˆå§‹åŒ–å·¥ä½œï¼ˆæ–¹æ³•å®ç°æ¯”è¾ƒé•¿ï¼Œç»†èŠ‚æ¯”è¾ƒå¤æ‚ï¼Œå„ä½å°±ç¡¬ç€å¤´çš®çœ‹å§ï¼‰ã€‚ protected BeanWrapper instantiateUsingFactoryMethod( String beanName, RootBeanDefinition mbd, @Nullable Object[] explicitArgs) &#123; return new ConstructorResolver(this) .instantiateUsingFactoryMethod(beanName, mbd, explicitArgs);&#125; æ„é€ ä¸€ä¸ª ConstructorResolver å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ instantiateUsingFactoryMethod() æ–¹æ³•ã€‚ConstructorResolver æ˜¯æ„é€ æ–¹æ³•æˆ–è€…å·¥å‚ç±»åˆå§‹åŒ– bean çš„å§”æ‰˜ç±»ã€‚ public BeanWrapper instantiateUsingFactoryMethod( final String beanName, final RootBeanDefinition mbd, @Nullable final Object[] explicitArgs) &#123; // æ„é€  BeanWrapperImpl å¯¹è±¡ BeanWrapperImpl bw = new BeanWrapperImpl(); // åˆå§‹åŒ– BeanWrapperImpl // å‘BeanWrapperå¯¹è±¡ä¸­æ·»åŠ  ConversionService å¯¹è±¡å’Œå±æ€§ç¼–è¾‘å™¨ PropertyEditor å¯¹è±¡ // this.beanFactory.initBeanWrapper(bw); Object factoryBean; Class&lt;?&gt; factoryClass; boolean isStatic; // å·¥å‚åä¸ä¸ºç©º String factoryBeanName = mbd.getFactoryBeanName(); if (factoryBeanName != null) &#123; if (factoryBeanName.equals(beanName)) &#123; throw new BeanDefinitionStoreException( mbd.getResourceDescription(), beanName, &quot;factory-bean reference points back to the same bean definition&quot;); &#125; // è·å–å·¥å‚å®ä¾‹ factoryBean = this.beanFactory.getBean(factoryBeanName); if (mbd.isSingleton() &amp;&amp; this.beanFactory.containsSingleton(beanName)) &#123; throw new ImplicitlyAppearedSingletonException(); &#125; factoryClass = factoryBean.getClass(); isStatic = false; &#125; else &#123; // å·¥å‚åä¸ºç©ºï¼Œåˆ™å…¶å¯èƒ½æ˜¯ä¸€ä¸ªé™æ€å·¥å‚ // é™æ€å·¥å‚åˆ›å»ºbeanï¼Œå¿…é¡»è¦æä¾›å·¥å‚çš„å…¨ç±»å if (!mbd.hasBeanClass()) &#123; throw new BeanDefinitionStoreException( mbd.getResourceDescription(), beanName, &quot;bean definition declares neither a bean class nor a factory-bean reference&quot;); &#125; factoryBean = null; factoryClass = mbd.getBeanClass(); isStatic = true; &#125; // å·¥å‚æ–¹æ³• Method factoryMethodToUse = null; ConstructorResolver.ArgumentsHolder argsHolderToUse = null; // å‚æ•° Object[] argsToUse = null; // å·¥å‚æ–¹æ³•çš„å‚æ•° // å¦‚æœæŒ‡å®šäº†æ„é€ å‚æ•°åˆ™ç›´æ¥ä½¿ç”¨ // åœ¨è°ƒç”¨ getBean æ–¹æ³•çš„æ—¶å€™æŒ‡å®šäº†æ–¹æ³•å‚æ•° if (explicitArgs != null) &#123; argsToUse = explicitArgs; &#125; else &#123; // æ²¡æœ‰æŒ‡å®šï¼Œåˆ™å°è¯•ä»é…ç½®æ–‡ä»¶ä¸­è§£æ Object[] argsToResolve = null; // é¦–å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å– synchronized (mbd.constructorArgumentLock) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³• factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod; if (factoryMethodToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‚æ•° argsToUse = mbd.resolvedConstructorArguments; if (argsToUse == null) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°å‚æ•°çš„åŒ…å¯è§å­—æ®µ argsToResolve = mbd.preparedConstructorArguments; &#125; &#125; &#125; // ç¼“å­˜ä¸­å­˜åœ¨,åˆ™è§£æå­˜å‚¨åœ¨ BeanDefinition ä¸­çš„å‚æ•° // å¦‚ç»™å®šæ–¹æ³•çš„æ„é€ å‡½æ•° A(int ,int )ï¼Œåˆ™é€šè¿‡æ­¤æ–¹æ³•åå°±ä¼šæŠŠé…ç½®æ–‡ä»¶ä¸­çš„(&quot;1&quot;,&quot;1&quot;)è½¬æ¢ä¸º (1,1) // ç¼“å­˜ä¸­çš„å€¼å¯èƒ½æ˜¯åŸå§‹å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼ if (argsToResolve != null) &#123; argsToUse = resolvePreparedArguments( beanName, mbd, bw, factoryMethodToUse, argsToResolve); &#125; &#125; // if (factoryMethodToUse == null || argsToUse == null) &#123; // è·å–å·¥å‚æ–¹æ³•çš„ç±»å…¨åç§° factoryClass = ClassUtils.getUserClass(factoryClass); // è·å–æ‰€æœ‰å¾…å®šæ–¹æ³• Method[] rawCandidates = getCandidateMethods(factoryClass, mbd); // æ£€ç´¢æ‰€æœ‰æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯å¯¹æ–¹æ³•è¿›è¡Œè¿‡æ»¤ List&lt;Method&gt; candidateSet = new ArrayList&lt;&gt;(); for (Method candidate : rawCandidates) &#123; // å¦‚æœæœ‰static ä¸”ä¸ºå·¥å‚æ–¹æ³•ï¼Œåˆ™æ·»åŠ åˆ° candidateSet ä¸­ if (Modifier.isStatic(candidate.getModifiers()) == isStatic &amp;&amp; mbd.isFactoryMethod(candidate)) &#123; candidateSet.add(candidate); &#125; &#125; Method[] candidates = candidateSet.toArray(new Method[0]); // æ’åºæ„é€ å‡½æ•° // public æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºï¼Œépublic æ„é€ å‡½æ•°å‚æ•°æ•°é‡é™åº AutowireUtils.sortFactoryMethods(candidates); // ç”¨äºæ‰¿è½½è§£æåçš„æ„é€ å‡½æ•°å‚æ•°çš„å€¼ ConstructorArgumentValues resolvedValues = null; boolean autowiring = (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR); int minTypeDiffWeight = Integer.MAX_VALUE; Set&lt;Method&gt; ambiguousFactoryMethods = null; int minNrOfArgs; if (explicitArgs != null) &#123; minNrOfArgs = explicitArgs.length; &#125; else &#123; // getBean() æ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œåˆ™éœ€è¦è§£æä¿å­˜åœ¨ BeanDefinition æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„å‚æ•° if (mbd.hasConstructorArgumentValues()) &#123; // æ„é€ å‡½æ•°çš„å‚æ•° ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues(); resolvedValues = new ConstructorArgumentValues(); // è§£ææ„é€ å‡½æ•°çš„å‚æ•° // å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues); &#125; else &#123; minNrOfArgs = 0; &#125; &#125; LinkedList&lt;UnsatisfiedDependencyException&gt; causes = null; for (Method candidate : candidates) &#123; // æ–¹æ³•ä½“çš„å‚æ•° Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes(); if (paramTypes.length &gt;= minNrOfArgs) &#123; // ä¿å­˜å‚æ•°çš„å¯¹è±¡ ArgumentsHolder argsHolder; // getBean()ä¼ é€’äº†å‚æ•° if (explicitArgs != null)&#123; // æ˜¾ç¤ºç»™å®šå‚æ•°ï¼Œå‚æ•°é•¿åº¦å¿…é¡»å®Œå…¨åŒ¹é… if (paramTypes.length != explicitArgs.length) &#123; continue; &#125; // æ ¹æ®å‚æ•°åˆ›å»ºå‚æ•°æŒæœ‰è€… argsHolder = new ArgumentsHolder(explicitArgs); &#125; else &#123; // ä¸ºæä¾›å‚æ•°ï¼Œè§£ææ„é€ å‚æ•° try &#123; String[] paramNames = null; // è·å– ParameterNameDiscoverer å¯¹è±¡ // ParameterNameDiscoverer æ˜¯ç”¨äºè§£ææ–¹æ³•å’Œæ„é€ å‡½æ•°çš„å‚æ•°åç§°çš„æ¥å£ï¼Œä¸ºå‚æ•°åç§°æ¢æµ‹å™¨ ParameterNameDiscoverer pnd = this.beanFactory.getParameterNameDiscoverer(); if (pnd != null) &#123; // è·å–æŒ‡å®šæ„é€ å‡½æ•°çš„å‚æ•°åç§° paramNames = pnd.getParameterNames(candidate); &#125; // åœ¨å·²ç»è§£æçš„æ„é€ å‡½æ•°å‚æ•°å€¼çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªå‚æ•°æŒæœ‰è€…å¯¹è±¡ argsHolder = createArgumentArray( beanName, mbd, resolvedValues, bw, paramTypes, paramNames, candidate, autowiring); &#125; catch (UnsatisfiedDependencyException ex) &#123; if (this.beanFactory.logger.isTraceEnabled()) &#123; this.beanFactory.logger.trace( &quot;Ignoring factory method [&quot; + candidate + &quot;] of bean &#x27;&quot; + beanName + &quot;&#x27;: &quot; + ex); &#125; if (causes == null) &#123; causes = new LinkedList&lt;&gt;(); &#125; causes.add(ex); continue; &#125; &#125; // isLenientConstructorResolution åˆ¤æ–­è§£ææ„é€ å‡½æ•°çš„æ—¶å€™æ˜¯å¦ä»¥å®½æ¾æ¨¡å¼è¿˜æ˜¯ä¸¥æ ¼æ¨¡å¼ // ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰çš„éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ // å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰&quot;æœ€æ¥è¿‘çš„æ¨¡å¼&quot;è¿›è¡ŒåŒ¹é… // typeDiffWeightï¼šç±»å‹å·®å¼‚æƒé‡ int typeDiffWeight = (mbd.isLenientConstructorResolution() ? argsHolder.getTypeDifferenceWeight(paramTypes) :argsHolder.getAssignabilityWeight(paramTypes)); // ä»£è¡¨æœ€æ¥è¿‘çš„ç±»å‹åŒ¹é…ï¼Œåˆ™é€‰æ‹©ä½œä¸ºæ„é€ å‡½æ•° if (typeDiffWeight &lt; minTypeDiffWeight) &#123; factoryMethodToUse = candidate; argsHolderToUse = argsHolder; argsToUse = argsHolder.arguments; minTypeDiffWeight = typeDiffWeight; ambiguousFactoryMethods = null; &#125; // å¦‚æœå…·æœ‰ç›¸åŒå‚æ•°æ•°é‡çš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„ç±»å‹å·®å¼‚æƒé‡ï¼Œåˆ™æ”¶é›†æ­¤ç±»å‹é€‰é¡¹ // ä½†æ˜¯ï¼Œä»…åœ¨éå®½æ¾æ„é€ å‡½æ•°è§£ææ¨¡å¼ä¸‹æ‰§è¡Œè¯¥æ£€æŸ¥ï¼Œå¹¶æ˜¾å¼å¿½ç•¥é‡å†™æ–¹æ³•ï¼ˆå…·æœ‰ç›¸åŒçš„å‚æ•°ç­¾åï¼‰ else if (factoryMethodToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight &amp;&amp; !mbd.isLenientConstructorResolution() &amp;&amp; paramTypes.length == factoryMethodToUse.getParameterCount() &amp;&amp; !Arrays.equals(paramTypes, factoryMethodToUse.getParameterTypes())) &#123; // æŸ¥æ‰¾åˆ°å¤šä¸ªå¯åŒ¹é…çš„æ–¹æ³• if (ambiguousFactoryMethods == null) &#123; ambiguousFactoryMethods = new LinkedHashSet&lt;&gt;(); ambiguousFactoryMethods.add(factoryMethodToUse); &#125; ambiguousFactoryMethods.add(candidate); &#125; &#125; &#125; // æ²¡æœ‰å¯æ‰§è¡Œçš„å·¥å‚æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (factoryMethodToUse == null) &#123; if (causes != null) &#123; UnsatisfiedDependencyException ex = causes.removeLast(); for (Exception cause : causes) &#123; this.beanFactory.onSuppressedException(cause); &#125; throw ex; &#125; List&lt;String&gt; argTypes = new ArrayList&lt;&gt;(minNrOfArgs); if (explicitArgs != null) &#123; for (Object arg : explicitArgs) &#123; argTypes.add(arg != null ? arg.getClass().getSimpleName() : &quot;null&quot;); &#125; &#125; else if (resolvedValues != null)&#123; Set&lt;ConstructorArgumentValues.ValueHolder&gt; valueHolders = new LinkedHashSet&lt;&gt;(resolvedValues.getArgumentCount()); valueHolders.addAll(resolvedValues.getIndexedArgumentValues().values()); valueHolders.addAll(resolvedValues.getGenericArgumentValues()); for (ConstructorArgumentValues.ValueHolder value : valueHolders) &#123; String argType = (value.getType() != null ? ClassUtils.getShortName(value.getType()) : (value.getValue() != null ? value.getValue().getClass().getSimpleName() : &quot;null&quot;)); argTypes.add(argType); &#125; &#125; String argDesc = StringUtils.collectionToCommaDelimitedString(argTypes); throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;No matching factory method found: &quot; + (mbd.getFactoryBeanName() != null ? &quot;factory bean &#x27;&quot; + mbd.getFactoryBeanName() + &quot;&#x27;; &quot; : &quot;&quot;) + &quot;factory method &#x27;&quot; + mbd.getFactoryMethodName() + &quot;(&quot; + argDesc + &quot;)&#x27;. &quot; + &quot;Check that a method with the specified name &quot; + (minNrOfArgs &gt; 0 ? &quot;and arguments &quot; : &quot;&quot;) + &quot;exists and that it is &quot; + (isStatic ? &quot;static&quot; : &quot;non-static&quot;) + &quot;.&quot;); &#125; else if (void.class == factoryMethodToUse.getReturnType()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid factory method &#x27;&quot; + mbd.getFactoryMethodName() + &quot;&#x27;: needs to have a non-void return type!&quot;); &#125; else if (ambiguousFactoryMethods != null) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Ambiguous factory method matches found in bean &#x27;&quot; + beanName + &quot;&#x27; &quot; + &quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot; + ambiguousFactoryMethods); &#125; if (explicitArgs == null &amp;&amp; argsHolderToUse != null) &#123; // å°†è§£æçš„æ„é€ å‡½æ•°åŠ å…¥ç¼“å­˜ argsHolderToUse.storeCache(mbd, factoryMethodToUse); &#125; &#125; try &#123; // å®ä¾‹åŒ– bean Object beanInstance; if (System.getSecurityManager() != null) &#123; final Object fb = factoryBean; final Method factoryMethod = factoryMethodToUse; final Object[] args = argsToUse; // é€šè¿‡æ‰§è¡Œå·¥å‚æ–¹æ³•æ¥åˆ›å»ºbeanç¤ºä¾‹ beanInstance = AccessController.doPrivileged( (PrivilegedAction&lt;Object&gt;) () -&gt; beanFactory.getInstantiationStrategy() .instantiate( mbd, beanName, beanFactory, fb, factoryMethod, args), beanFactory.getAccessControlContext()); &#125; else &#123; // é€šè¿‡æ‰§è¡Œå·¥å‚æ–¹æ³•æ¥åˆ›å»ºbeanç¤ºä¾‹ beanInstance = this.beanFactory.getInstantiationStrategy().instantiate( mbd, beanName, this.beanFactory, factoryBean, factoryMethodToUse, argsToUse); &#125; // åŒ…è£…ä¸º BeanWraper å¯¹è±¡ bw.setBeanInstance(beanInstance); return bw; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Bean instantiation via factory method failed&quot;, ex); &#125;&#125; instantiateUsingFactoryMethod() æ–¹æ³•ä½“å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå¤„ç†ç»†èŠ‚æ„Ÿè§‰å¾ˆå¤æ‚ï¼Œä¸­é—´æ–­æ–­ç»­ç»­çš„ã€‚åæ§½è¿™é‡Œçš„ä»£ç é£æ ¼ï¼Œå®Œå…¨ä¸ç¬¦åˆæˆ‘ä»¬å‰é¢çœ‹çš„ Spring ä»£ç é£æ ¼ã€‚Spring çš„ä¸€è´¯åšæ³•æ˜¯å°†ä¸€ä¸ªå¤æ‚é€»è¾‘è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†ä¸ºå¤šä¸ªç»†å°çš„æ¨¡å—è¿›è¡ŒåµŒå¥—ï¼Œæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œæ¨¡å—ä¸æ¨¡å—ä¹‹é—´å±‚å±‚åµŒå¥—ï¼Œä¸Šä¸€å±‚ä¸€èˆ¬éƒ½æ˜¯å¯¹ä¸‹ä¸€å±‚çš„æ€»ç»“å’Œæ¦‚æ‹¬ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—æ¯ä¸€å±‚çš„é€»è¾‘å˜å¾—æ¸…æ™°æ˜“æ‡‚ã€‚ å›å½’åˆ°ä¸Šé¢çš„æ–¹æ³•ä½“ï¼Œè™½ç„¶ä»£ç ä½“é‡å¤§ï¼Œä½†æ˜¯æ€»ä½“æˆ‘ä»¬è¿˜æ˜¯å¯çœ‹æ¸…æ¥šè¿™ä¸ªæ–¹æ³•è¦åšçš„äº‹æƒ…ã€‚ ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼šç¡®å®šå·¥å‚å¯¹è±¡ï¼Œç„¶åè·å–æ„é€ å‡½æ•°å’Œæ„é€ å‚æ•°ï¼Œæœ€åè°ƒç”¨ InstantiationStrategy å¯¹è±¡çš„ instantiate() æ¥åˆ›å»º bean å®ä¾‹ã€‚ ä¸‹é¢æˆ‘ä»¬å°±è¿™ä¸ªå¥æ¦‚æ‹¬çš„è¯è¿›è¡Œæ‹†åˆ†å¹¶è¯¦ç»†è¯´æ˜ã€‚ ç¡®å®šå·¥å‚å¯¹è±¡é¦–å…ˆè·å–å·¥å‚æ–¹æ³•åï¼Œè‹¥å·¥å‚æ–¹æ³•åä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ beanFactory.getBean() è·å–å·¥å‚å¯¹è±¡ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™å¯èƒ½ä¸ºä¸€ä¸ªé™æ€å·¥å‚ï¼Œå¯¹äºé™æ€å·¥å‚åˆ™å¿…é¡»æä¾›å·¥å‚ç±»çš„å…¨ç±»åï¼ŒåŒæ—¶è®¾ç½® factoryBean = null æ„é€ å‚æ•°ç¡®è®¤ å·¥å‚å¯¹è±¡ç¡®å®šåï¼Œåˆ™æ˜¯ç¡®è®¤æ„é€ å‚æ•°ã€‚æ„é€ å‚æ•°çš„ç¡®è®¤ä¸»è¦åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šexplicitArgs å‚æ•°ã€ç¼“å­˜ä¸­è·å–ã€é…ç½®æ–‡ä»¶ä¸­è§£æã€‚ explicitArgs å‚æ•° explicitArgs å‚æ•°æ˜¯æˆ‘ä»¬è°ƒç”¨ getBean() æ—¶ä¼ é€’æ™¯æ¥ï¼Œä¸€èˆ¬è¯¥å‚æ•°ï¼Œè¯¥å‚æ•°å°±æ˜¯ç”¨äºåˆå§‹åŒ– bean æ—¶æ‰€ä¼ é€’çš„å‚æ•°ï¼Œå¦‚æœè¯¥å‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥ç¡®å®šæ„é€ å‡½æ•°çš„å‚æ•°å°±æ˜¯å®ƒäº†ã€‚ ç¼“å­˜ä¸­è·å– åœ¨è¯¥æ–¹æ³•çš„æœ€åï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™æ ·ä¸€æ®µä»£ç ï¼šargsHolderToUse.storeCache(mbd, factoryMethodToUse) ï¼Œè¿™æ®µä»£ç ä¸»è¦æ˜¯å°†æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚ä¸‹ï¼š public void storeCache(RootBeanDefinition mbd, Executable constructorOrFactoryMethod) &#123; synchronized (mbd.constructorArgumentLock) &#123; mbd.resolvedConstructorOrFactoryMethod = constructorOrFactoryMethod; mbd.constructorArgumentsResolved = true; if (this.resolveNecessary) &#123; mbd.preparedConstructorArguments = this.preparedArguments; &#125; else &#123; mbd.resolvedConstructorArguments = this.arguments; &#125; &#125;&#125; å…¶ä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªå‚æ•° constructorArgumentLockã€resolvedConstructorOrFactoryMethodã€constructorArgumentsResolvedã€resolvedConstructorArgumentsã€‚è¿™äº›å‚æ•°éƒ½æ˜¯è·Ÿæ„é€ å‡½æ•°ã€æ„é€ å‡½æ•°ç¼“å­˜æœ‰å…³çš„ã€‚ constructorArgumentLockï¼šæ„é€ å‡½æ•°çš„ç¼“å­˜é” resolvedConstructorOrFactoryMethodï¼šç¼“å­˜å·²ç»è§£æçš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³• constructorArgumentsResolvedï¼šæ ‡è®°å­—æ®µï¼Œæ ‡è®°æ„é€ å‡½æ•°ã€å‚æ•°å·²ç»è§£æäº†ã€‚é»˜è®¤ä¸ºfalse resolvedConstructorArgumentsï¼šç¼“å­˜å·²ç»è§£æçš„æ„é€ å‡½æ•°å‚æ•°ï¼ŒåŒ…å¯è§å­—æ®µ æ‰€ä»¥ä»ç¼“å­˜ä¸­è·å–å°±æ˜¯æå–è¿™å‡ ä¸ªå‚æ•°çš„å€¼ï¼Œå¦‚ä¸‹ï¼š synchronized (mbd.constructorArgumentLock) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³• factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod; if (factoryMethodToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‚æ•° argsToUse = mbd.resolvedConstructorArguments; if (argsToUse == null) &#123; // è·å–ç¼“å­˜ä¸­çš„æ„é€ å‡½æ•°å‚æ•°çš„åŒ…å¯è§å­—æ®µ argsToResolve = mbd.preparedConstructorArguments; &#125; &#125;&#125; å¦‚æœç¼“å­˜ä¸­å­˜åœ¨æ„é€ å‚æ•°ï¼Œåˆ™éœ€è¦è°ƒç”¨ resolvePreparedArguments() æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œå› ä¸ºç¼“å­˜ä¸­çš„å€¼æœ‰å¯èƒ½æ˜¯æœ€ç»ˆå€¼ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯æœ€ç»ˆå€¼ï¼Œæ¯”å¦‚æˆ‘ä»¬æ„é€ å‡½æ•°ä¸­çš„ç±»å‹ä¸º Integer ç±»å‹çš„ 1 ï¼Œä½†æ˜¯åŸå§‹çš„å‚æ•°ç±»å‹æœ‰å¯èƒ½æ˜¯ String ç±»å‹çš„ 1 ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ä»ç¼“å­˜ä¸­å¾—åˆ°äº†æ„é€ å‚æ•°ä¹Ÿéœ€è¦ç»è¿‡ä¸€ç•ªçš„ç±»å‹è½¬æ¢ç¡®ä¿å‚æ•°ç±»å‹å®Œå…¨å¯¹åº”ã€‚ é…ç½®æ–‡ä»¶ä¸­è§£æ å³æ²¡æœ‰é€šè¿‡ä¼ é€’å‚æ•°çš„æ–¹å¼ä¼ é€’æ„é€ å‚æ•°ï¼Œç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ï¼Œé‚£å°±åªèƒ½é€šè¿‡è§£æé…ç½®æ–‡ä»¶è·å–æ„é€ å‚æ•°äº†ã€‚ åœ¨ bean è§£æç±»çš„åšæ–‡ä¸­æˆ‘ä»¬äº†è§£äº†ï¼Œé…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯éƒ½ä¼šè½¬æ¢åˆ° BeanDefinition å®ä¾‹å¯¹è±¡ä¸­ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°å¯ä»¥ç›´æ¥é€šè¿‡ BeanDefinition å¯¹è±¡è·å–ã€‚ä»£ç å¦‚ä¸‹ï¼š if (mbd.hasConstructorArgumentValues()) &#123; // æ„é€ å‡½æ•°çš„å‚æ•° ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues(); resolvedValues = new ConstructorArgumentValues(); // è§£ææ„é€ å‡½æ•°çš„å‚æ•° // å°†è¯¥ bean çš„æ„é€ å‡½æ•°å‚æ•°è§£æä¸º resolvedValues å¯¹è±¡ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°å…¶ä»– bean minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);&#125; é€šè¿‡ BeanDefinition çš„ getConstructorArgumentValues() å°±å¯ä»¥è·å–æ„é€ ä¿¡æ¯äº†ï¼Œæœ‰äº†æ„é€ ä¿¡æ¯å°±å¯ä»¥è·å–ç›¸å…³çš„å‚æ•°å€¼ä¿¡æ¯äº†ï¼Œè·å–çš„å‚æ•°ä¿¡æ¯åŒ…æ‹¬ç›´æ¥å€¼å’Œå¼•ç”¨ï¼Œè¿™ä¸€æ­¥éª¤çš„å¤„ç†äº¤ç”± resolveConstructorArguments() å®Œæˆï¼Œè¯¥æ–¹æ³•ä¼šå°†æ„é€ å‚æ•°ä¿¡æ¯è§£æä¸º resolvedValues å¯¹è±¡ å¹¶è¿”å›è§£æåˆ°çš„å‚æ•°ä¸ªæ•°ã€‚ æ„é€ å‡½æ•° ç¡®å®šæ„é€ å‚æ•°åï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯ç¡®å®šæ„é€ å‡½æ•°ã€‚ç¬¬ä¸€æ­¥åˆ™æ˜¯é€šè¿‡ getCandidateMethods() è·å–æ‰€æœ‰çš„æ„é€ æ–¹æ³•ï¼ŒåŒæ—¶å¯¹æ„é€ æ–¹æ³•è¿›è¡Œåˆ·é€‰ï¼Œç„¶ååœ¨å¯¹å…¶è¿›è¡Œæ’åºå¤„ç†ï¼ˆAutowireUtils.sortFactoryMethods(candidates)ï¼‰ï¼Œæ’åºçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿çš„æ‰¾åˆ°åŒ¹é…çš„æ„é€ å‡½æ•°ï¼Œå› ä¸ºæ„é€ å‡½æ•°çš„ç¡®è®¤æ˜¯æ ¹æ®å‚æ•°ä¸ªæ•°ç¡®è®¤çš„ã€‚ æ’åºçš„è§„åˆ™æ˜¯ï¼špublic æ„é€ å‡½æ•°ä¼˜å…ˆå‚æ•°æ•°é‡é™åºã€é public æ„é€ å‚æ•°æ•°é‡é™åºã€‚ é€šè¿‡è¿­ä»£ candidatesï¼ˆåŒ…å«äº†æ‰€æœ‰è¦åŒ¹é…çš„æ„é€ å‡½æ•°ï¼‰çš„æ–¹å¼ï¼Œä¸€æ¬¡æ¯”è¾ƒå…¶å‚æ•°ï¼Œå¦‚æœæ˜¾ç¤ºæä¾›äº†å‚æ•°ï¼ˆexplicitArgs != nullï¼‰ï¼Œåˆ™ç›´æ¥æ¯”è¾ƒä¸¤è€…æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™è¡¨ç¤ºæ‰¾åˆ°äº†ï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒã€‚ å¦‚æœæ²¡æœ‰æ˜¾ç¤ºæä¾›å‚æ•°ï¼Œåˆ™éœ€è¦è·å– ParameterNameDiscoverer å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸ºå‚æ•°åç§°æ¢æµ‹å™¨ï¼Œä¸»è¦ç”¨äºå‘ç°æ–¹æ³•å’Œæ„é€ å‡½æ•°çš„å‚æ•°åç§°ã€‚ å°†å‚æ•°åŒ…è£…æˆ ArgumentsHolder å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºä¿å­˜å‚æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‚æ•°æŒæœ‰è€…ã€‚å½“å°†å¯¹è±¡åŒ…è£…æˆ ArgumentsHolder å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œæ„é€ å‡½æ•°åŒ¹é…ï¼ŒåŒ¹é…åˆ†ä¸ºä¸¥æ ¼æ¨¡å¼å’Œå®½æ¾æ¨¡å¼ã€‚ ä¸¥æ ¼æ¨¡å¼ï¼šè§£ææ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»æ‰€æœ‰å‚æ•°éƒ½éœ€è¦åŒ¹é…ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ å®½æ¾æ¨¡å¼ï¼šä½¿ç”¨å…·æœ‰â€æœ€æ¥è¿‘çš„æ¨¡å¼â€è¿›è¡ŒåŒ¹é… åˆ¤æ–­çš„ä¾æ®æ˜¯æ ¹æ® BeanDefinition çš„ isLenientConstructorResolution å±æ€§ï¼ˆè¯¥å‚æ•°æ˜¯æˆ‘ä»¬åœ¨æ„é€  AbstractBeanDefinition å¯¹è±¡æ˜¯ä¼ é€’çš„ï¼‰æ¥è·å–ç±»å‹å·®å¼‚æƒé‡ï¼ˆtypeDiffWeightï¼‰ çš„ã€‚å¦‚æœ typeDiffWeight &lt; minTypeDiffWeight ï¼Œåˆ™ä»£è¡¨â€œæœ€æ¥è¿‘çš„æ¨¡å¼â€ï¼Œé€‰æ‹©å…¶ä½œä¸ºæ„é€ å‡½æ•°ï¼Œå¦åˆ™åªæœ‰ä¸¤è€…å…·æœ‰ç›¸åŒçš„å‚æ•°æ•°é‡ä¸”ç±»å‹å·®å¼‚æƒé‡ç›¸ç­‰æ‰ä¼šçº³å…¥è€ƒè™‘èŒƒå›´ã€‚ è‡³æ­¤ï¼Œæ„é€ å‡½æ•°å·²ç»ç¡®è®¤äº†ã€‚ åˆ›å»º bean å®ä¾‹ å·¥å‚å¯¹è±¡ã€æ„é€ å‡½æ•°ã€æ„é€ å‚æ•°éƒ½å·²ç»ç¡®è®¤äº†ï¼Œåˆ™æœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨ InstantiationStrategy å¯¹è±¡çš„ instantiate() æ¥åˆ›å»º bean å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š public Object instantiate( RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner, @Nullable Object factoryBean, final Method factoryMethod, @Nullable Object... args) &#123; try &#123; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123; ReflectionUtils.makeAccessible(factoryMethod); return null; &#125;); &#125; else &#123; ReflectionUtils.makeAccessible(factoryMethod); &#125; Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get(); try &#123; currentlyInvokedFactoryMethod.set(factoryMethod); // æ‰§è¡Œå·¥å‚æ–¹æ³•ï¼Œå¹¶è¿”å›å®ä¾‹ Object result = factoryMethod.invoke(factoryBean, args); if (result == null) &#123; result = new NullBean(); &#125; return result; &#125; finally &#123; if (priorInvokedFactoryMethod != null) &#123; currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod); &#125; else &#123; currentlyInvokedFactoryMethod.remove(); &#125; &#125; &#125; // çœç•¥ä¸€æ³¢ catch&#125; instantiate() æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯åˆ©ç”¨ Java åå°„æ‰§è¡Œå·¥å‚æ–¹æ³•å¹¶è¿”å›åˆ›å»ºå¥½çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¿™æ®µä»£ç ï¼š Object result &#x3D; factoryMethod.invoke(factoryBean, args); åˆ°è¿™é‡Œ instantiateUsingFactoryMethod() å·²ç»åˆ†æå®Œæ¯•äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹å¼€å¯Beançš„å®ä¾‹åŒ–è¿›ç¨‹","date":"2020-01-19T02:19:06.000Z","path":"2020/01/19/1ad7c22b.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2846 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨ä¸Šç¯‡åšå®¢IOC ä¹‹ åˆ†æå„ scope çš„ bean åˆ›å»ºä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•æ²¡æœ‰è®²åˆ° createBean() ï¼Œè¯¥æ–¹æ³•çš„å¦‚ä¸‹ï¼š protected abstract Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException; è¯¥æ–¹æ³•å®šä¹‰åœ¨ AbstractBeanFactory ä¸­ã€‚å…¶å«ä¹‰æ˜¯æ ¹æ®ç»™å®šçš„ BeanDefinition å’Œ argså®ä¾‹åŒ–ä¸€ä¸ª bean å¯¹è±¡ï¼Œå¦‚æœè¯¥ BeanDefinition å­˜åœ¨çˆ¶ç±»ï¼Œåˆ™è¯¥ BeanDefinition å·²ç»åˆå¹¶äº†çˆ¶ç±»çš„å±æ€§ã€‚æ‰€æœ‰ Bean å®ä¾‹çš„åˆ›å»ºéƒ½ä¼šå§”æ‰˜ç»™è¯¥æ–¹æ³•å®ç°ã€‚ æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š beanNameï¼šbean çš„åå­— mbdï¼šå·²ç»åˆå¹¶äº†çˆ¶ç±»å±æ€§çš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰BeanDefinition argsï¼šç”¨äºæ„é€ å‡½æ•°æˆ–è€…å·¥å‚æ–¹æ³•åˆ›å»º bean å®ä¾‹å¯¹è±¡çš„å‚æ•° è¯¥æŠ½è±¡æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯åœ¨ç±» AbstractAutowireCapableBeanFactory ä¸­å®ç°ï¼Œå¦‚ä¸‹ï¼š protected Object createBean( String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Creating instance of bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; RootBeanDefinition mbdToUse = mbd; // ç¡®ä¿æ­¤æ—¶çš„ bean å·²ç»è¢«è§£æäº† // å¦‚æœè·å–çš„class å±æ€§ä¸ä¸ºnullï¼Œåˆ™å…‹éš†è¯¥ BeanDefinition // ä¸»è¦æ˜¯å› ä¸ºè¯¥åŠ¨æ€è§£æçš„ class æ— æ³•ä¿å­˜åˆ°åˆ°å…±äº«çš„ BeanDefinition Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123; mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); &#125; try &#123; // éªŒè¯å’Œå‡†å¤‡è¦†ç›–æ–¹æ³• mbdToUse.prepareMethodOverrides(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, &quot;Validation of method overrides failed&quot;, ex); &#125; try &#123; // ç»™ BeanPostProcessors ä¸€ä¸ªæœºä¼šç”¨æ¥è¿”å›ä¸€ä¸ªä»£ç†ç±»è€Œä¸æ˜¯çœŸæ­£çš„ç±»å®ä¾‹ // AOP çš„åŠŸèƒ½å°±æ˜¯åŸºäºè¿™ä¸ªåœ°æ–¹ Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, &quot;BeanPostProcessor before instantiation of bean failed&quot;, ex); &#125; try &#123; // æ‰§è¡ŒçœŸæ­£åˆ›å»º bean çš„è¿‡ç¨‹ Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Finished creating instance of bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; return beanInstance; &#125; catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123; throw ex; &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex); &#125;&#125; è¿‡ç¨‹å¦‚ä¸‹ï¼š è§£ææŒ‡å®š BeanDefinition çš„ class å¤„ç† override å±æ€§ å®ä¾‹åŒ–çš„å‰ç½®å¤„ç† åˆ›å»º bean è§£ææŒ‡å®š BeanDefinition çš„ class Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName) è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è§£æ bean definition çš„ class ç±»ï¼Œå¹¶å°†å·²ç»è§£æçš„ Class å­˜å‚¨åœ¨ bean definition ä¸­ä»¥ä¾›åé¢ä½¿ç”¨ã€‚å¦‚æœè§£æçš„ class ä¸ä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯¥ BeanDefinition è¿›è¡Œå…‹éš†è‡³ mbdToUseï¼Œè¿™æ ·åšçš„ä¸»è¦ç›®çš„æ˜¯ä»¥ä¸ºåŠ¨æ€è§£æçš„ class æ˜¯æ— æ³•ä¿å­˜åˆ°å…±äº«çš„ BeanDefinition ä¸­ã€‚ å¤„ç† override å±æ€§å¤§å®¶è¿˜è®°å¾— lookup-method å’Œ replace-method è¿™ä¸¤ä¸ªé…ç½®åŠŸèƒ½ï¼Ÿåœ¨åšå®¢ ã€æ­»ç£• Springã€‘â€”â€“ IOC ä¹‹è§£æBeanï¼šè§£æ bean æ ‡ç­¾ï¼ˆä¸‰ï¼‰ ä¸­å·²ç»è¯¦ç»†åˆ†æäº†è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç”¨æ³•å’Œè§£æè¿‡ç¨‹ï¼ŒçŸ¥é“è§£æè¿‡ç¨‹å…¶å®å°±æ˜¯è®²è¿™ä¸¤ä¸ªé…ç½®å­˜æ”¾åœ¨ BeanDefinition ä¸­çš„ methodOverrides å±æ€§ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ bean å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å¦‚æœæ£€æµ‹åˆ°å­˜åœ¨ methodOverridesï¼Œåˆ™ä¼šåŠ¨æ€åœ°ä½ä¸ºå½“å‰ bean ç”Ÿæˆä»£ç†å¹¶ä½¿ç”¨å¯¹åº”çš„æ‹¦æˆªå™¨ä¸º bean åšå¢å¼ºå¤„ç†ã€‚å…·ä½“çš„å®ç°æˆ‘ä»¬åç»­åˆ†æï¼Œç°åœ¨å…ˆçœ‹ mbdToUse.prepareMethodOverrides() éƒ½å¹²äº†äº›ä»€ä¹ˆäº‹ï¼Œå¦‚ä¸‹ï¼š public void prepareMethodOverrides() throws BeanDefinitionValidationException &#123; if (hasMethodOverrides()) &#123; Set&lt;MethodOverride&gt; overrides = getMethodOverrides().getOverrides(); synchronized (overrides) &#123; for (MethodOverride mo : overrides) &#123; prepareMethodOverride(mo); &#125; &#125; &#125;&#125; å¦‚æœå­˜åœ¨ methodOverrides åˆ™è·å–æ‰€æœ‰çš„ override method ï¼Œç„¶åé€šè¿‡è¿­ä»£çš„æ–¹æ³•ä¸€æ¬¡è°ƒç”¨ prepareMethodOverride() ï¼Œå¦‚ä¸‹ï¼š protected void prepareMethodOverride(MethodOverride mo) throws BeanDefinitionValidationException &#123; int count = ClassUtils.getMethodCountForName(getBeanClass(), mo.getMethodName()); if (count == 0) &#123; throw new BeanDefinitionValidationException( &quot;Invalid method override: no method with name &#x27;&quot; + mo.getMethodName() + &quot;&#x27; on class [&quot; + getBeanClassName() + &quot;]&quot;); &#125; else if (count == 1) &#123; mo.setOverloaded(false); &#125;&#125; æ ¹æ®æ–¹æ³•åç§°ä» class ä¸­è·å–è¯¥æ–¹æ³•åçš„ä¸ªæ•°ï¼Œå¦‚æœä¸º 0 åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœ ä¸º 1 åˆ™è®¾ç½®è¯¥é‡è½½æ–¹æ³•æ²¡æœ‰è¢«é‡è½½ã€‚è‹¥ä¸€ä¸ªç±»ä¸­å­˜åœ¨å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œåˆ™åœ¨æ–¹æ³•è°ƒç”¨çš„æ—¶å€™è¿˜éœ€è¦æ ¹æ®å‚æ•°ç±»å‹æ¥åˆ¤æ–­åˆ°åº•é‡è½½çš„æ˜¯å“ªä¸ªæ–¹æ³•ã€‚åœ¨è®¾ç½®é‡è½½çš„æ—¶å€™å…¶å®è¿™é‡Œåšäº†ä¸€ä¸ªå°å°ä¼˜åŒ–ï¼Œé‚£å°±æ˜¯å½“ count == 1 æ—¶ï¼Œè®¾ç½® overloaded = falseï¼Œè¿™æ ·è¡¨ç¤ºè¯¥æ–¹æ³•æ²¡æœ‰é‡è½½ï¼Œè¿™æ ·åœ¨åç»­è°ƒç”¨çš„æ—¶å€™ä¾¿å¯ä»¥ç›´æ¥æ‰¾åˆ°æ–¹æ³•è€Œä¸éœ€è¦è¿›è¡Œæ–¹æ³•å‚æ•°çš„æ ¡éªŒã€‚ è¯šç„¶ï¼Œå…¶å® mbdToUse.prepareMethodOverrides() å¹¶æ²¡æœ‰åšä»€ä¹ˆå®è´¨æ€§çš„å·¥ä½œï¼Œåªæ˜¯å¯¹ methodOverrides å±æ€§åšäº†ä¸€äº›ç®€å•çš„æ ¡éªŒè€Œå·²ã€‚ å®ä¾‹åŒ–çš„å‰ç½®å¤„ç† resolveBeforeInstantiation() çš„ä½œç”¨æ˜¯ç»™ BeanPostProcessors åç½®å¤„ç†å™¨è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡çš„æœºä¼šï¼Œå…¶å®åœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰ Spring ä¸€ç›´éƒ½æ²¡æœ‰åˆ›å»º bean ï¼Œé‚£ä¹ˆè¿™é‡Œè¿”å›ä¸€ä¸ª bean çš„ä»£ç†ç±»æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿä½œç”¨ä½“ç°åœ¨åé¢çš„ if åˆ¤æ–­ï¼š if (bean != null) &#123; return bean;&#125; å¦‚æœä»£ç†å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ä»£ç†å¯¹è±¡ï¼Œè¿™ä¸€æ­¥éª¤æœ‰éå¸¸é‡è¦çš„ä½œç”¨ï¼ŒSpring åç»­å®ç° AOP å°±æ˜¯åŸºäºè¿™ä¸ªåœ°æ–¹åˆ¤æ–­çš„ã€‚ protected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) &#123; Object bean = null; if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123; if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; Class&lt;?&gt; targetType = determineTargetType(beanName, mbd); if (targetType != null) &#123; bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName); if (bean != null) &#123; bean = applyBeanPostProcessorsAfterInitialization(bean, beanName); &#125; &#125; &#125; mbd.beforeInstantiationResolved = (bean != null); &#125; return bean;&#125; è¿™ä¸ªæ–¹æ³•æ ¸å¿ƒå°±åœ¨äº applyBeanPostProcessorsBeforeInstantiation() å’Œ applyBeanPostProcessorsAfterInitialization() ä¸¤ä¸ªæ–¹æ³•ï¼Œbefore ä¸ºå®ä¾‹åŒ–å‰çš„åå¤„ç†å™¨åº”ç”¨ï¼Œafter ä¸ºå®ä¾‹åŒ–åçš„åå¤„ç†å™¨åº”ç”¨ï¼Œç”±äºæœ¬æ–‡çš„ä¸»é¢˜æ˜¯åˆ›å»º beanï¼Œå…³äº Bean çš„å¢å¼ºå¤„ç†åç»­ LZ ä¼šå•ç‹¬å‡ºåšæ–‡æ¥åšè¯¦ç»†è¯´æ˜ã€‚ åˆ›å»º bean å¦‚æœæ²¡æœ‰ä»£ç†å¯¹è±¡ï¼Œå°±åªèƒ½èµ°å¸¸è§„çš„è·¯çº¿è¿›è¡Œ bean çš„åˆ›å»ºäº†ï¼Œè¯¥è¿‡ç¨‹æœ‰ doCreateBean() å®ç°ï¼Œå¦‚ä¸‹ï¼š protected Object doCreateBean( final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args) throws BeanCreationException &#123; // BeanWrapperæ˜¯å¯¹Beançš„åŒ…è£…ï¼Œå…¶æ¥å£ä¸­æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œ // è·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨ BeanWrapper instanceWrapper = null; // å•ä¾‹æ¨¡å‹ï¼Œåˆ™ä»æœªå®Œæˆçš„ FactoryBean ç¼“å­˜ä¸­åˆ é™¤ if (mbd.isSingleton()) &#123; anceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; // ä½¿ç”¨åˆé€‚çš„å®ä¾‹åŒ–ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ã€ç®€å•åˆå§‹åŒ– if (instanceWrapper == null) &#123; instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; // åŒ…è£…çš„å®ä¾‹å¯¹è±¡ final Object bean = instanceWrapper.getWrappedInstance(); // åŒ…è£…çš„å®ä¾‹å¯¹è±¡çš„ç±»å‹ Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) &#123; mbd.resolvedTargetType = beanType; &#125; // æ£€æµ‹æ˜¯å¦æœ‰åç½®å¤„ç† // å¦‚æœæœ‰åç½®å¤„ç†ï¼Œåˆ™å…è®¸åç½®å¤„ç†ä¿®æ”¹ BeanDefinition synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; // applyMergedBeanDefinitionPostProcessors // åç½®å¤„ç†ä¿®æ”¹ BeanDefinition applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // è§£å†³å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ– // å•ä¾‹æ¨¡å¼ &amp; è¿è¡Œå¾ªç¯ä¾èµ–&amp;å½“å‰å•ä¾‹ bean æ˜¯å¦æ­£åœ¨è¢«åˆ›å»º boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; // æå‰å°†åˆ›å»ºçš„ bean å®ä¾‹åŠ å…¥åˆ°ectFactory ä¸­ // è¿™é‡Œæ˜¯ä¸ºäº†åæœŸé¿å…å¾ªç¯ä¾èµ– addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); &#125; /* * å¼€å§‹åˆå§‹åŒ– bean å®ä¾‹å¯¹è±¡ */ Object exposedObject = bean; try &#123; // å¯¹ bean è¿›è¡Œå¡«å……ï¼Œå°†å„ä¸ªå±æ€§å€¼æ³¨å…¥ï¼Œå…¶ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»– bean çš„å±æ€§ // åˆ™ä¼šé€’å½’åˆå§‹ä¾èµ– bean populateBean(beanName, mbd, instanceWrapper); // è°ƒç”¨åˆå§‹åŒ–æ–¹æ³• exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; /** * å¾ªç¯ä¾èµ–å¤„ç† */ if (earlySingletonExposure) &#123; // è·å– earlySingletonReference Object earlySingletonReference = getSingleton(beanName, false); // åªæœ‰åœ¨å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼ŒearlySingletonReference æ‰ä¸ä¼šä¸ºç©º if (earlySingletonReference != null) &#123; // å¦‚æœ exposedObject æ²¡æœ‰åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¢«æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«å¢å¼º if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; // å¤„ç†ä¾èµ– else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException( beanName, &quot;Bean with name &#x27;&quot; + beanName + &quot;&#x27; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; +&quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; try &#123; // æ³¨å†Œ bean registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;&#125; æ•´ä½“çš„æ€è·¯ï¼š å¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™æ¸…é™¤ factoryBeanInstanceCache ç¼“å­˜ï¼ŒåŒæ—¶è¿”å› BeanWrapper å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶å¦‚æœå­˜åœ¨ã€‚ å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ BeanWrapper æˆ–è€…ä¸æ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™è°ƒç”¨ createBeanInstance() å®ä¾‹åŒ– beanï¼Œä¸»è¦æ˜¯å°† BeanDefinition è½¬æ¢ä¸º BeanWrapper MergedBeanDefinitionPostProcessor çš„åº”ç”¨ å•ä¾‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç† è°ƒç”¨ populateBean() è¿›è¡Œå±æ€§å¡«å……ã€‚å°†æ‰€æœ‰å±æ€§å¡«å……è‡³ bean çš„å®ä¾‹ä¸­ è°ƒç”¨ initializeBean() åˆå§‹åŒ– bean ä¾èµ–æ£€æŸ¥ æ³¨å†Œ DisposableBean doCreateBean() å®Œæˆ bean çš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œï¼Œå†…å®¹å¤ªå¤šï¼Œè¿™é‡Œå°±åªåˆ—å‡ºæ•´ä½“æ€è·¯ï¼Œä¸‹æ–‡å¼€å§‹å°†è¯¥æ–¹æ³•è¿›è¡Œæ‹†åˆ†è¿›è¡Œè¯¦ç»†è®²è§£ï¼Œåˆ†å¸ƒä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œé˜è¿°ï¼š createBeanInstance() å®ä¾‹åŒ– bean populateBean() å±æ€§å¡«å…… å¾ªç¯ä¾èµ–çš„å¤„ç† initializeBean() åˆå§‹åŒ– bean","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹åˆ†æå„scopeçš„beanåˆ›å»º","date":"2020-01-18T02:23:01.000Z","path":"2020/01/18/13d2205c.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2839 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE singleton Spring çš„ scope é»˜è®¤ä¸º singletonï¼Œå…¶åˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);&#125; ç¬¬ä¸€éƒ¨åˆ†åˆ†æäº†ä»ç¼“å­˜ä¸­è·å–å•ä¾‹æ¨¡å¼çš„ beanï¼Œä½†æ˜¯å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨å‘¢ï¼Ÿ åˆ™éœ€è¦ä»å¤´å¼€å§‹åŠ è½½ beanï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± getSingleton() å®ç°ã€‚ public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(beanName, &quot;Bean name must not be null&quot;); // å…¨å±€åŠ é” synchronized (this.singletonObjects) &#123; // ä»ç¼“å­˜ä¸­æ£€æŸ¥ä¸€é // å› ä¸º singleton æ¨¡å¼å…¶å®å°±æ˜¯å¤ç”¨å·²ç»åˆ›å»ºçš„ bean æ‰€ä»¥è¿™æ­¥éª¤å¿…é¡»æ£€æŸ¥ Object singletonObject = this.singletonObjects.get(beanName); // ä¸ºç©ºï¼Œå¼€å§‹åŠ è½½è¿‡ç¨‹ if (singletonObject == null) &#123; // çœç•¥ éƒ¨åˆ†ä»£ç  // åŠ è½½å‰ç½®å¤„ç† beforeSingletonCreation(beanName); boolean newSingleton = false; // çœç•¥ä»£ç  try &#123; // åˆå§‹åŒ– bean // è¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯è°ƒç”¨ createBean() æ–¹æ³• singletonObject = singletonFactory.getObject(); newSingleton = true; &#125; // çœç•¥ catch éƒ¨åˆ† &#125; finally &#123; // åç½®å¤„ç† afterSingletonCreation(beanName); &#125; // åŠ å…¥ç¼“å­˜ä¸­ if (newSingleton) &#123; addSingleton(beanName, singletonObject); &#125; &#125; // ç›´æ¥è¿”å› return singletonObject;&#125; å…¶å®è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»º beanï¼Œä»…ä»…åªæ˜¯åšäº†ä¸€éƒ¨åˆ†å‡†å¤‡å’Œé¢„å¤„ç†æ­¥éª¤ï¼ŒçœŸæ­£è·å–å•ä¾‹ bean çš„æ–¹æ³•å…¶å®æ˜¯ç”± singletonFactory.getObject() è¿™éƒ¨åˆ†å®ç°ï¼Œè€Œ singletonFactory ç”±å›è°ƒæ–¹æ³•äº§ç”Ÿã€‚ é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†å“ªäº›å‡†å¤‡å‘¢ï¼Ÿ å†æ¬¡æ£€æŸ¥ç¼“å­˜æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»åŠ è½½äº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å¼€å§‹åŠ è½½è¿‡ç¨‹ã€‚ è°ƒç”¨ beforeSingletonCreation() è®°å½•åŠ è½½å•ä¾‹ bean ä¹‹å‰çš„åŠ è½½çŠ¶æ€ï¼Œå³å‰ç½®å¤„ç†ã€‚ è°ƒç”¨å‚æ•°ä¼ é€’çš„ ObjectFactory çš„ getObject() å®ä¾‹åŒ– beanã€‚ è°ƒç”¨ afterSingletonCreation() è¿›è¡ŒåŠ è½½å•ä¾‹åçš„åç½®å¤„ç†ã€‚ å°†ç»“æœè®°å½•å¹¶åŠ å…¥å€¼ç¼“å­˜ä¸­ï¼ŒåŒæ—¶åˆ é™¤åŠ è½½ bean è¿‡ç¨‹ä¸­æ‰€è®°å½•çš„ä¸€äº›è¾…åŠ©çŠ¶æ€ã€‚ æµç¨‹ä¸­æ¶‰åŠçš„ä¸‰ä¸ªæ–¹æ³• beforeSingletonCreation() ä¸ afterSingletonCreation() åœ¨åšå®¢ IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean ä¸­åˆ†æè¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†é˜è¿°äº†ï¼Œæˆ‘ä»¬çœ‹å¦å¤–ä¸€ä¸ªæ–¹æ³• addSingleton()ã€‚ protected void addSingleton(String beanName, Object singletonObject) &#123; synchronized (this.singletonObjects) &#123; this.singletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName); &#125;&#125; ä¸€ä¸ª putã€ä¸€ä¸ª addã€ä¸¤ä¸ª removeã€‚ singletonObjects å•ä¾‹ bean çš„ç¼“å­˜ singletonFactories å•ä¾‹ bean Factory çš„ç¼“å­˜ earlySingletonObjects â€œæ—©æœŸâ€åˆ›å»ºçš„å•ä¾‹ bean çš„ç¼“å­˜ registeredSingletons å·²ç»æ³¨å†Œçš„å•ä¾‹ç¼“å­˜ã€‚ åŠ è½½äº†å•ä¾‹ bean åï¼Œè°ƒç”¨ getObjectForBeanInstance() ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡ã€‚è¯¥æ–¹æ³•å·²ç»åœ¨ IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean è¯¦ç»†åˆ†æäº†ã€‚ åŸå‹æ¨¡å¼ else if (mbd.isPrototype()) &#123; Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);&#125; åŸå‹æ¨¡å¼çš„åˆå§‹åŒ–è¿‡ç¨‹å¾ˆç®€å•ï¼šç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹å°±å¯ä»¥äº†ã€‚ è¿‡ç¨‹å¦‚ä¸‹ï¼š è°ƒç”¨ beforeSingletonCreation() è®°å½•åŠ è½½åŸå‹æ¨¡å¼ bean ä¹‹å‰çš„åŠ è½½çŠ¶æ€ï¼Œå³å‰ç½®å¤„ç†ã€‚ è°ƒç”¨ createBean() åˆ›å»ºä¸€ä¸ª bean å®ä¾‹å¯¹è±¡ã€‚ è°ƒç”¨ afterSingletonCreation() è¿›è¡ŒåŠ è½½åŸå‹æ¨¡å¼ bean åçš„åç½®å¤„ç†ã€‚ è°ƒç”¨ getObjectForBeanInstance() ä» bean å®ä¾‹ä¸­è·å–å¯¹è±¡ã€‚ å…¶ä»–ä½œç”¨åŸŸ String scopeName = mbd.getScope();final Scope scope = this.scopes.get(scopeName);if (scope == null) &#123; throw new IllegalStateException( &quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;);&#125;try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);&#125;catch (IllegalStateException ex) &#123; throw new BeanCreationException( beanName, &quot;Scope &#x27;&quot; + scopeName + &quot;&#x27; is not active for the current thread; consider &quot; + &quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;, ex);&#125; æ ¸å¿ƒæµç¨‹å’ŒåŸå‹æ¨¡å¼ä¸€æ ·ï¼Œåªä¸è¿‡è·å– bean å®ä¾‹æ˜¯ç”± scope.get() å®ç°ï¼Œå¦‚ä¸‹ï¼š public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) &#123; // è·å– scope ç¼“å­˜ Map&lt;String, Object&gt; scope = this.threadScope.get(); Object scopedObject = scope.get(name); if (scopedObject == null) &#123; scopedObject = objectFactory.getObject(); // åŠ å…¥ç¼“å­˜ scope.put(name, scopedObject); &#125; return scopedObject;&#125; å¯¹äºä¸Šé¢ä¸‰ä¸ªæ¨¡å—ï¼Œå…¶ä¸­æœ€é‡è¦çš„æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š createBean() å’ŒgetObjectForBeanInstance()ã€‚ è¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ä¸Šé¢ä¸‰ä¸ªæ¨¡å—éƒ½æœ‰è°ƒç”¨ï¼ŒcreateBean() åç»­è¯¦ç»†è¯´æ˜ï¼ŒgetObjectForBeanInstance() åœ¨åšå®¢IOC ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean ä¸­æœ‰è¯¦ç»†è®²è§£ï¼Œè¿™é‡Œå†æ¬¡é˜è¿°ä¸‹ï¼ˆæ­¤æ®µå†…å®¹æ¥è‡ªã€ŠSpring æºç æ·±åº¦è§£æã€‹ï¼‰ï¼šè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯éªŒè¯ä»¥ä¸‹æˆ‘ä»¬å¾—åˆ°çš„ bean çš„æ­£ç¡®æ€§ï¼Œå…¶å®å°±æ˜¯æ£€æµ‹å½“å‰ bean æ˜¯å¦æ˜¯ FactoryBean ç±»å‹çš„ beanï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨è¯¥ bean å¯¹åº”çš„ FactoryBean å®ä¾‹çš„ getObject() ä½œä¸ºè¿”å›å€¼ã€‚æ— è®ºæ˜¯ä»ç¼“å­˜ä¸­è·å¾—åˆ°çš„ bean è¿˜æ˜¯é€šè¿‡ä¸åŒçš„ scope ç­–ç•¥åŠ è½½çš„ bean éƒ½åªæ˜¯æœ€åŸå§‹çš„ bean çŠ¶æ€ï¼Œå¹¶ä¸ä¸€å®šå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ beanã€‚ ä¸¾ä¸ªä¾‹å­ï¼ŒåŠ å…¥æˆ‘ä»¬éœ€è¦å¯¹å·¥å‚ bean è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè¿™é‡Œå¾—åˆ°çš„å…¶å®æ˜¯å·¥å‚ bean çš„åˆå§‹çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ˜¯å·¥å‚ bean ä¸­å®šä¹‰ factory-method æ–¹æ³•ä¸­è¿”å›çš„ beanï¼Œè€Œ getObjectForBeanInstance() å°±æ˜¯å®Œæˆè¿™ä¸ªå·¥ä½œçš„ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹parentBeanFactoryä¸ä¾èµ–å¤„ç†","date":"2020-01-17T01:56:43.000Z","path":"2020/01/17/c4a8e2a2.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2810 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE ç»§ä¸Šç¯‡åšå®¢ åŠ è½½ bean ä¹‹ ç¼“å­˜ä¸­è·å–å•ä¾‹ bean,å¦‚æœä»å•ä¾‹ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°å•ä¾‹ beanï¼Œåˆ™è¯´æ˜ä¸¤ç§æƒ…å†µï¼š è¯¥ bean çš„ scope ä¸æ˜¯ singleton è¯¥ bean çš„ scope æ˜¯ singleton ,ä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µ Spring æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿç»Ÿä¸€åŠ è½½å¹¶å®Œæˆåˆå§‹åŒ–ï¼ è¿™éƒ¨åˆ†å†…å®¹çš„ç¯‡å¹…è¾ƒé•¿ï¼Œæ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š ç¬¬ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä¸€äº›æ£€æµ‹ã€parentBeanFactory ä»¥åŠä¾èµ–å¤„ç†ã€‚ ç¬¬äºŒéƒ¨åˆ†åˆ™æ˜¯å„ä¸ª scope çš„åˆå§‹åŒ–ã€‚ if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName);&#125;// Check if bean definition exists in this factory.BeanFactory parentBeanFactory = getParentBeanFactory();if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125;&#125;if (!typeCheckOnly) &#123; markBeanAsCreated(beanName);&#125;try &#123; final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125;&#125;// çœç•¥å¾ˆå¤šä»£ç  è¿™æ®µä»£ç ä¸»è¦å¤„ç†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š æ£€æµ‹ã€‚è‹¥å½“å‰ bean åœ¨åˆ›å»ºï¼Œåˆ™æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ã€‚ å¦‚æœ beanDefinitionMap ä¸­ä¸å­˜åœ¨ beanName çš„ BeanDefinitionï¼ˆå³åœ¨ Spring bean åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ²¡æœ‰åŠ è½½ï¼‰ï¼Œåˆ™å°è¯•ä» parentBeanFactory ä¸­åŠ è½½ã€‚ åˆ¤æ–­æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥ã€‚ ä» mergedBeanDefinitions ä¸­è·å– beanName å¯¹åº”çš„ RootBeanDefinitionï¼Œå¦‚æœè¿™ä¸ª BeanDefinition æ˜¯å­ Bean çš„è¯ï¼Œåˆ™ä¼šåˆå¹¶çˆ¶ç±»çš„ç›¸å…³å±æ€§ã€‚ ä¾èµ–å¤„ç†ã€‚ æ£€æµ‹ åœ¨å‰é¢å°±æè¿‡ï¼ŒSpring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹çš„å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–åˆ™æ˜¯æŠ›å‡º BeanCurrentlyInCreationException å¼‚å¸¸ï¼Œæ‰€ä»¥é¦–å…ˆæ£€æŸ¥è¯¥ beanName æ˜¯å¦å¤„äºåŸå‹æ¨¡å¼ä¸‹çš„å¾ªç¯ä¾èµ–ã€‚å¦‚ä¸‹ï¼š if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName);&#125; è°ƒç”¨ isPrototypeCurrentlyInCreation() åˆ¤æ–­å½“å‰ bean æ˜¯å¦æ­£åœ¨åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š protected boolean isPrototypeCurrentlyInCreation(String beanName) &#123; Object curVal = this.prototypesCurrentlyInCreation.get(); return (curVal != null &amp;&amp; (curVal.equals(beanName) || (curVal instanceof Set &amp;&amp; ((Set&lt;?&gt;) curVal).contains(beanName))));&#125; å…¶å®æ£€æµ‹é€»è¾‘å’Œå•ä¾‹æ¨¡å¼ä¸€æ ·ï¼Œä¸€ä¸ªâ€œé›†åˆâ€å­˜æ”¾ç€æ­£åœ¨åˆ›å»ºçš„ beanï¼Œä»è¯¥é›†åˆä¸­è¿›è¡Œåˆ¤æ–­å³å¯ï¼Œåªä¸è¿‡å•ä¾‹æ¨¡å¼çš„â€œé›†åˆâ€ä¸º Set ï¼Œè€ŒåŸå‹æ¨¡å¼çš„åˆ™æ˜¯ ThreadLocalï¼ŒprototypesCurrentlyInCreation å®šä¹‰å¦‚ä¸‹ï¼š private final ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation = new NamedThreadLocal&lt;&gt;(&quot;Prototype beans currently in creation&quot;); æ£€æŸ¥çˆ¶ç±» BeanFactory è‹¥ containsBeanDefinition ä¸­ä¸å­˜åœ¨ beanName ç›¸å¯¹åº”çš„ BeanDefinitionï¼Œåˆ™ä» parentBeanFactory ä¸­è·å–ã€‚ // è·å– parentBeanFactoryBeanFactory parentBeanFactory = getParentBeanFactory();// parentBeanFactory ä¸ä¸ºç©ºä¸” beanDefinitionMap ä¸­ä¸å­˜è¯¥ name çš„ BeanDefinitionif (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // ç¡®å®šåŸå§‹ beanName String nameToLookup = originalBeanName(name); // è‹¥ä¸º AbstractBeanFactory ç±»å‹ï¼Œå§”æ‰˜çˆ¶ç±»å¤„ç† if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; // å§”æ‰˜ç»™æ„é€ å‡½æ•° getBean() å¤„ç† return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // æ²¡æœ‰ argsï¼Œå§”æ‰˜ç»™æ ‡å‡†çš„ getBean() å¤„ç† return parentBeanFactory.getBean(nameToLookup, requiredType); &#125;&#125; æ•´ä¸ªè¿‡ç¨‹è¾ƒä¸ºç®€å•ï¼Œéƒ½æ˜¯å§”æ‰˜ parentBeanFactory çš„ getBean() è¿›è¡Œå¤„ç†ï¼Œåªä¸è¿‡åœ¨è·å–ä¹‹å‰å¯¹ name è¿›è¡Œç®€å•çš„å¤„ç†ï¼Œä¸»è¦æ˜¯æƒ³è·å–åŸå§‹çš„ beanNameï¼Œå¦‚ä¸‹ï¼š protected String originalBeanName(String name) &#123; String beanName = transformedBeanName(name); if (name.startsWith(FACTORY_BEAN_PREFIX)) &#123; beanName = FACTORY_BEAN_PREFIX + beanName; &#125; return beanName;&#125; transformedBeanName() æ˜¯å¯¹ name è¿›è¡Œè½¬æ¢ï¼Œè·å–çœŸæ­£çš„ beanNameï¼Œå› ä¸ºæˆ‘ä»¬ä¼ é€’çš„å¯èƒ½æ˜¯ aliasNameï¼ˆè¿™ä¸ªè¿‡ç¨‹åœ¨åšå®¢ IOC ä¹‹ å¼€å¯ bean çš„åŠ è½½ ä¸­åˆ†æ transformedBeanName() æœ‰è¯¦ç»†è¯´æ˜ï¼‰ï¼Œå¦‚æœ name æ˜¯ä»¥ â€œ&amp;â€ å¼€å¤´çš„ï¼Œåˆ™åŠ ä¸Š â€œ&amp;â€ï¼Œå› ä¸ºåœ¨ transformedBeanName() å°† â€œ&amp;â€ å»æ‰äº†ï¼Œè¿™é‡Œè¡¥ä¸Šã€‚ ç±»å‹æ£€æŸ¥ å‚æ•° typeCheckOnly æ˜¯ç”¨æ¥åˆ¤æ–­è°ƒç”¨ getBean() æ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥è·å– beanã€‚å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œåˆ™éœ€è¦è°ƒç”¨ markBeanAsCreated() è®°å½•ï¼š protected void markBeanAsCreated(String beanName) &#123; // æ²¡æœ‰åˆ›å»º if (!this.alreadyCreated.contains(beanName)) &#123; // åŠ ä¸Šå…¨å±€é” synchronized (this.mergedBeanDefinitions) &#123; // å†æ¬¡æ£€æŸ¥ä¸€æ¬¡ï¼šDCL åŒæ£€æŸ¥æ¨¡å¼ if (!this.alreadyCreated.contains(beanName)) &#123; // ä» mergedBeanDefinitions ä¸­åˆ é™¤ beanNameï¼Œ // å¹¶åœ¨ä¸‹æ¬¡è®¿é—®æ—¶é‡æ–°åˆ›å»ºå®ƒã€‚ clearMergedBeanDefinition(beanName); // æ·»åŠ åˆ°å·²åˆ›å»ºbean é›†åˆä¸­ this.alreadyCreated.add(beanName); &#125; &#125; &#125;&#125; è·å– RootBeanDefinition final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); è°ƒç”¨ getMergedLocalBeanDefinition() è·å–ç›¸å¯¹åº”çš„ BeanDefinitionï¼Œå¦‚ä¸‹ï¼š protected RootBeanDefinition getMergedLocalBeanDefinition(String beanName) throws BeansException &#123; // å¿«é€Ÿä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å› RootBeanDefinition mbd = this.mergedBeanDefinitions.get(beanName); if (mbd != null) &#123; return mbd; &#125; // è·å– RootBeanDefinitionï¼Œ // å¦‚æœè¿”å›çš„ BeanDefinition æ˜¯å­ç±» bean çš„è¯ï¼Œåˆ™åˆå¹¶çˆ¶ç±»ç›¸å…³å±æ€§ return getMergedBeanDefinition(beanName, getBeanDefinition(beanName));&#125; é¦–å…ˆç›´æ¥ä» mergedBeanDefinitions ç¼“å­˜ä¸­è·å–ç›¸åº”çš„ RootBeanDefinitionï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›å¦åˆ™è°ƒç”¨ getMergedBeanDefinition() è·å– RootBeanDefinitionï¼Œè‹¥è·å–çš„ BeanDefinition ä¸ºå­ BeanDefinitionï¼Œåˆ™éœ€è¦åˆå¹¶çˆ¶ç±»çš„ç›¸å…³å±æ€§ã€‚ å¤„ç†ä¾èµ– å¦‚æœä¸€ä¸ª bean æœ‰ä¾èµ– bean çš„è¯ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ–è¯¥ bean æ—¶æ˜¯éœ€è¦å…ˆåˆå§‹åŒ–å®ƒæ‰€ä¾èµ–çš„ beanã€‚ // è·å–ä¾èµ–ã€‚// åœ¨åˆå§‹åŒ– bean æ—¶è§£æ depends-on æ ‡ç­¾æ—¶è®¾ç½®String[] dependsOn = mbd.getDependsOn();if (dependsOn != null) &#123; // è¿­ä»£ä¾èµ– for (String dep : dependsOn) &#123; // æ£€éªŒä¾èµ–çš„bean æ˜¯å¦å·²ç»æ³¨å†Œç»™å½“å‰ bean è·å–å…¶ä»–ä¼ é€’ä¾èµ–bean if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; // æ³¨å†Œåˆ°ä¾èµ–beanä¸­ registerDependentBean(dep, beanName); try &#123; // è°ƒç”¨ getBean åˆå§‹åŒ–ä¾èµ–bean getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125;&#125; è¿™æ®µä»£ç é€»è¾‘æ˜¯ï¼šé€šè¿‡è¿­ä»£çš„æ–¹å¼ä¾æ¬¡å¯¹ä¾èµ– bean è¿›è¡Œæ£€æµ‹ã€æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è°ƒç”¨ getBean() å®ä¾‹åŒ–ä¾èµ– beanã€‚ isDependent() æ˜¯æ ¡éªŒè¯¥ä¾èµ–æ˜¯å¦å·²ç»æ³¨å†Œç»™å½“å‰ beanã€‚ protected boolean isDependent(String beanName, String dependentBeanName) &#123; synchronized (this.dependentBeanMap) &#123; return isDependent(beanName, dependentBeanName, null); &#125;&#125; åŒæ­¥åŠ é”ç»™ dependentBeanMap å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ isDependent() æ ¡éªŒã€‚dependentBeanMap å¯¹è±¡ä¿å­˜çš„æ˜¯ä¾èµ– beanName ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼šbeanName - &gt; ä¾èµ– beanName çš„é›†åˆ private boolean isDependent(String beanName, String dependentBeanName, @Nullable Set&lt;String&gt; alreadySeen) &#123; // alreadySeen å·²ç»æ£€æµ‹çš„ä¾èµ– bean if (alreadySeen != null &amp;&amp; alreadySeen.contains(beanName)) &#123; return false; &#125; // è·å–åŸå§‹ beanName String canonicalName = canonicalName(beanName); // è·å–å½“å‰ beanName çš„ä¾èµ–é›†åˆ Set&lt;String&gt; dependentBeans = this.dependentBeanMap.get(canonicalName); // ä¸å­˜åœ¨ä¾èµ–ï¼Œè¿”å›false if (dependentBeans == null) &#123; return false; &#125; // å­˜åœ¨ï¼Œåˆ™è¯æ˜å­˜åœ¨å·²ç»æ³¨å†Œçš„ä¾èµ– if (dependentBeans.contains(dependentBeanName)) &#123; return true; &#125; // é€’å½’æ£€æµ‹ä¾èµ– for (String transitiveDependency : dependentBeans) &#123; if (alreadySeen == null) &#123; alreadySeen = new HashSet&lt;&gt;(); &#125; alreadySeen.add(beanName); if (isDependent(transitiveDependency, dependentBeanName, alreadySeen)) &#123; return true; &#125; &#125; return false;&#125; å¦‚æœæ ¡éªŒæˆåŠŸï¼Œåˆ™è°ƒç”¨ registerDependentBean() å°†è¯¥ä¾èµ–è¿›è¡Œæ³¨å†Œï¼Œä¾¿äºåœ¨é”€æ¯ bean ä¹‹å‰å¯¹å…¶è¿›è¡Œé”€æ¯ã€‚ public void registerDependentBean(String beanName, String dependentBeanName) &#123; String canonicalName = canonicalName(beanName); synchronized (this.dependentBeanMap) &#123; Set&lt;String&gt; dependentBeans = this.dependentBeanMap.computeIfAbsent( canonicalName, k -&gt; new LinkedHashSet&lt;&gt;(8)); if (!dependentBeans.add(dependentBeanName)) &#123; return; &#125; &#125; synchronized (this.dependenciesForBeanMap) &#123; Set&lt;String&gt; dependenciesForBean = this.dependenciesForBeanMap.computeIfAbsent( dependentBeanName, k -&gt; new LinkedHashSet&lt;&gt;(8)); dependenciesForBean.add(canonicalName); &#125;&#125; å…¶å®å°†å°±æ˜¯è¯¥æ˜ å°„å…³ç³»ä¿å­˜åˆ°ä¸¤ä¸ªé›†åˆä¸­ï¼šdependentBeanMapã€dependenciesForBeanMapã€‚ æœ€åè°ƒç”¨ getBean() å®ä¾‹åŒ–ä¾èµ– beanã€‚ è‡³æ­¤ï¼ŒåŠ è½½ bean çš„ç¬¬äºŒä¸ªéƒ¨åˆ†ä¹Ÿåˆ†æå®Œæ¯•äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹ä»å•ä¾‹ç¼“å­˜ä¸­è·å–å•ä¾‹bean","date":"2020-01-16T12:33:19.000Z","path":"2020/01/16/c9c155de.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2808 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE ä»è¿™ç¯‡åšå®¢å¼€å§‹æˆ‘ä»¬å¼€å§‹åŠ è½½ bean çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼Œä»ç¼“å­˜ä¸­è·å– beanï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š Object sharedInstance = getSingleton(beanName);if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.debug(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);&#125; é¦–å…ˆè°ƒç”¨ getSingleton() ä»ç¼“å­˜ä¸­è·å– beanï¼Œåœ¨ä¸Šç¯‡åšå®¢ IOC ä¹‹ å¼€å¯ bean çš„åŠ è½½ æåˆ°è¿‡ï¼ŒSpring å¯¹å•ä¾‹æ¨¡å¼çš„ bean åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œåç»­å¦‚æœå†è·å–è¯¥ bean åˆ™æ˜¯ç›´æ¥ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ï¼Œè¯¥è¿‡ç¨‹å°±ä½“ç°åœ¨ getSingleton() ä¸­ã€‚å¦‚ä¸‹ï¼š public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true);&#125;protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // ä»å•ä¾‹ç¼“å†²ä¸­åŠ è½½ bean Object singletonObject = this.singletonObjects.get(beanName); // ç¼“å­˜ä¸­çš„ bean ä¸ºç©ºï¼Œä¸”å½“å‰ bean æ­£åœ¨åˆ›å»º if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; // åŠ é” synchronized (this.singletonObjects) &#123; // ä» earlySingletonObjects è·å– singletonObject = this.earlySingletonObjects.get(beanName); // earlySingletonObjects ä¸­æ²¡æœ‰ï¼Œä¸”å…è®¸æå‰åˆ›å»º if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; // ä» singletonFactories ä¸­è·å–å¯¹åº”çš„ ObjectFactory ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); // ObjectFactory ä¸ä¸ºç©ºï¼Œåˆ™åˆ›å»º bean if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; return singletonObject;&#125; è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œé¦–å…ˆä» singletonObjects ä¸­è·å–ï¼Œè‹¥ä¸ºç©ºä¸”å½“å‰ bean æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™ä» earlySingletonObjects ä¸­è·å–ï¼Œè‹¥ä¸ºç©ºä¸”å…è®¸æå‰åˆ›å»ºåˆ™ä» singletonFactories ä¸­è·å–ç›¸åº”çš„ ObjectFactory ï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å…¶ getObject() åˆ›å»º beanï¼Œç„¶åå°†å…¶åŠ å…¥åˆ° earlySingletonObjectsï¼Œç„¶åä» singletonFactories åˆ é™¤ã€‚ æ€»ä½“é€»è¾‘å°±æ˜¯æ ¹æ® beanName ä¾æ¬¡æ£€æµ‹è¿™ä¸‰ä¸ª Mapï¼Œè‹¥ä¸ºç©ºï¼Œä»ä¸‹ä¸€ä¸ªï¼Œå¦åˆ™è¿”å›ã€‚ è¿™ä¸‰ä¸ª Map å­˜æ”¾çš„éƒ½æœ‰å„è‡ªçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š singletonObjects ï¼šå­˜æ”¾çš„æ˜¯å•ä¾‹ beanï¼Œå¯¹åº”å…³ç³»ä¸º bean name --&gt; bean instance earlySingletonObjectsï¼šå­˜æ”¾çš„æ˜¯æ—©æœŸçš„ beanï¼Œå¯¹åº”å…³ç³»ä¹Ÿæ˜¯ bean name --&gt; bean instanceã€‚å®ƒä¸ singletonObjects åŒºåˆ«åœ¨äº earlySingletonObjects ä¸­å­˜æ”¾çš„ bean ä¸ä¸€å®šæ˜¯å®Œæ•´çš„ï¼Œä»ä¸Šé¢è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£ï¼Œbean åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å°±å·²ç»åŠ å…¥åˆ° earlySingletonObjects ä¸­äº†ï¼Œæ‰€ä»¥å½“åœ¨ bean çš„åˆ›å»ºè¿‡ç¨‹ä¸­å°±å¯ä»¥é€šè¿‡ getBean() æ–¹æ³•è·å–ã€‚è¿™ä¸ª Map ä¹Ÿæ˜¯è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®æ‰€åœ¨ã€‚ singletonFactoriesï¼šå­˜æ”¾çš„æ˜¯ ObjectFactoryï¼Œå¯ä»¥ç†è§£ä¸ºåˆ›å»ºå•ä¾‹ bean çš„ factoryï¼Œå¯¹åº”å…³ç³»æ˜¯ bean name --&gt; ObjectFactory åœ¨ä¸Šé¢ä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ£€æµ‹æ–¹æ³• isSingletonCurrentlyInCreation(beanName)ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­è¯¥ beanName å¯¹åº”çš„ bean æ˜¯å¦åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæ³¨æ„è¿™ä¸ªè¿‡ç¨‹è®²çš„æ˜¯æ•´ä¸ªå·¥å‚ä¸­ã€‚å¦‚ä¸‹ï¼š public boolean isSingletonCurrentlyInCreation(String beanName) &#123; return this.singletonsCurrentlyInCreation.contains(beanName);&#125; ä»è¿™æ®µä»£ç ä¸­æˆ‘ä»¬å¯ä»¥é¢„æµ‹ï¼Œåœ¨ bean åˆ›å»ºè¿‡ç¨‹ä¸­éƒ½ä¼šå°†å…¶åŠ å…¥åˆ° singletonsCurrentlyInCreation é›†åˆä¸­ï¼Œå…·ä½“æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŠ çš„ï¼Œæˆ‘ä»¬åé¢åˆ†æã€‚ åˆ°è¿™é‡Œä»ç¼“å­˜ä¸­è·å– bean çš„è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•äº†ï¼Œæˆ‘ä»¬å†çœ‹å¼€ç¯‡çš„ä»£ç æ®µï¼Œä»ç¼“å­˜ä¸­è·å– bean åï¼Œè‹¥å…¶ä¸ä¸º null ä¸” args ä¸ºç©ºï¼Œåˆ™ä¼šè°ƒç”¨ getObjectForBeanInstance() å¤„ç†ã€‚ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆä¸€æ®µå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä»ç¼“å­˜ä¸­è·å–çš„ bean æ˜¯æœ€åŸå§‹çš„ bean å¹¶ä¸ä¸€å®šä½¿æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ beanï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè°ƒç”¨ getObjectForBeanInstance() è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•çš„å®šä¹‰ä¸ºè·å–ç»™å®š bean å®ä¾‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¦ä¹ˆæ˜¯ bean å®ä¾‹æœ¬èº«ï¼Œè¦ä¹ˆå°±æ˜¯ FactoryBean åˆ›å»ºçš„å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š protected Object getObjectForBeanInstance( Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) &#123; // è‹¥ä¸ºå·¥å‚ç±»å¼•ç”¨ï¼ˆname ä»¥ &amp; å¼€å¤´ï¼‰ if (BeanFactoryUtils.isFactoryDereference(name)) &#123; // å¦‚æœæ˜¯ NullBeanï¼Œåˆ™ç›´æ¥è¿”å› if (beanInstance instanceof NullBean) &#123; return beanInstance; &#125; // å¦‚æœ beanInstance ä¸æ˜¯ FactoryBean ç±»å‹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if (!(beanInstance instanceof FactoryBean)) &#123; throw new BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass()); &#125; &#125; // åˆ°è¿™é‡Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ª bean å®ä¾‹ï¼Œå½“ç„¶è¯¥å®ä¾‹å¯èƒ½æ˜¯ä¼šæ˜¯æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ bean åˆæˆ–è€…æ˜¯ä¸€ä¸ª FactoryBean // å¦‚æœæ˜¯ FactoryBeanï¼Œæˆ‘æˆ‘ä»¬åˆ™åˆ›å»ºè¯¥ bean if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123; return beanInstance; &#125; // åŠ è½½ FactoryBean Object object = null; // è‹¥ BeanDefinition ä¸º nullï¼Œåˆ™ä»ç¼“å­˜ä¸­åŠ è½½ if (mbd == null) &#123; object = getCachedObjectForFactoryBean(beanName); &#125; // è‹¥ object ä¾ç„¶ä¸ºç©ºï¼Œåˆ™å¯ä»¥ç¡®è®¤ï¼ŒbeanInstance ä¸€å®šæ˜¯ FactoryBean if (object == null) &#123; FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance; // if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123; mbd = getMergedLocalBeanDefinition(beanName); &#125; // æ˜¯å¦æ˜¯ç”¨æˆ·å®šä¹‰çš„è€Œä¸æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰çš„ boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic()); // æ ¸å¿ƒå¤„ç†ç±» object = getObjectFromFactoryBean(factory, beanName, !synthetic); &#125; return object;&#125; è¯¥æ–¹æ³•ä¸»è¦æ˜¯è¿›è¡Œæ£€æµ‹å·¥ä½œçš„ï¼Œä¸»è¦å¦‚ä¸‹ï¼š è‹¥ name ä¸ºå·¥å‚ç›¸å…³çš„ï¼ˆä»¥ &amp; å¼€å¤´ï¼‰ï¼Œä¸” beanInstance ä¸º NullBean ç±»å‹åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœ beanInstance ä¸ä¸º FactoryBean ç±»å‹åˆ™æŠ›å‡º BeanIsNotAFactoryException å¼‚å¸¸ã€‚è¿™é‡Œä¸»è¦æ˜¯æ ¡éªŒ beanInstance çš„æ­£ç¡®æ€§ã€‚ å¦‚æœ beanInstance ä¸ä¸º FactoryBean ç±»å‹æˆ–è€… name ä¹Ÿä¸æ˜¯ä¸å·¥å‚ç›¸å…³çš„ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚è¿™é‡Œä¸»è¦æ˜¯å¯¹é FactoryBean ç±»å‹å¤„ç†ã€‚ å¦‚æœ BeanDefinition ä¸ºç©ºï¼Œåˆ™ä» factoryBeanObjectCache ä¸­åŠ è½½ï¼Œå¦‚æœè¿˜æ˜¯ç©ºï¼Œåˆ™å¯ä»¥æ–­å®š beanInstance ä¸€å®šæ˜¯ FactoryBean ç±»å‹ï¼Œåˆ™å§”æ‰˜ getObjectFromFactoryBean() æ–¹æ³•å¤„ç† ä»ä¸Šé¢å¯ä»¥çœ‹å‡º getObjectForBeanInstance() ä¸»è¦æ˜¯è¿”å›ç»™å®šçš„ bean å®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶è¯¥å®ä¾‹å¯¹è±¡ä¸ºé FactoryBean ç±»å‹ï¼Œå¯¹äº FactoryBean ç±»å‹çš„ beanï¼Œåˆ™æ˜¯å§”æ‰˜ getObjectFromFactoryBean() ä» FactoryBean è·å– bean å®ä¾‹å¯¹è±¡ã€‚ protected Object getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess) &#123; // ä¸ºå•ä¾‹æ¨¡å¼ä¸”ç¼“å­˜ä¸­å­˜åœ¨ if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123; synchronized (getSingletonMutex()) &#123; // ä»ç¼“å­˜ä¸­è·å–æŒ‡å®šçš„ factoryBean Object object = this.factoryBeanObjectCache.get(beanName); if (object == null) &#123; // ä¸ºç©ºï¼Œåˆ™ä» FactoryBean ä¸­è·å–å¯¹è±¡ object = doGetObjectFromFactoryBean(factory, beanName); // ä»ç¼“å­˜ä¸­è·å– Object alreadyThere = this.factoryBeanObjectCache.get(beanName); // **æˆ‘å®åœ¨æ˜¯ä¸æ˜ç™½è¿™é‡Œè¿™ä¹ˆåšçš„åŸå› ï¼Œè¿™é‡Œæ˜¯å¹²å˜›ï¼Ÿï¼Ÿï¼Ÿ** if (alreadyThere != null) &#123; object = alreadyThere; &#125; else &#123; // éœ€è¦åç»­å¤„ç† if (shouldPostProcess) &#123; // è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ if (isSingletonCurrentlyInCreation(beanName)) &#123; return object; &#125; // å‰ç½®å¤„ç† beforeSingletonCreation(beanName); try &#123; // å¯¹ä» FactoryBean è·å–çš„å¯¹è±¡è¿›è¡Œåå¤„ç† // ç”Ÿæˆçš„å¯¹è±¡å°†æš´éœ²ç»™beanå¼•ç”¨ object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( beanName, &quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;, ex); &#125; finally &#123; // åç½®å¤„ç† afterSingletonCreation(beanName); &#125; &#125; // ç¼“å­˜ if (containsSingleton(beanName)) &#123; this.factoryBeanObjectCache.put(beanName, object); &#125; &#125; &#125; return object; &#125; &#125; else &#123; // éå•ä¾‹ Object object = doGetObjectFromFactoryBean(factory, beanName); if (shouldPostProcess) &#123; try &#123; object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( beanName, &quot;Post-processing of FactoryBean&#x27;s object failed&quot;, ex); &#125; &#125; return object; &#125;&#125; ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š è‹¥ä¸ºå•ä¾‹ä¸”å•ä¾‹ bean ç¼“å­˜ä¸­å­˜åœ¨ beanNameï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†ï¼ˆè·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼‰ï¼Œå¦åˆ™åˆ™ä» FactoryBean ä¸­è·å– bean å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ¥å—åç½®å¤„ç†ï¼Œåˆ™è°ƒç”¨ postProcessObjectFromFactoryBean() è¿›è¡Œåç½®å¤„ç†ã€‚ é¦–å…ˆè·å–é”ï¼ˆå…¶å®æˆ‘ä»¬åœ¨å‰é¢ç¯‡å¹…ä¸­å‘ç°äº†å¤§é‡çš„åŒæ­¥é”ï¼Œé”ä½çš„å¯¹è±¡éƒ½æ˜¯ this.singletonObjectsï¼Œ ä¸»è¦æ˜¯å› ä¸ºåœ¨å•ä¾‹æ¨¡å¼ä¸­å¿…é¡»è¦ä¿è¯å…¨å±€å”¯ä¸€ï¼‰ï¼Œç„¶åä» factoryBeanObjectCache ç¼“å­˜ä¸­è·å–å®ä¾‹å¯¹è±¡ objectï¼Œè‹¥ object ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ doGetObjectFromFactoryBean()æ–¹æ³•ä» FactoryBean è·å–å¯¹è±¡ï¼Œå…¶å®å†…éƒ¨å°±æ˜¯è°ƒç”¨ FactoryBean.getObject()ã€‚ å¦‚æœéœ€è¦åç»­å¤„ç†ï¼Œåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š è‹¥è¯¥ bean å¤„äºåˆ›å»ºä¸­ï¼ˆisSingletonCurrentlyInCreationï¼‰ï¼Œåˆ™è¿”å›éå¤„ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒ è°ƒç”¨ beforeSingletonCreation() è¿›è¡Œåˆ›å»ºä¹‹å‰çš„å¤„ç†ã€‚é»˜è®¤å®ç°å°†è¯¥ bean æ ‡å¿—ä¸ºå½“å‰åˆ›å»ºçš„ã€‚ è°ƒç”¨ postProcessObjectFromFactoryBean() å¯¹ä» FactoryBean è·å–çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯æŒ‰ç…§åŸæ ·ç›´æ¥è¿”å›ï¼Œå…·ä½“å®ç°æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­å®ç°çš„ï¼Œå½“ç„¶å­ç±»ä¹Ÿå¯ä»¥é‡å†™å®ƒï¼Œæ¯”å¦‚åº”ç”¨åç½®å¤„ç† è°ƒç”¨ afterSingletonCreation() è¿›è¡Œåˆ›å»º bean ä¹‹åçš„å¤„ç†ï¼Œé»˜è®¤å®ç°æ˜¯å°†è¯¥ bean æ ‡è®°ä¸ºä¸å†åœ¨åˆ›å»ºä¸­ã€‚ æœ€ååŠ å…¥åˆ° FactoryBeans ç¼“å­˜ä¸­ã€‚ è¯¥æ–¹æ³•åº”è¯¥å°±æ˜¯åˆ›å»º bean å®ä¾‹å¯¹è±¡ä¸­çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€äº†ã€‚è¿™é‡Œæˆ‘ä»¬å…³æ³¨ä¸‰ä¸ªæ–¹æ³•ï¼šbeforeSingletonCreation() ã€ afterSingletonCreation() ã€ postProcessObjectFromFactoryBean()ã€‚å¯èƒ½æœ‰å°ä¼™ä¼´è§‰å¾—å‰é¢ä¸¤ä¸ªæ–¹æ³•ä¸æ˜¯å¾ˆé‡è¦ï¼ŒLZ å¯ä»¥è‚¯å®šå‘Šè¯‰ä½ ï¼Œè¿™ä¸¤æ–¹æ³•æ˜¯éå¸¸é‡è¦çš„æ“ä½œï¼Œå› ä¸ºä»–ä»¬è®°å½•ç€ bean çš„åŠ è½½çŠ¶æ€ï¼Œæ˜¯æ£€æµ‹å½“å‰ bean æ˜¯å¦å¤„äºåˆ›å»ºä¸­çš„å…³é”®ä¹‹å¤„ï¼Œå¯¹è§£å†³ bean å¾ªç¯ä¾èµ–èµ·ç€å…³é”®ä½œç”¨ã€‚before æ–¹æ³•ç”¨äºæ ‡å¿—å½“å‰ bean å¤„äºåˆ›å»ºä¸­ï¼Œafter åˆ™æ˜¯ç§»é™¤ã€‚å…¶å®åœ¨è¿™ç¯‡åšå®¢åˆšåˆšå¼€å§‹å°±å·²ç»æåˆ°äº† isSingletonCurrentlyInCreation() æ˜¯ç”¨äºæ£€æµ‹å½“å‰ bean æ˜¯å¦å¤„äºåˆ›å»ºä¹‹ä¸­ï¼Œå¦‚ä¸‹ï¼š public boolean isSingletonCurrentlyInCreation(String beanName) &#123; return this.singletonsCurrentlyInCreation.contains(beanName);&#125; æ˜¯æ ¹æ® singletonsCurrentlyInCreation é›†åˆä¸­æ˜¯å¦åŒ…å«äº† beanNameï¼Œé›†åˆçš„å…ƒç´ åˆ™ä¸€å®šæ˜¯åœ¨ beforeSingletonCreation() ä¸­æ·»åŠ çš„ï¼Œå¦‚ä¸‹ï¼š protected void beforeSingletonCreation(String beanName) &#123; if (!this.inCreationCheckExclusions.contains(beanName) &amp;&amp; !this.singletonsCurrentlyInCreation.add(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125;&#125; afterSingletonCreation() ä¸ºç§»é™¤ï¼Œåˆ™ä¸€å®šå°±æ˜¯å¯¹ singletonsCurrentlyInCreation é›†åˆ remove äº†ï¼Œå¦‚ä¸‹ï¼š protected void afterSingletonCreation(String beanName) &#123; if (!this.inCreationCheckExclusions.contains(beanName) &amp;&amp; !this.singletonsCurrentlyInCreation.remove(beanName)) &#123; throw new IllegalStateException(&quot;Singleton &#x27;&quot; + beanName + &quot;&#x27; isn&#x27;t currently in creation&quot;); &#125;&#125; postProcessObjectFromFactoryBean() æ˜¯å¯¹ä» FactoryBean å¤„è·å–çš„ bean å®ä¾‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†ï¼Œå…¶é»˜è®¤å®ç°æ˜¯ç›´æ¥è¿”å› object å¯¹è±¡ï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œå­ç±»å¯ä»¥é‡å†™ï¼Œä¾‹å¦‚åº”ç”¨åå¤„ç†å™¨ã€‚ AbstractAutowireCapableBeanFactory å¯¹å…¶æä¾›äº†å®ç°ï¼Œå¦‚ä¸‹ï¼š protected Object postProcessObjectFromFactoryBean(Object object, String beanName) &#123; return applyBeanPostProcessorsAfterInitialization(object, beanName);&#125; è¯¥æ–¹æ³•çš„å®šä¹‰ä¸ºï¼šå¯¹æ‰€æœ‰çš„ {@code postProcessAfterInitialization} è¿›è¡Œå›è°ƒæ³¨å†Œ BeanPostProcessorsï¼Œè®©ä»–ä»¬èƒ½å¤ŸåæœŸå¤„ç†ä» FactoryBean ä¸­è·å–çš„å¯¹è±¡ã€‚ä¸‹é¢æ˜¯å…·ä½“å®ç°ï¼š public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123; Object current = beanProcessor.postProcessAfterInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result;&#125; å¯¹äºåç½®å¤„ç†å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšè¿‡å¤šé˜è¿°ï¼Œåé¢ä¼šä¸“é—¨çš„åšæ–‡è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œ è¿™é‡Œæˆ‘ä»¬åªéœ€è¦è®°ä½ä¸€ç‚¹ï¼šå°½å¯èƒ½ä¿è¯æ‰€æœ‰ bean åˆå§‹åŒ–åéƒ½ä¼šè°ƒç”¨æ³¨å†Œçš„ BeanPostProcessor.postProcessAfterInitialization() æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¤§å¯ä»¥é’ˆå¯¹æ­¤ç‰¹æ€§è®¾è®¡è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚ è‡³æ­¤ï¼Œä»ç¼“å­˜ä¸­è·å– bean å¯¹è±¡è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹å¼€å¯beançš„åŠ è½½","date":"2020-01-15T10:00:37.000Z","path":"2020/01/15/27d87789.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2806 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE (æ­¤å›¾æ¥è‡ªã€ŠSpring æ­ç§˜ã€‹) Spring IOCå®¹å™¨æ‰€èµ·çš„ä½œç”¨å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒä¼šä»¥æŸç§æ–¹å¼åŠ è½½ Configuration Metadataï¼Œå°†å…¶è§£ææ³¨å†Œåˆ°å®¹å™¨å†…éƒ¨ï¼Œç„¶åå›æ ¹æ®è¿™äº›ä¿¡æ¯ç»‘å®šæ•´ä¸ªç³»ç»Ÿçš„å¯¹è±¡ï¼Œæœ€ç»ˆç»„è£…æˆä¸€ä¸ªå¯ç”¨çš„åŸºäºè½»é‡çº§å®¹å™¨çš„åº”ç”¨ç³»ç»Ÿã€‚ Spring åœ¨å®ç°ä¸Šè¿°åŠŸèƒ½ä¸­ï¼Œå°†æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šå®¹å™¨åˆå§‹åŒ–é˜¶æ®µå’ŒåŠ è½½bean é˜¶æ®µã€‚ å®¹å™¨åˆå§‹åŒ–é˜¶æ®µï¼šé¦–å…ˆé€šè¿‡æŸç§æ–¹å¼åŠ è½½ Configuration Metadata (ä¸»è¦æ˜¯ä¾æ® Resourceã€ResourceLoader ä¸¤ä¸ªä½“ç³»)ï¼Œç„¶åå®¹å™¨ä¼šå¯¹åŠ è½½çš„ Configuration MetaData è¿›è¡Œè§£æå’Œåˆ†æï¼Œå¹¶å°†åˆ†æçš„ä¿¡æ¯ç»„è£…æˆ BeanDefinitionï¼Œå¹¶å°†å…¶ä¿å­˜æ³¨å†Œåˆ°ç›¸åº”çš„ BeanDefinitionRegistry ä¸­ã€‚è‡³æ­¤ï¼ŒSpring IOC çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆã€‚ åŠ è½½ bean é˜¶æ®µï¼šç»è¿‡å®¹å™¨åˆå§‹åŒ–é˜¶æ®µåï¼Œåº”ç”¨ç¨‹åºä¸­å®šä¹‰çš„ bean ä¿¡æ¯å·²ç»å…¨éƒ¨åŠ è½½åˆ°ç³»ç»Ÿä¸­äº†ï¼Œå½“æˆ‘ä»¬æ˜¾ç¤ºæˆ–è€…éšå¼åœ°è°ƒç”¨ getBean() æ—¶ï¼Œåˆ™ä¼šè§¦å‘åŠ è½½ bean é˜¶æ®µã€‚åœ¨è¿™é˜¶æ®µï¼Œå®¹å™¨ä¼šé¦–å…ˆæ£€æŸ¥æ‰€è¯·æ±‚çš„å¯¹è±¡æ˜¯å¦å·²ç»åˆå§‹åŒ–å®Œæˆäº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šæ ¹æ®æ³¨å†Œçš„ bean ä¿¡æ¯å®ä¾‹åŒ–è¯·æ±‚çš„å¯¹è±¡ï¼Œå¹¶ä¸ºå…¶æ³¨å†Œä¾èµ–ï¼Œç„¶åå°†å…¶è¿”å›ç»™è¯·æ±‚æ–¹ã€‚è‡³æ­¤ç¬¬äºŒä¸ªé˜¶æ®µä¹Ÿå·²ç»å®Œæˆã€‚ å½“æˆ‘ä»¬æ˜¾ç¤ºæˆ–è€…éšå¼åœ°è°ƒç”¨ getBean() æ—¶ï¼Œåˆ™ä¼šè§¦å‘åŠ è½½ bean é˜¶æ®µã€‚å¦‚ä¸‹ï¼š public Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false);&#125; å†…éƒ¨è°ƒç”¨ doGetBean() æ–¹æ³•ï¼Œå…¶æ¥å—å››ä¸ªå‚æ•°ï¼š nameï¼šè¦è·å– bean çš„åå­— requiredTypeï¼šè¦è·å– bean çš„ç±»å‹ argsï¼šåˆ›å»º bean æ—¶ä¼ é€’çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°ä»…é™äºåˆ›å»º bean æ—¶ä½¿ç”¨ typeCheckOnlyï¼šæ˜¯å¦ä¸ºç±»å‹æ£€æŸ¥ è¿™ä¸ªæ–¹æ³•çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå„ä½è€å¿ƒçœ‹ä¸‹ï¼š protected &lt;T&gt; T doGetBean( final String name, @Nullable final Class&lt;T&gt; requiredType, @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException &#123; // è·å– beanNameï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªè½¬æ¢åŠ¨ä½œï¼Œå°† name è½¬æ¢Wie beanName final String beanName = transformedBeanName(name); Object bean; // ä»ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­è·å– bean // *** è¿™é‡Œä¼šæ¶‰åŠåˆ°è§£å†³å¾ªç¯ä¾èµ– bean çš„é—®é¢˜ Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.debug(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; // å› ä¸º Spring åªè§£å†³å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œåœ¨åŸå‹æ¨¡å¼ä¸‹å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ // **å…³äºå¾ªç¯ä¾èµ–åç»­ä¼šå•ç‹¬å‡ºæ–‡è¯¦ç»†è¯´æ˜** if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; // å¦‚æœå®¹å™¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä»çˆ¶ç±»å®¹å™¨ä¸­åŠ è½½ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; &#125; // å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥åˆ™æ˜¯åˆ›å»ºbeanï¼Œè¿™é‡Œéœ€è¦è®°å½• if (!typeCheckOnly) &#123; markBeanAsCreated(beanName); &#125; try &#123; // ä»å®¹å™¨ä¸­è·å– beanName ç›¸åº”çš„ GenericBeanDefinitionï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º RootBeanDefinition final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); // æ£€æŸ¥ç»™å®šçš„åˆå¹¶çš„ BeanDefinition checkMergedBeanDefinition(mbd, beanName, args); // å¤„ç†æ‰€ä¾èµ–çš„ bean String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; // è‹¥ç»™å®šçš„ä¾èµ– bean å·²ç»æ³¨å†Œä¸ºä¾èµ–ç»™å®šçš„b ean // å¾ªç¯ä¾èµ–çš„æƒ…å†µ if (isDependent(beanName, dep)) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; // ç¼“å­˜ä¾èµ–è°ƒç”¨ registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125; // bean å®ä¾‹åŒ– // å•ä¾‹æ¨¡å¼ if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // æ˜¾ç¤ºä»å•åˆ©ç¼“å­˜ä¸­åˆ é™¤ bean å®ä¾‹ // å› ä¸ºå•ä¾‹æ¨¡å¼ä¸‹ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯èƒ½ä»–å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥é”€æ¯å®ƒ destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // åŸå‹æ¨¡å¼ else if (mbd.isPrototype()) &#123; // It&#x27;s a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; // ä»æŒ‡å®šçš„ scope ä¸‹åˆ›å»º bean String scopeName = mbd.getScope(); final Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException( &quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;); &#125; try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException( beanName, &quot;Scope &#x27;&quot; + scopeName + &quot;&#x27; is not active for the current thread; consider &quot; + &quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;, ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; // æ£€æŸ¥éœ€è¦çš„ç±»å‹æ˜¯å¦ç¬¦åˆ bean çš„å®é™…ç±»å‹ if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) &#123; try &#123; T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType); if (convertedBean == null) &#123; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; return convertedBean; &#125; catch (TypeMismatchException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Failed to convert bean &#x27;&quot; + name + &quot;&#x27; to required type &#x27;&quot; + ClassUtils.getQualifiedName(requiredType) + &quot;&#x27;&quot;, ex); &#125; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; &#125; return (T) bean;&#125; ä»£ç æ˜¯ç›¸å½“é•¿ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç›¸å½“å¤æ‚ï¼Œä¸‹é¢å°†å…¶è¿›è¡Œæ‹†åˆ†é˜è¿°ã€‚ 1.è·å– beanName final String beanName = transformedBeanName(name); è¿™é‡Œä¼ é€’çš„æ˜¯ nameï¼Œä¸ä¸€å®šå°±æ˜¯ beanNameï¼Œå¯èƒ½æ˜¯ aliasNameï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ FactoryBeanï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨ transformedBeanName() æ–¹æ³•å¯¹ name è¿›è¡Œä¸€ç•ªè½¬æ¢ï¼Œä¸»è¦å¦‚ä¸‹ï¼š protected String transformedBeanName(String name) &#123; return canonicalName(BeanFactoryUtils.transformedBeanName(name));&#125;// å»é™¤ FactoryBean çš„ä¿®é¥°ç¬¦public static String transformedBeanName(String name) &#123; Assert.notNull(name, &quot;&#x27;name&#x27; must not be null&quot;); String beanName = name; while (beanName.startsWith(BeanFactory.FACTORY_BEAN_PREFIX)) &#123; beanName = beanName.substring(BeanFactory.FACTORY_BEAN_PREFIX.length()); &#125; return beanName;&#125;// è½¬æ¢ aliasNamepublic String canonicalName(String name) &#123; String canonicalName = name; // Handle aliasing... String resolvedName; do &#123; resolvedName = this.aliasMap.get(canonicalName); if (resolvedName != null) &#123; canonicalName = resolvedName; &#125; &#125; while (resolvedName != null); return canonicalName;&#125; ä¸»è¦å¤„ç†è¿‡ç¨‹åŒ…æ‹¬ä¸¤æ­¥ï¼š å»é™¤ FactoryBean çš„ä¿®é¥°ç¬¦ã€‚å¦‚æœ name ä»¥ â€œ&amp;â€ ä¸ºå‰ç¼€ï¼Œé‚£ä¹ˆä¼šå»æ‰è¯¥ â€œ&amp;â€ï¼Œä¾‹å¦‚ï¼Œname = &quot;&amp;studentService&quot;ï¼Œåˆ™ä¼šæ˜¯ name = &quot;studentService&quot;ã€‚ å–æŒ‡å®šçš„ alias æ‰€è¡¨ç¤ºçš„æœ€ç»ˆ beanNameã€‚ä¸»è¦æ˜¯ä¸€ä¸ªå¾ªç¯è·å– beanName çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚åˆ«å A æŒ‡å‘åç§°ä¸º B çš„ bean åˆ™è¿”å› Bï¼Œè‹¥ åˆ«å A æŒ‡å‘åˆ«å Bï¼Œåˆ«å B æŒ‡å‘åç§°ä¸º C çš„ beanï¼Œåˆ™è¿”å› Cã€‚ 2.ä»å•ä¾‹ bean ç¼“å­˜ä¸­è·å– bean å¯¹åº”ä»£ç æ®µå¦‚ä¸‹ï¼š Object sharedInstance = getSingleton(beanName);if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;); &#125; else &#123; logger.debug(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;); &#125; &#125; bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);&#125; æˆ‘ä»¬çŸ¥é“å•ä¾‹æ¨¡å¼çš„ bean åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºåä¼šå°†è¯¥ bean åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œåé¢åœ¨è·å– bean å°±ä¼šç›´æ¥ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ã€‚å¦‚æœä»ç¼“å­˜ä¸­å¾—åˆ°äº† beanï¼Œåˆ™éœ€è¦è°ƒç”¨ getObjectForBeanInstance() å¯¹ bean è¿›è¡Œå®ä¾‹åŒ–å¤„ç†ï¼Œå› ä¸ºç¼“å­˜ä¸­è®°å½•çš„æ˜¯æœ€åŸå§‹çš„ bean çŠ¶æ€ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ beanã€‚ 3.åŸå‹æ¨¡å¼ä¾èµ–æ£€æŸ¥ä¸ parentBeanFactory å¯¹åº”ä»£ç æ®µ if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName);&#125;// Check if bean definition exists in this factory.BeanFactory parentBeanFactory = getParentBeanFactory();if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) &#123; return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); &#125; else if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125;&#125; Spring åªå¤„ç†å•ä¾‹æ¨¡å¼ä¸‹å¾—å¾ªç¯ä¾èµ–ï¼Œå¯¹äºåŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä¸»è¦åŸå› è¿˜æ˜¯åœ¨äº Spring è§£å†³å¾ªç¯ä¾èµ–çš„ç­–ç•¥æœ‰å…³ã€‚å¯¹äºå•ä¾‹æ¨¡å¼ Spring åœ¨åˆ›å»º bean çš„æ—¶å€™å¹¶ä¸æ˜¯ç­‰ bean å®Œå…¨åˆ›å»ºå®Œæˆåæ‰ä¼šå°† bean æ·»åŠ è‡³ç¼“å­˜ä¸­ï¼Œè€Œæ˜¯ä¸ç­‰ bean åˆ›å»ºå®Œæˆå°±ä¼šå°†åˆ›å»º bean çš„ ObjectFactory ææ—©åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œè¿™æ ·ä¸€æ—¦ä¸‹ä¸€ä¸ª bean åˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ– bean æ—¶åˆ™ç›´æ¥ä½¿ç”¨ ObjectFactroyã€‚ä½†æ˜¯åŸå‹æ¨¡å¼æˆ‘ä»¬çŸ¥é“æ˜¯æ²¡æ³•ä½¿ç”¨ç¼“å­˜çš„ï¼Œæ‰€ä»¥ Spring å¯¹åŸå‹æ¨¡å¼çš„å¾ªç¯ä¾èµ–å¤„ç†ç­–ç•¥åˆ™æ˜¯ä¸å¤„ç†ï¼ˆå…³äºå¾ªç¯ä¾èµ–åé¢ä¼šæœ‰å•ç‹¬æ–‡ç« è¯´æ˜ï¼‰ã€‚ å¦‚æœå®¹å™¨ç¼“å­˜ä¸­æ²¡æœ‰ç›¸å¯¹åº”çš„ BeanDefinition åˆ™ä¼šå°è¯•ä»çˆ¶ç±»å·¥å‚ï¼ˆparentBeanFactoryï¼‰ä¸­åŠ è½½ï¼Œç„¶åå†å»é€’å½’è°ƒç”¨ getBean()ã€‚ 4. ä¾èµ–å¤„ç† å¯¹åº”æºç å¦‚ä¸‹ï¼š String[] dependsOn = mbd.getDependsOn();if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125;&#125; æ¯ä¸ª bean éƒ½ä¸æ˜¯å•ç‹¬å·¥ä½œçš„ï¼Œå®ƒä¼šä¾èµ–å…¶ä»– beanï¼Œå…¶ä»– bean ä¹Ÿä¼šä¾èµ–å®ƒï¼Œå¯¹äºä¾èµ–çš„ bean ï¼Œå®ƒä¼šä¼˜å…ˆåŠ è½½ï¼Œæ‰€ä»¥åœ¨ Spring çš„åŠ è½½é¡ºåºä¸­ï¼Œåœ¨åˆå§‹åŒ–æŸä¸€ä¸ª bean çš„æ—¶å€™é¦–å…ˆä¼šåˆå§‹åŒ–è¿™ä¸ª bean çš„ä¾èµ–ã€‚ ä½œç”¨åŸŸå¤„ç† Spring bean çš„ä½œç”¨åŸŸé»˜è®¤ä¸º singletonï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–ä½œç”¨åŸŸï¼Œå¦‚prototypeã€requestã€session ç­‰ï¼Œä¸åŒçš„ä½œç”¨åŸŸä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥ã€‚ ç±»å‹è½¬æ¢ åœ¨è°ƒç”¨ doGetBean() æ–¹æ³•æ—¶ï¼Œæœ‰ä¸€ä¸ª requiredType å‚æ•°ï¼Œè¯¥å‚æ•°çš„åŠŸèƒ½å°±æ˜¯å°†è¿”å›çš„ bean è½¬æ¢ä¸º requiredType ç±»å‹ã€‚å½“ç„¶å°±ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬æ˜¯ä¸éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢çš„ï¼Œä¹Ÿå°±æ˜¯ requiredType ä¸ºç©ºï¼ˆæ¯”å¦‚ getBean(String name)ï¼‰ï¼Œä½†æœ‰å¯èƒ½ä¼šå­˜åœ¨è¿™ç§æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ä»¬è¿”å›çš„ bean ç±»å‹ä¸º Stringï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦å°†å…¶è½¬æ¢ä¸º Integerï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ requiredType å°±æœ‰ç”¨æ­¦ä¹‹åœ°äº†ã€‚å½“ç„¶æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä¸éœ€è¦è¿™æ ·åšçš„ã€‚ è‡³æ­¤ getBean() è¿‡ç¨‹è®²è§£å®Œäº†ã€‚åç»­å°†ä¼šå¯¹è¯¥è¿‡ç¨‹è¿›è¡Œæ‹†åˆ†ï¼Œæ›´åŠ è¯¦ç»†çš„è¯´æ˜ï¼Œå¼„æ¸…æ¥šå…¶ä¸­çš„æ¥é¾™å»è„‰ï¼Œæ‰€ä»¥è¿™ç¯‡åšå®¢åªèƒ½ç®—æ˜¯ Spring bean åŠ è½½è¿‡ç¨‹çš„ä¸€ä¸ªæ¦‚è§ˆã€‚ æ‹†åˆ†ä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š åˆ†æä»ç¼“å­˜ä¸­è·å–å•ä¾‹ beanï¼Œä»¥åŠå¯¹ bean çš„å®ä¾‹ä¸­è·å–å¯¹è±¡ å¦‚æœä»å•ä¾‹ç¼“å­˜ä¸­è·å– beanï¼ŒSpring æ˜¯æ€ä¹ˆåŠ è½½çš„å‘¢ï¼Ÿæ‰€ä»¥ç¬¬äºŒéƒ¨åˆ†æ˜¯åˆ†æ bean åŠ è½½ï¼Œä»¥åŠ bean çš„ä¾èµ–å¤„ç† bean å·²ç»åŠ è½½äº†ï¼Œä¾èµ–ä¹Ÿå¤„ç†å®Œæ¯•äº†ï¼Œç¬¬ä¸‰éƒ¨åˆ†åˆ™åˆ†æå„ä¸ªä½œç”¨åŸŸçš„ bean åˆå§‹åŒ–è¿‡ç¨‹ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹è£…è½½BeanDefinitionsæ€»ç»“","date":"2020-01-14T04:08:09.000Z","path":"2020/01/14/af13201.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=todo åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE å‰é¢åˆ†æäº† IoC BeanDefinition è£…è½½çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™ç¯‡å°±è¿™äº›å†…å®¹åšä¸€ä¸ªæ€»ç»“å°†å…¶è¿è´¯èµ·æ¥ã€‚ åœ¨å‰æ–‡æè¿‡ï¼ŒIoC å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥éª¤ï¼šResource å®šä½ã€BeanDefinition çš„è½½å…¥å’Œè§£æï¼ŒBeanDefinition æ³¨å†Œã€‚ Resource å®šä½ã€‚æˆ‘ä»¬ä¸€èˆ¬ç”¨å¤–éƒ¨èµ„æºæ¥æè¿° Bean å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– IoC å®¹å™¨çš„ç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦å®šä½è¿™ä¸ªå¤–éƒ¨èµ„æºã€‚åœ¨ä¸Šä¸€ç¯‡åšå®¢ï¼ˆã€ŠIoC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥ã€‹ï¼‰å·²ç»è¯¦ç»†è¯´æ˜äº†èµ„æºåŠ è½½çš„è¿‡ç¨‹ã€‚ BeanDefinition çš„è£…è½½å’Œè§£æ è£…è½½å°±æ˜¯ BeanDefinition çš„è½½å…¥ã€‚ è¯»å–ã€è§£æ Resource èµ„æºï¼Œä¹Ÿå°±æ˜¯å°†ç”¨æˆ·å®šä¹‰çš„ Bean è¡¨ç¤ºæˆ IoC å®¹å™¨çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼šBeanDefinition åœ¨ IoC å®¹å™¨å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª BeanDefinition Map çš„æ•°æ®ç»“æ„ åœ¨é…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ª éƒ½å¯¹åº”ç€ä¸€ä¸ª BeanDefinition å¯¹è±¡ã€‚ BeanDefinition æ³¨å†Œ å‘ IoC å®¹å™¨æ³¨å†Œåœ¨ç¬¬äºŒæ­¥è§£æå¥½çš„ BeanDefinitionï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ BeanDefinitionRegistry æ¥å£æ¥å®ç°çš„ã€‚ åœ¨ IoC å®¹å™¨å†…éƒ¨å…¶å®æ˜¯å°†ç¬¬äºŒä¸ªè¿‡ç¨‹è§£æå¾—åˆ°çš„ BeanDefinition æ³¨å…¥åˆ°ä¸€ä¸ª HashMap å®¹å™¨ä¸­ï¼ŒIoC å®¹å™¨å°±æ˜¯é€šè¿‡è¿™ä¸ª HashMap æ¥ç»´æŠ¤è¿™äº› BeanDefinition çš„ã€‚ åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰å®Œæˆä¾èµ–æ³¨å…¥ï¼ˆBean åˆ›å»ºï¼‰ï¼ŒBean åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨ #getBean(...) æ–¹æ³•ï¼Œå‘å®¹å™¨ç´¢è¦ Bean æ—¶ã€‚ å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®é¢„å¤„ç†ï¼Œå³å¯¹æŸä¸ª Bean è®¾ç½® lazyinit = false å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª Bean çš„ä¾èµ–æ³¨å…¥å°±ä¼šåœ¨å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å®Œæˆã€‚ åœ¨åšå®¢ ã€Š IoC ä¹‹åŠ è½½ BeanDefinitionã€‹ ä¸­æä¾›è¿‡ä¸€æ®µä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ ·ä¹Ÿä»¥è¿™æ®µä»£ç ä½œä¸ºæˆ‘ä»¬ç ”ç©¶ IoC åˆå§‹åŒ–è¿‡ç¨‹çš„å¼€ç«¯ï¼Œå¦‚ä¸‹ï¼š ClassPathResource resource = new ClassPathResource(&quot;bean.xml&quot;);DefaultListableBeanFactory factory = new DefaultListableBeanFactory();XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);reader.loadBeanDefinitions(resource); åˆšåˆšå¼€å§‹çš„æ—¶å€™å¯èƒ½å¯¹ä¸Šé¢è¿™å‡ è¡Œä»£ç ä¸çŸ¥é“ä»€ä¹ˆæ„æ€ï¼Œç°åœ¨åº”è¯¥å°±ä¸€ç›®äº†ç„¶äº†ï¼š ClassPathResource resource = new ClassPathResource(&quot;bean.xml&quot;); ï¼š æ ¹æ® Xml é…ç½®æ–‡ä»¶åˆ›å»º Resource èµ„æºå¯¹è±¡ã€‚ ClassPathResource æ˜¯ Resource æ¥å£çš„å­ç±»ï¼Œbean.xml æ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯æˆ‘ä»¬å®šä¹‰çš„ Bean ä¿¡æ¯ã€‚ DefaultListableBeanFactory factory = new DefaultListableBeanFactory(); ï¼šåˆ›å»ºä¸€ä¸ª BeanFactory ã€‚ DefaultListableBeanFactory æ˜¯ BeanFactory çš„ä¸€ä¸ªå­ç±»ï¼ŒBeanFactory ä½œä¸ºä¸€ä¸ªæ¥å£ï¼Œå…¶å®å®ƒæœ¬èº«æ˜¯ä¸å…·æœ‰ç‹¬ç«‹ä½¿ç”¨çš„åŠŸèƒ½çš„ï¼Œè€Œ DefaultListableBeanFactory åˆ™æ˜¯çœŸæ­£å¯ä»¥ç‹¬ç«‹ä½¿ç”¨çš„ IoC å®¹å™¨ï¼Œå®ƒæ˜¯æ•´ä¸ª Spring IoC çš„å§‹ç¥–ï¼Œåœ¨åç»­ä¼šæœ‰ä¸“é—¨çš„æ–‡ç« æ¥åˆ†æå®ƒã€‚ XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory); ï¼šåˆ›å»º XmlBeanDefinitionReader è¯»å–å™¨ï¼Œç”¨äºè½½å…¥ BeanDefinition ã€‚ reader.loadBeanDefinitions(resource);ï¼šå¼€å§‹ BeanDefinition çš„è½½å…¥å’Œæ³¨å†Œè¿›ç¨‹ï¼Œå®Œæˆåçš„ BeanDefinition æ”¾ç½®åœ¨ IoC å®¹å™¨ä¸­ã€‚ 1. Resource å®šä½Spring ä¸ºäº†è§£å†³èµ„æºå®šä½çš„é—®é¢˜ï¼Œæä¾›äº†ä¸¤ä¸ªæ¥å£ï¼šResourceã€ResourceLoaderï¼Œå…¶ä¸­ï¼š Resource æ¥å£æ˜¯ Spring ç»Ÿä¸€èµ„æºçš„æŠ½è±¡æ¥å£ ResourceLoader åˆ™æ˜¯ Spring èµ„æºåŠ è½½çš„ç»Ÿä¸€æŠ½è±¡ã€‚ å…³äºResourceã€ResourceLoader çš„æ›´å¤šçŸ¥è¯†è¯·å…³æ³¨ ã€ŠIoC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥ã€‹ Resource èµ„æºçš„å®šä½éœ€è¦ Resource å’Œ ResourceLoader ä¸¤ä¸ªæ¥å£äº’ç›¸é…åˆï¼Œåœ¨ä¸Šé¢é‚£æ®µä»£ç ä¸­ new ClassPathResource(&quot;bean.xml&quot;) ä¸ºæˆ‘ä»¬å®šä¹‰äº†èµ„æºï¼Œé‚£ä¹ˆ ResourceLoader åˆ™æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿ çœ‹ XmlBeanDefinitionReader æ„é€ æ–¹æ³•ï¼š // XmlBeanDefinitionReader.javapublic XmlBeanDefinitionReader(BeanDefinitionRegistry registry) &#123; super(registry);&#125; ç›´æ¥è°ƒç”¨çˆ¶ç±» AbstractBeanDefinitionReader æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š // AbstractBeanDefinitionReader.javaprotected AbstractBeanDefinitionReader(BeanDefinitionRegistry registry) &#123; Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;); this.registry = registry; // Determine ResourceLoader to use. if (this.registry instanceof ResourceLoader) &#123; this.resourceLoader = (ResourceLoader) this.registry; &#125; else &#123; this.resourceLoader = new PathMatchingResourcePatternResolver(); &#125; // Inherit Environment if possible if (this.registry instanceof EnvironmentCapable) &#123; this.environment = ((EnvironmentCapable) this.registry).getEnvironment(); &#125; else &#123; this.environment = new StandardEnvironment(); &#125;&#125; æ ¸å¿ƒåœ¨äºè®¾ç½® resourceLoader è¿™æ®µï¼Œå¦‚æœè®¾ç½®äº† ResourceLoader åˆ™ç”¨è®¾ç½®çš„ï¼Œå¦åˆ™ä½¿ç”¨ PathMatchingResourcePatternResolver ï¼Œè¯¥ç±»æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…çš„ ResourceLoaderã€‚ 2. BeanDefinition çš„è½½å…¥å’Œè§£æreader.loadBeanDefinitions(resource); ä»£ç æ®µï¼Œå¼€å¯ BeanDefinition çš„è§£æè¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š // XmlBeanDefinitionReader.java@Overridepublic int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException &#123; return loadBeanDefinitions(new EncodedResource(resource));&#125; åœ¨è¿™ä¸ªæ–¹æ³•ä¼šå°†èµ„æº resource åŒ…è£…æˆä¸€ä¸ª EncodedResource å®ä¾‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ #loadBeanDefinitions(EncodedResource encodedResource) æ–¹æ³•ã€‚ è€Œå°† Resource å°è£…æˆ EncodedResource ä¸»è¦æ˜¯ä¸ºäº†å¯¹ Resource è¿›è¡Œç¼–ç ï¼Œä¿è¯å†…å®¹è¯»å–çš„æ­£ç¡®æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š // XmlBeanDefinitionReader.java public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123; // ... çœç•¥ä¸€äº›ä»£ç  try &#123; // å°†èµ„æºæ–‡ä»¶è½¬ä¸º InputStream çš„ IO æµ InputStream inputStream = encodedResource.getResource().getInputStream(); try &#123; // ä» InputStream ä¸­å¾—åˆ° XML çš„è§£ææº InputSource inputSource = new InputSource(inputStream); if (encodedResource.getEncoding() != null) &#123; inputSource.setEncoding(encodedResource.getEncoding()); &#125; // ... å…·ä½“çš„è¯»å–è¿‡ç¨‹ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); &#125; finally &#123; inputStream.close(); &#125; &#125; // çœç•¥ä¸€äº›ä»£ç &#125; ä» encodedResource æºä¸­è·å– xml çš„è§£ææºï¼Œç„¶åè°ƒç”¨ #doLoadBeanDefinitions(InputSource inputSource, Resource resource) æ–¹æ³•ï¼Œæ‰§è¡Œå…·ä½“çš„è§£æè¿‡ç¨‹ã€‚ // XmlBeanDefinitionReader.java protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException &#123; try &#123; // è·å– XML Document å®ä¾‹ Document doc = doLoadDocument(inputSource, resource); // æ ¹æ® Document å®ä¾‹ï¼Œæ³¨å†Œ Bean ä¿¡æ¯ int count = registerBeanDefinitions(doc, resource); return count; &#125; // ... çœç•¥ä¸€å †é…ç½®&#125; åœ¨è¯¥æ–¹æ³•ä¸­ä¸»è¦åšä¸¤ä»¶äº‹ï¼š 1ã€æ ¹æ® xml è§£ææºè·å–ç›¸åº”çš„ Document å¯¹è±¡ã€‚ 2ã€è°ƒç”¨ #registerBeanDefinitions(Document doc, Resource resource) æ–¹æ³•ï¼Œå¼€å¯ BeanDefinition çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚ 2.1 è½¬æ¢ä¸º Document å¯¹è±¡è°ƒç”¨ #doLoadDocument(InputSource inputSource, Resource resource) æ–¹æ³•ï¼Œä¼šå°† Bean å®šä¹‰çš„èµ„æºè½¬æ¢ä¸º Document å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š // XmlBeanDefinitionReader.javaprotected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception &#123; return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler, getValidationModeForResource(resource), isNamespaceAware());&#125; è¯¥æ–¹æ³•æ¥å—äº”ä¸ªå‚æ•°ï¼š inputSource ï¼šåŠ è½½ Document çš„ Resource æºã€‚ entityResolverï¼šè§£ææ–‡ä»¶çš„è§£æå™¨ã€‚ ã€é‡è¦ã€‘è¯¦ç»†è§£æï¼Œè§ ã€Š IoC ä¹‹è·å– Document å¯¹è±¡ã€‹ ã€‚ errorHandler ï¼šå¤„ç†åŠ è½½ Document å¯¹è±¡çš„è¿‡ç¨‹çš„é”™è¯¯ã€‚ validationMode ï¼šéªŒè¯æ¨¡å¼ã€‚ ã€é‡è¦ã€‘è¯¦ç»†è§£æï¼Œè§ ã€Š IoC ä¹‹è·å–éªŒè¯æ¨¡å‹ã€‹ ã€‚ namespaceAware ï¼šå‘½åç©ºé—´æ”¯æŒã€‚å¦‚æœè¦æä¾›å¯¹ XML åç§°ç©ºé—´çš„æ”¯æŒï¼Œåˆ™ä¸º true ã€‚ #loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) æ–¹æ³•ï¼Œåœ¨ç±» DefaultDocumentLoader ä¸­æä¾›äº†å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š // DefaultDocumentLoader.java@Overridepublic Document loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) throws Exception &#123; // åˆ›å»º DocumentBuilderFactory DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware); // åˆ›å»º DocumentBuilder DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler); // è§£æ XML InputSource è¿”å› Document å¯¹è±¡ return builder.parse(inputSource);&#125; 2.2 æ³¨å†Œ BeanDefinition æµç¨‹è¿™åˆ°è¿™é‡Œï¼Œå°±å·²ç»å°†å®šä¹‰çš„ Bean èµ„æºæ–‡ä»¶ï¼Œè½½å…¥å¹¶è½¬æ¢ä¸º Document å¯¹è±¡äº†ã€‚ é‚£ä¹ˆï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¦‚ä½•å°†å…¶è§£æä¸º SpringIoC ç®¡ç†çš„ BeanDefinition å¯¹è±¡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ è¿™ä¸ªè¿‡ç¨‹ç”±æ–¹æ³• #registerBeanDefinitions(Document doc, Resource resource) æ–¹æ³•æ¥å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š // XmlBeanDefinitionReader.javapublic int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123; // åˆ›å»º BeanDefinitionDocumentReader å¯¹è±¡ BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); // è·å–å·²æ³¨å†Œçš„ BeanDefinition æ•°é‡ int countBefore = getRegistry().getBeanDefinitionCount(); // åˆ›å»º XmlReaderContext å¯¹è±¡ // æ³¨å†Œ BeanDefinition documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); // è®¡ç®—æ–°æ³¨å†Œçš„ BeanDefinition æ•°é‡ return getRegistry().getBeanDefinitionCount() - countBefore;&#125; é¦–å…ˆï¼Œåˆ›å»º BeanDefinition çš„è§£æå™¨ BeanDefinitionDocumentReader ã€‚ ç„¶åï¼Œè°ƒç”¨è¯¥ BeanDefinitionDocumentReader çš„ #registerBeanDefinitions(Document doc, XmlReaderContext readerContext) æ–¹æ³•ï¼Œå¼€å¯è§£æè¿‡ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å§”æ´¾æ¨¡å¼ï¼Œå…·ä½“çš„å®ç°ç”±å­ç±» DefaultBeanDefinitionDocumentReader å®Œæˆã€‚ä»£ç å¦‚ä¸‹ï¼š // DefaultBeanDefinitionDocumentReader.java@Overridepublic void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123; this.readerContext = readerContext; // è·å¾— XML Document Root Element // æ‰§è¡Œæ³¨å†Œ BeanDefinition doRegisterBeanDefinitions(doc.getDocumentElement());&#125; 2.2.1 å¯¹ Document å¯¹è±¡çš„è§£æä» Document å¯¹è±¡ä¸­è·å–æ ¹å…ƒç´  rootï¼Œç„¶åè°ƒç”¨ ``#doRegisterBeanDefinitions(Element root)` æ–¹æ³•ï¼Œå¼€å¯çœŸæ­£çš„è§£æè¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š // DefaultBeanDefinitionDocumentReader.javaprotected void doRegisterBeanDefinitions(Element root) &#123; // ... çœç•¥éƒ¨åˆ†ä»£ç ï¼ˆéæ ¸å¿ƒï¼‰ this.delegate = createDelegate(getReaderContext(), root, parent); // è§£æå‰å¤„ç† preProcessXml(root); // è§£æ parseBeanDefinitions(root, this.delegate); // è§£æåå¤„ç† postProcessXml(root);&#125; #preProcessXml(Element root)ã€#postProcessXml(Element root) ä¸ºå‰ç½®ã€åç½®å¢å¼ºå¤„ç†ï¼Œç›®å‰ Spring ä¸­éƒ½æ˜¯ç©ºå®ç°ã€‚ #parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) æ˜¯å¯¹æ ¹å…ƒç´  root çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š // DefaultBeanDefinitionDocumentReader.javaprotected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; // å¦‚æœæ ¹èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œé»˜è®¤è§£æ if (delegate.isDefaultNamespace(root)) &#123; // éå†å­èŠ‚ç‚¹ NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (node instanceof Element) &#123; Element ele = (Element) node; // å¦‚æœè¯¥èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œé»˜è®¤è§£æ if (delegate.isDefaultNamespace(ele)) &#123; parseDefaultElement(ele, delegate); // å¦‚æœè¯¥èŠ‚ç‚¹éé»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œè‡ªå®šä¹‰è§£æ &#125; else &#123; delegate.parseCustomElement(ele); &#125; &#125; &#125; // å¦‚æœæ ¹èŠ‚ç‚¹éé»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œè‡ªå®šä¹‰è§£æ &#125; else &#123; delegate.parseCustomElement(root); &#125;&#125; è¿­ä»£ root å…ƒç´ çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼š è‹¥èŠ‚ç‚¹ä¸ºé»˜è®¤å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ #parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) æ–¹æ³•ï¼Œå¼€å¯é»˜è®¤æ ‡ç­¾çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚ å¦åˆ™ï¼Œè°ƒç”¨ BeanDefinitionParserDelegate#parseCustomElement(Element ele) æ–¹æ³•ï¼Œå¼€å¯è‡ªå®šä¹‰æ ‡ç­¾çš„è§£ææ³¨å†Œè¿‡ç¨‹ã€‚ 2.2.1.1 é»˜è®¤æ ‡ç­¾è§£æè‹¥å®šä¹‰çš„å…ƒç´ èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯ Spring é»˜è®¤å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ #parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) æ–¹æ³•ï¼Œè¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æã€‚ä»£ç å¦‚ä¸‹ï¼š // DefaultBeanDefinitionDocumentReader.javaprivate void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123; if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123; // import importBeanDefinitionResource(ele); &#125; else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123; // alias processAliasRegistration(ele); &#125; else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123; // bean processBeanDefinition(ele, delegate); &#125; else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123; // beans // recurse doRegisterBeanDefinitions(ele); &#125;&#125; å¯¹å››å¤§æ ‡ç­¾ï¼šimportã€aliasã€beanã€beansè¿›è¡Œè§£æã€‚å…¶ä¸­ bean æ ‡ç­¾çš„è§£æä¸ºæ ¸å¿ƒå·¥ä½œã€‚ 2.2.1.2 è‡ªå®šä¹‰æ ‡ç­¾è§£æå¯¹äºé»˜è®¤æ ‡ç­¾åˆ™ç”± parseCustomElement(Element ele) æ–¹æ³•ï¼Œè´Ÿè´£è§£æã€‚ä»£ç å¦‚ä¸‹ï¼š // BeanDefinitionParserDelegate.java@Nullablepublic BeanDefinition parseCustomElement(Element ele) &#123; return parseCustomElement(ele, null);&#125;@Nullablepublic BeanDefinition parseCustomElement(Element ele, @Nullable BeanDefinition containingBd) &#123; // è·å– namespaceUri String namespaceUri = getNamespaceURI(ele); if (namespaceUri == null) &#123; return null; &#125; // æ ¹æ® namespaceUri è·å–ç›¸åº”çš„ Handler NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) &#123; error(&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot; + namespaceUri + &quot;]&quot;, ele); return null; &#125; // è°ƒç”¨è‡ªå®šä¹‰çš„ Handler å¤„ç† return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));&#125; è·å–èŠ‚ç‚¹çš„ namespaceUriï¼Œç„¶åæ ¹æ®è¯¥ namespaceUri è·å–ç›¸å¯¹åº”çš„ NamespaceHandlerï¼Œæœ€åè°ƒç”¨ NamespaceHandler çš„ #parse(Element element, ParserContext parserContext) æ–¹æ³•ï¼Œå³å®Œæˆè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æå’Œæ³¨å…¥ã€‚ 2.2.2 æ³¨å†Œ BeanDefinitionç»è¿‡ä¸Šé¢çš„è§£æï¼Œåˆ™å°† Document å¯¹è±¡é‡Œé¢çš„ Bean æ ‡ç­¾è§£ææˆäº†ä¸€ä¸ªä¸ªçš„ BeanDefinition ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯å°†è¿™äº› BeanDefinition æ³¨å†Œåˆ° IoC å®¹å™¨ä¸­ã€‚åŠ¨ä½œçš„è§¦å‘æ˜¯åœ¨è§£æ Bean æ ‡ç­¾å®Œæˆåï¼Œä»£ç å¦‚ä¸‹ï¼š // DefaultBeanDefinitionDocumentReader.javaprotected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; // è¿›è¡Œ bean å…ƒç´ è§£æã€‚ // å¦‚æœè§£ææˆåŠŸï¼Œåˆ™è¿”å› BeanDefinitionHolder å¯¹è±¡ã€‚ // è€Œ BeanDefinitionHolder ä¸º name å’Œ alias çš„ BeanDefinition å¯¹è±¡ // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™è¿”å› null ã€‚ BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) &#123; // è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾å¤„ç† bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // è¿›è¡Œ BeanDefinition çš„æ³¨å†Œ // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(&quot;Failed to register bean definition with name &#x27;&quot; + bdHolder.getBeanName() + &quot;&#x27;&quot;, ele, ex); &#125; // å‘å‡ºå“åº”äº‹ä»¶ï¼Œé€šçŸ¥ç›¸å…³çš„ç›‘å¬å™¨ï¼Œå·²å®Œæˆè¯¥ Bean æ ‡ç­¾çš„è§£æã€‚ // Send registration event. getReaderContext().fireComponentRegistered( new BeanComponentDefinition(bdHolder)); &#125;&#125; è°ƒç”¨ BeanDefinitionReaderUtils.registerBeanDefinition() æ–¹æ³•ï¼Œæ¥æ³¨å†Œã€‚ å…¶å®ï¼Œè¿™é‡Œé¢ä¹Ÿæ˜¯è°ƒç”¨ BeanDefinitionRegistry çš„ #registerBeanDefinition(String beanName, BeanDefinition beanDefinition) æ–¹æ³•ï¼Œæ¥æ³¨å†Œ BeanDefinition ã€‚ ä¸è¿‡ï¼Œæœ€ç»ˆçš„å®ç°æ˜¯åœ¨ DefaultListableBeanFactory ä¸­å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š // DefaultListableBeanFactory.java@Overridepublic void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123; // ...çœç•¥æ ¡éªŒç›¸å…³çš„ä»£ç  // ä»ç¼“å­˜ä¸­è·å–æŒ‡å®š beanName çš„ BeanDefinition BeanDefinition existingDefinition = this.beanDefinitionMap.get(beanName); // å¦‚æœå·²ç»å­˜åœ¨ if (existingDefinition != null) &#123; // å¦‚æœå­˜åœ¨ä½†æ˜¯ä¸å…è®¸è¦†ç›–ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (!isAllowBeanDefinitionOverriding()) &#123; throw new BeanDefinitionOverrideException(beanName, beanDefinition,existingDefinition); &#125; else &#123; // ...çœç•¥ logger æ‰“å°æ—¥å¿—ç›¸å…³çš„ä»£ç  &#125; // ã€é‡ç‚¹ã€‘å…è®¸è¦†ç›–ï¼Œç›´æ¥è¦†ç›–åŸæœ‰çš„ BeanDefinition åˆ° beanDefinitionMap ä¸­ã€‚ this.beanDefinitionMap.put(beanName, beanDefinition); // å¦‚æœæœªå­˜åœ¨ &#125; else &#123; // ... çœç•¥éæ ¸å¿ƒçš„ä»£ç  // ã€é‡ç‚¹ã€‘æ·»åŠ åˆ° BeanDefinition åˆ° beanDefinitionMap ä¸­ã€‚ this.beanDefinitionMap.put(beanName, beanDefinition); &#125; // é‡æ–°è®¾ç½® beanName å¯¹åº”çš„ç¼“å­˜ if (existingDefinition != null || containsSingleton(beanName)) &#123; resetBeanDefinition(beanName); &#125;&#125; è¿™æ®µä»£ç æœ€æ ¸å¿ƒçš„éƒ¨åˆ†æ˜¯è¿™å¥ this.beanDefinitionMap.put(beanName, beanDefinition) ä»£ç æ®µã€‚æ‰€ä»¥ï¼Œæ³¨å†Œè¿‡ç¨‹ä¹Ÿä¸æ˜¯é‚£ä¹ˆçš„é«˜å¤§ä¸Šï¼Œå°±æ˜¯åˆ©ç”¨ä¸€ä¸ª Map çš„é›†åˆå¯¹è±¡æ¥å­˜æ”¾ï¼škey æ˜¯ beanNameï¼Œvalue æ˜¯ BeanDefinition å¯¹è±¡ã€‚ 3. å°ç»“è‡³æ­¤ï¼Œæ•´ä¸ª IoC çš„åˆå§‹åŒ–è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†ï¼Œä» Bean èµ„æºçš„å®šä½ï¼Œè½¬æ¢ä¸º Document å¯¹è±¡ï¼Œæ¥ç€å¯¹å…¶è¿›è¡Œè§£æï¼Œæœ€åæ³¨å†Œåˆ° IoC å®¹å™¨ä¸­ï¼Œéƒ½å·²ç»å®Œç¾åœ°å®Œæˆäº†ã€‚ ç°åœ¨ IoC å®¹å™¨ä¸­å·²ç»å»ºç«‹äº†æ•´ä¸ª Bean çš„é…ç½®ä¿¡æ¯ï¼Œè¿™äº› Bean å¯ä»¥è¢«æ£€ç´¢ã€ä½¿ç”¨ã€ç»´æŠ¤ï¼Œä»–ä»¬æ˜¯æ§åˆ¶åè½¬çš„åŸºç¡€ï¼Œæ˜¯åé¢æ³¨å…¥ Bean çš„ä¾èµ–ã€‚æœ€åç”¨ä¸€å¼ æµç¨‹å›¾æ¥ç»“æŸè¿™ç¯‡æ€»ç»“ä¹‹æ–‡ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹æ³¨å†Œè§£æçš„BeanDefinitions","date":"2020-01-13T07:04:56.000Z","path":"2020/01/13/a9bec556.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2763 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE DefaultBeanDefinitionDocumentReader.processBeanDefinition() å®Œæˆ Bean æ ‡ç­¾è§£æçš„æ ¸å¿ƒå·¥ä½œï¼Œå¦‚ä¸‹ï¼š protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) &#123; bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(&quot;Failed to register bean definition with name &#x27;&quot; + bdHolder.getBeanName() + &quot;&#x27;&quot;, ele, ex); &#125; // Send registration event. getReaderContext().fireComponentRegistered( new BeanComponentDefinition(bdHolder)); &#125;&#125; è§£æå·¥ä½œåˆ†ä¸ºä¸‰æ­¥ï¼š è§£æé»˜è®¤æ ‡ç­¾ï¼› è§£æé»˜è®¤æ ‡ç­¾åä¸‹å¾—è‡ªå®šä¹‰æ ‡ç­¾ï¼› æ³¨å†Œè§£æåçš„ BeanDefinitionã€‚ ç»è¿‡å‰é¢ä¸¤ä¸ªæ­¥éª¤çš„è§£æï¼Œè¿™æ—¶çš„ BeanDefinition å·²ç»å¯ä»¥æ»¡è¶³åç»­çš„ä½¿ç”¨è¦æ±‚äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„å·¥ä½œå°±æ˜¯å°†è¿™äº› BeanDefinition è¿›è¡Œæ³¨å†Œï¼Œä¹Ÿå°±æ˜¯å®Œæˆç¬¬ä¸‰æ­¥ã€‚ æ³¨å†Œ BeanDefinition ç”± BeanDefinitionReaderUtils.registerBeanDefinition() å®Œæˆã€‚ å¦‚ä¸‹ï¼š public static void registerBeanDefinition( BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException &#123; // æ³¨å†Œ beanName String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); // æ³¨å†Œ alias String[] aliases = definitionHolder.getAliases(); if (aliases != null) &#123; for (String alias : aliases) &#123; registry.registerAlias(beanName, alias); &#125; &#125;&#125; é¦–å…ˆé€šè¿‡ beanName æ³¨å†Œ BeanDefinition ï¼Œ ç„¶åå†æ³¨å†Œåˆ«å aliasã€‚ BeanDefinition çš„æ³¨å†Œç”±æ¥å£ BeanDefinitionRegistry å®šä¹‰ã€‚ é€šè¿‡ beanName æ³¨å†Œ BeanDefinitionRegistry.registerBeanDefinition() å®ç°é€šè¿‡ beanName æ³¨å†Œ BeanDefinitionï¼Œå¦‚ä¸‹ï¼š public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123; // æ ¡éªŒ beanName ä¸ beanDefinition Assert.hasText(beanName, &quot;Bean name must not be empty&quot;); Assert.notNull(beanDefinition, &quot;BeanDefinition must not be null&quot;); if (beanDefinition instanceof AbstractBeanDefinition) &#123; try &#123; // æ ¡éªŒ BeanDefinition // è¿™æ˜¯æ³¨å†Œå‰çš„æœ€åä¸€æ¬¡æ ¡éªŒäº†ï¼Œä¸»è¦æ˜¯å¯¹å±æ€§ methodOverrides è¿›è¡Œæ ¡éªŒ ((AbstractBeanDefinition) beanDefinition).validate(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException( beanDefinition.getResourceDescription(), beanName,&quot;Validation of bean definition failed&quot;, ex); &#125; &#125; BeanDefinition oldBeanDefinition; // ä»ç¼“å­˜ä¸­è·å–æŒ‡å®š beanName çš„ BeanDefinition oldBeanDefinition = this.beanDefinitionMap.get(beanName); /** * å¦‚æœå­˜åœ¨ */ if (oldBeanDefinition != null) &#123; // å¦‚æœå­˜åœ¨ä½†æ˜¯ä¸å…è®¸è¦†ç›–ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (!isAllowBeanDefinitionOverriding()) &#123; throw new BeanDefinitionStoreException( beanDefinition.getResourceDescription(), beanName, &quot;Cannot register bean definition [&quot; + beanDefinition + &quot;] for bean &#x27;&quot; + beanName + &quot;&#x27;: There is already [&quot; + oldBeanDefinition + &quot;] bound.&quot;); &#125; // else if (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123; // e.g. was ROLE_APPLICATION, // now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE if (this.logger.isWarnEnabled()) &#123; this.logger.warn( &quot;Overriding user-defined bean definition for bean &#x27;&quot; + beanName + &quot;&#x27; with a framework-generated bean definition: replacing [&quot; + oldBeanDefinition + &quot;] with [&quot; + beanDefinition + &quot;]&quot;); &#125; &#125; // è¦†ç›– beanDefinition ä¸ è¢«è¦†ç›–çš„ beanDefinition ä¸æ˜¯åŒç±» else if (!beanDefinition.equals(oldBeanDefinition)) &#123; if (this.logger.isInfoEnabled()) &#123; this.logger.info( &quot;Overriding bean definition for bean &#x27;&quot; + beanName + &quot;&#x27; with a different definition: replacing [&quot; + oldBeanDefinition + &quot;] with [&quot; + beanDefinition + &quot;]&quot;); &#125; &#125; else &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug( &quot;Overriding bean definition for bean &#x27;&quot; + beanName + &quot;&#x27; with an equivalent definition: replacing [&quot; + oldBeanDefinition + &quot;] with [&quot; + beanDefinition + &quot;]&quot;); &#125; &#125; // å…è®¸è¦†ç›–ï¼Œç›´æ¥è¦†ç›–åŸæœ‰çš„ BeanDefinition this.beanDefinitionMap.put(beanName, beanDefinition); &#125; /** * ä¸å­˜åœ¨ */ else &#123; // æ£€æµ‹åˆ›å»º Bean é˜¶æ®µæ˜¯å¦å·²ç»å¼€å¯ï¼Œå¦‚æœå¼€å¯äº†åˆ™éœ€è¦å¯¹ beanDefinitionMap è¿›è¡Œå¹¶å‘æ§åˆ¶ if (hasBeanCreationStarted()) &#123; // beanDefinitionMap ä¸ºå…¨å±€å˜é‡ï¼Œé¿å…å¹¶å‘æƒ…å†µ synchronized (this.beanDefinitionMap) &#123; // this.beanDefinitionMap.put(beanName, beanDefinition); List&lt;String&gt; updatedDefinitions = new ArrayList&lt;&gt;(this.beanDefinitionNames.size() + 1); updatedDefinitions.addAll(this.beanDefinitionNames); updatedDefinitions.add(beanName); this.beanDefinitionNames = updatedDefinitions; if (this.manualSingletonNames.contains(beanName)) &#123; Set&lt;String&gt; updatedSingletons = new LinkedHashSet&lt;&gt;(this.manualSingletonNames); updatedSingletons.remove(beanName); this.manualSingletonNames = updatedSingletons; &#125; &#125; &#125; else &#123; // ä¸ä¼šå­˜åœ¨å¹¶å‘æƒ…å†µï¼Œç›´æ¥è®¾ç½® this.beanDefinitionMap.put(beanName, beanDefinition); this.beanDefinitionNames.add(beanName); this.manualSingletonNames.remove(beanName); &#125; this.frozenBeanDefinitionNames = null; &#125; if (oldBeanDefinition != null || containsSingleton(beanName)) &#123; // é‡æ–°è®¾ç½® beanName å¯¹åº”çš„ç¼“å­˜ resetBeanDefinition(beanName); &#125;&#125; å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š é¦–å…ˆ BeanDefinition è¿›è¡Œæ ¡éªŒï¼Œè¯¥æ ¡éªŒä¹Ÿæ˜¯æ³¨å†Œè¿‡ç¨‹ä¸­çš„æœ€åä¸€æ¬¡æ ¡éªŒäº†ï¼Œä¸»è¦æ˜¯å¯¹ AbstractBeanDefinition çš„ methodOverrides å±æ€§è¿›è¡Œæ ¡éªŒ æ ¹æ® beanName ä»ç¼“å­˜ä¸­è·å– BeanDefinitionï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œåˆ™æ ¹æ® allowBeanDefinitionOverriding æ ‡å¿—æ¥åˆ¤æ–­æ˜¯å¦å…è®¸è¦†ç›–ï¼Œå¦‚æœå…è®¸åˆ™ç›´æ¥è¦†ç›–ï¼Œå¦åˆ™æŠ›å‡º BeanDefinitionStoreException å¼‚å¸¸ è‹¥ç¼“å­˜ä¸­æ²¡æœ‰æŒ‡å®š beanName çš„ BeanDefinitionï¼Œåˆ™åˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯å¦å·²ç»å¼€å§‹äº† Bean çš„åˆ›å»ºé˜¶æ®µ&lt;&gt;ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦å¯¹ beanDefinitionMap è¿›è¡ŒåŠ é”æ§åˆ¶å¹¶å‘é—®é¢˜ï¼Œå¦åˆ™ç›´æ¥è®¾ç½®å³å¯ã€‚å¯¹äº hasBeanCreationStarted() æ–¹æ³•åç»­åšè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œä¸è¿‡å¤šé˜è¿°ã€‚ è‹¥ç¼“å­˜ä¸­å­˜åœ¨è¯¥ beanName æˆ–è€… å•åˆ© bean é›†åˆä¸­å­˜åœ¨è¯¥ beanNameï¼Œåˆ™è°ƒç”¨ resetBeanDefinition() é‡ç½® BeanDefinition ç¼“å­˜ã€‚ å…¶å®æ•´æ®µä»£ç çš„æ ¸å¿ƒå°±åœ¨äº this.beanDefinitionMap.put(beanName, beanDefinition); ã€‚ BeanDefinition çš„ç¼“å­˜ä¹Ÿä¸æ˜¯ç¥å¥‡çš„ä¸œè¥¿ï¼Œå°±æ˜¯å®šä¹‰ map ï¼Œkey ä¸º beanNameï¼Œvalue ä¸º BeanDefinitionã€‚ æ³¨å†Œ alias BeanDefinitionRegistry.registerAlias å®Œæˆ alias çš„æ³¨å†Œã€‚ public void registerAlias(String name, String alias) &#123; // æ ¡éªŒ name ã€ alias Assert.hasText(name, &quot;&#x27;name&#x27; must not be empty&quot;); Assert.hasText(alias, &quot;&#x27;alias&#x27; must not be empty&quot;); synchronized (this.aliasMap) &#123; // name == alias åˆ™å»æ‰alias if (alias.equals(name)) &#123; this.aliasMap.remove(alias); &#125; else &#123; // ç¼“å­˜ç¼“å­˜è®°å½• String registeredName = this.aliasMap.get(alias); if (registeredName != null) &#123; // ç¼“å­˜ä¸­çš„ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å› if (registeredName.equals(name)) &#123; // An existing alias - no need to re-register return; &#125; // ä¸å…è®¸åˆ™æŠ›å‡ºå¼‚å¸¸ if (!allowAliasOverriding()) &#123; throw new IllegalStateException( &quot;Cannot register alias &#x27;&quot; + alias + &quot;&#x27; for name &#x27;&quot; + name + &quot;&#x27;: It is already registered for name &#x27;&quot; + registeredName + &quot;&#x27;.&quot;); &#125; &#125; // å½“ A --&gt; B å­˜åœ¨æ—¶ï¼Œå¦‚æœå†æ¬¡å‡ºç° A --&gt; B --&gt; C åˆ™æŠ›å‡ºå¼‚å¸¸ checkForAliasCircle(name, alias); // æ³¨å†Œ alias this.aliasMap.put(alias, name); &#125; &#125;&#125; æ³¨å†Œ alias å’Œæ³¨å†Œ BeanDefinition çš„è¿‡ç¨‹å·®ä¸å¤šã€‚åœ¨æœ€åè°ƒç”¨äº† checkForAliasCircle() æ¥å¯¹åˆ«åè¿›è¡Œäº†æ£€æµ‹ã€‚ public boolean hasAlias(String name, String alias) &#123; for (Map.Entry&lt;String, String&gt; entry : this.aliasMap.entrySet()) &#123; String registeredName = entry.getValue(); if (registeredName.equals(name)) &#123; String registeredAlias = entry.getKey(); return (registeredAlias.equals(alias) || hasAlias(registeredAlias, alias)); &#125; &#125; return false;&#125; å¦‚æœ name ã€ alias ä¸º 1 ã€3 ï¼Œåˆ™æ„æˆ ï¼ˆ1,3ï¼‰ï¼ŒåŠ å…¥é›†åˆä¸­å­˜åœ¨ï¼ˆA,1ï¼‰ã€ï¼ˆ3,Aï¼‰çš„æƒ…å†µåˆ™ä¼šå‡ºé”™ã€‚ åˆ°è¿™é‡Œ BeanDefinitionã€alias éƒ½å·²ç»æ³¨å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯ç­‰å¾…åˆå§‹åŒ–ä½¿ç”¨äº†ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹è§£æbeanæ ‡ç­¾ï¼šè§£æè‡ªå®šä¹‰æ ‡ç­¾","date":"2020-01-12T08:35:19.000Z","path":"2020/01/12/61e43345.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2841 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE è·å– Document å¯¹è±¡åï¼Œä¼šæ ¹æ®è¯¥å¯¹è±¡å’Œ Resource èµ„æºå¯¹è±¡è°ƒç”¨ registerBeanDefinitions() æ–¹æ³•ï¼Œå¼€å§‹æ³¨å†Œ BeanDefinitions ä¹‹æ—…ã€‚åœ¨æ³¨å†Œ BeanDefinitions è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ parseBeanDefinitions() å¼€å¯ BeanDefinition çš„è§£æè¿‡ç¨‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå®ƒä¼šæ ¹æ®å‘½åç©ºé—´çš„ä¸åŒè°ƒç”¨ä¸åŒçš„æ–¹æ³•è¿›è¡Œè§£æï¼Œå¦‚æœæ˜¯é»˜è®¤çš„å‘½åç©ºé—´ï¼Œåˆ™è°ƒç”¨ parseDefaultElement() è¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æï¼Œå¦åˆ™è°ƒç”¨ parseCustomElement() æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾è§£æã€‚ ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾æ‰©å±• Spring è‡ªå®šä¹‰æ ‡ç­¾é…ç½®ä¸€èˆ¬éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š åˆ›å»ºä¸€ä¸ªéœ€è¦æ‰©å±•çš„ç»„ä»¶ å®šä¹‰ä¸€ä¸ª XSD æ–‡ä»¶ï¼Œç”¨äºæè¿°ç»„ä»¶å†…å®¹ åˆ›å»ºä¸€ä¸ªå®ç° AbstractSingleBeanDefinitionParser æ¥å£çš„ç±»ï¼Œç”¨æ¥è§£æ XSD æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œç»„ä»¶å®šä¹‰ åˆ›å»ºä¸€ä¸ª Handlerï¼Œç»§æ‰¿ NamespaceHandlerSupport ï¼Œç”¨äºå°†ç»„ä»¶æ³¨å†Œåˆ° Spring å®¹å™¨ ç¼–å†™ Spring.handlers å’Œ Spring.schemas æ–‡ä»¶ ä¸‹é¢å°±æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ ‡ç­¾ç»„ä»¶ã€‚ åˆ›å»ºç»„ä»¶ è¯¥ç»„ä»¶å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaBeanï¼Œæ²¡æœ‰ä»»ä½•ç‰¹åˆ«ä¹‹å¤„ã€‚ public class User &#123; private String id; private String userName; private String email;&#125; å®šä¹‰ XSD æ–‡ä»¶&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;xsd:schema xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns=&quot;http://www.cmsblogs.com/schema/user&quot; targetNamespace=&quot;http://www.cmsblogs.com/schema/user&quot; elementFormDefault=&quot;qualified&quot;&gt; &lt;xsd:element name=&quot;user&quot;&gt; &lt;xsd:complexType&gt; &lt;xsd:attribute name=&quot;id&quot; type=&quot;xsd:string&quot; /&gt; &lt;xsd:attribute name=&quot;userName&quot; type=&quot;xsd:string&quot; /&gt; &lt;xsd:attribute name=&quot;email&quot; type=&quot;xsd:string&quot; /&gt; &lt;/xsd:complexType&gt; &lt;/xsd:element&gt;&lt;/xsd:schema&gt; ä¸Šé¢é™¤äº†å¯¹ User è¿™ä¸ª JavaBean è¿›è¡Œäº†æè¿°å¤–ï¼Œè¿˜å®šä¹‰äº† xmlns=&quot;http://www.cmsblogs.com/schema/user&quot; targetNamespace=&quot;http://www.cmsblogs.com/schema/user&quot; è¿™ä¸¤ä¸ªå€¼ï¼Œè¿™ä¸¤ä¸ªå€¼åœ¨åé¢æ˜¯æœ‰å¤§ä½œç”¨çš„ã€‚ Parser ç±»å®šä¹‰ä¸€ä¸ª Parser ç±»ï¼Œè¯¥ç±»ç»§æ‰¿ AbstractSingleBeanDefinitionParser ï¼Œå¹¶å®ç° getBeanClass() å’Œ doParse() ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸»è¦æ˜¯ç”¨äºè§£æ XSD æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œç»„ä»¶å®šä¹‰ã€‚ public class UserDefinitionParser extends AbstractSingleBeanDefinitionParser &#123; @Override protected Class&lt;?&gt; getBeanClass(Element element) &#123; return User.class; &#125; @Override protected void doParse(Element element, BeanDefinitionBuilder builder) &#123; String id = element.getAttribute(&quot;id&quot;); String userName=element.getAttribute(&quot;userName&quot;); String email=element.getAttribute(&quot;email&quot;); if(StringUtils.hasText(id))&#123; builder.addPropertyValue(&quot;id&quot;,id); &#125; if(StringUtils.hasText(userName))&#123; builder.addPropertyValue(&quot;userName&quot;, userName); &#125; if(StringUtils.hasText(email))&#123; builder.addPropertyValue(&quot;email&quot;, email); &#125; &#125;&#125; Handler ç±»å®šä¹‰ Handler ç±»ï¼Œç»§æ‰¿ NamespaceHandlerSupport ,ä¸»è¦ç›®çš„æ˜¯å°†ç»„ä»¶æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚ public class UserNamespaceHandler extends NamespaceHandlerSupport &#123; @Override public void init() &#123; registerBeanDefinitionParser(&quot;user&quot;,new UserDefinitionParser()); &#125;&#125; Spring.handlershttp://www.cmsblogs.com/schema/user=org.springframework.core.customelement.UserNamespaceHandler Spring.schemashttp://www.cmsblogs.com/schema/user.xsd=user.xsd ç»è¿‡ä¸Šé¢å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„æ ‡ç­¾äº†ã€‚åœ¨ xml é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å¦‚ä¸‹ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:myTag=&quot;http://www.cmsblogs.com/schema/user&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.cmsblogs.com/schema/user http://www.cmsblogs.com/schema/user.xsd&quot;&gt; &lt;myTag:user id=&quot;user&quot; email=&quot;12233445566@qq.com&quot; userName=&quot;chenssy&quot; /&gt;&lt;/beans&gt; æµ‹è¯•ï¼š public static void main(String[] args)&#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;); User user = (User) context.getBean(&quot;user&quot;); System.out.println(user.getUserName() + &quot;----&quot; + user.getEmail());&#125; è¿è¡Œç»“æœï¼š è§£æè‡ªå®šä¹‰æ ‡ç­¾ä¸Šé¢å·²ç»æ¼”ç¤ºäº† Spring è‡ªå®šä¹‰æ ‡ç­¾çš„ä½¿ç”¨ï¼Œä¸‹é¢å°±æ¥åˆ†æè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹ã€‚DefaultBeanDefinitionDocumentReader.parseBeanDefinitions() è´Ÿè´£æ ‡ç­¾çš„è§£æå·¥ä½œï¼Œå…¶ä¸­å®ƒæ ¹æ®å‘½åç©ºé—´çš„ä¸åŒè¿›è¡Œä¸åŒæ ‡ç­¾çš„è§£æï¼Œå…¶ä¸­è‡ªå®šä¹‰æ ‡ç­¾ç”± delegate.parseCustomElement() å®ç°ã€‚å¦‚ä¸‹ï¼š public BeanDefinition parseCustomElement(Element ele) &#123; return parseCustomElement(ele, null);&#125; è°ƒç”¨ parseCustomElement() æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š public BeanDefinition parseCustomElement(Element ele, @Nullable BeanDefinition containingBd) &#123; // è·å– namespaceUri String namespaceUri = getNamespaceURI(ele); if (namespaceUri == null) &#123; return null; &#125; // æ ¹æ® namespaceUri è·å–ç›¸åº”çš„ Handler NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) &#123; error(&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot; + namespaceUri + &quot;]&quot;, ele); return null; &#125; // è°ƒç”¨è‡ªå®šä¹‰çš„ Handler å¤„ç† return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));&#125; å¤„ç†è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š è·å– namespaceUri æ ¹æ® namespaceUri è·å–ç›¸åº”çš„ Handler è°ƒç”¨è‡ªå®šä¹‰çš„ Handler å¤„ç† è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¾ˆç®€å•æ˜äº†ï¼Œæ ¹æ® namespaceUri è·å– Handlerï¼Œè¿™ä¸ªæ˜ å°„å…³ç³»æˆ‘ä»¬åœ¨ Spring.handlers ä¸­å·²ç»å®šä¹‰äº†ï¼Œæ‰€ä»¥åªéœ€è¦æ‰¾åˆ°è¯¥ç±»ï¼Œç„¶ååˆå§‹åŒ–è¿”å›ï¼Œæœ€åè°ƒç”¨è¯¥ Handler å¯¹è±¡çš„ parse() æ–¹æ³•å¤„ç†ï¼Œè¯¥æ–¹æ³•æˆ‘ä»¬ä¹Ÿæä¾›äº†å®ç°ã€‚æ‰€ä»¥ä¸Šé¢çš„æ ¸å¿ƒå°±åœ¨äºæ€ä¹ˆæ‰¾åˆ°è¯¥ Handler ç±»ã€‚è°ƒç”¨æ–¹æ³•ä¸ºï¼šthis.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri)``getNamespaceHandlerResolver() æ–¹æ³•è¿”å›çš„å‘½åç©ºé—´çš„è§£æå™¨ï¼Œè¯¥è§£æå®šä¹‰åœ¨ XmlReaderContext ä¸­ï¼Œå¦‚ä¸‹ï¼š public final NamespaceHandlerResolver getNamespaceHandlerResolver() &#123; return this.namespaceHandlerResolver;&#125; è¿™é‡Œç›´æ¥è¿”å›ï¼Œé‚£æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿ è¿™é‡Œéœ€è¦å›é€€åˆ°åšæ–‡ï¼šIoCä¹‹æ³¨å†ŒBeanDefinitions ï¼Œåœ¨è¿™ç¯‡åšå®¢ä¸­æåˆ°åœ¨æ³¨å†Œ BeanDefinition æ—¶ï¼š é¦–å…ˆæ˜¯é€šè¿‡ createBeanDefinitionDocumentReader() è·å– Document è§£æå™¨ BeanDefinitionDocumentReader å®ä¾‹ ç„¶åè°ƒç”¨è¯¥å®ä¾‹ registerBeanDefinitions() æ–¹æ³•è¿›è¡Œæ³¨å†Œã€‚ registerBeanDefinitions()æ–¹æ³•éœ€è¦æä¾›ä¸¤ä¸ªå‚æ•°ï¼š ä¸€ä¸ªæ˜¯ Document å®ä¾‹ doc ä¸€ä¸ªæ˜¯ XmlReaderContext å®ä¾‹ readerContext readerContext å®ä¾‹å¯¹è±¡ç”± createReaderContext() æ–¹æ³•æä¾›ã€‚namespaceHandlerResolver å®ä¾‹å¯¹è±¡å°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åˆå§‹åŒ–çš„ã€‚å¦‚ä¸‹ï¼š public XmlReaderContext createReaderContext(Resource resource) &#123; return new XmlReaderContext(resource, this.problemReporter, this.eventListener, this.sourceExtractor, this, getNamespaceHandlerResolver());&#125; XmlReaderContext æ„é€ å‡½æ•°ä¸­æœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯ NamespaceHandlerResolver å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”± getNamespaceHandlerResolver() æä¾›ï¼Œå¦‚ä¸‹ï¼š public NamespaceHandlerResolver getNamespaceHandlerResolver() &#123; if (this.namespaceHandlerResolver == null) &#123; this.namespaceHandlerResolver = createDefaultNamespaceHandlerResolver(); &#125; return this.namespaceHandlerResolver;&#125;protected NamespaceHandlerResolver createDefaultNamespaceHandlerResolver() &#123; ClassLoader cl = (getResourceLoader() != null ? getResourceLoader().getClassLoader() : getBeanClassLoader()); return new DefaultNamespaceHandlerResolver(cl);&#125; æ‰€ä»¥ getNamespaceHandlerResolver().resolve(namespaceUri) è°ƒç”¨çš„å°±æ˜¯ DefaultNamespaceHandlerResolver çš„ resolve()ã€‚å¦‚ä¸‹ï¼š public NamespaceHandler resolve(String namespaceUri) &#123; // è·å–æ‰€æœ‰å·²ç»é…ç½®çš„ Handler æ˜ å°„ Map&lt;String, Object&gt; handlerMappings = getHandlerMappings(); // æ ¹æ® namespaceUri è·å– handlerçš„ä¿¡æ¯ï¼šè¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ç±»è·¯å¾„ Object handlerOrClassName = handlerMappings.get(namespaceUri); if (handlerOrClassName == null) &#123; return null; &#125; else if (handlerOrClassName instanceof NamespaceHandler) &#123; // å¦‚æœå·²ç»åšè¿‡è§£æï¼Œç›´æ¥è¿”å› return (NamespaceHandler) handlerOrClassName; &#125; else &#123; String className = (String) handlerOrClassName; try &#123; Class&lt;?&gt; handlerClass = ClassUtils.forName(className, this.classLoader); if (!NamespaceHandler.class.isAssignableFrom(handlerClass)) &#123; throw new FatalBeanException(&quot;Class [&quot; + className + &quot;] for namespace [&quot; + namespaceUri + &quot;] does not implement the [&quot; + NamespaceHandler.class.getName() + &quot;] interface&quot;); &#125; // åˆå§‹åŒ–ç±» NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass); // è°ƒç”¨ init() æ–¹æ³• namespaceHandler.init(); // è®°å½•åœ¨ç¼“å­˜ handlerMappings.put(namespaceUri, namespaceHandler); return namespaceHandler; &#125; catch (ClassNotFoundException ex) &#123; throw new FatalBeanException(&quot;Could not find NamespaceHandler class [&quot; + className + &quot;] for namespace [&quot; + namespaceUri + &quot;]&quot;, ex); &#125; catch (LinkageError err) &#123; throw new FatalBeanException( &quot;Unresolvable class definition for NamespaceHandler class [&quot; + className + &quot;] for namespace [&quot; + namespaceUri + &quot;]&quot;, err); &#125; &#125;&#125; é¦–å…ˆè°ƒç”¨ getHandlerMappings() è·å–æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„æ˜ å°„å…³ç³» handlerMappings ï¼Œè¯¥å…³ç³»ä¸º &lt;å‘½åç©ºé—´,ç±»è·¯å¾„&gt;ï¼Œç„¶åæ ¹æ®å‘½åç©ºé—´ namespaceUri ä»æ˜ å°„å…³ç³»ä¸­è·å–ç›¸åº”çš„ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©ºæˆ–è€…å·²ç»åˆå§‹åŒ–äº†å°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ ¹æ®åå°„å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶è°ƒç”¨å…¶ init() æ–¹æ³•ï¼Œæœ€åå°†è¯¥ Handler å¯¹è±¡ç¼“å­˜ã€‚ init() æ–¹æ³•ä¸»è¦æ˜¯å°†è‡ªå®šä¹‰æ ‡ç­¾è§£æå™¨è¿›è¡Œæ³¨å†Œï¼Œå¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„ init() ï¼š @Overridepublic void init() &#123; registerBeanDefinitionParser(&quot;user&quot;,new UserDefinitionParser());&#125; ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„ registerBeanDefinitionParser() æ–¹æ³•è¿›è¡Œæ³¨å†Œï¼š protected final void registerBeanDefinitionParser( String elementName, BeanDefinitionParser parser) &#123; this.parsers.put(elementName, parser);&#125; å…¶å®å°±æ˜¯å°†æ˜ å°„å…³ç³»æ”¾åœ¨ä¸€ä¸ª Map ç»“æ„çš„ parsers å¯¹è±¡ä¸­ï¼šprivate final Map parsers ã€‚ å®Œæˆåè¿”å› NamespaceHandler å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶ parse() æ–¹æ³•å¼€å§‹è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æï¼Œå¦‚ä¸‹ï¼š public BeanDefinition parse(Element element, ParserContext parserContext) &#123; BeanDefinitionParser parser = findParserForElement(element, parserContext); return (parser != null ? parser.parse(element, parserContext) : null);&#125; è°ƒç”¨ findParserForElement() æ–¹æ³•è·å– BeanDefinitionParser å®ä¾‹ï¼Œå…¶å®å°±æ˜¯è·å–åœ¨ init() æ–¹æ³•é‡Œé¢æ³¨å†Œçš„å®ä¾‹å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š private BeanDefinitionParser findParserForElement( Element element, ParserContext parserContext) &#123; String localName = parserContext.getDelegate().getLocalName(element); BeanDefinitionParser parser = this.parsers.get(localName); if (parser == null) &#123; parserContext.getReaderContext().fatal( &quot;Cannot locate BeanDefinitionParser for element [&quot; + localName + &quot;]&quot;, element); &#125; return parser;&#125; è·å– localNameï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å°±æ˜¯ ï¼š user ç„¶åä» Map å®ä¾‹ parsers ä¸­è·å– BeanDefinitionParser å¯¹è±¡ã€‚ è¿”å› BeanDefinitionParser å¯¹è±¡åï¼Œè°ƒç”¨å…¶ parse()ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractBeanDefinitionParser ä¸­å®ç°ï¼š public final BeanDefinition parse( Element element, ParserContext parserContext) &#123; AbstractBeanDefinition definition = parseInternal(element, parserContext); if (definition != null &amp;&amp; !parserContext.isNested()) &#123; try &#123; String id = resolveId(element, definition, parserContext); if (!StringUtils.hasText(id)) &#123; parserContext.getReaderContext().error( &quot;Id is required for element &#x27;&quot; + parserContext.getDelegate().getLocalName(element) + &quot;&#x27; when used as a top-level tag&quot;, element); &#125; String[] aliases = null; if (shouldParseNameAsAliases()) &#123; String name = element.getAttribute(NAME_ATTRIBUTE); if (StringUtils.hasLength(name)) &#123; aliases = StringUtils.trimArrayElements( StringUtils.commaDelimitedListToStringArray(name)); &#125; &#125; BeanDefinitionHolder holder = new BeanDefinitionHolder(definition, id, aliases); registerBeanDefinition(holder, parserContext.getRegistry()); if (shouldFireEvents()) &#123; BeanComponentDefinition componentDefinition = new BeanComponentDefinition(holder); postProcessComponentDefinition(componentDefinition); parserContext.registerComponent(componentDefinition); &#125; &#125; catch (BeanDefinitionStoreException ex) &#123; String msg = ex.getMessage(); parserContext.getReaderContext().error((msg != null ? msg : ex.toString()), element); return null; &#125; &#125; return definition;&#125; æ ¸å¿ƒåœ¨æ–¹æ³• parseInternal() ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œä»¥ä¸ºè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ AbstractBeanDefinition å¯¹è±¡ï¼Œä»å‰é¢é»˜è®¤æ ‡ç­¾çš„è§£æå·¥ä½œä¸­æˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­è¯¥æ–¹æ³•å°±æ˜¯å°†æ ‡ç­¾è§£æä¸º AbstractBeanDefinition ï¼Œä¸”åç»­ä»£ç éƒ½æ˜¯å°† AbstractBeanDefinition è½¬æ¢ä¸º BeanDefinitionHolderï¼Œæ‰€ä»¥çœŸæ­£çš„è§£æå·¥ä½œéƒ½äº¤ç”± parseInternal() å®ç°ï¼Œå¦‚ä¸‹ï¼š protected final AbstractBeanDefinition parseInternal( Element element, ParserContext parserContext) &#123; // è·å– BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(); // è·å–çˆ¶ç±»å…ƒç´  String parentName = getParentName(element); if (parentName != null) &#123; builder.getRawBeanDefinition().setParentName(parentName); &#125; // è·å–è‡ªå®šä¹‰æ ‡ç­¾ä¸­çš„ classï¼Œè¿™ä¸ªæ—¶å€™ä¼šå»è°ƒç”¨è‡ªå®šä¹‰è§£æä¸­çš„ getBeanClass() Class&lt;?&gt; beanClass = getBeanClass(element); if (beanClass != null) &#123; builder.getRawBeanDefinition().setBeanClass(beanClass); &#125; else &#123; // beanClass ä¸º nullï¼Œæ„å‘³ç€å­ç±»å¹¶æ²¡æœ‰é‡å†™ getBeanClass() æ–¹æ³•ï¼Œ // åˆ™å°è¯•å»åˆ¤æ–­æ˜¯å¦é‡å†™äº† getBeanClassName() String beanClassName = getBeanClassName(element); if (beanClassName != null) &#123; builder.getRawBeanDefinition().setBeanClassName(beanClassName); &#125; &#125; builder.getRawBeanDefinition().setSource(parserContext.extractSource(element)); BeanDefinition containingBd = parserContext.getContainingBeanDefinition(); if (containingBd != null) &#123; // Inner bean definition must receive same scope as containing bean. builder.setScope(containingBd.getScope()); &#125; if (parserContext.isDefaultLazyInit()) &#123; // Default-lazy-init applies to custom bean definitions as well. builder.setLazyInit(true); &#125; // è°ƒç”¨å­ç±»çš„ doParse() è¿›è¡Œè§£æ doParse(element, parserContext, builder); return builder.getBeanDefinition();&#125; åœ¨è¯¥æ–¹æ³•ä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼šgetBeanClass() ã€doParse()ã€‚å¯¹äº getBeanClass() æ–¹æ³•ï¼ŒAbstractSingleBeanDefinitionParser ç±»å¹¶æ²¡æœ‰æä¾›å…·ä½“å®ç°ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› nullï¼Œæ„å‘³ç€å®ƒå¸Œæœ›å­ç±»èƒ½å¤Ÿé‡å†™è¯¥æ–¹æ³•ï¼Œå½“ç„¶å¦‚æœæ²¡æœ‰é‡å†™è¯¥æ–¹æ³•ï¼Œè¿™ä¼šå»è°ƒç”¨ getBeanClassName() ï¼Œåˆ¤æ–­å­ç±»æ˜¯å¦å·²ç»é‡å†™äº†è¯¥æ–¹æ³•ã€‚å¯¹äº doParse() åˆ™æ˜¯ç›´æ¥ç©ºå®ç°ã€‚æ‰€ä»¥å¯¹äº parseInternal() è€Œè¨€å®ƒæ€»æ˜¯æœŸå¾…å®ƒçš„å­ç±»èƒ½å¤Ÿå®ç° getBeanClass()ã€doParse()ï¼Œå…¶ä¸­ doParse() å°¤ä¸ºé‡è¦ï¼Œå¦‚æœä½ ä¸æä¾›å®ç°ï¼Œæ€ä¹ˆæ¥è§£æè‡ªå®šä¹‰æ ‡ç­¾å‘¢ï¼Ÿæœ€åå°†è‡ªå®šä¹‰çš„è§£æå™¨ï¼šUserDefinitionParser å†æ¬¡å›è§‚ã€‚ public class UserDefinitionParser extends AbstractSingleBeanDefinitionParser &#123; @Override protected Class&lt;?&gt; getBeanClass(Element element) &#123; return User.class; &#125; @Override protected void doParse(Element element, BeanDefinitionBuilder builder) &#123; String id = element.getAttribute(&quot;id&quot;); String userName=element.getAttribute(&quot;userName&quot;); String email=element.getAttribute(&quot;email&quot;); if(StringUtils.hasText(id))&#123; builder.addPropertyValue(&quot;id&quot;,id); &#125; if(StringUtils.hasText(userName))&#123; builder.addPropertyValue(&quot;userName&quot;, userName); &#125; if(StringUtils.hasText(email))&#123; builder.addPropertyValue(&quot;email&quot;, email); &#125; &#125;&#125; è‡³æ­¤ï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹å·²ç»åˆ†æå®Œæˆäº†ã€‚å…¶å®æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯è¾ƒä¸ºç®€å•ï¼š é¦–å…ˆä¼šåŠ è½½ handlers æ–‡ä»¶ï¼Œå°†å…¶ä¸­å†…å®¹è¿›è¡Œä¸€ä¸ªè§£æï¼Œå½¢æˆ &lt;namespaceUri,ç±»è·¯å¾„&gt; è¿™æ ·çš„ä¸€ä¸ªæ˜ å°„ ç„¶åæ ¹æ®è·å–çš„ namespaceUri å°±å¯ä»¥å¾—åˆ°ç›¸åº”çš„ç±»è·¯å¾„ï¼Œå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ç­‰åˆ°ç›¸åº”çš„ Handler å¯¹è±¡ è°ƒç”¨ parse() æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ ¹æ®æ ‡ç­¾çš„ localName å¾—åˆ°ç›¸åº”çš„ BeanDefinitionParser å®ä¾‹å¯¹è±¡ è°ƒç”¨ parse() ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ AbstractBeanDefinitionParser æŠ½è±¡ç±»ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘å°è£…åœ¨å…¶ parseInternal() ä¸­ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª AbstractBeanDefinition å®ä¾‹å¯¹è±¡ï¼Œå…¶ä¸»è¦æ˜¯åœ¨ AbstractSingleBeanDefinitionParser ä¸­å®ç°ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ Parser ç±»ï¼Œå…¶éœ€è¦å®ç° getBeanClass() æˆ–è€… getBeanClassName() å’Œ doParse()ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šconstructor-argã€propertyå­å…ƒç´ ","date":"2020-01-11T08:21:50.000Z","path":"2020/01/11/686a3d12.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2754 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE constructor-arg å­å…ƒç´ ä¸¾ä¸ªå°æ —å­ï¼š public class StudentService &#123; private String name; private Integer age; private BookService bookService; StudentService(String name, Integer age, BookService bookService)&#123; this.name = name; this.age = age; this.bookService = bookService; &#125;&#125; &lt;bean id=&quot;bookService&quot; class=&quot;org.springframework.core.service.BookService&quot;/&gt;&lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;constructor-arg index=&quot;0&quot; value=&quot;chenssy&quot;/&gt; &lt;constructor-arg name=&quot;age&quot; value=&quot;100&quot;/&gt; &lt;constructor-arg name=&quot;bookService&quot; ref=&quot;bookService&quot;/&gt;&lt;/bean&gt; StudentService å®šä¹‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ constructor-arg å…ƒç´ å¯¹å…¶é…ç½®ï¼Œè¯¥å…ƒç´ å¯ä»¥å®ç°å¯¹ StudentService è‡ªåŠ¨å¯»æ‰¾å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¹¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°†å€¼å½“åšå‚æ•°è¿›è¡Œè®¾ç½®ã€‚parseConstructorArgElements() æ–¹æ³•å®Œæˆ constructor-arg å­å…ƒç´ çš„è§£æã€‚ public void parseConstructorArgElements(Element beanEle, BeanDefinition bd) &#123; NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123; parseConstructorArgElement((Element) node, bd); &#125; &#125;&#125; éå†æ‰€æœ‰å­å…ƒç´ ï¼Œå¦‚æœä¸º constructor-arg åˆ™è°ƒç”¨ parseConstructorArgElement() è¿›è¡Œè§£æã€‚ public void parseConstructorArgElement(Element ele, BeanDefinition bd) &#123; // æå– indexã€typeã€name å±æ€§å€¼ String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE); String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE); String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); // å¦‚æœæœ‰index if (StringUtils.hasLength(indexAttr)) &#123; try &#123; int index = Integer.parseInt(indexAttr); if (index &lt; 0) &#123; error(&quot;&#x27;index&#x27; cannot be lower than 0&quot;, ele); &#125; else &#123; try &#123; // æ„é€ ä¸€ä¸ª ConstructorArgumentEntry å¹¶å°†å…¶åŠ å…¥åˆ° ParseState ä¸­ this.parseState.push(new ConstructorArgumentEntry(index)); // è§£æ ele å¯¹åº”å±æ€§å…ƒç´  Object value = parsePropertyValue(ele, bd, null); // æ ¹æ®è§£æçš„å±æ€§å…ƒç´ æ„é€ ä¸€ä¸ª valueHolder å¯¹è±¡ ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value); if (StringUtils.hasLength(typeAttr)) &#123; valueHolder.setType(typeAttr); &#125; if (StringUtils.hasLength(nameAttr)) &#123; valueHolder.setName(nameAttr); &#125; // valueHolder.setSource(extractSource(ele)); // ä¸å…è®¸é‡å¤æŒ‡å®šç›¸åŒå‚æ•° if (bd.getConstructorArgumentValues() .hasIndexedArgumentValue(index)) &#123; error(&quot;Ambiguous constructor-arg entries for index &quot; + index, ele); &#125; else &#123; // åŠ å…¥åˆ° indexedArgumentValues ä¸­å›½ bd.getConstructorArgumentValues() .addIndexedArgumentValue(index, valueHolder); &#125; &#125; finally &#123; this.parseState.pop(); &#125; &#125; &#125; catch (NumberFormatException ex) &#123; error(&quot;Attribute &#x27;index&#x27; of tag &#x27;constructor-arg&#x27; must be an integer&quot;, ele); &#125; &#125; else &#123; try &#123; this.parseState.push(new ConstructorArgumentEntry()); Object value = parsePropertyValue(ele, bd, null); ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value); if (StringUtils.hasLength(typeAttr)) &#123; valueHolder.setType(typeAttr); &#125; if (StringUtils.hasLength(nameAttr)) &#123; valueHolder.setName(nameAttr); &#125; valueHolder.setSource(extractSource(ele)); bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder); &#125; finally &#123; this.parseState.pop(); &#125; &#125;&#125; é¦–å…ˆè·å– indexã€typeã€name ä¸‰ä¸ªå±æ€§å€¼ï¼Œç„¶åæ ¹æ®æ˜¯å¦å­˜åœ¨ index æ¥åŒºåˆ†ã€‚ å…¶å®ä¸¤è€…é€»è¾‘éƒ½å·®ä¸å¤šï¼Œæ€»å…±åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ˆä»¥æœ‰ index ä¸ºä¾‹ï¼‰ï¼š æ„é€  ConstructorArgumentEntry å¯¹è±¡å¹¶å°†å…¶åŠ å…¥åˆ° ParseState é˜Ÿåˆ—ä¸­ã€‚ ConstructorArgumentEntry è¡¨ç¤ºæ„é€ å‡½æ•°çš„å‚æ•°ã€‚ è°ƒç”¨ parsePropertyValue() è§£æ constructor-arg å­å…ƒç´ ï¼Œè¿”å›ç»“æœå€¼ æ ¹æ®è§£æçš„ç»“æœå€¼æ„é€  ConstructorArgumentValues.ValueHolder å®ä¾‹å¯¹è±¡ å°† typeã€name å°è£…åˆ° ConstructorArgumentValues.ValueHolder ä¸­ï¼Œç„¶åå°† ValueHolder å®ä¾‹å¯¹è±¡æ·»åŠ åˆ° indexedArgumentValues ä¸­ã€‚ æ—  index çš„å¤„ç†é€»è¾‘å·®ä¸å¤šï¼Œåªæœ‰å‡ ç‚¹ä¸åŒï¼š æ„é€  ConstructorArgumentEntry å¯¹è±¡æ—¶æ˜¯è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼› æœ€åæ˜¯å°† ValueHolder å®ä¾‹æ·»åŠ åˆ° genericArgumentValues ä¸­ã€‚ parsePropertyValue() å¯¹å­å…ƒç´ è¿›ä¸€æ­¥è§£æã€‚ public Object parsePropertyValue(Element ele, BeanDefinition bd, @Nullable String propertyName) &#123; String elementName = (propertyName != null) ? &quot;&lt;property&gt; element for property &#x27;&quot; + propertyName + &quot;&#x27;&quot; : &quot;&lt;constructor-arg&gt; element&quot;; NodeList nl = ele.getChildNodes(); Element subElement = null; for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); // meta ã€description ä¸å¤„ç† if (node instanceof Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp; !nodeNameEquals(node, META_ELEMENT)) &#123; // Child element is what we&#x27;re looking for. if (subElement != null) &#123; error(elementName + &quot; must not contain more than one sub-element&quot;, ele); &#125; else &#123; subElement = (Element) node; &#125; &#125; &#125; // è§£æ ref å…ƒç´  boolean hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE); // è§£æ value å…ƒç´  boolean hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE); // constructor-arg å­å…ƒç´ æœ‰ä¸¤ç§æƒ…å†µä¸å­˜åœ¨ // 1. å³å­˜åœ¨ ref åˆå­˜åœ¨ value // 2. å­˜åœ¨ ref æˆ–è€… valueï¼Œä½†æ˜¯åˆæœ‰å­å…ƒç´  if ((hasRefAttribute &amp;&amp; hasValueAttribute) || ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != null)) &#123; error(elementName + &quot; is only allowed to contain either &#x27;ref&#x27; attribute OR &quot; + &quot; &#x27;value&#x27; attribute OR sub-element&quot;, ele); &#125; if (hasRefAttribute) &#123; // è·å– ref å±æ€§å€¼ String refName = ele.getAttribute(REF_ATTRIBUTE); if (!StringUtils.hasText(refName)) &#123; error(elementName + &quot; contains empty &#x27;ref&#x27; attribute&quot;, ele); &#125; // å°† ref å±æ€§å€¼æ„é€ ä¸º RuntimeBeanReference å®ä¾‹å¯¹è±¡ RuntimeBeanReference ref = new RuntimeBeanReference(refName); ref.setSource(extractSource(ele)); return ref; &#125; else if (hasValueAttribute) &#123; // è§£æ value å±æ€§å€¼ï¼Œæ„é€  TypedStringValue å®ä¾‹å¯¹è±¡ TypedStringValue valueHolder = new TypedStringValue( ele.getAttribute(VALUE_ATTRIBUTE)); valueHolder.setSource(extractSource(ele)); return valueHolder; &#125; else if (subElement != null) &#123; // è§£æå­å…ƒç´  return parsePropertySubElement(subElement, bd); &#125; else &#123; // Neither child element nor &quot;ref&quot; or &quot;value&quot; attribute found. error(elementName + &quot; must specify a ref or value&quot;, ele); return null; &#125;&#125; æå– constructor-arg å­å…ƒç´ çš„ ref å’Œ value çš„å±æ€§å€¼ï¼Œå¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»¥ä¸‹ä¸¤ç§æƒ…å†µæ˜¯ä¸å…è®¸å­˜åœ¨çš„ ref å’Œ value å±æ€§åŒæ—¶å­˜åœ¨ å­˜åœ¨ ref æˆ–è€… value ä¸”åˆæœ‰å­å…ƒç´  è‹¥å­˜åœ¨ ref å±æ€§ï¼Œåˆ™è·å–å…¶å€¼å¹¶å°†å…¶å°è£…è¿› RuntimeBeanReference å®ä¾‹å¯¹è±¡ä¸­ è‹¥å­˜åœ¨ value å±æ€§ï¼Œåˆ™è·å–å…¶å€¼å¹¶å°†å…¶å°è£…è¿› TypedStringValue å®ä¾‹å¯¹è±¡ä¸­ å¦‚æœå­å…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ parsePropertySubElement() è¿›è¡Œå­å…ƒç´ è¿›ä¸€æ­¥å¤„ç† å¯¹äº constructor-arg å­å…ƒç´ çš„åµŒå¥—å­å…ƒç´ ï¼Œéœ€è¦è°ƒç”¨ parsePropertySubElement() è¿›ä¸€æ­¥å¤„ç†ã€‚ public Object parsePropertySubElement(Element ele, @Nullable BeanDefinition bd) &#123; return parsePropertySubElement(ele, bd, null);&#125;public Object parsePropertySubElement( Element ele, @Nullable BeanDefinition bd, @Nullable String defaultValueType) &#123; if (!isDefaultNamespace(ele)) &#123; return parseNestedCustomElement(ele, bd); &#125; else if (nodeNameEquals(ele, BEAN_ELEMENT)) &#123; BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd); if (nestedBd != null) &#123; nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd); &#125; return nestedBd; &#125; else if (nodeNameEquals(ele, REF_ELEMENT)) &#123; // A generic reference to any name of any bean. String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE); boolean toParent = false; if (!StringUtils.hasLength(refName)) &#123; // A reference to the id of another bean in a parent context. refName = ele.getAttribute(PARENT_REF_ATTRIBUTE); toParent = true; if (!StringUtils.hasLength(refName)) &#123; error(&quot;&#x27;bean&#x27; or &#x27;parent&#x27; is required for &lt;ref&gt; element&quot;, ele); return null; &#125; &#125; if (!StringUtils.hasText(refName)) &#123; error(&quot;&lt;ref&gt; element contains empty target attribute&quot;, ele); return null; &#125; RuntimeBeanReference ref = new RuntimeBeanReference(refName, toParent); ref.setSource(extractSource(ele)); return ref; &#125; else if (nodeNameEquals(ele, IDREF_ELEMENT)) &#123; return parseIdRefElement(ele); &#125; else if (nodeNameEquals(ele, VALUE_ELEMENT)) &#123; return parseValueElement(ele, defaultValueType); &#125; else if (nodeNameEquals(ele, NULL_ELEMENT)) &#123; // It&#x27;s a distinguished null value. Let&#x27;s wrap it in a TypedStringValue // object in order to preserve the source location. TypedStringValue nullHolder = new TypedStringValue(null); nullHolder.setSource(extractSource(ele)); return nullHolder; &#125; else if (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123; return parseArrayElement(ele, bd); &#125; else if (nodeNameEquals(ele, LIST_ELEMENT)) &#123; return parseListElement(ele, bd); &#125; else if (nodeNameEquals(ele, SET_ELEMENT)) &#123; return parseSetElement(ele, bd); &#125; else if (nodeNameEquals(ele, MAP_ELEMENT)) &#123; return parseMapElement(ele, bd); &#125; else if (nodeNameEquals(ele, PROPS_ELEMENT)) &#123; return parsePropsElement(ele); &#125; else &#123; error(&quot;Unknown property sub-element: [&quot; + ele.getNodeName() + &quot;]&quot;, ele); return null; &#125;&#125; ä¸Šé¢å¯¹å„ä¸ªå­ç±»è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œè¯¦ç»†æƒ…å†µå¦‚æœå„ä½æœ‰å…´è¶£å¯ä»¥ç§»æ­¥æºç è¿›è¡Œæ·±ä¸€æ­¥çš„æ¢ç©¶ã€‚ property å­å…ƒç´ æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥ä½¿ç”¨ property å­å…ƒç´ ã€‚ &lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.service.StudentService&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;chenssy&quot;/&gt; &lt;property name=&quot;age&quot; value=&quot;18&quot;/&gt;&lt;/bean&gt; å¯¹äº property å­å…ƒç´ çš„è§£æï¼ŒSpring è°ƒç”¨ parsePropertyElements()ã€‚å¦‚ä¸‹ï¼š public void parsePropertyElements(Element beanEle, BeanDefinition bd) &#123; NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123; parsePropertyElement((Element) node, bd); &#125; &#125;&#125; å’Œ constructor-arg å­å…ƒç´ å·®ä¸å¤šï¼ŒåŒæ ·æ˜¯æå–æ‰€æœ‰çš„ property çš„å­å…ƒç´ ï¼Œç„¶åè°ƒç”¨ parsePropertyElement() è¿›è¡Œåˆ†æã€‚ public void parsePropertyElement(Element ele, BeanDefinition bd) &#123; // è·å– name å±æ€§ String propertyName = ele.getAttribute(NAME_ATTRIBUTE); if (!StringUtils.hasLength(propertyName)) &#123; error(&quot;Tag &#x27;property&#x27; must have a &#x27;name&#x27; attribute&quot;, ele); return; &#125; this.parseState.push(new PropertyEntry(propertyName)); try &#123; // å¦‚æœå­˜åœ¨ç›¸åŒçš„ name if (bd.getPropertyValues().contains(propertyName)) &#123; error(&quot;Multiple &#x27;property&#x27; definitions for property &#x27;&quot; + propertyName + &quot;&#x27;&quot;, ele); return; &#125; // è§£æå±æ€§å€¼ Object val = parsePropertyValue(ele, bd, propertyName); // æ ¹æ®è§£æçš„å±æ€§å€¼æ„é€  PropertyValue å®ä¾‹å¯¹è±¡ PropertyValue pv = new PropertyValue(propertyName, val); parseMetaElements(ele, pv); pv.setSource(extractSource(ele)); // æ·»åŠ åˆ° MutablePropertyValues ä¸­ bd.getPropertyValues().addPropertyValue(pv); &#125; finally &#123; this.parseState.pop(); &#125;&#125; ä¸è§£æ constructor-arg å­å…ƒç´ æ­¥éª¤å·®ä¸å¤šã€‚è°ƒç”¨ parsePropertyValue() è§£æå­å…ƒç´ å±æ€§å€¼ï¼Œç„¶åæ ¹æ®è¯¥å€¼æ„é€  PropertyValue å®ä¾‹å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° BeanDefinition ä¸­çš„ MutablePropertyValues ä¸­ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹è§£æbeanæ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method","date":"2020-01-10T07:36:53.000Z","path":"2020/01/10/fa973ffe.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2736 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨ IOC ä¹‹è§£æ Bean æ ‡ç­¾ï¼šBeanDefinitionä¸­å·²ç»å®Œæˆäº†å¯¹ Bean æ ‡ç­¾å±æ€§çš„è§£æå·¥ä½œï¼Œè¿™ç¯‡åšæ–‡å¼€å§‹åˆ†æå­å…ƒç´ çš„è§£æã€‚ å®Œæˆ Bean æ ‡ç­¾åŸºæœ¬å±æ€§è§£æåï¼Œä¼šä¾æ¬¡è°ƒç”¨ parseMetaElements()ã€parseLookupOverrideSubElements()ã€parseReplacedMethodSubElements() å¯¹å­å…ƒç´  metaã€lookup-methodã€replace-method å®Œæˆè§£æã€‚ä¸‰ä¸ªå­å…ƒç´ çš„ä½œç”¨å¦‚ä¸‹ï¼š metaï¼šå…ƒæ•°æ®ã€‚ lookup-methodï¼šSpring åŠ¨æ€æ”¹å˜ bean é‡Œæ–¹æ³•çš„å®ç°ã€‚ æ–¹æ³•æ‰§è¡Œè¿”å›çš„å¯¹è±¡ï¼Œä½¿ç”¨ Spring å†…åŸæœ‰çš„è¿™ç±»å¯¹è±¡æ›¿æ¢ï¼Œé€šè¿‡æ”¹å˜æ–¹æ³•è¿”å›å€¼æ¥åŠ¨æ€æ”¹å˜æ–¹æ³•ã€‚å†…éƒ¨å®ç°ä¸ºä½¿ç”¨ cglib æ–¹æ³•ï¼Œé‡æ–°ç”Ÿæˆå­ç±»ï¼Œé‡å†™é…ç½®çš„æ–¹æ³•å’Œè¿”å›å¯¹è±¡ï¼Œè¾¾åˆ°åŠ¨æ€æ”¹å˜çš„æ•ˆæœã€‚ replace-methodï¼šSpring åŠ¨æ€æ”¹å˜ bean é‡Œæ–¹æ³•çš„å®ç°ã€‚ éœ€è¦æ”¹å˜çš„æ–¹æ³•ï¼Œä½¿ç”¨ Spring å†…åŸæœ‰å…¶ä»–ç±»ï¼ˆéœ€è¦ç»§æ‰¿æ¥å£org.springframework.beans.factory.support.MethodReplacerï¼‰çš„é€»è¾‘ï¼Œæ›¿æ¢è¿™ä¸ªæ–¹æ³•ã€‚é€šè¿‡æ”¹å˜æ–¹æ³•æ‰§è¡Œé€»è¾‘æ¥åŠ¨æ€æ”¹å˜æ–¹æ³•ã€‚ meta å­å…ƒç´  meta ï¼šå…ƒæ•°æ®ã€‚å½“éœ€è¦ä½¿ç”¨é‡Œé¢çš„ä¿¡æ¯æ—¶å¯ä»¥é€šè¿‡keyè·å– meta æ‰€å£°æ˜çš„ key å¹¶ä¸ä¼šåœ¨ Bean ä¸­ä½“ç°ï¼Œåªæ˜¯ä¸€ä¸ªé¢å¤–çš„å£°æ˜ï¼Œå½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨é‡Œé¢çš„ä¿¡æ¯æ—¶ï¼Œé€šè¿‡ BeanDefinition çš„ getAttribute() è·å–ã€‚è¯¥å­å…ƒç´ çš„è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š public void parseMetaElements(Element ele, BeanMetadataAttributeAccessor attributeAccessor) &#123; NodeList nl = ele.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123; Element metaElement = (Element) node; String key = metaElement.getAttribute(KEY_ATTRIBUTE); String value = metaElement.getAttribute(VALUE_ATTRIBUTE); BeanMetadataAttribute attribute = new BeanMetadataAttribute(key, value); attribute.setSource(extractSource(metaElement)); attributeAccessor.addMetadataAttribute(attribute); &#125; &#125;&#125; è§£æè¿‡ç¨‹è¾ƒä¸ºç®€å•ï¼Œè·å–ç›¸åº”çš„ key - value æ„å»º BeanMetadataAttribute å¯¹è±¡ï¼Œç„¶åé€šè¿‡ addMetadataAttribute() åŠ å…¥åˆ° AbstractBeanDefinition ä¸­ã€‚ ä»£ç  å¦‚ä¸‹ï¼š public void addMetadataAttribute(BeanMetadataAttribute attribute) &#123; super.setAttribute(attribute.getName(), attribute);&#125; å§”æ‰˜ AttributeAccessorSupport å®ç°ï¼Œå¦‚ä¸‹ï¼š public void setAttribute(String name, @Nullable Object value) &#123; Assert.notNull(name, &quot;Name must not be null&quot;); if (value != null) &#123; this.attributes.put(name, value); &#125; else &#123; removeAttribute(name); &#125;&#125; AttributeAccessorSupport æ˜¯æ¥å£ AttributeAccessor çš„å®ç°è€…ã€‚ AttributeAccessor æ¥å£å®šä¹‰äº†ä¸å…¶ä»–å¯¹è±¡çš„å…ƒæ•°æ®è¿›è¡Œè¿æ¥å’Œè®¿é—®çš„çº¦å®šï¼Œå¯ä»¥é€šè¿‡è¯¥æ¥å£å¯¹å±æ€§è¿›è¡Œè·å–ã€è®¾ç½®ã€åˆ é™¤æ“ä½œã€‚ è®¾ç½®å…ƒæ•°æ®åï¼Œåˆ™å¯ä»¥é€šè¿‡ getAttribute() è·å–,å¦‚ä¸‹ï¼š public Object getAttribute(String name) &#123; BeanMetadataAttribute attribute = (BeanMetadataAttribute) super.getAttribute(name); return (attribute != null ? attribute.getValue() : null);&#125; lookup-method å­å…ƒç´  lookup-method ï¼šè·å–å™¨æ³¨å…¥ï¼Œæ˜¯æŠŠä¸€ä¸ªæ–¹æ³•å£°æ˜ä¸ºè¿”å›æŸç§ç±»å‹çš„ bean ä½†å®é™…è¦è¿”å›çš„ bean æ˜¯åœ¨é…ç½®æ–‡ä»¶é‡Œé¢é…ç½®çš„ã€‚è¯¥æ–¹æ³•å¯ä»¥ç”¨äºè®¾è®¡ä¸€äº›å¯æ’æ‹”çš„åŠŸèƒ½ä¸Šï¼Œè§£é™¤ç¨‹åºä¾èµ–ã€‚ ç›´æ¥ä¸Šä¾‹å­ï¼š public interface Car &#123; void display();&#125;public class Bmw implements Car&#123; @Override public void display() &#123; System.out.println(&quot;æˆ‘æ˜¯ BMW&quot;); &#125;&#125;public class Hongqi implements Car&#123; @Override public void display() &#123; System.out.println(&quot;æˆ‘æ˜¯ hongqi&quot;); &#125;&#125;public abstract class Display &#123; public void display()&#123; getCar().display(); &#125; public abstract Car getCar();&#125; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;classpath:spring.xml&quot;); Display display = (Display) context.getBean(&quot;display&quot;); display.display(); &#125;&#125; é…ç½®å†…å®¹å¦‚ä¸‹ï¼š &lt;bean id=&quot;display&quot; class=&quot;org.springframework.core.test1.Display&quot;&gt; &lt;lookup-method name=&quot;getCar&quot; bean=&quot;hongqi&quot;/&gt;&lt;/bean&gt; è¿è¡Œç»“æœä¸ºï¼š æˆ‘æ˜¯ hongqi å¦‚æœå°† bean=&quot;hognqi&quot; æ›¿æ¢ä¸º bean=&quot;bmw&quot;ï¼Œåˆ™è¿è¡Œç»“æœå˜æˆï¼š æˆ‘æ˜¯ BMW çœ‹äº†è¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬åˆæ­¥äº†è§£äº† looku-method å­å…ƒç´ æä¾›çš„åŠŸèƒ½äº†ï¼Œå…¶è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š public void parseLookupOverrideSubElements(Element beanEle, MethodOverrides overrides) &#123; NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) &#123; Element ele = (Element) node; String methodName = ele.getAttribute(NAME_ATTRIBUTE); String beanRef = ele.getAttribute(BEAN_ELEMENT); LookupOverride override = new LookupOverride(methodName, beanRef); override.setSource(extractSource(ele)); overrides.addOverride(override); &#125; &#125;&#125; è§£æè¿‡ç¨‹å’Œ meta å­å…ƒç´ æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼ŒåŒæ ·æ˜¯è§£æ methodNameã€beanRef æ„é€ ä¸€ä¸ª LookupOverride å¯¹è±¡ï¼Œç„¶åè¦†ç›–å³å¯ã€‚åœ¨å®ä¾‹åŒ– Bean çš„æ—¶å€™ï¼Œå†è¯¦ç»†é˜è¿°å…·ä½“çš„å®ç°è¿‡ç¨‹ï¼Œè¿™é‡Œä»…ä»…åªæ˜¯ä¸€ä¸ªæ ‡è®°ä½œç”¨ã€‚ replace-method å­å…ƒç´  replaced-method ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶è°ƒç”¨æ–°çš„æ–¹æ³•æ›¿æ¢ç°æœ‰çš„æ–¹æ³•ï¼Œè¿˜èƒ½åŠ¨æ€çš„æ›´æ–°åŸæœ‰æ–¹æ³•çš„é€»è¾‘ è¯¥æ ‡ç­¾ä½¿ç”¨æ–¹æ³•å’Œ lookup-method æ ‡ç­¾å·®ä¸å¤šï¼Œåªä¸è¿‡æ›¿ä»£æ–¹æ³•çš„ç±»éœ€è¦å®ç° MethodReplacer æ¥å£ã€‚å¦‚ä¸‹: public class Method &#123; public void display()&#123; System.out.println(&quot;æˆ‘æ˜¯åŸå§‹æ–¹æ³•&quot;); &#125;&#125;public class MethodReplace implements MethodReplacer &#123; @Override public Object reimplement(Object obj, Method method, Object[] args) throws Throwable &#123; System.out.println(&quot;æˆ‘æ˜¯æ›¿æ¢æ–¹æ³•&quot;); return null; &#125;&#125;public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;classpath:spring.xml&quot;); Method method = (Method) context.getBean(&quot;method&quot;); method.display();&#125; å¦‚æœ spring.xml æ–‡ä»¶å¦‚ä¸‹ï¼š &lt;bean id=&quot;methodReplace&quot; class=&quot;org.springframework.core.test1.MethodReplace&quot;/&gt;&lt;bean id=&quot;method&quot; class=&quot;org.springframework.core.test1.Method&quot;/&gt; åˆ™è¿è¡Œç»“æœä¸ºï¼š æˆ‘æ˜¯åŸå§‹æ–¹æ³• å¢åŠ  replaced-method å­å…ƒç´ ï¼š &lt;bean id=&quot;methodReplace&quot; class=&quot;org.springframework.core.test1.MethodReplace&quot;/&gt;&lt;bean id=&quot;method&quot; class=&quot;org.springframework.core.test1.Method&quot;&gt; &lt;replaced-method name=&quot;display&quot; replacer=&quot;methodReplace&quot;/&gt;&lt;/bean&gt; è¿è¡Œç»“æœä¸ºï¼š æˆ‘æ˜¯æ›¿æ¢æ–¹æ³• ä¸Šé¢ä»£ç æ¼”ç¤ºäº† replaced-method å­å…ƒç´ çš„ç”¨æ³•ï¼Œä¸‹é¢å†çœ‹çœ‹è¯¥å­å…ƒç´ çš„è§£æè¿‡ç¨‹ã€‚ public void parseReplacedMethodSubElements(Element beanEle, MethodOverrides overrides) &#123; NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) &#123; Element replacedMethodEle = (Element) node; String name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE); String callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE); ReplaceOverride replaceOverride = new ReplaceOverride(name, callback); // Look for arg-type match elements. List&lt;Element&gt; argTypeEles = DomUtils .getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT); for (Element argTypeEle : argTypeEles) &#123; String match = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE); match = (StringUtils.hasText(match) ? match : DomUtils.getTextValue(argTypeEle)); if (StringUtils.hasText(match)) &#123; replaceOverride.addTypeIdentifier(match); &#125; &#125; replaceOverride.setSource(extractSource(replacedMethodEle)); overrides.addOverride(replaceOverride); &#125; &#125;&#125; è¯¥å­å…ƒç´ å’Œ lookup-method èµ„æºçš„è§£æè¿‡ç¨‹å·®ä¸å¤šï¼ŒåŒæ ·æ˜¯æå– name å’Œ replacer å±æ€§æ„å»º ReplaceOverride å¯¹è±¡ï¼Œç„¶åè®°å½•åˆ° AbstractBeanDefinition ä¸­çš„ methodOverrides å±æ€§ä¸­ã€‚ å¯¹äº lookup-method å’Œ replaced-method ä¸¤ä¸ªå­å…ƒç´ æ˜¯å¦‚ä½•ä½¿ç”¨ä»¥å®Œæˆä»–ä»¬æ‰€æä¾›çš„åŠŸèƒ½ï¼Œåœ¨åç»­å®ä¾‹åŒ– Bean çš„æ—¶å€™ä¼šåšè¯¦ç»†è¯´æ˜ã€‚ è¿™ä¸¤ä¸ªæ ‡ç­¾å¾ˆå°‘ä½¿ç”¨","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šBeanDefinition","date":"2020-01-09T07:04:56.000Z","path":"2020/01/09/af1473fe.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2736 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE BeanDefinitionBeanDefinition æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæè¿°äº†ä¸€ä¸ª Bean å®ä¾‹ï¼ŒåŒ…æ‹¬å±æ€§å€¼ã€æ„é€ æ–¹æ³•å€¼å’Œç»§æ‰¿è‡ªå®ƒçš„ç±»çš„æ›´å¤šä¿¡æ¯ã€‚ ä»£ç å¦‚ä¸‹ï¼š public interface BeanDefinition extends AttributeAccessor, BeanMetadataElement &#123; String SCOPE_SINGLETON = ConfigurableBeanFactory.SCOPE_SINGLETON; String SCOPE_PROTOTYPE = ConfigurableBeanFactory.SCOPE_PROTOTYPE; int ROLE_APPLICATION = 0; int ROLE_SUPPORT = 1; int ROLE_INFRASTRUCTURE = 2; // Modifiable attributes void setParentName(@Nullable String parentName); @Nullable String getParentName(); void setBeanClassName(@Nullable String beanClassName); @Nullable String getBeanClassName(); void setScope(@Nullable String scope); @Nullable String getScope(); void setLazyInit(boolean lazyInit); boolean isLazyInit(); void setDependsOn(@Nullable String... dependsOn); @Nullable String[] getDependsOn(); void setAutowireCandidate(boolean autowireCandidate); boolean isAutowireCandidate(); void setPrimary(boolean primary); boolean isPrimary(); void setFactoryBeanName(@Nullable String factoryBeanName); @Nullable String getFactoryBeanName(); void setFactoryMethodName(@Nullable String factoryMethodName); @Nullable String getFactoryMethodName(); ConstructorArgumentValues getConstructorArgumentValues(); default boolean hasConstructorArgumentValues() &#123; return !getConstructorArgumentValues().isEmpty(); &#125; MutablePropertyValues getPropertyValues(); default boolean hasPropertyValues() &#123; return !getPropertyValues().isEmpty(); &#125; // Read-only attributes boolean isSingleton(); boolean isPrototype(); boolean isAbstract(); int getRole(); @Nullable String getDescription(); @Nullable String getResourceDescription(); @Nullable BeanDefinition getOriginatingBeanDefinition();&#125; çˆ¶ç±»BeanDefinitionç»§æ‰¿ AttributeAccessor å’Œ BeanMetadataElement æ¥å£ã€‚ä¸¤ä¸ªæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š AttributeAccessor ï¼šå®šä¹‰äº†ä¸å…¶å®ƒå¯¹è±¡çš„ï¼ˆå…ƒæ•°æ®ï¼‰è¿›è¡Œè¿æ¥å’Œè®¿é—®çš„çº¦å®šï¼Œå³å¯¹å±æ€§çš„ä¿®æ”¹ï¼ŒåŒ…æ‹¬è·å–ã€è®¾ç½®ã€åˆ é™¤ã€‚ ä»£ç å¦‚ä¸‹ï¼š public interface AttributeAccessor &#123; void setAttribute(String name, @Nullable Object value); @Nullable Object getAttribute(String name); @Nullable Object removeAttribute(String name); boolean hasAttribute(String name); String[] attributeNames();&#125; BeanMetadataElementï¼šBean å…ƒå¯¹è±¡æŒæœ‰çš„é…ç½®å…ƒç´ å¯ä»¥é€šè¿‡getSource() æ–¹æ³•æ¥è·å–ã€‚ ä»£ç å¦‚ä¸‹ï¼š public interface BeanMetadataElement &#123; @Nullable Object getSource();&#125; å­ç±»BeanDefinition æ•´ä¸ªç»“æ„å¦‚ä¸‹å›¾ï¼š æˆ‘ä»¬å¸¸ç”¨çš„ä¸‰ä¸ªå®ç°ç±»æœ‰ï¼šChildBeanDefinitionã€GenericBeanDefinitionã€RootBeanDefinitionï¼Œä¸‰è€…éƒ½ç»§æ‰¿ AbstractBeanDefinitionã€‚å¦‚æœé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†çˆ¶ å’Œ å­ ï¼Œåˆ™çˆ¶ ç”¨ RootBeanDefinitionè¡¨ç¤ºï¼Œå­ ç”¨ ChildBeanDefinition è¡¨ç¤ºï¼Œè€Œæ²¡æœ‰çˆ¶çš„å°±ä½¿ç”¨RootBeanDefinition è¡¨ç¤ºã€‚GenericBeanDefinition ä¸ºä¸€ç«™å¼æœåŠ¡ç±»ã€‚AbstractBeanDefinitionå¯¹ä¸‰ä¸ªå­ç±»å…±åŒçš„ç±»ä¿¡æ¯è¿›è¡ŒæŠ½è±¡ã€‚ è§£æ Bean æ ‡ç­¾åœ¨ BeanDefinitionParserDelegate.parseBeanDefinitionElement() ä¸­å®Œæˆ Bean çš„è§£æï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå·²ç»å®Œæˆå¯¹ æ ‡ç­¾è§£æçš„ BeanDefinition å®ä¾‹ã€‚ createBeanDefinitionåœ¨è¯¥æ–¹æ³•å†…éƒ¨ï¼Œé¦–å…ˆè°ƒç”¨ createBeanDefinition() æ–¹æ³•åˆ›å»ºä¸€ä¸ªç”¨äºæ‰¿è½½å±æ€§çš„ GenericBeanDefinition å®ä¾‹ï¼Œå¦‚ä¸‹ï¼š protected AbstractBeanDefinition createBeanDefinition( @Nullable String className, @Nullable String parentName) throws ClassNotFoundException &#123; return BeanDefinitionReaderUtils.createBeanDefinition( parentName, className, this.readerContext.getBeanClassLoader());&#125; å§”æ‰˜ BeanDefinitionReaderUtils åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š public static AbstractBeanDefinition createBeanDefinition( @Nullable String parentName, @Nullable String className, @Nullable ClassLoader classLoader) throws ClassNotFoundException &#123; GenericBeanDefinition bd = new GenericBeanDefinition(); bd.setParentName(parentName); if (className != null) &#123; if (classLoader != null) &#123; bd.setBeanClass(ClassUtils.forName(className, classLoader)); &#125; else &#123; bd.setBeanClassName(className); &#125; &#125; return bd;&#125; è¯¥æ–¹æ³•ä¸»è¦æ˜¯è®¾ç½® parentName ã€classNameã€classLoaderã€‚ parseBeanDefinitionAttributesåˆ›å»ºå®Œ GenericBeanDefinition å®ä¾‹åï¼Œå†è°ƒç”¨ parseBeanDefinitionAttributes() ï¼Œè¯¥æ–¹æ³•å°†åˆ›å»ºå¥½çš„ GenericBeanDefinition å®ä¾‹å½“åšå‚æ•°ï¼Œå¯¹ Bean æ ‡ç­¾çš„æ‰€æœ‰å±æ€§è¿›è¡Œè§£æï¼Œå¦‚ä¸‹ï¼š public AbstractBeanDefinition parseBeanDefinitionAttributes( Element ele, String beanName, @Nullable BeanDefinition containingBean, AbstractBeanDefinition bd) &#123; // è§£æ scope æ ‡ç­¾ if (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123; error(&quot;Old 1.x &#x27;singleton&#x27; attribute in use - upgrade to &#x27;scope&#x27; declaration&quot;, ele); &#125; else if (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123; bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE)); &#125; else if (containingBean != null) &#123; // Take default from containing bean in case of an inner bean definition. bd.setScope(containingBean.getScope()); &#125; // è§£æ abstract æ ‡ç­¾ if (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123; bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE))); &#125; // è§£æ lazy-init æ ‡ç­¾ String lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE); if (DEFAULT_VALUE.equals(lazyInit)) &#123; lazyInit = this.defaults.getLazyInit(); &#125; bd.setLazyInit(TRUE_VALUE.equals(lazyInit)); // è§£æ autowire æ ‡ç­¾ String autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE); bd.setAutowireMode(getAutowireMode(autowire)); // è§£æ depends-on æ ‡ç­¾ if (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123; String dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE); bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS)); &#125; // è§£æ autowire-candidate æ ‡ç­¾ String autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE); if (&quot;&quot;.equals(autowireCandidate) || DEFAULT_VALUE.equals(autowireCandidate)) &#123; String candidatePattern = this.defaults.getAutowireCandidates(); if (candidatePattern != null) &#123; String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern); bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName)); &#125; &#125; else &#123; bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate)); &#125; // è§£æ primay æ ‡ç­¾ if (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123; bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE))); &#125; // è§£æ init-method æ ‡ç­¾ if (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123; String initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE); bd.setInitMethodName(initMethodName); &#125; else if (this.defaults.getInitMethod() != null) &#123; bd.setInitMethodName(this.defaults.getInitMethod()); bd.setEnforceInitMethod(false); &#125; // è§£æ destroy-mothod æ ‡ç­¾ if (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123; String destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE); bd.setDestroyMethodName(destroyMethodName); &#125; else if (this.defaults.getDestroyMethod() != null) &#123; bd.setDestroyMethodName(this.defaults.getDestroyMethod()); bd.setEnforceDestroyMethod(false); &#125; // è§£æ factory-method æ ‡ç­¾ if (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123; bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE)); &#125; if (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123; bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE)); &#125; return bd;&#125; ä»ä¸Šé¢ä»£ç æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å¯¹ Bean æ ‡ç­¾å±æ€§çš„è§£æï¼Œè¿™äº›å±æ€§æˆ‘ä»¬åœ¨å·¥ä½œä¸­éƒ½æˆ–å¤šæˆ–å°‘ç”¨åˆ°è¿‡ã€‚ å®Œæˆ Bean æ ‡ç­¾åŸºæœ¬å±æ€§è§£æåï¼Œä¼šä¾æ¬¡è°ƒç”¨ parseMetaElements()ã€parseLookupOverrideSubElements()ã€parseReplacedMethodSubElements() å¯¹å­å…ƒç´  metaã€lookup-methodã€replace-method å®Œæˆè§£æã€‚ä¸‹ç¯‡åšæ–‡å°†ä¼šå¯¹è¿™ä¸‰ä¸ªå­å…ƒç´ è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è§£æbeanæ ‡ç­¾ï¼šå¼€å¯è§£æè¿›ç¨‹","date":"2020-01-08T06:28:53.000Z","path":"2020/01/08/fb623179.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2731 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE import æ ‡ç­¾è§£æå®Œæ¯•äº†ï¼Œå†çœ‹ Spring ä¸­æœ€å¤æ‚ä¹Ÿæ˜¯æœ€é‡è¦çš„æ ‡ç­¾ bean æ ‡ç­¾çš„è§£æè¿‡ç¨‹ã€‚ åœ¨æ–¹æ³• parseDefaultElement() ä¸­ï¼Œå¦‚æœé‡åˆ°æ ‡ç­¾ ä¸º bean åˆ™è°ƒç”¨ processBeanDefinition() æ–¹æ³•è¿›è¡Œ bean æ ‡ç­¾è§£æï¼Œå¦‚ä¸‹ï¼š protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) &#123; bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error(&quot;Failed to register bean definition with name &#x27;&quot; + bdHolder.getBeanName() + &quot;&#x27;&quot;, ele, ex); &#125; // Send registration event. getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); &#125;&#125; æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ è°ƒç”¨ BeanDefinitionParserDelegate.parseBeanDefinitionElement() è¿›è¡Œå…ƒç´ è§£æï¼Œè§£æè¿‡ç¨‹ä¸­å¦‚æœå¤±è´¥ï¼Œè¿”å› nullï¼Œé”™è¯¯ç”± ProblemReporter å¤„ç†ã€‚å¦‚æœè§£ææˆåŠŸåˆ™è¿”å› BeanDefinitionHolder å®ä¾‹ bdHolderã€‚BeanDefinitionHolder ä¸ºæŒæœ‰ name å’Œ alias çš„ BeanDefinitionã€‚ è‹¥å®ä¾‹ bdHolder ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ BeanDefinitionParserDelegate.decorateBeanDefinitionIfRequired() è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾å¤„ç† è§£æå®Œæˆåï¼Œåˆ™è°ƒç”¨ BeanDefinitionReaderUtils.registerBeanDefinition() å¯¹ bdHolder è¿›è¡Œæ³¨å†Œ å‘å‡ºå“åº”äº‹ä»¶ï¼Œé€šçŸ¥ç›¸å…³çš„ç›‘å¬å™¨ï¼Œå®Œæˆ Bean æ ‡ç­¾è§£æ å…ˆçœ‹æ–¹æ³• parseBeanDefinitionElement()ï¼Œå¦‚ä¸‹ï¼š public BeanDefinitionHolder parseBeanDefinitionElement(Element ele, @Nullable BeanDefinition containingBean) &#123; // è§£æ ID å±æ€§ String id = ele.getAttribute(ID_ATTRIBUTE); // è§£æ name å±æ€§ String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); // åˆ†å‰² name å±æ€§ List&lt;String&gt; aliases = new ArrayList&lt;&gt;(); if (StringUtils.hasLength(nameAttr)) &#123; String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS); aliases.addAll(Arrays.asList(nameArr)); &#125; String beanName = id; if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123; beanName = aliases.remove(0); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;No XML &#x27;id&#x27; specified - using &#x27;&quot; + beanName + &quot;&#x27; as bean name and &quot; + aliases + &quot; as aliases&quot;); &#125; &#125; // æ£€æŸ¥ name çš„å”¯ä¸€æ€§ if (containingBean == null) &#123; checkNameUniqueness(beanName, aliases, ele); &#125; // è§£æ å±æ€§ï¼Œæ„é€  AbstractBeanDefinition AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean); if (beanDefinition != null) &#123; // å¦‚æœ beanName ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ®æ¡ä»¶æ„é€ ä¸€ä¸ª beanName if (!StringUtils.hasText(beanName)) &#123; try &#123; if (containingBean != null) &#123; beanName = BeanDefinitionReaderUtils.generateBeanName( beanDefinition, this.readerContext.getRegistry(), true); &#125; else &#123; beanName = this.readerContext.generateBeanName(beanDefinition); String beanClassName = beanDefinition.getBeanClassName(); if (beanClassName != null &amp;&amp; beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp; !this.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123; aliases.add(beanClassName); &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Neither XML &#x27;id&#x27; nor &#x27;name&#x27; specified - &quot; + &quot;using generated bean name [&quot; + beanName + &quot;]&quot;); &#125; &#125; catch (Exception ex) &#123; error(ex.getMessage(), ele); return null; &#125; &#125; String[] aliasesArray = StringUtils.toStringArray(aliases); // å°è£… BeanDefinitionHolder return new BeanDefinitionHolder(beanDefinition, beanName, aliasesArray); &#125; return null;&#125; è¿™ä¸ªæ–¹æ³•è¿˜æ²¡æœ‰å¯¹ Bean æ ‡ç­¾è¿›è¡Œè§£æï¼Œåªæ˜¯åœ¨è§£æåŠ¨ä½œä¹‹å‰åšäº†ä¸€äº›åŠŸèƒ½æ¶æ„ï¼Œä¸»è¦çš„å·¥ä½œæœ‰ï¼š è§£æ idã€name å±æ€§ï¼Œç¡®å®š alias é›†åˆï¼Œæ£€æµ‹ beanName æ˜¯å¦å”¯ä¸€ è°ƒç”¨æ–¹æ³• parseBeanDefinitionElement() å¯¹å±æ€§è¿›è¡Œè§£æå¹¶å°è£…æˆ GenericBeanDefinition å®ä¾‹ beanDefinition æ ¹æ®æ‰€è·å–çš„ä¿¡æ¯ï¼ˆbeanNameã€aliasesã€beanDefinitionï¼‰æ„é€  BeanDefinitionHolder å®ä¾‹å¯¹è±¡å¹¶è¿”å›ã€‚ è¿™é‡Œæœ‰å¿…è¦è¯´ä¸‹ beanName çš„å‘½åè§„åˆ™ï¼šå¦‚æœ id ä¸ä¸ºç©ºï¼Œåˆ™ beanName = idï¼›å¦‚æœ id ä¸ºç©ºï¼Œä½†æ˜¯ alias ä¸ç©ºï¼Œåˆ™ beanName ä¸º alias çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœä¸¤è€…éƒ½ä¸ºç©ºï¼Œåˆ™æ ¹æ®é»˜è®¤è§„åˆ™æ¥è®¾ç½® beanNameã€‚ ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤ç¬¬äºŒä¸ªæ­¥éª¤ä¸ºæ ¸å¿ƒæ–¹æ³•ï¼Œå®ƒä¸»è¦æ‰¿æ‹…è§£æ Bean æ ‡ç­¾ä¸­æ‰€æœ‰çš„å±æ€§å€¼ã€‚å¦‚ä¸‹ï¼š public AbstractBeanDefinition parseBeanDefinitionElement( Element ele, String beanName, @Nullable BeanDefinition containingBean) &#123; this.parseState.push(new BeanEntry(beanName)); String className = null; // è§£æ class å±æ€§ if (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123; className = ele.getAttribute(CLASS_ATTRIBUTE).trim(); &#125; String parent = null; // è§£æ parent å±æ€§ if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123; parent = ele.getAttribute(PARENT_ATTRIBUTE); &#125; try &#123; // åˆ›å»ºç”¨äºæ‰¿è½½å±æ€§çš„ GenericBeanDefinition å®ä¾‹ AbstractBeanDefinition bd = createBeanDefinition(className, parent); // è§£æé»˜è®¤ bean çš„å„ç§å±æ€§ parseBeanDefinitionAttributes(ele, beanName, containingBean, bd); // æå– description bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT)); // è§£æå…ƒæ•°æ® parseMetaElements(ele, bd); // è§£æ lookup-method å±æ€§ parseLookupOverrideSubElements(ele, bd.getMethodOverrides()); // è§£æ replaced-method å±æ€§ parseReplacedMethodSubElements(ele, bd.getMethodOverrides()); // è§£ææ„é€ å‡½æ•°å‚æ•° parseConstructorArgElements(ele, bd); // è§£æ property å­å…ƒç´  parsePropertyElements(ele, bd); // è§£æ qualifier å­å…ƒç´  parseQualifierElements(ele, bd); bd.setResource(this.readerContext.getResource()); bd.setSource(extractSource(ele)); return bd; &#125; catch (ClassNotFoundException ex) &#123; error(&quot;Bean class [&quot; + className + &quot;] not found&quot;, ele, ex); &#125; catch (NoClassDefFoundError err) &#123; error(&quot;Class that bean class [&quot; + className + &quot;] depends on not found&quot;, ele, err); &#125; catch (Throwable ex) &#123; error(&quot;Unexpected failure during bean definition parsing&quot;, ele, ex); &#125; finally &#123; this.parseState.pop(); &#125; return null;&#125; åˆ°è¿™é‡Œï¼ŒBean æ ‡ç­¾çš„æ‰€æœ‰å±æ€§æˆ‘ä»¬éƒ½å¯ä»¥çœ‹åˆ°å…¶è§£æçš„è¿‡ç¨‹ï¼Œä¹Ÿå°±è¯´åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»è§£æä¸€ä¸ªåŸºæœ¬å¯ç”¨çš„ BeanDefinitionã€‚ ç”±äºè§£æè¿‡ç¨‹è¾ƒä¸ºæ¼«é•¿ï¼Œç¯‡å¹…è¾ƒå¤§ï¼Œä¸ºäº†æ›´å¥½çš„è§‚çœ‹ä½“éªŒï¼Œå°†è¿™ç¯‡åšæ–‡è¿›è¡Œæ‹†åˆ†ã€‚ä¸‹ç¯‡åšå®¢ä¸»è¦ä»‹ç» BeanDefinitionï¼Œä»¥åŠè§£æé»˜è®¤ Bean çš„è¿‡ç¨‹ï¼ˆparseBeanDefinitionAttributes()ï¼‰ â€“ - IOC ä¹‹è§£æBeanï¼šè§£æ import æ ‡ç­¾","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹è§£æBeanï¼šè§£æimportæ ‡ç­¾","date":"2020-01-07T04:13:51.000Z","path":"2020/01/07/3f8e0ea3.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2724 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨IOC ä¹‹ æ³¨å†Œ BeanDefinitionä¸­åˆ†æåˆ°ï¼ŒSpring ä¸­æœ‰ä¸¤ç§è§£æ Bean çš„æ–¹å¼ã€‚å¦‚æœæ ¹èŠ‚ç‚¹æˆ–è€…å­èŠ‚ç‚¹é‡‡ç”¨é»˜è®¤å‘½åç©ºé—´çš„è¯ï¼Œåˆ™è°ƒç”¨ parseDefaultElement() è¿›è¡Œé»˜è®¤æ ‡ç­¾è§£æï¼Œå¦åˆ™è°ƒç”¨ delegate.parseCustomElement() æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰è§£æã€‚æ‰€ä»¥ï¼Œä»¥ä¸‹åšå®¢å°±è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œè¯¦ç»†åˆ†æè¯´æ˜ï¼Œå…ˆä»é»˜è®¤æ ‡ç­¾è§£æè¿‡ç¨‹å¼€å§‹ï¼Œæºç å¦‚ä¸‹ï¼š private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123; // å¯¹ import æ ‡ç­¾çš„è§£æ if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123; importBeanDefinitionResource(ele); &#125; // å¯¹ alias æ ‡ç­¾çš„è§£æ else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123; processAliasRegistration(ele); &#125; // å¯¹ bean æ ‡ç­¾çš„è§£æ else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123; processBeanDefinition(ele, delegate); &#125; // å¯¹ beans æ ‡ç­¾çš„è§£æ else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123; // recurse doRegisterBeanDefinitions(ele); &#125;&#125; æ–¹æ³•çš„åŠŸèƒ½ä¸€ç›®äº†ç„¶ï¼Œåˆ†åˆ«æ˜¯å¯¹å››ç§ä¸åŒçš„æ ‡ç­¾è¿›è¡Œè§£æï¼Œåˆ†åˆ«æ˜¯ importã€aliasã€beanã€beansã€‚å’±é—¨ä»ç¬¬ä¸€ä¸ªæ ‡ç­¾ import å¼€å§‹ã€‚ import æ ‡ç­¾çš„å¤„ç†ç»å†è¿‡ Spring é…ç½®æ–‡ä»¶çš„å°ä¼™ä¼´éƒ½çŸ¥é“ï¼Œå¦‚æœå·¥ç¨‹æ¯”è¾ƒå¤§ï¼Œé…ç½®æ–‡ä»¶çš„ç»´æŠ¤ä¼šè®©äººè§‰å¾—ææ€–ï¼Œæ–‡ä»¶å¤ªå¤šäº†ï¼Œæƒ³è±¡å°†æ‰€æœ‰çš„é…ç½®éƒ½æ”¾åœ¨ä¸€ä¸ª spring.xml é…ç½®æ–‡ä»¶ä¸­ï¼Œå“ªç§åæ€•æ„Ÿæ˜¯ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Ÿæ‰€æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µ Spring æä¾›äº†ä¸€ä¸ªåˆ†æ¨¡å—çš„æ€è·¯ï¼Œåˆ©ç”¨ import æ ‡ç­¾ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªè¿™æ ·çš„ spring.xmlã€‚ &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;import resource=&quot;spring-student.xml&quot;/&gt; &lt;import resource=&quot;spring-student-dtd.xml&quot;/&gt;&lt;/beans&gt; spring.xml é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ import æ ‡ç­¾çš„æ–¹å¼å¯¼å…¥å…¶ä»–æ¨¡å—çš„é…ç½®æ–‡ä»¶ã€‚ å¦‚æœæœ‰é…ç½®éœ€è¦ä¿®æ”¹ç›´æ¥ä¿®æ”¹ç›¸åº”é…ç½®æ–‡ä»¶å³å¯ã€‚ è‹¥æœ‰æ–°çš„æ¨¡å—éœ€è¦å¼•å…¥ç›´æ¥å¢åŠ  import å³å¯ã€‚ è¿™æ ·å¤§å¤§ç®€åŒ–äº†é…ç½®åæœŸç»´æŠ¤çš„å¤æ‚åº¦ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºç®¡ç†ã€‚ importBeanDefinitionResourceSpring åˆ©ç”¨ importBeanDefinitionResource() æ–¹æ³•å®Œæˆå¯¹ import æ ‡ç­¾çš„è§£æã€‚ protected void importBeanDefinitionResource(Element ele) &#123; // è·å– resource çš„å±æ€§å€¼ String location = ele.getAttribute(RESOURCE_ATTRIBUTE); // ä¸ºç©ºï¼Œç›´æ¥é€€å‡º if (!StringUtils.hasText(location)) &#123; getReaderContext().error(&quot;Resource location must not be empty&quot;, ele); return; &#125; // è§£æç³»ç»Ÿå±æ€§ï¼Œæ ¼å¼å¦‚ ï¼š&quot;$&#123;user.dir&#125;&quot; location = getReaderContext().getEnvironment().resolveRequiredPlaceholders(location); Set&lt;Resource&gt; actualResources = new LinkedHashSet&lt;&gt;(4); // åˆ¤æ–­ location æ˜¯ç›¸å¯¹è·¯å¾„è¿˜æ˜¯ç»å¯¹è·¯å¾„ boolean absoluteLocation = false; try &#123; absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute(); &#125; catch (URISyntaxException ex) &#123; // cannot convert to an URI, considering the location relative // unless it is the well-known Spring prefix &quot;classpath*:&quot; &#125; // ç»å¯¹è·¯å¾„ if (absoluteLocation) &#123; try &#123; // ç›´æ¥æ ¹æ®åœ°è´¨åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶ int importCount = getReaderContext() .getReader().loadBeanDefinitions(location, actualResources); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Imported &quot; + importCount + &quot; bean definitions from URL location [&quot; + location + &quot;]&quot;); &#125; &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext().error( &quot;Failed to import bean definitions from URL location [&quot; + location + &quot;]&quot;, ele, ex); &#125; &#125; else &#123; // ç›¸å¯¹è·¯å¾„åˆ™æ ¹æ®ç›¸åº”çš„åœ°è´¨è®¡ç®—å‡ºç»å¯¹è·¯å¾„åœ°å€ try &#123; int importCount; Resource relativeResource = getReaderContext() .getResource().createRelative(location); if (relativeResource.exists()) &#123; importCount = getReaderContext() .getReader().loadBeanDefinitions(relativeResource); actualResources.add(relativeResource); &#125; else &#123; String baseLocation = getReaderContext() .getResource().getURL().toString(); importCount = getReaderContext().getReader() .loadBeanDefinitions( StringUtils.applyRelativePath(baseLocation, location), actualResources); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Imported &quot; + importCount + &quot; bean definitions from relative location [&quot; + location + &quot;]&quot;); &#125; &#125; catch (IOException ex) &#123; getReaderContext().error(&quot;Failed to resolve current resource location&quot;, ele, ex); &#125; catch (BeanDefinitionStoreException ex) &#123; getReaderContext() .error(&quot;Failed to import bean definitions from relative location [&quot; + location + &quot;]&quot;, ele, ex); &#125; &#125; // è§£ææˆåŠŸåï¼Œè¿›è¡Œç›‘å¬å™¨æ¿€æ´»å¤„ç† Resource[] actResArray = actualResources.toArray(new Resource[0]); getReaderContext().fireImportProcessed(location, actResArray, extractSource(ele));&#125; è§£æ import è¿‡ç¨‹è¾ƒä¸ºæ¸…æ™°ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š è·å– source å±æ€§çš„å€¼ï¼Œè¯¥å€¼è¡¨ç¤ºèµ„æºçš„è·¯å¾„ è§£æè·¯å¾„ä¸­çš„ç³»ç»Ÿå±æ€§ï¼Œå¦‚â€$&#123;user.dir&#125;â€œ åˆ¤æ–­èµ„æºè·¯å¾„ location æ˜¯ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„ å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œåˆ™è°ƒé€’å½’è°ƒç”¨ Bean çš„è§£æè¿‡ç¨‹ï¼Œè¿›è¡Œå¦ä¸€æ¬¡çš„è§£æ å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™å…ˆè®¡ç®—å‡ºç»å¯¹è·¯å¾„å¾—åˆ° Resourceï¼Œç„¶åè¿›è¡Œè§£æ é€šçŸ¥ç›‘å¬å™¨ï¼Œå®Œæˆè§£æ åˆ¤æ–­è·¯å¾„ æ–¹æ³•é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥åˆ¤æ–­ location æ˜¯ä¸ºç›¸å¯¹è·¯å¾„è¿˜æ˜¯ç»å¯¹è·¯å¾„ï¼š absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute(); åˆ¤æ–­ç»å¯¹è·¯å¾„çš„è§„åˆ™å¦‚ä¸‹ï¼š ä»¥ classpath*: æˆ–è€… classpath: å¼€å¤´ä¸ºç»å¯¹è·¯å¾„ èƒ½å¤Ÿé€šè¿‡è¯¥ location æ„å»ºå‡º java.net.URLä¸ºç»å¯¹è·¯å¾„ æ ¹æ® location æ„é€  java.net.URI åˆ¤æ–­è°ƒç”¨ isAbsolute() åˆ¤æ–­æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ ç»å¯¹è·¯å¾„ å¦‚æœ location ä¸ºç»å¯¹è·¯å¾„åˆ™è°ƒç”¨ loadBeanDefinitions()ï¼Œè¯¥æ–¹æ³•åœ¨ AbstractBeanDefinitionReader ä¸­å®šä¹‰ã€‚ public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123; ResourceLoader resourceLoader = getResourceLoader(); if (resourceLoader == null) &#123; throw new BeanDefinitionStoreException( &quot;Cannot import bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;); &#125; if (resourceLoader instanceof ResourcePatternResolver) &#123; // Resource pattern matching available. try &#123; Resource[] resources = ((ResourcePatternResolver) resourceLoader) .getResources(location); int loadCount = loadBeanDefinitions(resources); if (actualResources != null) &#123; for (Resource resource : resources) &#123; actualResources.add(resource); &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;); &#125; return loadCount; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex); &#125; &#125; else &#123; // Can only load single resources by absolute URL. Resource resource = resourceLoader.getResource(location); int loadCount = loadBeanDefinitions(resource); if (actualResources != null) &#123; actualResources.add(resource); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location [&quot; + location + &quot;]&quot;); &#125; return loadCount; &#125;&#125; æ•´ä¸ªé€»è¾‘æ¯”è¾ƒç®€å•ï¼š é¦–å…ˆè·å– ResourceLoader ç„¶åæ ¹æ®ä¸åŒçš„ ResourceLoader æ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œä¸»è¦æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ª Resource æœ€ç»ˆéƒ½ä¼šå›å½’åˆ° XmlBeanDefinitionReader.loadBeanDefinitions() ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚ è·å¾—åˆ°çš„ Resource çš„å¯¹è±¡æˆ–æ•°ç»„ï¼Œéƒ½ä¼šæ·»åŠ åˆ° actualResources ä¸­ã€‚ ç›¸å¯¹è·¯å¾„å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™ä¼šæ ¹æ®ç›¸åº”çš„ Resource è®¡ç®—å‡ºç›¸åº”çš„ç»å¯¹è·¯å¾„ï¼Œç„¶å æ ¹æ®è¯¥è·¯å¾„æ„é€ ä¸€ä¸ª Resourceï¼Œè‹¥è¯¥ Resource å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ XmlBeanDefinitionReader.loadBeanDefinitions() è¿›è¡Œ BeanDefinition åŠ è½½ å¦åˆ™æ„é€ ä¸€ä¸ªç»å¯¹ location ï¼Œè°ƒç”¨ AbstractBeanDefinitionReader.loadBeanDefinitions() æ–¹æ³•ï¼Œä¸ç»å¯¹è·¯å¾„è¿‡ç¨‹ä¸€æ ·ã€‚ è‡³æ­¤ï¼Œimport æ ‡ç­¾è§£æå®Œæ¯•ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒæ¸…æ™°æ˜äº†ï¼šè·å– source å±æ€§å€¼ï¼Œå¾—åˆ°æ­£ç¡®çš„èµ„æºè·¯å¾„ï¼Œç„¶åè°ƒç”¨ loadBeanDefinitions() æ–¹æ³•è¿›è¡Œé€’å½’çš„ BeanDefinition åŠ è½½","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹æ³¨å†ŒBeanDefinitions","date":"2020-01-06T10:53:34.000Z","path":"2020/01/06/9de498cf.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2697 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE è·å– Document å¯¹è±¡åï¼Œä¼šæ ¹æ®è¯¥å¯¹è±¡å’Œ Resource èµ„æºå¯¹è±¡è°ƒç”¨ registerBeanDefinitions() æ–¹æ³•ï¼Œå¼€å§‹æ³¨å†Œ BeanDefinitions ä¹‹æ—…ã€‚å¦‚ä¸‹ï¼š public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123; BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore;&#125; é¦–å…ˆè°ƒç”¨ createBeanDefinitionDocumentReader() æ–¹æ³•å®ä¾‹åŒ– BeanDefinitionDocumentReader å¯¹è±¡ï¼Œç„¶åè·å–ç»Ÿè®¡å‰ BeanDefinition çš„ä¸ªæ•°ï¼Œæœ€åè°ƒç”¨ registerBeanDefinitions() æ³¨å†Œ BeanDefinitionã€‚ å®ä¾‹åŒ– BeanDefinitionDocumentReader å¯¹è±¡æ–¹æ³•å¦‚ä¸‹ï¼š protected BeanDefinitionDocumentReader createBeanDefinitionDocumentReader() &#123; return BeanDefinitionDocumentReader.class.cast(BeanUtils .instantiateClass(this.documentReaderClass));&#125; æ³¨å†Œ BeanDefinition çš„æ–¹æ³• registerBeanDefinitions() æ˜¯åœ¨æ¥å£ BeanDefinitionDocumentReader ä¸­å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) throws BeanDefinitionStoreException; ä»ç»™å®šçš„ Document å¯¹è±¡ä¸­è§£æå®šä¹‰çš„ BeanDefinition å¹¶å°†ä»–ä»¬æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ã€‚ æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œå¾…è§£æçš„ Document å¯¹è±¡ï¼Œä»¥åŠè§£æå™¨çš„å½“å‰ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç›®æ ‡æ³¨å†Œè¡¨å’Œè¢«è§£æçš„èµ„æºã€‚å…¶ä¸­ readerContext æ˜¯æ ¹æ® Resource æ¥åˆ›å»ºçš„ï¼Œå¦‚ä¸‹ï¼š public XmlReaderContext createReaderContext(Resource resource) &#123; return new XmlReaderContext(resource, this.problemReporter, this.eventListener, this.sourceExtractor, this, getNamespaceHandlerResolver());&#125; DefaultBeanDefinitionDocumentReader å¯¹è¯¥æ–¹æ³•æä¾›äº†å®ç°ï¼š public void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123; this.readerContext = readerContext; logger.debug(&quot;Loading bean definitions&quot;); Element root = doc.getDocumentElement(); doRegisterBeanDefinitions(root);&#125; è°ƒç”¨ doRegisterBeanDefinitions() å¼€å¯æ³¨å†Œ BeanDefinition ä¹‹æ—…ã€‚ protected void doRegisterBeanDefinitions(Element root) &#123; BeanDefinitionParserDelegate parent = this.delegate; this.delegate = createDelegate(getReaderContext(), root, parent); if (this.delegate.isDefaultNamespace(root)) &#123; // å¤„ç† profile String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); if (StringUtils.hasText(profileSpec)) &#123; String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123; if (logger.isInfoEnabled()) &#123; logger.info( &quot;Skipped XML bean definition file due to specified profiles [&quot; + profileSpec + &quot;] not matching: &quot; + getReaderContext().getResource()); &#125; return; &#125; &#125; &#125; // è§£æå‰å¤„ç† preProcessXml(root); // è§£æ parseBeanDefinitions(root, this.delegate); // è§£æåå¤„ç† postProcessXml(root); this.delegate = parent;&#125; ç¨‹åºé¦–å…ˆå¤„ç† profileå±æ€§ï¼Œprofileä¸»è¦ç”¨äºæˆ‘ä»¬åˆ‡æ¢ç¯å¢ƒï¼Œæ¯”å¦‚åˆ‡æ¢å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒï¼Œéå¸¸æ–¹ä¾¿ã€‚ç„¶åè°ƒç”¨ parseBeanDefinitions() è¿›è¡Œè§£æåŠ¨ä½œï¼Œä¸è¿‡åœ¨è¯¥æ–¹æ³•ä¹‹å‰ä¹‹ååˆ†åˆ«è°ƒç”¨ preProcessXml() å’Œ postProcessXml() æ–¹æ³•æ¥è¿›è¡Œå‰ã€åå¤„ç†ï¼Œç›®å‰è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ç©ºå®ç°ï¼Œäº¤ç”±å­ç±»æ¥å®ç°ã€‚ protected void preProcessXml(Element root) &#123;&#125;protected void postProcessXml(Element root) &#123;&#125; parseBeanDefinitions() å®šä¹‰å¦‚ä¸‹ï¼š protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; if (delegate.isDefaultNamespace(root)) &#123; NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); if (node instanceof Element) &#123; Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) &#123; parseDefaultElement(ele, delegate); &#125; else &#123; delegate.parseCustomElement(ele); &#125; &#125; &#125; &#125; else &#123; delegate.parseCustomElement(root); &#125;&#125; æœ€ç»ˆè§£æåŠ¨ä½œè½åœ°åœ¨ä¸¤ä¸ªæ–¹æ³•å¤„ï¼šparseDefaultElement(ele, delegate) å’Œ delegate.parseCustomElement(root)ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Spring æœ‰ä¸¤ç§ Bean å£°æ˜æ–¹å¼ï¼š é…ç½®æ–‡ä»¶å¼å£°æ˜ï¼š&lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.StudentService&quot;/&gt; è‡ªå®šä¹‰æ³¨è§£æ–¹å¼ï¼š&lt;tx:annotation-driven&gt; ä¸¤ç§æ–¹å¼çš„è¯»å–å’Œè§£æéƒ½å­˜åœ¨è¾ƒå¤§çš„å·®å¼‚ï¼Œæ‰€ä»¥é‡‡ç”¨ä¸åŒçš„è§£ææ–¹æ³•ï¼Œå¦‚æœæ ¹èŠ‚ç‚¹æˆ–è€…å­èŠ‚ç‚¹é‡‡ç”¨é»˜è®¤å‘½åç©ºé—´çš„è¯ï¼Œåˆ™è°ƒç”¨ parseDefaultElement() è¿›è¡Œè§£æï¼Œå¦åˆ™è°ƒç”¨ delegate.parseCustomElement() æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰è§£æã€‚ è‡³æ­¤ï¼ŒdoLoadBeanDefinitions() ä¸­åšçš„ä¸‰ä»¶äº‹æƒ…å·²ç»å…¨éƒ¨åˆ†æå®Œæ¯•ï¼Œä¸‹é¢å°†å¯¹ Bean çš„è§£æè¿‡ç¨‹åšè¯¦ç»†åˆ†æè¯´æ˜ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è·å–Documentå¯¹è±¡","date":"2020-01-05T06:21:04.000Z","path":"2020/01/05/13336b20.html","text":"åœ¨ XmlBeanDefinitionReader.doLoadDocument() æ–¹æ³•ä¸­åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯è°ƒç”¨ getValidationModeForResource() è·å– XML çš„éªŒè¯æ¨¡å¼ï¼ŒäºŒæ˜¯è°ƒç”¨ DocumentLoader.loadDocument() è·å– Document å¯¹è±¡ã€‚ä¸Šç¯‡åšå®¢å·²ç»åˆ†æäº†è·å– XML éªŒè¯æ¨¡å¼ï¼ˆIOC ä¹‹ è·å–éªŒè¯æ¨¡å‹ï¼‰ï¼Œè¿™ç¯‡æˆ‘ä»¬åˆ†æè·å– Document å¯¹è±¡ã€‚ DocumentLoaderè·å– Document çš„ç­–ç•¥ç”±æ¥å£ DocumentLoader å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š public interface DocumentLoader &#123; Document loadDocument( InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) throws Exception;&#125; DocumentLoader ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³• loadDocument() ï¼Œè¯¥æ–¹æ³•æ¥æ”¶äº”ä¸ªå‚æ•°ï¼š inputSourceï¼šåŠ è½½ Document çš„ Resource æº entityResolverï¼šè§£ææ–‡ä»¶çš„è§£æå™¨ errorHandlerï¼šå¤„ç†åŠ è½½ Document å¯¹è±¡çš„è¿‡ç¨‹çš„é”™è¯¯ validationModeï¼šéªŒè¯æ¨¡å¼ namespaceAwareï¼šå‘½åç©ºé—´æ”¯æŒã€‚ å¦‚æœè¦æä¾›å¯¹ XML åç§°ç©ºé—´çš„æ”¯æŒï¼Œåˆ™ä¸ºtrue è¯¥æ–¹æ³•ç”± DocumentLoader çš„é»˜è®¤å®ç°ç±» DefaultDocumentLoader å®ç°ï¼Œå¦‚ä¸‹ï¼š public Document loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware) throws Exception &#123; DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Using JAXP provider [&quot; + factory.getClass().getName() + &quot;]&quot;); &#125; DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler); return builder.parse(inputSource);&#125; é¦–å…ˆè°ƒç”¨ createDocumentBuilderFactory() åˆ›å»º DocumentBuilderFactory ï¼Œå†é€šè¿‡è¯¥ factory åˆ›å»º DocumentBuilderï¼Œæœ€åè§£æ InputSource è¿”å› Document å¯¹è±¡ã€‚ EntityResolverloadDocument() è·å– Document å¯¹è±¡æ—¶ï¼Œæœ‰ä¸€ä¸ªå‚æ•° entityResolver ï¼Œè¯¥å‚æ•°æ˜¯é€šè¿‡ getEntityResolver() è·å–çš„ã€‚ getEntityResolver() è¿”å›æŒ‡å®šçš„è§£æå™¨ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ„é€ ä¸€ä¸ªæœªæŒ‡å®šçš„é»˜è®¤è§£æå™¨ã€‚ protected EntityResolver getEntityResolver() &#123; if (this.entityResolver == null) &#123; ResourceLoader resourceLoader = getResourceLoader(); if (resourceLoader != null) &#123; this.entityResolver = new ResourceEntityResolver(resourceLoader); &#125; else &#123; this.entityResolver = new DelegatingEntityResolver(getBeanClassLoader()); &#125; &#125; return this.entityResolver;&#125; å¦‚æœ ResourceLoader ä¸ä¸º nullï¼Œåˆ™æ ¹æ®æŒ‡å®šçš„ ResourceLoader åˆ›å»ºä¸€ä¸ª ResourceEntityResolverã€‚ å¦‚æœ ResourceLoader ä¸ºnullï¼Œåˆ™åˆ›å»º ä¸€ä¸ª DelegatingEntityResolverï¼Œè¯¥ Resolver å§”æ‰˜ç»™é»˜è®¤çš„ BeansDtdResolver å’Œ PluggableSchemaResolver ã€‚ æ¶‰åŠå­ç±» ResourceEntityResolverï¼šç»§æ‰¿è‡ª EntityResolver ï¼Œé€šè¿‡ ResourceLoader æ¥è§£æå®ä½“çš„å¼•ç”¨ã€‚ DelegatingEntityResolverï¼šEntityResolver çš„å®ç°ï¼Œåˆ†åˆ«ä»£ç†äº† dtd çš„ BeansDtdResolver å’Œ xml schemas çš„ PluggableSchemaResolverã€‚ BeansDtdResolver ï¼š spring bean dtd è§£æå™¨ã€‚EntityResolver çš„å®ç°ï¼Œç”¨æ¥ä» classpath æˆ–è€… jar æ–‡ä»¶åŠ è½½ dtdã€‚ PluggableSchemaResolverï¼šä½¿ç”¨ä¸€ç³»åˆ— Map æ–‡ä»¶å°† schema url è§£æåˆ°æœ¬åœ° classpath èµ„æº getEntityResolver() è¿”å› EntityResolver ï¼Œé‚£è¿™ä¸ª EntityResolver åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ If a SAX application needs to implement customized handling for external entities, it must implement this interface and register an instance with the SAX driver using the setEntityResolver method.å°±æ˜¯è¯´ï¼šå¦‚æœ SAX åº”ç”¨ç¨‹åºéœ€è¦å®ç°è‡ªå®šä¹‰å¤„ç†å¤–éƒ¨å®ä½“ï¼Œåˆ™å¿…é¡»å®ç°æ­¤æ¥å£å¹¶ä½¿ç”¨ setEntityResolver() å‘ SAX é©±åŠ¨å™¨æ³¨å†Œä¸€ä¸ªå®ä¾‹ã€‚ å¦‚ä¸‹ï¼š public class MyResolver implements EntityResolver &#123; public InputSource resolveEntity (String publicId, String systemId)&#123; if (systemId.equals(&quot;http://www.myhost.com/today&quot;))&#123; MyReader reader = new MyReader(); return new InputSource(reader); &#125; else &#123; // use the default behaviour return null; &#125; &#125;&#125; æˆ‘ä»¬é¦–å…ˆå°† spring-student.xml æ–‡ä»¶ä¸­çš„ XSD å£°æ˜çš„åœ°å€æ”¹æ‰ï¼Œå¦‚ä¸‹ï¼š å¦‚æœæˆ‘ä»¬å†æ¬¡è¿è¡Œï¼Œåˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š ä»ä¸Šé¢çš„é”™è¯¯å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨è¿›è¡Œæ–‡æ¡£éªŒè¯æ—¶ï¼Œæ— æ³•æ ¹æ®å£°æ˜æ‰¾åˆ° XSD éªŒè¯æ–‡ä»¶è€Œå¯¼è‡´æ— æ³•è¿›è¡Œ XML æ–‡ä»¶éªŒè¯ã€‚åœ¨(IOC ä¹‹ è·å–éªŒè¯æ¨¡å‹)ä¸­è®²åˆ°ï¼Œå¦‚æœè¦è§£æä¸€ä¸ª XML æ–‡ä»¶ï¼ŒSAX é¦–å…ˆä¼šè¯»å–è¯¥ XML æ–‡æ¡£ä¸Šçš„å£°æ˜ï¼Œç„¶åæ ¹æ®å£°æ˜å»å¯»æ‰¾ç›¸åº”çš„ DTD å®šä¹‰ï¼Œä»¥ä¾¿å¯¹æ–‡æ¡£è¿›è¡ŒéªŒè¯ã€‚é»˜è®¤çš„åŠ è½½è§„åˆ™æ˜¯é€šè¿‡ç½‘ç»œæ–¹å¼ä¸‹è½½éªŒè¯æ–‡ä»¶ï¼Œè€Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¼šé‡åˆ°ç½‘ç»œä¸­æ–­æˆ–è€…ä¸å¯ç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆå°±åº”ç”¨å°±ä¼šå› ä¸ºæ— æ³•ä¸‹è½½éªŒè¯æ–‡ä»¶è€ŒæŠ¥é”™ã€‚ EntityResolver çš„ä½œç”¨å°±æ˜¯åº”ç”¨æœ¬èº«å¯ä»¥æä¾›ä¸€ä¸ªå¦‚ä½•å¯»æ‰¾éªŒè¯æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³è‡ªå®šä¹‰å®ç°ã€‚ æ¥å£å£°æ˜å¦‚ä¸‹ï¼š public interface EntityResolver &#123; public abstract InputSource resolveEntity (String publicId,String systemId) throws SAXException, IOException;&#125; æ¥å£æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•° publicId å’Œ systemIdï¼Œå¹¶è¿”å› InputSource å¯¹è±¡ã€‚ä¸¤ä¸ªå‚æ•°å£°æ˜å¦‚ä¸‹ï¼š publicIdï¼šè¢«å¼•ç”¨çš„å¤–éƒ¨å®ä½“çš„å…¬å…±æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æä¾›ï¼Œåˆ™è¿”å›null systemIdï¼šè¢«å¼•ç”¨çš„å¤–éƒ¨å®ä½“çš„ç³»ç»Ÿæ ‡è¯†ç¬¦ è¿™ä¸¤ä¸ªå‚æ•°çš„å®é™…å†…å®¹å’Œå…·ä½“çš„éªŒè¯æ¨¡å¼æœ‰å…³ç³»ã€‚å¦‚ä¸‹ XSD éªŒè¯æ¨¡å¼ publicIdï¼šnull systemIdï¼šhttp://www.springframework.org/schema/beans/spring-beans.xsd DTD éªŒè¯æ¨¡å¼ publicIdï¼š-//SPRING//DTD BEAN 2.0//EN systemIdï¼šhttp://www.springframework.org/dtd/spring-beans.dtd å¦‚ä¸‹ï¼š æˆ‘ä»¬çŸ¥é“åœ¨ Spring ä¸­ä½¿ç”¨ DelegatingEntityResolver ä¸º EntityResolver çš„å®ç°ç±»ï¼ŒresolveEntity() å®ç°å¦‚ä¸‹ï¼š public InputSource resolveEntity(String publicId, @Nullable String systemId) throws SAXException, IOException &#123; if (systemId != null) &#123; if (systemId.endsWith(DTD_SUFFIX)) &#123; return this.dtdResolver.resolveEntity(publicId, systemId); &#125; else if (systemId.endsWith(XSD_SUFFIX)) &#123; return this.schemaResolver.resolveEntity(publicId, systemId); &#125; &#125; return null;&#125; ä¸åŒçš„éªŒè¯æ¨¡å¼ä½¿ç”¨ä¸åŒçš„è§£æå™¨è§£æï¼Œå¦‚æœæ˜¯ DTD éªŒè¯æ¨¡å¼åˆ™ä½¿ç”¨ BeansDtdResolver æ¥è¿›è¡Œè§£æï¼Œå¦‚æœæ˜¯ XSD åˆ™ä½¿ç”¨ PluggableSchemaResolver æ¥è¿›è¡Œè§£æã€‚ BeansDtdResolver çš„è§£æè¿‡ç¨‹å¦‚ä¸‹: public InputSource resolveEntity(String publicId, @Nullable String systemId) throws IOException &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Trying to resolve XML entity with public ID [&quot; + publicId + &quot;] and system ID [&quot; + systemId + &quot;]&quot;); &#125; if (systemId != null &amp;&amp; systemId.endsWith(DTD_EXTENSION)) &#123; int lastPathSeparator = systemId.lastIndexOf(&#x27;/&#x27;); int dtdNameStart = systemId.indexOf(DTD_NAME, lastPathSeparator); if (dtdNameStart != -1) &#123; String dtdFile = DTD_NAME + DTD_EXTENSION; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Trying to locate [&quot; + dtdFile + &quot;] in Spring jar on classpath&quot;); &#125; try &#123; Resource resource = new ClassPathResource(dtdFile, getClass()); InputSource source = new InputSource(resource.getInputStream()); source.setPublicId(publicId); source.setSystemId(systemId); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Found beans DTD [&quot; + systemId + &quot;] in classpath: &quot; + dtdFile); &#125; return source; &#125; catch (IOException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Could not resolve beans DTD [&quot; + systemId + &quot;]: not found in classpath&quot;, ex); &#125; &#125; &#125; &#125; or wherever. return null;&#125; ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŠ è½½ DTD ç±»å‹çš„ BeansDtdResolver.resolveEntity() åªæ˜¯å¯¹ systemId è¿›è¡Œäº†ç®€å•çš„æ ¡éªŒï¼ˆä»æœ€åä¸€ä¸ª / å¼€å§‹ï¼Œå†…å®¹ä¸­æ˜¯å¦åŒ…å« spring-beansï¼‰ï¼Œç„¶åæ„é€ ä¸€ä¸ª InputSource å¹¶è®¾ç½® publicIdã€systemIdï¼Œç„¶åè¿”å›ã€‚ PluggableSchemaResolver çš„è§£æè¿‡ç¨‹å¦‚ä¸‹: public InputSource resolveEntity(String publicId, @Nullable String systemId) throws IOException &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Trying to resolve XML entity with public id [&quot; + publicId + &quot;] and system id [&quot; + systemId + &quot;]&quot;); &#125; if (systemId != null) &#123; String resourceLocation = getSchemaMappings().get(systemId); if (resourceLocation != null) &#123; Resource resource = new ClassPathResource(resourceLocation, this.classLoader); try &#123; InputSource source = new InputSource(resource.getInputStream()); source.setPublicId(publicId); source.setSystemId(systemId); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Found XML schema [&quot; + systemId + &quot;] in classpath: &quot; + resourceLocation); &#125; return source; &#125; catch (FileNotFoundException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Couldn&#x27;t find XML schema [&quot; + systemId + &quot;]: &quot; + resource, ex); &#125; &#125; &#125; &#125; return null;&#125; é¦–å…ˆè°ƒç”¨ getSchemaMappings() è·å–ä¸€ä¸ªæ˜ å°„è¡¨(systemId ä¸å…¶åœ¨æœ¬åœ°çš„å¯¹ç…§å…³ç³»)ï¼Œç„¶åæ ¹æ®ä¼ å…¥çš„ systemId è·å–è¯¥ systemId åœ¨æœ¬åœ°çš„è·¯å¾„ resourceLocationï¼Œæœ€åæ ¹æ® resourceLocation æ„é€  InputSource å¯¹è±¡ã€‚ æ˜ å°„è¡¨å¦‚ä¸‹ï¼ˆéƒ¨åˆ†ï¼‰:","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹è·å–éªŒè¯æ¨¡å‹","date":"2020-01-04T06:21:04.000Z","path":"2020/01/04/4e0696ee.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2658 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE åœ¨ä¸Šç¯‡åšå®¢IOC ä¹‹ åŠ è½½ BeanDefinition ä¸­æåˆ°ï¼Œåœ¨æ ¸å¿ƒé€»è¾‘æ–¹æ³• doLoadBeanDefinitions()ä¸­ä¸»è¦æ˜¯åšä¸‰ä»¶äº‹æƒ…ã€‚ è°ƒç”¨ getValidationModeForResource() è·å– xml æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ è°ƒç”¨ loadDocument() æ ¹æ® xml æ–‡ä»¶è·å–ç›¸åº”çš„ Document å®ä¾‹ã€‚ è°ƒç”¨ registerBeanDefinitions() æ³¨å†Œ Bean å®ä¾‹ã€‚ è¿™ç¯‡åšå®¢ä¸»è¦åˆ†æè·å– xml æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ã€‚ XML æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ä¿è¯äº† XML æ–‡ä»¶çš„æ­£ç¡®æ€§ DTD ä¸ XSD çš„åŒºåˆ«DTD(Document Type Definition)ï¼Œå³æ–‡æ¡£ç±»å‹å®šä¹‰ï¼Œä¸º XML æ–‡ä»¶çš„éªŒè¯æœºåˆ¶ï¼Œå±äº XML æ–‡ä»¶ä¸­ç»„æˆçš„ä¸€éƒ¨åˆ†ã€‚DTD æ˜¯ä¸€ç§ä¿è¯ XML æ–‡æ¡£æ ¼å¼æ­£ç¡®çš„æœ‰æ•ˆéªŒè¯æ–¹å¼ï¼Œå®ƒå®šä¹‰äº†ç›¸å…³ XML æ–‡æ¡£çš„å…ƒç´ ã€å±æ€§ã€æ’åˆ—æ–¹å¼ã€å…ƒç´ çš„å†…å®¹ç±»å‹ä»¥åŠå…ƒç´ çš„å±‚æ¬¡ç»“æ„ã€‚å…¶å® DTD å°±ç›¸å½“äº XML ä¸­çš„ â€œè¯æ±‡â€å’Œâ€œè¯­æ³•â€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”è¾ƒ XML æ–‡ä»¶å’Œ DTD æ–‡ä»¶ æ¥çœ‹æ–‡æ¡£æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œå…ƒç´ å’Œæ ‡ç­¾ä½¿ç”¨æ˜¯å¦æ­£ç¡®ã€‚ è¦åœ¨ Spring ä¸­ä½¿ç”¨ DTDï¼Œéœ€è¦åœ¨ Spring XML æ–‡ä»¶å¤´éƒ¨å£°æ˜ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE beans PUBLIC &quot;-//SPRING//DTD BEAN//EN&quot; &quot;http://www.springframework.org/dtd/spring-beans.dtd&quot;&gt; DTD åœ¨ä¸€å®šçš„é˜¶æ®µæ¨åŠ¨äº† XML çš„å‘å±•ï¼Œä½†æ˜¯å®ƒæœ¬èº«å­˜åœ¨ç€ä¸€äº›ç¼ºé™·ï¼š å®ƒæ²¡æœ‰ä½¿ç”¨ XML æ ¼å¼ï¼Œè€Œæ˜¯è‡ªå·±å®šä¹‰äº†ä¸€å¥—æ ¼å¼ï¼Œç›¸å¯¹è§£æå™¨çš„é‡ç”¨æ€§è¾ƒå·®ï¼›è€Œä¸” DTD çš„æ„å»ºå’Œè®¿é—®æ²¡æœ‰æ ‡å‡†çš„ç¼–ç¨‹æ¥å£ï¼Œå› è€Œè§£æå™¨å¾ˆéš¾ç®€å•çš„è§£æ DTD æ–‡æ¡£ã€‚ DTD å¯¹å…ƒç´ çš„ç±»å‹é™åˆ¶è¾ƒå°‘ï¼›åŒæ—¶å…¶ä»–çš„çº¦æŸåŠ›ä¹Ÿå«å¼±ã€‚ DTD æ‰©å±•èƒ½åŠ›è¾ƒå·®ã€‚ åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„ DTD æ–‡æ¡£çš„æè¿°èƒ½åŠ›æœ‰é™ã€‚ é’ˆå¯¹ DTD çš„ç¼ºé™·ï¼ŒW3C åœ¨ 2001 å¹´æ¨å‡º XSDã€‚XSDï¼ˆXML Schemas Definitionï¼‰å³ XML Schema è¯­è¨€ã€‚XML Schema æœ¬èº«å°±æ˜¯ä¸€ä¸ª XMLæ–‡æ¡£ï¼Œä½¿ç”¨çš„æ˜¯ XML è¯­æ³•ï¼Œå› æ­¤å¯ä»¥å¾ˆæ–¹ä¾¿çš„è§£æ XSD æ–‡æ¡£ã€‚ ç›¸å¯¹äº DTDï¼ŒXSD å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š XML SchemaåŸºäºXML,æ²¡æœ‰ä¸“é—¨çš„è¯­æ³• XML Schemaå¯ä»¥è±¡å…¶ä»–XMLæ–‡ä»¶ä¸€æ ·è§£æå’Œå¤„ç† XML Schemaæ¯”DTDæä¾›äº†æ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹. XML Schemaæä¾›å¯æ‰©å……çš„æ•°æ®æ¨¡å‹ã€‚ XML Schemaæ”¯æŒç»¼åˆå‘½åç©ºé—´ XML Schemaæ”¯æŒå±æ€§ç»„ã€‚ getValidationModeForResource() åˆ†æprotected int getValidationModeForResource(Resource resource) &#123; // è·å–æŒ‡å®šçš„éªŒè¯æ¨¡å¼ int validationModeToUse = getValidationMode(); // å¦‚æœæ‰‹åŠ¨æŒ‡å®šï¼Œåˆ™ç›´æ¥è¿”å› if (validationModeToUse != VALIDATION_AUTO) &#123; return validationModeToUse; &#125; // é€šè¿‡ç¨‹åºæ£€æµ‹ int detectedMode = detectValidationMode(resource); if (detectedMode != VALIDATION_AUTO) &#123; return detectedMode; &#125; // å‡ºç°å¼‚å¸¸ï¼Œè¿”å› XSD return VALIDATION_XSD;&#125; å¦‚æœæŒ‡å®šäº† XML æ–‡ä»¶çš„çš„éªŒè¯æ¨¡å¼ï¼ˆè°ƒç”¨XmlBeanDefinitionReader.setValidating(boolean validating)ï¼‰åˆ™ç›´æ¥è¿”å›æŒ‡å®šçš„éªŒè¯æ¨¡å¼ï¼Œå¦åˆ™è°ƒç”¨ detectValidationMode() è·å–ç›¸åº”çš„éªŒè¯æ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š protected int detectValidationMode(Resource resource) &#123; if (resource.isOpen()) &#123; throw new BeanDefinitionStoreException( &quot;Passed-in Resource [&quot; + resource + &quot;] contains an open stream: &quot; + &quot;cannot determine validation mode automatically. Either pass in a Resource &quot; + &quot;that is able to create fresh streams, or explicitly specify the validationMode &quot; + &quot;on your XmlBeanDefinitionReader instance.&quot;); &#125; InputStream inputStream; try &#123; inputStream = resource.getInputStream(); &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;Unable to determine validation mode for [&quot; + resource + &quot;]: cannot open InputStream. &quot; + &quot;Did you attempt to load directly from a SAX InputSource without specifying the &quot; + &quot;validationMode on your XmlBeanDefinitionReader instance?&quot;, ex); &#125; try &#123; // æ ¸å¿ƒæ–¹æ³• return this.validationModeDetector.detectValidationMode(inputStream); &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;Unable to determine validation mode for [&quot; + resource + &quot;]: an error occurred whilst reading from the InputStream.&quot;, ex); &#125;&#125; å‰é¢ä¸€å¤§å †çš„ä»£ç ï¼Œæ ¸å¿ƒåœ¨äº this.validationModeDetector.detectValidationMode(inputStream)ï¼ŒvalidationModeDetector å®šä¹‰ä¸º XmlValidationModeDetector,æ‰€ä»¥éªŒè¯æ¨¡å¼çš„è·å–å§”æ‰˜ç»™ XmlValidationModeDetector çš„ detectValidationMode() æ–¹æ³•ã€‚ public int detectValidationMode(InputStream inputStream) throws IOException &#123; BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream)); try &#123; boolean isDtdValidated = false; String content; // ä¸€è¡Œä¸€è¡Œè¯»å– xml æ–‡ä»¶çš„å†…å®¹ while ((content = reader.readLine()) != null) &#123; content = consumeCommentTokens(content); if (this.inComment || !StringUtils.hasText(content)) &#123; continue; &#125; // åŒ…å« DOCTYPE ä¸º DTD æ¨¡å¼ if (hasDoctype(content)) &#123; isDtdValidated = true; break; &#125; // è¯»å– &lt; å¼€å§‹ç¬¦å·ï¼ŒéªŒè¯æ¨¡å¼ä¸€å®šä¼šåœ¨ &lt; ç¬¦å·ä¹‹å‰ if (hasOpeningTag(content)) &#123; // End of meaningful data... break; &#125; &#125; // ä¸º true è¿”å› DTDï¼Œå¦åˆ™è¿”å› XSD return (isDtdValidated ? VALIDATION_DTD : VALIDATION_XSD); &#125; catch (CharConversionException ex) &#123; // å‡ºç°å¼‚å¸¸ï¼Œä¸º XSD return VALIDATION_AUTO; &#125; finally &#123; reader.close(); &#125;&#125; ä»ä»£ç ä¸­çœ‹ï¼Œä¸»è¦æ˜¯é€šè¿‡è¯»å– XML æ–‡ä»¶çš„å†…å®¹ï¼Œåˆ¤æ–­å†…å®¹ä¸­æ˜¯å¦åŒ…å«æœ‰ DOCTYPE ï¼Œå¦‚æœæ˜¯ åˆ™ä¸º DTDï¼Œå¦åˆ™ä¸º XSDï¼Œå½“ç„¶åªä¼šè¯»å–åˆ° ç¬¬ä¸€ä¸ª â€œ&lt;â€œ å¤„ï¼Œå› ä¸º éªŒè¯æ¨¡å¼ä¸€å®šä¼šåœ¨ç¬¬ä¸€ä¸ª â€œ&lt;â€ ä¹‹å‰ã€‚å¦‚æœå½“ä¸­å‡ºç°äº† CharConversionException å¼‚å¸¸ï¼Œåˆ™ä¸º XSDæ¨¡å¼ã€‚ å¥½äº†ï¼ŒXML æ–‡ä»¶çš„éªŒè¯æ¨¡å¼åˆ†æå®Œæ¯•ï¼Œä¸‹ç¯‡åˆ†æ doLoadBeanDefinitions() çš„ç¬¬äºŒä¸ªæ­¥éª¤ï¼šè·å– Document å®ä¾‹ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IoCä¹‹åŠ è½½BeanDefinition","date":"2020-01-02T23:14:45.000Z","path":"2020/01/03/a6d994a0.html","text":"æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2658 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE å¼€å±€å…ˆçœ‹ä¸€æ®µä»£ç ï¼š ClassPathResource resource = new ClassPathResource(&quot;bean.xml&quot;);DefaultListableBeanFactory factory = new DefaultListableBeanFactory();XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);reader.loadBeanDefinitions(resource); è¿™æ®µä»£ç æ˜¯ Spring ä¸­ç¼–ç¨‹å¼ä½¿ç”¨ IOC å®¹å™¨ï¼Œé€šè¿‡è¿™å››æ®µç®€å•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆæ­¥åˆ¤æ–­ IOC å®¹å™¨çš„ä½¿ç”¨è¿‡ç¨‹ã€‚ è·å–èµ„æº è·å– BeanFactory æ ¹æ®æ–°å»ºçš„ BeanFactory åˆ›å»ºä¸€ä¸ªBeanDefinitionReaderå¯¹è±¡ï¼Œè¯¥Reader å¯¹è±¡ä¸ºèµ„æºçš„è§£æå™¨ è£…è½½èµ„æº æ•´ä¸ªè¿‡ç¨‹å°±åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šèµ„æºå®šä½ã€è£…è½½ã€æ³¨å†Œï¼Œå¦‚ä¸‹ï¼š èµ„æºå®šä½ã€‚æˆ‘ä»¬ä¸€èˆ¬ç”¨å¤–éƒ¨èµ„æºæ¥æè¿° Bean å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– IOC å®¹å™¨çš„ç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦å®šä½è¿™ä¸ªå¤–éƒ¨èµ„æºã€‚åœ¨ï¼ˆ IOC ä¹‹ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥ï¼‰å·²ç»è¯¦ç»†è¯´æ˜äº†èµ„æºåŠ è½½çš„è¿‡ç¨‹ã€‚ è£…è½½ã€‚è£…è½½å°±æ˜¯ BeanDefinition çš„è½½å…¥ã€‚BeanDefinitionReader è¯»å–ã€è§£æ Resource èµ„æºï¼Œä¹Ÿå°±æ˜¯å°†ç”¨æˆ·å®šä¹‰çš„ Bean è¡¨ç¤ºæˆ IOC å®¹å™¨çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼šBeanDefinitionã€‚åœ¨ IOC å®¹å™¨å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª BeanDefinition Map çš„æ•°æ®ç»“æ„ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ª éƒ½å¯¹åº”ç€ä¸€ä¸ªBeanDefinitionå¯¹è±¡ã€‚ æ³¨å†Œã€‚å‘IOCå®¹å™¨æ³¨å†Œåœ¨ç¬¬äºŒæ­¥è§£æå¥½çš„ BeanDefinitionï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ BeanDefinitionRegistry æ¥å£æ¥å®ç°çš„ã€‚åœ¨ IOC å®¹å™¨å†…éƒ¨å…¶å®æ˜¯å°†ç¬¬äºŒä¸ªè¿‡ç¨‹è§£æå¾—åˆ°çš„ BeanDefinition æ³¨å…¥åˆ°ä¸€ä¸ª HashMap å®¹å™¨ä¸­ï¼ŒIOC å®¹å™¨å°±æ˜¯é€šè¿‡è¿™ä¸ª HashMap æ¥ç»´æŠ¤è¿™äº› BeanDefinition çš„ã€‚åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰å®Œæˆä¾èµ–æ³¨å…¥ï¼Œä¾èµ–æ³¨å†Œæ˜¯å‘ç”Ÿåœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨ getBean() å‘å®¹å™¨ç´¢è¦ Bean æ—¶ã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®é¢„å¤„ç†ï¼Œå³å¯¹æŸä¸ª Bean è®¾ç½® lazyinit å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª Bean çš„ä¾èµ–æ³¨å…¥å°±ä¼šåœ¨å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å®Œæˆã€‚ XML Resource =&gt; XML Document =&gt; Bean Definition ã€‚ èµ„æºå®šä½åœ¨å‰é¢å·²ç»åˆ†æäº†ï¼Œä¸‹é¢æˆ‘ä»¬ç›´æ¥åˆ†æåŠ è½½ï¼Œä¸Šé¢æè¿‡reader.loadBeanDefinitions(resource) æ‰æ˜¯åŠ è½½èµ„æºçš„çœŸæ­£å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä»è¯¥æ–¹æ³•å…¥æ‰‹ã€‚ public int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException &#123; return loadBeanDefinitions(new EncodedResource(resource));&#125; ä»æŒ‡å®šçš„ xml æ–‡ä»¶åŠ è½½ BeanDefinitionï¼Œè¿™é‡Œä¼šå…ˆå¯¹ Resource èµ„æºå°è£…æˆ EncodedResourceã€‚è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦å°† Resource å°è£…æˆ EncodedResourceå‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†å¯¹ Resource è¿›è¡Œç¼–ç ï¼Œä¿è¯å†…å®¹è¯»å–çš„æ­£ç¡®æ€§ã€‚å°è£…æˆ EncodedResource åï¼Œè°ƒç”¨loadBeanDefinitions()ï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„é€»è¾‘å®ç°ã€‚å¦‚ä¸‹ï¼š public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123; Assert.notNull(encodedResource, &quot;EncodedResource must not be null&quot;); if (logger.isInfoEnabled()) &#123; logger.info(&quot;Loading XML bean definitions from &quot; + encodedResource.getResource()); &#125; // è·å–å·²ç»åŠ è½½è¿‡çš„èµ„æº Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get(); if (currentResources == null) &#123; currentResources = new HashSet&lt;&gt;(4); this.resourcesCurrentlyBeingLoaded.set(currentResources); &#125; // å°†å½“å‰èµ„æºåŠ å…¥è®°å½•ä¸­ if (!currentResources.add(encodedResource)) &#123; throw new BeanDefinitionStoreException( &quot;Detected cyclic loading of &quot; + encodedResource + &quot; - check your import definitions!&quot;); &#125; try &#123; // ä» EncodedResource è·å–å°è£…çš„ Resource å¹¶ä» Resource ä¸­è·å–å…¶ä¸­çš„ InputStream InputStream inputStream = encodedResource.getResource().getInputStream(); try &#123; InputSource inputSource = new InputSource(inputStream); // è®¾ç½®ç¼–ç  if (encodedResource.getEncoding() != null) &#123; inputSource.setEncoding(encodedResource.getEncoding()); &#125; // æ ¸å¿ƒé€»è¾‘éƒ¨åˆ† return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); &#125; finally &#123; inputStream.close(); &#125; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( &quot;IOException parsing XML document from &quot; + encodedResource.getResource(), ex); &#125; finally &#123; // ä»ç¼“å­˜ä¸­å‰”é™¤è¯¥èµ„æº currentResources.remove(encodedResource); if (currentResources.isEmpty()) &#123; this.resourcesCurrentlyBeingLoaded.remove(); &#125; &#125;&#125; é¦–å…ˆé€šè¿‡ resourcesCurrentlyBeingLoaded.get() æ¥è·å–å·²ç»åŠ è½½è¿‡çš„èµ„æºï¼Œç„¶åå°† encodedResource åŠ å…¥å…¶ä¸­ï¼Œå¦‚æœ resourcesCurrentlyBeingLoaded ä¸­å·²ç»å­˜åœ¨è¯¥èµ„æºï¼Œåˆ™æŠ›å‡º BeanDefinitionStoreException å¼‚å¸¸ã€‚å®Œæˆåä» encodedResource è·å–å°è£…çš„ Resource èµ„æºå¹¶ä» Resource ä¸­è·å–ç›¸åº”çš„ InputStream ï¼Œæœ€åå°† InputStream å°è£…ä¸º InputSource è°ƒç”¨ doLoadBeanDefinitions()ã€‚ æ–¹æ³• doLoadBeanDefinitions() ä¸ºä» xml æ–‡ä»¶ä¸­åŠ è½½ BeanDefinition çš„çœŸæ­£é€»è¾‘ï¼Œå¦‚ä¸‹: protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException &#123; try &#123; // è·å– Document å®ä¾‹ Document doc = doLoadDocument(inputSource, resource); // æ ¹æ® Document å®ä¾‹****æ³¨å†Œ Beanä¿¡æ¯ return registerBeanDefinitions(doc, resource); &#125; catch (BeanDefinitionStoreException ex) &#123; throw ex; &#125; catch (SAXParseException ex) &#123; throw new XmlBeanDefinitionStoreException(resource.getDescription(), &quot;Line &quot; + ex.getLineNumber() + &quot; in XML document from &quot; + resource + &quot; is invalid&quot;, ex); &#125; catch (SAXException ex) &#123; throw new XmlBeanDefinitionStoreException(resource.getDescription(), &quot;XML document from &quot; + resource + &quot; is invalid&quot;, ex); &#125; catch (ParserConfigurationException ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), &quot;Parser configuration exception parsing XML from &quot; + resource, ex); &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), &quot;IOException parsing XML document from &quot; + resource, ex); &#125; catch (Throwable ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), &quot;Unexpected exception parsing XML document from &quot; + resource, ex); &#125;&#125; æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯ try å—çš„ä¸¤è¡Œä»£ç ã€‚ è°ƒç”¨ doLoadDocument() æ–¹æ³•ï¼Œæ ¹æ® xml æ–‡ä»¶è·å– Document å®ä¾‹ã€‚ æ ¹æ®è·å–çš„ Document å®ä¾‹æ³¨å†Œ Bean ä¿¡æ¯ã€‚ å…¶å®åœ¨ doLoadDocument()æ–¹æ³•å†…éƒ¨è¿˜è·å–äº† xml æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ã€‚å¦‚ä¸‹: protected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception &#123; return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler, getValidationModeForResource(resource), isNamespaceAware());&#125; è°ƒç”¨getValidationModeForResource() è·å–æŒ‡å®šèµ„æºï¼ˆxmlï¼‰çš„éªŒè¯æ¨¡å¼ã€‚ æ‰€ä»¥ doLoadBeanDefinitions()ä¸»è¦å°±æ˜¯åšäº†ä¸‰ä»¶äº‹æƒ…ã€‚ è°ƒç”¨ getValidationModeForResource() è·å– xml æ–‡ä»¶çš„éªŒè¯æ¨¡å¼ è°ƒç”¨ loadDocument() æ ¹æ® xml æ–‡ä»¶è·å–ç›¸åº”çš„ Document å®ä¾‹ã€‚ è°ƒç”¨ registerBeanDefinitions() æ³¨å†Œ Bean å®ä¾‹ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹Springç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥","date":"2020-01-02T14:30:27.000Z","path":"2020/01/02/8f7aa5ac.html","text":"æ‘˜è¦ æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2656 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE èµ„æºåŠ è½½ç­–ç•¥éœ€è¦æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š èŒèƒ½åˆ’åˆ†æ¸…æ¥šã€‚èµ„æºçš„å®šä¹‰å’Œèµ„æºçš„åŠ è½½åº”è¯¥è¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç•Œé™ï¼› ç»Ÿä¸€çš„æŠ½è±¡ã€‚ç»Ÿä¸€çš„èµ„æºå®šä¹‰å’Œèµ„æºåŠ è½½ç­–ç•¥ã€‚èµ„æºåŠ è½½åè¦è¿”å›ç»Ÿä¸€çš„æŠ½è±¡ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦å¯¹èµ„æºè¿›è¡Œæ€æ ·çš„å¤„ç†ï¼Œåº”è¯¥ç”±æŠ½è±¡èµ„æºæ¥å£æ¥ç•Œå®šã€‚ ç»Ÿä¸€èµ„æºï¼šResourceorg.springframework.core.io.Resource ä¸º Spring æ¡†æ¶æ‰€æœ‰èµ„æºçš„æŠ½è±¡å’Œè®¿é—®æ¥å£ï¼Œå®ƒç»§æ‰¿ org.springframework.core.io.InputStreamSourceæ¥å£ã€‚ä½œä¸ºæ‰€æœ‰èµ„æºçš„ç»Ÿä¸€æŠ½è±¡ï¼ŒSource å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œç”±å­ç±» AbstractResource æä¾›ç»Ÿä¸€çš„é»˜è®¤å®ç°ã€‚å®šä¹‰å¦‚ä¸‹ï¼š public interface Resource extends InputStreamSource &#123; /** * èµ„æºæ˜¯å¦å­˜åœ¨ */ boolean exists(); /** * èµ„æºæ˜¯å¦å¯è¯» */ default boolean isReadable() &#123; return true; &#125; /** * èµ„æºæ‰€ä»£è¡¨çš„å¥æŸ„æ˜¯å¦è¢«ä¸€ä¸ªstreamæ‰“å¼€äº† */ default boolean isOpen() &#123; return false; &#125; /** * æ˜¯å¦ä¸º File */ default boolean isFile() &#123; return false; &#125; /** * è¿”å›èµ„æºçš„URLçš„å¥æŸ„ */ URL getURL() throws IOException; /** * è¿”å›èµ„æºçš„URIçš„å¥æŸ„ */ URI getURI() throws IOException; /** * è¿”å›èµ„æºçš„Fileçš„å¥æŸ„ */ File getFile() throws IOException; /** * è¿”å› ReadableByteChannel */ default ReadableByteChannel readableChannel() throws IOException &#123; return Channels.newChannel(getInputStream()); &#125; /** * èµ„æºå†…å®¹çš„é•¿åº¦ */ long contentLength() throws IOException; /** * èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´ */ long lastModified() throws IOException; /** * æ ¹æ®èµ„æºçš„ç›¸å¯¹è·¯å¾„åˆ›å»ºæ–°èµ„æº */ Resource createRelative(String relativePath) throws IOException; /** * èµ„æºçš„æ–‡ä»¶å */ @Nullable String getFilename(); /** * èµ„æºçš„æè¿° */ String getDescription();&#125; ç±»ç»“æ„å›¾å¦‚ä¸‹ï¼š ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒResource æ ¹æ®èµ„æºçš„ä¸åŒç±»å‹æä¾›ä¸åŒçš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹ï¼š FileSystemResourceï¼šå¯¹ java.io.File ç±»å‹èµ„æºçš„å°è£…ï¼Œåªè¦æ˜¯è·Ÿ File æ‰“äº¤é“çš„ï¼ŒåŸºæœ¬ä¸Šä¸ FileSystemResource ä¹Ÿå¯ä»¥æ‰“äº¤é“ã€‚æ”¯æŒæ–‡ä»¶å’Œ URL çš„å½¢å¼ï¼Œå®ç° WritableResource æ¥å£ï¼Œä¸”ä» Spring Framework 5.0 å¼€å§‹ï¼ŒFileSystemResource ä½¿ç”¨NIO.2 APIè¿›è¡Œè¯»/å†™äº¤äº’ ByteArrayResourceï¼šå¯¹å­—èŠ‚æ•°ç»„æä¾›çš„æ•°æ®çš„å°è£…ã€‚å¦‚æœé€šè¿‡ InputStream å½¢å¼è®¿é—®è¯¥ç±»å‹çš„èµ„æºï¼Œè¯¥å®ç°ä¼šæ ¹æ®å­—èŠ‚æ•°ç»„çš„æ•°æ®æ„é€ ä¸€ä¸ªç›¸åº”çš„ ByteArrayInputStreamã€‚ UrlResourceï¼šå¯¹ java.net.URLç±»å‹èµ„æºçš„å°è£…ã€‚å†…éƒ¨å§”æ´¾ URL è¿›è¡Œå…·ä½“çš„èµ„æºæ“ä½œã€‚ ClassPathResourceï¼šclass path ç±»å‹èµ„æºçš„å®ç°ã€‚ä½¿ç”¨ç»™å®šçš„ ClassLoader æˆ–è€…ç»™å®šçš„ Class æ¥åŠ è½½èµ„æºã€‚ InputStreamResourceï¼šå°†ç»™å®šçš„ InputStream ä½œä¸ºä¸€ç§èµ„æºçš„ Resource çš„å®ç°ç±»ã€‚ AbstractResource ä¸º Resource æ¥å£çš„é»˜è®¤å®ç°ï¼Œå®ƒå®ç°äº† Resource æ¥å£çš„å¤§éƒ¨åˆ†çš„å…¬å…±å®ç°ï¼Œä½œä¸º Resource æ¥å£ä¸­çš„é‡ä¸­ä¹‹é‡ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š public abstract class AbstractResource implements Resource &#123; /** * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè‹¥åˆ¤æ–­è¿‡ç¨‹äº§ç”Ÿå¼‚å¸¸ï¼ˆå› ä¸ºä¼šè°ƒç”¨SecurityManageræ¥åˆ¤æ–­ï¼‰ï¼Œå°±å…³é—­å¯¹åº”çš„æµ */ @Override public boolean exists() &#123; try &#123; return getFile().exists(); &#125; catch (IOException ex) &#123; // Fall back to stream existence: can we open the stream? try &#123; InputStream is = getInputStream(); is.close(); return true; &#125; catch (Throwable isEx) &#123; return false; &#125; &#125; &#125; /** * ç›´æ¥è¿”å›trueï¼Œè¡¨ç¤ºå¯è¯» */ @Override public boolean isReadable() &#123; return true; &#125; /** * ç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªè¢«æ‰“å¼€ */ @Override public boolean isOpen() &#123; return false; &#125; /** * ç›´æ¥è¿”å›falseï¼Œè¡¨ç¤ºä¸ä¸º File */ @Override public boolean isFile() &#123; return false; &#125; /** * æŠ›å‡º FileNotFoundException å¼‚å¸¸ï¼Œäº¤ç»™å­ç±»å®ç° */ @Override public URL getURL() throws IOException &#123; throw new FileNotFoundException(getDescription() + &quot; cannot be resolved to URL&quot;); &#125; /** * åŸºäº getURL() è¿”å›çš„ URL æ„å»º URI */ @Override public URI getURI() throws IOException &#123; URL url = getURL(); try &#123; return ResourceUtils.toURI(url); &#125; catch (URISyntaxException ex) &#123; throw new NestedIOException(&quot;Invalid URI [&quot; + url + &quot;]&quot;, ex); &#125; &#125; /** * æŠ›å‡º FileNotFoundException å¼‚å¸¸ï¼Œäº¤ç»™å­ç±»å®ç° */ @Override public File getFile() throws IOException &#123; throw new FileNotFoundException(getDescription() + &quot; cannot be resolved to absolute file path&quot;); &#125; /** * æ ¹æ® getInputStream() çš„è¿”å›ç»“æœæ„å»º ReadableByteChannel */ @Override public ReadableByteChannel readableChannel() throws IOException &#123; return Channels.newChannel(getInputStream()); &#125; /** * è·å–èµ„æºçš„é•¿åº¦ * * è¿™ä¸ªèµ„æºå†…å®¹é•¿åº¦å®é™…å°±æ˜¯èµ„æºçš„å­—èŠ‚é•¿åº¦ï¼Œé€šè¿‡å…¨éƒ¨è¯»å–ä¸€éæ¥åˆ¤æ–­ */ @Override public long contentLength() throws IOException &#123; InputStream is = getInputStream(); try &#123; long size = 0; byte[] buf = new byte[255]; int read; while ((read = is.read(buf)) != -1) &#123; size += read; &#125; return size; &#125; finally &#123; try &#123; is.close(); &#125; catch (IOException ex) &#123; &#125; &#125; &#125; /** * è¿”å›èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´ */ @Override public long lastModified() throws IOException &#123; long lastModified = getFileForLastModifiedCheck().lastModified(); if (lastModified == 0L) &#123; throw new FileNotFoundException( getDescription() + &quot; cannot be resolved in the file system for resolving its last-modified timestamp&quot;); &#125; return lastModified; &#125; protected File getFileForLastModifiedCheck() throws IOException &#123; return getFile(); &#125; /** * äº¤ç»™å­ç±»å®ç° */ @Override public Resource createRelative(String relativePath) throws IOException &#123; throw new FileNotFoundException( &quot;Cannot create a relative resource for &quot; + getDescription()); &#125; /** * è·å–èµ„æºåç§°ï¼Œé»˜è®¤è¿”å› null */ @Override @Nullable public String getFilename() &#123; return null; &#125; /** * è¿”å›èµ„æºçš„æè¿° */ @Override public String toString() &#123; return getDescription(); &#125; @Override public boolean equals(Object obj) &#123; return (obj == this || (obj instanceof Resource &amp;&amp; ((Resource) obj) .getDescription().equals(getDescription()))); &#125; @Override public int hashCode() &#123; return getDescription().hashCode(); &#125;&#125; å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°è‡ªå®šä¹‰çš„ Resourceï¼Œè®°ä½ä¸è¦å®ç° Resource æ¥å£ï¼Œè€Œåº”è¯¥ç»§æ‰¿ AbstractResource æŠ½è±¡ç±»ï¼Œç„¶åæ ¹æ®å½“å‰çš„å…·ä½“èµ„æºç‰¹æ€§è¦†ç›–ç›¸åº”çš„æ–¹æ³•å³å¯ã€‚ ç»Ÿä¸€èµ„æºå®šä½(ResourceLoader)ä¸€å¼€å§‹å°±è¯´äº† Spring å°†èµ„æºçš„å®šä¹‰å’Œèµ„æºçš„åŠ è½½åŒºåˆ†å¼€äº†ï¼ŒResource å®šä¹‰äº†ç»Ÿä¸€çš„èµ„æºï¼Œé‚£èµ„æºçš„åŠ è½½åˆ™ç”± ResourceLoader æ¥ç»Ÿä¸€å®šä¹‰ã€‚ org.springframework.core.io.ResourceLoader ä¸º Spring èµ„æºåŠ è½½çš„ç»Ÿä¸€æŠ½è±¡ï¼Œå…·ä½“çš„èµ„æºåŠ è½½åˆ™ç”±ç›¸åº”çš„å®ç°ç±»æ¥å®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°† ResourceLoader ç§°ä½œä¸ºç»Ÿä¸€èµ„æºå®šä½å™¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š public interface ResourceLoader &#123; String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX; Resource getResource(String location); ClassLoader getClassLoader();&#125; ResourceLoader æ¥å£æä¾›ä¸¤ä¸ªæ–¹æ³•ï¼šgetResource()ã€getClassLoader()ã€‚ getResource()æ ¹æ®æ‰€æä¾›èµ„æºçš„è·¯å¾„ location è¿”å› Resource å®ä¾‹ï¼Œä½†æ˜¯å®ƒä¸ç¡®ä¿è¯¥ Resource ä¸€å®šå­˜åœ¨ï¼Œéœ€è¦è°ƒç”¨ Resource.exist()æ–¹æ³•åˆ¤æ–­ã€‚è¯¥æ–¹æ³•æ”¯æŒä»¥ä¸‹æ¨¡å¼çš„èµ„æºåŠ è½½ï¼š URLä½ç½®èµ„æºï¼Œå¦‚â€file:C:/test.datâ€ ClassPathä½ç½®èµ„æºï¼Œå¦‚â€classpath:test.datâ€ ç›¸å¯¹è·¯å¾„èµ„æºï¼Œå¦‚â€WEB-INF/test.datâ€ï¼Œæ­¤æ—¶è¿”å›çš„Resourceå®ä¾‹æ ¹æ®å®ç°ä¸åŒè€Œä¸åŒ è¯¥æ–¹æ³•çš„ä¸»è¦å®ç°æ˜¯åœ¨å…¶å­ç±» DefaultResourceLoader ä¸­å®ç°ï¼Œå…·ä½“è¿‡ç¨‹æˆ‘ä»¬åœ¨åˆ†æ DefaultResourceLoader æ—¶åšè¯¦ç»†è¯´æ˜ã€‚ getClassLoader() è¿”å› ClassLoader å®ä¾‹ï¼Œå¯¹äºæƒ³è¦è·å– ResourceLoader ä½¿ç”¨çš„ ClassLoader ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•æ¥è·å–ï¼Œ åœ¨åˆ†æ Resource æ—¶ï¼Œæåˆ°äº†ä¸€ä¸ªç±» ClassPathResource ï¼Œè¿™ä¸ªç±»æ˜¯å¯ä»¥æ ¹æ®æŒ‡å®šçš„ ClassLoader æ¥åŠ è½½èµ„æºçš„ã€‚ ä½œä¸º Spring ç»Ÿä¸€çš„èµ„æºåŠ è½½å™¨ï¼Œå®ƒæä¾›äº†ç»Ÿä¸€çš„æŠ½è±¡ï¼Œå…·ä½“çš„å®ç°åˆ™ç”±ç›¸åº”çš„å­ç±»æ¥è´Ÿè´£å®ç°ï¼Œå…¶ç±»çš„ç±»ç»“æ„å›¾å¦‚ä¸‹ï¼š DefaultResourceLoaderDefaultResourceLoader æ˜¯ ResourceLoader çš„é»˜è®¤å®ç°ï¼Œå®ƒæ¥æ”¶ ClassLoader ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°æˆ–è€…ä½¿ç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œåœ¨ä½¿ç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°æ—¶ï¼Œä½¿ç”¨çš„ ClassLoader ä¸ºé»˜è®¤çš„ ClassLoaderï¼ˆä¸€èˆ¬ä¸ºThread.currentThread().getContextClassLoader()ï¼‰ï¼Œå¯ä»¥é€šè¿‡ ClassUtils.getDefaultClassLoader()è·å–ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è°ƒç”¨ setClassLoader()æ–¹æ³•è¿›è¡Œåç»­è®¾ç½®ã€‚å¦‚ä¸‹ï¼š public DefaultResourceLoader() &#123; this.classLoader = ClassUtils.getDefaultClassLoader();&#125;public DefaultResourceLoader(@Nullable ClassLoader classLoader) &#123; this.classLoader = classLoader;&#125;public void setClassLoader(@Nullable ClassLoader classLoader) &#123; this.classLoader = classLoader;&#125;@Override@Nullablepublic ClassLoader getClassLoader() &#123; return (this.classLoader != null ? this.classLoader : ClassUtils.getDefaultClassLoader());&#125; ResourceLoader ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ä¸º getResource(),å®ƒæ ¹æ®æä¾›çš„ location è¿”å›ç›¸åº”çš„ Resourceï¼Œè€Œ DefaultResourceLoader å¯¹è¯¥æ–¹æ³•æä¾›äº†æ ¸å¿ƒå®ç°(å®ƒçš„ä¸¤ä¸ªå­ç±»éƒ½æ²¡æœ‰æä¾›è¦†ç›–è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®šResourceLoader çš„èµ„æºåŠ è½½ç­–ç•¥å°±å°è£… DefaultResourceLoaderä¸­)ï¼Œå¦‚ä¸‹ï¼š public Resource getResource(String location) &#123; Assert.notNull(location, &quot;Location must not be null&quot;); for (ProtocolResolver protocolResolver : this.protocolResolvers) &#123; Resource resource = protocolResolver.resolve(location, this); if (resource != null) &#123; return resource; &#125; &#125; if (location.startsWith(&quot;/&quot;)) &#123; return getResourceByPath(location); &#125; else if (location.startsWith(CLASSPATH_URL_PREFIX)) &#123; return new ClassPathResource(location.substring( CLASSPATH_URL_PREFIX.length()), getClassLoader()); &#125; else &#123; try &#123; // Try to parse the location as a URL... URL url = new URL(location); return (ResourceUtils.isFileURL(url) ? new FileUrlResource(url) : new UrlResource(url)); &#125; catch (MalformedURLException ex) &#123; // No URL -&gt; resolve as resource path. return getResourceByPath(location); &#125; &#125;&#125; é¦–å…ˆé€šè¿‡ ProtocolResolver æ¥åŠ è½½èµ„æºï¼ŒæˆåŠŸè¿”å› Resourceï¼Œå¦åˆ™è°ƒç”¨å¦‚ä¸‹é€»è¾‘ï¼š è‹¥ location ä»¥ / å¼€å¤´ï¼Œåˆ™è°ƒç”¨ getResourceByPath()æ„é€  ClassPathContextResource ç±»å‹èµ„æºå¹¶è¿”å›ã€‚ è‹¥ location ä»¥ classpath: å¼€å¤´ï¼Œåˆ™æ„é€  ClassPathResource ç±»å‹èµ„æºå¹¶è¿”å›ï¼Œåœ¨æ„é€ è¯¥èµ„æºæ—¶ï¼Œé€šè¿‡ getClassLoader()è·å–å½“å‰çš„ ClassLoaderã€‚ æ„é€  URL ï¼Œå°è¯•é€šè¿‡å®ƒè¿›è¡Œèµ„æºå®šä½ï¼Œè‹¥æ²¡æœ‰æŠ›å‡º MalformedURLException å¼‚å¸¸ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ä¸º FileURL , å¦‚æœæ˜¯åˆ™æ„é€  FileUrlResource ç±»å‹èµ„æºï¼Œå¦åˆ™æ„é€  UrlResourceã€‚è‹¥åœ¨åŠ è½½è¿‡ç¨‹ä¸­æŠ›å‡º MalformedURLException å¼‚å¸¸ï¼Œåˆ™å§”æ´¾ getResourceByPath() å®ç°èµ„æºå®šä½åŠ è½½ã€‚ ProtocolResolver ï¼Œç”¨æˆ·è‡ªå®šä¹‰åè®®èµ„æºè§£å†³ç­–ç•¥ï¼Œä½œä¸º DefaultResourceLoader çš„ SPIï¼Œå®ƒå…è®¸ç”¨æˆ·è‡ªå®šä¹‰èµ„æºåŠ è½½åè®®ï¼Œè€Œä¸éœ€è¦ç»§æ‰¿ ResourceLoader çš„å­ç±»ã€‚åœ¨ä»‹ç» Resource æ—¶ï¼Œæåˆ°å¦‚æœè¦å®ç°è‡ªå®šä¹‰ Resourceï¼Œæˆ‘ä»¬åªéœ€è¦ç»§æ‰¿ DefaultResource å³å¯ï¼Œä½†æ˜¯æœ‰äº† ProtocolResolver åï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç»§æ‰¿ DefaultResourceLoaderï¼Œæ”¹ä¸ºå®ç° ProtocolResolver æ¥å£ä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ ResourceLoaderã€‚ ProtocolResolver æ¥å£ï¼Œä»…æœ‰ä¸€ä¸ªæ–¹æ³• Resource resolve(String location, ResourceLoader resourceLoader)ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šèµ„æºè·¯å¾„locationï¼ŒæŒ‡å®šçš„åŠ è½½å™¨ ResourceLoaderï¼Œè¿”å›ä¸ºç›¸åº”çš„ Resource ã€‚åœ¨ Spring ä¸­ä½ ä¼šå‘ç°è¯¥æ¥å£å¹¶æ²¡æœ‰å®ç°ç±»ï¼Œå®ƒéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œè‡ªå®šä¹‰çš„ Resolver å¦‚ä½•åŠ å…¥ Spring ä½“ç³»å‘¢ï¼Ÿè°ƒç”¨ DefaultResourceLoader.addProtocolResolver() å³å¯ï¼Œå¦‚ä¸‹ï¼š public void addProtocolResolver(ProtocolResolver resolver) &#123; Assert.notNull(resolver, &quot;ProtocolResolver must not be null&quot;); this.protocolResolvers.add(resolver);&#125; ä¸‹é¢ç¤ºä¾‹æ˜¯æ¼”ç¤º DefaultResourceLoader åŠ è½½èµ„æºçš„å…·ä½“ç­–ç•¥ï¼Œä»£ç å¦‚ä¸‹ï¼ˆè¯¥ç¤ºä¾‹å‚è€ƒã€ŠSpring è§£å¯†ã€‹ P89ï¼‰ï¼š ResourceLoader resourceLoader = new DefaultResourceLoader();Resource fileResource1 = resourceLoader.getResource(&quot;D:/Users/chenming673/Documents/spark.txt&quot;);System.out.println(&quot;fileResource1 is FileSystemResource:&quot; + (fileResource1 instanceof FileSystemResource));Resource fileResource2 = resourceLoader.getResource(&quot;/Users/chenming673/Documents/spark.txt&quot;);System.out.println(&quot;fileResource2 is ClassPathResource:&quot; + (fileResource2 instanceof ClassPathResource));Resource urlResource1 = resourceLoader.getResource(&quot;file:/Users/chenming673/Documents/spark.txt&quot;);System.out.println(&quot;urlResource1 is UrlResource:&quot; + (urlResource1 instanceof UrlResource));Resource urlResource2 = resourceLoader.getResource(&quot;http://www.baidu.com&quot;);System.out.println(&quot;urlResource1 is urlResource:&quot; + (urlResource2 instanceof UrlResource)); è¿è¡Œç»“æœï¼š fileResource1 is FileSystemResource:falsefileResource2 is ClassPathResource:trueurlResource1 is UrlResource:trueurlResource1 is urlResource:true å…¶å®å¯¹äº fileResource1 æˆ‘ä»¬æ›´åŠ å¸Œæœ›æ˜¯ FileSystemResource èµ„æºç±»å‹ï¼Œä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œå®ƒæ˜¯ ClassPathResource ç±»å‹ã€‚åœ¨getResource()èµ„æºåŠ è½½ç­–ç•¥ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ D:/Users/chenming673/Documents/spark.txtèµ„æºå…¶å®åœ¨è¯¥æ–¹æ³•ä¸­æ²¡æœ‰ç›¸åº”çš„èµ„æºç±»å‹ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåœ¨æŠ›å‡º MalformedURLException å¼‚å¸¸æ—¶é€šè¿‡ getResourceByPath() æ„é€ ä¸€ä¸ª ClassPathResource ç±»å‹çš„èµ„æºã€‚è€ŒæŒ‡å®šæœ‰åè®®å‰ç¼€çš„èµ„æºè·¯å¾„ï¼Œåˆ™é€šè¿‡ URL å°±å¯ä»¥å®šä¹‰ï¼Œæ‰€ä»¥è¿”å›çš„éƒ½æ˜¯UrlResourceç±»å‹ã€‚ FileSystemResourceLoaderä»ä¸Šé¢çš„ç¤ºä¾‹æˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å® DefaultResourceLoader å¯¹getResourceByPath(String)æ–¹æ³•å¤„ç†å…¶å®ä¸æ˜¯å¾ˆæ°å½“ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ FileSystemResourceLoader ï¼Œå®ƒç»§æ‰¿ DefaultResourceLoader ä¸”è¦†å†™äº† getResourceByPath(String)ï¼Œä½¿ä¹‹ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºå¹¶ä»¥ FileSystemResource ç±»å‹è¿”å›ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æƒ³è¦çš„èµ„æºç±»å‹ï¼Œå¦‚ä¸‹ï¼š @Overrideprotected Resource getResourceByPath(String path) &#123; if (path.startsWith(&quot;/&quot;)) &#123; path = path.substring(1); &#125; return new FileSystemContextResource(path);&#125; FileSystemContextResource ä¸º FileSystemResourceLoader çš„å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿ FileSystemResourceã€‚ private static class FileSystemContextResource extends FileSystemResource implements ContextResource &#123; public FileSystemContextResource(String path) &#123; super(path); &#125; @Override public String getPathWithinContext() &#123; return getPath(); &#125;&#125; åœ¨æ„é€ å™¨ä¸­ä¹Ÿæ˜¯è°ƒç”¨ FileSystemResource çš„æ„é€ æ–¹æ³•æ¥æ„é€  FileSystemContextResource çš„ã€‚ å¦‚æœå°†ä¸Šé¢çš„ç¤ºä¾‹å°† DefaultResourceLoader æ”¹ä¸º FileSystemContextResource ï¼Œåˆ™ fileResource1 åˆ™ä¸º FileSystemResourceã€‚ ResourcePatternResolverResourceLoader çš„ Resource getResource(String location) æ¯æ¬¡åªèƒ½æ ¹æ® location è¿”å›ä¸€ä¸ª Resourceï¼Œå½“éœ€è¦åŠ è½½å¤šä¸ªèµ„æºæ—¶ï¼Œæˆ‘ä»¬é™¤äº†å¤šæ¬¡è°ƒç”¨ getResource() å¤–åˆ«æ— ä»–æ³•ã€‚ResourcePatternResolver æ˜¯ ResourceLoader çš„æ‰©å±•ï¼Œå®ƒæ”¯æŒæ ¹æ®æŒ‡å®šçš„èµ„æºè·¯å¾„åŒ¹é…æ¨¡å¼æ¯æ¬¡è¿”å›å¤šä¸ª Resource å®ä¾‹ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š public interface ResourcePatternResolver extends ResourceLoader &#123; String CLASSPATH_ALL_URL_PREFIX = &quot;classpath*:&quot;; Resource[] getResources(String locationPattern) throws IOException;&#125; ResourcePatternResolver åœ¨ ResourceLoader çš„åŸºç¡€ä¸Šå¢åŠ äº† getResources(String locationPattern)ï¼Œä»¥æ”¯æŒæ ¹æ®è·¯å¾„åŒ¹é…æ¨¡å¼è¿”å›å¤šä¸ª Resource å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿæ–°å¢äº†ä¸€ç§æ–°çš„åè®®å‰ç¼€ classpath*:ï¼Œè¯¥åè®®å‰ç¼€ç”±å…¶å­ç±»è´Ÿè´£å®ç°ã€‚ PathMatchingResourcePatternResolver ä¸º ResourcePatternResolver æœ€å¸¸ç”¨çš„å­ç±»ï¼Œå®ƒé™¤äº†æ”¯æŒ ResourceLoader å’Œ ResourcePatternResolver æ–°å¢çš„ classpath:* å‰ç¼€å¤–ï¼Œè¿˜æ”¯æŒ Ant é£æ ¼çš„è·¯å¾„åŒ¹é…æ¨¡å¼ï¼ˆç±»ä¼¼äº **/*.xmlï¼‰ã€‚ PathMatchingResourcePatternResolver æä¾›äº†ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š public PathMatchingResourcePatternResolver() &#123; this.resourceLoader = new DefaultResourceLoader();&#125;public PathMatchingResourcePatternResolver(ResourceLoader resourceLoader) &#123; Assert.notNull(resourceLoader, &quot;ResourceLoader must not be null&quot;); this.resourceLoader = resourceLoader;&#125;public PathMatchingResourcePatternResolver(@Nullable ClassLoader classLoader) &#123; this.resourceLoader = new DefaultResourceLoader(classLoader);&#125; PathMatchingResourcePatternResolver åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª ResourceLoaderï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯ï¼Œå®ƒä¼šåœ¨å†…éƒ¨æ„é€ ä¸€ä¸ª DefaultResourceLoaderã€‚ Resource getResource(String location)@Overridepublic Resource getResource(String location) &#123; return getResourceLoader().getResource(location);&#125; getResource() æ–¹æ³•ç›´æ¥å§”æ‰˜ç»™ç›¸åº”çš„ ResourceLoader æ¥å®ç°ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åœ¨å®ä¾‹åŒ–çš„ PathMatchingResourcePatternResolver çš„æ—¶å€™ï¼Œå¦‚æœä¸çŸ¥é“ ResourceLoader ï¼Œé‚£ä¹ˆåœ¨åŠ è½½èµ„æºæ—¶ï¼Œå…¶å®å°±æ˜¯ DefaultResourceLoader çš„è¿‡ç¨‹ã€‚å…¶å®åœ¨ä¸‹é¢ä»‹ç»çš„ Resource[] getResources(String locationPattern) ä¹Ÿç›¸åŒï¼Œåªä¸è¿‡è¿”å›çš„èµ„æºæ—¶å¤šä¸ªè€Œå·²ã€‚ Resource[] getResources(String locationPattern)public Resource[] getResources(String locationPattern) throws IOException &#123; Assert.notNull(locationPattern, &quot;Location pattern must not be null&quot;); // ä»¥ classpath*: å¼€å¤´ if (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123; // è·¯å¾„åŒ…å«é€šé…ç¬¦ if (getPathMatcher() .isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123; return findPathMatchingResources(locationPattern); &#125; else &#123; // è·¯å¾„ä¸åŒ…å«é€šé…ç¬¦ return findAllClassPathResources( locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length())); &#125; &#125; else &#123; int prefixEnd = ( locationPattern.startsWith(&quot;war:&quot;) ? locationPattern.indexOf(&quot;*/&quot;) + 1 : locationPattern.indexOf(&#x27;:&#x27;) + 1); // è·¯å¾„åŒ…å«é€šé…ç¬¦ if (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123; return findPathMatchingResources(locationPattern); &#125; else &#123; return new Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;; &#125; &#125;&#125; å¤„ç†é€»è¾‘å¦‚ä¸‹å›¾ï¼š ä¸‹é¢å°± findAllClassPathResources()åšè¯¦ç»†åˆ†æã€‚ findAllClassPathResources()å½“ locationPattern ä»¥ classpath:* å¼€å¤´ä½†æ˜¯ä¸åŒ…å«é€šé…ç¬¦ï¼Œåˆ™è°ƒç”¨findAllClassPathResources() æ–¹æ³•åŠ è½½èµ„æºã€‚è¯¥æ–¹æ³•è¿”å› classes è·¯å¾„ä¸‹å’Œæ‰€æœ‰ jar åŒ…ä¸­çš„æ‰€æœ‰ç›¸åŒ¹é…çš„èµ„æºã€‚ protected Resource[] findAllClassPathResources(String location) throws IOException &#123; String path = location; if (path.startsWith(&quot;/&quot;)) &#123; path = path.substring(1); &#125; Set&lt;Resource&gt; result = doFindAllClassPathResources(path); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Resolved classpath location [&quot; + location + &quot;] to resources &quot; + result); &#125; return result.toArray(new Resource[0]);&#125; çœŸæ­£æ‰§è¡ŒåŠ è½½çš„æ˜¯åœ¨ doFindAllClassPathResources()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š protected Set&lt;Resource&gt; doFindAllClassPathResources(String path) throws IOException &#123; Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(16); ClassLoader cl = getClassLoader(); Enumeration&lt;URL&gt; resourceUrls = (cl != null ? cl.getResources(path) : ClassLoader.getSystemResources(path)); while (resourceUrls.hasMoreElements()) &#123; URL url = resourceUrls.nextElement(); result.add(convertClassLoaderURL(url)); &#125; if (&quot;&quot;.equals(path)) &#123; addAllClassLoaderJarRoots(cl, result); &#125; return result;&#125; doFindAllClassPathResources() æ ¹æ® ClassLoader åŠ è½½è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æºã€‚åœ¨åŠ è½½èµ„æºè¿‡ç¨‹ä¸­å¦‚æœï¼Œåœ¨æ„é€  PathMatchingResourcePatternResolver å®ä¾‹çš„æ—¶å€™å¦‚æœä¼ å…¥äº† ClassLoaderï¼Œåˆ™è°ƒç”¨å…¶ getResources()ï¼Œå¦åˆ™è°ƒç”¨ClassLoader.getSystemResources(path)ã€‚ ClassLoader.getResources()å¦‚ä¸‹: public Enumeration&lt;URL&gt; getResources(String name) throws IOException &#123; @SuppressWarnings(&quot;unchecked&quot;) Enumeration&lt;URL&gt;[] tmp = (Enumeration&lt;URL&gt;[]) new Enumeration&lt;?&gt;[2]; if (parent != null) &#123; tmp[0] = parent.getResources(name); &#125; else &#123; tmp[0] = getBootstrapResources(name); &#125; tmp[1] = findResources(name); return new CompoundEnumeration&lt;&gt;(tmp);&#125; çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å°±å·²ç»ä¸€ç›®äº†ç„¶äº†ï¼Ÿå¦‚æœå½“å‰çˆ¶ç±»åŠ è½½å™¨ä¸ä¸º nullï¼Œåˆ™é€šè¿‡çˆ¶ç±»å‘ä¸Šè¿­ä»£è·å–èµ„æºï¼Œå¦åˆ™è°ƒç”¨ getBootstrapResources()ã€‚è¿™é‡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œ(^â–½^)ã€‚ è‹¥ path ä¸º ç©ºï¼ˆâ€œâ€ï¼‰æ—¶ï¼Œåˆ™è°ƒç”¨ addAllClassLoaderJarRoots()æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸»è¦æ˜¯åŠ è½½è·¯å¾„ä¸‹å¾—æ‰€æœ‰ jar åŒ…ï¼Œæ–¹æ³•è¾ƒé•¿ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å°±ä¸è´´å‡ºæ¥äº†ã€‚ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ findAllClassPathResources() å…¶å®å°±æ˜¯åˆ©ç”¨ ClassLoader æ¥åŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„èµ„æºï¼Œä¸ç®¡å®ƒæ˜¯åœ¨ class è·¯å¾„ä¸‹è¿˜æ˜¯åœ¨ jar åŒ…ä¸­ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„ä¸ºç©ºæˆ–è€… /ï¼Œåˆ™ä¼šè°ƒç”¨ addAllClassLoaderJarRoots() æ–¹æ³•åŠ è½½æ‰€æœ‰çš„ jar åŒ…ã€‚ findAllClassPathResources()å½“ locationPattern ä»¥ classpath:* å¼€å¤´ä¸”å½“ä¸­åŒ…å«äº†é€šé…ç¬¦ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œèµ„æºåŠ è½½ã€‚å¦‚ä¸‹ï¼š protected Resource[] findPathMatchingResources(String locationPattern) throws IOException &#123; // ç¡®å®šè·Ÿè·¯å¾„ String rootDirPath = determineRootDir(locationPattern); String subPattern = locationPattern.substring(rootDirPath.length()); // è·å–æ ¹æ®è·¯å¾„ä¸‹å¾—èµ„æº Resource[] rootDirResources = getResources(rootDirPath); Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(16); for (Resource rootDirResource : rootDirResources) &#123; rootDirResource = resolveRootDirResource(rootDirResource); URL rootDirUrl = rootDirResource.getURL(); // bundle èµ„æºç±»å‹ if (equinoxResolveMethod != null &amp;&amp; rootDirUrl.getProtocol().startsWith(&quot;bundle&quot;)) &#123; URL resolvedUrl = (URL) ReflectionUtils .invokeMethod(equinoxResolveMethod, null, rootDirUrl); if (resolvedUrl != null) &#123; rootDirUrl = resolvedUrl; &#125; rootDirResource = new UrlResource(rootDirUrl); &#125; // VFS èµ„æº if (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) &#123; result.addAll(VfsResourceMatchingDelegate .findMatchingResources(rootDirUrl, subPattern, getPathMatcher())); &#125; // Jar else if (ResourceUtils.isJarURL(rootDirUrl) || isJarResource(rootDirResource)) &#123; result .addAll(doFindPathMatchingJarResources (rootDirResource, rootDirUrl, subPattern)); &#125; else &#123; result .addAll(doFindPathMatchingFileResources( rootDirResource, subPattern)); &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Resolved location pattern [&quot; + locationPattern + &quot;] to resources &quot; + result); &#125; return result.toArray(new Resource[0]);&#125; æ–¹æ³•æœ‰ç‚¹å„¿é•¿ï¼Œä½†æ˜¯æ€è·¯è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œä¸»è¦åˆ†ä¸¤æ­¥ï¼š ç¡®å®šç›®å½•ï¼Œè·å–è¯¥ç›®å½•ä¸‹å¾—æ‰€æœ‰èµ„æº åœ¨æ‰€è·å¾—çš„æ‰€æœ‰èµ„æºä¸­è¿›è¡Œè¿­ä»£åŒ¹é…è·å–æˆ‘ä»¬æƒ³è¦çš„èµ„æºã€‚ åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æˆ‘ä»¬è¦å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ determineRootDir(),ä¸€ä¸ªæ˜¯ doFindPathMatchingFileResources()ã€‚ determineRootDir()ä¸»è¦æ˜¯ç”¨äºç¡®å®šæ ¹è·¯å¾„ï¼Œå¦‚ä¸‹ï¼š protected String determineRootDir(String location) &#123; int prefixEnd = location.indexOf(&#x27;:&#x27;) + 1; int rootDirEnd = location.length(); while (rootDirEnd &gt; prefixEnd &amp;&amp; getPathMatcher() .isPattern(location.substring(prefixEnd, rootDirEnd))) &#123; rootDirEnd = location.lastIndexOf(&#x27;/&#x27;, rootDirEnd - 2) + 1; &#125; if (rootDirEnd == 0) &#123; rootDirEnd = prefixEnd; &#125; return location.substring(0, rootDirEnd);&#125; è¯¥æ–¹æ³•ä¸€å®šè¦ç»™å‡ºä¸€ä¸ªç¡®å®šçš„æ ¹ç›®å½•ã€‚è¯¥æ ¹ç›®å½•ç”¨äºç¡®å®šæ–‡ä»¶çš„åŒ¹é…çš„èµ·å§‹ç‚¹ï¼Œå°†æ ¹ç›®å½•ä½ç½®çš„èµ„æºè§£æä¸º java.io.File å¹¶å°†å…¶ä¼ é€’åˆ° retrieveMatchingFiles()ï¼Œå…¶ä½™ä¸ºçŸ¥ç”¨äºæ¨¡å¼åŒ¹é…ï¼Œæ‰¾å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„èµ„æºã€‚ ç¡®å®šæ ¹è·¯å¾„å¦‚ä¸‹: åŸè·¯å¾„ ç¡®å®šæ ¹è·¯å¾„ classpath*:test/cc*/spring-*.xml classpath*:test/ classpath*:test/aa/spring-*.xml classpath*:test/aa/ ç¡®å®šæ ¹è·¯å¾„åï¼Œåˆ™è°ƒç”¨ getResources() æ–¹æ³•è·å–è¯¥è·¯å¾„ä¸‹å¾—æ‰€æœ‰èµ„æºï¼Œç„¶åè¿­ä»£èµ„æºè·å–ç¬¦åˆæ¡ä»¶çš„èµ„æºã€‚ è‡³æ­¤ Spring æ•´ä¸ªèµ„æºè®°è½½è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•ã€‚ä¸‹é¢ç®€è¦æ€»ç»“ä¸‹ï¼š Spring æä¾›äº† Resource å’Œ ResourceLoader æ¥ç»Ÿä¸€æŠ½è±¡æ•´ä¸ªèµ„æºåŠå…¶å®šä½ã€‚ä½¿å¾—èµ„æºä¸èµ„æºçš„å®šä½æœ‰äº†ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„ç•Œé™ï¼Œå¹¶ä¸”æä¾›äº†åˆé€‚çš„ Default ç±»ï¼Œä½¿å¾—è‡ªå®šä¹‰å®ç°æ›´åŠ æ–¹ä¾¿å’Œæ¸…æ™°ã€‚ AbstractResource ä¸º Resource çš„é»˜è®¤å®ç°ï¼Œå®ƒå¯¹ Resource æ¥å£åšäº†ä¸€ä¸ªç»Ÿä¸€çš„å®ç°ï¼Œå­ç±»ç»§æ‰¿è¯¥ç±»ååªéœ€è¦è¦†ç›–ç›¸åº”çš„æ–¹æ³•å³å¯ï¼ŒåŒæ—¶å¯¹äºè‡ªå®šä¹‰çš„ Resource æˆ‘ä»¬ä¹Ÿæ˜¯ç»§æ‰¿è¯¥ç±»ã€‚ DefaultResourceLoader åŒæ ·ä¹Ÿæ˜¯ ResourceLoader çš„é»˜è®¤å®ç°ï¼Œåœ¨è‡ªå®š ResourceLoader çš„æ—¶å€™æˆ‘ä»¬é™¤äº†å¯ä»¥ç»§æ‰¿è¯¥ç±»å¤–è¿˜å¯ä»¥å®ç° ProtocolResolver æ¥å£æ¥å®ç°è‡ªå®šèµ„æºåŠ è½½åè®®ã€‚ DefaultResourceLoader æ¯æ¬¡åªèƒ½è¿”å›å•ä¸€çš„èµ„æºï¼Œæ‰€ä»¥ Spring é’ˆå¯¹è¿™ä¸ªæä¾›äº†å¦å¤–ä¸€ä¸ªæ¥å£ ResourcePatternResolver ï¼Œè¯¥æ¥å£æä¾›äº†æ ¹æ®æŒ‡å®šçš„ locationPattern è¿”å›å¤šä¸ªèµ„æºçš„ç­–ç•¥ã€‚å…¶å­ç±» PathMatchingResourcePatternResolver æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…çš„ ResourceLoader ï¼Œå› ä¸ºå®ƒå³å®ç°äº† Resource getResource(String location) ä¹Ÿå®ç°äº† Resource[] getResources(String locationPattern)ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"IOCä¹‹æ·±å…¥ç†è§£SpringIoC","date":"2020-01-01T15:41:06.000Z","path":"2020/01/01/a426e6ea.html","text":"æ‘˜è¦ æœ¬æ–‡ä½œè€…ï¼šchenssy å‡ºå¤„ï¼šhttp://cmsblogs.com/?p=2652 åœ¨å­¦ä¹ Springæºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼Œæ„Ÿè°¢ä½œè€…ã€‚Springç‰ˆæœ¬ï¼šSpring 5.0.6.RELEASE IOC ç†è®ºIoC å…¨ç§°ä¸º Inversion of Controlï¼Œç¿»è¯‘ä¸º â€œæ§åˆ¶åè½¬â€ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªåˆ«åä¸º DIï¼ˆDependency Injectionï¼‰,å³ä¾èµ–æ³¨å…¥ã€‚ å¦‚ä½•ç†è§£â€œæ§åˆ¶åè½¬â€å¥½å‘¢ï¼Ÿç†è§£å¥½å®ƒçš„å…³é”®åœ¨äºæˆ‘ä»¬éœ€è¦å›ç­”å¦‚ä¸‹å››ä¸ªé—®é¢˜ï¼š è°æ§åˆ¶è° æ§åˆ¶ä»€ä¹ˆ ä¸ºä½•æ˜¯åè½¬ å“ªäº›æ–¹é¢åè½¬äº† åœ¨å›ç­”è¿™å››ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ IOC çš„å®šä¹‰ï¼š æ‰€è°“ IOC ï¼Œå°±æ˜¯ç”± Spring IOC å®¹å™¨æ¥è´Ÿè´£å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹è±¡ä¹‹é—´çš„å…³ç³» ä¸Šé¢è¿™å¥è¯æ˜¯æ•´ä¸ª IoC ç†è®ºçš„æ ¸å¿ƒã€‚å¦‚ä½•æ¥ç†è§£è¿™å¥è¯ï¼Ÿæˆ‘ä»¬å¼•ç”¨ä¸€ä¸ªä¾‹å­æ¥èµ°é˜è¿°ï¼ˆçœ‹å®Œè¯¥ä¾‹å­ä¸Šé¢å››ä¸ªé—®é¢˜ä¹Ÿå°±ä¸æ˜¯é—®é¢˜äº†ï¼‰ã€‚ ä»¥æ‰¾å¥³æœ‹å‹ä¸ºä¾‹ï¼ˆå¯¹äºç¨‹åºçŒ¿æ¥è¯´è¿™ä¸ªå€¼å¾—æ¢ç©¶çš„é—®é¢˜ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•æ¥æ‰¾å¥³æœ‹å‹çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼ˆæ¼‚äº®ã€èº«æå¥½ã€æ€§æ ¼å¥½ï¼‰æ‰¾ä¸€ä¸ªå¦¹å­ï¼Œç„¶ååˆ°å¤„æ‰“å¬å¥¹çš„å…´è¶£çˆ±å¥½ã€å¾®ä¿¡ã€ç”µè¯å·ç ï¼Œç„¶åå„ç§æŠ•å…¶æ‰€å¥½é€å…¶æ‰€è¦ï¼Œæœ€åè¿½åˆ°æ‰‹ã€‚å¦‚ä¸‹ï¼š /** * å¹´è½»å°ä¼™å­ */public class YoungMan &#123; private BeautifulGirl beautifulGirl; YoungMan()&#123; // å¯èƒ½ä½ æ¯”è¾ƒç‰›é€¼ï¼ŒæŒ‡è…¹ä¸ºå©š // beautifulGirl = new BeautifulGirl(); &#125; public void setBeautifulGirl(BeautifulGirl beautifulGirl) &#123; this.beautifulGirl = beautifulGirl; &#125; public static void main(String[] args)&#123; YoungMan you = new YoungMan(); BeautifulGirl beautifulGirl = new BeautifulGirl(&quot;ä½ çš„å„ç§æ¡ä»¶&quot;); beautifulGirl.setxxx(&quot;å„ç§æŠ•å…¶æ‰€å¥½&quot;); // ç„¶åä½ æœ‰å¥³ç¥¨äº† you.setBeautifulGirl(beautifulGirl); &#125;&#125; è¿™å°±æ˜¯æˆ‘ä»¬é€šå¸¸åšäº‹çš„æ–¹å¼ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŸä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨è¿™ç§ç›´æ¥åˆ›å»ºçš„æ–¹å¼(new BeautifulGirl())ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤æ‚è€Œåˆç¹çï¼Œè€Œä¸”æˆ‘ä»¬å¿…é¡»è¦é¢å¯¹æ¯ä¸ªç¯èŠ‚ï¼ŒåŒæ—¶ä½¿ç”¨å®Œæˆä¹‹åæˆ‘ä»¬è¿˜è¦è´Ÿè´£é”€æ¯å®ƒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬çš„å¯¹è±¡ä¸å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡è€¦åˆåœ¨ä¸€èµ·ã€‚ å…¶å®æˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Ÿæˆ‘ä»¬æ¯æ¬¡ç”¨åˆ°è‡ªå·±ä¾èµ–çš„å¯¹è±¡çœŸçš„éœ€è¦è‡ªå·±å»åˆ›å»ºå—ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬ä¾èµ–å¯¹è±¡å…¶å®å¹¶ä¸æ˜¯ä¾èµ–è¯¥å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯ä¾èµ–å®ƒæ‰€æä¾›çš„æœåŠ¡ï¼Œåªè¦åœ¨æˆ‘ä»¬éœ€è¦å®ƒçš„æ—¶å€™ï¼Œå®ƒèƒ½å¤ŸåŠæ—¶æä¾›æœåŠ¡å³å¯ï¼Œè‡³äºå®ƒæ˜¯æˆ‘ä»¬ä¸»åŠ¨å»åˆ›å»ºçš„è¿˜æ˜¯åˆ«äººé€ç»™æˆ‘ä»¬çš„ï¼Œå…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚å†è¯´äº†ï¼Œç›¸æ¯”äºè‡ªå·±åƒè¾›ä¸‡è‹¦å»åˆ›å»ºå®ƒè¿˜è¦ç®¡ç†ã€å–„åè€Œè¨€ï¼Œç›´æ¥æœ‰äººé€è¿‡æ¥æ˜¯ä¸æ˜¯æ˜¾å¾—æ›´åŠ å¥½å‘¢ï¼Ÿ è¿™ä¸ªç»™æˆ‘ä»¬é€ä¸œè¥¿çš„â€œäººâ€ å°±æ˜¯ IoCï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªå©šä»‹å…¬å¸ï¼Œä½œä¸ºä¸€ä¸ªå©šä»‹å…¬å¸å®ƒç®¡ç†ç€å¾ˆå¤šç”·ç”·å¥³å¥³çš„èµ„æ–™ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¥³æœ‹å‹çš„æ—¶å€™ï¼Œç›´æ¥è·Ÿå©šä»‹å…¬å¸æå‡ºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå©šä»‹å…¬å¸åˆ™ä¼šæ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚æä¾›ä¸€ä¸ªå¦¹å­ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬åªéœ€è¦è´Ÿè´£è°ˆæ‹çˆ±ï¼Œç”ŸçŒ´å­å°±è¡Œäº†ã€‚ä½ çœ‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¾ˆç®€å•æ˜äº†ã€‚ è¯šç„¶ï¼Œä½œä¸ºå©šä»‹å…¬å¸çš„ IoC å¸®æˆ‘ä»¬çœç•¥äº†æ‰¾å¥³æœ‹å‹çš„ç¹æ‚è¿‡ç¨‹ï¼Œå°†åŸæ¥çš„ä¸»åŠ¨å¯»æ‰¾å˜æˆäº†ç°åœ¨çš„è¢«åŠ¨æ¥å—ï¼ˆç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼‰ï¼Œæ›´åŠ ç®€æ´è½»ä¾¿ã€‚ä½ æƒ³å•Šï¼ŒåŸæ¥ä½ è¿˜å¾—éé©¬å‰åï¼Œå„ç§å·´ç»“ï¼Œä»€ä¹ˆä¸œè¥¿éƒ½éœ€è¦è‡ªå·±å»äº²åŠ›äº²ä¸ºï¼Œç°åœ¨å¥½äº†ï¼Œç›´æ¥æœ‰äººæŠŠç°æˆçš„é€è¿‡æ¥ï¼Œå¤šä¹ˆç¾å¦™çš„äº‹æƒ…å•Šã€‚æ‰€ä»¥ï¼Œç®€å•ç‚¹è¯´ï¼ŒIoC çš„ç†å¿µå°±æ˜¯è®©åˆ«äººä¸ºä½ æœåŠ¡ï¼Œå¦‚ä¸‹å›¾ï¼ˆæ‘˜è‡ªSpringæ­ç§˜ï¼‰ï¼š åœ¨æ²¡æœ‰å¼•å…¥ IoC çš„æ—¶å€™ï¼Œè¢«æ³¨å…¥çš„å¯¹è±¡ç›´æ¥ä¾èµ–äºè¢«ä¾èµ–çš„å¯¹è±¡ï¼Œæœ‰äº† IoC åï¼Œä¸¤è€…åŠå…¶ä»–ä»¬çš„å…³ç³»éƒ½æ˜¯é€šè¿‡ Ioc Service Provider æ¥ç»Ÿä¸€ç®¡ç†ç»´æŠ¤çš„ã€‚è¢«æ³¨å…¥çš„å¯¹è±¡éœ€è¦ä»€ä¹ˆï¼Œç›´æ¥è·Ÿ IoC Service Provider æ‰“å£°æ‹›å‘¼ï¼Œåè€…å°±ä¼šæŠŠç›¸åº”çš„è¢«ä¾èµ–å¯¹è±¡æ³¨å…¥åˆ°è¢«æ³¨å…¥çš„å¯¹è±¡ä¸­ï¼Œä»è€Œè¾¾åˆ° IOC Service Provider ä¸ºè¢«æ³¨å…¥å¯¹è±¡æœåŠ¡çš„ç›®çš„ã€‚æ‰€ä»¥ IoC å°±æ˜¯è¿™ä¹ˆç®€å•ï¼åŸæ¥æ˜¯éœ€è¦ä»€ä¹ˆä¸œè¥¿è‡ªå·±å»æ‹¿ï¼Œç°åœ¨æ˜¯éœ€è¦ä»€ä¹ˆä¸œè¥¿è®©åˆ«äººï¼ˆIOC Service Providerï¼‰é€è¿‡æ¥ ç°åœ¨åœ¨çœ‹ä¸Šé¢é‚£å››ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆå°±æ˜¾å¾—éå¸¸æ˜æ˜¾äº†: è°æ§åˆ¶è°ï¼šåœ¨ä¼ ç»Ÿçš„å¼€å‘æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯é‡‡ç”¨ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡çš„æ–¹å¼æ¥åˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¾èµ–çš„å¯¹è±¡ç›´æ¥ç”±ä½ è‡ªå·±æ§åˆ¶ï¼Œä½†æ˜¯æœ‰äº† IOC å®¹å™¨åï¼Œåˆ™ç›´æ¥ç”± IoC å®¹å™¨æ¥æ§åˆ¶ã€‚æ‰€ä»¥â€œè°æ§åˆ¶è°â€ï¼Œå½“ç„¶æ˜¯ IoC å®¹å™¨æ§åˆ¶å¯¹è±¡ã€‚ æ§åˆ¶ä»€ä¹ˆï¼šæ§åˆ¶å¯¹è±¡ã€‚ ä¸ºä½•æ˜¯åè½¬ï¼šæ²¡æœ‰ IoC çš„æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯åœ¨è‡ªå·±å¯¹è±¡ä¸­ä¸»åŠ¨å»åˆ›å»ºè¢«ä¾èµ–çš„å¯¹è±¡ï¼Œè¿™æ˜¯æ­£è½¬ã€‚ä½†æ˜¯æœ‰äº† IoC åï¼Œæ‰€ä¾èµ–çš„å¯¹è±¡ç›´æ¥ç”± IoC å®¹å™¨åˆ›å»ºåæ³¨å…¥åˆ°è¢«æ³¨å…¥çš„å¯¹è±¡ä¸­ï¼Œä¾èµ–çš„å¯¹è±¡ç”±åŸæ¥çš„ä¸»åŠ¨è·å–å˜æˆè¢«åŠ¨æ¥å—ï¼Œæ‰€ä»¥æ˜¯åè½¬ã€‚ å“ªäº›æ–¹é¢åè½¬äº†ï¼šæ‰€ä¾èµ–å¯¹è±¡çš„è·å–è¢«åè½¬äº†ã€‚ å¦¹å­æœ‰äº†ï¼Œä½†æ˜¯å¦‚ä½•æ‹¥æœ‰å¦¹å­å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯ä¸€é—¨å­¦é—®ã€‚ å¯èƒ½ä½ æ¯”è¾ƒç‰›é€¼ï¼Œåˆšåˆšå‡ºç”Ÿçš„æ—¶å€™å°±æŒ‡è…¹ä¸ºå©šäº†ã€‚ å¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬è¿˜æ˜¯ä¼šè€ƒè™‘è‡ªå·±æƒ³è¦ä»€ä¹ˆæ ·çš„å¦¹å­ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦å‘å©šä»‹å…¬å¸æ‰“æ‹›å‘¼çš„ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œä½ æ ¹æœ¬å°±ä¸çŸ¥é“è‡ªå·±æƒ³è¦ä»€ä¹ˆæ ·çš„å¦¹å­ï¼Œç›´æ¥è·Ÿå©šä»‹å…¬å¸è¯´ï¼Œæˆ‘å°±è¦ä¸€ä¸ªè¿™æ ·çš„å¦¹å­ã€‚ æ‰€ä»¥ï¼ŒIOC Service Provider ä¸ºè¢«æ³¨å…¥å¯¹è±¡æä¾›è¢«ä¾èµ–å¯¹è±¡ä¹Ÿæœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼šæ„é€ æ–¹æ³•æ³¨å…¥ã€setteræ–¹æ³•æ³¨å…¥ã€æ¥å£æ³¨å…¥ã€‚ æ„é€ å™¨æ³¨å…¥æ„é€ å™¨æ³¨å…¥ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯è¢«æ³¨å…¥çš„å¯¹è±¡é€šè¿‡åœ¨å…¶æ„é€ æ–¹æ³•ä¸­å£°æ˜ä¾èµ–å¯¹è±¡çš„å‚æ•°åˆ—è¡¨ï¼Œè®©å¤–éƒ¨çŸ¥é“å®ƒéœ€è¦å“ªäº›ä¾èµ–å¯¹è±¡ã€‚ YoungMan(BeautifulGirl beautifulGirl)&#123; this.beautifulGirl = beautifulGirl;&#125; æ„é€ å™¨æ³¨å…¥æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œå¯¹è±¡æ„é€ å®Œæ¯•åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè¿™å°±å¥½æ¯”ä½ å‡ºç”Ÿä½ å®¶é‡Œå°±ç»™ä½ æŒ‡å®šäº†ä½ åª³å¦‡ã€‚ setter æ–¹æ³•æ³¨å…¥å¯¹äº JavaBean å¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ getter å’Œ setter æ–¹æ³•æ¥è®¿é—®å’Œè®¾ç½®å¯¹è±¡çš„å±æ€§ã€‚æ‰€ä»¥ï¼Œå½“å‰å¯¹è±¡åªéœ€è¦ä¸ºå…¶æ‰€ä¾èµ–çš„å¯¹è±¡æä¾›ç›¸å¯¹åº”çš„ setter æ–¹æ³•ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•å°†ç›¸åº”çš„ä¾èµ–å¯¹è±¡è®¾ç½®åˆ°è¢«æ³¨å…¥å¯¹è±¡ä¸­ã€‚å¦‚ä¸‹ï¼š public class YoungMan &#123; private BeautifulGirl beautifulGirl; public void setBeautifulGirl(BeautifulGirl beautifulGirl) &#123; this.beautifulGirl = beautifulGirl; &#125;&#125; ç›¸æ¯”äºæ„é€ å™¨æ³¨å…¥ï¼Œsetter æ–¹å¼æ³¨å…¥ä¼šæ˜¾å¾—æ¯”è¾ƒå®½æ¾çµæ´»äº›ï¼Œå®ƒå¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¿›è¡Œæ³¨å…¥ï¼ˆå½“ç„¶æ˜¯åœ¨ä½¿ç”¨ä¾èµ–å¯¹è±¡ä¹‹å‰ï¼‰ï¼Œè¿™å°±å¥½æ¯”ä½ å¯ä»¥å…ˆæŠŠè‡ªå·±æƒ³è¦çš„å¦¹å­æƒ³å¥½äº†ï¼Œç„¶åå†è·Ÿå©šä»‹å…¬å¸æ‰“æ‹›å‘¼ï¼Œä½ å¯ä»¥è¦æ—å¿—ç²æ¬¾å¼çš„ï¼Œèµµä¸½é¢–æ¬¾å¼çš„ï¼Œç”šè‡³å‡¤å§å“ªæ¬¾çš„ï¼Œéšæ„æ€§è¾ƒå¼ºã€‚ æ¥å£æ–¹å¼æ³¨å…¥æ¥å£æ–¹å¼æ³¨å…¥æ˜¾å¾—æ¯”è¾ƒéœ¸é“ï¼Œå› ä¸ºå®ƒéœ€è¦è¢«ä¾èµ–çš„å¯¹è±¡å®ç°ä¸å¿…è¦çš„æ¥å£ï¼Œå¸¦æœ‰ä¾µå…¥æ€§ã€‚ä¸€èˆ¬éƒ½ä¸æ¨èè¿™ç§æ–¹å¼ã€‚ å…³äº IOC ç†è®ºéƒ¨åˆ†ï¼Œç¬”è€…ä¸åœ¨é˜è¿°ï¼Œè¿™é‡Œæ¨èå‡ ç¯‡åšå®¢é˜…è¯»ï¼š è°ˆè°ˆå¯¹Spring IOCçš„ç†è§£ï¼šhttp://www.cnblogs.com/xdp-gacl/p/4249939.html [Springçš„IOCåŸç†é€šä¿—è§£é‡Šä¸€ä¸‹]ï¼šhttps://blog.csdn.net/m13666368773/article/details/7802126 spring iocåŸç†ï¼ˆçœ‹å®Œåå¤§å®¶å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªspringï¼‰ï¼šhttps://blog.csdn.net/it_man/article/details/4402245 å„ä¸ªç»„ä»¶å…ˆçœ‹ä¸‹å›¾ï¼ˆæ‘˜è‡ª:http://singleant.iteye.com/blog/1177358ï¼‰ è¯¥å›¾ä¸º ClassPathXmlApplicationContext çš„ç±»ç»§æ‰¿ä½“ç³»ç»“æ„ï¼Œè™½ç„¶åªæœ‰ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒåŸºæœ¬ä¸ŠåŒ…å«äº† IOC ä½“ç³»ä¸­å¤§éƒ¨åˆ†çš„æ ¸å¿ƒç±»å’Œæ¥å£ã€‚ ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹è¿™ä¸ªå›¾è¿›è¡Œç®€å•çš„æ‹†åˆ†å’Œè¡¥å……è¯´æ˜ã€‚ Resourceä½“ç³»Resourceï¼Œå¯¹èµ„æºçš„æŠ½è±¡ï¼Œå®ƒçš„æ¯ä¸€ä¸ªå®ç°ç±»éƒ½ä»£è¡¨äº†ä¸€ç§èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œå¦‚ClasspathResource ã€ URLResource ï¼ŒFileSystemResource ç­‰ã€‚ [ æœ‰äº†èµ„æºï¼Œå°±åº”è¯¥æœ‰èµ„æºåŠ è½½ï¼ŒSpring åˆ©ç”¨ ResourceLoader æ¥è¿›è¡Œç»Ÿä¸€èµ„æºåŠ è½½ï¼Œç±»å›¾å¦‚ä¸‹ï¼š BeanFactory ä½“ç³»BeanFactory æ˜¯ä¸€ä¸ªéå¸¸çº¯ç²¹çš„ bean å®¹å™¨ï¼Œå®ƒæ˜¯ IOC å¿…å¤‡çš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ BeanDefinition æ˜¯å¥¹çš„åŸºæœ¬ç»“æ„ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª BeanDefinition map ï¼Œå¹¶å¯æ ¹æ® BeanDefinition çš„æè¿°è¿›è¡Œ bean çš„åˆ›å»ºå’Œç®¡ç†ã€‚ BeanFacoty æœ‰ä¸‰ä¸ªç›´æ¥å­ç±» ListableBeanFactoryã€HierarchicalBeanFactory å’Œ AutowireCapableBeanFactoryï¼ŒDefaultListableBeanFactory ä¸ºæœ€ç»ˆé»˜è®¤å®ç°ï¼Œå®ƒå®ç°äº†æ‰€æœ‰æ¥å£ã€‚ Beandefinition ä½“ç³»BeanDefinition ç”¨æ¥æè¿° Spring ä¸­çš„ Bean å¯¹è±¡ã€‚ BeandefinitionReaderä½“ç³»BeanDefinitionReader çš„ä½œç”¨æ˜¯è¯»å– Spring çš„é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ Ioc å®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼šBeanDefinitionã€‚ [ ApplicationContextä½“ç³»è¿™ä¸ªå°±æ˜¯å¤§åé¼é¼çš„ Spring å®¹å™¨ï¼Œå®ƒå«åšåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œä¸æˆ‘ä»¬åº”ç”¨æ¯æ¯ç›¸å…³ï¼Œå¥¹ç»§æ‰¿ BeanFactoryï¼Œæ‰€ä»¥å®ƒæ˜¯ BeanFactory çš„æ‰©å±•å‡çº§ç‰ˆï¼Œå¦‚æœBeanFactory æ˜¯å±Œä¸çš„è¯ï¼Œé‚£ä¹ˆ ApplicationContext åˆ™æ˜¯åå‰¯å…¶å®çš„é«˜å¯Œå¸…ã€‚ç”±äº ApplicationContext çš„ç»“æ„å°±å†³å®šäº†å®ƒä¸ BeanFactory çš„ä¸åŒï¼Œå…¶ä¸»è¦åŒºåˆ«æœ‰ï¼š ç»§æ‰¿ MessageSourceï¼Œæä¾›å›½é™…åŒ–çš„æ ‡å‡†è®¿é—®ç­–ç•¥ã€‚ ç»§æ‰¿ ApplicationEventPublisher ï¼Œæä¾›å¼ºå¤§çš„äº‹ä»¶æœºåˆ¶ã€‚ æ‰©å±• ResourceLoaderï¼Œå¯ä»¥ç”¨æ¥åŠ è½½å¤šä¸ª Resourceï¼Œå¯ä»¥çµæ´»è®¿é—®ä¸åŒçš„èµ„æºã€‚ å¯¹ Web åº”ç”¨çš„æ”¯æŒã€‚ ä¸‹å›¾æ¥æºï¼šhttps://blog.csdn.net/yujin753/article/details/47043143 ä¸Šé¢äº”ä¸ªä½“ç³»å¯ä»¥è¯´æ˜¯Spring IoCä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œåé¢åšæ–‡ä¹Ÿæ˜¯é’ˆå¯¹è¿™äº”ä¸ªéƒ¨åˆ†è¿›è¡Œæºç åˆ†æã€‚å…¶å® IoC å’‹ä¸€çœ‹è¿˜æ˜¯æŒºç®€å•çš„ï¼Œæ— éå°±æ˜¯å°†é…ç½®æ–‡ä»¶ï¼ˆæš‚ä¸”è®¤ä¸ºæ˜¯ xml æ–‡ä»¶ï¼‰è¿›è¡Œè§£æï¼ˆåˆ†æ xml è°ä¸ä¼šå•Šï¼‰ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ª Map é‡Œé¢å°±å·®ä¸å¤šäº†ï¼Œåˆçœ‹æœ‰é“ç†ï¼Œå…¶å®è¦é¢ä¸´çš„é—®é¢˜è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ï¼Œä¸‹é¢å°±åŠ³çƒ¦å„ä½çœ‹å®¢è·Ÿç€ LZ åšå®¢æ¥ä¸€æ­¥ä¸€æ­¥æ­å¼€ Spring IoC çš„ç¥ç§˜é¢çº±ã€‚ æ­¤ç³»åˆ—åšæ–‡ä¸º LZ å­¦ä¹ ã€ç ”ç©¶ Spring æœºåˆ¶å’Œæºç çš„å­¦ä¹ ç¬”è®°ï¼Œä¼šæ¶‰åŠå‚è€ƒåˆ«äººçš„åšæ–‡å’Œä¹¦ç±å†…å®¹ï¼Œå¦‚æœ‰é›·åŒï¼Œçº¯å±å€Ÿé‰´ï¼Œå½“ç„¶ LZ ä¼šæ ‡æ˜å‚è€ƒæ¥æºã€‚åŒæ—¶ç”±äºçŸ¥è¯†é¢å’Œèƒ½åŠ›çš„é—®é¢˜ï¼Œæ–‡ç« ä¸­éš¾å…ä¼šå‡ºç°é”™è¯¯ä¹‹å¤„ï¼Œå¦‚æœ‰ï¼Œæœ›å„ä½å¤§ä½¬æŒ‡å‡ºï¼Œä¸èƒœæ„Ÿæ¿€ã€‚ LZ å†™æ­¤ç³»åˆ—åšå®¢æ—¶ï¼ŒSpring æœ€æ–°ç‰ˆæœ¬ä¸º 5.0.6.RELEASE ï¼Œæ‰€ä»¥æ­¤ç³»åˆ—åšå®¢æ‰€æœ‰æºç æ¥æºå‡ä¸º 5.0.6.RELEASEã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”ç¼“å­˜æ¨¡å—","date":"2019-10-31T01:09:42.000Z","path":"2019/10/31/fce458a9.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„ç¼“å­˜æ¨¡å— MyBatisä½œä¸º ä¸€ä¸ª å¼ºå¤§çš„æŒä¹…å±‚ æ¡† æ¶ï¼Œç¼“ å­˜æ˜¯å…¶å¿…ä¸å¯å°‘çš„åŠŸèƒ½ä¹‹ä¸€ã€‚MyBatisä¸­çš„ç¼“ å­˜ æ˜¯ä¸¤ å±‚ ç»“ æ„ çš„ï¼Œåˆ†ä¸º ä¸€çº§ ç¼“ å­˜ã€äºŒçº§ ç¼“ å­˜ï¼Œä½†åœ¨æœ¬è´¨ ä¸Šæ˜¯ç›¸åŒçš„ï¼Œå®ƒ ä»¬ ä½¿ç”¨çš„éƒ½æ˜¯Cacheæ¥ å£çš„å® ç° ã€‚ åœ¨ MyBatisç¼“ å­˜æ¨¡å— ä¸­æ¶‰åŠäº†è£… é¥° å™¨æ¨¡å¼çš„ç›¸å…³ çŸ¥è¯† ã€‚ è£…é¥°å™¨æ¨¡å¼åœ¨å®è·µç”Ÿäº§ä¸­ï¼Œæ–°éœ€æ±‚åœ¨è½¯ä»¶çš„æ•´ä¸ªç”Ÿå‘½è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸æ–­å‡ºç°çš„ã€‚å½“æœ‰æ–°éœ€æ±‚å‡ºç°æ—¶ï¼Œå°±éœ€è¦ä¸ºæŸäº›ç»„ä»¶æ·»åŠ æ–°çš„åŠŸèƒ½æ¥æ»¡è¶³è¿™äº›éœ€æ±‚ã€‚ æ·»åŠ æ–°åŠŸèƒ½çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹å·±æœ‰ç»„ä»¶çš„ä»£ç å¹¶æ·»åŠ ç›¸åº”çš„æ–°åŠŸèƒ½ï¼Œè¿™æ˜¾ç„¶ä¼šç ´åå·±æœ‰ç»„ä»¶çš„ç¨³å®šæ€§ï¼Œä¿®æ”¹å®Œæˆåï¼Œæ•´ä¸ªç»„ä»¶éœ€è¦é‡æ–°è¿›è¡Œæµ‹è¯•ï¼Œæ‰èƒ½ä¸Šçº¿ä½¿ç”¨ã€‚è¿™ç§æ–¹å¼æ˜¾ç„¶è¿åäº†â€œå¼€æ”¾-å°é—­â€åŸåˆ™ã€‚ å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ç»§æ‰¿æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå­ç±»å¹¶åœ¨å­ç±»ä¸­æ·»åŠ æ–°åŠŸèƒ½å®ç°æ‰©å±•ã€‚*è¿™ç§æ–¹æ³•æ˜¯é™æ€çš„ï¼Œç”¨æˆ·ä¸èƒ½æ§åˆ¶å¢åŠ è¡Œä¸ºçš„æ–¹å¼å’Œæ—¶æœºã€‚è€Œä¸”æœ‰äº›æƒ…å†µä¸‹ç»§æ‰¿æ˜¯ä¸å¯è¡Œçš„ã€‚ ä¾‹å¦‚å·±æœ‰ç»„ä»¶æ˜¯è¢«finalå…³é”®å­—ä¿®é¥°çš„ç±»ã€‚ å¦å¤–ï¼Œå¦‚æœå¾…æ·»åŠ çš„æ–°åŠŸèƒ½å­˜åœ¨å¤šç§ç»„åˆï¼Œä½¿ç”¨ç»§æ‰¿æ–¹å¼å¯èƒ½ä¼šå¯¼è‡´å¤§é‡å­ç±»çš„å‡ºç°ã€‚ ä¾‹å¦‚ï¼Œæœ‰4ä¸ªå¾…æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œç³»ç»Ÿéœ€è¦åŠ¨æ€ä½¿ç”¨ä»»æ„å¤šä¸ªåŠŸèƒ½çš„ç»„åˆï¼Œåˆ™éœ€è¦æ·»åŠ 15ä¸ªå­ç±»æ‰èƒ½æ»¡è¶³å…¨éƒ¨éœ€æ±‚ã€‚ è£…é¥°å™¨æ¨¡å¼èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè£…é¥°å™¨å¯ä»¥åŠ¨æ€åœ°ä¸ºå¯¹è±¡æ·»åŠ åŠŸèƒ½ï¼Œå®ƒæ˜¯åŸºäºç»„åˆçš„æ–¹å¼å®ç°è¯¥åŠŸèƒ½çš„ã€‚ åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨ç»„åˆçš„æ–¹å¼æ¥æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œè€Œéä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼ã€‚è®¾è®¡æ¨¡å¼ä¸­å¸¸è§çš„ä¸€å¥è¯:ç»„åˆä¼˜äºç»§æ‰¿ã€‚ è£…é¥°å™¨æ¨¡å¼çš„ç±»å›¾ï¼Œä»¥åŠå…¶ä¸­çš„æ ¸å¿ƒè§’è‰²ï¼š Componentï¼ˆç»„ä»¶ï¼‰ ç»„ä»¶æ¥å£å®šä¹‰äº†å…¨éƒ¨ç»„ä»¶å®ç°ç±»ä»¥åŠæ‰€æœ‰è£…é¥°å™¨å®ç°çš„è¡Œä¸ºã€‚ ConcreteComponent (å…·ä½“ ç»„ ä»¶å® ç° ç±» ) å…·ä½“ç»„ä»¶å®ç°ç±»å®ç°äº†Componentæ¥å£ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œå…·ä½“ç»„ä»¶å®ç°ç±»å°±æ˜¯è¢«è£…é¥°å™¨è£…é¥°çš„åŸå§‹å¯¹è±¡ï¼Œè¯¥ç±»æä¾›äº†Componentæ¥å£ä¸­å®šä¹‰çš„æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå…¶ä»–é«˜çº§åŠŸèƒ½æˆ–åç»­æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œéƒ½æ˜¯é€šè¿‡è£…é¥°å™¨çš„æ–¹å¼æ·»åŠ åˆ°è¯¥ç±»çš„å¯¹è±¡ä¹‹ä¸Šçš„ã€‚ Decorator(è£…é¥°å™¨) æ‰€æœ‰è£…é¥°å™¨çš„çˆ¶ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº†Componentæ¥å£çš„æŠ½è±¡ç±»ï¼Œå¹¶åœ¨å…¶ä¸­å°è£…äº†ä¸€ä¸ªComponentå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¢«è£…é¥°çš„å¯¹è±¡ã€‚ è€Œè¿™ä¸ªè¢«è£…é¥°çš„å¯¹è±¡åªè¦æ˜¯Componentç±»å‹å³å¯ï¼Œè¿™å°±å®ç°äº†è£…é¥°å™¨çš„ç»„åˆå’Œå¤ç”¨ã€‚ å¦‚ä¸‹å›¾ï¼Œè£…é¥°å™¨**C(ConcreteDecoratorlç±»å‹)ä¿®é¥°äº†è£…é¥°å™¨B(ConcreteDecorator2ç±»å‹)**å¹¶ä¸ºå…¶æ·»åŠ åŠŸèƒ½Wï¼Œè€Œè£…é¥°å™¨B(ConcreteDecorator2ç±»å‹)åˆä¿®é¥°äº†ç»„ä»¶A(ConcreteComponentç±»å‹)å¹¶ä¸ºå…¶æ·»åŠ åŠŸèƒ½Vã€‚ å…¶ä¸­ï¼Œç»„ä»¶å¯¹è±¡Aæä¾›çš„æ˜¯æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œè£…é¥°å™¨Bå’Œè£…é¥°å™¨Cä¼šä¸ºç»„ä»¶å¯¹è±¡Aæ·»åŠ æ–°çš„åŠŸèƒ½ã€‚ ConcreteDecorator å…·ä½“çš„è£…é¥°å™¨å®ç°ç±»ï¼Œè¯¥å®ç°ç±»è¦å‘è¢«è£…é¥°å¯¹è±¡æ·»åŠ æŸäº›åŠŸèƒ½ã€‚å¦‚ä¸Šå›¾ï¼Œè£…é¥°å™¨Bã€Cå°±æ˜¯è¯¥è§’è‰²ï¼Œè¢«è£…é¥°çš„å¯¹è±¡åªè¦æ˜¯Componentç±»å‹å³å¯ã€‚åœ¨JavaIOåŒ…ä¸­ï¼Œå¤§é‡åº”ç”¨äº†è£…é¥°å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨JavaIOåŒ…è¯»å–æ–‡ä»¶æ—¶ï¼Œç»å¸¸ä¼šçœ‹åˆ°å¦‚ä¸‹ä»£ç : BufferedlnputStream bis = new BufferedlnputStream( new FilelnputStream(new File(&quot;D:/test.txt&quot;))); FilelnputStreamå¹¶æ²¡æœ‰ç¼“å†²åŠŸèƒ½ï¼Œæ¯æ¬¡è°ƒç”¨å…¶read()æ–¹æ³•æ—¶éƒ½ä¼šå‘æ“ä½œç³»ç»Ÿå‘èµ·ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå½“è¯»å–å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿåœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´é¢‘ç¹åˆ‡æ¢ï¼Œæ€§èƒ½è¾ƒä½ã€‚ BufferedlnputStreamæ˜¯æä¾›äº†ç¼“å†²åŠŸèƒ½çš„è£…é¥°å™¨ï¼Œæ¯æ¬¡è°ƒç”¨å…¶read()æ–¹æ³•æ—¶ï¼Œä¼šé¢„å…ˆä»æ–‡ä»¶ä¸­è·å–ä¸€éƒ¨åˆ†æ•°æ®å¹¶ç¼“å­˜åˆ°BufferedlnputStreamçš„ç¼“å†²åŒºä¸­ï¼Œåé¢è¿ç»­çš„å‡ æ¬¡è¯»å–å¯ä»¥ç›´æ¥ä»ç¼“å†²åŒºä¸­è·å–æ•°æ®ï¼Œç›´åˆ°ç¼“å†²åŒºæ•°æ®è€—å°½æ‰ä¼šé‡æ–°ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæé«˜äº†è¯»å–çš„æ€§èƒ½ã€‚ åœ¨MyBatisçš„ç¼“å­˜æ¨¡å—ä¸­ï¼Œä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼çš„å˜ä½“ï¼Œå…¶ä¸­å°†Decoratoræ¥å£å’ŒComponentæ¥å£åˆå¹¶ä¸ºä¸€ä¸ªComponentæ¥å£ ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹ï¼š ç›¸è¾ƒäºç»§æ‰¿æ¥è¯´ï¼Œè£…é¥°å™¨æ¨¡å¼çš„çµæ´»æ€§æ›´å¼ºï¼Œå¯æ‰©å±•æ€§ä¹Ÿå¼ºã€‚æ­£å¦‚å‰é¢æ‰€è¯´ï¼Œç»§æ‰¿æ–¹å¼ä¼šå¯¼è‡´å¤§é‡å­ç±»çš„æƒ…å†µã€‚è€Œè£…é¥°è€…æ¨¡å¼å¯ä»¥å°†å¤æ‚çš„åŠŸèƒ½åˆ‡åˆ†æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„è£…é¥°å™¨ï¼Œé€šè¿‡å¤šä¸ªç‹¬ç«‹è£…é¥°å™¨çš„åŠ¨æ€ç»„åˆï¼Œåˆ›å»ºä¸åŒåŠŸèƒ½çš„ç»„ä»¶ï¼Œä»è€Œæ»¡è¶³å¤šç§ä¸åŒéœ€æ±‚ã€‚ å½“æœ‰æ–°åŠŸèƒ½éœ€è¦æ·»åŠ æ—¶ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„è£…é¥°å™¨å®ç°ç±»ï¼Œç„¶åé€šè¿‡ç»„åˆæ–¹å¼æ·»åŠ è¿™ä¸ªæ–°è£…é¥°å™¨å³å¯ï¼Œæ— é¡»ä¿®æ”¹å·±æœ‰ç±»çš„ä»£ç ï¼Œç¬¦åˆâ€œå¼€æ”¾-å°é—­â€åŸåˆ™ã€‚ ä½†æ˜¯ï¼Œéšç€æ·»åŠ çš„æ–°éœ€æ±‚è¶Šæ¥è¶Šå¤šï¼Œå¯èƒ½ä¼šåˆ›å»ºå‡ºåµŒå¥—å¤šå±‚è£…é¥°å™¨çš„å¯¹è±¡ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œä¹Ÿå¢åŠ äº†ç†è§£çš„éš¾åº¦å’Œå®šä½é”™è¯¯çš„éš¾åº¦ã€‚ Cacheæ¥å£åŠå…¶å®ç°MyBatisçš„ç¼“å­˜æ¨¡å—åœ¨org.apache.ibatis.cacheåŒ…ä¸‹ï¼Œå…¶ä¸­Cacheæ¥å£æ˜¯ç¼“å­˜æ¨¡å—çš„ä¸­æœ€æ ¸å¿ƒçš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰ç¼“å­˜çš„åŸºæœ¬è¡Œä¸ºã€‚ Cache public interface Cache &#123; /** * è¿”å›è¯¥ç¼“å­˜å¯¹åº”çš„id * @return The identifier of this cache */ String getId(); /** * å‘ç¼“å­˜ä¸­æ·»åŠ æ•°æ®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Keyæ˜¯CacheKeyï¼Œvalueæ˜¯æŸ¥è¯¢ç»“æœ * @param key Can be any object but usually it is a &#123;@link CacheKey&#125; * @param value The result of a select. */ void putObject(Object key, Object value); /** * ä»ç¼“å­˜ä¸­è·å–æ•°æ® * @param key The key * @return The object stored in the cache. */ Object getObject(Object key); /** * åˆ é™¤Keyå¯¹åº”çš„ç¼“å­˜ * As of 3.3.0 this method is only called during a rollback * for any previous value that was missing in the cache. * This lets any blocking cache to release the lock that * may have previously put on the key. * A blocking cache puts a lock when a value is null * and releases it when the value is back again. * This way other threads will wait for the value to be * available instead of hitting the database. * * * @param key The key * @return Not used */ Object removeObject(Object key); /** * æ¸…ç©ºç¼“å­˜ * Clears this cache instance */ void clear(); /** * ç¼“å­˜é¡¹çš„ä¸ªæ•°ï¼Œä¸ä¼šè¢«MyBatisæ ¸å¿ƒä»£ç è°ƒç”¨ * Optional. This method is not called by the core. * * @return The number of elements stored in the cache (not its capacity). */ int getSize(); /** * è·å–è¯»å†™é”ï¼Œä¸ä¼šè¢«MyBatisæ ¸å¿ƒä»£ç è°ƒç”¨ * Optional. As of 3.2.6 this method is no longer called by the core. * * Any locking needed by the cache must be provided internally by the cache provider. * * @return A ReadWriteLock */ ReadWriteLock getReadWriteLock();&#125; Cacheæ¥å£çš„å®ç°ç±»æœ‰å¤šä¸ªï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯è£…é¥°å™¨ï¼Œåªæœ‰PerpetualCacheæä¾›äº†Cacheæ¥å£çš„åŸºæœ¬å®ç°ã€‚ PerpetualCache**PerpetualCacheåœ¨ç¼“å­˜æ¨¡å—ä¸­æ‰®æ¼”ç€ConcreteComponentçš„è§’è‰²**ï¼Œå…¶å®ç°æ¯”è¾ƒç®€å•ï¼Œåº•å±‚ä½¿ç”¨HashMapè®°å½•ç¼“å­˜é¡¹ï¼Œä¹Ÿæ˜¯é€šè¿‡è¯¥HashMapå¯¹è±¡çš„æ–¹æ³•å®ç°çš„Cacheæ¥å£ä¸­å®šä¹‰çš„ç›¸åº”æ–¹æ³•ã€‚ public class PerpetualCache implements Cache &#123; private final String id; private Map&lt;Object, Object&gt; cache = new HashMap&lt;Object, Object&gt;(); public PerpetualCache(String id) &#123; this.id = id; &#125; @Override public String getId() &#123; return id; &#125; @Override public int getSize() &#123; return cache.size(); &#125; @Override public void putObject(Object key, Object value) &#123; cache.put(key, value); &#125; @Override public Object getObject(Object key) &#123; return cache.get(key); &#125; @Override public Object removeObject(Object key) &#123; return cache.remove(key); &#125; @Override public void clear() &#123; cache.clear(); &#125; @Override public ReadWriteLock getReadWriteLock() &#123; return null; &#125; @Override public boolean equals(Object o) &#123; if (getId() == null) &#123; throw new CacheException(&quot;Cache instances require an ID.&quot;); &#125; if (this == o) &#123; return true; &#125; if (!(o instanceof Cache)) &#123; return false; &#125; Cache otherCache = (Cache) o; return getId().equals(otherCache.getId()); &#125; @Override public int hashCode() &#123; if (getId() == null) &#123; throw new CacheException(&quot;Cache instances require an ID.&quot;); &#125; return getId().hashCode(); &#125;&#125; ä¸‹é¢æ¥ä»‹ç»org.apache.ibatis.cache.decoratorsåŒ…ä¸‹æä¾›çš„è£…é¥°å™¨ï¼Œå®ƒä»¬éƒ½ç›´æ¥å®ç°äº†Cacheæ¥å£ï¼Œæ‰®æ¼”ç€ConcreteDecoratorçš„è§’è‰²ã€‚ è¿™äº›è£…é¥°å™¨ä¼šåœ¨PerpetualCacheçš„åŸºç¡€ä¸Šæä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œé€šè¿‡å¤šä¸ªç»„åˆåæ»¡è¶³ä¸€ä¸ªç‰¹å®šçš„éœ€æ±‚ï¼Œåé¢ä»‹ç»äºŒçº§ç¼“å­˜æ—¶ï¼Œä¼šè§åˆ°è¿™äº›è£…é¥°å™¨æ˜¯å¦‚ä½•å®ŒæˆåŠ¨æ€ç»„åˆçš„ã€‚ BlockingCacheBlockingCacheæ˜¯é˜»å¡ç‰ˆæœ¬çš„ç¼“å­˜è£…é¥°å™¨ï¼Œå®ƒä¼šä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾æŒ‡å®škeyå¯¹åº”çš„æ•°æ®ã€‚ // é˜»å¡è¶…æ—¶æ—¶é—´private long timeout;// è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡private final Cache delegate;// æ¯ä¸ªKeyéƒ½æœ‰å¯¹åº”çš„ReentrantLockå¯¹è±¡private final ConcurrentHashMap&lt;Object, ReentrantLock&gt; locks; å‡è®¾çº¿ç¨‹Aåœ¨BlockingCacheä¸­æœªæŸ¥æ‰¾åˆ°keyAå¯¹åº”çš„ç¼“å­˜é¡¹æ—¶ï¼Œçº¿ç¨‹Aä¼šè·å–keyAå¯¹åº”çš„é”ï¼Œè¿™æ ·åç»­çº¿ç¨‹åœ¨æŸ¥æ‰¾keyAæ—¶ä¼šå‘ç”Ÿé˜»å¡ BlockingCache.getObject(Object key) public Object getObject(Object key) &#123; // è·å–keyå¯¹åº”çš„é” acquireLock(key); Object value = delegate.getObject(key); if (value != null) &#123; // å¦‚æœç¼“å­˜æœ‰keyå¯¹åº”çš„ç¼“å­˜é¡¹ï¼Œåˆ™é‡Šæ”¾é” releaseLock(key); &#125; return value;&#125; acquireLock(Object key) private void acquireLock(Object key) &#123; // è·å–ReentrantLockå¯¹è±¡ Lock lock = getLockForKey(key); if (timeout &gt; 0) &#123; try &#123; // è·å–é”ï¼Œå¸¦è¶…æ—¶æ—¶é—´çš„é‚£ç§ boolean acquired = lock.tryLock(timeout, TimeUnit.MILLISECONDS); if (!acquired) &#123; // å¦‚æœè¶…æ—¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new CacheException(&quot;...&quot;); &#125; &#125; catch (InterruptedException e) &#123; throw new CacheException(&quot;...&quot;); &#125; &#125; else &#123; lock.lock(); &#125;&#125; å†æ¥çœ‹ä¸€ä¸‹getLockForKeyæ–¹æ³• private ReentrantLock getLockForKey(Object key) &#123; ReentrantLock lock = new ReentrantLock(); // åˆ›å»ºReentrantLockå¯¹è±¡ // è¯•æ·»åŠ åˆ°locksé›†åˆä¸­ï¼Œå¦‚æœlocksé›†åˆä¸­å·²ç»æœ‰äº†ç›¸åº”çš„ReentrantLockå¯¹è±¡ï¼Œåˆ™ä½¿ç”¨locksé›†åˆ // ä¸­çš„ReentrantLockå¯¹è±¡ ReentrantLock previous = locks.putIfAbsent(key, lock); return previous == null ? lock : previous;&#125; å‡è®¾çº¿ç¨‹Aä»æ•°æ®åº“ä¸­æŸ¥æ‰¾åˆ°keyAå¯¹åº”çš„ç»“æœå¯¹è±¡åï¼Œå°†ç»“æœå¯¹è±¡æ”¾å…¥åˆ°BlockingCacheä¸­ï¼Œæ­¤æ—¶çº¿ç¨‹Aä¼šé‡Šæ”¾keyAå¯¹åº”çš„é”ï¼Œå”¤é†’é˜»å¡åœ¨è¯¥é”ä¸Šçš„çº¿ç¨‹ã€‚ å…¶ä»–çº¿ç¨‹å³å¯ä»BlockingCacheä¸­è·å–keyAå¯¹åº”çš„æ•°æ®ï¼Œè€Œä¸æ˜¯å†æ¬¡è®¿é—®æ•°æ®åº“ã€‚ BlockingCache.putObject() @Overridepublic void putObject(Object key, Object value) &#123; try &#123; // å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹ delegate.putObject(key, value); &#125; finally &#123; releaseLock(key);// é‡Šæ”¾é” &#125;&#125; BlockingCache.releaseLock(Object key) private void releaseLock(Object key) &#123; ReentrantLock lock = locks.get(key); if (lock.isHeldByCurrentThread()) &#123; // åˆ¤æ–­é”æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æŒæœ‰ // é‡Šæ”¾é” lock.unlock(); &#125;&#125; FifoCache&amp;LruCacheåœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œä¸ºäº†æ§åˆ¶ç¼“å­˜çš„å¤§å°ï¼Œç³»ç»Ÿéœ€è¦æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ¸…ç†ç¼“å­˜ã€‚ FifoCacheæ˜¯å…ˆå…¥å…ˆå‡ºç‰ˆæœ¬çš„è£…é¥°å™¨ï¼Œ**å½“å‘ç¼“å­˜æ·»åŠ æ•°æ®æ—¶ï¼Œå¦‚æœç¼“å­˜é¡¹çš„ä¸ªæ•°å·±ç»è¾¾åˆ°ä¸Šé™ï¼Œåˆ™ä¼šå°†ç¼“å­˜ä¸­æœ€è€(å³æœ€æ—©è¿›å…¥ç¼“å­˜)çš„ç¼“å­˜é¡¹åˆ é™¤ã€‚** FifoCacheä¸­å­—æ®µçš„å«ä¹‰ï¼š // è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡private final Cache delegate;// ç”¨äºè®°å½•keyè¿›å…¥ç¼“å­˜çš„å…ˆåé¡ºåºï¼Œä½¿ç”¨çš„æ˜¯LinkedList&lt;Object&gt;ç±»å‹çš„å‡ ä¸ªå¯¹è±¡ private final Deque&lt;Object&gt; keyList;// è®°å½•ç¼“å­˜é¡¹çš„ä¸Šé™ï¼Œå¦‚æœè¶…è¿‡ï¼Œåˆ™æ¸…ç†æœ€è€çš„ç¼“å­˜private int size; FifoCache.getObject()å’ŒremoveObject()æ–¹æ³•çš„å®ç°éƒ½æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚Cacheå¯¹è±¡çš„å¯¹åº”æ–¹æ³•ã€‚ åœ¨FifoCache.putObject()æ–¹æ³•ä¸­ä¼šå®Œæˆç¼“å­˜é¡¹ä¸ªæ•°çš„æ£€æµ‹ä»¥åŠç¼“å­˜çš„æ¸…ç†æ“ä½œã€‚ public void putObject(Object key, Object value) &#123; // æ£€æµ‹å¹¶æ¸…ç†ç¼“å­˜ cycleKeyList(key); // æ·»åŠ ç¼“å­˜é¡¹ delegate.putObject(key, value);&#125;private void cycleKeyList(Object key) &#123; // è®°å½•key keyList.addLast(key); if (keyList.size() &gt; size) &#123; // å¦‚æœè¾¾åˆ°ç¼“å­˜ä¸Šé™ï¼Œåˆ™æ¸…ç†æœ€è€çš„ç¼“å­˜é¡¹ Object oldestKey = keyList.removeFirst(); delegate.removeObject(oldestKey); &#125;&#125; LruCacheæ˜¯æŒ‰ç…§è¿‘æœŸæœ€å°‘ä½¿ç”¨ç®—æ³•**(LeastRecentlyUsedï¼ŒLRU)**è¿›è¡Œç¼“å­˜æ¸…ç†çš„è£…é¥°å™¨ï¼Œåœ¨éœ€è¦æ¸…ç†ç¼“å­˜æ—¶,å®ƒä¼šæ¸…é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜é¡¹ã€‚ // è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡private final Cache delegate;// LinkedHashMap&lt;Object,Object&gt;ç±»å‹å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åºçš„HashMapï¼Œç”¨äºè®°å½•keyæœ€è¿‘çš„ä½¿ç”¨æƒ…å†µprivate Map&lt;Object, Object&gt; keyMap;// è®°å½•æœ€å°‘è¢«ä½¿ç”¨çš„ç¼“å­˜é¡¹çš„keyprivate Object eldestKey; LruCacheçš„æ„é€ å‡½æ•°ä¸­é»˜è®¤è®¾ç½®çš„ç¼“å­˜å¤§å°æ˜¯1024,æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶setSize()æ–¹æ³•é‡æ–°è®¾ç½®ç¼“å­˜å¤§å° public void setSize(final int size) &#123; // é‡æ–°è®¾ç½®ç¼“å­˜å¤§å°çš„æ—¶å€™ï¼Œ ä¼šå……å€¼keyMapå­—æ®µ // LinkedHashMapæ„é€ å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œtrueè¡¨ç¤ºè¯¥LinkedHashMapè®°å½•çš„é¡ºåºæ˜¯ // access-order,ä¹Ÿå°±æ˜¯è¯´LinkedHashMap.get()æ–¹æ³•ä¼šæ”¹å˜å…¶è®°å½•çš„é¡ºåº keyMap = new LinkedHashMap&lt;Object, Object&gt;(size, .75F, true) &#123; private static final long serialVersionUID = 4267176411845948333L; // å½“è°ƒç”¨LinkedHashMap.put()æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³• @Override protected boolean removeEldestEntry(Map.Entry&lt;Object, Object&gt; eldest) &#123; boolean tooBig = size() &gt; size; if (tooBig) &#123; // å¦‚æœå·²åˆ°è¾¾ç¼“å­˜ä¸Šé™ï¼Œåˆ™æ›´æ–°eldestKeyå­—æ®µï¼Œåé¢ä¼šåˆ é™¤è¯¥é¡¹ eldestKey = eldest.getKey(); &#125; return tooBig; &#125; &#125;;&#125; LruCache.getObject()æ–¹æ³•é™¤äº†è¿”å›ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šè°ƒç”¨keyMap.get()æ–¹æ³•ä¿®æ”¹keyçš„é¡ºåºï¼Œè¡¨ç¤ºæŒ‡å®šçš„keyæœ€è¿‘è¢«ä½¿ç”¨ã€‚ LruCache.putObject()æ–¹æ³•é™¤äº†æ·»åŠ ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šå°†eldestKeyå­—æ®µæŒ‡å®šçš„ç¼“å­˜é¡¹æ¸…é™¤æ‰ã€‚ @Overridepublic void putObject(Object key, Object value) &#123; // ä¿®æ”¹LinkedHashMapä¸­è®°å½•çš„é¡ºåº delegate.putObject(key, value); cycleKeyList(key);&#125;@Overridepublic Object getObject(Object key) &#123; keyMap.get(key); //touch // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ç¼“å­˜é¡¹ return delegate.getObject(key);&#125;private void cycleKeyList(Object key) &#123; keyMap.put(key, key); if (eldestKey != null) &#123; // eldestKeyä¸ä¸ºç©ºï¼Œå³ç¼“å­˜å·²è¾¾åˆ°ä¸Šé™ // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ç¼“å­˜ delegate.removeObject(eldestKey); eldestKey = null; &#125;&#125; SoftCache&amp;WeakCacheå…ˆäº†è§£ä¸€ä¸‹Javaæä¾›çš„4ç§å¼•ç”¨ç±»å‹ã€‚ SoftCacheä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰ï¼š // ReferenceQueueï¼Œå¼•ç”¨é˜Ÿåˆ—ï¼Œç”¨äºè®°å½•å·²ç»è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹æ‰€å¯¹åº”çš„SoftEntryå¯¹è±¡private final Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;// åœ¨SoftCacheä¸­ï¼Œæœ€è¿‘ä½¿ç”¨çš„ä¸€éƒ¨åˆ†ç¼“å­˜é¡¹ä¸ä¼šè¢«GCå›æ”¶ï¼Œè¿™å°±æ˜¯é€šè¿‡å°†å…¶valueæ·»åŠ åˆ°// hardLinksToAvoidGarbageCollectioné›†åˆä¸­å®ç°çš„(å³æœ‰å¼ºå¼•ç”¨æŒ‡å‘å…¶value)// hardLinksToAvoidGarbageCollectioné›†åˆæ˜¯LinkedList&lt;Object&gt;ç±»å‹private final ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;// åº•å±‚è¢«è£…é¥°çš„åº•å±‚Cacheå¯¹è±¡private final Cache delegate;// å¼ºè¿æ¥çš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯256private int numberOfHardLinks; SoftCacheä¸­ç¼“å­˜é¡¹çš„valueæ˜¯SoftEntryå¯¹è±¡ï¼ŒSoftEntryç»§æ‰¿äº†SoftReferenceï¼Œå…¶ä¸­æŒ‡å‘keyçš„å¼•ç”¨æ˜¯å¼ºå¼•ç”¨ï¼Œè€ŒæŒ‡å‘valueçš„å¼•ç”¨æ˜¯è½¯å¼•ç”¨ã€‚ private static class SoftEntry extends SoftReference&lt;Object&gt; &#123; private final Object key; SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123; super(value, garbageCollectionQueue); // æŒ‡å‘valueçš„å¼•ç”¨æ˜¯è½¯å¼•ç”¨ï¼Œä¸”å…³è”äº†å¼•ç”¨é˜Ÿåˆ— this.key = key; // å¼ºå¼•ç”¨ &#125;&#125; SoftCache.putObject()æ–¹æ³•é™¤äº†å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šæ¸…é™¤å·±ç»è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹,å…¶å…·ä½“å®ç°å¦‚ä¸‹: public void putObject(Object key, Object value) &#123; // æ¸…é™¤å·²è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹ removeGarbageCollectedItems(); // å‘ç¼“å­˜ä¸­æ·»åŠ ç¼“å­˜é¡¹ delegate.putObject(key, new SoftEntry(key, value, queueOfGarbageCollectedEntries));&#125;private void removeGarbageCollectedItems() &#123; SoftEntry sv; // éå†queueOfGarbageCollectedEntriesé›†åˆ while ((sv = (SoftEntry) queueOfGarbageCollectedEntries.poll()) != null) &#123; // å°†å·²ç»è¢«GCå›æ”¶çš„valueå¯¹è±¡å¯¹åº”çš„ç¼“å­˜é¡¹æ¸…é™¤ delegate.removeObject(sv.key); &#125;&#125; SoftCache.getObject()æ–¹æ³•é™¤äº†ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„value,å¤„ç†è¢«GCå›æ”¶çš„valueå¯¹åº”çš„ç¼“å­˜é¡¹ï¼Œè¿˜ä¼šæ›´æ–°hardLinksToAvoidGarbageCollectioné›†åˆ public Object getObject(Object key) &#123; Object result = null; @SuppressWarnings(&quot;unchecked&quot;) // assumed delegate cache is totally managed by this cache // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç¼“å­˜é¡¹ SoftReference&lt;Object&gt; softReference = (SoftReference&lt;Object&gt;) delegate.getObject(key); if (softReference != null) &#123; // æ£€æµ‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„ç¼“å­˜é¡¹ result = softReference.get(); // è·å–SoftReferenceå¼•ç”¨çš„value if (result == null) &#123;// å·²ç»è¢«GCå›æ”¶ delegate.removeObject(key); // ä»ç¼“å­˜ä¸­æ¸…é™¤å¯¹åº”çš„ç¼“å­˜é¡¹ &#125; else &#123; // æœªè¢«GCå›æ”¶ // See #586 (and #335) modifications need more than a read lock synchronized (hardLinksToAvoidGarbageCollection) &#123; // ç¼“å­˜é¡¹çš„valueæ·»åŠ åˆ°hardLinksToAvoidGarbageCollectioné›†åˆä¸­ä¿å­˜ hardLinksToAvoidGarbageCollection.addFirst(result); if (hardLinksToAvoidGarbageCollection.size() &gt; numberOfHardLinks) &#123; // è¶…è¿‡numberOfHardLinksï¼Œåˆ™å°†æœ€è€çš„ç¼“å­˜é¡¹ä»hardLinksToAvoidGarbageCollectioné›†åˆä¸­æ¸…é™¤ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ— hardLinksToAvoidGarbageCollection.removeLast(); &#125; &#125; &#125; &#125; return result;&#125; SoftCache.removeObject()æ–¹æ³•åœ¨æ¸…é™¤ç¼“å­˜é¡¹ä¹‹å‰ï¼Œä¹Ÿä¼šè°ƒç”¨removeGarbageCollectedItems()æ–¹æ³•æ¸…ç†è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹ã€‚ SoftCache.clear()æ–¹æ³•é¦–å…ˆæ¸…ç†hardLinksToAvoidGarbageCollectioné›†åˆï¼Œç„¶åæ¸…ç†è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹ï¼Œæœ€åæ¸…ç†åº•å±‚delegateç¼“å­˜ä¸­çš„ç¼“å­˜é¡¹ã€‚ public void clear() &#123; synchronized (hardLinksToAvoidGarbageCollection) &#123; hardLinksToAvoidGarbageCollection.clear(); // æ¸…ç†å¼ºå¼•ç”¨é›†åˆ &#125; removeGarbageCollectedItems(); // æ¸…ç†è¢«GCå›æ”¶çš„ç¼“å­˜é¡¹ delegate.clear(); // æ¸…ç†åº•å±‚delegateç¼“å­˜ä¸­çš„ç¼“å­˜é¡¹&#125; WeakCacheçš„å®ç°ä¸SoftCacheåŸºæœ¬ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºå…¶ä¸­ä½¿ç”¨WeakEntry(ç»§æ‰¿è‡ªWeakReference)å°è£…çœŸæ­£çš„valueå¯¹è±¡ï¼Œå…¶ä»–å®ç°å®Œå…¨ä¸€æ ·ã€‚ othersScheduledCacheæ˜¯å‘¨æœŸæ€§æ¸…ç†ç¼“å­˜çš„è£…é¥°å™¨ï¼Œå®ƒçš„clearlntervalå­—æ®µè®°å½•äº†ä¸¤æ¬¡ç¼“å­˜æ¸…ç†ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯ä¸€å°æ—¶ï¼ŒlastClearå­—æ®µè®°å½•äº†æœ€è¿‘ä¸€æ¬¡æ¸…ç†çš„æ—¶é—´æˆ³ã€‚ ScheduledCacheçš„getObject()ã€putObject()ã€removeObject()ç­‰æ ¸å¿ƒæ–¹æ³•åœ¨æ‰§è¡Œæ—¶ï¼Œéƒ½ä¼šæ ¹æ®è¿™ä¸¤ä¸ªå­—æ®µæ£€æµ‹æ˜¯å¦éœ€è¦è¿›è¡Œæ¸…ç†æ“ä½œï¼Œæ¸…ç†æ“ä½œä¼šæ¸…ç©ºç¼“å­˜ä¸­æ‰€æœ‰ç¼“å­˜é¡¹ã€‚ LoggingCacheåœ¨Cacheçš„åŸºç¡€ä¸Šæä¾›äº†æ—¥å¿—åŠŸèƒ½ï¼Œå®ƒé€šè¿‡hitå­—æ®µå’Œrequestå­—æ®µè®°å½•äº†Cacheçš„å‘½ä¸­æ¬¡æ•°å’Œè®¿é—®æ¬¡æ•°ã€‚ åœ¨LoggingCache.getObject()æ–¹æ³•ä¸­ä¼šç»Ÿè®¡å‘½ä¸­æ¬¡æ•°å’Œè®¿é—®æ¬¡æ•°è¿™ä¸¤ä¸ªæŒ‡æ ‡ï¼Œå¹¶æŒ‰ç…§æŒ‡å®šçš„æ—¥å¿—è¾“å‡ºæ–¹å¼è¾“å‡ºå‘½ä¸­ç‡ã€‚ SynchronizedCacheé€šè¿‡åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šæ·»åŠ synchronizedå…³é”®å­—ï¼Œä¸ºCacheæ·»åŠ äº†åŒæ­¥åŠŸèƒ½ï¼Œæœ‰ç‚¹ç±»ä¼¼äºJDKä¸­Collectionsä¸­çš„SynchronizedCollectionå†…éƒ¨ç±»çš„å®ç°ã€‚ SerializedCacheæä¾›äº†å°†valueå¯¹è±¡åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚ SerializedCacheåœ¨æ·»åŠ ç¼“å­˜é¡¹æ—¶ï¼Œä¼šå°†valueå¯¹åº”çš„Javaå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œå¹¶å°†åºåˆ—åŒ–åçš„byte[]æ•°ç»„ä½œä¸ºvalueå­˜å…¥ç¼“å­˜ã€‚ SerializedCacheåœ¨è·å–ç¼“å­˜é¡¹æ—¶ï¼Œä¼šå°†ç¼“å­˜é¡¹ä¸­çš„byte[]æ•°ç»„ååºåˆ—åŒ–æˆJavaå¯¹è±¡ã€‚ ä½¿ç”¨å‰é¢ä»‹ç»çš„Cacheè£…é¥°å™¨å®ç°è¿›è¡Œè£…é¥°ä¹‹åï¼Œæ¯æ¬¡ä»ç¼“å­˜ä¸­è·å–åŒä¸€keyå¯¹åº”çš„å¯¹è±¡æ—¶ï¼Œå¾—åˆ°çš„éƒ½æ˜¯åŒä¸€å¯¹è±¡ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹è¯¥å¯¹è±¡éƒ½ä¼šå½±å“åˆ°å…¶ä»–çº¿ç¨‹ä»¥åŠç¼“å­˜ä¸­çš„å¯¹è±¡ï¼›è€ŒSerializedCacheæ¯æ¬¡ä»ç¼“å­˜ä¸­è·å–æ•°æ®æ—¶ï¼Œéƒ½ä¼šé€šè¿‡ååºåˆ—åŒ–å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ã€‚**SerializedCacheä½¿ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JavaåŸç”Ÿåºåˆ—åŒ–ã€‚** CacheKeyåœ¨Cacheä¸­å”¯ä¸€ç¡®å®šä¸€ä¸ªç¼“å­˜é¡¹éœ€è¦ä½¿ç”¨ç¼“å­˜é¡¹çš„key,MyBatisä¸­å› ä¸ºæ¶‰åŠåŠ¨æ€SQLç­‰å¤šæ–¹é¢å› ç´ ï¼Œå…¶ç¼“å­˜é¡¹çš„keyä¸èƒ½ä»…ä»…é€šè¿‡ä¸€ä¸ªStringè¡¨ç¤ºï¼Œæ‰€ä»¥MyBatisæä¾›äº†CacheKeyç±»æ¥è¡¨ç¤ºç¼“å­˜é¡¹çš„keyï¼Œåœ¨ä¸€ä¸ªCacheKeyå¯¹è±¡ä¸­å¯ä»¥å°è£…å¤šä¸ªå½±å“ç¼“å­˜é¡¹çš„å› ç´ ã€‚ CacheKeyä¸­å¯ä»¥æ·»åŠ å¤šä¸ªå¯¹è±¡ï¼Œç”±è¿™äº›å¯¹è±¡å…±åŒç¡®å®šä¸¤ä¸ªCacheKeyå¯¹è±¡æ˜¯å¦ç›¸åŒã€‚ // å‚ä¸è®¡ç®—hashcodeï¼Œé»˜è®¤å€¼37private final int multiplier;// CacheKeyçš„hashcodeï¼Œåˆå§‹å€¼æ˜¯37private int hashcode;// æ ¡éªŒå’Œprivate long checksum;// updateListé›†åˆçš„ä¸ªæ•°private int count;// ç”±è¯¥é›†åˆä¸­çš„æ‰€æœ‰å¯¹è±¡å…±åŒå†³å®šä¸¤ä¸ªCacheKeyæ˜¯å¦ç›¸åŒprivate List&lt;Object&gt; updateList; åœ¨å‘CacheKey.updateListé›†åˆä¸­æ·»åŠ å¯¹ è±¡æ—¶ ï¼Œä½¿ç”¨çš„æ˜¯CacheKey.update()æ–¹æ³•ï¼š public void update(Object object) &#123; int baseHashCode = object == null ? 1 : ArrayUtil.hashCode(object); // é‡æ–°è®¡ç®—countã€checksumå’Œhashcodeçš„å€¼ count++; checksum += baseHashCode; baseHashCode *= count; hashcode = multiplier * hashcode + baseHashCode; // å°†objectæ·»åŠ åˆ°updateListé›†åˆä¸­ updateList.add(object);&#125; å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”bindingæ¨¡å—","date":"2019-10-30T01:09:42.000Z","path":"2019/10/30/e275ec7f.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„bindingæ¨¡å— åœ¨ iBatis (MyBatis çš„å‰èº«)ä¸­ï¼ŒæŸ¥ è¯¢ ä¸€ä¸ª Blog å¯¹ è±¡æ—¶ éœ€è¦è°ƒ ç”¨ SqlSession.queryForObject (&quot;selectBlog&quot;, blogld)æ–¹æ³•ã€‚ å…¶ä¸­ï¼ŒSqlSession.queryForObject()æ–¹æ³•ä¼š æ‰§ è¡ŒæŒ‡å®šçš„ SQL è¯­ å¥è¿› è¡Œ æŸ¥ è¯¢ å¹¶ è¿”å›ä¸€ä¸ª ç»“ æœå¯¹ è±¡ï¼Œç¬¬ä¸€ä¸ª å‚ æ•° selectBlogæŒ‡æ˜äº†å…·ä½“ æ‰§ è¡Œçš„SQLè¯­ å¥çš„id,è¯¥ SQL è¯­ å¥å®šä¹‰ åœ¨ç›¸åº” çš„æ˜ å°„é…ç½®æ–‡ä»¶ä¸­ã€‚ å¦‚æœæˆ‘ä»¬ é”™ å°† selectBlogå†™ æˆäº† selectBloglï¼Œåœ¨åˆå§‹ åŒ–è¿‡ ç¨‹ä¸­ï¼ŒMyBatisæ˜¯æ— æ³•æç¤ºè¯¥ é”™ è¯¯ çš„ï¼Œè€Œåœ¨å® é™… è°ƒ ç”¨queryForObject(selectBlog1ï¼Œblogld) æ–¹æ³•æ—¶æ‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼€å‘äººå‘˜æ‰èƒ½çŸ¥é“è¯¥é”™è¯¯ã€‚ MyBatisæä¾›äº† bindingæ¨¡å— ç”¨äºè§£å†³ ä¸Šè¿°é—® é¢˜ ï¼Œæˆ‘ä»¬ å¯ä»¥å®šä¹‰ ä¸€ä¸ª Mapperæ¥å£ï¼Œè¯¥ ç¤ºä¾‹ä¸­ä¸º BlogMapperæ¥å£ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹æ‰€ç¤ºã€‚ è¿™ é‡Œçš„ BlogMapperæ¥å£å¹¶ ä¸éœ€è¦ç»§ æ‰¿ä»»ä½•å…¶ä»–æ¥å£ï¼Œè€Œä¸”å¼€ å‘ äººå‘˜ ä¸éœ€è¦æä¾›è¯¥ æ¥å£çš„å® ç° ã€‚ public interface BlogMapper &#123; // åœ¨æ˜ å°„æ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ª&lt;select&gt;æ¥å£ï¼Œidä¸º selectById public Blog selectById(int id);&#125; è¯¥ Mapperæ¥å£ä¸­å®šä¹‰ äº† SQLè¯­ å¥å¯¹ åº” çš„æ–¹æ³•ï¼Œè¿™ äº›æ–¹æ³•åœ¨MyBatisåˆå§‹åŒ–è¿‡ ç¨‹ä¸­ä¼š ä¸ æ˜  å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ çš„SQLè¯­ å¥ç›¸å…³ è” ã€‚å¦‚æœå­˜åœ¨æ— æ³•å…³ è” çš„SQLè¯­ å¥ï¼Œåœ¨ MyBatisçš„åˆå§‹åŒ– èŠ‚ ç‚¹å°±ä¼š æŠ›å‡ºå¼‚ å¸¸ã€‚ æˆ‘ä»¬å¯ä»¥è°ƒ ç”¨Mapperæ¥å£ä¸­çš„æ–¹æ³•æ‰§ è¡Œç›¸åº” çš„SQLè¯­ å¥ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬ææ—©å‘ç°ä¸Šè¿°é—®é¢˜ ã€‚ æŸ¥è¯¢blogï¼š blogMapper mapp = session.getMapper(BlogMapper.class);Blog blog = mapp.selectById(1); bindingæ¨¡å—æ ¸å¿ƒç»„ä»¶ MapperRegistry&amp;MapperProxyFactoryMapperRegistryMapperRegistryæ˜¯ Mapperæ¥å£åŠå…¶å¯¹ åº” çš„ä»£ç†å¯¹ è±¡å·¥å‚ çš„æ³¨å†Œ ä¸­å¿ƒã€‚Configurationæ˜¯ MyBatiså…¨å±€æ€§çš„é…ç½®å¯¹ è±¡ï¼Œåœ¨ MyBatisåˆå§‹åŒ–çš„è¿‡ ç¨‹ä¸­ï¼Œæ‰€æœ‰é…ç½®ä¿¡æ¯ä¼š è¢«è§£ææˆç›¸åº” çš„å¯¹ è±¡å¹¶ è®° å½• åˆ°Configurationå¯¹ è±¡ä¸­ã€‚è¿™ é‡Œ å…³ æ³¨ Configuration.mapperRegistryå­— æ®µ ï¼Œ å®ƒ è®° å½• å½“ å‰ ä½¿ ç”¨ çš„ MapperRegistryå¯¹ è±¡ ã€‚ MapperRegistryä¸­å­—æ®µåŠå«ä¹‰ // Configurationå¯¹è±¡ï¼ŒMyBatisä¸­å…¨å±€å”¯ä¸€çš„é…ç½®å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰é…ç½®ä¿¡æ¯private final Configuration config;// è®°å½•Mapperæ¥å£ä¸å¯¹åº”MapperRegistryä¹‹é—´çš„å…³ç³»private final Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = new HashMap&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;(); åœ¨ MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­è¯»å–æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠMapperæ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ï¼Œå¹¶ è°ƒ ç”¨ MapperRegistry.addMapper()æ–¹ æ³• å¡« å…… MapperRegistry.knownMappers é›† åˆ ï¼Œ è¯¥ é›† åˆ çš„ key æ˜¯ Mapperæ¥å£å¯¹ åº” çš„Classå¯¹ è±¡ï¼Œvalueä¸º MapperProxyFactoryå·¥å‚ å¯¹ è±¡ï¼Œå¯ä»¥ä¸º Mapperæ¥å£åˆ› å»ºä»£ç†å¯¹ è±¡ã€‚MapperRegistry.addMapper()æ–¹æ³•çš„ éƒ¨åˆ†å® ç° å¦‚ä¸‹: public &lt;T&gt; void addMapper(Class&lt;T&gt; type) &#123; if (type.isInterface()) &#123; // æ£€æµ‹typeæ˜¯å¦ä¸ºæ¥å£ if (hasMapper(type)) &#123; // å¦‚æœå·²ç»æ·»åŠ æœè¯¥æ¥å£ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ throw new BindingException(&quot;...&quot;); &#125; boolean loadCompleted = false; try &#123; // Mapperæ¥å£å¯¹åº”çš„Classå¯¹è±¡å’ŒMapperProxyFactoryå¯¹è±¡æ·»åŠ åˆ°knownMappersé›†åˆ knownMappers.put(type, new MapperProxyFactory&lt;T&gt;(type)); // It&#x27;s important that the type is added before the parser is run // otherwise the binding may automatically be attempted by the // mapper parser. If the type is already known, it won&#x27;t try. // XMLè§£æå’Œæ³¨è§£å¤„ç† MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type); parser.parse(); loadCompleted = true; &#125; finally &#123; if (!loadCompleted) &#123; knownMappers.remove(type); &#125; &#125; &#125;&#125; åœ¨éœ€è¦æ‰§ è¡ŒæŸSQLè¯­ å¥æ—¶ ï¼Œä¼š å…ˆè°ƒ ç”¨MapperRegistry.getMapper()æ–¹æ³•è· å–å® ç° äº† Mapper æ¥å£çš„ä»£ç†å¯¹ è±¡ï¼Œä¾‹å¦‚æœ¬èŠ‚ å¼€ å§‹çš„ç¤ºä¾‹ä¸­ï¼Œsession.getMapper(BlogMapper.class)æ–¹æ³•å¾—åˆ°çš„å® é™… ä¸Š æ˜¯ MyBatisé€š è¿‡ JDKåŠ¨ æ€ ä»£ ç† ä¸º BlogMapperæ¥ å£ ç”Ÿ æˆ çš„ ä»£ ç† å¯¹ è±¡ ã€‚MapperRegistry.getMapper() æ–¹æ³•çš„ä»£ç  å¦‚ä¸‹ã€‚ public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123; // æŸ¥æ‰¾æŒ‡å®štypeçš„MapperProxyFactoryå¯¹è±¡ final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type); if (mapperProxyFactory == null) &#123; throw new BindingException(&quot;...&quot;); &#125; try &#123; // åˆ›å»ºå®ç°äº†typeæ¥å£çš„ä»£ç†å¯¹è±¡ return mapperProxyFactory.newInstance(sqlSession); &#125; catch (Exception e) &#123; throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e); &#125;&#125; MapperProxyFactoryMapperProxyFactoryä¸»è¦è´Ÿ è´£ åˆ› å»ºä»£ç†å¯¹ è±¡ï¼Œå…¶ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å’ŒåŠŸèƒ½å¦‚ä¸‹ // å½“å‰MapperProxyFactoryå¯¹è±¡å¯ä»¥åˆ›å»ºå®ç°äº†mapperlnterfaceæ¥å£çš„ä»£ç†å¯¹è±¡private final Class&lt;T&gt; mapperInterface;// ç¼“å­˜ï¼Œkeyæ˜¯mapperlnterfaceæ¥å£ä¸­æŸæ–¹æ³•å¯¹åº”çš„Methodå¯¹è±¡ï¼Œvalueæ˜¯å¯¹åº”çš„MapperMethodå¯¹è±¡private final Map&lt;Method, MapperMethod&gt; methodCache = new ConcurrentHashMap&lt;Method, MapperMethod&gt;(); MapperProxyFactory.newInstance()æ–¹æ³•å®ç°äº†åˆ›å»ºå®ç°äº†mapperlnterface æ¥å£çš„ä»£ç†å¯¹è±¡çš„åŠŸèƒ½ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹: protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123; // åˆ›å»ºä»£ç†å¯¹è±¡ return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);&#125;public T newInstance(SqlSession sqlSession) &#123; // åˆ›å»ºMapperProxyå¯¹è±¡ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°çš„MapperProxyå¯¹è±¡ final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache); return newInstance(mapperProxy);&#125; MapperProxyMapperProxyå®ç°äº†InvocationHandleræ¥å£ï¼ŒInvocationHandleræ˜¯å®ç°JDKä»£ç†å¯¹è±¡çš„æ ¸å¿ƒé€»è¾‘ã€‚ MappProxyä¸­æ ¸å¿ƒå­—æ®µå«ä¹‰å’ŒåŠŸèƒ½ï¼š // è®°å½•äº†å…³è”çš„SqlSessionå¯¹è±¡private final SqlSession sqlSession;// mapperæ¥å£å¯¹åº”çš„classå¯¹è±¡private final Class&lt;T&gt; mapperInterface;// ç”¨äºç¼“å­˜MapperMethodå¯¹è±¡ï¼Œå…¶ä¸­keyæ˜¯Mapperæ¥å£ä¸­æ–¹æ³•å¯¹åº”çš„Methodå¯¹è±¡ï¼Œvalueæ˜¯å¯¹åº”çš„MapperMethodå¯¹è±¡// MapperMethodå¯¹è±¡ä¼šå®Œæˆå‚æ•°è½¬æ¢ä»¥åŠSQLè¯­å¥çš„æ‰§è¡ŒåŠŸèƒ½// MapperMethodä¸­å¹¶ä¸è®°å½•ä»»ä½•çŠ¶æ€ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å¤šä¸ªä»£ç†å¯¹è±¡ä¹‹é—´å…±äº«private final Map&lt;Method, MapperMethod&gt; methodCache; MapperProxy.invoke()æ–¹æ³•æ˜¯ä»£ç†å¯¹è±¡æ‰§è¡Œçš„ä¸»è¦é€»è¾‘ï¼Œå®ç°å¦‚ä¸‹: public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123; // å¦‚æœç›®æ ‡æ–¹æ³•ç»§æ‰¿è‡ªObjectï¼Œåˆ™ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³• if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, args); &#125; else if (isDefaultMethod(method)) &#123; // è¿™é‡Œæ˜¯é’ˆå¯¹java7ä»¥ä¸Šç‰ˆæœ¬åŠ¨æ€ç±»å‹è¯­è¨€çš„æ”¯æŒ return invokeDefaultMethod(proxy, method, args); &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; // ä»ç¼“å­˜ä¸­è·å–MapperMethodå¯¹è±¡ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºæ–°çš„MapperMethodå¯¹è±¡å¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ final MapperMethod mapperMethod = cachedMapperMethod(method); // æ‰§è¡ŒSQLè¯­å¥ return mapperMethod.execute(sqlSession, args);&#125; MapperProxy.cachedMapperMethod()æ–¹æ³•ä¸»è¦è´Ÿè´£ç»´æŠ¤methodCacheè¿™ä¸ªç¼“å­˜é›†åˆï¼š private MapperMethod cachedMapperMethod(Method method) &#123; // å…ˆä»ç¼“å­˜ä¸­è·å–MapperMethodå¯¹è±¡ MapperMethod mapperMethod = methodCache.get(method); if (mapperMethod == null) &#123; // ç¼“å­˜å°±çˆ±ä½ mapperMethodå¯¹è±¡å¹¶æ”¾åˆ°ç¼“å­˜ä¸­ mapperMethod = new MapperMethod(mapperInterface, method, sqlSession.getConfiguration()); methodCache.put(method, mapperMethod); &#125; return mapperMethod;&#125; MapperMethodMapperMethodä¸­å°è£…äº† Mapperæ¥å£ä¸­å¯¹åº”æ–¹æ³•çš„ä¿¡æ¯ï¼Œä»¥åŠå¯¹åº” SQLè¯­å¥çš„ä¿¡æ¯ã€‚ å¯ä»¥å°† MapperMethodçœ‹ä½œè¿æ¥ Mapperæ¥å£ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„SQLè¯­å¥çš„æ¡¥æ¢ã€‚ MapperMethodä¸­å„ä¸ªå­—æ®µçš„ä¿¡æ¯å¦‚ä¸‹: // è®°å½•SQLè¯­å¥å’Œç±»å‹private final SqlCommand command;// Mapperæ¥å£å¯¹åº”æ–¹æ³•çš„ä¿¡æ¯private final MethodSignature method; SqlCommandSqlCommandæ˜¯ MapperMethodä¸­å®šä¹‰ çš„å†… éƒ¨ç±» ,å®ƒ ä½¿ç”¨nameå­—æ®µè®° å½• äº† SQLè¯­ å¥çš„åç§° , ä½¿ç”¨typeå­— æ®µ (SqlCommandTypeç±» å‹)è®° å½• äº† SQLè¯­ å¥çš„ç±» å‹ã€‚ SqlCommandTypeæ˜¯æšä¸¾ç±»å‹ ï¼Œæœ‰æ•ˆå–å€¼ä¸ºUNKNOWNã€INSERTã€UPDATEã€DELETEã€SELECTã€FLUSHã€‚ SqlCommandçš„æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–nameå­—æ®µå’Œtypeå­—æ®µï¼Œä»£ç å¦‚ä¸‹: public SqlCommand(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123; final String methodName = method.getName(); final Class&lt;?&gt; declaringClass = method.getDeclaringClass(); MappedStatement ms = resolveMappedStatement(mapperInterface, methodName, declaringClass, configuration); if (ms == null) &#123; if (method.getAnnotation(Flush.class) != null) &#123; // @Flushå¤„ç† name = null; type = SqlCommandType.FLUSH; &#125; else &#123; throw new BindingException(&quot;...&quot;); &#125; &#125; else &#123; name = ms.getId(); type = ms.getSqlCommandType(); if (type == SqlCommandType.UNKNOWN) &#123; throw new BindingException(&quot;Unknown execution method for: &quot; + name); &#125; &#125;&#125;private MappedStatement resolveMappedStatement( Class&lt;?&gt; mapperInterface, String methodName, Class&lt;?&gt; declaringClass, Configuration configuration) &#123; // SQLè¯­å¥çš„åç§°æ˜¯ç”±Mapperæ¥å£çš„åç§°ä¸å¯¹åº”çš„æ–¹æ³•åç§°ç»„æˆçš„ String statementId = mapperInterface.getName() + &quot;.&quot; + methodName; if (configuration.hasStatement(statementId)) &#123; // æ£€æµ‹æ˜¯å¦æœ‰è¯¥åç§°çš„SQLè¯­å¥ // ä»Configuration.mappedStatementsé›†åˆä¸­æŸ¥æ‰¾å¯¹åº”çš„MappedStatementå¯¹è±¡ï¼Œ // MappedStatementå¯¹è±¡ä¸­å°è£…äº†SQLè¯­å¥ç›¸å…³çš„ä¿¡æ¯ï¼Œåœ¨MyBatisåˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œåé¢è¯¦ç»†æè¿° return configuration.getMappedStatement(statementId); &#125; else if (mapperInterface.equals(declaringClass)) &#123; return null; &#125; for (Class&lt;?&gt; superInterface : mapperInterface.getInterfaces()) &#123; // å¦‚æœæŒ‡å®šæ–¹æ³•æ˜¯åœ¨çˆ¶æ¥å£ä¸­å®šä¹‰çš„ï¼Œåˆ™åœ¨æ­¤è¿›è¡Œç»§æ‰¿ç»“æ„çš„å¤„ç† if (declaringClass.isAssignableFrom(superInterface)) &#123; // é€’å½’å¤„ç† MappedStatement ms = resolveMappedStatement(superInterface,methodName,declaringClass, configuration); if (ms != null) &#123; return ms; &#125; &#125; &#125; return null; &#125;&#125; ParamNameResolveråœ¨ MethodSignatureä¸­ ï¼Œä¼š ä½¿ ç”¨ ParamNameResolverå¤„ ç† Mapperæ¥ å£ ä¸­ å®š ä¹‰ çš„ æ–¹ æ³• çš„ å‚ æ•° åˆ— è¡¨ ã€‚ ParamNameResolver ä½¿ç”¨ name å­— æ®µ (SortedMap&lt;Integer, String&gt;ç±» å‹ )è®° å½• äº† å‚ æ•° åœ¨ å‚ æ•° åˆ—è¡¨ä¸­çš„ä½ç½®ç´¢å¼•ä¸ å‚ æ•° åç§° ä¹‹é—´ çš„å¯¹ åº” å…³ ç³»ï¼Œå…¶ä¸­keyè¡¨ç¤ºå‚ æ•° åœ¨å‚ æ•° åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œ valueè¡¨ç¤ºå‚ æ•° åç§° ï¼Œå‚ æ•° åç§° å¯ä»¥é€šè¿‡ @Paramæ³¨è§£æŒ‡å®šï¼Œå¦‚æœæ²¡ æœ‰æŒ‡å®š@Paramæ³¨è§£ï¼Œåˆ™ ä½¿ ç”¨å‚ æ•° ç´¢å¼•ä½œä¸º å…¶åç§° ã€‚ å¦‚æœå‚ æ•° åˆ—è¡¨ä¸­åŒ…å«RowBoundsç±» å‹ æˆ– ResultHandlerç±» å‹çš„å‚ æ•° ï¼Œ åˆ™ è¿™ ä¸¤ ç§ ç±» å‹çš„å‚ æ•° å¹¶ ä¸ä¼š è¢«è®° å½• åˆ°nameé›†åˆä¸­ï¼Œè¿™ å°±ä¼š å¯¼ è‡´å‚ æ•° çš„ç´¢å¼•ä¸ åç§° ä¸ä¸€è‡´ã€‚ ParamNameResolverçš„ hasParamAnnotationå­— æ®µ (booleanç±» å‹ )è®° å½• å¯¹ åº” æ–¹ æ³• çš„ å‚ æ•° åˆ— è¡¨ ä¸­æ˜¯å¦ä½¿ç”¨äº† @Paramæ³¨ è§£ ã€‚ åœ¨ ParamNameResolverçš„æ„ é€ æ–¹æ³•ä¸­ï¼Œä¼š é€šè¿‡ åå°„çš„æ–¹å¼è¯» å–Mapperæ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¹¶åˆå§‹åŒ–ä»¥ä¸Šå­—æ®µï¼š public ParamNameResolver(Configuration config, Method method) &#123; // è·å–å‚æ•°åˆ—è¡¨ä¸­æ¯ä¸ªå‚æ•°çš„ç±»å‹ final Class&lt;?&gt;[] paramTypes = method.getParameterTypes(); // è·å–å‚æ•°åˆ—è¡¨ä¸Šçš„æ³¨è§£ final Annotation[][] paramAnnotations = method.getParameterAnnotations(); // è®°å½•å‚æ•°ç´¢å¼•ä¸å‚æ•°åç§°çš„å¯¹åº”å…³ç³» final SortedMap&lt;Integer, String&gt; map = new TreeMap&lt;Integer, String&gt;(); int paramCount = paramAnnotations.length; // get names from @Param annotations for (int paramIndex = 0; paramIndex &lt; paramCount; paramIndex++) &#123; if (isSpecialParameter(paramTypes[paramIndex])) &#123; // skip special parameters // å¦‚æœå‚æ•°æ˜¯RowBoundsç±»å‹æˆ–ResultHandlerç±»å‹ï¼Œåˆ™è·³è¿‡å¯¹è¯¥å‚æ•°çš„åˆ†æ continue; &#125; String name = null; // éå†å‚æ•°å¯¹åº”çš„æ³¨è§£é›†åˆ for (Annotation annotation : paramAnnotations[paramIndex]) &#123; if (annotation instanceof Param) &#123; // å¦‚æœå‡ºç°è¿‡@Paramå°±æŠŠhasParamAnnotationåˆå§‹åŒ–ä¸ºtrue hasParamAnnotation = true; // è·å–@Paramæ³¨è§£æŒ‡å®šçš„å‚æ•°åç§° name = ((Param) annotation).value(); break; &#125; &#125; if (name == null) &#123; // @Param was not specified. if (config.isUseActualParamName()) &#123; name = getActualParamName(method, paramIndex); &#125; if (name == null) &#123; // use the parameter index as the name (&quot;0&quot;, &quot;1&quot;, ...) // gcode issue #71 name = String.valueOf(map.size()); &#125; &#125; map.put(paramIndex, name); &#125; names = Collections.unmodifiableSortedMap(map);&#125; namesé›†åˆä¸»è¦åœ¨ParamNameResolver.getNamedParams()æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œè¯¥ æ–¹æ³•æ¥æ”¶çš„å‚ æ•° æ˜¯ ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨ï¼Œå¹¶å°†å®å‚ä¸å…¶å¯¹åº”åç§°è¿›è¡Œå…³è”ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹: public Object getNamedParams(Object[] args) &#123; final int paramCount = names.size(); if (args == null || paramCount == 0) &#123; return null; &#125; else if (!hasParamAnnotation &amp;&amp; paramCount == 1) &#123; return args[names.firstKey()]; &#125; else &#123; final Map&lt;String, Object&gt; param = new ParamMap&lt;Object&gt;(); int i = 0; for (Map.Entry&lt;Integer, String&gt; entry : names.entrySet()) &#123; param.put(entry.getValue(), args[entry.getKey()]); // add generic param names (param1, param2, ...) final String genericParamName = GENERIC_NAME_PREFIX + String.valueOf(i + 1); // ensure not to overwrite parameter named with @Param if (!names.containsValue(genericParamName)) &#123; param.put(genericParamName, args[entry.getKey()]); &#125; i++; &#125; return param; &#125;&#125; MethodSignatureMethodSignature ä¹Ÿ æ˜¯ MapperMethodä¸­å®šä¹‰ çš„å†… éƒ¨ç±» ï¼Œå…¶ä¸­å°è£… äº† Mapperæ¥å£ä¸­å®šä¹‰ çš„æ–¹æ³•çš„ç›¸å…³ ä¿¡æ¯ï¼Œ MethodSignatureä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å¦‚ä¸‹: // è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸º Collectionç±»å‹æˆ–æ˜¯æ•°ç»„ç±»å‹private final boolean returnsMany;// è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºMapç±»å‹private final boolean returnsMap;// è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºVoidç±»å‹private final boolean returnsVoid;// è¿”å›ç±»å‹æ˜¯å¦ä¸ºCursorç±»å‹private final boolean returnsCursor;// è¿”å›å€¼ç±»å‹private final Class&lt;?&gt; returnType;// å¦‚æœè¿”å›å€¼ç±»å‹æ˜¯Mapï¼Œåˆ™è¯¥å­—æ®µè®°å½•äº†ä½œä¸ºkeyçš„åˆ—åprivate final String mapKey;// ç”¨æ¥æ ‡è®°è¯¥æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­ResultHandlerç±»å‹å‚æ•°çš„ä½ç½®private final Integer resultHandlerIndex;// ç”¨æ¥æ ‡è®°è¯¥æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­RowBoundsç±»å‹å‚æ•°çš„ä½ç½®private final Integer rowBoundsIndex;// æ–¹æ³•å¯¹åº”çš„ParamNameResolverå¯¹è±¡private final ParamNameResolver paramNameResolver; åœ¨ MethodSignatureçš„æ„ é€ å‡½æ•° ä¸­ä¼š è§£æç›¸åº” çš„Methodå¯¹ è±¡ï¼Œå¹¶ åˆå§‹åŒ–ä¸Šè¿°å­—æ®µï¼Œå…·ä½“ ä»£ ç  å¦‚ä¸‹: public MethodSignature (Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123; Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface); if (resolvedReturnType instanceof Class&lt;?&gt;) &#123; this.returnType = (Class&lt;?&gt;) resolvedReturnType; &#125; else if (resolvedReturnType instanceof ParameterizedType) &#123; this.returnType = (Class&lt;?&gt;) ((ParameterizedType) resolvedReturnType).getRawType(); &#125; else &#123; this.returnType = method.getReturnType(); &#125; this.returnsVoid = void.class.equals(this.returnType); this.returnsMany = configuration.getObjectFactory().isCollection(this.returnType) || this.returnType.isArray(); this.returnsCursor = Cursor.class.equals(this.returnType); // è‹¥MethodSignatureå¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ æ˜¯Mapä¸”æŒ‡å®šäº†@MapKeyæ³¨è§£ï¼Œåˆ™ ä½¿ç”¨getMapKey()æ–¹æ³•å¤„ ç† this.mapKey = getMapKey(method); this.returnsMap = this.mapKey != null; this.rowBoundsIndex = getUniqueParamIndex(method, RowBounds.class); this.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler.class); this.paramNameResolver = new ParamNameResolver(configuration, method);&#125; getUniqueParamIndex()æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯æŸ¥æ‰¾æŒ‡å®šç±»å‹çš„å‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚ private Integer getUniqueParamIndex(Method method, Class&lt;?&gt; paramType) &#123; Integer index = null; final Class&lt;?&gt;[] argTypes = method.getParameterTypes(); // éå†MethodSignatureå¯¹åº”æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ for (int i = 0; i &lt; argTypes.length; i++) &#123; if (paramType.isAssignableFrom(argTypes[i])) &#123; if (index == null) &#123; // è®°å½•paramTypeç±»å‹å‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®ç´¢å¼• index = i; &#125; else &#123; // RowBoundså’ŒResultHandlerç±»å‹çš„å‚æ•°åªèƒ½æœ‰ä¸€ä¸ªï¼Œä¸èƒ½é‡å¤å‡ºç° throw new BindingException(&quot;...&quot;); &#125; &#125; &#125; return index;&#125; convertArgsToSqlCommandParam()è¾…åŠ©æ–¹æ³•ï¼š // è´Ÿè´£å°†args[]æ•°ç»„(ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨)è½¬æ¢æˆSQLè¯­å¥å¯¹åº”çš„å‚æ•°åˆ—è¡¨ï¼Œå®ƒæ˜¯é€šè¿‡ä¸Šé¢ä»‹ç»çš„public Object convertArgsToSqlCommandParam(Object[] args) &#123; return paramNameResolver.getNamedParams(args);&#125; MapperMethod.execute()MapperMethodä¸­ æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯execute()æ–¹æ³•ï¼Œå®ƒ ä¼š æ ¹æ®SQLè¯­ å¥çš„ç±» å‹è°ƒ ç”¨SqlSessionå¯¹ åº” çš„æ–¹æ³•å®Œæˆæ•° æ® åº“ æ“ä½œï¼š public Object execute(SqlSession sqlSession, Object[] args) &#123; Object result; switch (command.getType()) &#123;// æ ¹æ®SQLè¯­å¥çš„ç±»å‹è°ƒç”¨SqlSessionå¯¹åº”çš„æ–¹æ³• case INSERT: &#123; // ä½¿ç”¨ParamNameResolverå¤„ç†args[]æ•°ç»„(ç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨)ï¼Œå°†ç”¨æˆ·ä¼ å…¥çš„å®å‚ä¸ // æŒ‡å®šå‚æ•°åç§°å…³è”èµ·æ¥ Object param = method.convertArgsToSqlCommandParam(args); // ç”¨SqlSession.insert()æ–¹æ³•ï¼ŒrowCountResult()æ–¹æ³•ä¼šæ ¹æ®methodå­—æ®µä¸­è®°å½•çš„æ–¹æ³•çš„ result = rowCountResult(sqlSession.insert(command.getName(), param)); break; &#125; case UPDATE: &#123; Object param = method.convertArgsToSqlCommandParam(args); result = rowCountResult(sqlSession.update(command.getName(), param)); break; &#125; case DELETE: &#123; Object param = method.convertArgsToSqlCommandParam(args); result = rowCountResult(sqlSession.delete(command.getName(), param)); break; &#125; case SELECT: // å¤„ç†è¿”å›å€¼ä¸ºVoidä¸”ResultSeté€šè¿‡ResultHandlerå¤„ç†çš„æ–¹æ³• if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123; executeWithResultHandler(sqlSession, args); result = null; &#125; else if (method.returnsMany()) &#123; // å¤„ç†è¿”å›å€¼ä¸ºé›†åˆæˆ–æ•°ç»„çš„ç±»å‹ result = executeForMany(sqlSession, args); &#125; else if (method.returnsMap()) &#123;// å¤„ç†è¿”å›å€¼ä¸ºMapçš„æ–¹æ³• result = executeForMap(sqlSession, args); &#125; else if (method.returnsCursor()) &#123; // ... result = executeForCursor(sqlSession, args); &#125; else &#123; // å¤„ç†è¿”å›å€¼ä¸ºå•ä¸€å¯¹è±¡çš„æ–¹æ³• Object param = method.convertArgsToSqlCommandParam(args); result = sqlSession.selectOne(command.getName(), param); &#125; break; case FLUSH: result = sqlSession.flushStatements(); break; default: throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName()); &#125; if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123; throw new BindingException(&quot;...&quot;); &#125; return result;&#125; æ‰§ è¡Œ INSERTã€UPDATEã€DELETEç±» å‹ çš„ SQLè¯­ å¥æ—¶ ï¼Œå…¶æ‰§ è¡Œç»“ æœéƒ½éœ€è¦ç» è¿‡MapperMethod.rowCountResult()æ–¹ æ³• å¤„ ç† ã€‚ SqlSession ä¸­ çš„ insert()ç­‰ æ–¹ æ³• è¿” å› çš„ æ˜¯ int å€¼ ï¼Œ rowCountResult()æ–¹æ³•ä¼š å°† è¯¥ intå€¼ è½¬ æ¢ æˆMapperæ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹: private Object rowCountResult(int rowCount) &#123; final Object result; if (method.returnsVoid()) &#123; result = null; &#125; else if (Integer.class.equals(method.getReturnType()) || Integer.TYPE.equals(method.getReturnType())) &#123; result = rowCount; &#125; else if (Long.class.equals(method.getReturnType()) || Long.TYPE.equals(method.getReturnType())) &#123; result = (long)rowCount; &#125; else if (Boolean.class.equals(method.getReturnType()) || Boolean.TYPE.equals(method.getReturnType())) &#123; result = rowCount &gt; 0; &#125; else &#123; throw new BindingException(&quot;...&quot;); &#125; return result;&#125; å¦‚ æœ Mapperæ¥å£ä¸­å®šä¹‰ çš„æ–¹æ³•å‡†å¤‡ ä½¿ç”¨ResultHandlerå¤„ ç†æŸ¥ è¯¢ ç»“ æœé›†ï¼Œåˆ™ é€šè¿‡ MapperMethod.executeWithResultHandler()æ–¹æ³•å¤„ ç†ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹: private void executeWithResultHandler(SqlSession sqlSession, Object[] args) &#123; // è· å–SQLè¯­ å¥å¯¹ åº” çš„MappedStatementå¯¹è±¡ MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(command.getName()); if (!StatementType.CALLABLE.equals(ms.getStatementType()) &amp;&amp; void.class.equals(ms.getResultMaps().get(0).getType())) &#123; throw new BindingException(&quot;...&quot;); &#125; Object param = method.convertArgsToSqlCommandParam(args); if (method.hasRowBounds()) &#123; RowBounds rowBounds = method.extractRowBounds(args); sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args)); &#125; else &#123; // è°ƒç”¨SqlSession.select()æ–¹æ³•ï¼Œæ‰§è¡ŒæŸ¥è¯¢ ï¼Œå¹¶ç”±æŒ‡å®šçš„ResultHandlerå¤„ç†ç»“æœå¯¹è±¡ sqlSession.select(command.getName(), param, method.extractResultHandler(args)); &#125;&#125; å¦‚ æœ Mapperæ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ä¸º æ•° ç»„ æˆ–æ˜¯Collectionæ¥å£å® ç° ç±» ï¼Œåˆ™ é€šè¿‡ MapperMethod.executeForMany()æ–¹ æ³• å¤„ ç† ï¼Œå…· ä½“ å® ç° å¦‚ ä¸‹ : private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object[] args) &#123; List&lt;E&gt; result; Object param = method.convertArgsToSqlCommandParam(args); if (method.hasRowBounds()) &#123; RowBounds rowBounds = method.extractRowBounds(args); // è°ƒç”¨SqlSession.selectList()æ–¹æ³•å®ŒæˆæŸ¥è¯¢ result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds); &#125; else &#123; result = sqlSession.&lt;E&gt;selectList(command.getName(), param); &#125; // issue #510 Collections &amp; arrays support if (!method.getReturnType().isAssignableFrom(result.getClass())) &#123; if (method.getReturnType().isArray()) &#123; return convertToArray(result); &#125; else &#123; return convertToDeclaredCollection(sqlSession.getConfiguration(), result); &#125; &#125; return result;&#125; convertToDeclaredCollection()æ–¹ æ³• å’Œ convertToArray()æ–¹ æ³• çš„ åŠŸ èƒ½ ç±» ä¼¼ ï¼Œä¸» è¦ è´Ÿ è´£ å°† ç»“ æœ å¯¹ è±¡è½¬ æ¢ æˆCollectioné›†åˆå¯¹ è±¡å’Œæ•° ç»„ å¯¹ è±¡ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹: private &lt;E&gt; Object convertToDeclaredCollection(Configuration config, List&lt;E&gt; list) &#123; // é€šè¿‡åå°„åˆ›å»ºé›†åˆå¯¹è±¡ Object collection = config.getObjectFactory().create(method.getReturnType()); // åˆ›å»ºMetaObjectå¯¹è±¡ MetaObject metaObject = config.newMetaObject(collection); metaObject.addAll(list); return collection;&#125;@SuppressWarnings(&quot;unchecked&quot;)private &lt;E&gt; Object convertToArray(List&lt;E&gt; list) &#123; Class&lt;?&gt; arrayComponentType = method.getReturnType().getComponentType(); Object array = Array.newInstance(arrayComponentType, list.size()); if (arrayComponentType.isPrimitive()) &#123; for (int i = 0; i &lt; list.size(); i++) &#123; Array.set(array, i, list.get(i)); &#125; return array; &#125; else &#123; return list.toArray((E[])array); &#125;&#125; å¦‚æœMapperæ¥å£ä¸­å¯¹ åº” æ–¹æ³•çš„è¿”å›å€¼ ä¸º Mapç±» å‹,åˆ™ é€šè¿‡ MapperMethod.executeForMap() æ–¹æ³•å¤„ç†ï¼Œå…·ä½“å®ç°å¦‚ä¸‹: private &lt;K, V&gt; Map&lt;K, V&gt; executeForMap(SqlSession sqlSession, Object[] args) &#123; Map&lt;K, V&gt; result; Object param = method.convertArgsToSqlCommandParam(args); if (method.hasRowBounds()) &#123; RowBounds rowBounds = method.extractRowBounds(args); result = sqlSession.&lt;K, V&gt;selectMap( command.getName(), param, method.getMapKey(), rowBounds); &#125; else &#123; result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey()); &#125; return result;&#125; executeForCursor()æ–¹æ³•ä¸ executeForMap()æ–¹æ³•ç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«å°±æ˜¯è°ƒ selectCursor()æ–¹æ³•ã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”Transaction","date":"2019-10-29T01:09:42.000Z","path":"2019/10/29/e275ec7f.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„Transactionæ¨¡å— åœ¨å® è·µ å¼€ å‘ ä¸­ï¼Œæ§åˆ¶æ•° æ®åº“ äº‹åŠ¡ æ˜¯ä¸€ä»¶éå¸¸é‡è¦çš„å·¥ä½œï¼ŒMyBatisä½¿ ç”¨ Transactionæ¥å£å¯¹æ•°æ®åº“äº‹åŠ¡è¿› è¡Œäº†æŠ½è±¡ï¼ŒTransactionæ¥å£çš„å®šä¹‰ å¦‚ä¸‹: public interface Transaction &#123; /** * è·å–å¯¹åº”çš„æ•°æ®åº“è¿æ¥ */ Connection getConnection() throws SQLException; /** * æäº¤äº‹åŠ¡ */ void commit() throws SQLException; /** * å›æ»šäº‹åŠ¡ */ void rollback() throws SQLException; /** * å…³é—­æ•°æ®åº“è¿æ¥ */ void close() throws SQLException; /** * è·å–äº‹åŠ¡è¶…æ—¶æ—¶é—´ */ Integer getTimeout() throws SQLException; &#125; Transaction æ¥ å£ æœ‰ JdbcTransactionã€ ManagedTransaction ä¸¤ ä¸ª å® ç° ï¼Œ å…¶ å¯¹ è±¡ åˆ† åˆ« ç”± JdbcTransactionFactoryå’Œ ManagedTransactionFactoryè´Ÿ è´£ åˆ› å»ºã€‚è¿™ é‡Œä¹Ÿä½¿ç”¨ å·¥å‚ æ–¹æ³•æ¨¡å¼ã€‚ JdbcTransactionJdbcTransactionä¾èµ–äº JDBC Connectionæ§åˆ¶äº‹åŠ¡çš„æäº¤å’Œå› æ»š ã€‚JdbcTransactionä¸­ å­— æ®µ çš„ å«ä¹‰ å¦‚ä¸‹: // äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“è¿æ¥protected Connection connection;// æ•°æ®åº“è¿æ¥æ‰€å±çš„DataSourceprotected DataSource dataSource;// äº‹åŠ¡éš”ç¦»çº§åˆ«protected TransactionIsolationLevel level;// æ˜¯å¦è‡ªåŠ¨æäº¤protected boolean autoCommmit; åœ¨ JdbcTransactionçš„æ„ é€ å‡½æ•° ä¸­ä¼š åˆå§‹åŒ–é™¤connectionå­—æ®µä¹‹å¤–çš„å…¶ä»–ä¸‰ä¸ª å­—æ®µï¼Œè€Œ connectionå­—æ®µä¼š å»¶è¿Ÿ åˆå§‹åŒ–ï¼Œå®ƒ ä¼š åœ¨è°ƒ ç”¨getConnection()æ–¹æ³•æ—¶ é€šè¿‡ dataSource.getConnection() æ–¹æ³•åˆå§‹åŒ–ï¼Œå¹¶ ä¸”åŒæ—¶ è®¾ ç½®autoCommitå’Œäº‹åŠ¡ éš”ç¦» çº§ åˆ« ã€‚ JdbcTransactionçš„ commit()æ–¹æ³•å’Œ rollback()æ–¹æ³•éƒ½ä¼š è°ƒ ç”¨Connectionå¯¹ åº” æ–¹æ³•å® ç° çš„ã€‚ ManagedTransactionManagedTransactionçš„å® ç° æ›´åŠ ç®€ å• ï¼Œå®ƒ åŒæ · ä¾èµ– å…¶ä¸­çš„dataSourceå­—æ®µè· å–è¿ æ¥ï¼Œä½†å…¶ commit()ã€rollback()æ–¹æ³•éƒ½æ˜¯ç©ºå® ç° ï¼Œäº‹åŠ¡ çš„æäº¤å’Œå›æ»š éƒ½æ˜¯ä¾é  å®¹å™¨ç®¡ç†çš„ã€‚ ManagedTransactionä¸­é€šè¿‡ closeConnectionå­—æ®µçš„å€¼ æ§åˆ¶æ•° æ®åº“ è¿ æ¥çš„å…³ é—­ è¡Œä¸º ã€‚ public void close() throws SQLException &#123; if (this.closeConnection &amp;&amp; this.connection != null) &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;Closing JDBC Connection [&quot; + this.connection + &quot;]&quot;); &#125; this.connection.close(); &#125;&#125; TransactionFactoryTransactionFactoryæ¥ å£ å®š ä¹‰ äº† é… ç½® æ–° å»º TransactionFactoryå¯¹ è±¡ çš„ æ–¹ æ³• ï¼Œ ä»¥ åŠ åˆ› å»º Transactionå¯¹ è±¡çš„æ–¹æ³•ï¼Œä»£ç  å¦‚ä¸‹: public interface TransactionFactory &#123; /** * é…ç½®TransactionFactoryå¯¹ è±¡ï¼Œä¸€èˆ¬ç´§ è·Ÿ åœ¨åˆ› å»ºå®Œæˆä¹‹åï¼Œå®Œæˆå¯¹ TransactionFactoryçš„è‡ªå®šä¹‰ é…ç½® */ void setProperties(Properties props); /** * åœ¨æŒ‡å®šçš„è¿ æ¥ä¸Šåˆ› å»ºTransactionå¯¹ è±¡ */ Transaction newTransaction(Connection conn); /** * ä» æŒ‡å®šæ•° æ®æºä¸­è· å–æ•° æ®åº“ è¿ æ¥ï¼Œå¹¶ åœ¨æ­¤è¿ æ¥ä¹‹ä¸Šåˆ› å»ºTransactionå¯¹ è±¡ */ Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit);&#125; JdbcTransactionFactory å’Œ ManagedTransactionFactory è´Ÿ è´£ åˆ› å»º JdbcTransaction å’Œ ManagedTransactionï¼Œè¿™ ä¸€éƒ¨åˆ†çš„ä»£ç  æ¯”è¾ƒ ç®€ å• ã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”DataSource","date":"2019-10-28T01:09:42.000Z","path":"2019/10/28/899df03d.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„DataSourceæ¨¡å— åœ¨æ•° æ®æŒä¹…å±‚ ä¸­ï¼Œæ•° æ®æºæ˜¯ä¸€ä¸ª éå¸¸é‡è¦çš„ç»„ ä»¶ï¼Œå…¶æ€§èƒ½ç›´æ¥å…³ ç³»åˆ°æ•´ä¸ª æ•° æ®æŒä¹…å±‚ çš„æ€§èƒ½ã€‚ åœ¨å® è·µ ä¸­æ¯”è¾ƒ å¸¸è§ çš„ç¬¬ä¸‰æ–¹æ•° æ®æºç»„ ä»¶æœ‰ApacheCommonDBCPã€C3P0ã€Proxoolç­‰ï¼ŒMyBatisä¸ä»… å¯ä»¥é›†æˆç¬¬ä¸‰æ–¹æ•° æ®æºç»„ ä»¶ï¼Œè¿˜ æä¾›äº†è‡ªå·±çš„æ•° æ®æºå® ç° ã€‚ å¸¸è§ çš„æ•° æ®æºç»„ ä»¶éƒ½å® ç° äº† javax.sql.DataSourceæ¥å£ï¼ŒMyBatisè‡ªèº«å® ç° çš„æ•° æ®æºå® ç° ä¹Ÿ ä¸ ä¾‹ å¤– ã€‚ MyBatis æ ä¾› äº† ä¸¤ ä¸ª javax.sql.DataSource æ¥ å£ å® ç° ï¼Œ åˆ† åˆ« æ˜¯ PooledDataSource å’Œ UnpooledDataSourceã€‚ Mybatisä½¿ ç”¨ ä¸ åŒ çš„ DataSourceFactoryæ¥ å£ å® ç° åˆ› å»º ä¸ åŒ ç±» å‹ çš„ DataSource,å¦‚å›¾æ‰€ç¤ºï¼Œè¿™ æ˜¯å·¥å‚ æ–¹æ³•æ¨¡å¼çš„ä¸€ä¸ª å…¸å‹åº” ç”¨ã€‚ å·¥å‚æ–¹æ³•æ¨¡å¼ åœ¨å·¥å‚ æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå®šä¹‰ äº†ä¸€ä¸ª ç”¨äºåˆ› å»ºå¯¹ è±¡çš„å·¥å‚ æ¥å£ï¼Œå¹¶ æ ¹æ®å·¥å‚ æ¥å£çš„å…·ä½“ å® ç° ç±» å†³å®šå…·ä½“å®ä¾‹åŒ–å“ªä¸€ä¸ªå…·ä½“äº§å“ç±»ã€‚é¦–å…ˆæ¥çœ‹å·¥å‚æ–¹æ³•æ¨¡å¼çš„UMLå›¾ï¼Œä»æ•´ä½“ä¸Šäº†è§£è¯¥æ¨¡å¼ çš„ç»“ æ„ ã€‚ å·¥å‚æ–¹æ³•æœ‰å››ä¸ªè§’è‰²æ„æˆï¼š å·¥å‚æ¥å£ï¼ˆFactoryï¼‰ å·¥å‚ æ¥å£æ˜¯å·¥å‚ æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒæ¥å£ï¼Œè°ƒ ç”¨è€…ä¼š ç›´æ¥ä¸ å·¥å‚ æ¥ å£äº¤äº’ç”¨äºè·å–å…·ä½“çš„äº§å“å®ç°ç±» å…·ä½“å·¥å‚ç±»ï¼ˆConcreteFactoryï¼‰ å…·ä½“ å·¥å‚ ç±» æ˜¯å·¥å‚ æ¥å£çš„å® ç° ç±» ï¼Œç”¨äºå® ä¾‹åŒ–äº§ å“ å¯¹è±¡ï¼Œä¸åŒçš„å…·ä½“å·¥å‚ç±»ä¼šæ ¹æ®éœ€æ±‚å®ä¾‹åŒ–ä¸åŒçš„äº§å“å®ç°ç±»ã€‚ äº§å“æ¥å£ï¼ˆProductï¼‰ å“æ¥å£ç”¨äºå®šä¹‰ äº§ å“ç±» çš„åŠŸèƒ½ï¼Œå…·ä½“ å·¥å‚ ç±» äº§ ç”Ÿçš„æ‰€æœ‰äº§ å“å¯¹è±¡éƒ½å¿…é¡»å®ç°è¯¥æ¥å£ã€‚è°ƒç”¨è€…ä¸€èˆ¬ä¼šé¢å‘äº§å“æ¥å£è¿›è¡Œç¼–ç¨‹ï¼Œæ‰€ä»¥äº§å“æ¥å£ä¼šä¸è°ƒç”¨è€…ç›´æ¥äº¤äº’ï¼Œä¹Ÿæ˜¯è°ƒ ç”¨è€…æœ€ä¸º å…³ å¿ƒçš„æ¥å£ã€‚ å…·ä½“ äº§ å“ç±» ï¼ˆConcreteProductï¼‰ ç° äº§ å“æ¥å£çš„å® ç° ç±» ï¼Œå…·ä½“ äº§ å“ç±» ä¸­å®šä¹‰ äº†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ å¦‚æœéœ€è¦äº§ ç”Ÿæ–°çš„äº§ å“ï¼Œä¾‹å¦‚å¯¹ äºMyBatisçš„æ•° æ®æºæ¨¡å— æ¥ è¯´ ï¼Œå°±æ˜¯æ·»åŠ æ–°çš„ç¬¬ä¸‰æ–¹æ•° æ® æºç»„ ä»¶ï¼Œåªéœ€è¦æ·»åŠ å¯¹ åº” çš„å·¥å‚ å® ç° ç±» ï¼Œæ–°æ•° æ®æºå°±å¯ä»¥è¢«MyBatisä½¿ç”¨ï¼Œè€Œä¸å¿…ä¿®æ”¹å·±æœ‰çš„ ä»£ç  ã€‚æ˜¾ ç„¶ï¼Œå·¥å‚ æ–¹æ³•æ¨¡å¼ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå·¥å‚ æ–¹æ³•ä¼š å‘è°ƒ ç”¨è€…éš è—å…·ä½“ äº§ å“ç±» çš„å® ä¾‹åŒ–ç»† èŠ‚ ï¼Œè°ƒ ç”¨è€…åªéœ€è¦äº†è§£å·¥å‚ æ¥å£å’Œäº§ å“æ¥å£ï¼Œé¢å‘è¿™ ä¸¤ ä¸ª æ¥å£ç¼– ç¨‹å³ å¯ã€‚ å·¥å‚ æ–¹æ³•æ¨¡å¼ä¹Ÿæ˜¯å­˜åœ¨ç¼ºç‚¹çš„ã€‚åœ¨å¢åŠ æ–°äº§ å“å® ç° ç±» æ—¶ ï¼Œè¿˜ è¦æä¾›ä¸€ä¸ª ä¸ ä¹‹å¯¹ åº” çš„å·¥å‚ å® ç° ç±» ï¼Œæ‰€ä»¥å® é™… æ–°å¢çš„ç±» æ˜¯æˆå¯¹ å‡ºç° çš„ï¼Œè¿™ å¢åŠ äº†ç³»ç»Ÿ çš„å¤ æ‚ åº¦ã€‚å¦ å¤–ï¼Œå·¥å‚ æ–¹æ³•æ¨¡å¼å¼•å…¥äº† å·¥å‚ æ¥å£å’Œäº§ å“æ¥å£è¿™ ä¸€å±‚ æŠ½è±¡ï¼Œè°ƒ ç”¨è€…é¢å‘è¯¥ æŠ½è±¡å±‚ ç¼– ç¨‹,å¢åŠ äº†ç¨‹åºçš„æŠ½è±¡æ€§å’Œç†è§£éš¾ åº¦ã€‚ DataSourceFactoryåœ¨æ•° æ®æºæ¨¡å— ä¸­ï¼ŒDataSourceFactoryæ¥å£æ‰®æ¼”å·¥å‚ æ¥å£çš„è§’è‰²ã€‚ UnpooledDataSourceFactory å’Œ PooledDataSourceFactoryåˆ™ æ‰®æ¼”ç€å…·ä½“ å·¥å‚ ç±» çš„è§’è‰²ã€‚ æˆ‘ä»¬ ä» DataSourceFactoryæ¥å£å¼€ å§‹åˆ† æï¼Œå…¶å®šä¹‰ å¦‚ä¸‹: public interface DataSourceFactory &#123; // è®¾ç½®DataSourceçš„ç›¸å…³å±æ€§ï¼Œä¸€èˆ¬ç´§è·Ÿåœ¨åˆå§‹åŒ–å®Œæˆä¹‹å void setProperties(Properties props); // è·å–DataSourceå¯¹è±¡ DataSource getDataSource();&#125; åœ¨ UnpooledDataSourceFactoryçš„ æ„ é€  å‡½ æ•° ä¸­ ä¼š ç›´ æ¥ åˆ› å»º UnpooledDataSourceå¯¹ è±¡ ï¼Œå¹¶ åˆå§‹ åŒ– UnpooledDataSourceFactory.dataSource å­— æ®µ ã€‚UnpooledDataSourceFactory.setProperties()æ–¹æ³•ä¼š å®Œæˆå¯¹ UnpooledDataSourceå¯¹ è±¡çš„é…ç½®ï¼Œä»£ç  å¦‚ä¸‹: public void setProperties(Properties properties) &#123; Properties driverProperties = new Properties(); // åˆ›å»ºDataSourceå¯¹åº”çš„MetaObject MetaObject metaDataSource = SystemMetaObject.forObject(dataSource); // éå†propertiesé›†åˆï¼Œè¯¥é›†åˆä¸­é…ç½®äº†æ•°æ®æºéœ€è¦çš„ä¿¡æ¯ for (Object key : properties.keySet()) &#123; String propertyName = (String) key; // ä»¥&quot;driver.&quot;å¼€å¤´çš„é…ç½®é¡¹æ˜¯å¯¹DateSourceçš„é…ç½®ï¼Œè®°å½•åˆ°driverPropertiesä¸­ä¿å­˜ if (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123; String value = properties.getProperty(propertyName); driverProperties.setProperty( propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value); &#125; else if (metaDataSource.hasSetter(propertyName)) &#123; String value = (String) properties.get(propertyName); Object convertedValue = convertValue(metaDataSource, propertyName, value); metaDataSource.setValue(propertyName, convertedValue); &#125; else &#123; throw new DataSourceException(&quot;...&quot;); &#125; &#125; if (driverProperties.size() &gt; 0) &#123; metaDataSource.setValue(&quot;driverProperties&quot;, driverProperties); &#125;&#125; UnpooledDataSourceFactory.getDataSource()æ–¹æ³•å® ç° æ¯”è¾ƒ ç®€ å• ï¼Œå®ƒ ç›´æ¥è¿”å› dataSourceå­—æ®µ è®° å½• çš„ UnpooledDataSource å¯¹ è±¡ ã€‚ PooledDataSourceFactory ç»§ æ‰¿ äº† UnpooledDataSourceFactory, ä½† å¹¶ æ²¡ æœ‰ è¦† ç›– setProperties() æ–¹æ³•å’ŒgetDataSource()æ–¹æ³•ã€‚ä¸¤ è€…å”¯ä¸€çš„åŒº åˆ« æ˜¯PooledDataSourceFactoryçš„æ„ é€ å‡½æ•° ä¼š å°† å…¶ dataSource å­— æ®µ åˆ å§‹ åŒ– ä¸º PooledDataSource å¯¹ è±¡ ã€‚ JndiDataSourceFactoryæ˜¯ä¾èµ– JNDIæœåŠ¡ ä» å®¹å™¨ä¸­è· å–ç”¨æˆ· é…ç½®çš„DataSourceï¼Œå…¶é€» è¾‘ å¹¶ ä¸ å¤ æ‚ ã€‚ UnpooledDataSourcejavax.sql.DataSourceæ¥å£åœ¨æ•° æ®æºæ¨¡å— ä¸­æ‰®æ¼”äº†äº§ å“æ¥å£çš„è§’è‰²ï¼ŒMyBatisæä¾›äº†ä¸¤ ä¸ª DataSourceæ¥ å£ çš„ å® ç° ç±» ï¼Œåˆ† åˆ« æ˜¯ UnpooledDataSourceå’Œ PooledDataSourceï¼Œå®ƒ ä»¬ æ‰® æ¼” ç€ å…· ä½“ äº§ å“ç±» çš„è§’è‰²ã€‚ UnpooledDataSource å® ç° äº† javax.sql.DataSource æ¥ å£ ä¸­ å®š ä¹‰ çš„ getConnection()æ–¹ æ³• åŠ å…¶ é‡ è½½æ–¹æ³•ï¼Œç”¨äºè· å–æ•° æ®åº“ è¿ æ¥ã€‚ æ¯æ¬¡é€šè¿‡ UnpooledDataSource.getConnection()æ–¹æ³•è· å–æ•° æ®åº“ è¿ æ¥ æ—¶ éƒ½ä¼š åˆ› å»ºä¸€ä¸ª æ–°è¿ æ¥ã€‚ UnpooledDataSourceä¸­çš„å­—æ®µå¦‚ä¸‹ï¼Œæ¯ä¸ª å­—æ®µéƒ½æœ‰å¯¹ åº” çš„getter/setter æ–¹æ³•: public class UnpooledDataSource implements DataSource &#123; private ClassLoader driverClassLoader; private Properties driverProperties; private static Map&lt;String, Driver&gt; registeredDrivers = new ConcurrentHashMap&lt;String, Driver&gt;(); private String driver; private String url; private String username; private String password; private Boolean autoCommit; private Integer defaultTransactionIsolationLevel; static &#123; Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers(); while (drivers.hasMoreElements()) &#123; Driver driver = drivers.nextElement(); registeredDrivers.put(driver.getClass().getName(), driver); &#125; &#125; // ...&#125; Pooled DataSourceäº†è§£JDBCç¼– ç¨‹çš„è¯» è€…çŸ¥é“ï¼Œæ•° æ®åº“ è¿ æ¥çš„åˆ› å»ºè¿‡ ç¨‹æ˜¯éå¸¸è€—æ—¶ çš„ï¼Œæ•° æ®åº“ èƒ½å¤Ÿ å»ºç«‹çš„è¿ æ¥æ•° ä¹Ÿéå¸¸æœ‰é™ï¼Œæ‰€ä»¥åœ¨ç» å¤§å¤šæ•° ç³»ç»Ÿ ä¸­ï¼Œæ•° æ®åº“ è¿ æ¥æ˜¯éå¸¸çè´µ çš„èµ„ æºï¼Œä½¿ç”¨æ•° æ®åº“ è¿ æ¥æ± å°±æ˜¾å¾—å°¤ä¸ºå¿…è¦ã€‚ ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ä¼šå¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥å®ç°æ•°æ®åº“è¿æ¥çš„é‡ç”¨ã€æé«˜å“ åº” é€Ÿåº¦ã€é˜²æ­¢æ•° æ®åº“ è¿ æ¥è¿‡ å¤šé€ æˆæ•° æ®åº“ å‡æ­»ã€é¿å…æ•° æ®åº“ è¿ æ¥æ³„éœ²ç­‰ã€‚ æ•°æ®åº“è¿æ¥æ± åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¸€èˆ¬ä¼šåˆ›å»ºä¸€å®šæ•°é‡çš„æ•°æ®åº“è¿æ¥å¹¶æ·»åŠ åˆ°è¿æ¥æ± ä¸­å¤‡ç”¨ã€‚ å½“ ç¨‹åºéœ€è¦ä½¿ç”¨æ•° æ®åº“ è¿ æ¥æ—¶ ï¼Œä» æ± ä¸­è¯· æ±‚è¿ æ¥;å½“ ç¨‹åºä¸å†ä½¿ç”¨è¯¥ è¿ æ¥æ—¶ ï¼Œä¼š å°† å…¶è¿”å›åˆ°æ± ä¸­ ç¼“ å­˜ï¼Œç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³ é—­ ã€‚ å½“ ç„¶ï¼Œæ•° æ®åº“ è¿ æ¥æ± ä¼š æ§åˆ¶è¿ æ¥æ€» æ•° çš„ä¸Šé™ä»¥åŠç©ºé—² è¿ æ¥æ•° çš„ä¸Šé™ï¼Œå¦‚æœè¿ æ¥æ± åˆ› å»ºçš„æ€» è¿ æ¥æ•° å·±è¾¾ åˆ°ä¸Šé™ï¼Œä¸”éƒ½å·²è¢«å ç”¨ï¼Œåˆ™ åç»­ è¯· æ±‚è¿ æ¥çš„çº¿ ç¨‹ä¼š è¿› å…¥é˜»å¡é˜Ÿ åˆ—ç­‰å¾…ï¼Œç›´åˆ°æœ‰çº¿ ç¨‹é‡Š æ”¾å‡ºå¯ç”¨çš„è¿ æ¥ã€‚ å¦‚æœè¿ æ¥æ± ä¸­ç©ºé—² è¿ æ¥æ•° è¾ƒ å¤šï¼Œè¾¾ åˆ° å…¶ä¸Šé™ï¼Œåˆ™ åç»­ è¿”å›çš„ç©ºé—² è¿ æ¥ä¸ä¼š æ”¾å…¥æ± ä¸­ï¼Œè€Œæ˜¯ç›´æ¥å…³ é—­ ï¼Œè¿™ æ · å¯ä»¥å‡ å°‘ç³»ç»Ÿ ç»´ æŠ¤ å¤šä½™æ•° æ®åº“è¿æ¥çš„å¼€é”€ã€‚ å¦‚æœå°†æ€»è¿æ¥æ•°çš„ä¸Šé™è®¾ç½®å¾—è¿‡å¤§ï¼Œå¯èƒ½å› è¿æ¥æ•°è¿‡å¤šè€Œå¯¼è‡´æ•°æ®åº“åƒµæ­»ï¼Œç³»ç»Ÿæ•´ä½“æ€§èƒ½ ä¸‹é™; å¦‚æœæ€»è¿æ¥æ•°ä¸Šé™è¿‡å°ï¼Œåˆ™æ— æ³•å®Œå…¨å‘æŒ¥æ•°æ®åº“çš„æ€§èƒ½ï¼Œæµªè´¹æ•°æ®åº“èµ„æºã€‚å¦‚æœå°†ç©ºé—² è¿æ¥çš„ä¸Šé™è®¾ç½®å¾—è¿‡å¤§ï¼Œåˆ™ä¼šæµªè´¹ç³»ç»Ÿèµ„æºæ¥ç»´æŠ¤è¿™äº›ç©ºé—²è¿æ¥; å¦‚æœç©ºé—²è¿æ¥ä¸Šé™è¿‡å°ï¼Œå½“ å‡ºç° ç¬é—´ çš„å³°å€¼ è¯· æ±‚æ—¶ ï¼Œç³»ç»Ÿ çš„å¿«é€Ÿå“ åº” èƒ½åŠ›å°±æ¯”è¾ƒ å¼±ã€‚ æ‰€ä»¥åœ¨è®¾ ç½®æ•° æ®åº“ è¿ æ¥æ± çš„è¿™ ä¸¤ ä¸ª å€¼ æ—¶ï¼Œéœ€è¦è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€æƒè¡¡ä»¥åŠä¸€äº›ç»éªŒã€‚ PooledDataSourceå® ç° äº†ç®€ æ˜“æ•° æ®åº“ è¿ æ¥æ± çš„åŠŸèƒ½ï¼Œå®ƒ ä¾èµ– çš„ç»„ ä»¶å¦‚å›¾ æ‰€ç¤ºï¼Œå…¶ä¸­éœ€ è¦æ³¨æ„çš„æ˜¯ï¼ŒPooledDataSourceåˆ› å»ºæ–°æ•° æ®åº“ è¿ æ¥çš„åŠŸèƒ½æ˜¯ä¾èµ– å…¶ä¸­å°è£… çš„UnpooledDataSource å¯¹è±¡å®ç°çš„ã€‚ PooledConnectionPooledDataSourceå¹¶ ä¸ä¼š ç›´æ¥ç®¡ç†java.sql.Connectionå¯¹ è±¡ï¼Œè€Œæ˜¯ç®¡ç† PooledConnectionå¯¹ è±¡ã€‚ åœ¨ PooledConnectionä¸­å°è£… äº†çœŸ æ­£çš„æ•° æ®åº“ è¿ æ¥å¯¹ è±¡(java.sql.Connection) ä»¥åŠå…¶ä»£ç†å¯¹ è±¡ï¼Œè¿™ é‡Œçš„ä»£ç†å¯¹ è±¡æ˜¯é€šè¿‡ JDKåŠ¨ æ€ ä»£ç†äº§ ç”Ÿçš„ã€‚PooledConnectionç»§ æ‰¿äº† InvocationHandler æ¥å£ã€‚ æ ¸å¿ƒå­—æ®µï¼š // è®°å½•å½“å‰PooledConnectionå¯¹ è±¡æ‰€åœ¨çš„ PooledDataSourceå¯¹ è±¡ã€‚// è¯¥ PooledConnectionæ˜¯ä»è¯¥ PooledDataSourceä¸­è· å–çš„;// å½“ è°ƒ ç”¨close() æ–¹æ³•æ—¶ ä¼š å°† PooledConnectionæ”¾å›è¯¥PooledDataSource ä¸­private final PooledDataSource dataSource;// çœŸæ­£çš„æ•°æ®åº“è¿æ¥private final Connection realConnection;// æ•°æ®åº“è¿æ¥ä»£ç†å¯¹è±¡private final Connection proxyConnection;// ä»è¿æ¥æ± ä¸­å–å‡ºè¯¥è¿æ¥çš„æ—¶é—´æˆ³private long checkoutTimestamp;// åˆ›å»ºè¯¥è¿æ¥çš„æ—¶é—´æˆ³private long createdTimestamp;// æœ€åä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´æˆ³private long lastUsedTimestamp;// ç”±æ•°æ®åº“URLã€ç”¨æˆ·åå’Œå¯†ç è®¡ç®—å‡ºæ¥çš„hashå€¼ï¼Œå¯ç”¨äºæ ‡è¯†è¯¥è¿æ¥æ‰€åœ¨çš„è¿æ¥æ± private int connectionTypeCode;// æ£€æµ‹å½“å‰PooledConnectionæ˜¯å¦æœ‰æ•ˆï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç¨‹åºé€šè¿‡close()æ–¹æ³•å°†è¿æ¥è¿˜ç»™è¿æ¥æ± ä¹‹å// ä¾ç„¶é€šè¿‡è¯¥è¿æ¥æ“ä½œæ•°æ®åº“private boolean valid; PooledConnection.invoke()æ–¹æ³•çš„å® ç° ï¼Œè¯¥ æ–¹æ³•æ˜¯proxyConnectionè¿™ ä¸ª è¿ æ¥ä»£ç†å¯¹ è±¡çš„çœŸ æ­£ä»£ç† é€» è¾‘ ï¼Œå®ƒ ä¼š å¯¹ close()æ–¹æ³•çš„è°ƒ ç”¨è¿› è¡Œä»£ç†ï¼Œå¹¶ ä¸”åœ¨è°ƒ ç”¨çœŸ æ­£æ•° æ®åº“ è¿ æ¥çš„æ–¹æ³•ä¹‹å‰è¿› è¡Œæ£€ æµ‹ ï¼Œ ä»£ç  å¦‚ä¸‹: public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; String methodName = method.getName(); // å¦‚æœè°ƒç”¨close()æ–¹æ³•ï¼Œåˆ™å°†å…¶é‡æ–°æ”¾å…¥è¿æ¥æ± ï¼Œè€Œä¸æ˜¯çœŸæ­£å…³é—­æ•°æ®åº“è¿æ¥ if (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123; dataSource.pushConnection(this); return null; &#125; else &#123; try &#123; if (!Object.class.equals(method.getDeclaringClass())) &#123; // issue #579 toString() should never fail // throw an SQLException instead of a Runtime // é€šè¿‡validå­—æ®µæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ checkConnection(); &#125; // è°ƒç”¨çœŸæ­£æ•°æ®åº“è¿æ¥å¯¹è±¡å¯¹åº”çš„æ–¹æ³• return method.invoke(realConnection, args); &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; &#125;&#125; PoolStatePoolStateæ˜¯ ç”¨ äº ç®¡ ç† PooledConnectionå¯¹ è±¡ çŠ¶ æ€ çš„ ç»„ ä»¶ ï¼Œå®ƒ é€š è¿‡ ä¸¤ ä¸ª ArrayList &lt;PooledConnection&gt;é›†åˆåˆ†åˆ« ç®¡ç†ç©ºé—² çŠ¶ æ€ çš„è¿ æ¥å’Œæ´»è·ƒ çŠ¶ æ€ çš„è¿ æ¥ï¼Œå®šä¹‰ å¦‚ä¸‹: // ç©ºé—²çš„PooledConnectionå¯¹è±¡é›†åˆprotected final List&lt;PooledConnection&gt; idleConnections = new ArrayList&lt;PooledConnection&gt;();// æ´»è·ƒçš„PooledConnectioné›†åˆprotected final List&lt;PooledConnection&gt; activeConnections = new ArrayList&lt;PooledConnection&gt;();// è¯·æ±‚æ•°æ®åº“è¿æ¥çš„æ¬¡æ•°protected long requestCount = 0;// è·å–è¿æ¥çš„ç´¯ç§¯æ—¶é—´protected long accumulatedRequestTime = 0;// checkoutTimeè¡¨ç¤ºåº”ç”¨ä»è¿æ¥æ± ä¸­å–å‡ºè¿æ¥ï¼Œåˆ°å½’è¿˜çš„è¿™æ®µæ—¶é•¿// accumulatedCheckoutTimeè®°å½•äº†æ‰€æœ‰è¿æ¥ç´¯ç§¯çš„checkoutTimeæ—¶é•¿protected long accumulatedCheckoutTime = 0;// å½“è¿æ¥é•¿æ—¶é—´æœªå½’è¿˜ç»™è¿æ¥æ± çš„æ—¶å€™ï¼Œä¼šè¢«è®¤è¯¥è¿æ¥è¶…æ—¶// claimedOverdueConnectionCountè®°å½•äº†è¶…æ—¶è¿æ¥ä¸ªæ•°protected long claimedOverdueConnectionCount = 0;// ç´¯ç§¯è¶…æ—¶æ—¶é—´protected long accumulatedCheckoutTimeOfOverdueConnections = 0;// ç´¯ç§¯ç­‰å¾…æ—¶é—´protected long accumulatedWaitTime = 0;// ç´¯ç§¯ç­‰å¾…æ¬¡æ•°protected long hadToWaitCount = 0;// æ— æ•ˆçš„è¿æ¥æ•°protected long badConnectionCount = 0; PooledDataSourcePooledDataSourceä¸­ ç®¡ ç† çš„ çœŸ æ­£ çš„ æ•° æ® åº“ è¿ æ¥ å¯¹ è±¡ æ˜¯ ç”± PooledDataSourceä¸­å°è£… çš„UnpooledDataSourceå¯¹ è±¡ åˆ› å»º çš„ ï¼Œå¹¶ ç”± PoolStateç®¡ ç† æ‰€ æœ‰ è¿ æ¥ çš„ çŠ¶ æ€ ã€‚ PooledDataSourceä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ å’ŒåŠŸèƒ½å¦‚ä¸‹: // é€šè¿‡ PoolStateç®¡ç†è¿æ¥æ± çš„çŠ¶æ€å¹¶è®°å½•ç»Ÿè®¡ä¿¡æ¯private final PoolState state = new PoolState(this);// è®°å½•UnpooledDataSourceå¯¹è±¡ï¼Œç”¨äºç”ŸæˆçœŸå®çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–è¯¥å­—æ®µprivate final UnpooledDataSource dataSource;// æœ€å¤§æ´»è·ƒè¿æ¥æ•°protected int poolMaximumActiveConnections = 10;// æœ€å¤§ç©ºé—²è¿æ¥æ•°protected int poolMaximumIdleConnections = 5;// æœ€å¤§checkoutæ—¶é•¿protected int poolMaximumCheckoutTime = 20000;// æœ€å¤§ç­‰å¾…æ—¶é—´protected int poolTimeToWait = 20000;// æœ€å¤§æ— æ•ˆè¿æ¥æ•°é‡protected int poolMaximumLocalBadConnectionTolerance = 3;// åœ¨æ£€æµ‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ˜¯å¦å¯ç”¨çš„æ—¶å€™ï¼Œä¼šç»™æ•°æ®åº“å‘é€ä¸€ä¸ªæµ‹è¯•SQLè¯­å¥protected String poolPingQuery = &quot;NO PING QUERY SET&quot;;protected boolean poolPingEnabled;// å½“è¿æ¥è¶…è¿‡ poolPingConnectionsNotUsedForæ¯«ç§’æœªä½¿ç”¨æ—¶ ï¼Œä¼šå‘é€ä¸€æ¬¡æµ‹è¯•SQLè¯­å¥ï¼Œæ£€æµ‹è¿æ¥æ˜¯å¦æ­£å¸¸protected int poolPingConnectionsNotUsedFor;// æ ¹æ®æ•°æ®åº“çš„URLã€ç”¨æˆ·åå’Œå¯†ç ç”Ÿæˆçš„ä¸€ä¸ªhashå€¼ï¼Œè¯¥å“ˆå¸Œå€¼ç”¨äºæ ‡å¿—ç€å½“å‰çš„è¿æ¥æ± ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–private int expectedConnectionTypeCode; PooledDataSource.getConnection()æ–¹ æ³• é¦– å…ˆ ä¼š è°ƒ ç”¨ PooledDataSource.popConnection()æ–¹ æ³• è· å– PooledConnection å¯¹ è±¡ï¼Œç„¶åé€šè¿‡ PooledConnection.getProxyConnection()æ–¹æ³•è· å–æ•° æ®åº“ è¿ æ¥çš„ä»£ç†å¯¹ è±¡ã€‚popConnection()æ–¹æ³•æ˜¯PooledDataSourceçš„æ ¸å¿ƒé€» è¾‘ ä¹‹ä¸€ï¼Œå…¶å…·ä½“ é€» è¾‘ å¦‚å›¾ã€‚ PooledDataSource.popConnection()æ–¹æ³•çš„å…·ä½“å®ç°ï¼š private PooledConnection popConnection(String username, String password) throws SQLException &#123; boolean countedWait = false; PooledConnection conn = null; long t = System.currentTimeMillis(); int localBadConnectionCount = 0; while (conn == null) &#123; synchronized (state) &#123; if (!state.idleConnections.isEmpty()) &#123; // Pool has available connection conn = state.idleConnections.remove(0); if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; &#125; else &#123; // Pool does not have available connection if (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123; // Can create new connection conn = new PooledConnection(dataSource.getConnection(), this); if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; &#125; else &#123; // Cannot create new connection PooledConnection oldestActiveConnection = state.activeConnections.get(0); long longestCheckoutTime = oldestActiveConnection.getCheckoutTime(); if (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123; // Can claim overdue connection state.claimedOverdueConnectionCount++; state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime; state.accumulatedCheckoutTime += longestCheckoutTime; state.activeConnections.remove(oldestActiveConnection); if (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123; try &#123; oldestActiveConnection.getRealConnection().rollback(); &#125; catch (SQLException e) &#123; log.debug(&quot;Bad connection. Could not roll back&quot;); &#125; &#125; conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this); conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp()); conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp()); oldestActiveConnection.invalidate(); if (log.isDebugEnabled()) &#123; log.debug(&quot;....&quot;); &#125; &#125; else &#123; // Must wait try &#123; if (!countedWait) &#123; state.hadToWaitCount++; countedWait = true; &#125; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; long wt = System.currentTimeMillis(); state.wait(poolTimeToWait); state.accumulatedWaitTime += System.currentTimeMillis() - wt; &#125; catch (InterruptedException e) &#123; break; &#125; &#125; &#125; &#125; if (conn != null) &#123; // ping to server and check the connection is valid or not if (conn.isValid()) &#123; if (!conn.getRealConnection().getAutoCommit()) &#123; conn.getRealConnection().rollback(); &#125; conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password)); conn.setCheckoutTimestamp(System.currentTimeMillis()); conn.setLastUsedTimestamp(System.currentTimeMillis()); state.activeConnections.add(conn); state.requestCount++; state.accumulatedRequestTime += System.currentTimeMillis() - t; &#125; else &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; state.badConnectionCount++; localBadConnectionCount++; conn = null; if (localBadConnectionCount &gt; (poolMaximumIdleConnections + poolMaximumLocalBadConnectionTolerance)) &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; throw new SQLException(&quot;...&quot;); &#125; &#125; &#125; &#125; &#125; if (conn == null) &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; throw new SQLException(&quot;...&quot;); &#125; return conn;&#125; é€š è¿‡ å‰ é¢ å¯¹ PooledConnection.invoke()æ–¹æ³•çš„åˆ†ææˆ‘ä»¬ çŸ¥é“ï¼Œå½“ è°ƒ ç”¨è¿ æ¥çš„ä»£ç†å¯¹ è±¡çš„ close()æ–¹ æ³• æ—¶ ï¼Œå¹¶æœªå…³é—­çœŸæ­£çš„æ•°æ®è¿æ¥ ï¼Œè€Œæ˜¯è°ƒç”¨PooledDataSource.pushConnection()æ–¹æ³•å°† PooledConnectionå¯¹ è±¡å½’ è¿˜ ç»™ è¿ æ¥æ± ï¼Œä¾›ä¹‹åé‡ç”¨ã€‚ PooledDataSource.pushConnection()æ–¹æ³•ä¹Ÿæ˜¯ PooledDataSourceçš„æ ¸å¿ƒé€» è¾‘ ä¹‹ä¸€ï¼Œå…¶é€» è¾‘ å¦‚å›¾ PooledDataSource.pushConnection()ä»£ç å¦‚ä¸‹ï¼š protected void pushConnection(PooledConnection conn) throws SQLException &#123; synchronized (state) &#123; state.activeConnections.remove(conn); if (conn.isValid()) &#123; if (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123; state.accumulatedCheckoutTime += conn.getCheckoutTime(); if (!conn.getRealConnection().getAutoCommit()) &#123; // å›æ»šæœªæäº¤çš„äº‹åŠ¡ conn.getRealConnection().rollback(); &#125; PooledConnection newConn = new PooledConnection(conn.getRealConnection(), this); state.idleConnections.add(newConn); newConn.setCreatedTimestamp(conn.getCreatedTimestamp()); newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp()); conn.invalidate(); if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; state.notifyAll(); &#125; else &#123; // ç©ºé—²è¿æ¥æ•°å·²è¾¾åˆ°ä¸Šé™æˆ–PooledConnectionå¯¹è±¡å¹¶ä¸å±äºè¯¥è¿æ¥æ±  state.accumulatedCheckoutTime += conn.getCheckoutTime(); if (!conn.getRealConnection().getAutoCommit()) &#123; conn.getRealConnection().rollback(); &#125; conn.getRealConnection().close(); if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; conn.invalidate(); &#125; &#125; else &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; // ç»Ÿè®¡æ— æ•ˆPooledConnectionå¯¹è±¡ä¸ªæ•° state.badConnectionCount++; &#125; &#125;&#125; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPooledDataSource.pushConnection()æ–¹æ³•å’ŒpopConnection()æ–¹æ³•ä¸­éƒ½è°ƒ ç”¨äº† PooledConnection.isValid()æ–¹ æ³• æ¥ æ£€ æµ‹ PooledConnectionçš„ æœ‰ æ•ˆ æ€§ ï¼Œ è¯¥ æ–¹ æ³• é™¤ äº† æ£€ æµ‹ PooledConnection.valid å­—æ®µçš„å€¼ ï¼Œè¿˜ ä¼š è°ƒ ç”¨ PooledDataSource.pingConnection()æ–¹æ³•å° è¯• è®© æ•° æ® åº“ æ‰§ è¡ŒpodPingQueryå­—æ®µä¸­è®° å½• çš„æµ‹ è¯• SQLè¯­ å¥ï¼Œä» è€Œæ£€ æµ‹ çœŸ æ­£çš„æ•° æ®åº“ è¿ æ¥å¯¹ è±¡æ˜¯å¦ä¾ç„¶ å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ public boolean isValid() &#123; return valid &amp;&amp; realConnection != null &amp;&amp; dataSource.pingConnection(this);&#125;protected boolean pingConnection(PooledConnection conn) &#123; boolean result = true; try &#123; result = !conn.getRealConnection().isClosed(); &#125; catch (SQLException e) &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; result = false; &#125; if (result) &#123; if (poolPingEnabled) &#123; // æ£€æµ‹poolPingEnabledè®¾ç½®ï¼Œæ˜¯å¦è¿è¡Œæ‰§è¡Œæµ‹è¯•SQLè¯­ å¥ // é•¿æ—¶é—´(è¶…è¿‡ poolPingConnectionsNotUsedForæŒ‡å®šçš„æ—¶é•¿)æœªä½¿ç”¨çš„è¿æ¥ï¼Œæ‰éœ€è¦ping // æ“ä½œæ¥æ£€æµ‹æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸ if (poolPingConnectionsNotUsedFor &gt;= 0 &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123; try &#123; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; Connection realConn = conn.getRealConnection(); Statement statement = realConn.createStatement(); ResultSet rs = statement.executeQuery(poolPingQuery); rs.close(); statement.close(); if (!realConn.getAutoCommit()) &#123; realConn.rollback(); &#125; result = true; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; &#125; catch (Exception e) &#123; log.warn(&quot;...&quot;); try &#123; conn.getRealConnection().close(); &#125; catch (Exception e2) &#123; //ignore &#125; result = false; if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; &#125; &#125; &#125; &#125; return result;&#125; æœ€åéœ€è¦æ³¨æ„çš„æ˜¯PooledDataSource.forceCloseAll()æ–¹æ³•ï¼Œå½“ ä¿®æ”¹PooledDataSourceçš„å­—æ®µ æ—¶ ï¼Œä¾‹å¦‚æ•° æ®åº“ URLã€ç”¨æˆ·åã€å¯†ç  ã€autoCommité…ç½®ç­‰ï¼Œéƒ½ä¼š è°ƒ ç”¨forceCloseAll()æ–¹æ³•å°† æ‰€ æœ‰æ•° æ®åº“ è¿ æ¥å…³ é—­ ï¼ŒåŒæ—¶ ä¹Ÿä¼š å°† æ‰€æœ‰ç›¸åº” çš„PooledConnectioriå¯¹ è±¡éƒ½è®¾ ç½®ä¸º æ— æ•ˆï¼Œæ¸… ç©º activeConnections é›† åˆ å’Œ idleConnections é›† åˆ ã€‚ åº”ç”¨ç³»ç»Ÿä¹‹åé€šè¿‡PooledDataSource.getConnection()è·å–è¿æ¥æ—¶ï¼Œä¼šæŒ‰ç…§æ–°çš„é…ç½®é‡æ–°é…ç½®æ–°çš„æ•°æ®åº“è¿æ¥ä»¥åŠç›¸åº”çš„PooledConnectionå¯¹è±¡ã€‚ public void forceCloseAll() &#123; synchronized (state) &#123; expectedConnectionTypeCode = assembleConnectionTypeCode( dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword()); for (int i = state.activeConnections.size(); i &gt; 0; i--) &#123; try &#123; PooledConnection conn = state.activeConnections.remove(i - 1); conn.invalidate(); Connection realConn = conn.getRealConnection(); if (!realConn.getAutoCommit()) &#123; realConn.rollback(); &#125; realConn.close(); &#125; catch (Exception e) &#123; // ignore &#125; &#125; for (int i = state.idleConnections.size(); i &gt; 0; i--) &#123; try &#123; PooledConnection conn = state.idleConnections.remove(i - 1); conn.invalidate(); Connection realConn = conn.getRealConnection(); if (!realConn.getAutoCommit()) &#123; realConn.rollback(); &#125; realConn.close(); &#125; catch (Exception e) &#123; // ignore &#125; &#125; &#125; if (log.isDebugEnabled()) &#123; log.debug(&quot;PooledDataSource forcefully closed/removed all connections.&quot;); &#125;&#125; å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”èµ„æºåŠ è½½","date":"2019-10-27T01:09:42.000Z","path":"2019/10/27/899df03d.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„èµ„æºåŠ è½½æ¨¡å— ç±»åŠ è½½å™¨Javaè™š æ‹Ÿ æœºä¸­çš„ç±» åŠ è½½ å™¨(ClassLoader)è´Ÿ è´£ åŠ è½½ æ¥ è‡ªæ–‡ä»¶ç³»ç»Ÿ ã€ç½‘ ç»œ æˆ–å…¶ä»–æ¥ æºçš„ç±» æ–‡ ä»¶ã€‚Javaè™š æ‹Ÿ æœºä¸­çš„ç±» åŠ è½½ å™¨é»˜è®¤ ä½¿ç”¨çš„æ˜¯åŒ äº² å§”æ´¾æ¨¡å¼ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œå…¶ä¸­æœ‰ä¸‰ç§ é»˜è®¤ ä½¿ ç”¨ çš„ ç±» åŠ  è½½ å™¨ ï¼Œåˆ† åˆ« æ˜¯ Bootstrap ClassLoaderã€Extension ClassLoader å’Œ System ClassLoader (ä¹Ÿ è¢«ç§° ä¸º ApplicationClassLoader)ï¼Œæ¯ç§ ç±» åŠ è½½ å™¨éƒ½å·±ç» ç¡® å®šä» å“ª ä¸ª ä½ç½®åŠ è½½ ç±» æ–‡ä»¶ã€‚ BootstrapClassLoaderè´Ÿ è´£ åŠ è½½ JDKè‡ªå¸¦ çš„rt.jaråŒ…ä¸­çš„ç±» æ–‡ä»¶ï¼Œå®ƒ æ˜¯æ‰€æœ‰ç±» åŠ è½½ å™¨çš„çˆ¶åŠ è½½ å™¨ï¼ŒBootstrap ClassLoaderæ²¡ æœ‰ä»»ä½•çˆ¶ç±» åŠ è½½ å™¨ã€‚Extension ClassLoaderè´Ÿ è´£ åŠ  è½½ Javaçš„æ‰© å±•ç±» åº“ ï¼Œä¹Ÿå°±æ˜¯ä» jre/lib/extç›®å½• ä¸‹æˆ–è€…java.ext.dirsç³»ç»Ÿ å± æ€§æŒ‡å®šçš„ç›®å½• ä¸‹åŠ è½½ ç±» ã€‚ SystemClassLoaderè´Ÿ è´£ ä» classpathç¯ å¢ƒå˜ é‡ä¸­åŠ è½½ ç±» æ–‡ä»¶ï¼Œclasspathç¯ å¢ƒå˜ é‡é€šå¸¸ç”±-classpathæˆ– -cpå‘½ä»¤è¡Œé€‰ é¡¹ æ¥ å®šä¹‰ ï¼Œæˆ– æ˜¯ ç”± JARä¸­ Manifestæ–‡ ä»¶ çš„ classpathå± æ€§æŒ‡å®šã€‚System ClassLoaderæ˜¯ExtensionClassLoaderçš„å­åŠ è½½ å™¨ã€‚ æ ¹æ®åŒäº²å§”æ´¾æ¨¡å¼ï¼Œåœ¨åŠ è½½ç±»æ–‡ä»¶æ—¶ï¼Œå­åŠ è½½å™¨é¦–å…ˆä¼šå°†åŠ è½½è¯·æ±‚å§”æ‰˜ç»™å®ƒçš„çˆ¶åŠ è½½å™¨ã€‚ çˆ¶åŠ è½½å™¨ä¼šæ£€æµ‹è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥ç±»ï¼Œå¦‚æœå·±åŠ è½½åˆ™åŠ è½½è¿‡ç¨‹ç»“æŸ;å¦‚æœæœªåŠ è½½åˆ™è¯·æ±‚ç»§ ç»­ å‘ä¸Šä¼  é€’ ï¼Œç›´åˆ°BootstrapClassLoaderã€‚ å¦‚æœåœ¨è¯· æ±‚å‘ä¸Šå§”æ‰˜çš„è¿‡ ç¨‹ä¸­ï¼Œå§‹ç»ˆ æœªæ£€ æµ‹ åˆ°è¯¥ ç±» å·± åŠ è½½ ï¼Œåˆ™ ä» BootstrapClassLoaderå¼€ å§‹å° è¯• ä» å…¶å¯¹ åº” è·¯å¾„ ä¸­åŠ è½½ è¯¥ ç±» æ–‡ä»¶ï¼Œå¦‚æœåŠ è½½ å¤±è´¥ åˆ™ ç”± å­åŠ è½½å™¨ç»§ç»­å°è¯•åŠ è½½ï¼Œç›´è‡³å‘èµ·åŠ è½½è¯·æ±‚çš„å­åŠ è½½å™¨ä½ä¸ºæ­¢ã€‚ åŒ äº² å§”æ´¾æ¨¡å¼å¯ä»¥ä¿è¯ ä¸¤ ç‚¹: ä¸€æ˜¯å­åŠ è½½ å™¨å¯ä»¥ä½¿ç”¨çˆ¶åŠ è½½ å™¨å·±åŠ è½½ çš„ç±» ï¼Œè€Œçˆ¶åŠ è½½ å™¨æ—  æ³•ä½¿ç”¨å­åŠ è½½ å™¨å·²åŠ è½½ çš„ç±» ; äºŒæ˜¯çˆ¶åŠ è½½ å™¨å·²åŠ è½½ è¿‡ çš„ç±» æ— æ³•è¢«å­åŠ è½½ å™¨å†æ¬¡åŠ è½½ ã€‚ è¿™ æ · å°±å¯ä»¥ä¿è¯ JVMçš„å®‰å…¨æ€§å’Œç¨³ å®šæ€§ã€‚ ClassLoaderWrapperä¸Šä¸Šä¸€å°èŠ‚ä¸­äº†è§£äº†ç±» åŠ è½½ å™¨çš„å¸¸è§ ä½¿ç”¨æ–¹å¼ã€‚åœ¨ MyBatisçš„ IO åŒ…ä¸­å°è£… äº† ClassLoaderä»¥åŠè¯» å–èµ„ æºæ–‡ä»¶çš„ç›¸å…³ APIã€‚ åœ¨ IOåŒ… ä¸­ æ ä¾› çš„ ClassLoaderWrapperæ˜¯ ä¸€ ä¸ª ClassLoaderçš„åŒ…è£… å™¨ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªClassLoaderå¯¹ è±¡ã€‚ é€šè¿‡ è°ƒ æ•´å¤šä¸ª ç±» åŠ è½½ å™¨çš„ä½¿ç”¨é¡º åºï¼ŒClassLoaderWrapperå¯ä»¥ç¡® ä¿è¿”å›ç»™ ç³» ç»Ÿ ä½¿ç”¨çš„æ˜¯æ­£ç¡® çš„ç±» åŠ è½½ å™¨ã€‚ ä½¿ ç”¨ ClassLoaderWrapperå°±å¦‚åŒä½¿ç”¨ä¸€ä¸ª ClassLoaderå¯¹ è±¡ï¼Œ ClassLoaderWrapperä¼š æŒ‰ç…§æŒ‡å®šçš„é¡º åºä¾æ¬¡æ£€ æµ‹ å…¶ä¸­å°è£… çš„ClassLoaderå¯¹ è±¡ï¼Œå¹¶ ä» ä¸­é€‰ å–ç¬¬ä¸€ ä¸ª å¯ç”¨çš„ClassLoaderå®Œæˆç›¸å…³ åŠŸèƒ½ã€‚ ClassLoaderWrapperçš„ ä¸» è¦ åŠŸ èƒ½ å¯ ä»¥ åˆ† ä¸º ä¸‰ ç±» ï¼Œ åˆ† åˆ« æ˜¯ getResourceAsURL()æ–¹ æ³• ã€ classForName()æ–¹æ³•ã€getResourceAsStream()æ–¹æ³•ï¼Œè¿™ ä¸‰ä¸ª æ–¹æ³•éƒ½æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ ä¸‰ç±» æ–¹æ³•æœ€ç»ˆ éƒ½ä¼š è°ƒ ç”¨å‚ æ•° ä¸º Stringå’ŒClassLoader[]çš„é‡è½½ ã€‚ getResourceAsURL()ä»£ç å¦‚ä¸‹ï¼Œå…¶ä»–çš„ç±»ä¼¼ï¼š public URL getResourceAsURL(String resource, ClassLoader classLoader) &#123; return getResourceAsURL(resource, getClassLoaders(classLoader));&#125;// è¿”å›ClassLoader[], è¯¥æ–¹æ³•æŒ‡æ˜ç±»åŠ è½½å™¨çš„ä½¿ç”¨é¡ºåºClassLoader[] getClassLoaders(ClassLoader classLoader) &#123; return new ClassLoader[]&#123; classLoader, defaultClassLoader, Thread.currentThread().getContextClassLoader(), getClass().getClassLoader(), systemClassLoader&#125;;&#125;URL getResourceAsURL(String resource, ClassLoader[] classLoader) &#123; URL url; for (ClassLoader cl : classLoader) &#123; if (null != cl) &#123; // look for the resource as passed in... url = cl.getResource(resource); // ...but some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it // and try again if we didn&#x27;t find the resource if (null == url) &#123; url = cl.getResource(&quot;/&quot; + resource); &#125; // &quot;It&#x27;s always in the last place I look for it!&quot; // ... because only an idiot would keep looking for it after finding it, so stop looking already. if (null != url) &#123; return url; &#125; &#125; &#125; // didn&#x27;t find it anywhere. return null;&#125; Resourcesæ˜¯ä¸€ä¸ª æä¾›äº†å¤šä¸ª é™ æ€ æ–¹æ³•çš„å·¥å…·ç±» ï¼Œå…¶ä¸­å°è£… äº†ä¸€ä¸ª ClassLoaderWrapperç±» å‹ çš„é™ æ€ å­—æ®µï¼ŒResourcesæä¾›çš„è¿™ äº›é™ æ€ å·¥å…·éƒ½æ˜¯é€šè¿‡ è°ƒ ç”¨è¯¥ ClassLoaderWrapperå¯¹ è±¡çš„ç›¸åº” æ–¹ æ³•å® ç° çš„ã€‚ ResolverUtilResolverUtilå¯ä»¥æ ¹æ®æŒ‡å®šçš„æ¡ä»¶æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„ç±» ï¼Œå…¶ä¸­ä½¿ç”¨çš„æ¡ä»¶ç”±Testæ¥å£è¡¨ç¤ºã€‚ ResolverUtilä¸­ä½¿ç”¨classLoaderå­— æ®µ (ClassLoaderç±» å‹)è®° å½• äº†å½“ å‰ä½¿ç”¨çš„ç±» åŠ è½½ å™¨ï¼Œé»˜è®¤ æƒ… å†µ ä¸‹ï¼Œä½¿ç”¨çš„æ˜¯å½“ å‰çº¿ ç¨‹ä¸Šä¸‹æ–‡ç»‘ å®šçš„ClassLoaderï¼Œæˆ‘ä»¬ å¯ä»¥é€šè¿‡ setClassLoader()æ–¹æ³•ä¿®æ”¹ä½¿ ç”¨ç±»åŠ è½½å™¨ã€‚ MyBatisæä¾›äº†ä¸¤ ä¸ª å¸¸ç”¨çš„Testæ¥å£å® ç° ï¼Œåˆ†åˆ« æ˜¯IsAå’ŒAnnotatedWith,å¦‚å›¾ æ‰€ç¤ºã€‚ IsAç”¨äºæ£€ æµ‹ ç±» æ˜¯å¦ç»§ æ‰¿äº†æŒ‡å®šçš„ç±» æˆ–æ¥å£ï¼ŒAnnotatedWithç”¨äºæ£€ æµ‹ ç±» æ˜¯å¦æ·»åŠ äº†æŒ‡å®šçš„æ³¨è§£ã€‚ å¼€ å‘ äººå‘˜ ä¹Ÿå¯ä»¥è‡ªå·±å® ç° Testæ¥å£ï¼Œå® ç° æŒ‡å®šæ¡ ä»¶çš„æ£€ æµ‹ ã€‚ Testæ¥å£ä¸­å®šä¹‰ äº† matches()æ–¹æ³•ï¼Œå®ƒ ç”¨äºæ£€ æµ‹ æŒ‡å®šç±» æ˜¯å¦ç¬¦åˆæ¡ ä»¶: public interface Test &#123; /** * Will be called repeatedly with candidate classes. Must return True if a class * is to be included in the results, false otherwise. */ boolean matches(Class&lt;?&gt; type);&#125; IsAå’Œ AnnotatedWithçš„å…·ä½“ å® ç° å¦‚ä¸‹ public static class IsA implements Test &#123; private Class&lt;?&gt; parent; /** Constructs an IsA test using the supplied Class as the parent class/interface. */ public IsA(Class&lt;?&gt; parentType) &#123; this.parent = parentType; &#125; /** Returns true if type is assignable to the parent type supplied in the constructor. */ @Override public boolean matches(Class&lt;?&gt; type) &#123; return type != null &amp;&amp; parent.isAssignableFrom(type); &#125; @Override public String toString() &#123; return &quot;is assignable to &quot; + parent.getSimpleName(); &#125;&#125;public static class AnnotatedWith implements Test &#123; private Class&lt;? extends Annotation&gt; annotation; /** Constructs an AnnotatedWith test for the specified annotation type. */ public AnnotatedWith(Class&lt;? extends Annotation&gt; annotation) &#123; this.annotation = annotation; &#125; /** Returns true if the type is annotated with the class provided to the constructor. */ @Override public boolean matches(Class&lt;?&gt; type) &#123; return type != null &amp;&amp; type.isAnnotationPresent(annotation); &#125; @Override public String toString() &#123; return &quot;annotated with @&quot; + annotation.getSimpleName(); &#125;&#125; é»˜è®¤ æƒ…å†µ ä¸‹ï¼Œä½¿ç”¨Thread.currentThread().getContextClassLoader()è¿™ ä¸ª ç±» åŠ è½½ å™¨åŠ è½½ ç¬¦åˆæ¡ ä»¶çš„ç±» ï¼Œæˆ‘ä»¬ å¯ä»¥åœ¨è°ƒ ç”¨find()æ–¹æ³•ä¹‹å‰ï¼Œè°ƒ ç”¨ setClassLoader(ClassLoader)è®¾ ç½®éœ€è¦ä½¿ç”¨çš„ ClassLoaderï¼Œè¿™ ä¸ª ClassLoaderå¯ ä»¥ ä» ClassLoaderWrapperä¸­ è· å– åˆ é€‚ çš„ ç±» åŠ  è½½ å™¨ ã€‚ ResolverUtilçš„ä½¿ç”¨æ¡ˆä¾‹ï¼š ResolverUtil&lt;ActionBean&gt; resolver = new ResolverUtil&lt;ActionBean&gt;();// åœ¨pkg1å’Œpkg2è¿™ä¸ªåŒ…ä¸‹æŸ¥æ‰¾å®ç°äº†ActionBeanè¿™ä¸ªæ¥å£çš„ç±»resolver.findImplementation(ActionBean.class, pkg1, pkg2);// åœ¨pkg1åŒ…ä¸‹æŸ¥æ‰¾ç¬¦åˆCustomerTestæ¡ä»¶çš„ç±»resolver.find(new CustomTest(), pkg1);// åœ¨pkg2åŒ…ä¸‹æŸ¥æ‰¾ç¬¦åˆCustomerTestæ¡ä»¶çš„ç±»resolver.find(new CustomTest(), pkg2);// è·å–ä¸Šé¢ä¸‰æ¬¡æŸ¥æ‰¾çš„ç»“æœCollection&lt;ActionBean&gt; beans = resolver.getClasses(); ResolverUtil.findImplementations()æ–¹æ³•å’ŒResolverUtil.findAnnotated()æ–¹æ³•éƒ½æ˜¯ä¾èµ–RescolverUtil.find()æ–¹æ³•å®ç°çš„ï¼ŒfindImplementations()æ–¹æ³•ä¼šåˆ›å»ºIsAå¯¹è±¡ä½œä¸ºæ£€æµ‹æ¡ä»¶ï¼ŒfindAnnotated()æ–¹æ³•ä¼šåˆ›å»ºAnnotatedWithå¯¹è±¡ä½œä¸ºæ£€æµ‹æ¡ä»¶ã€‚ public ResolverUtil&lt;T&gt; find(Test test, String packageName) &#123; String path = getPackagePath(packageName); try &#123; List&lt;String&gt; children = VFS.getInstance().list(path); for (String child : children) &#123; if (child.endsWith(&quot;.class&quot;)) &#123; addIfMatching(test, child); &#125; &#125; &#125; catch (IOException ioe) &#123; log.error(&quot;Could not read package: &quot; + packageName, ioe); &#125; return this;&#125;protected void addIfMatching(Test test, String fqn) &#123; try &#123; // fqnæ˜¯ç±»æ‰€åœ¨å®Œå…¨é™å®šåï¼Œå³åŒ…æ‹¬å…¶æ‰€åœ¨åŒ…çš„åŒ…å String externalName = fqn.substring(0, fqn.indexOf(&#x27;.&#x27;)).replace(&#x27;/&#x27;, &#x27;.&#x27;); ClassLoader loader = getClassLoader(); if (log.isDebugEnabled()) &#123; log.debug(&quot;...&quot;); &#125; Class&lt;?&gt; type = loader.loadClass(externalName); if (test.matches(type)) &#123; matches.add((Class&lt;T&gt;) type); &#125; &#125; catch (Throwable t) &#123; log.warn(&quot;...&quot;); &#125;&#125; VFSVFSè¡¨ç¤ºè™š æ‹Ÿ æ–‡ä»¶ç³»ç»Ÿ (VirtualFileSystem),å®ƒ ç”¨æ¥ æŸ»æ‰¾ æŒ‡å®šè·¯å¾„ ä¸‹çš„èµ„ æºã€‚VFSæ˜¯ä¸€ä¸ª æŠ½è±¡ç±» ï¼ŒMyBatisä¸­æä¾›äº† JBoss6VFSå’Œ DefaultVFSä¸¤ ä¸ª VFSçš„å® ç° ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ç”¨æˆ· ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰ çš„VFSå® ç° ç±» ã€‚ VFSé‡‡ç”¨å•ä¾‹æ¨¡å¼å®ç° å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”æ—¥å¿—æ¨¡å—","date":"2019-10-26T01:09:42.000Z","path":"2019/10/26/899df03d.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„æ—¥å¿—æ¨¡å— åœ¨ Java å¼€ å‘ ä¸­å¸¸ç”¨çš„æ—¥å¿—æ¡† æ¶æœ‰ Log4jã€Log4j2ã€Apache Commons Logã€java.util.loggingã€ slf4jç­‰ï¼Œè¿™ äº›å·¥å…·å¯¹ å¤–çš„æ¥å£ä¸å°½ ç›¸åŒã€‚ ä¸º äº†ç»Ÿ ä¸€è¿™ äº›å·¥å…·çš„æ¥å£ï¼ŒMyBatiså®šä¹‰ äº†ä¸€å¥—ç»Ÿ ä¸€ çš„æ—¥å¿—æ¥å£ä¾›ä¸Šå±‚ ä½¿ç”¨ï¼Œå¹¶ ä¸º ä¸Šè¿°å¸¸ç”¨çš„æ—¥å¿—æ¡† æ¶æä¾›äº†ç›¸åº” çš„é€‚é…å™¨ã€‚ é€‚é…å™¨æ¨¡å¼å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è®¾è®¡æ¨¡å¼ä¸­çš„å…­å¤§åŸåˆ™ å•ä¸€èŒè´£åŸåˆ™ ä¸è¦å­˜åœ¨å¤šäºä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŸå› ï¼Œç®€å•æ¥è¯´ï¼Œä¸€ä¸ªç±»åªè´Ÿè´£å”¯ä¸€ é¡¹èŒè´£ã€‚ é‡Œæ°æ›¿æ¢åŸåˆ™ å¦‚æœå¯¹ æ¯ä¸€ä¸ª ç±» å‹ä¸º T1çš„å¯¹ è±¡tlï¼Œéƒ½æœ‰ç±» å‹ä¸º T2çš„å¯¹ è±¡ä½¿å¾—ä»¥ T1å®šä¹‰ çš„æ‰€æœ‰ç¨‹åºPåœ¨æ‰€æœ‰çš„å¯¹ è±¡tléƒ½ä»£æ¢ æˆt2æ—¶ ï¼Œç¨‹åºP çš„è¡Œä¸º æ²¡ æœ‰å‘ ç”Ÿå˜ åŒ–ï¼Œ é‚£ä¹ˆ ç±» å‹T2æ˜¯ç±» å‹T1çš„å­ç±» å‹ã€‚éµå®ˆé‡Œæ°æ›¿æ¢ åŸåˆ™ ï¼Œå¯ä»¥å¸® åŠ©æˆ‘ä»¬ è®¾ è®¡ å‡ºæ›´ä¸º åˆ ç†çš„ç»§ æ‰¿ä½“ ç³»ã€‚ ä¾èµ–å€’ç½®åŸåˆ™ ç³»ç»Ÿçš„é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—çš„å…·ä½“å®ç°ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–å…¶ æŠ½è±¡ç±» æˆ–æ¥å£ï¼ŒæŠ½è±¡æ¥å£ä¸åº” è¯¥ ä¾èµ– å…·ä½“ å® ç° ç±» ï¼Œè€Œå…·ä½“ å® ç° ç±» åº” è¯¥ äºä¾èµ– æŠ½è±¡ã€‚ç®€ å• æ¥ è¯´ ï¼Œæˆ‘ä»¬ è¦é¢å‘æ¥å£ç¼– ç¨‹ã€‚å½“ éœ€æ±‚å‘ ç”Ÿå˜ åŒ–æ—¶ å¯¹ å¤–æ¥å£ä¸å˜ ï¼Œåªè¦æä¾›æ–°çš„å® ç° ç±» å³ å¯ã€‚ æ¥å£éš”ç¦»åŸåˆ™ ä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šã€‚ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬ åœ¨è®¾ è®¡ æ¥å£æ—¶ ï¼Œä¸è¦è®¾ è®¡ å‡ºåº å¤§è‡ƒ è‚¿ çš„æ¥å£ï¼Œå› ä¸º å® ç° è¿™ ç§ æ¥å£æ—¶ éœ€è¦å® ç° å¾ˆ å¤šä¸å¿… è¦çš„æ–¹æ³•ã€‚æˆ‘ä»¬ è¦å°½ é‡è®¾ è®¡ å‡ºåŠŸèƒ½å• ä¸€çš„æ¥å£ï¼Œè¿™ æ · ä¹Ÿèƒ½ä¿è¯ å® ç° ç±» çš„èŒ è´£ å• ä¸€ã€‚ è¿ªç±³ç‰¹æ³•åˆ™ ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°‘çš„äº†è§£ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¦æ±‚æˆ‘ä»¬å‡ ä½ç±» é—´ è€¦ åˆã€‚ å¼€æ”¾-å°é—­åŸåˆ™ ç¨‹åºè¦å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ç®€å•æ¥è¯´ï¼Œå½“éœ€æ±‚å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ ä»¬ å¯ä»¥é€šè¿‡ æ·»åŠ æ–°çš„æ¨¡å— æ»¡ è¶³æ–°éœ€æ±‚ï¼Œè€Œä¸æ˜¯é€šè¿‡ ä¿®æ”¹åŸæ¥ çš„å® ç° ä»£ç  æ¥ æ»¡ è¶³æ–°éœ€æ±‚ã€‚ åœ¨è¿™ å…­æ¡ åŸåˆ™ ä¸­ï¼Œå¼€ æ”¾-å°é—­ åŸåˆ™ æ˜¯æœ€åŸºç¡€ çš„åŸåˆ™ ï¼Œä¹Ÿæ˜¯å…¶ä»–åŸåˆ™ ä»¥åŠåæ–‡ä»‹ç» çš„æ‰€æœ‰è®¾ è®¡ æ¨¡å¼çš„æœ€ç»ˆ ç›®æ ‡ ã€‚ é€‚é…å™¨æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯è§£å†³ ç”±äºæ¥å£ä¸èƒ½å…¼å®¹è€Œå¯¼ è‡´ç±» æ—  æ³•ä½¿ç”¨çš„é—® é¢˜ ï¼Œé€‚é…å™¨æ¨¡å¼ä¼š å°† éœ€è¦é€‚é…çš„ç±» è½¬ æ¢ æˆè°ƒ ç”¨è€…èƒ½å¤Ÿ ä½¿ç”¨çš„ç›®æ ‡ æ¥å£ã€‚è¿™ é‡Œå…ˆä»‹ç» é€‚é…å™¨æ¨¡å¼ä¸­æ¶‰åŠçš„å‡  ä¸ª è§’è‰²ï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚ ç›®æ ‡æ¥å£ ç”¨è€…èƒ½å¤Ÿ ç›´æ¥ä½¿ç”¨çš„æ¥å£ã€‚ éœ€è¦é€‚é…çš„ç±»ï¼ˆAdapteeï¼‰ â€”èˆ¬æƒ…å†µä¸‹ï¼ŒAdapteeç±»ä¸­æœ‰çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å…¶æ¥å£ ä¸èƒ½è¢«è°ƒ ç”¨è€…ç›´æ¥ä½¿ç”¨ã€‚ é€‚é…å™¨ï¼ˆAdapterï¼‰ Adapter å® ç° äº† Target æ¥å£ï¼Œå¹¶ åŒ…è£… äº†ä¸€ä¸ª Adaptee å¯¹ è±¡ã€‚Adapter åœ¨å® ç° Targetæ¥å£ä¸­çš„æ–¹æ³•æ—¶ ï¼Œä¼š å°† è°ƒ ç”¨å§”æ‰˜ç»™ Adapteeå¯¹ è±¡çš„ç›¸å…³ æ–¹æ³•ï¼Œç”±Adaptee å®Œæˆå…·ä½“ çš„ä¸š åŠ¡ ã€‚ é€‚é…å™¨æ¨¡å¼ç±»å›¾ï¼š ä½¿ç”¨é€‚é…å™¨æ¨¡å¼çš„å¥½å¤„ å°±æ˜¯å¤ ç”¨ç° æœ‰ç»„ ä»¶ã€‚ åº” ç”¨ç¨‹åºéœ€è¦å¤ ç”¨ç° æœ‰çš„ç±» ï¼Œä½†æ¥å£ä¸èƒ½è¢«è¯¥ åº” ç”¨ç¨‹åºå…¼å®¹ï¼Œåˆ™ æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚ è¿™ ç§ åœº æ™¯ä¸‹å°±é€‚åˆä½¿ç”¨é€‚é…å™¨æ¨¡å¼å® ç° æ¥å£çš„é€‚é…ï¼Œä» è€Œå®Œ æˆç»„ ä»¶çš„å¤ ç”¨ã€‚ å¾ˆ æ˜æ˜¾ ï¼Œé€‚é…å™¨æ¨¡å¼é€šè¿‡ æä¾›Adapterçš„æ–¹å¼å®Œæˆæ¥å£é€‚é…ï¼Œå® ç° äº†ç¨‹åºå¤ ç”¨ Adapteeçš„éœ€æ±‚ï¼Œé¿å…äº†ä¿®æ”¹Adapteeå® ç° æ¥å£ï¼Œè¿™ ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ ã€‚ å½“ æœ‰æ–°çš„Adaptee éœ€è¦è¢«å¤ ç”¨æ—¶ ï¼Œåªè¦æ·»åŠ æ–°çš„Adapterå³ å¯ï¼Œè¿™ ä¹Ÿæ˜¯ç¬¦åˆâ€œå¼€ æ”¾-å°é—­ â€åŸåˆ™ çš„ã€‚ åœ¨ MyBatisçš„æ—¥å¿—æ¨¡å— ä¸­ï¼Œå°±ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ã€‚ MyBatiså†… éƒ¨è°ƒ ç”¨å…¶æ—¥å¿—æ¨¡å— æ—¶ ï¼Œä½¿ç”¨ äº†å…¶å†… éƒ¨æ¥å£(ä¹Ÿå°±æ˜¯åé¢è¦ä»‹ç» çš„org.apache.ibatis.loggingLog æ¥å£)ã€‚ä½†æ˜¯ Log4jã€Log4j2 ç­‰ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶å¯¹ å¤–æä¾›çš„æ¥å£å„ä¸ç›¸åŒï¼ŒMyBatisä¸º äº†é›†æˆå’Œå¤ ç”¨è¿™ äº›ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶ï¼Œ åœ¨å…¶æ—¥å¿—æ¨¡å— ä¸­æä¾›äº†å¤šç§ Adapter, å°† è¿™ äº›ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶å¯¹ å¤–çš„æ¥å£é€‚é…æˆäº† org.apache.ibatis.logging.Log æ¥å£ï¼Œè¿™ æ · MyBatis å†… éƒ¨å°±å¯ä»¥ç»Ÿ ä¸€é€šè¿‡ org.apache.ibatis.logging.Logæ¥å£è°ƒ ç”¨ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶çš„åŠŸèƒ½äº†ã€‚ æ—¥å¿—é€‚é…å™¨MyBatis ç»Ÿ ä¸€æä¾›äº† traceã€debugã€ warnã€errorå››ä¸ª çº§ åˆ« ç”¨äºå¯¹åº”ä¸Šè¯‰çš„å„ç§ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶çš„çº§åˆ«ï¼Œè¿™ åŸºæœ¬ä¸ ä¸»æµæ—¥å¿—æ¡† æ¶çš„æ›°å¿—çº§ åˆ« ç±» ä¼¼ï¼Œå¯ä»¥æ»¡ è¶³ç» å¤§å¤šæ•° åœº æ™¯çš„æ—¥å¿— éœ€æ±‚ã€‚ MyBatisçš„æ—¥å¿—æ¨¡å— ä½äºorg.apache.ibatis.loggingåŒ…ä¸­ï¼Œè¯¥ æ¨¡å— ä¸­é€šè¿‡ Logæ¥å£å®šä¹‰ äº†æ—¥å¿— æ¨¡å— çš„åŠŸèƒ½ï¼Œå½“ ç„¶æ—¥å¿—é€‚é…å™¨ä¹Ÿä¼š å® ç° æ­¤æ¥å£ã€‚LogFactoryå·¥å‚ ç±» è´Ÿ è´£ åˆ› å»ºå¯¹ åº” çš„æ—¥å¿—ç»„ ä»¶é€‚ é…å™¨ã€‚ åœ¨LogFactoryç±» åŠ è½½ æ—¶ ä¼š æ‰§ è¡Œå…¶é™ æ€ ä»£ç  å— ï¼Œå…¶é€» è¾‘ æ˜¯æŒ‰åºåŠ è½½ å¹¶ å® ä¾‹åŒ–å¯¹ åº” æ—¥å¿—ç»„ ä»¶çš„ é€‚é…å™¨ï¼Œç„¶åä½¿ç”¨LogFactory. logConstructorè¿™ ä¸ª é™ æ€ å­—æ®µï¼Œè®° å½• å½“ å‰ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ ä»¶çš„ é€‚é…å™¨ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹æ‰€ç¤ºã€‚ private static Constructor&lt;? extends Log&gt; logConstructor;static &#123; tryImplementation(new Runnable() &#123; @Override public void run() &#123; useSlf4jLogging(); &#125; &#125;); tryImplementation(new Runnable() &#123; @Override public void run() &#123; useCommonsLogging(); &#125; &#125;); tryImplementation(new Runnable() &#123; @Override public void run() &#123; useLog4J2Logging(); &#125; &#125;); tryImplementation(new Runnable() &#123; @Override public void run() &#123; useLog4JLogging(); &#125; &#125;); tryImplementation(new Runnable() &#123; @Override public void run() &#123; useJdkLogging(); &#125; &#125;); tryImplementation(new Runnable() &#123; @Override public void run() &#123; useNoLogging(); &#125; &#125;);&#125; LogFactory.tryImplementation()æ–¹ æ³• é¦– å…ˆ ä¼š æ£€ æµ‹ logConstructorå­— æ®µ ï¼Œ è‹¥ ä¸º ç©º åˆ™ è°ƒ ç”¨ Runnable.run()æ–¹æ³•(æ³¨æ„ï¼Œä¸æ˜¯***start()***æ–¹æ³•)ï¼Œå¦‚ä¸Šè¿°ä»£ç  æ‰€ç¤ºï¼Œå…¶ä¸­ä¼š è°ƒ ç”¨use*Logging()æ–¹æ³•ã€‚ è¿™ é‡Œä»¥useJdkLogging()ä¸º ä¾‹è¿› è¡Œä»‹ç» ï¼Œå…·ä½“ ä»£ç  å¦‚ä¸‹: public static synchronized void useJdkLogging() &#123; setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);&#125;private static void setImplementation(Class&lt;? extends Log&gt; implClass) &#123; try &#123; // è·å–æŒ‡å®šé€‚é…å™¨çš„æ„é€ æ–¹æ³• Constructor&lt;? extends Log&gt; candidate = implClass.getConstructor(String.class); Log log = candidate.newInstance(LogFactory.class.getName()); if (log.isDebugEnabled()) &#123; log.debug(&quot;Logging initialized using &#x27;&quot; + implClass + &quot;&#x27; adapter.&quot;); &#125; // åˆå§‹åŒ–logConstructorå­—æ®µ logConstructor = candidate; &#125; catch (Throwable t) &#123; throw new LogException(&quot;Error setting Log implementation. Cause: &quot; + t, t); &#125;&#125; ç›¸åº”çš„å®ç°ç±»éƒ½åœ¨org.apache.ibatis.loggingçš„å­åŒ…ä¸‹ã€‚ä¸”éƒ½å® ç° äº† org.apache.ibatis.logging.Log æ¥å£ï¼Œå¹¶ å°è£… äº† java.util.logging. Logger å¯¹ è±¡ ï¼Œorg.apache.ibatis.logging.Log æ¥å£ çš„åŠŸèƒ½å…¨éƒ¨é€šè¿‡ è°ƒ ç”¨ java.util.logging.Logger å¯¹ è±¡ å® ç° ï¼Œè¿™ ä¸ å‰é¢ä»‹ç» çš„é€‚é…å™¨æ¨¡å¼å®Œå…¨ä¸€è‡´ã€‚ JDBCè°ƒè¯•åœ¨MyBatisçš„æ—¥å¿—æ¨¡å— ä¸­æœ‰ä¸€ä¸ª JdbcåŒ…ï¼Œå®ƒ å¹¶ ä¸æ˜¯å°† æ—¥å¿—ä¿¡æ¯é€šè¿‡ JDBCä¿å­˜åˆ°æ•° æ®åº“ ä¸­ï¼Œ è€Œæ˜¯é€šè¿‡ JDKåŠ¨ æ€ ä»£ç†çš„æ–¹å¼ï¼Œå°† JDBCæ“ä½œé€šè¿‡ æŒ‡å®šçš„æ—¥å¿—æ¡† æ¶æ‰“å°å‡ºæ¥ ã€‚è¿™ ä¸ª åŠŸèƒ½é€šå¸¸åœ¨ å¼€ å‘ é˜¶ æ®µä½¿ç”¨ï¼Œå®ƒ å¯ä»¥è¾“ å‡ºSQLè¯­ å¥ã€ç”¨æˆ· ä¼  å…¥çš„ç»‘ å®šå‚ æ•° ã€SQLè¯­ å¥å½±å“ è¡Œæ•° ç­‰ç­‰ä¿¡æ¯ï¼Œå¯¹ è°ƒ è¯• ç¨‹åºæ¥ è¯´ æ˜¯éå¸¸é‡è¦çš„ã€‚ BaseJdbcLoggeræ˜¯ä¸€ä¸ª æŠ½è±¡ç±» ï¼Œå®ƒ æ˜¯JdbcåŒ…ä¸‹å…¶ä»–Loggerç±» çš„çˆ¶ç±» ï¼Œç»§ æ‰¿å…³ ç³»å¦‚å›¾æ‰€ç¤ºã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”åå°„æ¨¡å—","date":"2019-10-25T01:09:42.000Z","path":"2019/10/25/899df03d.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡ä»‹ç»MyBatisçš„åå°„æ¨¡å— åå°„å·¥å…·ç®±Mybatis åœ¨è¿›è¡Œå‚æ•°å¤„ç†ã€ç»“æœæ˜ å°„ç­‰æ“ä½œæ—¶ï¼Œä¼šæ¶‰åŠå¤§é‡çš„åå°„æ“ä½œã€‚Java ä¸­çš„åå°„è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯ä»£ç ç¼–å†™èµ·æ¥æ¯”è¾ƒå¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼Œä¸ºäº†ç®€åŒ–åå°„æ“ä½œçš„ç›¸å…³ä»£ç ï¼ŒMybatis æä¾›äº†ä¸“é—¨çš„åå°„æ¨¡å—ï¼Œè¯¥æ¨¡å—ä½äº org.apache.ibatis.reflection åŒ…ä¸­ï¼Œå®ƒå¯¹å¸¸è§çš„åå°„æ“ä½œåšäº†è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´åŠ ç®€æ´æ–¹ä¾¿çš„åå°„ APIã€‚ Reflector &amp; ReflectorFactoryReflectoræ˜¯MyBatisä¸­åå°„æ¨¡å—çš„åŸºç¡€ï¼Œæ¯éš”Reflectorå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªç±»ï¼Œåœ¨Reflectorä¸­ç¼“å­˜äº†åå°„æ“ä½œéœ€è¦ä½¿ç”¨çš„ç´¯çš„å…ƒä¿¡æ¯ã€‚ Reflectorä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š Private Class &lt;?&gt; type; //å¯¹åº”çš„ C1 ass ç±»å‹//å¯è¯»å±æ€§çš„åç§°é›†åˆï¼Œå¯è¯»å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” getter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„private String I readablepropertynames= EMPTY STRING ARRAY//å¯å†™å±æ€§çš„åç§°é›†åˆï¼Œå¯å†™å±æ€§å°±æ˜¯å­˜åœ¨ç›¸åº” setter æ–¹æ³•çš„å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„private String [writeablepropertynames EMPTY STRING ARRAY;//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ Invoker å¯¹è±¡ï¼Œå®ƒæ˜¯å¯¹ setter æ–¹æ³•å¯¹åº” // Me thod å¯¹è±¡çš„å°è£…ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»private Map &lt;String, Invoker&gt; setmethods =new Hashmap &lt;String, Invoker&gt; ();//å±æ€§ç›¸åº”çš„ getter æ–¹æ³•é›†åˆï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue ä¹Ÿæ˜¯ Invoker å¯¹è±¡private Map &lt;String, Invoker&gt; getmethods =new Hashmap &lt;String, Invoker&gt; ();//è®°å½•äº†å±æ€§ç›¸åº”çš„ setter æ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ setter æ–¹æ³•çš„å‚æ•°ç±»å‹private Map &lt;String, Class &lt;?&gt;&gt; settypes =new Hashmap &lt;string, Class &lt;?&gt;&gt; ();//è®°å½•äº†å±æ€§ç›¸åº”çš„ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œkey æ˜¯å±æ€§åç§°ï¼Œvalue æ˜¯ getter æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ private Map &lt;string, Class &lt;?&gt;&gt; gettypes=new Hashmap &lt;string, Class &lt;?&gt;&gt; ();private Constructor &lt;?&gt; default Constructor; //è®°å½•äº†é»˜è®¤æ„é€ æ–¹æ³•//è®°å½•äº†æ‰€æœ‰å±æ€§åç§°çš„é›†åˆprivate Map &lt;string, String&gt; caseinsensitivepropertymap-new Hashmap &lt;String, String&gt; (); åœ¨Reflectorçš„æ„é€ æ–¹æ³•ä¸­ä¼šè§£æåˆ¶å®šçš„Classå¯¹è±¡ï¼Œå¹¶å¡«å……ä¸Šè¿°é›†åˆã€‚å…·ä½“å¦‚ä¸‹ï¼š public Reflector(Class&lt;?&gt; clazz) &#123; type = clazz; // åˆå§‹åŒ–typeå­—æ®µ // æŸ¥æ‰¾clazzçš„é»˜è®¤æ„é€ æ–¹æ³•ï¼Œå…·ä½“å®ç°æ˜¯é€šè¿‡åå°„éå†æ‰€æœ‰æ„é€ æ–¹æ³• addDefaultConstructor(clazz); addGetMethods(clazz); // å¤„ç†clazzä¸­çš„getteræ–¹æ³•ï¼Œå¡«å……getMethodsé›†åˆå’ŒgetTypesé›†åˆ addSetMethods(clazz); // å¤„ç†clazzä¸­çš„setteræ–¹æ³•ï¼Œå¡«å……setMethodsé›†åˆå’ŒsetTypesé›†åˆ addFields(clazz); // å¤„ç†æ²¡æœ‰getter/setteræ–¹æ³•çš„å­—æ®µ // æ ¹æ®getMethods/setMethodsé›†åˆï¼Œåˆå§‹åŒ–å¯è¯»/å†™å±æ€§çš„åç§°é›†åˆ readablePropertyNames = getMethods.keySet().toArray(new String[0]); writablePropertyNames = setMethods.keySet().toArray(new String[0]); // åˆå§‹åŒ–caseInsensitivePropertyMapé›†åˆï¼Œå…¶ä¸­è®°å½•äº†æ‰€æœ‰å¤§å†™æ ¼å¼çš„å±æ€§åç§° for (String propName : readablePropertyNames) &#123; caseInsensitivePropertyMap.put( propName.toUpperCase(Locale.ENGLISH), propName); &#125; for (String propName : writablePropertyNames) &#123; caseInsensitivePropertyMap.put( propName.toUpperCase(Locale.ENGLISH), propName); &#125;&#125; Reflector.Addgetmethodso()æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ getter æ–¹æ³•ï¼ŒReflector. addSetMethods()æ–¹æ³•è´Ÿè´£è§£æç±»ä¸­å®šä¹‰çš„ setter æ–¹æ³•ï¼Œä¸¤è€…çš„é€»è¾‘ç±»ä¼¼ã€‚ Reflector. Addgetmethods() æ–¹æ³•æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ã€‚ é¦–å…ˆï¼Œè°ƒç”¨Reflector.getClassMethods()æ–¹æ³•è·å–å½“å‰ç±»åŠå…¶çˆ¶ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå“åº”çš„Methodå¯¹è±¡ã€‚ private Method[] getClassMethods(Class&lt;?&gt; clazz) &#123; // ç”¨äºè®°å½•åˆ¶å®šç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³•çš„å”¯ä¸€ç­¾åä»¥åŠå¯¹åº”çš„Methodå¯¹è±¡ Map&lt;String, Method&gt; uniqueMethods = new HashMap&lt;&gt;(); Class&lt;?&gt; currentClass = clazz; while (currentClass != null &amp;&amp; currentClass != Object.class) &#123; // è®°å½•currentClassè¿™ä¸ªç±»ä¸­å®šä¹‰çš„å…¨éƒ¨æ–¹æ³• addUniqueMethods(uniqueMethods, currentClass.getDeclaredMethods()); // we also need to look for interface methods - // because the class may be abstract // è®°å½•æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³• Class&lt;?&gt;[] interfaces = currentClass.getInterfaces(); for (Class&lt;?&gt; anInterface : interfaces) &#123; addUniqueMethods(uniqueMethods, anInterface.getMethods()); &#125; // è·å–çˆ¶ç±»ï¼Œç»§ç»­whileå¾ªç¯ currentClass = currentClass.getSuperclass(); &#125; Collection&lt;Method&gt; methods = uniqueMethods.values(); return methods.toArray(new Method[0]);// è½¬æ¢æˆMethodsæ•°ç»„è¿”å›&#125; ç„¶åï¼ŒæŒ‰ç…§JavaBeançš„è§„èŒƒï¼Œä»Reflector.getClassMethods()æ–¹æ³•è¿”å›çš„Methodæ•°ç»„ä¸­æŸ¥æ‰¾è¯¥ç±»ä¸­å®šä¹‰çš„getteræ–¹æ³•ï¼Œå°†å…¶è®°å½•åˆ°conflictingGettersé›†åˆä¸­ã€‚conflictingGettersé›†åˆçš„keyä¸ºå±æ€§åç§°ï¼Œvalueæ˜¯è¯¥å±æ€§å¯¹åº”çš„getteræ–¹æ³•çš„é›†åˆã€‚ å½“å­ç±»è¦†ç›–äº†çˆ¶ç±»çš„getteræ–¹æ³•ä¸”è¿”å›å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨æ­¥éª¤1ä¸­å°±ä¼šäº§ç”Ÿä¸¤ä¸ªç­¾åä¸åŒçš„æ–¹æ³•ã€‚ TypeParameterResolveråœ¨å¼€ å§‹ä»‹ç» TypeParameterResolverä¹‹å‰ï¼Œå…ˆç®€ å• ä»‹ç» ä¸€ä¸‹Typeæ¥å£çš„åŸºç¡€ çŸ¥è¯† ã€‚Typeæ˜¯æ‰€æœ‰ç±» å‹çš„çˆ¶æ¥å£ï¼Œå®ƒ æœ‰å››ä¸ª å­æ¥å£å’Œä¸€ä¸ª å® ç° ç±» ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ ä¸‹é¢æ¥ çœ‹è¿™ äº›å­æ¥å£å’Œå­ç±» æ‰€ä»£è¡¨çš„ç±» å‹ã€‚ Classæ¯”è¾ƒ å¸¸è§ ï¼Œå®ƒ è¡¨ç¤ºçš„æ˜¯åŸå§‹ç±» å‹ã€‚ Classç±» çš„å¯¹ è±¡è¡¨ç¤ºJVMä¸­çš„ä¸€ä¸ª ç±» æˆ–æ¥å£ï¼Œ æ¯ä¸ª Javaç±» åœ¨JVMé‡Œéƒ½è¡¨ç° ä¸º ä¸€ä¸ª Classå¯¹ è±¡ã€‚ åœ¨ç¨‹åºä¸­å¯ä»¥é€šè¿‡ â€œç±»å.classâ€ã€â€œ**å¯¹è±¡.getClass()â€æˆ–æ˜¯â€œClass.forName(â€œç±» åâ€)**â€ç­‰æ–¹å¼è· å–Classå¯¹ è±¡ã€‚ æ•° ç»„ ä¹Ÿè¢«æ˜ å°„ä¸º Classå¯¹ è±¡ï¼Œæ‰€æœ‰å…ƒç´ ç±» å‹ç›¸åŒä¸”ç»´ æ•° ç›¸åŒçš„æ•° ç»„ éƒ½å…±äº«åŒä¸€ä¸ª Classå¯¹ è±¡ã€‚ ParameterizedType è¡¨ç¤ºçš„æ˜¯å‚ æ•° åŒ–ç±» å‹ï¼Œä¾‹å¦‚ Listã€ Map&lt;Integerï¼ŒString&gt;ã€ Serviceè¿™ ç§ å¸¦ æœ‰æ³›å‹çš„ç±» å‹ã€‚ ParameterizedTypeæ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯: Type getRawType()â€”â€“è¿”å›å‚ æ•° åŒ–ç±» å‹ä¸­çš„åŸå§‹ç±» å‹ï¼Œä¾‹å¦‚Listçš„åŸå§‹ç±» å‹ä¸º Listã€‚ Type[] getActualTypeArguments()â€”â€“è· å–å‚ æ•° åŒ–ç±» å‹çš„ç±» å‹å˜ é‡æˆ–æ˜¯å® é™… ç±» å‹åˆ— è¡¨ï¼Œä¾‹å¦‚Map&lt;Integerï¼ŒString&gt;çš„å® é™… æ³›å‹åˆ—è¡¨Integerå’Œ Stringã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ è¯¥ åˆ—è¡¨çš„å…ƒç´ ç±» å‹éƒ½æ˜¯Type,ä¹Ÿå°±æ˜¯è¯´ ï¼Œå¯èƒ½å­˜åœ¨å¤šå±‚ åµŒå¥—çš„æƒ…å†µ ã€‚ Type getOwnerType()â€”â€“è¿”å›æ˜¯ç±» å‹æ‰€å± çš„ç±» å‹ï¼Œä¾‹å¦‚å­˜åœ¨Aç±» ï¼Œå…¶ä¸­å®šä¹‰ äº† å†… éƒ¨ç±» InnerAï¼Œåˆ™ InnerAå± çš„ç±» å‹ä¸º Aï¼Œå¦‚æœæ˜¯é¡¶ å±‚ ç±» å‹åˆ™ è¿”å›nullã€‚ è¿™ ç§ å…³ ç³»æ¯”è¾ƒ å¸¸è§ çš„ç¤ºä¾‹æ˜¯Map&lt;Kï¼ŒV&gt;æ¥å£ä¸ Map.Entry&lt;Kï¼ŒV&gt;æ¥å£ï¼ŒMap&lt;Kï¼ŒV&gt; æ¥ å£ æ˜¯Map&lt;K,V&gt;æ¥å£çš„æ‰€æœ‰è€…ã€‚ TypeVariableè¡¨ç¤ºçš„æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ ç”¨æ¥ åæ˜ åœ¨JVMç¼– è¯‘ è¯¥ æ³›å‹å‰çš„ä¿¡æ¯ã€‚ ä¾‹å¦‚List ä¸­çš„Tå°±æ˜¯ç±» å‹å˜ é‡ï¼Œå®ƒ åœ¨ç¼– è¯‘ æ—¶ éœ€è¢«è½¬ æ¢ ä¸º ä¸€ä¸ª å…·ä½“ çš„ç±» å‹åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ è¯¥ æ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ª ï¼Œåˆ†åˆ« æ˜¯: Type[] getBounds()â€”â€“è· å–ç±» å‹å˜ é‡çš„ä¸Šè¾¹ ç•Œï¼Œå¦‚æœæœªæ˜ç¡® å£° æ˜ä¸Šè¾¹ ç•Œåˆ™ é»˜è®¤ ä¸º Objectã€‚ ä¾‹å¦‚ class Testä¸­ K çš„ä¸Šç•Œå°±æ˜¯ Personã€‚ D getGenericDeclaration()â€”â€“è· å–å£° æ˜è¯¥ ç±» å‹å˜ é‡çš„åŸå§‹ç±» å‹ï¼Œä¾‹ å¦‚ class Test ä¸­ çš„åŸå§‹ç±» å‹æ˜¯ Testã€‚ String getName()â€” è· å–åœ¨æºç  ä¸­å®šä¹‰ æ—¶ çš„åå­—ï¼Œä¸Šä¾‹ä¸­ä¸º Kã€‚ GenericArrayType è¡¨ç¤ºçš„æ˜¯æ•° ç»„ ç±» å‹ä¸”ç»„ æˆå…ƒç´ æ˜¯ ParameterizedType æˆ– TypeVariableã€‚ ä¾‹å¦‚ Listæˆ–T[]ã€‚è¯¥ æ¥å£åªæœ‰ Type getGenericComponentType()â€”ä¸ª æ–¹æ³•ï¼Œå®ƒ è¿”å›æ•° ç»„ çš„ç»„ æˆå…ƒç´ ã€‚ WildcardType è¡¨ç¤ºçš„æ˜¯é€šé…ç¬¦æ³›å‹ï¼Œä¾‹å¦‚? extends Number å’Œ? uper Integerã€‚ WildcardTypeæ¥å£æœ‰ä¸¤ ä¸ª æ–¹æ³•ï¼Œåˆ†åˆ« æ˜¯: Type[] getUpperBounds()â€”-è¿”å›æ³›å‹å˜ é‡çš„ä¸Šç•Œã€‚ Type[] getLowerBounds()â€”- è¿”å›æ³›å‹å˜ é‡çš„ä¸‹ç•Œã€‚ å›åˆ°å¯¹ TypeParameterResolveï¼Œå®ƒ æ˜¯ä¸€ä¸ª å·¥å…·ç±» ï¼Œæä¾›äº†ä¸€ç³»åˆ—é™ æ€ æ–¹æ³•æ¥ è§£ææŒ‡å®šç±» ä¸­çš„å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ã€‚TypeParameterResolverä¸­å„ä¸ª é™ æ€ æ–¹æ³•ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¤§è‡´å¦‚ä¸‹å›¾ æ‰€ç¤ºï¼Œä¸º ä¿æŒæ¸… æ™° ï¼Œå…¶ä¸­é€’ å½’ è°ƒ ç”¨æ²¡ æœ‰è¡¨ç° å‡ºæ¥ ï¼Œåœ¨åé¢ çš„ä»£ç  åˆ†æè¿‡ ç¨‹ä¸­ä¼š è¿› è¡Œå¼ºè°ƒ ã€‚ TypeParameterResolver ä¸­ é€š è¿‡ resolveFieldType()æ–¹ æ³• ã€ resolveRetumType()æ–¹ æ³• ã€ resolveParamTypes()æ–¹æ³•åˆ†åˆ« è§£æå­—æ®µç±» å‹ã€æ–¹æ³•è¿”å›å€¼ ç±» å‹å’Œæ–¹æ³•å‚ æ•° åˆ—è¡¨ä¸­å„ä¸ª å‚ æ•° çš„ç±» å‹ã€‚ è¿™ ä¸‰ä¸ª æ–¹æ³•çš„é€» è¾‘ åŸºæœ¬ç±» ä¼¼ï¼Œè¿™ é‡Œä»¥resolveFieldType()æ–¹æ³•ä¸º ä¾‹è¿› è¡Œä»‹ç» ï¼ŒTypeParameterResolver.resolveFieldType()æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹: /** * @return The field type as &#123;@link Type&#125;. If it has type parameters in the declaration, * they will be resolved to the actual runtime &#123;@link Type&#125;s. */public static Type resolveFieldType(Field field, Type srcType) &#123; Type fieldType = field.getGenericType(); Class&lt;?&gt; declaringClass = field.getDeclaringClass(); return resolveType(fieldType, srcType, declaringClass);&#125; ä¸Šè¿°ä¸‰ä¸ª æ–¹æ³•éƒ½ä¼š è°ƒ ç”¨resolveType()æ–¹æ³•ï¼Œè¯¥ æ–¹æ³•ä¼š æ ¹æ®å…¶ç¬¬ä¸€ä¸ª å‚ æ•° çš„ ç±» å‹ï¼Œå³ å­—æ®µã€æ–¹æ³•è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„ç±» å‹ï¼Œé€‰ æ‹© åˆé€‚çš„æ–¹æ³•è¿› è¡Œè§£æã€‚resolveType()æ–¹æ³•çš„ ç¬¬äºŒä¸ª å‚ æ•° è¡¨ç¤ºæŸ¥ æ‰¾ è¯¥ å­—æ®µã€è¿”å›å€¼ æˆ–æ–¹æ³•å‚ æ•° çš„èµ·å§‹ä½ç½®ã€‚ç¬¬ä¸‰ä¸ª å‚ æ•° åˆ™ è¡¨ç¤ºè¯¥ å­—æ®µã€æ–¹æ³• å®šä¹‰ æ‰€åœ¨çš„ç±» ã€‚TypeParameterResolver.resolveType()æ–¹æ³•ä»£ç  å¦‚ä¸‹ï¼š private static Type resolveType(Type type, Type srcType, Class&lt;?&gt; declaringClass) &#123; if (type instanceof TypeVariable) &#123; // è§£æTypeVariableç±»å‹ return resolveTypeVar((TypeVariable&lt;?&gt;) type, srcType, declaringClass); &#125; else if (type instanceof ParameterizedType) &#123; // è§£æParameterizedTypeç±»å‹ return resolveParameterizedType((ParameterizedType) type, srcType, declaringClass); &#125; else if (type instanceof GenericArrayType) &#123; // è§£ægenericArrayTypeç±»å‹ return resolveGenericArrayType((GenericArrayType) type, srcType, declaringClass); &#125; else &#123; return type; // classç±»å‹ &#125; // å­—æ®µã€è¿”å›å€¼ ã€å‚ æ•° ä¸å¯èƒ½ç›´æ¥å®šä¹‰ æˆWildcardTypeç±» å‹ï¼Œä½†å¯ä»¥åµŒå¥—åœ¨åˆ« çš„ç±» å‹ä¸­&#125; ä¸ºäº†ä¾¿äºç†è§£ï¼Œé€šè¿‡ä¸€ä¸ªç¤ºä¾‹åˆ†æresolveTypeæ–¹æ³•ï¼Œ å‡è®¾æœ‰ä¸‰ä¸ªç±» ClassAã€SubClassAã€TestTypeï¼Œä»£ç å¦‚ä¸‹ï¼š ClassA public class ClassA &lt;K, V&gt; &#123; protected Map&lt;K, V&gt; map; // â€¢â€¢â€¢ map çš„ getter/setter æ–¹ æ³• (ç•¥ )&#125; SubClassA public class SubClassA &lt;T&gt; extends ClassA&lt;T,T&gt; &#123; // ...... &#125; TestType public class TestType &#123; SubClassA&lt;Long&gt; sa = new SubClassA(); public static void main(String[] args) throws NoSuchFieldException &#123; Field f = ClassA.class.getDeclaredField(&quot;map&quot;); System.out.println(f.getGenericType()); System.out.println(f.getGenericType() instanceof ParameterizedType); // è¾“å‡ºï¼š // java.util.Map&lt;K, V&gt; // true // è§£æSubA&lt;Long&gt;(ParameterizedTypeç±» å‹)ä¸­çš„mapå­—æ®µï¼Œæ³¨æ„:ParameterizedTypelmplæ˜¯ // åœ¨ sun.reflect.generics.reflectiveObjects åŒ…ä¸‹çš„ ParameterizedTypeæ¥å£å® ç° Type type = TypeParameterResolver.resolveFieldType( f, ParameterizedTypelmpl.make(SubClassA.class, new Type[]&#123;Long.class&#125;, TestType.class)); //ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ç”Ÿæˆä¸Šè¿°ParameterizedTypeå¯¹ è±¡ï¼Œ // å¹¶ è°ƒ ç”¨ TypeParameterResolver.resolveFieldType ()æ–¹ æ³• : // // TypeParameterResolver.resolveFieldType(f, // TestType.class.getDeclaredField(&quot;sa&quot;).getGenericType()); System.out.println(type.getClass()); // è¾“ å‡º :class TypeParameterResolver$ParameterizedTypelmpl // æ³¨æ„ï¼ŒTypeParameterResolver$ParameterizedTypeImplæ˜¯ParameterizedTypeæ¥å£çš„å® ç° ParameterizedType p = (ParameterizedType) type; System.out.println(p.getRawType()); // è¾“ å‡º :interface java.util.Map System.out.println(p.getOwnerType()); // è¾“ å‡º:null for (Type t : p .getActualTypeArguments()) &#123; System.out.println(t); &#125; //è¾“ å‡º: // class java.lang.Long // class java.lang.Long &#125;&#125; æ ¹æ®å‰é¢çš„Typeæ¥å£çš„ä»‹ç»ï¼Œä¸Šä¾‹ä¸­ClassA.mapå­—æ®µå£°æ˜çš„ç±»å‹Map&lt;K,V&gt;æ˜¯ParamelerizedTypeç±»å‹ï¼ŒresolveType()æ–¹æ³•å›è°ƒç”¨resolvParameterizedType()æ–¹æ³•è¿›è¡Œè§£æã€‚ é¦–å…ˆä»‹ç»resolveParameterizedType()æ–¹æ³•çš„å‚æ•°ï¼š ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¾…è§£æçš„ParameterizedTypeç±»å‹ ç¬¬äºŒä¸ªå‚æ•°æ˜¯è§£ææ“ä½œçš„èµ·å§‹ç±»å‹ ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå®šä¹‰è¯¥å­—æ®µæˆ–æ–¹æ³•çš„ç±»çš„Classå¯¹è±¡ åœ¨è¯¥ç¤ºä¾‹ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Map&lt;K,V&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeTest.SubAå¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰ç›¸åº”çš„Classå¯¹è±¡ã€‚ ç»§ç»­åˆ†æscanSuperTypes()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å›é€’å½’æ•´ä¸ªç»§æ‰¿ç»“æ„å¹¶å®Œæˆç±»å‹å˜é‡çš„è§£æã€‚åœ¨è¯¥ç¤ºä¾‹ä¹‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°Kå¯¹åº”çš„TypeVariableå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯TypeText.SubAå¯¹åº”çš„ParameterizedTypeå¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassAï¼ˆå£°æ˜mapå­—æ®µçš„ç±»ï¼‰å¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯SubClassAå¯¹åº”çš„Classå¯¹è±¡ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯Class&lt;T,T&gt;å¯¹åº”çš„ParameterizedTypeå¯¹è±¡ã€‚ scanSuperTypes()æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š private static Type scanSuperTypes( TypeVariable&lt;?&gt; typeVar, Type srcType, Class&lt;?&gt; declaringClass, Class&lt;?&gt; clazz, Type superclass) &#123; Type result = null; if (superclass instanceof ParameterizedType) &#123; ParameterizedType parentAsType = (ParameterizedType) superclass; Class&lt;?&gt; parentAsClass = (Class&lt;?&gt;) parentAsType.getRawType(); if (declaringClass == parentAsClass) &#123; Type[] typeArgs = parentAsType.getActualTypeArguments(); TypeVariable&lt;?&gt;[] declaredTypeVars = declaringClass.getTypeParameters(); for (int i = 0; i &lt; declaredTypeVars.length; i++) &#123; if (declaredTypeVars[i] == typeVar) &#123; if (typeArgs[i] instanceof TypeVariable) &#123; TypeVariable&lt;?&gt;[] typeParams = clazz.getTypeParameters(); for (int j = 0; j &lt; typeParams.length; j++) &#123; if (typeParams[j] == typeArgs[i]) &#123; if (srcType instanceof ParameterizedType) &#123; result = ((ParameterizedType) srcType).getActualTypeArguments()[j]; &#125; break; &#125; &#125; &#125; else &#123; result = typeArgs[i]; &#125; &#125; &#125; &#125; else if (declaringClass.isAssignableFrom(parentAsClass)) &#123; result = resolveTypeVar(typeVar, parentAsType, declaringClass); &#125; &#125; else if (superclass instanceof Class) &#123; if (declaringClass.isAssignableFrom((Class&lt;?&gt;) superclass)) &#123; result = resolveTypeVar(typeVar, superclass, declaringClass); &#125; &#125; return result; &#125; ä¸‹å›¾å±•ç¤ºäº†scanSuperTypes()æ–¹æ³•è§£æç±»å‹å˜é‡çš„æ ¸å¿ƒé€»è¾‘ã€‚ ObjectFactoryMyBatisä¸­å¾ˆå¤šæ¨¡å—ä¼šä½¿ç”¨åˆ°ObjectFactoryæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº†å¤šä¸ªcreate()æ–¹æ³•çš„é‡è½½ï¼Œé€šè¿‡è¿™äº›create()æ–¹æ³•å¯ä»¥åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚ObjectFactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š public interface ObjectFactory &#123; /** * Sets configuration properties. * è®¾ç½®é…ç½®ä¿¡æ¯ * @param properties configuration properties */ void setProperties(Properties properties); /** * Creates a new object with default constructor. * é€šè¿‡æ— å‚æ„é€ å™¨åˆ›å»ºæŒ‡å®šç±»çš„å¯¹è±¡ * @param type Object type * @return */ &lt;T&gt; T create(Class&lt;T&gt; type); /** * Creates a new object with the specified constructor and params. * æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œä»æŒ‡å®šç±»å‹ä¸­é€‰æ‹©åˆé€‚çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡ * @param type Object type * @param constructorArgTypes Constructor argument types * @param constructorArgs Constructor argument values * @return */ &lt;T&gt; T create(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs); /** * Returns true if this object can have a set of other objects. * It&#x27;s main purpose is to support non-java.util.Collection objects like Scala collections. * æ£€æµ‹æŒ‡å®šç±»å‹æ˜¯å¦ä¸ºé›†åˆç±»å‹ï¼Œä¸»è¦å¤„ç†java.util.CollectiopnåŠå…¶å­ç±» * * @param type Object type * @return whether it is a collection or not * @since 3.1.0 */ &lt;T&gt; boolean isCollection(Class&lt;T&gt; type);&#125; DefaultObjectFactoryæ˜¯MyBatisæä¾›çš„ObjectFactoryæ¥å£çš„å”¯ä¸€å® ç° ï¼Œå®ƒ æ˜¯ä¸€ä¸ª åå°„å·¥å‚ ï¼Œ å…¶ create()æ–¹æ³•é€šè¿‡ è°ƒ ç”¨ instantiateClass()æ–¹æ³•å® ç° ã€‚ DefaultObjectFactory.instantiateClass()æ–¹æ³•ä¼š æ ¹æ®ä¼  å…¥çš„å‚ æ•° åˆ—è¡¨é€‰ æ‹© åˆé€‚çš„æ„ é€ å‡½æ•° å® ä¾‹åŒ–å¯¹ è±¡ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹: private &lt;T&gt; T instantiateClass(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123; try &#123; Constructor&lt;T&gt; constructor; if (constructorArgTypes == null || constructorArgs == null) &#123; constructor = type.getDeclaredConstructor(); if (!constructor.isAccessible()) &#123; constructor.setAccessible(true); &#125; return constructor.newInstance(); &#125; constructor = type.getDeclaredConstructor(constructorArgTypes.toArray(new Class[constructorArgTypes.size()])); if (!constructor.isAccessible()) &#123; constructor.setAccessible(true); &#125; return constructor.newInstance(constructorArgs.toArray(new Object[constructorArgs.size()])); &#125; catch (Exception e) &#123; StringBuilder argTypes = new StringBuilder(); if (constructorArgTypes != null &amp;&amp; !constructorArgTypes.isEmpty()) &#123; for (Class&lt;?&gt; argType : constructorArgTypes) &#123; argTypes.append(argType.getSimpleName()); argTypes.append(&quot;,&quot;); &#125; argTypes.deleteCharAt(argTypes.length() - 1); // remove trailing , &#125; StringBuilder argValues = new StringBuilder(); if (constructorArgs != null &amp;&amp; !constructorArgs.isEmpty()) &#123; for (Object argValue : constructorArgs) &#123; argValues.append(String.valueOf(argValue)); argValues.append(&quot;,&quot;); &#125; argValues.deleteCharAt(argValues.length() - 1); // remove trailing , &#125; throw new ReflectionException(&quot;Error instantiating &quot; + type + &quot; with invalid types (&quot; + argTypes + &quot;) or values (&quot; + argValues + &quot;). Cause: &quot; + e, e); &#125; &#125; é™¤äº†ä½¿ç”¨MyBatisæä¾›çš„DefaultObjectFactoryå®ç°ï¼Œè¿˜å¯ä»¥åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè‡ªå®šä¹‰çš„ObjectFactoryæ¥å£å®ç°ç´¯ï¼Œ ä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ã€‚ Propertyå·¥å…·ç±»org.apache.ibatis.reflection.property åŒ…ä¸‹ï¼Œæä¾›äº† PropertyCopierã€PropertyNamerã€PropertyTokenizer ä¸‰ä¸ªå±æ€§ç›¸å…³çš„å·¥å…·ç±»ã€‚ PropertyTokenizer åœ¨ä½¿ç”¨MyBatisçš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°ä¸€äº›å±æ€§è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼Œåœ¨æŸ¥è¯¢ç”¨æˆ·ï¼ˆUserï¼‰çš„è®¢å•ï¼ˆOrderï¼‰çš„ç»“æœé›†å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š user_name order item1 item2 â€¦ Mary 124640 iPhone 8 plus MacBook Pro â€¦ Lisa 46546 iPhone 11 Pro Mac Pro â€¦ â€¦ â€¦ â€¦ â€¦ â€¦ å¯¹è±¡æ¨¡å‹å¦‚ä¸‹ï¼š å‡è®¾ç°åœ¨éœ€è¦å°†ç»“æœé›†ä¸­çš„item1åˆ—é›¨ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•ï¼ˆOrderï¼‰çš„ç¬¬ä¸€æ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼Œitem2ä¸ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•çš„ï¼ˆOrderï¼‰çš„ç¬¬äºŒæ¡ç›®ï¼ˆItemï¼‰çš„åç§°æ˜ å°„ï¼ˆè¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­å¾ˆå°‘è¿™æ ·çš„è®¾è®¡ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ˜ å°„è§„åˆ™ï¼š &lt;resultMap id=&quot;rm4testProTool&quot; type=&quot;User&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot; /&gt; &lt;result property=&quot;orders[0].items[0].name&quot; column=&quot;iteml&quot; /&gt; &lt;result property=&quot;orders[0].items[1].name&quot; column=&quot;item2&quot; /&gt;&lt;/resultMap&gt; åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œorders[0].items[0].nameè¿™ç§ç”± .å’Œ[]ç»„æˆçš„è¡¨è¾¾å¼æ˜¯ç”±PropertyTokenizerè¿›è¡Œè§£æçš„ã€‚ä»¥ä¸‹æ˜¯æ­¤ç±»çš„æºç ï¼š public class PropertyTokenizer implements Iterator&lt;PropertyTokenizer&gt; &#123; // å½“å‰è¡¨è¾¾å¼çš„åç§° private String name; // å½“å‰è¡¨è¾¾å¼çš„ç´¢å¼•å private final String indexedName; // ç´¢å¼•ä¸‹æ ‡ private String index; // å­è¡¨è¾¾å¼ private final String children; public PropertyTokenizer(String fullname) &#123; // æŸ¥æ‰¾ . çš„ä½ç½® int delim = fullname.indexOf(&#x27;.&#x27;); if (delim &gt; -1) &#123; // åˆå§‹åŒ– name name = fullname.substring(0, delim); // åˆå§‹åŒ–children children = fullname.substring(delim + 1); &#125; else &#123; name = fullname; children = null; &#125; // åˆå§‹åŒ–indexname indexedName = name; delim = name.indexOf(&#x27;[&#x27;); if (delim &gt; -1) &#123; // åˆå§‹åŒ–index index = name.substring(delim + 1, name.length() - 1); name = name.substring(0, delim); &#125; &#125; public String getName() &#123; return name; &#125; public String getIndex() &#123; return index; &#125; public String getIndexedName() &#123; return indexedName; &#125; public String getChildren() &#123; return children; &#125; @Override public boolean hasNext() &#123; return children != null; &#125; // nextæ–¹æ³•ä¸­ä¼šåˆ›å»ºPropertyTokenizerå¯¹è±¡å¹¶è§£æchildrenå­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼ @Override public PropertyTokenizer next() &#123; return new PropertyTokenizer(children); &#125; @Override public void remove() &#123; throw new UnsupportedOperationException(&quot;Remove is not supported, as it has no meaning in the context of properties.&quot;); &#125;&#125; PropertyTokenizerç»§æ‰¿äº†Iteratoræ¥å£ï¼Œå®ƒå¯ä»¥è¿­ä»£å¤„ç†åµŒå¥—å¤šå±‚è¡¨è¾¾å¼ã€‚ next()æ–¹æ³•ä¸­ä¼šåˆ›å»ºPropertyTokenizerå¯¹è±¡å¹¶è§£æchildrenå­—æ®µè®°å½•çš„å­è¡¨è¾¾å¼ã€‚ ç»§ç»­ä½¿ç”¨è®¢å•ç¤ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæè¿°è§£æå±æ€§è¡¨è¾¾å¼orders[0].items[0].nameçš„è¿­ä»£è¿‡ç¨‹ï¼š PropertyNamer PropertyNameræ˜¯å¦ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†ä¸‹åˆ—é™æ€æ–¹æ³•å¸®åŠ©å®Œæˆæ–¹æ³•ååˆ°å±æ€§åçš„è½¬æ¢ï¼Œä»¥åŠå¤šç§æ£€æµ‹æ“ä½œã€‚ public final class PropertyNamer &#123; private PropertyNamer() &#123; // Prevent Instantiation of Static Class &#125; // å°†æ–¹æ³•åè½¬æ¢æˆå±æ€§å public static String methodToProperty(String name) &#123; if (name.startsWith(&quot;is&quot;)) &#123; name = name.substring(2); &#125; else if (name.startsWith(&quot;get&quot;) || name.startsWith(&quot;set&quot;)) &#123; name = name.substring(3); &#125; else &#123; throw new ReflectionException(&quot;Error parsing property name &#x27;&quot; + name + &quot;&#x27;. Didn&#x27;t start with &#x27;is&#x27;, &#x27;get&#x27; or &#x27;set&#x27;.&quot;); &#125; if (name.length() == 1 || (name.length() &gt; 1 &amp;&amp; !Character.isUpperCase(name.charAt(1)))) &#123; name = name.substring(0, 1).toLowerCase(Locale.ENGLISH) + name.substring(1); &#125; return name; &#125; public static boolean isProperty(String name) &#123; return name.startsWith(&quot;get&quot;) || name.startsWith(&quot;set&quot;) || name.startsWith(&quot;is&quot;); &#125; public static boolean isGetter(String name) &#123; return name.startsWith(&quot;get&quot;) || name.startsWith(&quot;is&quot;); &#125; public static boolean isSetter(String name) &#123; return name.startsWith(&quot;set&quot;); &#125;&#125; PropertyCopier PropertyCopieræ˜¯ä¸€ä¸ªå±æ€§æ‹·è´çš„å·¥å…·ç±»ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯copyBeanProperties()æ–¹æ³•ï¼Œä¸»è¦å®ç°ç›¸åŒç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å±æ€§å€¼æ‹·è´ï¼Œå…·ä½“å¦‚ä¸‹ï¼š public final class PropertyCopier &#123; private PropertyCopier() &#123; // Prevent Instantiation of Static Class &#125; public static void copyBeanProperties(Class&lt;?&gt; type, Object sourceBean, Object destinationBean) &#123; Class&lt;?&gt; parent = type; while (parent != null) &#123; final Field[] fields = parent.getDeclaredFields(); for(Field field : fields) &#123; try &#123; field.setAccessible(true); field.set(destinationBean, field.get(sourceBean)); &#125; catch (Exception e) &#123; // Nothing useful to do, will only fail on final fields, which will be ignored. &#125; &#125; // ç»§ç»­æ‹·è´çˆ¶ç±»ä¸­å®šä¹‰çš„å­—æ®µ parent = parent.getSuperclass(); &#125; &#125;&#125; MetaClassorg.apache.ibatis.reflection.MetaClass ï¼Œç±»çš„å…ƒæ•°æ®ï¼ŒåŸºäº Reflector å’Œ PropertyTokenizer ï¼Œæä¾›å¯¹æŒ‡å®šç±»çš„å„ç§éªšæ“ä½œã€‚å®ç°äº†å¯¹å¤æ‚çš„å±æ€§è¡¨è¾¾å¼çš„è§£æï¼Œå¹¶å®ç°äº†è·å–æŒ‡å®šå±æ€§æè¿°ä¿¡æ¯çš„åŠŸèƒ½ã€‚ ä»£ç ï¼š public class MetaClass &#123; // ç”¨äºç¼“å­˜Reflectorå¯¹è±¡ private final ReflectorFactory reflectorFactory; // åˆ›å»ºMetaClassæ—¶ä¼šæŒ‡å®šä¸€ä¸ªç±»ï¼Œè¯¥Reflectorå¯¹è±¡ä¼šç”¨äºè®°å½•è¯¥ç±»ç›¸å…³çš„å…ƒä¿¡æ¯ private final Reflector reflector; // MetaClassçš„æ„é€ æ–¹æ³•æ˜¯ä½¿ç”¨privateä¿®é¥°çš„ private MetaClass(Class&lt;?&gt; type, ReflectorFactory reflectorFactory) &#123; this.reflectorFactory = reflectorFactory; // åˆ›å»ºReflectorå¯¹è±¡ this.reflector = reflectorFactory.findForClass(type); &#125; // ä½¿ç”¨é™æ€æ–¹æ³•åˆ›å»ºMetaClasså¯¹è±¡ public static MetaClass forClass(Class&lt;?&gt; type, ReflectorFactory reflectorFactory) &#123; return new MetaClass(type, reflectorFactory); &#125; public MetaClass metaClassForProperty(String name) &#123; Class&lt;?&gt; propType = reflector.getGetterType(name); return MetaClass.forClass(propType, reflectorFactory); &#125; public String findProperty(String name) &#123; // å§”æ‰˜ç»™buildProperty()æ–¹æ³•å®ç° StringBuilder prop = buildProperty(name, new StringBuilder()); return prop.length() &gt; 0 ? prop.toString() : null; &#125; public String findProperty(String name, boolean useCamelCaseMapping) &#123; if (useCamelCaseMapping) &#123; name = name.replace(&quot;_&quot;, &quot;&quot;); &#125; return findProperty(name); &#125; public String[] getGetterNames() &#123; return reflector.getGetablePropertyNames(); &#125; public String[] getSetterNames() &#123; return reflector.getSetablePropertyNames(); &#125; public Class&lt;?&gt; getSetterType(String name) &#123; PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; MetaClass metaProp = metaClassForProperty(prop.getName()); return metaProp.getSetterType(prop.getChildren()); &#125; else &#123; return reflector.getSetterType(prop.getName()); &#125; &#125; public Class&lt;?&gt; getGetterType(String name) &#123; PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; MetaClass metaProp = metaClassForProperty(prop); return metaProp.getGetterType(prop.getChildren()); &#125; // issue #506. Resolve the type inside a Collection Object return getGetterType(prop); &#125; private MetaClass metaClassForProperty(PropertyTokenizer prop) &#123; Class&lt;?&gt; propType = getGetterType(prop); return MetaClass.forClass(propType, reflectorFactory); &#125; private Class&lt;?&gt; getGetterType(PropertyTokenizer prop) &#123; Class&lt;?&gt; type = reflector.getGetterType(prop.getName()); if (prop.getIndex() != null &amp;&amp; Collection.class.isAssignableFrom(type)) &#123; Type returnType = getGenericGetterType(prop.getName()); if (returnType instanceof ParameterizedType) &#123; Type[] actualTypeArguments = ((ParameterizedType) returnType).getActualTypeArguments(); if (actualTypeArguments != null &amp;&amp; actualTypeArguments.length == 1) &#123; returnType = actualTypeArguments[0]; if (returnType instanceof Class) &#123; type = (Class&lt;?&gt;) returnType; &#125; else if (returnType instanceof ParameterizedType) &#123; type = (Class&lt;?&gt;) ((ParameterizedType) returnType).getRawType(); &#125; &#125; &#125; &#125; return type; &#125; private Type getGenericGetterType(String propertyName) &#123; try &#123; Invoker invoker = reflector.getGetInvoker(propertyName); if (invoker instanceof MethodInvoker) &#123; Field _method = MethodInvoker.class.getDeclaredField(&quot;method&quot;); _method.setAccessible(true); Method method = (Method) _method.get(invoker); return TypeParameterResolver.resolveReturnType(method, reflector.getType()); &#125; else if (invoker instanceof GetFieldInvoker) &#123; Field _field = GetFieldInvoker.class.getDeclaredField(&quot;field&quot;); _field.setAccessible(true); Field field = (Field) _field.get(invoker); return TypeParameterResolver.resolveFieldType(field, reflector.getType()); &#125; &#125; catch (NoSuchFieldException e) &#123; &#125; catch (IllegalAccessException e) &#123; &#125; return null; &#125; public boolean hasSetter(String name) &#123; PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; if (reflector.hasSetter(prop.getName())) &#123; MetaClass metaProp = metaClassForProperty(prop.getName()); return metaProp.hasSetter(prop.getChildren()); &#125; else &#123; return false; &#125; &#125; else &#123; return reflector.hasSetter(prop.getName()); &#125; &#125; // åˆ¤æ–­æŒ‡å®šå±æ€§æ˜¯å¦æœ‰ getting æ–¹æ³• public boolean hasGetter(String name) &#123; PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; if (reflector.hasGetter(prop.getName())) &#123; MetaClass metaProp = metaClassForProperty(prop); return metaProp.hasGetter(prop.getChildren()); &#125; else &#123; return false; &#125; &#125; else &#123; return reflector.hasGetter(prop.getName()); &#125; &#125; public Invoker getGetInvoker(String name) &#123; return reflector.getGetInvoker(name); &#125; public Invoker getSetInvoker(String name) &#123; return reflector.getSetInvoker(name); &#125; private StringBuilder buildProperty(String name, StringBuilder builder) &#123; // è§£æå±æ€§è¡¨è¾¾å¼ PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; // æ˜¯å¦è¿˜æœ‰å­è¡¨è¾¾å¼ // æŸ¥æ‰¾Propertytokenizer.nameå¯¹åº”çš„å±æ€§ String propertyName = reflector.findPropertyName(prop.getName()); if (propertyName != null) &#123; builder.append(propertyName); builder.append(&quot;.&quot;); // ä¸ºè¯¥å±æ€§åˆ›å»ºå¯¹åº”çš„MetaClasså¯¹è±¡ MetaClass metaProp = metaClassForProperty(propertyName); // é€’å½’è§£æchildrenå­—æ®µï¼Œå°†è§£æç»“æœæ·»åŠ åˆ°builderä¸­ä¿å­˜ metaProp.buildProperty(prop.getChildren(), builder); &#125; &#125; else &#123; // é€’å½’å‡ºå£ String propertyName = reflector.findPropertyName(name); if (propertyName != null) &#123; builder.append(propertyName); &#125; &#125; return builder; &#125; public boolean hasDefaultConstructor() &#123; return reflector.hasDefaultConstructor(); &#125;&#125; MetaClassä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯findProperty()ï¼Œå®ƒæ˜¯é€šè¿‡è°ƒç”¨MetaClass.buildProperty()æ–¹æ³•å®ç°çš„ï¼Œ äºŒbuildProperty()æ–¹æ³•ä¼šé€šè¿‡PropertyTokenizerè§£æå¤æ‚çš„å±æ€§è¡¨è¾¾å¼ ObjectWrapperMetaClassæ˜¯Mybatiså¯¹ç±»çº§åˆ«çš„å…ƒä¿¡æ¯çš„å°è£…å’Œå¤„ç†ï¼Œä¸‹é¢æ¥çœ‹MyBatiså¯¹å¯¹è±¡çº§åˆ«çš„å…ƒä¿¡æ¯çš„å¤„ç†ã€‚ObjectWrapperæ¥å£æ˜¯å¯¹å¯¹è±¡çš„åŒ…è£…ï¼ŒæŠ½è±¡äº†å¯¹è±¡çš„å±æ€§ä¿¡æ¯ï¼Œå®ƒå®šä¹‰äº†ä¸€ç³»åˆ—æŸ¥è¯¢å¯¹è±¡å±æ€§ä¿¡æ¯çš„æ–¹æ³•ï¼Œä»¥åŠæ›´æ–°å±æ€§çš„æ–¹æ³•ã€‚ public interface ObjectWrapper &#123; // å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”å±æ€§çš„ç›¸åº”getteræ–¹æ³•ï¼Œ // å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è·å–æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼ Object get(PropertyTokenizer prop); // å¦‚æœObjectWrapperä¸­å°è£…çš„æ˜¯æ™®é€šçš„Beanå¯¹è±¡ï¼Œåˆ™è°ƒç”¨ç›¸åº”çš„setteræ–¹æ³• // å¦‚æœå°è£…çš„æ˜¯é›†åˆç±»ï¼Œåˆ™è®¾ç½®æŒ‡å®škeyæˆ–ä¸‹æ ‡å¯¹åº”çš„valueå€¼ void set(PropertyTokenizer prop, Object value); // æŸ¥æ‰¾å±æ€§è¡¨è¾¾å¼æŒ‡å®šçš„å±æ€§ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦å¿½ç•¥å±æ€§è¡¨è¾¾å¼ä¸­çš„ä¸‹åˆ’çº¿ String findProperty(String name, boolean useCamelCaseMapping); String[] getGetterNames(); String[] getSetterNames(); Class&lt;?&gt; getSetterType(String name); Class&lt;?&gt; getGetterType(String name); boolean hasSetter(String name); boolean hasGetter(String name); // ä¸ºå±æ€§è¡¨è¾¾å¼çš„å±æ€§åˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡ MetaObject instantiatePropertyValue(String name, PropertyTokenizer prop, ObjectFactory objectFactory); boolean isCollection(); void add(Object element); &lt;E&gt; void addAll(List&lt;E&gt; element);&#125; ObjectWrapperFactoryè´Ÿè´£åˆ›å»ºObjectWrapperå¯¹è±¡ã€‚ DefaultObjectWrapperFactoryå® ç° äº† ObjectWrapperFactoryæ¥å£ï¼Œä½†å®ƒ å® ç° çš„ getWrapperFor() æ–¹æ³•å§‹ç»ˆ æŠ›å‡ºå¼‚ å¸¸ï¼ŒhasWrapperFor()æ–¹æ³•å§‹ç»ˆ è¿”å›falseï¼Œæ‰€ä»¥è¯¥ å® ç° å® é™… ä¸Šæ˜¯ä¸å¯ç”¨çš„ã€‚ä½†æ˜¯ ä¸ ObjectFactory ç±» ä¼¼ï¼Œæˆ‘ä»¬ å¯ä»¥åœ¨ mybatis-config.xml ä¸­é…ç½®è‡ªå®šä¹‰ çš„ ObjectWrapperFactory å® ç° ç±» è¿› è¡Œæ‰© å±•ï¼Œåœ¨åé¢ä»‹ç» MyBatisåˆå§‹åŒ–æ—¶ è¿˜ ä¼š æåˆ°è¯¥ æ‰© å±•ç‚¹ã€‚ BaseWrapperæ˜¯ä¸€ä¸ªå®ç°äº†ObjectWrapperæ¥å£çš„æŠ½è±¡ç±»ï¼Œå…¶ä¸­å°è£…äº†MetaObjectå¯¹è±¡ï¼Œå¹¶æä¾›äº†ä¸‰ä¸ªæ–¹å‹‡çš„æ–¹æ³•æä¾›å…¶å­ç±»ä½¿ç”¨ï¼š BaseWrapper,resolveCollection()æ–¹æ³•ä¼š è°ƒ ç”¨ MetaObject.get Value()æ–¹æ³•ï¼Œå®ƒ ä¼š è§£æå± æ€§è¡¨è¾¾ å¼å¹¶ è· å–æŒ‡å®šçš„å± æ€§ã€‚ BaseWrapper.getCollectionValue()æ–¹æ³•å’Œ setCollectionValue()æ–¹æ³•ä¼š è§£æå± æ€§è¡¨è¾¾ å¼çš„ç´¢å¼• ä¿¡æ¯ï¼Œç„¶åè· å–/è®¾ ç½®å¯¹ åº” é¡¹ ã€‚ MetaObjectorg.apache.ibatis.reflection.MetaObject ï¼Œå¯¹è±¡å…ƒæ•°æ®ï¼Œæä¾›äº†å¯¹è±¡çš„å±æ€§å€¼çš„è·å¾—å’Œè®¾ç½®ç­‰ç­‰æ–¹æ³•ã€‚ å¯ä»¥ç†è§£æˆï¼Œå¯¹ BaseWrapper æ“ä½œçš„è¿›ä¸€æ­¥å¢å¼ºã€‚ ObjectWrapperæä¾›äº†è·å–/è®¾ç½®å¯¹è±¡ä¸­æŒ‡å®šçš„å±æ€§å€¼ã€æ£€æµ‹getter/setterç­‰å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ˜¯ObjectWrapperåªæ˜¯è¿™äº›åŠŸèƒ½çš„æœ€åä¸€ç«™ï¼Œæˆ‘ä»¬çœç•¥äº†å¯¹å±æ€§è¡¨è¾¾å¼è§£æè¿‡ç¨‹çš„ä»‹ç»ï¼Œè€Œè¯¥è§£æè¿‡ç¨‹æ˜¯åœ¨MetaObjectä¸­å®ç°çš„ã€‚ MetaObjectä¸­å­—æ®µçš„å«ä¹‰ï¼š // åŸå§‹JavaBeanå¯¹è±¡private final Object originalObject;// ä¸Šæ–‡ä»‹ç»çš„ObjectWrapperå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†originalObjectå¯¹è±¡private final ObjectWrapper objectWrapper;// è´Ÿè´£å®ä¾‹åŒ–originalObjectçš„å·¥å‚å¯¹è±¡private final ObjectFactory objectFactory;// è´Ÿè´£åˆ›å»ºObjectWrapperçš„å·¥å‚å¯¹è±¡private final ObjectWrapperFactory objectWrapperFactory;// ç”¨äºåˆ›å»ºå¹¶ç¼“å­˜Reflectorå¯¹è±¡çš„å·¥å‚å¯¹è±¡private final ReflectorFactory reflectorFactory; MetaObjectçš„æ„é€ æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„åŸå§‹å¯¹è±¡çš„ç±»å‹ä»¥åŠObjectFactoryå·¥å‚çš„å®ç°ï¼Œ åˆ›å»ºç›¸åº”çš„ObjectWrapperå¯¹è±¡ï¼š private MetaObject( Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory, ReflectorFactory reflectorFactory) &#123; this.originalObject = object; this.objectFactory = objectFactory; this.objectWrapperFactory = objectWrapperFactory; this.reflectorFactory = reflectorFactory; if (object instanceof ObjectWrapper) &#123; this.objectWrapper = (ObjectWrapper) object; &#125; else if (objectWrapperFactory.hasWrapperFor(object)) &#123; this.objectWrapper = objectWrapperFactory.getWrapperFor(this, object); &#125; else if (object instanceof Map) &#123; this.objectWrapper = new MapWrapper(this, (Map) object); &#125; else if (object instanceof Collection) &#123; this.objectWrapper = new CollectionWrapper(this, (Collection) object); &#125; else &#123; this.objectWrapper = new BeanWrapper(this, object); &#125; &#125; MetaObjectå’ŒObjectWrapperä¸­å…³äºç±»çº§åˆ«çš„æ–¹æ³•ï¼Œä¾‹å¦‚hasGetter()ã€hasSetter()ã€findProperty()ç­‰æ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨MetaClassçš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚ å…¶ä»–æ–¹æ³•éƒ½æ˜¯å…³äºå¯¹è±¡çº§åˆ«çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ä¸ObjectWrapperé…åˆå®ç°ï¼Œä¾‹å¦‚MetaObject.getValue()/setValue()æ–¹æ³•ã€‚ ä»¥ä¸‹æ˜¯getValue()çš„ä»£ç ï¼š public Object getValue(String name) &#123; PropertyTokenizer prop = new PropertyTokenizer(name); if (prop.hasNext()) &#123; // æ ¹æ®PropertyTokenizerè§£æåæŒ‡å®šçš„å±æ€§ï¼Œåˆ›å»ºç›¸åº”çš„MetaObjectå¯¹è±¡ MetaObject metaValue = metaObjectForProperty(prop.getIndexedName()); if (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123; return null; &#125; else &#123; return metaValue.getValue(prop.getChildren()); &#125; &#125; else &#123; return objectWrapper.get(prop); &#125; &#125; ç±»å‹è½¬æ¢JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨PreparedStatementä¸ºSQLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œéœ€è¦ä»Javaç±»å‹è½¬æ¢æˆJDBCç±»å‹ï¼Œè€Œä»ç»“æœé›†è·å–æ•°æ®çš„æ—¶å€™ï¼Œåˆ™éœ€è¦ä»JDBCç±»å‹è½¬æ¢æˆJavaç±»å‹ã€‚ MyBatisä½¿ç”¨ç±»å‹è½¬æ¢å¤„ç†å™¨å®Œè½¦è¿‡äº†ä¸Šè¿°ä¸¤ç§è½¬æ¢ã€‚ åœ¨ MyBatisä¸­ä½¿ç”¨JdbcTypeè¿™ ä¸ª æšä¸¾ ç±» å‹ä»£è¡¨JDBCä¸­çš„æ•° æ®ç±» å‹ï¼Œè¯¥ æšä¸¾ ç±» å‹ä¸­å®šä¹‰ äº† TYPE_CODEå­—æ®µï¼Œè®° å½• äº† JDBCç±» å‹åœ¨java.sql.Typesä¸­ç›¸åº” çš„å¸¸é‡ ç¼– ç  ï¼Œå¹¶ é€šè¿‡ ä¸€ä¸ª é™ æ€ é›†åˆcodeLookup (HashMap&lt;Integerï¼ŒJdbcType&gt;ç±» å‹)ç»´ æŠ¤ äº†å¸¸é‡ç¼– ç  ä¸JdbcTypeä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ TypeHandlerMyBatisä¸­æ‰€æœ‰çš„ç±» å‹è½¬ æ¢ å™¨éƒ½ç»§ æ‰¿äº† TypeHandleræ¥å£ï¼Œåœ¨ TypeHandleræ¥å£ä¸­å®šä¹‰ äº†å¦‚ ä¸‹å››ä¸ª æ–¹æ³•ï¼Œè¿™ å››ä¸ª æ–¹æ³•åˆ†ä¸º ä¸¤ ç±» :setParameter()æ–¹æ³•è´Ÿ è´£ å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJava ç±» å‹:getResult()æ–¹æ³•åŠå…¶é‡è½½ è´Ÿ è´£ å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹ã€‚ public interface TypeHandler&lt;T&gt; &#123; //åœ¨é€šè¿‡ PreparedStatementä¸º SQLè¯­ å¥ç»‘ å®šå‚ æ•° æ—¶ ï¼Œä¼š å°† æ•° æ®ç”±JdbcTypeç±» å‹è½¬ æ¢ æˆJavaç±» å‹ void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException; //ä» ResultSetä¸­è· å–æ•° æ®æ—¶ ä¼š è°ƒ ç”¨æ­¤æ–¹æ³•ï¼Œä¼š å°† æ•° æ®ç”±Javaç±» å‹è½¬ æ¢ æˆJdbcTypeç±» å‹ T getResult(ResultSet rs, String columnName) throws SQLException; T getResult(ResultSet rs, int columnIndex) throws SQLException; T getResult(CallableStatement cs, int columnIndex) throws SQLException;&#125; ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰TypeHandlerå®ç°ï¼ŒMyBatisæä¾›äº†BaseTypeHandlerè¿™ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†TypeHandleræ¥å£ï¼Œå¹¶ç»§æ‰¿äº†TypeReferenceæŠ½è±¡ç±»ï¼Œå…¶ç»§æ‰¿ç»“æ„å¦‚ä¸‹ï¼š åœ¨BaseTypeHandlerä¸­å®ç°äº†TypeHandler.setParameter()æ–¹æ³•å’ŒTypeHandler.getResult()æ–¹æ³•ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å¯¹äºéç©ºæ•°æ®çš„å¤„ç†éƒ½äº¤ç»™äº†å­ç±»å®ç°ã€‚ public abstract class BaseTypeHandler&lt;T&gt; extends TypeReference&lt;T&gt; implements TypeHandler&lt;T&gt; &#123; protected Configuration configuration; public void setConfiguration(Configuration c) &#123; this.configuration = c; &#125; @Override public void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException &#123; if (parameter == null) &#123; if (jdbcType == null) &#123; throw new TypeException(&quot;JDBC requires that the JdbcType must be specified for all nullable parameters.&quot;); &#125; try &#123; ps.setNull(i, jdbcType.TYPE_CODE); &#125; catch (SQLException e) &#123; throw new TypeException(&quot;Error setting null for parameter #&quot; + i + &quot; with JdbcType &quot; + jdbcType + &quot; . &quot; + &quot;Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. &quot; + &quot;Cause: &quot; + e, e); &#125; &#125; else &#123; try &#123; setNonNullParameter(ps, i, parameter, jdbcType); &#125; catch (Exception e) &#123; throw new TypeException(&quot;Error setting non null for parameter #&quot; + i + &quot; with JdbcType &quot; + jdbcType + &quot; . &quot; + &quot;Try setting a different JdbcType for this parameter or a different configuration property. &quot; + &quot;Cause: &quot; + e, e); &#125; &#125; &#125; @Override public T getResult(ResultSet rs, String columnName) throws SQLException &#123; T result; try &#123; result = getNullableResult(rs, columnName); &#125; catch (Exception e) &#123; throw new ResultMapException(&quot;Error attempting to get column &#x27;&quot; + columnName + &quot;&#x27; from result set. Cause: &quot; + e, e); &#125; if (rs.wasNull()) &#123; return null; &#125; else &#123; return result; &#125; &#125; @Override public T getResult(ResultSet rs, int columnIndex) throws SQLException &#123; T result; try &#123; result = getNullableResult(rs, columnIndex); &#125; catch (Exception e) &#123; throw new ResultMapException(&quot;Error attempting to get column #&quot; + columnIndex+ &quot; from result set. Cause: &quot; + e, e); &#125; if (rs.wasNull()) &#123; return null; &#125; else &#123; return result; &#125; &#125; @Override public T getResult(CallableStatement cs, int columnIndex) throws SQLException &#123; T result; try &#123; result = getNullableResult(cs, columnIndex); &#125; catch (Exception e) &#123; throw new ResultMapException(&quot;Error attempting to get column #&quot; + columnIndex+ &quot; from callable statement. Cause: &quot; + e, e); &#125; if (cs.wasNull()) &#123; return null; &#125; else &#123; return result; &#125; &#125; public abstract void setNonNullParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException; public abstract T getNullableResult(ResultSet rs, String columnName) throws SQLException; public abstract T getNullableResult(ResultSet rs, int columnIndex) throws SQLException; public abstract T getNullableResult(CallableStatement cs, int columnIndex) throws SQLException;&#125; ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ TypeHandlerç”¨äºå®Œæˆå•ä¸ªå‚æ•°ä»¥åŠå•ä¸ªåˆ—å€¼çš„ç±»å‹è½¬æ¢ï¼Œ å¦‚æœå­˜åœ¨å¤šåˆ—å€¼è½¬æ¢æˆä¸€ä¸ªJavaå¯¹è±¡çš„éœ€æ±‚ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘åœ¨ä½¿ç”¨æ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰åˆé€‚çš„æ˜ å°„è§„åˆ™ï¼ˆï¼‰å®Œæˆæ˜ å°„ã€‚ TypeHandlerRegistryä»‹ç»å®ŒTypeHandleræ¥å£åŠå…¶åŠŸèƒ½ä¹‹åï¼ŒMyBatiså¦‚ä½•ç®¡ç†ä¼—å¤šçš„TypeHanlderæ¥å£å®ç°ï¼Œå¦‚ä½•çŸ¥é“ä½•æ—¶ä½¿ç”¨å“ªä¸ªTypeHandleræ¥å£å®ç°å®Œæˆè½¬æ¢å‘¢ï¼Ÿ è¿™ä¸ªå·¥ä½œæ˜¯ç”±TypeHandlerRegistryå®Œæˆçš„ï¼Œåœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šä¸ºæ‰€æœ‰å·²çŸ¥çš„TypeHanlderåˆ›å»ºå¯¹è±¡ï¼Œå¹¶å®ç°æ³¨å†Œåˆ°TypeHandlerRegistryä¸­ï¼Œ ç”±TypeHandlerRegistryè´Ÿè´£ç®¡ç†è¿™äº›TypeHandlerå¯¹è±¡ã€‚ TypeHandlerRegistryä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰ï¼š // è®°å½•JdbcTypeä¸TypeHandlerä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œå…¶ä¸­JdbcTypeæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå®šä¹‰å¯¹åº”çš„JDBCç±»å‹// è¯¥é›†åˆä¸»è¦ç”¨äºä»ç»“æœé›†è¯»å–æ•°æ®æ—¶ï¼Œå°†æ•°æ®ä»Jdbcç±»å‹è½¬æ¢æˆJavaç±»å‹private final Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = new EnumMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType.class);// è®°å½•äº†Javaç±»å‹å‘æŒ‡å®šJdbcTypeè½¬æ¢æ—¶ï¼Œéœ€è¦ä½¿ç”¨çš„TypeHandlerå¯¹è±¡ã€‚// ä¾‹å¦‚Javaç±»å‹ä¸­çš„Stringå¯èƒ½è½¬æ¢æˆæ•°æ®åº“çš„charã€varcharç­‰å¤šç§ç±»å‹ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»private final Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = new ConcurrentHashMap&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();// è®°å½•äº†å…¨éƒ¨TypeHandlerçš„ç±»å‹ä»¥åŠè¯¥ç±»å‹ç›¸åº”çš„TypeHandlerå¯¹è±¡private final TypeHandler&lt;Object&gt; UNKNOWN_TYPE_HANDLER = new UnknownTypeHandler(this);// ç©ºTypeHandleré›†åˆçš„æ ‡è¯†private final Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; ALL_TYPE_HANDLERS_MAP = new HashMap&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;(); 1. æ³¨å†ŒTypeHandlerå¯¹è±¡ TypeHandlerRegistry.register()æ–¹æ³•å® ç° äº†æ³¨å†Œ TypeHandlerå¯¹ è±¡çš„åŠŸèƒ½ï¼Œè¯¥ æ³¨å†Œ è¿‡ ç¨‹ä¼š å‘ä¸Š è¿°å››ä¸ª é›†åˆä¸­æ·»åŠ TypeHandlerå¯¹ è±¡ã€‚register()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡è½½ ä¹‹é—´ çš„è°ƒ ç”¨å…³ ç³»å¦‚å›¾ ã€‚ ä» ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤šæ•° register()æ–¹æ³•æœ€ç»ˆ ä¼š è°ƒ ç”¨é‡è½½(4) å®Œæˆæ³¨å†Œ åŠŸèƒ½ï¼Œå…ˆæ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ï¼Œå…¶ä¸‰ä¸ª å‚ æ•° åˆ†åˆ« æŒ‡å®šäº† TypeHandlerèƒ½å¤Ÿ å¤„ ç†çš„Javaç±» å‹ã€Jdbcç±» å‹ä»¥åŠ TypeHandlerå¯¹ è±¡ã€‚ é‡è½½(4) private void register(Type javaType, JdbcType jdbcType, TypeHandler&lt;?&gt; handler) &#123; if (javaType != null) &#123;// æ£€æµ‹æ˜¯å¦æ˜ç¡®æŒ‡å®šäº†TypeHanlderèƒ½å¤Ÿå¤„ç†çš„Javaç±»å‹ // è·å–æŒ‡å®šjavaç±»å‹åœ¨TYPE_HANDLER_MAPé›†åˆä¸­å¯¹åº”TypeHanlderé›†åˆ Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; map = TYPE_HANDLER_MAP.get(javaType); if (map == null || map == NULL_TYPE_HANDLER_MAP) &#123; // åˆ›å»ºæ–°çš„TypeHandleré›†åˆï¼Œå¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­ map = new HashMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(); TYPE_HANDLER_MAP.put(javaType, map); &#125; // å°†TypeHandlerå¯¹è±¡æ³¨å†Œåˆ°å¹¶æ·»åŠ åˆ°TYPE_HANDLER_MAPä¸­ map.put(jdbcType, handler); &#125; // å‘ALL_TYPE_HANDLERS_MAPé›†åˆæ³¨å†ŒTypeHandlerç±»å‹å’Œå¯¹åº”çš„TypeHanlderå¯¹è±¡ ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler);&#125; åœ¨(1)ã€œ(3)è¿™ ä¸‰ä¸ª register()æ–¹æ³•é‡è½½ ä¸­ä¼š å° è¯• è¯» å–TypeHandlerç±» ä¸­å®šä¹‰ çš„@MappedTypes æ³¨è§£å’Œ@MappedJdbcTypesæ³¨è§£ï¼Œ@MappedTypesæ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ TypeHandlerå® ç° ç±» èƒ½å¤Ÿ å¤„ ç† çš„Javaç±» å‹çš„é›†åˆï¼Œ@MappedJdbcTypesæ³¨è§£ç”¨äºæŒ‡æ˜è¯¥ TypeHandlerå® ç° ç±» èƒ½å¤Ÿ å¤„ ç†çš„JDBC ç±» å‹é›†åˆã€‚register()æ–¹æ³•çš„é‡è½½(1)ã€œ(3)çš„å…·ä½“ å® ç° å¦‚ä¸‹: é‡è½½(1) // Only handler typepublic void register(Class&lt;?&gt; typeHandlerClass) &#123; boolean mappedTypeFound = false; MappedTypes mappedTypes = typeHandlerClass.getAnnotation(MappedTypes.class); if (mappedTypes != null) &#123; for (Class&lt;?&gt; javaTypeClass : mappedTypes.value()) &#123; register(javaTypeClass, typeHandlerClass); mappedTypeFound = true; &#125; &#125; if (!mappedTypeFound) &#123; register(getInstance(null, typeHandlerClass)); &#125;&#125; é‡è½½(2) public &lt;T&gt; void register(TypeHandler&lt;T&gt; typeHandler) &#123; boolean mappedTypeFound = false; MappedTypes mappedTypes = typeHandler.getClass().getAnnotation(MappedTypes.class); if (mappedTypes != null) &#123; for (Class&lt;?&gt; handledType : mappedTypes.value()) &#123; register(handledType, typeHandler); mappedTypeFound = true; &#125; &#125; // @since 3.1.0 - try to auto-discover the mapped type if (!mappedTypeFound &amp;&amp; typeHandler instanceof TypeReference) &#123; try &#123; TypeReference&lt;T&gt; typeReference = (TypeReference&lt;T&gt;) typeHandler; register(typeReference.getRawType(), typeHandler); mappedTypeFound = true; &#125; catch (Throwable t) &#123; // maybe users define the TypeReference with a different type and are not assignable, so just ignore it &#125; &#125; if (!mappedTypeFound) &#123; register((Class&lt;T&gt;) null, typeHandler); &#125;&#125; é‡è½½(3) private &lt;T&gt; void register(Type javaType, TypeHandler&lt;? extends T&gt; typeHandler) &#123; MappedJdbcTypes mappedJdbcTypes = typeHandler.getClass().getAnnotation(MappedJdbcTypes.class); if (mappedJdbcTypes != null) &#123; for (JdbcType handledJdbcType : mappedJdbcTypes.value()) &#123; register(javaType, handledJdbcType, typeHandler); &#125; if (mappedJdbcTypes.includeNullJdbcType()) &#123; register(javaType, null, typeHandler); &#125; &#125; else &#123; register(javaType, null, typeHandler); &#125;&#125; ä¸Š è¿° å…¨ éƒ¨ çš„ register()æ–¹ æ³• é‡ è½½ éƒ½ æ˜¯ åœ¨ å‘ TYPE_HANDLER_MAPé›† åˆ å’Œ ALL_TYPE_HANDLERS_MAP é›†åˆæ³¨å†Œ TypeHandler å¯¹ è±¡ï¼Œè€Œé‡è½½(5)æ˜¯å‘ JDBC_TYPE_HANDLER_MAP é›†åˆæ³¨å†Œ TypeHandlerå¯¹ è±¡ï¼Œå…¶å…·ä½“ å® ç° å¦‚ä¸‹: é‡è½½(5) public void register(JdbcType jdbcType, TypeHandler&lt;?&gt; handler) &#123; JDBC_TYPE_HANDLER_MAP.put(jdbcType, handler);&#125; TypeHandlerRegistryé™¤äº†æä¾›æ³¨å†Œ å• ä¸ª TypeHandlerçš„register()é‡è½½ ï¼Œè¿˜ å¯ä»¥æ‰« ææ•´ä¸ª åŒ…ä¸‹ çš„TypeHandleræ¥å£å® ç° ç±» ï¼Œå¹¶ å°† å®Œæˆè¿™ äº›TypeHandlerå® ç° ç±» çš„æ³¨å†Œ ã€‚ é‡è½½(6) public void register(String packageName) &#123; ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;Class&lt;?&gt;&gt;(); // æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„æ¥å£å®ç°ç±» resolverUtil.find(new ResolverUtil.IsA(TypeHandler.class), packageName); Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; handlerSet = resolverUtil.getClasses(); for (Class&lt;?&gt; type : handlerSet) &#123; //Ignore inner classes and interfaces (including package-info.java) and abstract classes if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) &#123; register(type); &#125; &#125;&#125; 2. æŸ¥æ‰¾TypeHandler TypeHandlerRegistryæä¾›äº†æŸ¥ æ‰¾ TypeHandlerå¯¹ è±¡çš„åŠŸèƒ½ã€‚TypeHandlerRegistry.getTypeHandler()æ–¹æ³•å® ç° äº†ä» ä¸Šè¿°å››ä¸ª é›†åˆä¸­è· å–å¯¹ åº” TypeHandlerå¯¹ è±¡çš„åŠŸèƒ½ã€‚TypeHandlerRegistry.getTypeHandler()æ–¹æ³•æœ‰å¤šä¸ª é‡è½½ ï¼Œè¿™ äº›é‡ è½½ ä¹‹é—´ çš„å…³ ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç» è¿‡ ä¸€ç³»åˆ—ç±» å‹è½¬ æ¢ ä¹‹åï¼ŒTypeHandlerRegistry.getTypeHandler()æ–¹æ³•çš„å¤šä¸ª é‡è½½ éƒ½ä¼š è°ƒ ç”¨ TypeHandlerRegistry.getTypeHandle(Type, JdbcType)è¿™ ä¸ª é‡è½½ æ–¹æ³•ï¼Œå®ƒ ä¼š æ ¹æ®æŒ‡å®šçš„ Java ç±» å‹å’Œ JdbcTypeç±» å‹æŸ¥ æ‰¾ ç›¸åº” çš„TypeHandlerå¯¹ è±¡ã€‚ TypeAliasRegistryåœ¨ç¼– å†™ SQLè¯­ å¥æ—¶ ï¼Œä½¿ç”¨åˆ« åå¯ä»¥æ–¹ä¾¿ç†è§£ä»¥åŠç»´ æŠ¤ ï¼Œä¾‹å¦‚è¡¨åæˆ–åˆ—åå¾ˆ é•¿ æ—¶ ï¼Œæˆ‘ä»¬ ä¸€èˆ¬ ä¼š ä¸º å…¶è®¾ è®¡ æ˜“æ‡‚ æ˜“ç»´ æŠ¤ çš„åˆ« åã€‚MyBatiså°† SQLè¯­ å¥ä¸­åˆ« åçš„æ¦‚ å¿µè¿› è¡Œäº†å»¶ä¼¸å’Œæ‰© å±•ï¼ŒMyBatis å¯ä»¥ä¸º ä¸€ä¸ª ç±» æ·»åŠ ä¸€ä¸ª åˆ« åï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡ åˆ« åå¼•ç”¨è¯¥ ç±» ã€‚ MyBatisé€šè¿‡ TypeAliasRegistryç±» å®Œæˆåˆ« åæ³¨å†Œ å’Œç®¡ç†çš„åŠŸèƒ½ï¼ŒTypeAliasRegistryçš„ç»“ æ„ æ¯” è¾ƒ ç®€ å• ï¼Œå®ƒ é€šè¿‡ TYPE_ALIASESå­—æ®µ(Map&lt;Stringï¼ŒClass&lt;?&gt;&gt;ç±» å‹)ç®¡ç†åˆ« åä¸ Javaç±» å‹ä¹‹é—´ çš„å¯¹ åº” å…³ ç³»ï¼Œé€šè¿‡ TypeAHasRegistiy.registerAlias()æ–¹æ³•å®Œæˆæ³¨å†Œ åˆ« åï¼Œè¯¥ æ–¹æ³•çš„å…·ä½“ å® ç° å¦‚ä¸‹: public void registerAlias(String alias, Class&lt;?&gt; value) &#123; if (alias == null) &#123; throw new TypeException(&quot;The parameter alias cannot be null&quot;); &#125; // å°†åˆ«åè½¬æ¢æˆå°å†™ String key = alias.toLowerCase(Locale.ENGLISH); // æ£€æµ‹åˆ«åæ˜¯å¦å­˜åœ¨ if (TYPE_ALIASES.containsKey(key) &amp;&amp; TYPE_ALIASES.get(key) != null &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123; throw new TypeException(&quot;...&quot;); &#125; TYPE_ALIASES.put(key, value);&#125; åœ¨ TypeAliasRegistryçš„æ„ é€ æ–¹æ³•ä¸­ï¼Œé»˜è®¤ ä¸º Javaçš„åŸºæœ¬ç±» å‹åŠå…¶æ•° ç»„ ç±» å‹ã€åŸºæœ¬ç±» å‹çš„å° è£… ç±» åŠå…¶æ•°ç»„ç±»å‹ã€Dateã€BigDecimalã€Biglntegerã€Mapã€HashMapã€Listã€ArrayListã€Collectionã€ Iteratorã€ResultSetç­‰ç±» å‹æ·»åŠ äº†åˆ«åã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"åŸºç¡€æ”¯æŒå±‚â€”â€”è§£æå™¨æ¨¡å—","date":"2019-10-24T01:09:42.000Z","path":"2019/10/24/94150c5.html","text":"MyBatisåŸºç¡€æ”¯æŒå±‚ä½äº Mybatis æ•´ä½“æ¶æ„çš„æœ€åº•å±‚ï¼Œæ”¯æ’‘ç€ Mybatis çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ˜¯æ•´ä¸ªæ¡†æ¶çš„åŸºçŸ³ã€‚åŸºç¡€æ”¯æŒå±‚ä¸­å°è£…äº†å¤šä¸ªè¾ƒä¸ºé€šç”¨çš„ã€ç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸ä»…ä»…ä¸º Mybatis æä¾›åŸºç¡€æ”¯æ’‘ï¼Œä¹Ÿå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯ä¸­ç›´æ¥å¤ç”¨ã€‚ è¿™ç¯‡æ–‡ç« ä»‹ç»MyBatisçš„è§£æå™¨æ¨¡å— Mybatisä¸­æ¶‰åŠå¤§é‡çš„XMLé…ç½®æ–‡ä»¶ï¼Œå¸¸è§çš„XMLè§£ææ–¹å¼ï¼šDOMã€SAXå’ŒStAXã€‚ XPathç®€ä»‹MyBatisåœ¨åˆå§‹åŒ–è¿‡ ç¨‹ä¸­å¤„ ç†mybatis-config.xmlé…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„æ–‡ä»¶æ—¶ ï¼Œä½¿ç”¨çš„æ˜¯DOM è§£ææ–¹å¼ï¼Œå¹¶ ç»“ åˆä½¿ç”¨XPathè§£æXMLé…ç½®æ–‡ä»¶ã€‚ æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼ŒDOMä¼šå°†æ•´ä¸ª XMLæ–‡æ¡£ åŠ è½½ åˆ°å†… å­˜ä¸­å¹¶ å½¢æˆæ ‘çŠ¶æ•°æ®ç»“æ„ ï¼Œè€Œ XPathæ˜¯ä¸€ç§ ä¸º æŸ¥ è¯¢ XMLæ–‡æ¡£ è€Œè®¾ è®¡ çš„è¯­ è¨€ï¼Œå®ƒ å¯ä»¥ ä¸ DOMè§£ææ–¹å¼é…åˆä½¿ç”¨ï¼Œå® ç° å¯¹ XMLæ–‡æ¡£ çš„è§£æã€‚ Xpath ä¹‹äº XML å°±å¥½æ¯” SQL è¯­è¨€ä¹‹äºæ•°æ®åº“ã€‚ XPathParserMybatis æä¾›çš„ Xpathparser ç±»å°è£…äº†Xpathã€Document å’Œ Entityresolverã€‚ Xpathparser ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å’ŒåŠŸèƒ½å¦‚ä¸‹æ‰€ç¤ºã€‚ private Document document; // Document å¯¹è±¡ private boolean validation; //æ˜¯å¦å¼€å¯éªŒè¯private Entityresolver entityresolver; //ç”¨äºåŠ è½½æœ¬åœ° DTD æ–‡ä»¶private Properties variables; // mybatis- config. Xm1 ä¸­ã€Špropteriesã€‹æ ‡ç­¾å®šä¹‰çš„é”®å€¼å¯¹é›†åˆ private Xpath xpath; // Xpath å¯¹è±¡ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹ XML æ–‡æ¡£è¿›è¡ŒéªŒè¯æ—¶ï¼Œä¼šæ ¹æ® XML æ–‡æ¡£å¼€å§‹ä½ç½®æŒ‡å®šçš„ç½‘å€åŠ è½½å¯¹åº”çš„ DTD æ–‡ä»¶æˆ– XSD æ–‡ä»¶ã€‚ å¦‚æœè§£æ mybatis- config. Xml é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤è”ç½‘åŠ è½½ http: / mybatis. Org, / dtd/mybatis-3- config. Dtd è¿™ä¸ª DTD æ–‡æ¡£ï¼Œå½“ç½‘ç»œæ¯”è¾ƒæ…¢æ—¶ä¼šå¯¼è‡´éªŒè¯è¿‡ç¨‹ç¼“æ…¢ã€‚ åœ¨å®è·µä¸­å¾€å¾€ä¼šæå‰è®¾ç½® Entityresolver æ¥å£å¯¹è±¡åŠ è½½æœ¬åœ°çš„ DTD æ–‡ä»¶ï¼Œä»è€Œé¿å…è”ç½‘åŠ è½½ DTD æ–‡ä»¶ã€‚ Xmlmapperentity Resolver æ˜¯ Mybatis æä¾›çš„ Entity Resolver æ¥å£çš„å®ç°ç±»ã€‚ EntityResolver æ¥å£çš„æ ¸å¿ƒæ˜¯ resolveEntity()æ–¹æ³•ï¼ŒXMLMapperEntityResolver çš„å® ç° å¦‚ä¸‹ public class XMLMapperEntityResolver implements EntityResolver &#123; private static final String IBATIS_CONFIG_SYSTEM = &quot;ibatis-3-config.dtd&quot;; private static final String IBATIS_MAPPER_SYSTEM = &quot;ibatis-3-mapper.dtd&quot;; private static final String MYBATIS_CONFIG_SYSTEM = &quot;mybatis-3-config.dtd&quot;; private static final String MYBATIS_MAPPER_SYSTEM = &quot;mybatis-3-mapper.dtd&quot;; private static final String MYBATIS_CONFIG_DTD = &quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;; private static final String MYBATIS_MAPPER_DTD = &quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;; @Override public InputSource resolveEntity(String publicId, String systemId) throws SAXException &#123; try &#123; if (systemId != null) &#123; String lowerCaseSystemId = systemId.toLowerCase(Locale.ENGLISH); if (lowerCaseSystemId.contains(MYBATIS_CONFIG_SYSTEM) || lowerCaseSystemId.contains(IBATIS_CONFIG_SYSTEM)) &#123; return getInputSource(MYBATIS_CONFIG_DTD, publicId, systemId); &#125; else if (lowerCaseSystemId.contains(MYBATIS_MAPPER_SYSTEM) || lowerCaseSystemId.contains(IBATIS_MAPPER_SYSTEM)) &#123; return getInputSource(MYBATIS_MAPPER_DTD, publicId, systemId); &#125; &#125; return null; &#125; catch (Exception e) &#123; throw new SAXException(e.toString()); &#125; &#125; private InputSource getInputSource(String path, String publicId, String systemId) &#123; InputSource source = null; if (path != null) &#123; try &#123; InputStream in = Resources.getResourceAsStream(path); source = new InputSource(in); source.setPublicId(publicId); source.setSystemId(systemId); &#125; catch (IOException e) &#123; // ignore, null is ok &#125; &#125; return source; &#125;&#125; å›åˆ°å¯¹ XPathParser çš„ åˆ† æ ï¼Œåœ¨ XPathParser. createDocument()æ–¹æ³•ä¸­å°è£… äº†å‰é¢ä»‹ç» çš„åˆ› å»ºDocumentå¯¹ è±¡çš„è¿‡ ç¨‹å¹¶ è§¦ å‘ äº†åŠ è½½ XMLæ–‡æ¡£ çš„ è¿‡ ç¨‹ï¼Œå…·ä½“ å® ç° å¦‚ä¸‹: private void commonConstructor(boolean validation, Properties variables, EntityResolver entityResolver) &#123; this.validation = validation; this.entityResolver = entityResolver; this.variables = variables; XPathFactory factory = XPathFactory.newInstance(); this.xpath = factory.newXPath();&#125;private Document createDocument(InputSource inputSource) &#123; // important: this must only be called AFTER common constructor try &#123; DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); factory.setValidating(validation); factory.setNamespaceAware(false); factory.setIgnoringComments(true); factory.setIgnoringElementContentWhitespace(false); factory.setCoalescing(false); factory.setExpandEntityReferences(true); DocumentBuilder builder = factory.newDocumentBuilder(); builder.setEntityResolver(entityResolver); builder.setErrorHandler(new ErrorHandler() &#123; @Override public void error(SAXParseException exception) throws SAXException &#123; throw exception; &#125; @Override public void fatalError(SAXParseException exception) throws SAXException &#123; throw exception; &#125; @Override public void warning(SAXParseException exception) throws SAXException &#123; &#125; &#125;); return builder.parse(inputSource); &#125; catch (Exception e) &#123; throw new BuilderException(&quot;Error creating document instance. Cause: &quot; + e, e); &#125;&#125; Xpathparser ä¸­æä¾›äº†ä¸€ç³»åˆ—çš„ eval*0 æ–¹æ³•ç”¨äºè§£æ booleanã€shotã€longã€intã€Stringã€Node ç­‰ç±»å‹çš„ä¿¡æ¯ï¼Œå®ƒé€šè¿‡è°ƒç”¨å‰é¢ä»‹ç»çš„ Xpath. Evaluate() æ–¹æ³•æŸ¥æ‰¾æŒ‡å®šè·¯å¾„çš„èŠ‚ç‚¹æˆ–å±æ€§ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„ç±»å‹è£…æ¢ã€‚å…·ä½“ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸è´´å‡ºæ¥äº†ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Xpathparser. Evalstring() æ–¹æ³•ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ Propertyparser. Parse() æ–¹æ³•å¤„ç†èŠ‚ç‚¹ä¸­ç›¸åº”çš„é»˜è®¤å€¼ã€‚ åœ¨ Propertyparser ä¸­æŒ‡å®šäº†æ˜¯å¦å¼€å¯ä½¿ç”¨é»˜è®¤å€¼çš„åŠŸèƒ½ä»¥åŠé»˜è®¤çš„åˆ†éš”ç¬¦ PropertyParser.parse() æ–¹æ³•ä¸­ä¼šåˆ›å»º Generic Tokenparser è§£æå™¨ï¼Œå¹¶å°†é»˜è®¤å€¼çš„å¤„ç†å§”æ‰˜ç»™Generic Tokenparser.parse()æ–¹æ³•ã€‚ Generic Tokenparser æ˜¯ä¸€ä¸ªé€šç”¨çš„å­—å ä½ç¬¦è§£æå™¨ï¼Œå…¶å­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š Private final String opentoken; //å ä½ç¬¦çš„å¼€å§‹æ ‡è®° private final String closetoken; //å ä½ç¬¦çš„ç»“æ±æ ‡è®°private final Tokenhandler handler; // Tokenhandler æ¥å£çš„å®ç°ä¼šæŒ‰ç…§ä¸€å®šçš„é€»è¾‘è§£æå ä½ç¬¦ GenericTokenparser.parse() æ–¹æ³•çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå®ƒä¼šé¡ºåºæŸ¥æ‰¾ openToken å’Œ closeTokenï¼Œè§£æå¾—åˆ°å ä½ç¬¦çš„å­—é¢å€¼ï¼Œå¹¶å°†å…¶äº¤ç»™ Tokenhandler å¤„ç†ï¼Œç„¶åå°†è§£æç»“æœé‡æ–°æ‹¼è£…æˆå­—ç¬¦ä¸²å¹¶è¿”å›ã€‚ å‚è€ƒ ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"MyBatiså¿«é€Ÿå…¥é—¨","date":"2019-10-21T03:31:35.000Z","path":"2019/10/21/3f93d624.html","text":"å¿ƒè¡€æ¥æ½®ï¼Œæäº†æœ¬ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹ï¼Œæ•´ç†ä¸€äº›æ ¸å¿ƒå†…å®¹ æ€ç»´å¯¼å›¾ï¼š æ•´ä½“æ¶æ„ï¼š åŸºç¡€æ”¯æŒå±‚åŸºç¡€æ”¯æŒå±‚åŒ…å«æ•´ä¸ª Mybatis çš„åŸºç¡€æ¨¡å—ï¼Œè¿™äº›æ¨¡å—ä¸ºæ ¸å¿ƒå¤„ç†å±‚çš„åŠŸèƒ½æä¾›äº†è‰¯å¥½çš„æ”¯æ’‘ã€‚ åå°„æ¨¡å—Java ä¸­çš„åå°„è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†å¯¹å¤§å¤šæ•°å¼€å‘äººå‘˜æ¥è¯´ï¼Œå†™å‡ºé«˜è´¨é‡çš„åå°„ä»£ç è¿˜æ˜¯ æœ‰ä¸€å®šéš¾åº¦çš„ã€‚Mybatis ä¸­ä¸“é—¨æä¾›äº†åå°„æ¨¡å—ï¼Œè¯¥æ¨¡å—å¯¹ Java åŸç”Ÿçš„åå°„è¿›è¡Œäº†è‰¯å¥½çš„å°è£…ï¼Œæä¾›äº†æ›´åŠ ç®€æ´æ˜“ç”¨çš„ APï¼Œæ–¹ä¾¿ä¸Šå±‚ä½¿è°ƒç”¨ï¼Œå¹¶ä¸”å¯¹åå°„æ“ä½œè¿›è¡Œäº†ç³»åˆ—ä¼˜åŒ–ï¼Œä¾‹å¦‚ç¼“å­˜äº†ç±»çš„å…ƒæ•°æ®ï¼Œæé«˜äº†åå°„æ“ä½œçš„æ€§èƒ½ã€‚ ç±»å‹è½¬æ¢æ¨¡å—æ­£å¦‚å‰é¢ç¤ºä¾‹æ‰€ç¤ºï¼ŒMybatis ä¸ºç®€åŒ–é…ç½®æ–‡ä»¶æä¾›äº†åˆ«åæœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ˜¯ç±»å‹è½¬æ¢æ¨¡å—çš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ã€‚ ç±»å‹è½¬æ¢æ¨¡å—çš„å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯å®ç° JDBC ç±»å‹ä¸ Java ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè¯¥åŠŸèƒ½åœ¨ä¸º SQL è¯­å¥ç»‘å®šå®å‚ä»¥åŠæ˜ å°„æŸ¥è¯¢ç»“æœé›†æ—¶éƒ½ä¼šæ¶‰åŠã€‚åœ¨ä¸º SQL è¯­å¥ç»‘å®šå®å‚æ—¶ï¼Œä¼šå°†æ•°æ®ç”± Java ç±»å‹è½¬æ¢æˆ JDBC ç±»å‹ï¼›è€Œåœ¨æ˜ å°„ç»“æœé›†æ—¶ï¼Œä¼šå°†æ•°æ®ç”± JDBC ç±»å‹è½¬æ¢æˆ Java ç±»å‹ã€‚ ###æ—¥å¿—æ¨¡å— æ— è®ºåœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¿˜æ˜¯åœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„åœ°ä½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚è‰¯å¥½çš„æ—¥å¿—åŠŸèƒ½å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿå®šä½ Bug ä»£ç ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆç­‰é—®é¢˜ã€‚ç›®å‰çš„ Java ä¸–ç•Œä¸­å­˜åœ¨å¾ˆå¤šä¼˜ç§€çš„æ—¥å¿—æ¡†æ¶ï¼Œä¾‹å¦‚ Log4jã€Log4j2ã€slf4 ç­‰ã€‚Mybatis ä½œä¸ºä¸€ä¸ªè®¾è®¡ä¼˜è‰¯çš„æ¡†æ¶ï¼Œé™¤äº†æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¿¡æ¯ï¼Œè¿˜è¦èƒ½å¤Ÿé›†æˆå¤šç§æ—¥å¿—æ¡†æ¶ï¼Œå…¶æ—¥å¿—æ¨¡å—çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯é›†æˆç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶ã€‚èµ„æºåŠ è½½æ¨¡å— èµ„æºåŠ è½½æ¨¡å—ä¸»è¦æ˜¯å¯¹ç±»åŠ è½½å™¨è¿›è¡Œå°è£…ï¼Œç¡®å®šç±»åŠ è½½å™¨çš„ä½¿ç”¨é¡ºåºï¼Œå¹¶æä¾›äº†åŠ è½½ç±»æ–‡ä»¶ä»¥åŠå…¶ä»–èµ„æºæ–‡ä»¶çš„åŠŸèƒ½ã€‚ è§£æå™¨æ¨¡å—è§£æå™¨æ¨¡å—çš„ä¸»è¦æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼šä¸€ä¸ªåŠŸèƒ½æ˜¯å¯¹ Xpath è¿›è¡Œå°è£…ï¼Œä¸º Mybatis åˆå§‹åŒ–æ—¶è§£æ mybatis-config, xml é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æä¾›æ”¯æŒï¼›å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯ä¸ºå¤„ç†åŠ¨æ€ SQL è¯­å¥ä¸­çš„å ä½ç¬¦æä¾›æ”¯æŒã€‚æ•°æ®æºæ¨¡å— æ•°æ®æºæ˜¯å®é™…å¼€å‘ä¸­å¸¸ç”¨çš„ç»„ä»¶ä¹‹ä¸€ã€‚ç°åœ¨å¼€æºçš„æ•°æ®æºéƒ½æä¾›äº†æ¯”è¾ƒä¸°å¯Œçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œè¿æ¥æ± åŠŸèƒ½ã€æ£€æµ‹è¿æ¥çŠ¶æ€ç­‰ï¼Œé€‰æ‹©æ€§èƒ½ä¼˜ç§€çš„æ•°æ®æºç»„ä»¶å¯¹äºæå‡ ORM æ¡†æ¶ä¹ƒè‡³æ•´ä¸ªåº”ç”¨çš„æ€§èƒ½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚Mybatis è‡ªèº«æä¾›äº†ç›¸åº”çš„æ•°æ®æºå®ç°ï¼Œå½“ç„¶ Mybatis ä¹Ÿæä¾›äº†ä¸ç¬¬ä¸‰æ–¹æ•°æ®æºé›†æˆçš„æ¥å£ï¼Œè¿™äº›åŠŸèƒ½éƒ½ä½äºæ•°æ®æºæ¨¡å—ä¹‹ä¸­ã€‚ äº‹åŠ¡ç®¡ç†Mybatis å¯¹æ•°æ®åº“ä¸­çš„äº‹åŠ¡è¿›è¡Œäº†æŠ½è±¡ï¼Œå…¶è‡ªèº«æä¾›äº†ç›¸åº”çš„äº‹åŠ¡æ¥å£å’Œç®€å•å®ç°ã€‚åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼ŒMy Batis ä¼šä¸ Spring æ¡†æ¶é›†æˆï¼Œå¹¶ç”± Spring æ¡†æ¶ç®¡ç†äº‹åŠ¡ï¼Œåœ¨ç¬¬ 4 ç« ä¼šä»‹ç» Mybatis å¦‚ä½•ä¸ Spring é›†æˆå¼€å‘ï¼Œå…¶ä¸­å°±ä¼šæ¶‰åŠ Spring æ¡†æ¶ç®¡ç†äº‹åŠ¡ç›¸å…³çš„é…ç½®ã€‚ ç¼“å­˜æ¨¡å—åœ¨ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½æ—¶ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œè€Œæ·»åŠ ç¼“å­˜åˆ™æ˜¯ä¼˜åŒ–æ•°æ®åº“æ—¶æœ€æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ã€‚æ­£ç¡®ã€åˆç†åœ°ä½¿ç”¨ç¼“å­˜å¯ä»¥å°†ä¸€éƒ¨åˆ†æ•°æ®åº“è¯·æ±‚æ‹¦æˆªåœ¨ç¼“å­˜è¿™ä¸€å±‚ï¼Œè¿™å°±èƒ½å¤Ÿå‡å°‘ç›¸å½“ä¸€éƒ¨åˆ†æ•°æ®åº“çš„å‹åŠ›ã€‚ Mybatis ä¸­æä¾›äº†ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œè€Œè¿™ä¸¤çº§ç¼“å­˜éƒ½æ˜¯ä¾èµ–äºåŸºç¡€æ”¯æŒå±‚ä¸­çš„ç¼“å­˜æ¨¡å—å®ç°çš„ã€‚è¿™é‡Œéœ€è¦è¯»è€…æ³¨æ„çš„æ˜¯ï¼ŒMybatis ä¸­è‡ªå¸¦çš„è¿™ä¸¤çº§ç¼“å­˜ä¸ Mybatis ä»¥åŠæ•´ä¸ªåº”ç”¨æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ª JM ä¸­çš„ï¼Œå…±äº«åŒä¸€å—å †å†…å­˜ã€‚å¦‚æœè¿™ä¸¤çº§ç¼“å­˜ä¸­çš„æ•°æ®é‡è¾ƒå¤§ï¼Œåˆ™å¯èƒ½å½±å“ç³»ç»Ÿä¸­å…¶ä»–åŠŸèƒ½çš„è¿è¡Œï¼Œæ‰€ä»¥å½“éœ€è¦ç¼“å­˜å¤§é‡æ•°æ®æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ Redisã€Memcache ç­‰ç¼“å­˜äº§å“ã€‚ Binding æ¨¡å—é€šè¿‡å‰é¢çš„ç¤ºä¾‹æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è°ƒç”¨ Sqlsession ç›¸åº”æ–¹æ³•æ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œéœ€è¦æŒ‡å®šæ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„ SQL èŠ‚ç‚¹ï¼Œå¦‚æœå‡ºç°æ‹¼å†™é”™è¯¯ï¼Œæˆ‘ä»¬åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°ç›¸åº”çš„å¼‚å¸¸ã€‚ä¸ºäº†å°½æ—©å‘ç°è¿™ç§é”™è¯¯ï¼ŒMybatis é€šè¿‡ Binding æ¨¡å—å°†ç”¨æˆ·è‡ªå®šä¹‰çš„ Mapper 1 æ¥å£ä¸æ˜ å°„é…ç½®æ–‡ä»¶å…³è”èµ·æ¥ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡è°ƒç”¨è‡ªå®šä¹‰ Mapper æ¥å£ä¸­çš„æ–¹æ³•æ‰§è¡Œç›¸åº”çš„ SQL è¯­å¥å®Œæˆæ•°æ®åº“æ“ä½œï¼Œä»è€Œé¿å…ä¸Šè¿°é—®é¢˜ã€‚ å€¼å¾—è¯»è€…æ³¨æ„çš„æ˜¯ï¼Œå¼€å‘äººå‘˜æ— é¡»ç¼–å†™è‡ªå®šä¹‰ Mapper æ¥å£çš„å®ç°ï¼ŒMy Batis ä¼šè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚åœ¨æœ‰äº›åœºæ™¯ä¸­ï¼Œè‡ªå®šä¹‰ Mapper æ¥å£å¯ä»¥å®Œå…¨ä»£æ›¿æ˜ å°„é…ç½®æ–‡ä»¶ï¼Œä½†æœ‰çš„æ˜ å°„è§„åˆ™å’Œ SQL è¯­å¥çš„å®šä¹‰è¿˜æ˜¯å†™åœ¨æ˜ å°„é…ç½®æ–‡ä»¶ä¸­æ¯”è¾ƒæ–¹ä¾¿ï¼Œä¾‹å¦‚åŠ¨æ€ SQL è¯­å¥çš„å®šä¹‰ã€‚ æ ¸å¿ƒå¤„ç†å±‚é…ç½®è§£æåœ¨ Mybatis åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šåŠ è½½ mybatis-config. Xml é…ç½®æ–‡ä»¶ã€æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠ Mapper æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ï¼Œè§£æåçš„é…ç½®ä¿¡æ¯ä¼šå½¢æˆç›¸åº”çš„å¯¹è±¡å¹¶ä¿å­˜åˆ° Configuration å¯¹è±¡ä¸­ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­å®šä¹‰çš„~ &lt;resultmapã€‹èŠ‚ç‚¹ï¼ˆå³ Resultset I çš„æ˜ å°„è§„åˆ™ï¼‰ä¼šè¢«è§£ææˆ Resultmap å¯¹è±¡ï¼›ç¤ºä¾‹ä¸­å®šä¹‰çš„ã€Šresult èŠ‚ç‚¹ï¼ˆå³å±æ€§æ˜ å°„ï¼‰ä¼šè¢«è§£ææˆ Resultmapping å¯¹è±¡ã€‚ä¹‹åï¼Œåˆ©ç”¨è¯¥ Configuration å¯¹è±¡åˆ›å»º Sqlsessionfactory å¯¹è±¡ã€‚å¾… Mybatis åˆå§‹åŒ–ä¹‹åï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡åˆå§‹åŒ–å¾—åˆ° Sqlsessionfactory åˆ›å»º Sqlsession å¯¹è±¡å¹¶å®Œæˆæ•°æ®åº“æ“ä½œã€‚ SQL è§£æä¸ scripting æ¨¡å—æ‹¼å‡‘ SQL è¯­å¥æ˜¯ä¸€ä»¶çƒ¦çä¸”æ˜“å‡ºé”™çš„è¿‡ç¨‹ï¼Œä¸ºäº†å°†å¼€å‘äººå‘˜ä»è¿™é¡¹æ¯ç‡¥æ— è¶£çš„å·¥ä½œä¸­è§£è„±å‡ºæ¥ï¼ŒMybatis å®ç°åŠ¨æ€ SQL è¯­å¥çš„åŠŸèƒ½ï¼Œæä¾›äº†å¤šç§åŠ¨æ€ SQL è¯­å¥å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼ŒwhereèŠ‚ç‚¹ã€ifèŠ‚ç‚¹ã€foreachèŠ‚ç‚¹ç­‰ã€‚é€šè¿‡è¿™äº›èŠ‚ç‚¹çš„ç»„åˆä½¿ç”¨ï¼Œå¼€å‘äººå‘˜å¯ä»¥å†™å‡ºå‡ ä¹æ»¡è¶³æ‰€æœ‰éœ€æ±‚çš„åŠ¨æ€ SQL è¯­å¥ã€‚ Mybatis ä¸­çš„ scripting æ¨¡å—ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å®å‚ï¼Œè§£ææ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰çš„åŠ¨æ€ SQL èŠ‚ç‚¹ï¼Œå¹¶å½¢æˆæ•°æ®åº“å¯æ‰§è¡Œçš„ SQL è¯­å¥ã€‚ä¹‹åä¼šå¤„ç† SQL è¯­å¥ä¸­çš„å ä½ç¬¦ï¼Œç»‘å®šç”¨æˆ·ä¼ å…¥çš„å®å‚ã€‚ SQL æ‰§è¡ŒSQL è¯­å¥çš„æ‰§è¡Œæ¶‰åŠå¤šä¸ªç»„ä»¶ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ Executorã€Statementhandlerã€Parameterhandler å’Œ Resultsethandlerã€‚Executor ä¸»è¦è´Ÿè´£ç»´æŠ¤ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜å¹¶æä¾›äº‹åŠ¡ç®¡ç†çš„ç›¸å…³æ“ä½œï¼Œå®ƒä¼šå°†æ•°æ®åº“ç›¸å…³æ“ä½œå§”æ‰˜ç»™ Statementhandler å®Œæˆ Statementhandler é¦–å…ˆé€šè¿‡ Parameter Handler å®Œæˆ SQL è¯­å¥çš„å®å‚ç»‘å®šï¼Œç„¶åé€šè¿‡ iava, sql Statement å¯¹è±¡æ‰§è¡Œ SQL è¯­å¥å¹¶å¾—åˆ°ç»“æœé›†ï¼Œæœ€åé€šè¿‡ Resultset Handler å®Œæˆç»“æœé›†çš„æ˜ å°„ï¼Œå¾—åˆ°ç»“æœå¯¹è±¡å¹¶è¿”å›ã€‚ æ’ä»¶Mybatis è‡ªèº«çš„åŠŸèƒ½è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œç¾åˆ‡åˆæ‰€æœ‰çš„åº”ç”¨åœºæ™¯ï¼Œå› æ­¤ Mybatis æä¾›äº†æ’ä»¶æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶çš„æ–¹å¼å¯¹ Mybatis è¿›è¡Œæ‰©å±•ã€‚ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¹Ÿå¯ä»¥æ”¹å˜ Mybatis çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¦æˆª SQL è¯­å¥å¹¶å¯¹å…¶è¿›è¡Œé‡å†™ã€‚ç”±äºç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¼šå½±å“ Mybatis çš„æ ¸å¿ƒè¡Œä¸ºï¼Œåœ¨ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ä¹‹å‰ï¼Œå¼€å‘äººå‘˜éœ€è¦äº†è§£ Mybatis å†…éƒ¨çš„åŸç†ï¼Œè¿™æ ·æ‰èƒ½ç¼–å†™å‡ºå®‰å…¨ã€é«˜æ•ˆçš„æ’ä»¶ æ¥å£å±‚æ¥å£å±‚ç›¸å¯¹ç®€å•ï¼Œå…¶æ ¸å¿ƒæ˜¯ Sqlsession æ¥å£ï¼Œè¯¥æ¥å£ä¸­å®šä¹‰äº† Mybatis æš´éœ²ç»™åº”ç”¨ç¨‹åºè°ƒç”¨çš„ APIï¼Œä¹Ÿå°±æ˜¯ä¸Šå±‚åº”ç”¨ä¸ MyBatis äº¤äº’çš„æ¡¥æ¢ã€‚æ¥å£å±‚åœ¨æ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨æ ¸å¿ƒå¤„ç†å±‚çš„ç›¸åº”æ¨¡å—æ¥å®Œæˆå…·ä½“çš„æ•°æ®åº“æ“ä½œã€‚","tags":[{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"}]},{"title":"Docker Swarm","date":"2019-09-28T13:35:29.000Z","path":"2019/09/28/656e6847.html","text":"å®è·µä¸­ä¼šå‘ç°ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å•ä¸ª Docker èŠ‚ç‚¹æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæ­å»º Docker é›†ç¾¤åŠ¿åœ¨å¿…è¡Œã€‚ç„¶è€Œï¼Œé¢å¯¹ Kubernetes, Mesos ä»¥åŠ Swarm ç­‰ä¼—å¤šå®¹å™¨é›†ç¾¤ç³»ç»Ÿï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿå®ƒä»¬ä¹‹ä¸­ï¼ŒSwarm æ˜¯ Docker åŸç”Ÿçš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€ç®€å•ï¼Œæœ€æ˜“å­¦ï¼Œæœ€èŠ‚çœèµ„æºçš„ï¼Œæ¯”è¾ƒé€‚åˆä¸­å°å‹å…¬å¸ä½¿ç”¨ã€‚ Docker Swarm ä»‹ç»Swarm åœ¨ Docker 1.12 ç‰ˆæœ¬ä¹‹å‰å±äºä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œåœ¨ Docker 1.12 ç‰ˆæœ¬å‘å¸ƒä¹‹åï¼Œè¯¥é¡¹ç›®åˆå¹¶åˆ°äº† Docker ä¸­ï¼Œæˆä¸º Docker çš„ä¸€ä¸ªå­å‘½ä»¤ã€‚ç›®å‰ï¼ŒSwarm æ˜¯ Docker ç¤¾åŒºæä¾›çš„å”¯ä¸€ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker é›†ç¾¤ç®¡ç†çš„å·¥å…·ã€‚å®ƒå¯ä»¥æŠŠå¤šä¸ª Docker ä¸»æœºç»„æˆçš„ç³»ç»Ÿè½¬æ¢ä¸ºå•ä¸€çš„è™šæ‹Ÿ Docker ä¸»æœºï¼Œä½¿å¾—å®¹å™¨å¯ä»¥ç»„æˆè·¨ä¸»æœºçš„å­ç½‘ç½‘ç»œã€‚ Docker Swarm æ˜¯ä¸€ä¸ªä¸º IT è¿ç»´å›¢é˜Ÿæä¾›é›†ç¾¤å’Œè°ƒåº¦èƒ½åŠ›çš„ç¼–æ’å·¥å…·ã€‚ç”¨æˆ·å¯ä»¥æŠŠé›†ç¾¤ä¸­æ‰€æœ‰ Docker Engine æ•´åˆè¿›ä¸€ä¸ªã€Œè™šæ‹Ÿ Engineã€çš„èµ„æºæ± ï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤ä¸å•ä¸€çš„ä¸» Swarm è¿›è¡Œæ²Ÿé€šï¼Œè€Œä¸å¿…åˆ†åˆ«å’Œæ¯ä¸ª Docker Engine æ²Ÿé€šã€‚åœ¨çµæ´»çš„è°ƒåº¦ç­–ç•¥ä¸‹ï¼ŒIT å›¢é˜Ÿå¯ä»¥æ›´å¥½åœ°ç®¡ç†å¯ç”¨çš„ä¸»æœºèµ„æºï¼Œä¿è¯åº”ç”¨å®¹å™¨çš„é«˜æ•ˆè¿è¡Œã€‚ Docker Swarm ä¼˜ç‚¹ä»»ä½•è§„æ¨¡éƒ½æœ‰é«˜æ€§èƒ½è¡¨ç°å¯¹äºä¼ä¸šçº§çš„ Docker Engine é›†ç¾¤å’Œå®¹å™¨è°ƒåº¦è€Œè¨€ï¼Œå¯æ‹“å±•æ€§æ˜¯å…³é”®ã€‚ä»»ä½•è§„æ¨¡çš„å…¬å¸â€”â€”ä¸è®ºæ˜¯æ‹¥æœ‰äº”ä¸ªè¿˜æ˜¯ä¸Šåƒä¸ªæœåŠ¡å™¨â€”â€”éƒ½èƒ½åœ¨å…¶ç¯å¢ƒä¸‹æœ‰æ•ˆä½¿ç”¨ Swarmã€‚ ç»è¿‡æµ‹è¯•ï¼ŒSwarm å¯æ‹“å±•æ€§çš„æé™æ˜¯åœ¨ 1000 ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ 50000 ä¸ªéƒ¨ç½²å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨çš„å¯åŠ¨æ—¶é—´ä¸ºäºšç§’çº§ï¼ŒåŒæ—¶æ€§èƒ½æ— å‡æŸã€‚ çµæ´»çš„å®¹å™¨è°ƒåº¦Swarm å¸®åŠ© IT è¿ç»´å›¢é˜Ÿåœ¨æœ‰é™æ¡ä»¶ä¸‹å°†æ€§èƒ½è¡¨ç°å’Œèµ„æºåˆ©ç”¨æœ€ä¼˜åŒ–ã€‚Swarm çš„å†…ç½®è°ƒåº¦å™¨ï¼ˆschedulerï¼‰æ”¯æŒå¤šç§è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬ï¼šèŠ‚ç‚¹æ ‡ç­¾ï¼Œäº²å’Œæ€§å’Œå¤šç§å®¹å™¨éƒ¨ç­–ç•¥å¦‚ binpackã€spreadã€random ç­‰ç­‰ã€‚ æœåŠ¡çš„æŒç»­å¯ç”¨æ€§Docker Swarm ç”± Swarm Manager æä¾›é«˜å¯ç”¨æ€§ï¼Œé€šè¿‡åˆ›å»ºå¤šä¸ª Swarm master èŠ‚ç‚¹å’Œåˆ¶å®šä¸» master èŠ‚ç‚¹å®•æœºæ—¶çš„å¤‡é€‰ç­–ç•¥ã€‚å¦‚æœä¸€ä¸ª master èŠ‚ç‚¹å®•æœºï¼Œé‚£ä¹ˆä¸€ä¸ª slave èŠ‚ç‚¹å°±ä¼šè¢«å‡æ ¼ä¸º master èŠ‚ç‚¹ï¼Œç›´åˆ°åŸæ¥çš„ master èŠ‚ç‚¹æ¢å¤æ­£å¸¸ã€‚ æ­¤å¤–ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ï¼ŒSwarm ä¼šç»§ç»­å°è¯•åŠ å…¥ï¼Œå¹¶æä¾›é”™è¯¯è­¦æŠ¥å’Œæ—¥å¿—ã€‚åœ¨èŠ‚ç‚¹å‡ºé”™æ—¶ï¼ŒSwarm ç°åœ¨å¯ä»¥å°è¯•æŠŠå®¹å™¨é‡æ–°è°ƒåº¦åˆ°æ­£å¸¸çš„èŠ‚ç‚¹ä¸Šå»ã€‚ å’Œ Docker API åŠæ•´åˆæ”¯æŒçš„å…¼å®¹æ€§ Swarm å¯¹ Docker API å®Œå…¨æ”¯æŒï¼Œè¿™æ„å‘³ç€å®ƒèƒ½ä¸ºä½¿ç”¨ä¸åŒ Docker å·¥å…·ï¼ˆå¦‚ Docker CLIï¼ŒComposeï¼ŒTrusted Registryï¼ŒHub å’Œ UCPï¼‰çš„ç”¨æˆ·æä¾›æ— ç¼è¡”æ¥çš„ä½¿ç”¨ä½“éªŒã€‚ Docker Swarm ä¸º Docker åŒ–åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆè¯¸å¦‚å¤šä¸»æœºç½‘ç»œå’Œå­˜å‚¨å·ç®¡ç†ï¼‰æä¾›åŸç”Ÿæ”¯æŒã€‚å¼€å‘çš„ Compose æ–‡ä»¶èƒ½ï¼ˆé€šè¿‡ docker-compose up ï¼‰è½»æ˜“åœ°éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨æˆ– Swarm é›†ç¾¤ä¸Šã€‚Docker Swarm è¿˜å¯ä»¥ä» Docker Trusted Registry æˆ– Hub é‡Œ pull å¹¶ run é•œåƒã€‚ ç»¼ä¸Šæ‰€è¿°ï¼ŒDocker Swarm æä¾›äº†ä¸€å¥—é«˜å¯ç”¨ Docker é›†ç¾¤ç®¡ç†çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œå…¨æ”¯æŒæ ‡å‡†çš„ Docker APIï¼Œæ–¹ä¾¿ç®¡ç†è°ƒåº¦é›†ç¾¤ Docker å®¹å™¨ï¼Œåˆç†å……åˆ†åˆ©ç”¨é›†ç¾¤ä¸»æœºèµ„æºã€‚ å¹¶éæ‰€æœ‰æœåŠ¡éƒ½åº”è¯¥éƒ¨ç½²åœ¨Swarmé›†ç¾¤å†…ã€‚æ•°æ®åº“ä»¥åŠå…¶å®ƒæœ‰çŠ¶æ€æœåŠ¡å°±ä¸é€‚åˆéƒ¨ç½²åœ¨Swarmé›†ç¾¤å†…ã€‚ ç›¸å…³æ¦‚å¿µèŠ‚ç‚¹è¿è¡Œ Docker çš„ä¸»æœºå¯ä»¥ä¸»åŠ¨åˆå§‹åŒ–ä¸€ä¸ª Swarm é›†ç¾¤æˆ–è€…åŠ å…¥ä¸€ä¸ªå·²å­˜åœ¨çš„ Swarm é›†ç¾¤ï¼Œè¿™æ ·è¿™ä¸ªè¿è¡Œ Docker çš„ä¸»æœºå°±æˆä¸ºä¸€ä¸ª Swarm é›†ç¾¤çš„èŠ‚ç‚¹ (node) ã€‚èŠ‚ç‚¹åˆ†ä¸ºç®¡ç† (manager) èŠ‚ç‚¹å’Œå·¥ä½œ (worker) èŠ‚ç‚¹ã€‚ ç®¡ç†èŠ‚ç‚¹ç”¨äº Swarm é›†ç¾¤çš„ç®¡ç†ï¼Œdocker swarm å‘½ä»¤åŸºæœ¬åªèƒ½åœ¨ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œï¼ˆèŠ‚ç‚¹é€€å‡ºé›†ç¾¤å‘½ä»¤ docker swarm leave å¯ä»¥åœ¨å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œï¼‰ã€‚ä¸€ä¸ª Swarm é›†ç¾¤å¯ä»¥æœ‰å¤šä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä½†åªæœ‰ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹å¯ä»¥æˆä¸º leaderï¼Œleader é€šè¿‡ raft åè®®å®ç°ã€‚ å·¥ä½œèŠ‚ç‚¹æ˜¯ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹ï¼Œç®¡ç†èŠ‚ç‚¹å°†æœåŠ¡ (service) ä¸‹å‘è‡³å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œã€‚ç®¡ç†èŠ‚ç‚¹é»˜è®¤ä¹Ÿä½œä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®è®©æœåŠ¡åªè¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ã€‚ä¸‹å›¾å±•ç¤ºäº†é›†ç¾¤ä¸­ç®¡ç†èŠ‚ç‚¹ä¸å·¥ä½œèŠ‚ç‚¹çš„å…³ç³»ã€‚ æœåŠ¡å’Œä»»åŠ¡ä»»åŠ¡ ï¼ˆTaskï¼‰æ˜¯ Swarm ä¸­çš„æœ€å°çš„è°ƒåº¦å•ä½ï¼Œç›®å‰æ¥è¯´å°±æ˜¯ä¸€ä¸ªå•ä¸€çš„å®¹å™¨ã€‚ æœåŠ¡ ï¼ˆServicesï¼‰ æ˜¯æŒ‡ä¸€ç»„ä»»åŠ¡çš„é›†åˆï¼ŒæœåŠ¡å®šä¹‰äº†ä»»åŠ¡çš„å±æ€§ã€‚æœåŠ¡æœ‰ä¸¤ç§æ¨¡å¼ï¼š replicated services æŒ‰ç…§ä¸€å®šè§„åˆ™åœ¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šä¸ªæ•°çš„ä»»åŠ¡ã€‚ global services æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä»»åŠ¡ ä¸¤ç§æ¨¡å¼é€šè¿‡ docker service create çš„ â€“mode å‚æ•°æŒ‡å®šã€‚ä¸‹å›¾å±•ç¤ºäº†å®¹å™¨ã€ä»»åŠ¡ã€æœåŠ¡çš„å…³ç³»ã€‚ æœ€å è½¬è‡ªï¼šDocker(å…­)ï¼šDocker ä¸‰å‰‘å®¢ä¹‹ Docker Swarm å¯¹è¿™ä¸ªDocker Swarmè¿™éƒ¨åˆ†ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä¸»è¦æ˜¯æƒ³äº†è§£å…¶æ¦‚å¿µã€‚è½¬å‘è¿™ç¯‡æ–‡ç« å†…å®¹ä»¥å…ä»¥åæ‰¾ä¸åˆ°ã€‚ å®è·µä¹‹åå†åšè¡¥å……","tags":[{"name":"Docker","slug":"Docker","permalink":"https://www.cayzlh.com/tags/Docker/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"name":"Docker","slug":"å¾®æœåŠ¡/Docker","permalink":"https://www.cayzlh.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Docker/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹ä»£ç†æ¨¡å¼","date":"2019-04-02T12:14:47.000Z","path":"2019/04/02/ae152a83.html","text":"ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆä»£ç†ï¼‰ ç”Ÿæ´»ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–å®ä¾‹ä¸èƒœæšä¸¾ï¼Œä½†å¯¹äºåšæŠ€æœ¯çš„æˆ‘ä»¬ï¼Œä»¥ç½‘ç»œä»£ç†ä¸¾ä¾‹ç›¸ä¿¡æ˜¯æœ€åˆé€‚ä¸è¿‡äº†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä¸Šç½‘å‰å¾—å»ç½‘ç»œæœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ç”³è¯·äº’è”ç½‘å®½å¸¦ä¸šåŠ¡ï¼Œäºæ˜¯é¡ºç†æˆç« å…‰çº¤å…¥æˆ·ï¼Œå¹¶æ‹¿åˆ°ä¸€ä¸ªè°ƒåˆ¶è§£è°ƒå™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¿—ç§°çš„â€œçŒ«â€ã€‚å¥½ï¼Œâ€œçŒ«â€å®ç°äº†äº’è”ç½‘è®¿é—®æ¥å£ï¼Œçœ‹ä»£ç ã€‚ public interface Internet &#123;//äº’è”ç½‘è®¿é—®æ¥å£ public void access(String url);&#125; public class Modem implements Internet &#123;//è°ƒåˆ¶è§£è°ƒå™¨ @Override public void access(String url)&#123;//å®ç°äº’è”ç½‘è®¿é—®æ¥å£ System.out.println(&quot;æ­£åœ¨è®¿é—®ï¼š&quot; + url); &#125;&#125; ä½œä¸ºè°ƒåˆ¶è§£è°ƒå™¨ï¼Œä¸€å®šæœ‰ä¸Šç½‘åŠŸèƒ½äº†ï¼Œç”¨æˆ·çš„ç”µè„‘åªéœ€è¦ç”¨ç½‘çº¿è¿æ¥è¿™åªâ€œçŒ«â€ä¾¿æ¥å…¥äº’è”ç½‘äº†ã€‚å°±è¿™ä¹ˆç®€å•ä¹ˆï¼Ÿç„¶è€ŒæŸå¤©æˆ‘ä»¬å‘ç°å­©å­å­¦ä¹ æ—¶æ€»æ˜¯å·å·ä¸Šç½‘çœ‹ç”µå½±ç©æ¸¸æˆï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šå¯¹æŸäº›ç½‘ç«™è¿›è¡Œè¿‡æ»¤ï¼Œæ‹’ç»é»„èµŒæ¯’ä¾µå®³æœªæˆå¹´ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç»ˆç«¯ç”µè„‘ä¸çŒ«ä¹‹é—´åŠ ä¸€å±‚ä»£ç†ï¼Œç”¨äºè¿‡æ»¤æŸäº›ä¸è‰¯ç½‘ç«™ï¼Œæœ€ç»ˆæˆ‘ä»¬å†³å®šè´­ä¹°ä¸€æ¬¾æœ‰è¿‡æ»¤åŠŸèƒ½çš„è·¯ç”±å™¨ã€‚ public class RouterProxy implements Internet &#123;//è·¯ç”±å™¨ä»£ç†ç±» private Internet modem;//æŒæœ‰è¢«ä»£ç†ç±»å¼•ç”¨ private List&lt;String&gt; blackList = Arrays.asList(&quot;ç”µå½±&quot;, &quot;æ¸¸æˆ&quot;, &quot;éŸ³ä¹&quot;, &quot;å°è¯´&quot;); public RouterProxy() &#123; this.modem = new Modem();//å®ä¾‹åŒ–è¢«ä»£ç†ç±» System.out.println(&quot;æ‹¨å·ä¸Šç½‘...è¿æ¥æˆåŠŸï¼&quot;); &#125; @Override public void access(String url) &#123;//åŒæ ·å®ç°äº’è”ç½‘è®¿é—®æ¥å£æ–¹æ³• for (String keyword : blackList) &#123;//å¾ªç¯é»‘åå• if (url.contains(keyword)) &#123;//æ˜¯å¦åŒ…å«é»‘åå•å­—çœ¼ System.out.println(&quot;ç¦æ­¢è®¿é—®ï¼š&quot; + url); return; &#125; &#125; modem.access(url);//æ­£å¸¸è®¿é—®äº’è”ç½‘ &#125;&#125; æ³¨æ„çœ‹ï¼Œåœ¨è¿™é‡Œè·¯ç”±å™¨ä»£ç†ä¸»è¦å……å½“ä»£ç†çš„è§’è‰²ï¼Œå’Œä¹‹å‰çš„â€œçŒ«â€ä¸€æ ·ï¼Œå®ƒåŒæ ·å®ç°äº†äº’è”ç½‘æ¥å£ï¼Œçœ‹ä¼¼ä¹Ÿæ˜¯æœ‰ä¸Šç½‘åŠŸèƒ½çš„ï¼Œå…¶å®ä¸ç„¶ã€‚ç¬¬12è¡Œä»£ç å¯¹äºäº’è”ç½‘è®¿é—®åŠŸèƒ½çš„å®ç°ä¸€å¼€å§‹å°±åšäº†ä¸ªè¿‡æ»¤ï¼Œå¦‚æœåœ°å€ä¸­å¸¦æœ‰é»‘åå•ä¸­çš„æ•æ„Ÿå­—çœ¼åˆ™ç¦æ­¢è®¿é—®å¹¶ç›´æ¥é€€å‡ºï¼Œåä¹‹åˆ™äºç¬¬19è¡Œè°ƒç”¨â€œçŒ«â€çš„äº’è”ç½‘è®¿é—®æ–¹æ³•ï¼Œçœ‹åˆ°äº†å§ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨â€œçŒ«â€çš„ä¸Šç½‘åŠŸèƒ½ã€‚æ³¨æ„æ­¤å¤„ä¸ºäº†å¯¹â€œçŒ«â€è¿›è¡Œæ§åˆ¶ï¼Œä»£ç†ä¸“ä¸ºæ­¤è€Œç”Ÿï¼Œæˆ‘ä»¬ç›´æ¥äºç¬¬7è¡Œå®ä¾‹åŒ–å®ƒè€Œä¸æ˜¯éœ€è¦åˆ«äººæŠŠå®ƒæ³¨å…¥è¿›æ¥ã€‚å¥½äº†ï¼Œå­©å­ç°åœ¨æ¥ä¸Šç½‘äº†ï¼Œè¿«ä¸åŠå¾…è¿è¡Œä¹‹ã€‚ public class Client &#123; public static void main(String[] args) &#123; Internet proxy = new RouterProxy();//å®ä¾‹åŒ–çš„æ˜¯ä»£ç† proxy.access(&quot;http://www.ç”µå½±.com&quot;); proxy.access(&quot;http://www.æ¸¸æˆ.com&quot;); proxy.access(&quot;ftp://www.å­¦ä¹ .com/java&quot;); proxy.access(&quot;http://www.å·¥ä½œ.com&quot;); /* è¿è¡Œç»“æœ æ‹¨å·ä¸Šç½‘...è¿æ¥æˆåŠŸï¼ ç¦æ­¢è®¿é—®ï¼šhttp://www.ç”µå½±.com ç¦æ­¢è®¿é—®ï¼šhttp://www.æ¸¸æˆ.com æ­£åœ¨è®¿é—®ï¼šftp://www.å­¦ä¹ .com/java æ­£åœ¨è®¿é—®ï¼šhttp://www.å·¥ä½œ.com */ &#125;&#125; åœ¨ç¬¬3è¡Œå¤„ï¼Œå­©å­å®ä¾‹åŒ–çš„ä¸å†æ˜¯â€œçŒ«â€ï¼Œè€Œæ˜¯è¢«å·æ¢æ¢æŸ±çš„æ›¿æ¢ä¸ºè·¯ç”±å™¨ä»£ç†äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å¤§å®¶ä¸Šç½‘éƒ½è¿æ¥è·¯ç”±å™¨äº†ï¼Œè€Œä¸æ˜¯ç›´æ¥å»è¿â€œçŒ«â€ï¼Œè¿™æ ·ä¸ä½†çœå»äº†æˆ‘ä»¬æ‹¨å·çš„éº»çƒ¦ï¼ˆè·¯ç”±å™¨å¸®åŠ©æ‹¨å·ï¼‰è€Œä¸”å­©å­å†ä¹Ÿè®¿é—®ä¸åˆ°ä¹±ä¸ƒå…«ç³Ÿçš„ç½‘ç«™äº†ã€‚è€Œè¿™ä¸ªä»£ç†è‡ªèº«å…¶å®å¹¶ä¸å…·å¤‡è®¿é—®äº’è”ç½‘çš„èƒ½åŠ›ï¼Œå®ƒåªæ˜¯ç®€å•çš„è°ƒç”¨â€œçŒ«â€ä¸Šç½‘åŠŸèƒ½ï¼Œå…¶å­˜åœ¨ç›®çš„åªæ˜¯ä¸ºäº†æ§åˆ¶å¯¹â€çŒ«â€œçš„äº’è”è®¿é—®ï¼Œå¯¹å…¶è¿›è¡Œä»£ç†è€Œå·²ã€‚ ä»£ç†æ¨¡å¼æ›´å¼ºè°ƒçš„æ˜¯å¯¹è¢«ä»£ç†å¯¹è±¡çš„æ§åˆ¶ï¼Œè€Œä¸æ˜¯ä»…é™äºå»è£…é¥°ç›®æ ‡å¯¹è±¡å¹¶å¢å¼ºå…¶åŸæœ‰çš„åŠŸèƒ½ã€‚å°±åƒæ˜æ˜Ÿçš„ä¾‹å­ä¸€æ ·ï¼Œå¦‚æœé’±æ²¡ç»™å¤Ÿï¼ŒåˆåŒæœªè¾¾æˆï¼Œåˆ™ä¸è®©æ˜æ˜Ÿéšæ„ä½œç§€ã€‚ ç›¸ä¿¡å¤§å®¶å·²ç»ç†è§£åœ°å¾ˆé€šé€äº†å§ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä»£ç†æ¨¡å¼äº†ã€‚å…¶å®è¿˜æœ‰ä¸€ç§å«åŠ¨æ€ä»£ç†ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶å®ä¾‹åŒ–è¿‡ç¨‹æ˜¯åœ¨è¿è¡Œæ—¶å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸éœ€è¦ä¸“é—¨é’ˆå¯¹æŸä¸ªæ¥å£å»å†™è¿™ä¹ˆä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œæ˜¯æ ¹æ®æ¥å£åŠ¨æ€ç”Ÿæˆã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬å…ˆå¿˜æ‰ä¹‹å‰çš„è·¯ç”±å™¨ä»£ç†ï¼Œå½“æˆ‘ä»¬å†…ç½‘ä¸­çš„ä¸Šç½‘è®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œè·¯ç”±å™¨çš„Lanå£å·²è¢«å æ»¡ä¸å¤Ÿç”¨äº†ï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šæ¢æˆäº¤æ¢æœºï¼Œçœ‹ä»£ç ã€‚ public interface Intranet &#123;//å±€åŸŸç½‘è®¿é—®æ¥å£ public void fileAccess(String path);&#125; ä¸ºäº†ä¿æŒç®€å•ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªäº¤æ¢æœºSwitchå®ç°äº†å±€åŸŸç½‘è®¿é—®æ¥å£Intranetï¼Œè¯·æ³¨æ„è¿™é‡Œä¸æ˜¯äº’è”ç½‘æ¥å£Internetã€‚ public class Switch implements Intranet &#123; @Override public void fileAccess(String path)&#123; System.out.println(&quot;è®¿é—®å†…ç½‘ï¼š&quot; + path); &#125;&#125; è¿™é‡Œè¿›è¡Œçš„æ˜¯å±€åŸŸç½‘æ–‡ä»¶è®¿é—®ï¼Œæ¯”å¦‚è¯´æ˜¯æ‹·è´å¦ä¸€å°å†…ç½‘æœºå™¨ä¸Šçš„å…±äº«æ–‡ä»¶ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³ä¿è¯ä¸ä¹‹å‰ä¸€æ ·çš„å…³é”®å­—è¿‡æ»¤æ§åˆ¶åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡æ˜¯ä»€ä¹ˆåœ°å€éƒ½è¦å…ˆé€šè¿‡è¿‡æ»¤ã€‚ åˆ°è¿™é‡Œè®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼ŒçŒ«å®ç°çš„æ˜¯äº’è”ç½‘è®¿é—®æ¥å£ï¼Œäº¤æ¢æœºå®ç°çš„æ˜¯å±€åŸŸç½‘è®¿é—®æ¥å£ï¼Œé‚£æˆ‘ä»¬çš„è¿‡æ»¤å™¨ä»£ç†ç±»åˆ°åº•è¯¥æ€ä¹ˆå†™ï¼Ÿæ˜¯å®ç°Internetæ¥å£å‘¢è¿˜æ˜¯å®ç°Intranetæ¥å£å‘¢ï¼Ÿè¦ä¹ˆä¸¤ä¸ªéƒ½å®ç°ï¼Ÿå†åŠ è¿›æ¥æ–°çš„ç±»æ¥å£åˆè¦ä¸åœåœ°æ”¹å®ç°ç±»å—ï¼Ÿè¿™æ˜¾ç„¶è¡Œä¸é€šï¼Œè¿‡æ»¤å™¨æ— éå°±æ˜¯ä¸€æ®µè¿‡æ»¤é€»è¾‘ä¸å¿…æ¥å›æ”¹åŠ¨ï¼Œè¿™è¿åäº†è®¾è®¡æ¨¡å¼å¼€é—­åŸåˆ™ã€‚åŠ¨æ€ä»£ç†åº”æ—¶è€Œç”Ÿï¼Œæˆ‘ä»¬æ¥çœ‹ä»£ç ã€‚ public class KeywordFilter implements InvocationHandler &#123; private List&lt;String&gt; blackList = Arrays.asList(&quot;ç”µå½±&quot;, &quot;æ¸¸æˆ&quot;, &quot;éŸ³ä¹&quot;, &quot;å°è¯´&quot;); // è¢«ä»£ç†çš„çœŸå®å¯¹è±¡,çŒ«ã€äº¤æ¢æœºã€æˆ–æ˜¯åˆ«çš„ä»€ä¹ˆéƒ½æ˜¯ã€‚ private Object origin; public KeywordFilter(Object origin) &#123; this.origin = origin;//æ³¨å…¥è¢«ä»£ç†å¯¹è±¡ System.out.println(&quot;å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼...&quot;); &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; //è¦è¢«åˆ‡å…¥æ–¹æ³•é¢ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘ String arg = args[0].toString(); for (String keyword : blackList) &#123; if (arg.toString().contains(keyword)) &#123; System.out.println(&quot;ç¦æ­¢è®¿é—®ï¼š&quot; + arg); return null; &#125; &#125; //è°ƒç”¨çœŸå®çš„è¢«ä»£ç†å¯¹è±¡æ–¹æ³• return method.invoke(origin, arg); &#125;&#125; å¯¹äºè¿™ä¸ªå…³é”®å­—è¿‡æ»¤åŠŸèƒ½æˆ‘ä»¬ä¸å†å†™åˆ°ä»£ç†ç±»é‡Œé¢äº†ï¼Œè€Œæ˜¯å¦å¤–å†™ä¸ªç±»å¹¶å®ç°JDKåå°„åŒ…ä¸­æä¾›çš„InvocationHandleræ¥å£ï¼Œäºç¬¬9è¡Œæ³¨å…¥å³å°†è¢«ä»£ç†çš„å¯¹è±¡ï¼Œä¸ç®¡æ˜¯çŒ«è¿˜æ˜¯äº¤æ¢æœºä»€ä¹ˆçš„å®ƒæ€»å½’æ˜¯ä¸ªObjectï¼Œç„¶ååœ¨ç¬¬14è¡Œå®ç°è¿™ä¸ªinvokeè°ƒç”¨æ–¹æ³•ï¼Œä¹‹åç”Ÿæˆçš„åŠ¨æ€ä»£ç†å°†æ¥ä¼šè°ƒè¿›æ¥è·‘è¿™å—çš„é€»è¾‘ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬è¿™é‡Œä¾ç„¶ä¿æŒä¸å˜çš„é€»è¾‘ï¼Œåœ¨çœŸå®å¯¹è±¡æ–¹æ³•è¢«æ‰§è¡Œä¹‹å‰è¿è¡Œäº†è¿‡æ»¤é€»è¾‘åŠ ä»¥æ§åˆ¶ã€‚ç”±äºä¼ å…¥çš„å‚æ•°æ˜¯è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•methodï¼Œä»¥åŠä¸€å †å‚æ•°argsï¼Œæ‰€ä»¥æ³¨æ„è¿™é‡Œç¬¬24è¡Œæˆ‘ä»¬è¦ç”¨åå°„å»è°ƒç”¨è¢«ä»£ç†å¯¹è±¡originäº†ï¼Œæœ€åæ¥çœ‹æˆ‘ä»¬å¦‚ä½•è¿è¡Œã€‚ public class Client &#123; public static void main(String[] args) &#123; //è®¿é—®å¤–ç½‘ï¼ˆäº’è”ç½‘ï¼‰,ç”ŸæˆçŒ«ä»£ç†ã€‚ Internet internet = (Internet) Proxy.newProxyInstance( Modem.class.getClassLoader(), Modem.class.getInterfaces(), new KeywordFilter(new Modem())); internet.access(&quot;http://www.ç”µå½±.com&quot;); internet.access(&quot;http://www.æ¸¸æˆ.com&quot;); internet.access(&quot;http://www.å­¦ä¹ .com&quot;); internet.access(&quot;http://www.å·¥ä½œ.com&quot;); //è®¿é—®å†…ç½‘ï¼ˆå±€åŸŸç½‘ï¼‰ï¼Œç”Ÿæˆäº¤æ¢æœºä»£ç†ã€‚ Intranet intranet = (Intranet) Proxy.newProxyInstance( Switch.class.getClassLoader(), Switch.class.getInterfaces(), new KeywordFilter(new Switch())); intranet.fileAccess(&quot;\\\\\\\\192.68.1.2\\\\å…±äº«\\\\ç”µå½±\\\\IronHuman.mp4&quot;); intranet.fileAccess(&quot;\\\\\\\\192.68.1.2\\\\å…±äº«\\\\æ¸¸æˆ\\\\Hero.exe&quot;); intranet.fileAccess(&quot;\\\\\\\\192.68.1.4\\\\shared\\\\Javaå­¦ä¹ èµ„æ–™.zip&quot;); intranet.fileAccess(&quot;\\\\\\\\192.68.1.6\\\\JavaçŸ¥éŸ³\\\\è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼.doc&quot;); /* å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼... ç¦æ­¢è®¿é—®ï¼šhttp://www.ç”µå½±.com ç¦æ­¢è®¿é—®ï¼šhttp://www.æ¸¸æˆ.com æ­£åœ¨è®¿é—®ï¼šhttp://www.å­¦ä¹ .com æ­£åœ¨è®¿é—®ï¼šhttp://www.å·¥ä½œ.com å¼€å¯å…³é”®å­—è¿‡æ»¤æ¨¡å¼... ç¦æ­¢è®¿é—®ï¼š\\\\192.68.1.2\\å…±äº«\\ç”µå½±\\IronHuman.mp4 ç¦æ­¢è®¿é—®ï¼š\\\\192.68.1.2\\å…±äº«\\æ¸¸æˆ\\Hero.exe è®¿é—®å†…ç½‘ï¼š\\\\192.68.1.4\\shared\\Javaå­¦ä¹ èµ„æ–™.zip è®¿é—®å†…ç½‘ï¼š\\\\192.68.1.6\\JavaçŸ¥éŸ³\\è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼.doc */ &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸ç®¡æ˜¯è®¿é—®äº’è”ç½‘è¿˜æ˜¯å±€åŸŸç½‘ï¼Œåªéœ€è¦åˆ†åˆ«ç”Ÿæˆç›¸åº”çš„ä»£ç†å¹¶è°ƒç”¨å³å¯ï¼Œç›¸åŒçš„è¿‡æ»¤å™¨é€»è¾‘è¢«æ‰§è¡Œäº†ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å†å†™ä»»ä½•çš„ä»£ç†ç±»äº†ï¼Œåªéœ€è¦å®ç°ä¸€æ¬¡InvocationHandlerå°±ä¸€åŠ³æ°¸é€¸äº†ï¼Œåœ¨è¿è¡Œæ—¶å»åŠ¨æ€åœ°ç”Ÿæˆä»£ç†ï¼Œè¾¾åˆ°å…¼å®¹ä»»ä½•æ¥å£çš„ç›®çš„ã€‚ å…¶å®åœ¨å¾ˆå¤šæ¡†æ¶ä¸­å¤§é‡åº”ç”¨åˆ°äº†åŠ¨æ€ä»£ç†æ¨¡å¼ï¼Œæ¯”å¦‚Springçš„é¢å‘åˆ‡é¢AOPï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½ä¸€ä¸ªåˆ‡é¢ç±»@Aspectï¼Œå£°æ˜å…¶åˆ‡å…¥ç‚¹@Pointcutï¼ˆè¢«ä»£ç†çš„å“ªäº›å¯¹è±¡çš„å“ªäº›æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„çŒ«å’Œäº¤æ¢æœºçš„accessä»¥åŠaccessFileï¼‰ï¼Œä»¥åŠè¢«åˆ‡å…¥çš„ä»£ç å—ï¼ˆè¦å¢åŠ ä¸Šå»çš„é€»è¾‘ï¼Œæ¯”å¦‚è¿™é‡Œçš„è¿‡æ»¤åŠŸèƒ½ä»£ç ï¼Œå¯åˆ†ä¸ºå‰ç½®æ‰§è¡Œ@Beforeï¼Œåç½®æ‰§è¡Œ@Afterï¼Œä»¥åŠå¼‚å¸¸å¤„ç†@AfterThrowingç­‰ï¼‰ï¼Œäºæ˜¯æ¡†æ¶è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä»£ç†å¹¶åˆ‡å…¥ç›®æ ‡æ‰§è¡Œã€‚æ­£å¦‚ç»™æ¯ç»™æ–¹æ³•å‰ååŠ å…¥æ—¥å¿—çš„ä¾‹å­ï¼Œæˆ–è€…æ›´ç»å…¸çš„äº‹åŠ¡æ§åˆ¶çš„ä¾‹å­ï¼Œåœ¨æ‰€æœ‰ä¸šåŠ¡ä»£ç ä¹‹å‰å…ˆåˆ‡å…¥â€œäº‹åŠ¡å¼€å§‹â€ï¼Œæ‰§è¡Œè¿‡åå†åˆ‡å…¥â€œäº‹åŠ¡æäº¤â€ï¼Œå¦‚æœæŠ›å¼‚å¸¸è¢«æ•è·åˆ™æ‰§è¡Œâ€œäº‹åŠ¡å›æ»šâ€ï¼Œå¦‚æ­¤å°±ä¸å¿…è¦åœ¨æ¯ä¸ªä¸šåŠ¡ç±»ä¸­å»å†™è¿™äº›é‡å¤ä»£ç äº†ï¼Œä¸€åŠ³æ°¸é€¸ï¼Œå†—ä½™ä»£ç å¤§é‡å‡å°‘ï¼Œå¼€å‘æ•ˆç‡æƒŠäººæå‡ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹äº«å…ƒæ¨¡å¼","date":"2019-03-23T12:02:33.000Z","path":"2019/03/23/34d98dd9.html","text":"ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆäº«å…ƒï¼‰ é¦–å…ˆæ¥çœ‹ä¸€ä¸ªå®ä¾‹ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦å¼€å‘ä¸€æ¬¾RPGæ¸¸æˆï¼Œæ¸¸æˆåœ°å›¾é€šå¸¸éå¸¸å¤§ï¼Œè€Œä¸”æœ‰å„ç§å„æ ·ï¼Œæœ‰è‰åœ°ã€æ²™æ¼ ã€è’åŸï¼Œæ°´è·¯ç­‰ç­‰ï¼Œåœ¨å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸‹åº”è¯¥æ€æ ·å»å»ºæ¨¡ã€‚ å¯¹äºè¿™ç§åœ°å›¾ï¼Œæˆ‘ä»¬åŠ è½½ä¸€æ•´å¼ å›¾ç‰‡æ¥åšåœ°å›¾ï¼Ÿå¦‚æœåœ°å›¾å¤ªå¤§ï¼Œå›¾ç‰‡åŠ è½½ç›¸å½“å¡é¡¿å§ï¼Ÿè€Œä¸”å¤§ç‰‡åœ°å›¾ä¸Šå…¶å®éƒ½æ˜¯é‡å¤çš„å›¾ç‰‡ç´ æï¼Œæ•´å›¾åŠ è½½è®¾è®¡ä¹Ÿæœ‰å¤±çµæ´»æ€§ã€‚å†ä»”ç»†è§‚å¯Ÿä¸‹ï¼Œè¿™åœ°å›¾æ— éå°±æ˜¯å¾ˆå¤šå°å›¾ç‰‡ï¼ˆå…ƒï¼‰æ‹¼èµ·æ¥çš„å“¦ï¼Œè¿™ä¸å°±æ˜¯ç±»ä¼¼äºæˆ‘ä»¬è£…ä¿®æ—¶è´´é©¬èµ›å…‹å˜›ï¼Ÿ ç®€å•çš„å®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬æœ‰ä¸ªç –å—ç±»ï¼ŒæŒæœ‰â€œå›¾ç‰‡â€ï¼Œâ€œä½ç½®â€ç­‰å±æ€§ä¿¡æ¯ï¼Œç„¶åå®ä¾‹åŒ–è¿™äº›ç –å—å†è°ƒç”¨å…¶â€œç»˜åˆ¶â€æ–¹æ³•æŠŠå›¾ç‰‡æ˜¾ç¤ºåœ¨åœ°å›¾æŸä½ç½®ä¸Šå³å¯ã€‚ public class Tile &#123; private String image;//åœ°ç –æ‰€ç”¨çš„å›¾ç‰‡æè´¨ private int x, y;//åœ°ç –æ‰€åœ¨åæ ‡ public Tile(String image, int x, int y) &#123; this.image = image; System.out.print(&quot;ä»ç£ç›˜åŠ è½½[&quot; + image + &quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;); this.x = x; this.y = y; &#125; public void draw() &#123; System.out.println(&quot;åœ¨ä½ç½®[&quot; + x + &quot;:&quot; + y + &quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot; + image + &quot;]&quot;); &#125;&#125; ä»£ç çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œç¬¬3è¡Œçš„åœ°ç –æè´¨å›¾ç‰‡æˆ‘ä»¬ç”¨Stringæ¥æ¨¡æ‹Ÿä»£æ›¿ï¼Œç¬¬7è¡Œåˆå§‹åŒ–æ—¶æˆ‘ä»¬æŠŠå›¾ç‰‡åŠ è½½åˆ°å†…å­˜ï¼Œæ¯”å¦‚è¯´è¿™ä¸ªIOæ“ä½œè¦è€—è´¹åŠç§’æ—¶é—´ï¼Œå¥½äº†æˆ‘ä»¬å…ˆæµ‹è¯•ç»˜åˆ¶ç¬¬ä¸€è¡Œç –å—ï¼Œè¿è¡Œä¸€ä¸‹ã€‚ public class Client &#123; public static void main(String[] args) &#123; //ä»¥ç»˜åˆ¶ç¬¬ä¸€è¡Œä¸ºä¾‹ new Tile(&quot;æ²³æµ&quot;, 10, 10).draw(); new Tile(&quot;æ²³æµ&quot;, 10, 20).draw(); new Tile(&quot;çŸ³è·¯&quot;, 10, 30).draw(); new Tile(&quot;è‰åª&quot;, 10, 40).draw(); new Tile(&quot;è‰åª&quot;, 10, 50).draw(); new Tile(&quot;è‰åª&quot;, 10, 60).draw(); new Tile(&quot;è‰åª&quot;, 10, 70).draw(); new Tile(&quot;è‰åª&quot;, 10, 80).draw(); /* è¿è¡Œç»“æœ ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:10]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ] ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:20]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ] ä»ç£ç›˜åŠ è½½[çŸ³è·¯]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:30]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[çŸ³è·¯] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:40]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:50]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:60]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:70]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:80]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] */ &#125;&#125; æœ‰æ²¡æœ‰å‘ç°é—®é¢˜ï¼Ÿæ¯åŠ è½½ä¸€å¼ å›¾éƒ½è¦è€—è´¹æ‰åŠç§’é’Ÿï¼Œæ‰ç”»äº†8å¼ åœ°ç –å›¾å°±4ç§’é’Ÿæµé€äº†ï¼Œå¦‚æœæ„å»ºæ•´å¼ åœ°å›¾å¾—å¤šå°‘æ—¶é—´ï¼Ÿè¿™å°±åƒæ˜¯åœ¨æ…¢æ€§è‡ªæ€ï¼Œå¦‚æ­¤æ•ˆç‡ä¸¥é‡å½±å“äº†æ¸¸æˆçš„ç”¨æˆ·ä½“éªŒï¼Œå…‰å¡é¡¿åœ¨åœ°å›¾åŠ è½½è¿™ç»™æ¼«é•¿çš„è¿‡ç¨‹å°±å·²ç»è®©ç©å®¶å¤±å»å…´è¶£äº†ã€‚ è¿™ä¸ªåœºæ™¯å¾ˆå®¹æ˜“æƒ³åˆ°ç”¨åŸå‹æ¨¡å¼æ¥å®ç°ï¼ŒæŠŠç›¸åŒçš„å›¾å…±äº«å‡ºæ¥ï¼Œç”¨å…‹éš†çš„æ–¹å¼ä»£æ›¿ç‰©ä»¶å›¾å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä»è€ŒåŠ å¿«åˆå§‹åŒ–é€Ÿåº¦ã€‚å…±äº«å…ƒè²Œä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œé€Ÿåº¦ä¹ŸåŠ å¿«äº†ï¼Œä½†å¯¹è±¡æ•°é‡è²Œä¼¼è¿˜æ˜¯ä¸ªä¸¥é‡é—®é¢˜ï¼Œæ¯ä¸€ä¸ªå°ç‰©ä»¶å›¾éƒ½è¦å¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¹ˆä¸ªå°æ¸¸æˆç”¨å¾—ç€é‚£ä¹ˆå¤§çš„å†…å­˜å¼€é”€ä¹ˆï¼Œæä¸å¥½ç”šè‡³ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œæ‰€ä»¥ï¼Œè®¾è®¡æ¨¡å¼ä¸€å®šè¿˜æ˜¯æœ‰é—®é¢˜ã€‚ æ²¿ç€å…±äº«çš„æ€è·¯æˆ‘ä»¬å†çœ‹ä¸‹åˆ°åº•éœ€ä¸éœ€è¦è¿™ä¹ˆå¤šå¯¹è±¡ï¼Ÿè¿™äº›å¯¹è±¡ä¸åŒçš„åœ°æ–¹åœ¨äºå…¶åæ ‡çš„ä¸åŒï¼Œå†å°±æ˜¯æè´¨çš„ä¸åŒï¼Œä¹Ÿå°±æ˜¯å›¾çš„ä¸åŒäº†ï¼Œèƒ½ä¸èƒ½ä»è¿™äº›å¯¹è±¡é‡ŒæŠ½å–å‡ºæ¥ä¸€äº›å…±åŒç‚¹å‘¢ï¼Ÿé¦–å…ˆæ¯ä¸ªå›¾çš„åæ ‡éƒ½ä¸ä¸€æ ·ï¼Œæ˜¯æ²¡åŠæ³•å…±äº«çš„ï¼Œä½†æ˜¯æè´¨å›¾æ˜¯é‡å¤å‡ºç°çš„ï¼Œæ˜¯å¯ä»¥å…±äº«çš„ï¼ŒåŒæ ·çš„æè´¨å›¾ä¼šåœ¨ä¸åŒçš„åæ ‡ä½ç½®ä¸Šé‡å¤å‡ºç°ï¼Œé‚£ä¹ˆè¿™ä¸ªæè´¨å›¾æ˜¯å¯ä»¥åšæˆå…±äº«å…ƒçš„ã€‚ æ—¢ç„¶åæ ‡ä¸èƒ½å…±äº«ï¼Œé‚£å°±ä¸åšä¸ºæè´¨ç±»çš„å…±äº«å…ƒå±æ€§ï¼Œç”±å®¢æˆ·ç«¯ç»´æŠ¤è¿™äº›åæ ‡å¹¶ä½œä¸ºå‚æ•°ä¼ å…¥å¥½äº†ï¼Œè€Œä¸”è¿™äº›æè´¨éƒ½æœ‰ç»˜åˆ¶èƒ½åŠ›ï¼Œé‚£å°±å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£å§ã€‚ public interface Drawable &#123; void draw(int x, int y);//ç»˜åˆ¶æ–¹æ³•ï¼Œæ¥æ”¶åœ°å›¾åæ ‡ã€‚&#125; ä¹Ÿå¯ä»¥ç”¨æŠ½è±¡ç±»æŠ½å‡ºæ›´å¤šçš„å±æ€§å’Œæ–¹æ³•ä»£æ›¿æ¥å£ï¼Œä½¿å­ç±»å˜å¾—ç®€å•ï¼Œè¿™é‡Œä¸ºäº†æ¸…æ™°è¯´æ˜é—®é¢˜å°±ç”¨æ¥å£ã€‚æ¥ä¸‹æ¥æ˜¯æè´¨ç±»ä»¬ï¼Œç»Ÿç»Ÿå®ç°è¿™ä¸ªç»˜åˆ¶æ¥å£ã€‚ public class Water implements Drawable &#123; private String image;//æ²³æµå›¾ç‰‡æè´¨ public Water() &#123; this.image = &quot;æ²³æµ&quot;; System.out.print(&quot;ä»ç£ç›˜åŠ è½½[&quot; + image + &quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;); &#125; @Override public void draw(int x, int y) &#123; System.out.println(&quot;åœ¨ä½ç½®[&quot; + x + &quot;:&quot; + y + &quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot; + image + &quot;]&quot;); &#125;&#125; æ³¨æ„ç¬¬6è¡Œå› ä¸ºæ˜¯æ²³æµæè´¨ç±»ï¼Œæ‰€ä»¥åˆå§‹åŒ–æˆ‘ä»¬ç›´æ¥åŠ è½½æ²³æµå›¾ç‰‡ç´ æï¼Œè¿™å°±æ˜¯ç±»å†…éƒ¨å³å°†åšå…±äº«çš„â€œå…ƒâ€æ•°æ®äº†ï¼Œä¹Ÿå«åšâ€œå†…è•´çŠ¶æ€â€ï¼Œè‡³äºâ€œå¤–è•´çŠ¶æ€â€å°±æ˜¯åæ ‡äº†ï¼Œåªä½œä¸ºå‚æ•°ä»å¤–éƒ¨ä¼ å…¥ä¸åšå…±äº«ã€‚æ¥ä¸‹æ¥æ˜¯è‰åœ°ã€çŸ³å­è·¯ç­‰ç­‰ã€‚ public class Grass implements Drawable &#123; private String image;//è‰åªå›¾ç‰‡æè´¨ public Grass() &#123; this.image = &quot;è‰åª&quot;; System.out.print(&quot;ä»ç£ç›˜åŠ è½½[&quot; + image + &quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;); &#125; @Override public void draw(int x, int y) &#123; System.out.println(&quot;åœ¨ä½ç½®[&quot; + x + &quot;:&quot; + y + &quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot; + image + &quot;]&quot;); &#125;&#125; public class Stone implements Drawable &#123; private String image;//çŸ³è·¯å›¾ç‰‡æè´¨ public Stone() &#123; this.image = &quot;çŸ³è·¯&quot;; System.out.print(&quot;ä»ç£ç›˜åŠ è½½[&quot; + image + &quot;]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚&quot;); &#125; @Override public void draw(int x, int y) &#123; System.out.println(&quot;åœ¨ä½ç½®[&quot; + x + &quot;:&quot; + y + &quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot; + image + &quot;]&quot;); &#125;&#125; public class House implements Drawable &#123; private String image;//æˆ¿å­å›¾ç‰‡æè´¨ public House() &#123; this.image = &quot;æˆ¿å­&quot;; System.out.print(&quot;ä»ç£ç›˜åŠ è½½[&quot; + image + &quot;]å›¾ç‰‡ï¼Œè€—æ—¶ä¸€ç§’ã€‚ã€‚ã€‚&quot;); &#125; @Override public void draw(int x, int y) &#123; System.out.println(&quot;å°†å›¾å±‚åˆ‡åˆ°æœ€ä¸Šå±‚ã€‚ã€‚ã€‚&quot;);//æˆ¿å­ç›–åœ¨åœ°ä¸Šï¼Œæ‰€ä»¥åˆ‡æ¢åˆ°é¡¶å±‚å›¾å±‚ã€‚ System.out.println(&quot;åœ¨ä½ç½®[&quot; + x + &quot;:&quot; + y + &quot;]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[&quot; + image + &quot;]&quot;); &#125;&#125; æ³¨æ„ä¸Šé¢è¿™ä¸ªçš„æˆ¿å­ç±»æœ‰æ‰€ä¸åŒï¼Œå®ƒæœ‰è‡ªå·±ç‰¹æœ‰çš„ç»˜åˆ¶è¡Œä¸ºæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨åœ°æ¿å›¾å±‚ä¹‹ä¸Šç»˜åˆ¶æˆ¿å­ï¼Œè¦†ç›–æ‰ä¸‹é¢çš„åœ°æ¿ï¼Œä½¿å…¶å˜å¾—æ›´åŠ ç«‹ä½“ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éè¦ç”¨æ¥å£æˆ–æŠ½è±¡ç±»æ¥åšå¼•ç”¨ï¼Œä½¿å®ç°ç±»å¯ä»¥æœ‰è‡ªå·±ç‹¬ç‰¹çš„è¡Œä¸ºæ–¹å¼ï¼Œå¤šæ€çš„å¥½å¤„ç«‹ç«¿è§å½±ã€‚æ¥ä¸‹æ¥å°±æ˜¯å®ç°â€œå…ƒä¹‹å…±äº«â€çš„å…³é”®äº†ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•å·¥å‚ç±»ï¼Œçœ‹ä»£ç ã€‚ public class Factory &#123;//å›¾ä»¶å·¥å‚ private Map&lt;String, Drawable&gt; images;//å›¾åº“ public Factory() &#123; images = new HashMap&lt;String, Drawable&gt;(); &#125; public Drawable getDrawable(String image) &#123; //ç¼“å­˜é‡Œå¦‚æœæ²¡æœ‰å›¾ä»¶ï¼Œåˆ™å®ä¾‹åŒ–å¹¶æ”¾å…¥ç¼“å­˜ã€‚ if(!images.containsKey(image))&#123; switch (image) &#123; case &quot;æ²³æµ&quot;: images.put(image, new Water()); break; case &quot;è‰åª&quot;: images.put(image, new Grass()); break; case &quot;çŸ³è·¯&quot;: images.put(image, new Stone()); &#125; &#125; //ç¼“å­˜é‡Œå¿…ç„¶æœ‰å›¾ï¼Œç›´æ¥å–å¾—å¹¶è¿”å›ã€‚ return images.get(image); &#125;&#125; è¿™ä¸ªå›¾ä»¶å·¥å‚ç»´æŠ¤ç€æ‰€æœ‰å…ƒå¯¹è±¡çš„å›¾åº“ï¼Œæ„é€ æ–¹æ³•äºç¬¬5è¡Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå“ˆå¸Œå›¾çš„ç¼“å­˜â€æ± â€œï¼Œå½“å®¢æˆ·ç«¯äºç¬¬8è¡Œéœ€è¦å®ä¾‹åŒ–å›¾ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆè§‚å¯Ÿè¿™ä¸ªå›¾åº“æ± é‡Œå­˜åœ¨ä¸å­˜åœ¨å·²å®ä¾‹åŒ–è¿‡çš„å›¾ä»¶ï¼Œä¹Ÿå°±æ˜¯çœ‹æœ‰æ— å·²åšå…±äº«çš„å›¾å…ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™å®ä¾‹åŒ–å¹¶åŠ å…¥å›¾åº“å…±äº«æ± ä¾›ä¸‹æ¬¡ä½¿ç”¨ï¼Œè¿™ä¾¿æ˜¯â€å…ƒä¹‹å…±äº«â€œçš„ç§˜å¯†äº†ã€‚å·§å¤ºå¤©å·¥çš„è®¾è®¡ä¸€æ°”å‘µæˆï¼Œå·²ç»è¿«ä¸åŠå¾…å»è¿è¡Œäº†ã€‚ public class Client &#123; public static void main(String[] args) &#123; //å…ˆå®ä¾‹åŒ–å›¾ä»¶å·¥å‚ Factory factory = new Factory(); //ä»¥ç¬¬ä¸€è¡Œä¸ºä¾‹ factory.getDrawable(&quot;æ²³æµ&quot;).draw(10, 10); factory.getDrawable(&quot;æ²³æµ&quot;).draw(10, 20); factory.getDrawable(&quot;çŸ³è·¯&quot;).draw(10, 30); factory.getDrawable(&quot;è‰åª&quot;).draw(10, 40); factory.getDrawable(&quot;è‰åª&quot;).draw(10, 50); factory.getDrawable(&quot;è‰åª&quot;).draw(10, 60); factory.getDrawable(&quot;è‰åª&quot;).draw(10, 70); factory.getDrawable(&quot;è‰åª&quot;).draw(10, 80); /*è¿è¡Œç»“æœ ä»ç£ç›˜åŠ è½½[æ²³æµ]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:10]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ] åœ¨ä½ç½®[10:20]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[æ²³æµ] ä»ç£ç›˜åŠ è½½[çŸ³è·¯]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:30]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[çŸ³è·¯] ä»ç£ç›˜åŠ è½½[è‰åª]å›¾ç‰‡ï¼Œè€—æ—¶åŠç§’ã€‚ã€‚ã€‚åœ¨ä½ç½®[10:40]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] åœ¨ä½ç½®[10:50]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] åœ¨ä½ç½®[10:60]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] åœ¨ä½ç½®[10:70]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] åœ¨ä½ç½®[10:80]ä¸Šç»˜åˆ¶å›¾ç‰‡ï¼š[è‰åª] */ &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æŠ›å¼ƒäº†åˆ©ç”¨newå…³é”®å­—è‚†æ„å¦„ä¸ºåœ°åˆ¶é€ å¯¹è±¡ï¼Œè€Œæ˜¯æ”¹ç”¨è¿™ä¸ªå›¾ä»¶å·¥å‚å»å¸®æˆ‘ä»¬æŠŠå…ƒæ„å»ºå¹¶å…±äº«èµ·æ¥ã€‚æ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿è¡Œç»“æœä¸­æ¯æ¬¡å®ä¾‹åŒ–å¯¹è±¡ä¼šè€—è´¹åŠç§’æ—¶é—´ï¼Œå†æ¬¡è¯·æ±‚å¯¹è±¡æ—¶å°±ä¸å†ä¼šåŠ è½½å›¾ç‰‡è€—è´¹æ—¶é—´äº†ï¼Œä¹Ÿå°±æ˜¯ä»å…±äº«å›¾æ± ç›´æ¥æ‹¿åˆ°äº†ï¼Œä¸å†é€ æ¬¡ã€‚æ›´å¦™çš„æ˜¯ï¼Œå¦‚æœç”»å®Œæ•´ä¸ªåœ°å›¾åªéœ€è¦å®ä¾‹åŒ–éœ€è¦ç”¨åˆ°çš„æŸäº›å…ƒç´ æè€Œå·²ï¼Œå³ä½¿æ˜¯é‚£ä¸ªå¤§æˆ¿å­å›¾ä»¶ä¹Ÿåªéœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡å°±å¤Ÿäº†ã€‚è‡³æ­¤ï¼ŒCPUé€Ÿåº¦ï¼Œå†…å­˜è½»é‡åŒ–åŒæ—¶åšåˆ°äº†ä¼˜åŒ–ï¼Œæ•´ä¸ªæ¸¸æˆç”¨æˆ·ä½“éªŒå¾—åˆ°äº†æå¤§çš„æå‡ã€‚ äº«å…ƒçš„ç²¾é«“å½“ç„¶é‡ç‚¹ä¸æ­¢äºâ€äº«â€œï¼Œæ›´é‡è¦çš„æ˜¯å¯¹äºå…ƒçš„è¾¨è¯†ï¼Œä¾‹å¦‚é‚£ä¸ªä»å¤–éƒ¨å®¢æˆ·ç«¯ä¼ å…¥çš„åæ ‡å‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬ä¾ç„¶æŠŠåæ ‡ä¹Ÿå½“ä½œå…±äº«å¯¹è±¡å…ƒæ•°æ®ï¼ˆå†…è•´çŠ¶æ€ï¼‰çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„å°†æ— å…ƒå¯äº«ï¼Œå¤§é‡çš„å¯¹è±¡å°±å¦‚åŒä¸–ç•Œä¸Šæ²¡æœ‰ç›¸åŒçš„ä¸¤ç‰‡æ ‘å¶ä¸€æ ·å¤šä¸èƒœæ•°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´å›¾åº“æ± è¢«æ’‘çˆ†ï¼Œäº«å…ƒå°†å˜å¾—æ¯«æ— æ„ä¹‰ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ•´ä¸ªç³»ç»Ÿæ•°æ®ç»“æ„çš„åˆ†æã€è®¾è®¡ã€è§„åˆ’æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹ä¸­ä»‹è€…æ¨¡å¼","date":"2019-03-18T09:55:37.000Z","path":"2019/03/18/af3a654f.html","text":"ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆä¸­ä»‹ï¼‰ ä¸­ä»‹ï¼Œä½œç”¨äºå¤šä¸ªäº‹ç‰©ä¹‹é—´å……å½“äº¤äº’æ²Ÿé€šçš„åª’ä»‹ã€‚æˆ‘ä»¬çš„ç”Ÿæ´»ä¸­æœ‰å„ç§å„æ ·çš„åª’ä»‹ï¼Œæ¯”å¦‚ä¸€äº›ä¼ ç»Ÿåª’ä½“ï¼Œä¹¦åˆŠæ‚å¿—ï¼ŒæŠ¥çº¸ï¼ŒæŠŠä¿¡æ¯ä¼ é€’ç»™è¯»è€…ã€‚å†æ¯”å¦‚åˆ©ç”¨ç”µå­ä¿¡æ¯æŠ€æœ¯çš„äº’è”ç½‘ï¼Œä½œä¸ºä¸€ç§æ–°åª’ä½“ï¼Œä¸å•å¯ä»¥æ›´é«˜æ•ˆåœ°æŠŠä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·ï¼Œè€Œä¸”å¯ä»¥åå‘åœ°è·å¾—ç”¨æˆ·åé¦ˆè¯„è®ºï¼Œç”¨æˆ·ä¸ç”¨æˆ·ä¹‹é—´äº¦å¯ä»¥è¿›è¡Œæ²Ÿé€šï¼Œè¿™ç§å…¨ç»ˆç«¯åŒå‘äº’é€šæ˜¯ä¼ ç»Ÿåª’ä½“æ‰€ä¸èƒ½åŠçš„ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œå†å¦‚å©šä»‹æ‰€ã€æˆ¿äº§ä¸­ä»‹ã€äº¤æ¢æœºç»„ç½‘ã€ç°ä»£ç”µå­å•†åŠ¡ã€C2Cè´­ç‰©å¹³å°ã€æ‰‹æœºã€å³æ—¶é€šè½¯ä»¶ç­‰ç­‰ï¼Œè¿™äº›éƒ½ä¸æˆ‘ä»¬çš„ç”Ÿæ´»æ¯æ¯ç›¸å…³ï¼Œç¦»å¼€å®ƒä»¬æˆ‘ä»¬å°†ä¸¾æ­¥ç»´è‰°ã€‚å…¶å®ä¸ç®¡æ˜¯ä»»ä½•ä¸­ä»‹ï¼Œå…¶æœ¬è´¨éƒ½æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯å……å½“ä¸­é—´åª’ä»‹çš„è§’è‰²ï¼Œå¹¶è¾¾æˆå¤šæ–¹ä¸šåŠ¡äº’é€šçš„ç›®çš„ã€‚ é¦–å…ˆæˆ‘ä»¬ä»¥æœ€ç®€å•çš„æ¨¡å‹æ¥è§£å†³é—®é¢˜ï¼Œä»¥ä¸¤ä¸ªäººäº¤è°ˆä¸ºä¾‹ï¼Œå…¶å®ä»–ä»¬ä¹‹é—´å¹¶ä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹åª’ä»‹ï¼Œè€Œæ˜¯ä¸€å¯¹ä¸€ç›´æ¥æ²Ÿé€šï¼Œçœ‹ä»£ç ã€‚ public class People &#123; private String name;//ç”¨åå­—æ¥åŒºåˆ«äººã€‚ private People other;//æŒæœ‰å¯¹æ–¹çš„å¼•ç”¨ã€‚ public String getName() &#123; return this.name; &#125; public People(String name) &#123; this.name = name;//åˆå§‹åŒ–å¿…é¡»èµ·åã€‚ &#125; public void connect(People other) &#123; this.other = other;//è¿æ¥æ–¹æ³•ä¸­æ³¨å…¥å¯¹æ–¹å¼•ç”¨ã€‚ &#125; public void talk(String msg) &#123; other.listen(msg);//æˆ‘æ–¹è¯´è¯æ—¶ï¼Œå¯¹æ–¹è†å¬ã€‚ &#125; public void listen(String msg) &#123; //è†å¬æ¥è‡ªå¯¹æ–¹çš„å£°éŸ³ System.out.println( other.getName() + &quot; å¯¹ &quot; + this.name + &quot; è¯´ï¼š&quot; + msg ); &#125;&#125; ä¸€åˆ‡å°±ç»ªï¼Œä¸¤äººå¼€å§‹æ²Ÿé€šã€‚ public class Main &#123; public static void main(String args[]) &#123; People p3 = new People(&quot;å¼ ä¸‰&quot;); People p4 = new People(&quot;æå››&quot;); p3.connect(p4); p4.connect(p3); p3.talk(&quot;ä½ å¥½ã€‚&quot;); p4.talk(&quot;æ—©ä¸Šå¥½ï¼Œä¸‰å“¥ã€‚&quot;); &#125; /**************************** è¾“å‡ºç»“æœï¼š å¼ ä¸‰ å¯¹ æå›› è¯´ï¼šä½ å¥½ã€‚ æå›› å¯¹ å¼ ä¸‰ è¯´ï¼šæ—©ä¸Šå¥½ï¼Œä¸‰å“¥ã€‚ *****************************/&#125; ä»Peopleç±»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ²Ÿé€šåªåªèƒ½åœ¨ä¸¤äººä¹‹é—´è¿›è¡Œï¼Œè€Œä¸”å„è‡ªéƒ½æŒæœ‰å¯¹æ–¹å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿æŠŠæ¶ˆæ¯ä¼ é€’ç»™å¯¹æ–¹çš„ç›‘å¬æ–¹æ³•ã€‚è¿™ç§æ¨¡å¼è™½ç„¶ç®€å•ï¼Œä½†è€¦åˆæ€§å¤ªå¼ºï¼Œä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ ï¼Œè°ä¹Ÿç¦»ä¸å¼€è°ã€‚è¯•æƒ³å¦‚æœå†æœ‰å¤šä¸ªäººåŠ å…¥äº¤è°ˆï¼Œé‚£æ¯ä¸ªäººéƒ½è¦æŒæœ‰å…¶ä»–æ‰€æœ‰äººçš„å¼•ç”¨äº†ï¼Œè¿™æ—¶ä¼šé™·å…¥ä¸€ç§å¤šå¯¹å¤šçš„å…³è”é™·é˜±ï¼Œå¯¹è±¡å…³ç³»å˜å¾—å¤æ‚ä¸å ªï¼Œå¦‚è››ç½‘èˆ¬éš¾ä»¥ç»´æŠ¤ã€‚ æˆ‘ä»¬å°±æ‹¿ç¾¤èŠå¤©å®¤ä¸¾ä¾‹ï¼Œæ¯å½“æœ‰äººåŠ å…¥æˆ–ç¦»å¼€ï¼Œéƒ½è¦æŠŠæ¯ä¸ªäººæŒæœ‰çš„å…¶ä»–äººçš„å¼•ç”¨å…³ç³»æ›´æ–°ä¸€éï¼Œå‘æ¶ˆæ¯æ—¶æ›´æ˜¯ç¹çä¸å ªï¼Œé‡å¤å·¥ä½œæ˜¾å¾—éå¸¸å¤šä½™ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å¼€å§‹è¿›è¡Œæ€è€ƒï¼Œä¸ºä½•ä¸æŠŠé‡å¤çš„éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥å‘¢ï¼Œä¹Ÿå°±æ˜¯æŠŠå¯¹æ–¹çš„å¼•ç”¨æ”¾åœ¨ä¸€ä¸ªä¸­ä»‹ç±»é‡Œé¢å»ç»Ÿä¸€ç»´æŠ¤èµ·æ¥ï¼Œäºæ˜¯è®¾è®¡æ›´æ”¹å¦‚ä¸‹ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªç”¨æˆ·ä¸å†æ‰€æŒæœ‰å…¶ä»–æ‰€æœ‰ç”¨æˆ·çš„å¼•ç”¨äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯èŠå¤©å®¤çš„å¼•ç”¨ï¼Œè¿™æ ·å¼•ç”¨å…³ç³»ç¬é—´å˜å¾—æ˜æœ—èµ·æ¥ï¼Œå¼€å§‹æˆ‘ä»¬çš„ä»£ç é‡æ„ã€‚ public class User &#123; private String name;//åå­— private ChatRoom chatRoom;//èŠå¤©å®¤å¼•ç”¨ public User(String name) &#123; this.name = name;//åˆå§‹åŒ–å¿…é¡»èµ·åå­— &#125; public String getName() &#123; return this.name; &#125; public void login(ChatRoom chatRoom) &#123;//ç”¨æˆ·ç™»é™† chatRoom.connect(this);//è°ƒç”¨èŠå¤©å®¤è¿æ¥æ–¹æ³• this.chatRoom = chatRoom;//æ³¨å…¥èŠå¤©å®¤å¼•ç”¨ &#125; public void talk(String msg) &#123;//ç”¨æˆ·å‘è¨€ chatRoom.sendMsg(this, msg);//ç»™èŠå¤©å®¤å‘æ¶ˆæ¯ &#125; public void listen(User fromWhom, String msg) &#123;//ä¸”å¬é£åŸ System.out.print(&quot;ã€&quot;+this.name+&quot;çš„å¯¹è¯æ¡†ã€‘&quot;); System.out.println(fromWhom.getName() + &quot; è¯´ï¼š &quot; + msg); &#125;&#125; å¯ä»¥çœ‹åˆ°ç¬¬14è¡Œï¼Œç”¨æˆ·ç™»é™†èŠå¤©å®¤æ—¶ä¸å†æ˜¯è¿æ¥å¯¹æ–¹äº†ï¼Œè€Œæ˜¯è¿æ¥é€šçŸ¥èŠå¤©å®¤å¹¶å‘ŠçŸ¥ï¼šâ€œæœ‰äººè¿›æ¥äº†è¯·è¿›è¡Œæ³¨å†Œâ€ï¼Œç„¶åè®°å½•ä¸‹æ¥ç”¨æˆ·å½“å‰æ‰€åœ¨èŠå¤©å®¤çš„å¼•ç”¨ã€‚ç¬¬19è¡Œï¼Œç”¨æˆ·å‘è¨€æ—¶ä¹Ÿä¸æ˜¯ç›´æ¥æ‰¾å¯¹æ–¹äº†ï¼Œè€Œæ˜¯æŠŠæ¶ˆæ¯æ‰”ç»™èŠå¤©å®¤å¤„ç†ã€‚ç¬¬23è¡Œï¼Œè†å¬æ–¹æ³•åŒæ ·ä¹Ÿæ˜¯ï¼Œå°†æ¥ä¼šæ¥å—æ¥è‡ªèŠå¤©å®¤çš„å£°éŸ³ã€‚å¾ˆæ˜¾ç„¶ï¼Œä¸€åˆ‡æ²Ÿé€šéƒ½ä¸æ˜¯ä¸­ä»‹èŠå¤©å®¤è¿›è¡Œï¼Œè¿™æ ·ç”¨æˆ·ä¹‹é—´å°±å®ç°äº†è§£è€¦çš„ç›®çš„ã€‚æ¥ç€å†™èŠå¤©å®¤ä¸­ä»‹ç±»ï¼š public class ChatRoom &#123; private String name;//èŠå¤©å®¤å‘½å public ChatRoom(String name) &#123; this.name = name;//åˆå§‹åŒ–å¿…é¡»å‘½åèŠå¤©å®¤ &#125; List&lt;User&gt; users = new ArrayList&lt;&gt;();//èŠå¤©å®¤é‡Œçš„ç”¨æˆ·ä»¬ public void connect(User user) &#123; this.users.add(user);//ç”¨æˆ·è¿›å…¥èŠå¤©å®¤åŠ å…¥åˆ—è¡¨ã€‚ System.out.print(&quot;æ¬¢è¿ã€&quot;); System.out.print(user.getName()); System.out.println(&quot;ã€‘åŠ å…¥èŠå¤©å®¤ã€&quot; + this.name + &quot;ã€‘&quot;); &#125; public void sendMsg(User fromWhom, String msg) &#123; // å¾ªç¯æ‰€æœ‰ç”¨æˆ·ï¼Œåªå‘æ¶ˆæ¯ç»™éå‘é€æ–¹fromWhomã€‚ users.stream() .filter(user -&gt; !user.equals(fromWhom))//è¿‡æ»¤æ‰å‘é€æ–¹fromWhom .forEach(toWhom -&gt; toWhom.listen(fromWhom, msg));//å‘é€æ¶ˆæ¯ç»™å‰©ä¸‹çš„æ‰€æœ‰äºº &#125;&#125; è¿™é‡Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªèŠå¤©å®¤ä½œä¸ºä¸­ä»‹ç±»ï¼Œæ‰€æœ‰å‚ä¸è€…ç™»é™†æ—¶è°ƒç”¨ç¬¬10è¡Œçš„connectæ–¹æ³•è¿›å…¥èŠå¤©å®¤ï¼Œå¹¶è®°å½•å…¶å¼•ç”¨åˆ°usersåˆ—è¡¨ä¸­ã€‚ç¬¬17è¡Œï¼Œå½“ç”¨æˆ·å‘æ¶ˆæ¯åˆ°å¹³å°æˆ‘ä»¬å†è½¬å‘ç»™å…¶ä»–äººï¼Œè¿™é‡Œåˆ©ç”¨Java8çš„æµå’ŒLambdaè¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤ï¼ˆUserç±»çš„equalsæ–¹æ³•è¯·è‡ªè¡ŒåŠ å…¥ï¼‰ï¼Œå¹¶å¾ªç¯è°ƒç”¨æ‰€æœ‰æ¥æ”¶æ–¹çš„listenæ–¹æ³•å³å¯ã€‚ ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ä¿æŒæœ€ç®€å•çš„æ–¹å¼ï¼Œå¦‚æœæŸå¤©æƒ…å†µå˜å¾—å¤æ‚ï¼Œæœ‰äº†ä¸åŒçš„ç”¨æˆ·ï¼Œæˆ–æ˜¯èŠå¤©å®¤ä¹Ÿå„ä¸ç›¸åŒå¹¶åŠ å…¥äº†å„è‡ªçš„ç‰¹æ€§ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦ç»§ç»­é‡æ„ï¼ŒæŠ½è±¡èŠå¤©å®¤ç±»ï¼ŒæŠ½è±¡ç”¨æˆ·ç±»ï¼Œè¯»è€…å¯ä»¥çµæ´»è¿ç”¨ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°äº†ã€‚ å…¶å®ä¸­ä»‹æ¨¡å¼ä¸æ­¢æ˜¯åœ¨ç”Ÿæ´»ä¸­å¹¿æ³›åº”ç”¨ï¼Œåœ¨è½¯ä»¶æ¶æ„ä¸­ä¹Ÿéå¸¸å¸¸è§ï¼Œå½“ä¸‹æµè¡Œçš„å¾®æœåŠ¡åˆ†å¸ƒå¼è½¯ä»¶æ¶æ„æ‰€ç”¨åˆ°çš„æ³¨å†Œä¸­å¿ƒï¼Œä¾‹å¦‚æœ€å¸¸ç”¨åˆ°çš„äº‘ç»„ä»¶Eureka Serverï¼Œå…¶ä½œç”¨å°±æ˜¯ä¸ºä¼—å¤šåˆ†å¸ƒå¼æœåŠ¡æä¾›æ³¨å†Œå‘ç°æœåŠ¡ï¼Œå®ƒæ­£æ˜¯å……å½“åƒä¸­ä»‹ä¸€æ ·çš„è§’è‰²ã€‚ ä¸­ä»‹æ¨¡å¼æ›´åƒæ˜¯ç½‘ç»œæ‹“æ‰‘ä¸­çš„æ˜Ÿå‹ç»“æ„ï¼Œå®ƒæè¿°äº†ä¼—èŠ‚ç‚¹ä¸ä¸­å¿ƒç‚¹çš„å…³ç³»ã€‚ å¯¹åƒä¹‹é—´æ˜¾å¼åœ°äº’ç›¸å¼•ç”¨è¶Šå¤šï¼Œæ„å‘³ç€ä¾èµ–æ€§è¶Šå¼ºï¼Œç‹¬ç«‹æ€§è¶Šå·®ï¼Œä¸åˆ©äºä»£ç ç»´æŠ¤ä¸æ‰©å±•ï¼ŒåŒæ—¶å¤šæ–¹æ²Ÿé€šçš„ä»»åŠ¡ä¹Ÿåº”äº¤ç”±ä¸­é—´å¹³å°æ¥å®Œæˆï¼Œæ¯ä¸ªç±»åº”åªå…·å¤‡å„è‡ªè¯¥æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¾¿æ˜¯é«˜å†…èšä½è€¦åˆçš„è®¾è®¡æ ‡å‡†ã€‚ä¸­ä»‹æ¨¡å¼ç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ï¼Œå®ƒè§£å†³äº†å¯¹è±¡é—´è¿‡åº¦è€¦åˆã€å¤æ‚é¢‘ç¹äº¤äº’çš„é—®é¢˜ï¼Œæ‰“ç ´äº†ä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ çš„ç›¸äº’ä¾èµ–ï¼Œç¬¬ä¸‰æ–¹çš„ä»‹å…¥æœ‰åŠ©äºåŒæ–¹è°ƒåœï¼Œæ‰“ç ´å¦‚èƒ¶ä¼¼æ¼†ã€çº ç¼ ä¸ä¼‘çš„å…³ç³»ï¼Œè®©ä»–ä»¬ä¹‹é—´å˜å¾—æ¾æ•£ã€è‡ªç”±ã€ç‹¬ç«‹ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼","date":"2019-03-15T09:36:20.000Z","path":"2019/03/15/e4d55155.html","text":"ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆè£…é¥°ï¼‰ è£…é¥°ï¼Œåœ¨æŸç‰©ä»¶åŸºç¡€ä¸ŠåŠ ä»¥ä¿®é¥°ï¼Œè£…ç‚¹ï¼Œä½¿å¾—åŸæœ¬çš„æœ´ç´ å˜å¾—åä¸½ï¼Œè¾¾åˆ°åŒ–è…æœ½ä¸ºç¥å¥‡çš„æ•ˆæœã€‚æ¯”å¦‚æˆ‘ä»¬ä»å¼€å‘å•†ä¹°æ¥çš„æ¯›å¯æˆ¿ï¼Œå¿…ç„¶è¦è¿›è¡Œå®¤å†…è£…æ½¢è¿™ä¹ˆä¸€é¡¹å·¥ç¨‹ï¼Œä»€ä¹ˆç®€çº¦é£å•Šï¼ŒåŒ—æ¬§é£å•Šï¼Œåœ°ä¸­æµ·ï¼Œç¾å¼ä¸­å¼ç­‰ç­‰ï¼Œå½“ç„¶èåœé’èœå„æœ‰æ‰€çˆ±ï¼Œæ¯ä¸ªäººè£…å‡ºçš„æˆ¿å­éƒ½å„æœ‰å·®å¼‚ï¼Œä½†ä¸ç®¡ä½•ç§é£æ ¼ï¼Œè¿™éƒ½æ˜¯å¯¹åŸæœ¬æ¯›å¯æˆ¿çš„è£…é¥°ï¼Œç•™ç»™ä¸šä¸»æŒ‰ç…§è‡ªå·±çš„å–œå¥½è¿›è¡ŒäºŒæ¬¡åŠ å·¥ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ¯›å¯äºŒæ‰‹æˆ¿æ¯”è£…ä¿®è¿‡çš„è¦å¥½å–ï¼Œæœ‰æˆå“å°±ä¸€å®šå¾—æœ‰åŠæˆå“ï¼Œè¿™æ ·æ‰èƒ½æŠŠæ›´å¤šçš„é€‰æ‹©ç•™ç»™ç”¨æˆ·ï¼Œä½¿å¾—è£…é¥°æˆä¸ºå¯èƒ½ã€‚ äººé è¡£è£…é©¬é éï¼Œå½“ç„¶ä¸æ­¢æ˜¯è£…ä¿®æœ‰è¿™ä¹ˆç¥å¥‡çš„æ•ˆæœï¼Œå¯¹äºå¥³ç”ŸåŒ–å¦†æ¥è¯´æˆ‘ä»¬ä¹Ÿæ˜¯æ·±æœ‰ä½“ä¼šï¼Œæ¯å½“å¥³å‹å›å®¶å¸å¦†åç´ é¢æœå¤©çš„æ—¶å€™æˆ‘ä»¬çš„å†…å¿ƒæ˜¯å´©æºƒçš„ï¼Œæœ‰ç§å½“åˆç›¸äº²è¢«éª—çš„æ„Ÿè§‰ã€‚ æ˜¾è€Œæ˜“è§ï¼Œå¥³å‹æ¯å¤©å‡ºé—¨ä¹‹å‰è¿›è¡Œçš„é‚£åœºæ´—ç¤¼æ˜¯å¤šä¹ˆçš„ç¥åœ£ï¼Œå¤šä¹ˆçš„ä¸å¯æˆ–ç¼ºã€‚è¯šç„¶ï¼ŒåŒ–å¦†çš„è¿‡ç¨‹å¯¹äºç”·äººæ¥è¯´å……æ»¡äº†ç¥ç§˜è‰²å½©ï¼Œä½†å¯¹äºå¥³äººæ¥è¯´æ›´åƒæ˜¯ä¸€åœºæ´—ç¤¼ï¼Œæ€€æ£ç€ä¿¡ä»°ä¸æ•¬ç•æ„Ÿè¿›è¡Œçš„ä¸€åœºä»ªå¼ï¼Œæœ€ç»ˆä¼šåƒé­”æ³•ä¸€èˆ¬æŠŠè‡ªå·±çš„è„¸å˜å¾—å®Œç¾æ— ç‘•ï¼Œæ›´æœ‰ç”šè€…æµ“å¦†è‰³æŠ¹åœ°è¿æ¯›å­”éƒ½çœ‹ä¸åˆ°ã€‚ ä½œä¸ºç ”å‘äººå‘˜ï¼Œæˆ‘ä»¬ä¸€å®šä¸èƒ½æ”¾è¿‡å¯¹äºè¿™é¡¹ç¥ç§˜å·¥ç¨‹çš„æ‹†è§£åˆ†æï¼Œå¼€å§‹æˆ‘ä»¬çš„å·¥ä½œã€‚é¦–å…ˆæ¯ä¸ªäººè¦å±•ç¤ºè‡ªå·±é‚£å¿…ç„¶æœ‰ä¸€ä¸ªæ ‡å‡†è¡Œä¸ºshow()ï¼Œæˆ‘ä»¬å°†å®ƒæŠ½è±¡å‡ºæ¥ä½œä¸ºæ¥å£Showableã€‚ public interface Showable &#123; public void show();//å®šä¹‰å±•ç¤ºè¡Œä¸º&#125; å½“ç„¶ï¼Œå¥³å‹ä¼šè¿™é—¨åŠŸå¤«äº†ï¼Œæ‰€ä»¥å®ç°äº†æ­¤è¡Œä¸ºå¹¶æ–½å±•å…¶â€œç¾ä¸½çš„è„¸åºâ€äº†ï¼Œä½†æ­¤æ—¶åªæ˜¯åŸç”Ÿæ€çš„ç´ é¢œã€‚ public class Girl implements Showable&#123; @Override public void show() &#123; System.out.print(&quot;å¥³å­©çš„ç´ é¢œ&quot;); &#125;&#125; æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼Œç›´æ¥è°ƒç”¨çš„è¯ä¼šæ˜¯ç´ é¢æœå¤©ç›´é¢æƒ¨æ·¡çš„äººç”Ÿï¼Œè¿™æ ·å½“ç„¶è¾¾ä¸åˆ°ç¾é¢œæ•ˆæœäº†ï¼Œä½•ä»¥ç™»ä¸Šäººç”Ÿå·…å³°ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥è¦è¿›è¡ŒåŒ–å¦†äº†ï¼Œè¿™é‡Œå¿…é¡»ä¾é ä¸€ç§ç¥ç§˜è€Œåˆæ˜‚è´µçš„ä¸œè¥¿ï¼ŒåŒ–å¦†å“ç™»åœºäº†ï¼Œå®ƒåŒæ ·å®ç°äº†Showableæ¥å£ã€‚ public class Decorator implements Showable&#123;//åŒ–å¦†å“ç²‰é¥°å™¨ Showable showable;//æŒæœ‰æŸä¸ªå–„äºå±•ç¤ºçš„å®¶ä¼™ public Decorator(Showable showable) &#123;//æ„é€ æ—¶æ³¨å…¥è¿™ä¸ªå®¶ä¼™ this.showable = showable; &#125; @Override public void show() &#123; System.out.print(&quot;ç²‰é¥°(&quot;);//åŒ–å¦†å“ç²‰é¥° showable.show();//è¿™å®¶ä¼™ç´ é¢æœå¤©çš„ç§€ System.out.print(&quot;)&quot;);//ç²‰é¥°æ‰“å®Œæ”¶å·¥ &#125;&#125; æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨æ„é€ åŒ–å¦†å“ç±»çš„æ—¶å€™å¯ä»¥æŠŠå¥³å­©ç»™æ³¨å…¥è¿›æ¥ï¼Œç›®çš„åœ¨äºè°ƒç”¨å¥³å­©çš„showæ–¹æ³•ï¼Œä½†å¯¹äºå…¶åŸæœ¬çš„å…·ä½“è¡Œä¸ºè£…é¥°å™¨ä¸€æ— æ‰€çŸ¥ï¼Œå¹¶ä¸”æ²¡æœ‰åŠ å…¥ä»»ä½•é€»è¾‘é™åˆ¶ï¼Œå®ƒæ‰€åšçš„æ— éæ˜¯â€œç”»é¾™ç‚¹ç›â€ï¼Œâ€œé”¦ä¸Šæ·»èŠ±â€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹çœ‹ç»“æœã€‚ public class Client &#123; public static void main(String[] args) &#123; //ç”¨è£…é¥°å™¨åŒ…è£¹å¥³å­©showå‡ºæ¥ new Decorator(new Girl()).show(); //ç»“æœï¼šç²‰é¥°(å¥³å­©çš„ç´ é¢œ) &#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªéœ€è¦æ–°å»ºè£…é¥°å™¨çš„æ—¶å€™æŠŠå¥³å­©ç»™åŒ…è£…è¿›å»å°±å¾—åˆ°äº†ç²‰é¥°è¿‡çš„ç¾é¢œï¼Œæ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿç„¶è€Œæ­¤æ—¶æœ‰å¥³æœ‹å‹ä¼šå«Œå¼ƒäº†ï¼Œâ€œåªæ˜¯æ‰“ç²‰åº•è¿™ä¹ˆç®€å•å—ï¼Ÿçœ¼éœœå‘¢ï¼Ÿå£çº¢å‘¢â€¦â€¦â€ã€‚ å¥½å§ï¼Œä¸ºäº†æ»¡è¶³å¥³å‹çš„è¦æ±‚ï¼Œæˆ‘ä»¬å¾—å†å¤šä¸€äº›è®¾è®¡ã€‚æƒ³æƒ³çœ‹è¿™äº›åŒ–å¦†å“ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆéƒ½æœ‰å…±åŒçš„ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬ç»Ÿç»Ÿéƒ½å¯ä»¥è£…é¥°åŸç”Ÿæ€çš„ç´ é¢œå±•ç¤ºæ–¹æ³•showï¼Œé‚£æˆ‘ä»¬ä½•ä¸æŠŠè¿™äº›ç‰¹æ€§æŠ½è±¡å‡ºæ¥å‘¢ï¼Ÿå¼€å§‹è¡ŒåŠ¨ï¼Œä¿®æ”¹æˆ‘ä»¬çš„è£…é¥°ç±»ã€‚ public abstract class Decorator implements Showable&#123; protected Showable showable; public Decorator(Showable showable) &#123; this.showable = showable; &#125; @Override public void show() &#123; showable.show();//ç›´æ¥è°ƒç”¨ä¸åšåŠ ä»»ä½•ç²‰é¥°ã€‚ &#125;&#125; æˆ‘ä»¬æŠŠåŒ–å¦†å“ç±»ç»™æ”¹æˆæŠ½è±¡ç±»ï¼Œé‡å†™showæ–¹æ³•ï¼Œä½†ä¸åšä»»ä½•ç²‰é¥°äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç•™ç»™å­ç±»å…·ä½“çš„æŸä¸ªåŒ–å¦†å“å»åšè£…é¥°å§ã€‚åŒ–å¦†é¦–å…ˆç¬¬ä¸€æ­¥ä¸€å®šè¦æ‰“åº•äº†ï¼Œè¿™é‡Œæˆ‘ä»¬é¦–å…ˆåŠ å…¥ä¸€ä¸ªç²‰åº•ç±»ã€‚ public class FoundationMakeup extends Decorator&#123; public FoundationMakeup(Showable showable) &#123; super(showable);//è°ƒç”¨åŒ–å¦†å“çˆ¶ç±»æ³¨å…¥ &#125; @Override public void show() &#123; System.out.print(&quot;æ‰“ç²‰åº•(&quot;); showable.show(); System.out.print(&quot;)&quot;); &#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç²‰åº•ç±»ç»§æ‰¿äº†åŒ–å¦†å“ç±»ï¼Œå½“ç„¶è¿™ä¸ªç²‰åº•çš„showæ–¹æ³•ä¸€å®šè¦åŠ ä»¥ä¿®é¥°äº†ï¼Œåœ¨åŸç”Ÿæ€çš„å‰åéƒ½è¿›è¡Œäº†æ‰“ç²‰åº•æ“ä½œã€‚åŒæ ·åœ°ï¼Œæ‰“å®Œç²‰åº•åå†ç”»ä¸ªå£çº¢å§ã€‚ public class Lipstick extends Decorator&#123; public Lipstick(Showable showable) &#123; super(showable); &#125; @Override public void show() &#123; System.out.print(&quot;æ¶‚å£çº¢(&quot;); showable.show(); System.out.print(&quot;)&quot;); &#125;&#125; æœ€åï¼Œæˆ‘ä»¬æŠŠå¥³å‹ã€ç²‰åº•ã€å£çº¢å±‚å±‚åŒ…è£¹èµ·æ¥å¹¶è¿è¡Œï¼Œç»“æœå¦‚æ„¿ä»¥å¿ã€‚ public class Client &#123; public static void main(String[] args) &#123; //å£çº¢åŒ…è£¹ç²‰åº•ï¼Œå†åŒ…è£¹å¥³å‹ã€‚ Showable madeupGirl = new Lipstick(new FoundationMakeup(new Girl())); madeupGirl.show(); //è¿è¡Œç»“æœï¼šæ¶‚å£çº¢(æ‰“ç²‰åº•(å¥³å­©çš„è„¸åº)) &#125;&#125; å¦‚æœå¥³å‹å¯¹è¿™ç§æ·¡å¦†æ•ˆæœè¿˜æ˜¯ä¸æ»¡æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·»åŠ åŒ–å¦†å“ç±»ï¼Œç«æ¯›è†ã€çœ¼çº¿ã€çœ‰ç¬”ã€è…®çº¢ç­‰ç­‰ç­‰ç­‰ï¼Œåªéœ€è¦å±‚å±‚åŒ…è£¹èµ·æ¥ï¼Œæœ€ç»ˆå®ç°å¥³å‹æµ“å¦†è‰³æŠ¹çš„æ¢¦æƒ³ã€‚ æˆ‘ä»¬è§‚å¯Ÿè¿™ç§è£…é¥°å™¨æ¨¡å¼ç»“æ„ï¼Œæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†å‘¢ï¼Ÿæ²¡é”™ï¼Œå…¶å®è£…é¥°å™¨æ¨¡å¼åœ¨JDKé‡Œå°±æœ‰å¾ˆå¤šåº”ç”¨ï¼Œæ¯”å¦‚Java IOåŒ…é‡Œçš„ä¼—å¤šæµå¤„ç†ç±»ã€‚ new BufferedReader(new InputStreamReader(new FileInputStream(filePath))); å½“ç„¶ï¼Œæµå¤„ç†ç±»å½“ç„¶è¦æ¯”æˆ‘ä»¬çš„ä¾‹å­å¤æ‚çš„å¤šï¼Œä½†å…¶åŸºæœ¬æ€æƒ³å’Œæˆ‘ä»¬å»ç¹å°±ç®€çš„ä¾‹å­å¼‚é€”åŒå½’ï¼Œè¿™äº›å¯¹è±¡å°±å¥½åƒæ˜¯ä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·å±‚å±‚åŒ…è£¹ï¼Œå±‚å±‚è£…é¥°ï¼Œæ¯å¥—ä¸€å±‚å°±ä¼šå¤šå‡ºä¸€äº›åŠŸèƒ½å‡ºæ¥ï¼Œæˆ‘ä»¬æ›´å¯ä»¥è‡ªç”±æ­é…ï¼Œå®ç°ä¸åŒçš„ç»„åˆåŠŸèƒ½ã€‚ æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯å¥³ç”ŸåŒ–å¦†è¿˜æ˜¯ç¨‹åºå‘˜å†™ä»£ç ï¼Œæˆ‘ä»¬éƒ½ä¸å¯èƒ½å¼„å‡ºä¸€ä¸ªå·¨å¤§çš„ç±»ç„¶åå»æå®šæ‰€æœ‰äº‹æƒ…ï¼Œå¦‚æ­¤ä»£ç ä¼šè¶Šå †ç§¯è¶Šå¤šï¼Œéš¾äºç»´æŠ¤ï¼ŒåŠŸèƒ½æ‰©å±•æ›´æ˜¯ä¸¾æ­¥ç»´è‰°ã€‚æˆ‘ä»¬éƒ½éœ€è¦æœ‰è¿™ç§è®¾è®¡æ€æƒ³ï¼Œæ¯ä¸ªåŒ–å¦†å“éƒ¨ä»¶å„å¸å…¶èŒï¼Œä¸åšå’Œè‡ªå·±ä¸ç›¸å…³çš„äº‹ï¼Œç„¶åæŠŠéƒ¨ä»¶å±‚å±‚å åŠ ï¼Œå¹¶æ ¹æ®éœ€æ±‚ç»„è£…æˆå‹ï¼Œä»¥è¾¾æœ€ç»ˆçš„è£…é¥°ç›®çš„ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹é—¨é¢æ¨¡å¼","date":"2019-03-12T09:18:38.000Z","path":"2019/03/12/2ce91e46.html","text":"ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé—¨é¢ï¼‰ å¼€é—¨è§å±±ï¼Œé—¨ï¼Œå»ºç­‘ç‰©çš„å…¥å£ï¼Œé¢ï¼Œè„¸ä¹Ÿã€‚é—¨é¢ï¼ˆFacadeï¼‰ï¼Œé€šå¸¸æŒ‡åº—é“ºçš„é—¨å¤´å¤–è¡¨éƒ¨åˆ†ï¼Œå½“ç„¶ä¸€å®šè¦ä¸´è¡—æ‰æ˜¯å¥½çš„å•†é“ºï¼Œåœ¨äººæµé‡å¤§çš„åœ°æ–¹è¥é€ æ›´å¥½çš„è§†è§‰å†²å‡»ï¼Œè¿™æ ·ä¼šæœ‰æ›´å¤šç­‰ç­‰æœºä¼šæš´éœ²ç»™æ½œåœ¨é¡¾å®¢ï¼Œå¦åˆ™åªèƒ½æ˜¯é â€œé…’é¦™ä¸æ€•å··å­æ·±â€ï¼Œé å‘³é“æ¥å¸å¼•äººäº†ã€‚ å½“ç„¶é™¤äº†å…‰é²œäº®ä¸½çš„å¤–è¡¨ï¼Œæ›´é‡è¦çš„æ˜¯é—¨åº—æä¾›çš„æœåŠ¡äº†ã€‚å°±æ‹¿é¤é¥®æ¥ä¸¾ä¾‹å§ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›é—¨åº—æˆ‘ä»¬éƒ½æ€æ ·åƒé¥­å‘¢ï¼Ÿæˆ‘ä»¬è‡ªå·±åšåˆä¸ä¼šï¼Œç®—äº†è¿˜æ˜¯æ‰¾å¥³å‹ä¸‹å¨å§ã€‚å¾ˆç®€å•åˆ†ä¸‰æ­¥èµ°ï¼Œé¦–å…ˆæ‰¾èœè´©ä¹°èœï¼Œå…¶æ¬¡å¥³å‹ä¸‹å¨ï¼Œæœ€ååƒå®Œæ´—ç¢—ï¼Œæ‰“å®Œæ”¶å·¥ä»£ç å¦‚ä¸‹ã€‚ public class VegVendor &#123;//èœè´©å­ public void sell()&#123; System.out.println(&quot;èœè´©å­å–èœã€‚ã€‚ã€‚&quot;); &#125;&#125;public class GirlFriend &#123;//å¥³å‹ public void cook()&#123; System.out.println(&quot;å¥³å‹çƒ¹é¥ªã€‚ã€‚ã€‚&quot;); &#125;&#125;public class Me &#123; public void eat()&#123; System.out.println(&quot;æˆ‘åªä¼šåƒã€‚ã€‚ã€‚&quot;); &#125; public static void main(String[] args) &#123; //æ‰¾èœè´©å­ä¹°èœ VegVendor vv = new VegVendor(); vv.sell(); //æ‰¾å¥³å‹åšé¥­ GirlFriend gf = new GirlFriend(); gf.cook(); //æˆ‘åªä¼šåƒ Me me = new Me(); me.eat(); //è°æ´—ç¢—å‘¢ï¼Ÿä¸€åœºæˆ˜åœºä¸€è§¦å³å‘â€¦â€¦ &#125;&#125; å…¶å®æˆ‘ä»¬ä¸è¯¥æ‰¾å¥³å‹åšé¥­çš„ï¼Œè€Œæ˜¯åº”è¯¥é›‡ä¸€ä¸ªä¸“ä¸šå¨å¸ˆï¼Œå¯è¿™ä¸‹æ¥å¾—å¤šå¤§èŠ±è´¹å•Šï¼Œå¤ªåˆ’ä¸æ¥äº†ï¼Œä¹Ÿè®¸è¿˜å¾—æˆ‘ä»¬è‡ªå·±æ´—ç¢—â€¦â€¦å“ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿä¸æƒ³éº»çƒ¦ï¼Œè¿˜æ˜¯æ‰¾é—¨åº—æ¥è§£å†³å§ï¼Œè‡³äºé‚£äº›ä¹°èœå•Šï¼Œçƒ¹é¥ªå•Šï¼Œæ´—ç¢—æ”¶æ‹¾æ¡Œå­å•Šæˆ‘ä»¬ç»Ÿç»Ÿéƒ½ä¸ç”¨ç®¡äº†ï¼Œé—¨åº—å¯ä»¥è¿›è¡Œèµ„æºæ•´åˆä¸è°ƒåº¦ï¼Œè¿™æ ·æˆ‘ä»¬åƒé¥­å°±å˜å¾—å¦‚æ­¤ç®€å•äº†ï¼Œåªéœ€è¦ä»˜é’±å°±è¡Œäº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªä¼šåƒã€‚ public class Facade &#123; private VegVendor vv; private Chef chef; private Waiter waiter; private Cleaner cleaner; public Facade() &#123; this.vv = new VegVendor(); //å¼€é—¨å‰å°±æ‰¾èœè´©å­å‡†å¤‡å¥½è”¬èœ vv.sell(); //å½“ç„¶è¿˜å¾—é›‡ä½£å¥½å„ç±»é¥­åº—æœåŠ¡äººå‘˜ this.chef = new Chef(); this.waiter = new Waiter(); this.cleaner = new Cleaner(); &#125; public void provideService()&#123; //æ¥å¾…ï¼Œå…¥åº§ï¼Œç‚¹èœ waiter.order(); //æ‰¾å¨å¸ˆåšé¥­ chef.cook(); //ä¸Šèœ waiter.serve(); //æ”¶æ‹¾æ¡Œå­ï¼Œæ´—ç¢—ï¼Œä»¥åŠå…¶ä»–å·¥åºâ€¦â€¦ cleaner.clean(); cleaner.wash(); &#125;&#125; è¿™ä¸‹å¯çˆ½äº†ï¼Œæˆ‘ä»¬å†ä¹Ÿä¸ç”¨å»èŠ±è´¹æ—¶é—´å»è°ƒåŠ¨é‚£ä¹ˆå¤šèµ„æºï¼Œåˆæ˜¯å‡ºé—¨ä¹°èœï¼Œåˆæ˜¯æ‰¾å¥³å‹åšèœï¼Œæ´—ç¢—æ“¦æ¡Œä»€ä¹ˆçš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ€¥éœ€ä¸€ä¸ªé—¨é¢æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰é—¨é¢çš„è¯ï¼Œè¯•æƒ³æ¯å®¶æ¯æˆ·æ¯é¡¿éƒ½åšé¥­çš„è¯ï¼Œäºæ˜¯æˆ‘ä»¬æ”¾å¼ƒæˆ‘ä»¬çš„ä¸“ä¸šä¼˜åŠ¿ï¼Œæ•´å¤©èŠ±å¾ˆé•¿æ—¶é—´åšé¥­æ‰èƒ½ä¸é¥¿è‚šå­ï¼Œå¦‚æ­¤åŠ³åŠ¨åˆ†å·¥ä¸æ˜ç¡®ï¼Œç¤¾ä¼šç”Ÿäº§ç‡ä½ä¸‹ï¼Œå›½å®¶ç»æµç”Ÿäº§ä¸æ™¯æ°”ï¼Œæœ€åé€ æˆGDPä¸‹æ»‘ï¼Œè¿™å°±æ˜¯äºšå½“æ–¯å¯†çš„åŠ³åŠ¨åˆ†å·¥ç†è®ºã€‚ æ€»ç»“ï¼š å…¶å®è¿™å°±æ˜¯é—¨é¢æ¨¡å¼çš„ç”¨æ³•äº†ï¼Œé—¨é¢å°±æ˜¯ä¸€ä¸ªå¤§ç³»ç»Ÿï¼Œé‡Œé¢å°è£…äº†å¾ˆå¤šçš„å­éƒ¨ä»¶ï¼ˆæˆ–å­ç³»ç»Ÿï¼‰ï¼Œéƒ¨ä»¶ä¹‹é—´ä¹Ÿè®¸æœ‰å¤æ‚çš„é€»è¾‘å…³ç³»ï¼Œå¯¹äºæˆ‘ä»¬æ—è§‚è€…æ¥è¯´ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›å­éƒ¨ä»¶æ˜¯éå¸¸éº»çƒ¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥é—¨é¢å°±å……å½“äº†ä¸€ä¸ªåŒ…è£…ç±»çš„è§’è‰²ï¼Œå¹¶ä¸”å¯¹å¤–æš´éœ²ä¸€ä¸ªæ¥å£ï¼Œè¾¾åˆ°ç®€åŒ–å®¢æˆ·æ“ä½œçš„ç›®çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹å®¢æˆ·ç«¯ä¸å­ç³»ç»Ÿä¹‹é—´çš„è§£è€¦ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿æ–¹æ³•","date":"2019-03-08T06:54:47.000Z","path":"2019/03/08/334a0583.html","text":"è®¾è®¡æ¨¡å¼`ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ é¢å‘å¯¹è±¡ï¼Œæ˜¯å¯¹äº‹ç‰©å±æ€§ä¸è¡Œä¸ºçš„å°è£…ï¼Œæ–¹æ³•ï¼ŒæŒ‡çš„å°±æ˜¯è¡Œä¸ºã€‚æ¨¡æ¿æ–¹æ³•ï¼Œæ˜¾è€Œæ˜“è§æ˜¯è¯´æŸä¸ªæ–¹æ³•å……å½“äº†æ¨¡æ¿çš„ä½œç”¨ï¼Œå…¶å……åˆ†åˆ©ç”¨äº†æŠ½è±¡ç±»è™šå®ç»“åˆçš„ç‰¹æ€§ï¼Œè™šéƒ¨æŠ½è±¡é¢„ç•™ï¼Œå®éƒ¨å›ºå®šå»¶ç»­ï¼Œä»¥è¾¾åˆ°å°†æŸç§å›ºæœ‰è¡Œä¸ºå»¶ç»­è‡³å­ç±»çš„ç›®çš„ã€‚åè§‚æ¥å£ï¼Œåˆ™è¾¾ä¸åˆ°è¿™ç§ç›®çš„ã€‚è¦ææ˜ç™½æ¨¡æ¿æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬ä»æ¥å£ä¸æŠ½è±¡ç±»çš„åŒºåˆ«åˆ‡å…¥ã€‚ ä»¥ä¸‹æ–‡ç« å†…å®¹æ¥æºï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰ æ¨¡æ¿æ–¹æ³•æ±½è½¦ä¸Šçš„æ¥å£æœ€å¸¸è§çš„å°±æ˜¯è¿™å‡ ä¸ªäº†ï¼šç‚¹çƒŸå™¨ï¼ŒUSBï¼ŒAUXç­‰ç­‰ï¼Œå¾ˆæ˜æ˜¾è¿™äº›éƒ½æ˜¯æ¥å£ï¼Œå®ƒä»¬éƒ½é¢„ç•™äº†æŸç§æ ‡å‡†ï¼Œæš´éœ²åœ¨ç³»ç»Ÿå¤–éƒ¨ï¼Œå¹¶ä¸å¤–è®¾å¯¹æ¥ã€‚å°±æ‹¿ç‚¹çƒŸå™¨æ¥å£æ¥è¯´å§ï¼Œå®ƒåŸæœ¬æ˜¯ä¸“é—¨ç”¨äºç»™ç‚¹çƒŸå™¨ä¾›ç”µçš„ï¼Œåæ¥ç”±äºè¿™ä¸ªæ¥å£åœ¨æ±½è½¦ä¸Šçš„é€šç”¨æ€§ï¼Œäºæ˜¯è¡ç”Ÿå‡ºäº†å„ç§å¤–éƒ¨è®¾å¤‡ï¼Œåªè¦æ˜¯ç¬¦åˆè¿™ä¸ªæ ‡å‡†sizeçš„ï¼Œå¸¦æ­£è´Ÿæç°§ç‰‡çš„ï¼Œç›´æµ12Vçš„ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚å¯¼èˆªã€è¡Œè½¦è®°å½•ä»ªã€å¸å°˜å™¨ä»€ä¹ˆçš„ï¼Œä»¥åŠå…¶ä»–å„ç§è½¦è½½ç”µå­è®¾å¤‡ã€‚ ç‚¹çƒŸå™¨æ¥å£public interface CigarLighterInterface &#123;//ç‚¹çƒŸå™¨æ¥å£ //ä¾›ç”µæ–¹æ³•ï¼Œ16Vç›´æµç”µ public void electrifyDC16V();&#125; GPSpublic class GPS implements CigarLighterInterface &#123; //å¯¼èˆªçš„å®ç° @Override public void electrifyDC16V() &#123; System.out.println(&quot;è¿æ¥å«æ˜Ÿ&quot;); System.out.println(&quot;å®šä½ã€‚ã€‚ã€‚&quot;); &#125;&#125; CigarLighterpublic class CigarLighter implements CigarLighterInterface &#123; //ç‚¹çƒŸå™¨çš„å®ç° @Override public void electrifyDC16V() &#123; int time = 1000; while(--time&gt;0)&#123; System.out.println(&quot;åŠ çƒ­ç”µç‚‰ä¸&quot;); &#125; System.out.println(&quot;ç‚¹çƒŸå™¨å¼¹å‡º&quot;); &#125;&#125; å¯¹äºç‚¹çƒŸå™¨æ¥å£æ¥è¯´ï¼Œå®ƒæ ¹æœ¬ä¸åœ¨ä¹ä¹Ÿä¸çŸ¥é“å¯¹æ¥çš„å¤–è®¾æ˜¯ä»€ä¹ˆé¬¼ï¼Œå®ƒåªæ˜¯å®šä¹‰äº†ä¸€ç§è§„èŒƒï¼Œä¸€ç§æ ‡å‡†ï¼Œåªè¦ç¬¦åˆçš„éƒ½å¯ä»¥å¯¹æ¥ã€‚å†æ¯”å¦‚USBæ¥å£çš„åº”ç”¨æ›´åŠ å¹¿æ³›ï¼Œå¤–è®¾æ›´æ˜¯åº”æœ‰å°½æœ‰ã€‚ å½“ç„¶å¤§éƒ¨åˆ†æƒ…å†µæˆ‘ä»¬ä½¿ç”¨æ¥å£ä¼šå¤šäºæŠ½è±¡ç±»ï¼Œå› ä¸ºæ¥å£çµæ´»å•Šï¼ŒæŠ½è±¡ç±»ä¸å…è®¸å¤šç»§æ‰¿å•Šç­‰ç­‰ï¼Œå…¶å®æˆ‘ä»¬è¿˜æ˜¯è¦çœ‹åº”ç”¨åœºæ™¯ï¼Œåœ¨æŸç§æ— è§„çŸ©ä¸æˆæ–¹åœ†ï¼Œæˆ–è€…è§„èŒƒæ¯”è¾ƒæ˜ç¡®ï¼Œçš„æƒ…å†µä¸‹æŠ½è±¡ç±»çš„åº”ç”¨æ˜¯æœ‰å¿…è¦çš„ï¼Œä¸–é—´ä¸‡ç‰©æ²¡æœ‰æœ€å¥½çš„ï¼Œåªæœ‰æœ€åˆé€‚çš„ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹çŠ¶æ€æ¨¡å¼","date":"2019-03-01T06:22:45.000Z","path":"2019/03/01/5f8f3de5.html","text":"è®¾è®¡æ¨¡å¼`ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ ä¸¾ä¾‹ ä»¥ä¸‹æ–‡å­—æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆçŠ¶æ€ï¼‰ çŠ¶æ€Stateï¼ŒæŒ‡æŸäº‹ç‰©æ‰€å¤„çš„çŠ¶å†µæˆ–å½¢æ€ï¼Œæ¯”å¦‚æ°´çš„ä¸‰æ€ï¼Œé›¶ä¸‹ä¼šå˜æˆå›ºæ€å†°ï¼Œå¸¸æ¸©ä¼šæ˜¯æ¶²æ€æ°´ï¼Œ100â„ƒä¼šè’¸å‘æˆæ°”æ€çš„æ°´è’¸æ°”ã€‚ åœ¨è¿™ä¸ªåœ°çƒç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæ°´çš„æ€»é‡å¹¶ä¸ä¼šå¢åŠ ï¼Œä¹Ÿä¸ä¼šå‡å°‘ï¼Œåªæ˜¯éšç€æ¸©åº¦çš„å˜åŒ–å…¶åˆ†å­é—´å‘ç”Ÿäº†ç¨€æ¾ç´§å¯†çš„å˜åŒ–ç½¢äº†ï¼Œäºæ˜¯ä¾¿æœ‰äº†ä¸åŒçš„è¡Œä¸ºï¼Œæ¯”å¦‚æµåŠ¨ã€å‡å›ºã€æˆ–æ˜¯è’¸è…¾ï¼Œä½†å¯¹äºå…¶æœ¬è´¨H2Oåˆ†å­å¯¹è±¡å¹¶æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå˜åŒ–çš„ï¼Œåªæ˜¯å…¶å½¢æ€ã€‚ å½“ç„¶ï¼Œäº‹ç‰©çš„çŠ¶æ€éƒ½æ˜¯ä¸åŒçš„ï¼Œæœ‰çš„å¤šæœ‰çš„å°‘ã€‚ç‰©è´¨åŸºæœ¬ä¸‰æ€ï¼Œäººçš„ç²¾ç¥çŠ¶æ€æ›´æ˜¯éå¸¸å¤æ‚å¤šå˜çš„ï¼Œå–œæ€’å“€ä¹ï¼Œäº”å‘³æ‚é™ˆã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œå¯¹äºæŸäº›æ‚£æœ‰ä¸¥é‡çš„ç²¾ç¥åˆ†è£‚çš„ç—…äººæ¥è¯´ï¼Œå…¶ç²¾ç¥çŠ¶æ€æ›´æ˜¯å˜åŒ–æ— å¸¸ï¼Œæœ‰äº›ç«Ÿå¯ä»¥æ‰®æ¼”å‡ åç§è§’è‰²ï¼Œéšæ—¶é—´æˆ–å¢ƒé‡åˆ‡æ¢ï¼Œä¸€ä¼šå˜æˆç²¾æ˜èªé¢–çš„å¾‹å¸ˆï¼Œä¸€ä¼šæ˜¯æ‡¦å¼±çš„å¤±è´¥è€…æ€»æ˜¯è¦è‡ªæ€ï¼Œä¸€ä¸ªå¢ƒé‡è§¦å‘åˆæ˜¯æ„¤æ€’çš„æ€äººæš´å¾’ï¼Œè¿™äººæ ¼åˆ‡æ¢é€Ÿåº¦ï¼Œä¸§å¿ƒç—…ç‹‚åˆ°ä»¤äººå‘æŒ‡ã€‚ å®ä¾‹ ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé€‚é…å™¨ï¼‰ å¼€å…³å®ç°ä¸€ä¸ªå¼€å…³ç±»ï¼Œæš´éœ²å‡ºä¸¤ä¸ªUIå¯æ“ä½œæ¥å£ï¼ˆå¯¹æ¥ä½ çš„æ‰‹æŒ‡ï¼‰ï¼šå¼€ã€å…³ã€‚ å®šä¹‰ä¸€ä¸ªç±»å§ï¼Œå°±å«å®ƒï¼šSwitcherå¥½äº†ï¼Œå¯¹å¤–æš´éœ²ä¸¤ä¸ªæ–¹æ³•ï¼šswitchOn()ä»¥åŠswitchOff()ï¼Œä»¥ä¾¿ç”¨æˆ·è°ƒç”¨ã€‚ public class Switcher &#123; //falseä»£è¡¨å…³ï¼Œtrueä»£è¡¨å¼€ private boolean state = false;//åˆå§‹çŠ¶æ€æ˜¯å…³ public void switchOn()&#123; state = !state; System.out.println(&quot;OK...ç¯äº®&quot;); &#125; public void switchOff()&#123; state = !state; System.out.println(&quot;OK...ç¯ç­&quot;); &#125;&#125; æ¥å£è®¾è®¡å®Œæˆï¼Œæ²¡æœ‰é—®é¢˜äº†ï¼ï¼å½“ç„¶è¯´è¿™ä¸ªæ²¡é—®é¢˜æ˜¯åœ¨å‰ç«¯UIå£³å­è®¾è®¡ç²¾å¦™çš„å‰æä¸‹ï¼Œä½†è¿™å¹¶ä¸èƒ½ä»£è¡¨æˆ‘ä»¬çš„ç¨‹åºè®¾è®¡æ²¡é—®é¢˜ã€‚å¦‚æœUIå¯ä»¥é‡å¤è°ƒç”¨å¼€æˆ–è€…å…³ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼ŸçŠ¶æ€ä¹±å¥—äº†ï¼è¿™ä¸ªè®¾è®¡æ˜¯éå¸¸ä¸å¯é çš„ï¼Œæˆ‘ä»¬ä¸èƒ½å› ä¸ºè¡¨é¢è®¾è®¡ä¸Šçš„å®Œç¾å°±å¿½ç•¥äº†åç«¯ä»£ç åŠŸèƒ½çš„é€»è¾‘æ­£ç¡®æ€§ï¼Œè¡¨é‡Œä¸ä¸€ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åšåº”ç”¨æ—¶ä¸ä½†è¦åšå¥½å‰ç«¯æ ¡éªŒï¼ˆç”¨æˆ·ä½“éªŒï¼‰ï¼Œæ›´è¦ä¿è¯åç«¯æ ¡éªŒï¼ˆåŠŸèƒ½æ­£ç¡®æ€§ï¼‰ä¸å¯ç¼ºå¤±ã€‚ æ”¹ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çš„è®¾è®¡ï¼Œè¿™é‡Œä¸€å®šè¦åŠ å…¥é’ˆå¯¹å½“å‰çŠ¶æ€çš„æ¡ä»¶åˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€çš„çŠ¶æ€ä¸èƒ½å†å¼€ï¼Œå…³çš„çŠ¶æ€ä¸èƒ½å†å…³ï¼ public class Switcher &#123; //falseä»£è¡¨å…³ï¼Œtrueä»£è¡¨å¼€ boolean state = false;//åˆå§‹çŠ¶æ€æ˜¯å…³ public void switchOn()&#123; if(state == false)&#123;//å½“å‰æ˜¯å…³çŠ¶æ€ state = true; System.out.println(&quot;OK...ç¯äº®&quot;); &#125;else&#123;//å½“å‰æ˜¯å¼€çŠ¶æ€ System.out.println(&quot;WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€&quot;); &#125; &#125; public void switchOff()&#123; if(state == true)&#123;//å½“å‰æ˜¯å¼€çŠ¶æ€ state = false; System.out.println(&quot;OK...ç¯ç­&quot;); &#125;else&#123;//å½“å‰æ˜¯å…³çŠ¶æ€ System.out.println(&quot;WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³&quot;); &#125; &#125;&#125; è¿™é‡ŒåŠ å…¥äº†é€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœé‡å¤å¼€æˆ–è€…é‡å¤å…³çš„è¯æ˜¯ä¼šå‘Šè­¦çš„ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥æŠ›å¼‚å¸¸å‡ºå»ï¼Œæˆ‘ä»¬å°±ä¸æé‚£ä¹ˆå¤æ‚åŒ–äº†ã€‚é‚£å¯¹äºè¿™æ ·çš„è®¾è®¡æ²¡æœ‰é—®é¢˜å§ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œé€»è¾‘ä¸Šæ˜¯è·‘çš„é€šçš„ï¼Œå†™ä¸ªClientç±»æµ‹è¯•ä¸€ä¸‹ã€‚ public class Client &#123; public static void main(String[] args) &#123; Switcher s = new Switcher(); s.switchOff();//WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³ s.switchOn();//OK...ç¯äº® s.switchOff();//OK...ç¯ç­ s.switchOn();//OK...ç¯äº® s.switchOn();//WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€ &#125;&#125; So farï¼Œä¸ç®¡ç†Šå­©å­æ€ä¹ˆå¼€å¼€å…³å…³éƒ½ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚ è‡ªåŠ¨æŒ¡ è¿™æ ·çš„è®¾è®¡ä»ç„¶æ˜¯ç³Ÿç³•çš„ã€‚è¯•æƒ³ï¼Œå¦‚æœçŠ¶æ€ä¸æ­¢ä¸€ç§ï¼Œå¹¶ä¸”çŠ¶æ€åˆ‡æ¢æœ‰åŠå…¶å¤æ‚çš„é€»è¾‘ï¼Œä¾‹å¦‚ï¼šæ±½è½¦çš„è‡ªåŠ¨æŒ¡ã€‚ æ±½è½¦çš„è‡ªåŠ¨æŒ¡ï¼ŒæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘æ¥è®¾è®¡ï¼Œå°±åƒå¦‚ä¸‹ä»£ç ï¼š public class Car &#123; //0ï¼šParké©»è½¦æ¡£ï¼Œ1ï¼šReverseå€’é€€æŒ¡ï¼Œ //2ï¼šNeutralç©ºæŒ¡ï¼Œ3ï¼šDriveå‰è¿›æ¡£ã€‚ String state = &quot;P&quot;;//åˆå§‹çŠ¶æ€æ˜¯Pæ¡£ public void push()&#123;//å‘ä¸Šæ¨æ¡£æ† switch (state) &#123; case &quot;P&quot;://é©»è½¦æ¡£çŠ¶æ€ System.out.println(&quot;WARN!!!åˆ°å¤´äº†æ¨ä¸åŠ¨äº†ï¼&quot;); break; case &quot;R&quot;://å€’æŒ¡çŠ¶æ€ state = &quot;P&quot;; System.out.println(&quot;OK...åˆ‡Pæ¡£&quot;); break; case &quot;N&quot;://ç©ºæ¡£çŠ¶æ€ System.out.println(&quot;OK...åˆ‡Ræ¡£&quot;); break; case &quot;D&quot;://å‰è¿›æ¡£çŠ¶æ€ System.out.println(&quot;OK...åˆ‡Næ¡£&quot;); break; default: break; &#125; &#125; public void pull()&#123;//å‘ä¸‹æ‹‰æ¡£æ† //è¿™é‡Œçœç•¥ï¼Œé€»è¾‘åŒä¸Šç±»ä¼¼ &#125;&#125; è¿™ä¸ªæ˜¯åœ¨ä½œæ­»äº†ï¼Œé‚£ä¸€å¤§å †é€»è¾‘åˆ¤æ–­å†™åœ¨å®¿ä¸»ç±»é‡Œä¼šè¶Šæ¥è¶Šåƒèœ˜è››ç½‘ï¼æˆ‘ä»¬å¿…é¡»æƒ³æ–¹è®¾æ³•æŠŠè¿™ä¸ªè®¾è®¡ç»™æ¨¡å—åŒ–ï¼ŒæŠŠçŠ¶æ€æ¨¡å—ç»™ç‹¬ç«‹å‡ºæ¥ï¼å¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œå°†ç®—æ³•ç­–ç•¥è¢«æŠ½ç¦»å‡ºæ¥ï¼Œè¿™é‡Œä¸¾ä¸€åä¸‰ï¼ŒæŠŠçŠ¶æ€ä¹Ÿç»™æŠ½ç¦»å‡ºæ¥ï¼Œå¥½äº†åŠæ³•æœ‰äº†ï¼Œæˆ‘ä»¬å¿˜æ‰è‡ªåŠ¨æŒ¡ï¼Œç»§ç»­ç”¨æˆ‘ä»¬å¤§é“è‡³ç®€çš„å¼€å…³ä¾‹å­ã€‚ public interface State &#123; public void switchOn(Switcher switcher);//å¼€ public void switchOff(Switcher switcher);//å…³&#125; ä»¥ä¸Šæˆ‘ä»¬é¦–å…ˆäº†å®šä¹‰ä¸€ä¸ªçŠ¶æ€Stateæ¥å£ï¼Œä¸¤ä¸ªæ–¹æ³•å¼€ä¸å…³ï¼Œæ³¨æ„è¿™é‡Œä¸ç­–ç•¥æ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸ºäº†ä¸å®¿ä¸»Switcherå¯¹æ¥æ‰€ä»¥æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ç„¶åæ˜¯å¼€çŠ¶æ€ä¸å…³çŠ¶æ€çš„å®ç°ã€‚ public class On implements State &#123; @Override public void switchOn(Switcher switcher) &#123; System.out.println(&quot;WARN!!!é€šç”µçŠ¶æ€æ— éœ€å†å¼€&quot;); return; &#125; @Override public void switchOff(Switcher switcher) &#123; switcher.setState(new Off()); System.out.println(&quot;OK...ç¯ç­&quot;); &#125;&#125;public class Off implements State &#123; @Override public void switchOn(Switcher switcher) &#123; switcher.setState(new On()); System.out.println(&quot;OK...ç¯äº®&quot;); &#125; @Override public void switchOff(Switcher switcher) &#123; System.out.println(&quot;WARN!!!æ–­ç”µçŠ¶æ€æ— éœ€å†å…³&quot;); return; &#125;&#125; æ˜¾è€Œæ˜“è§ï¼Œæ³¨æ„çœ‹ç¬¬10è¡Œä»£ç ï¼Œå¼€çŠ¶æ€ä¸èƒ½åšå¼€è¡Œä¸ºï¼Œåªå‘Šè­¦å¹¶è¿”å›ï¼Œå…³çŠ¶æ€åä¹‹äº¦ç„¶ã€‚è€Œç¬¬4è¡Œä»£ç åˆ™æ˜¯åˆæ³•çš„è¡Œä¸ºï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡ŒçŠ¶æ€åˆ‡æ¢å¹¶å®æ–½ç›¸åº”è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€çŠ¶æ€å¯å…³ï¼Œå…³çŠ¶æ€å¯å¼€ã€‚æ³¨æ„è¿™é‡Œæ˜¯æŠŠå®¿ä¸»å¯¹è±¡ä¼ å…¥è¿›æ¥ç”¨äºåˆ‡æ¢å…¶å½“å‰çŠ¶æ€ï¼Œäº¦æˆ–æ˜¯è°ƒç”¨å®¿ä¸»çš„å…·ä½“åŠŸèƒ½æ–¹æ³•ï¼ˆè¿™é‡Œçœç•¥ç”¨æ‰“å°è¾“å‡ºä»£æ›¿ï¼‰ï¼Œæ¯”å¦‚å®¿ä¸»é‡Œçš„ä¸€ç›ç¯æä¾›çš„æ–¹æ³•ã€‚ è‡³æ­¤ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éå¸¸ä¼˜é›…ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸçš„å°†çŠ¶æ€ä»å®¿ä¸»ä¸­æŠ½ç¦»äº†ï¼Œæœ€åå†æ¥çœ‹å®¿ä¸»å¼€å…³ç±»æ˜¯ä»€ä¹ˆæ ·å­ã€‚ public class Switcher &#123; //å¼€å…³çš„åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºâ€œå…³â€ private State state = new Off(); public State getState() &#123; return state; &#125; public void setState(State state) &#123; this.state = state; &#125; public void switchOn()&#123; state.switchOn(this);//è¿™é‡Œè°ƒç”¨çš„æ˜¯å½“å‰çŠ¶æ€çš„å¼€æ–¹æ³• &#125; public void switchOff()&#123; state.switchOff(this);//è¿™é‡Œè°ƒç”¨çš„æ˜¯å½“å‰çŠ¶æ€çš„å…³æ–¹æ³• &#125;&#125; ç”šè‡³æˆ‘ä»¬è¿˜å¯ä»¥ç»™é‡Œé¢åŠ ä¸€ç›ç¯ï¼Œåƒä¹‹å‰æˆ‘ä»¬æåˆ°çš„é‚£æ ·ï¼Œåœ¨StateçŠ¶æ€æ¥å£å®ç°é‡Œå»è°ƒç”¨ã€‚ public class Switcher &#123; //...ä¹‹ä¸Šä»£ç ç•¥... private Lamp lamp; public void lampOn()&#123; lamp.on(); &#125; public void lampOff()&#123; lamp.off(); &#125;&#125; å…¶å®å®ƒå°±æ˜¯ç­–ç•¥çš„ä¸€ä¸ªå˜ç§ï¼Œåªä¸è¿‡çŠ¶æ€æ¨¡å¼ä¼šæ›´å¥½çš„æ ¹æ®å½“å‰çš„çŠ¶æ€å»å®æ–½ä¸åŒçš„è¡Œä¸ºï¼Œå¹¶ä¸”è‡ªä¸»åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼Œå¼€å˜å…³ï¼Œå…³å˜å¼€ã€‚å°±å¥½ä¼¼ç”µæ¢¯ï¼ˆè™½ç„¶æ˜¯åµŒå…¥å¼é¢å‘è¿‡ç¨‹ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ï¼‰ï¼Œç”¨æˆ·æ ¹æœ¬æ— æ³•éšæ„å¼ºåˆ¶æ›´æ”¹å…¶çŠ¶æ€ä»¥åŠè¡Œä¸ºï¼Œä½ è®©å®ƒä¸Šï¼Œå®ƒä¸ä¸€å®šé©¬ä¸Šå°±èƒ½ä¸Šï¼Œå¦åˆ™ä¼šé€ æˆäº‹æ•…ã€‚ç”µæ¢¯å†…éƒ¨å°è£…äº†å¤šä¸ªçŠ¶æ€ä»¥åŠå¯¹åº”çš„é€»è¾‘äº§ç”Ÿä¸åŒçš„è¡Œä¸ºï¼Œå®ƒä¼šæ ¹æ®å½“å‰çŠ¶æ€å»è‡ªæˆ‘è°ƒæ•´å¹¶å®æ–½æœ€ä¼˜æ–¹æ¡ˆï¼Œä»¥è¾¾åˆ°å®‰å…¨ã€é«˜æ•ˆçš„ç›®çš„ï¼Œè¿™æ‰æ˜¯å¯é çš„è®¾è®¡ã€‚ æ³¨æ„äº‹é¡¹ï¼šåœ¨è¡Œä¸ºå—çŠ¶æ€çº¦æŸçš„æ—¶å€™ä½¿ç”¨çŠ¶æ€æ¨¡å¼ï¼Œè€Œä¸”çŠ¶æ€ä¸è¶…è¿‡ 5 ä¸ªã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹ç­–ç•¥æ¨¡å¼","date":"2019-02-26T05:53:55.000Z","path":"2019/02/26/a7a792e2.html","text":"è®¾è®¡æ¨¡å¼ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ ç­–ç•¥æ¨¡å¼åœ¨ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰ä¸­ï¼Œä¸€ä¸ªç±»çš„è¡Œä¸ºæˆ–å…¶ç®—æ³•å¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚ åœ¨ç­–ç•¥æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºè¡¨ç¤ºå„ç§ç­–ç•¥çš„å¯¹è±¡å’Œä¸€ä¸ªè¡Œä¸ºéšç€ç­–ç•¥å¯¹è±¡æ”¹å˜è€Œæ”¹å˜çš„ context å¯¹è±¡ã€‚ç­–ç•¥å¯¹è±¡æ”¹å˜ context å¯¹è±¡çš„æ‰§è¡Œç®—æ³•ã€‚ å®ä¾‹ ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆç­–ç•¥ï¼‰ è®¡ç®—å™¨å®ç°ä¸€ä¸ªæœ€ç®€å•çš„è®¡ç®—å™¨ï¼Œå‡è®¾åªèƒ½è¿›è¡ŒåŠ å‡æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š public class Calculator &#123;//è¿åè®¾è®¡æ¨¡å¼åŸåˆ™çš„åšæ³• public int add(int a, int b)&#123;//åŠ æ³• return a + b; &#125; public int sub(int a, int b)&#123;//å‡æ³• return a - b; &#125;&#125; è¿™æ ·å†™èƒ½å®ç°æˆ‘ä»¬çš„åŠ å‡æ³•åŠŸèƒ½ï¼Œä½†æ˜¯å¾€æ‹“å±•æ–¹é¢æƒ³ï¼Œå¦‚æœéšç€æˆ‘ä»¬çš„ç®—æ³•ä¸æ–­å¢åŠ ï¼Œå¦‚ä¹˜æ³•ã€é™¤æ³•ã€æ¬¡æ–¹ã€å¼€æ–¹ç­‰ç­‰ï¼Œé‚£ä¹ˆè¿™ä¸ªè®¡ç®—å™¨ç±»å°±å¾—ä¸æ–­çš„æ”¹å•Šæ”¹å•Šï¼Œæ”¹åˆ°æœ€åè¿™ä¸ªç±»çš„ä»£ç å°†ä¼šéå¸¸åºå¤§ã€‚ã€‚ æŠ½è±¡æ—¢ç„¶ä¸èƒ½æŠŠç®—æ³•ç»™å†™æ­»åœ¨è¿™é‡Œé¢ï¼Œé‚£ä¸€å®šè¦æŠŠè¿™ä¸ªç®—æ³•ç»™æŠ½è±¡ä¸€ä¸‹ï¼ŒæŠŠå®ç°ç»†èŠ‚ä»è¿™ä¸ªç±»é‡ŒæŠ½ç¦»å‡ºæ¥ï¼Œç‹¬ç«‹å‡ºæ¥æˆä¸ºnä¸ªç­–ç•¥ï¼Œå°±å½“ä¸‹æ¥è®²æˆ‘ä»¬ä¸€å…±æœ‰ä¿©ä¸ªç­–ç•¥ï¼Œä¸€ä¸ªæ˜¯åŠ æ³•ç­–ç•¥ï¼Œä¸€ä¸ªæ˜¯å‡æ³•ç­–ç•¥ï¼Œä»–ä»¬å®ç°çš„éƒ½æ˜¯åŒä¸€ä¸ªç®—æ³•æ¥å£ï¼Œæ¥æ”¶å‚æ•°ä¸ºæ“ä½œæ•°aï¼Œä»¥åŠè¢«æ“ä½œæ•°bã€‚ public interface Strategy &#123;//ç®—æ³•æ ‡å‡† public int calculate(int a, int b);//æ“ä½œæ•°ï¼Œè¢«æ“ä½œæ•°&#125; å®ç°åŠ æ³•public class Addition implements Strategy&#123;//å®ç°ç®—æ³•æ¥å£ @Override public int calculate(int a, int b) &#123;//åŠ æ•°ä¸è¢«åŠ æ•° return a + b;//è¿™é‡Œæˆ‘ä»¬åšåŠ æ³•è¿ç®— &#125;&#125; å‡æ³•public class Subtraction implements Strategy&#123;//å®ç°ç®—æ³•æ¥å£ @Override public int calculate(int a, int b) &#123;//å‡æ•°ä¸è¢«å‡æ•° return a - b;//è¿™é‡Œæˆ‘ä»¬åšå‡æ³•è¿ç®— &#125;&#125; å®ç°è®¡ç®—å™¨public class Calculator &#123;//è®¡ç®—å™¨ç±» private Strategy strategy;//æ‹¥æœ‰æŸç§ç®—æ³•ç­–ç•¥ public void setStrategy(Strategy strategy) &#123;//æ¥å…¥ç®—æ³•ç­–ç•¥ this.strategy = strategy; &#125; public int getResult(int a, int b)&#123; return this.strategy.calculate(a, b);//è¿”å›å…·ä½“ç­–ç•¥çš„ç»“æœ &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—å™¨ç±»é‡Œå·²ç»æŠŠä¹‹å‰çš„å…·ä½“åŠ å‡ç®—æ³•å®ç°ä»£ç ç»™å‰¥ç¦»å‡ºå»äº†ï¼Œè¦ç”¨å“ªä¸ªç®—æ³•ï¼Œåªéœ€è¦æ³¨å…¥è¿›æ¥ï¼Œç„¶åè·å¾—è®¡ç®—ç»“æœgetResultå®é™…ä¸Šè°ƒç”¨çš„æ˜¯å…·ä½“ç®—æ³•çš„calculateã€‚ ä½¿ç”¨è®¡ç®—å™¨public class Client &#123; public static void main(String[] args) &#123; Calculator calculator = new Calculator();//å®ä¾‹åŒ–è®¡ç®—å™¨ calculator.setStrategy(new Addition());//æ¥å…¥åŠ æ³•å®ç° int result = calculator.getResult(1, 1);//è®¡ç®—ï¼ System.out.println(result);//å¾—åˆ°çš„æ˜¯åŠ æ³•ç»“æœ2 calculator.setStrategy(new Subtraction());//å†æ¬¡æ¥å…¥å‡æ³•å®ç° result = calculator.getResult(1, 1);//è®¡ç®—ï¼ System.out.println(result);//å¾—åˆ°çš„æ˜¯å‡æ³•ç»“æœ0 &#125;&#125; è¿™ä¸ªè®¡ç®—å™¨å¯ä»¥è¯´æ˜¯å…·æœ‰ç®—æ³•ç­–ç•¥æ‰©å±•æ€§çš„ï¼Œä»¥åè¦æœ‰æ–°çš„ç®—æ³•æ˜¯ä¸éœ€è¦å†æ›´æ”¹ä»»ä½•ç°æœ‰ä»£ç çš„ï¼Œåªéœ€è¦æ–°å†™ä¸€ä¸ªç®—æ³•æ¯”å¦‚ä¹˜æ³•Multiplicationï¼Œå¹¶å®ç°calculateæ–¹æ³•ï¼Œæ¥ä¸‹æ¥è¦åšçš„åªæ˜¯ç»„è£…ä¸Šå»ä¾¿å¯ä»¥ä½¿ç”¨äº†ã€‚ æ€»ç»“ç­–ç•¥å®ç°ç±»å·²ç»æˆä¸ºç‹¬ç«‹äºå®¿ä¸»ä¹‹å¤–çš„æ¨¡å—ï¼Œå³æ’å³ç”¨ã€‚å¯ä»¥ç»„åˆæˆä¸ºä¸€ä¸ªæ•´ä½“ï¼Œåˆå¯ä»¥åˆ†æ‹†ç‹¬ç«‹ï¼Œå¯ä»¥å‘ç”Ÿå…³è”ï¼Œä½†ç»ä¸è€¦åˆï¼Œæ—¢å¯¹ç«‹åˆç»Ÿä¸€ï¼Œè¿™æ˜¯å”¯ç‰©è¾©è¯æ³•çš„ç»ä½³ä½“ç°ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹é€‚é…å™¨æ¨¡å¼","date":"2019-02-25T02:03:23.000Z","path":"2019/02/25/8ac957b9.html","text":"è®¾è®¡æ¨¡å¼ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ å®ä¾‹ ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé€‚é…å™¨ï¼‰ é¡¾åæ€ä¹‰ï¼Œé€‚é…å™¨ï¼Œå¾—é€‚åº”å½“å‰çš„ä¸åŒé…ç½®ï¼Œè§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚æˆ‘ä»¬ç”Ÿæ´»ä¸­å……æ»¡äº†å„ç§å„æ ·çš„é€‚é…å™¨ï¼Œä¸Šç½‘ç”¨çš„è°ƒåˆ¶è§£è°ƒå™¨(modem)å°±æ˜¯ä¸€ç§æ•°æ¨¡è½¬æ¢çš„é€‚é…å™¨ï¼Œä¿—ç§°â€œçŒ«â€ï¼Œä¸è¿‡ç°åœ¨éƒ½æ˜¯å…‰çŒ«äº†ï¼Œä¹Ÿå°±æ˜¯å…‰ä¿¡å·å’Œç”µä¿¡å·çš„äº’ç›¸è½¬åŒ–ï¼Œå…¶å®é“ç†æ˜¯ä¸€æ ·çš„ï¼Œè¿˜æœ‰å„ç§å˜å‹å™¨ä¹Ÿå±äºç”µå‹è½¬æ¢çš„é€‚é…å™¨ã€‚ å¦‚æœè§‰å¾—è¿˜ä¸å¤Ÿå½¢è±¡å¯ä»¥çœ‹ä¸€ä¸‹å®¶é‡Œçš„ç”µå™¨ï¼Œæ¯”å¦‚ä½ çš„ç”µè§†æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå¢™ä¸Šçš„æ’å­”æ˜¯ä¸‰é¡¹æ’å­”æ€ä¹ˆåŠï¼Ÿå“¦ï¼Œæœ‰äººè¯´æŠŠæ’å¤´æ°å¼¯å¼ºè¡Œæ’å…¥ï¼é‚£å¦‚æœæ˜¯ä¸‰é¡¹æ’å¤´æ¥ä¸¤é¡¹æ’å­”å‘¢ï¼ŸæŠŠé›¶çº¿æ’é’ˆæ‹”äº†ï¼å‘ƒï¼Œæˆ‘åªèƒ½è¯´è¿™æ˜¯æš´åŠ›ç ´è§£ï¼è¿åè®¾è®¡æ¨¡å¼åŸåˆ™ã€‚è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸è¦éšä¾¿ç ´åç°æœ‰çš„ç±»ï¼Œé‚£æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œç”¨ä¼˜é›…å¾®å¦™çš„æ–¹å¼åŒ–è§£è¿™ç§ä¸å…¼å®¹æƒ…å†µã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¼€å§‹ä»£ç éƒ¨åˆ†ï¼Œå…ˆå†™å¢™ä¸Šçš„ä¸‰é¡¹æ’å­”æ¥å£ï¼Œå‘½åTriplePinï¼š public interface TriplePin &#123; //å‚æ•°åˆ†åˆ«ä¸ºç«çº¿liveï¼Œé›¶çº¿nullï¼Œåœ°çº¿earth public void electrify(int l, int n, int e);&#125; æˆ‘ä»¬åªå®šä¹‰ä¸‰æ’å­”æ ‡å‡†electrifyï¼ˆé€šç”µï¼‰æ–¹æ³•ï¼Œä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç«çº¿ã€é›¶çº¿ã€åœ°çº¿ï¼Œå¾ˆç®€å•å§ï¼ŒåŒæ ·åœ°æ¥ä¸‹æ¥æ˜¯ä¸¤é¡¹æ’å­”æ¥å£ï¼Œåªæ˜¯å°‘äº†åœ°çº¿ï¼Œå‘½åDualPinï¼š public interface DualPin &#123; public void electrify(int l, int n);//è¿™é‡Œæ²¡æœ‰åœ°çº¿&#125; è¯·æ³¨æ„ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯æˆ‘ä»¬çš„å¢™ä¸Šçš„ç›®æ ‡æ¥å£ï¼Œè€Œæ˜¯ç”µè§†æœºçš„ä¸¤æ’æ ‡å‡†ã€‚å¥½äº†ç»§ç»­ï¼Œæˆ‘ä»¬çš„TVç™»åœºäº†ï¼Œç”¨çš„æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå½“ç„¶å®ƒå®ç°çš„æ˜¯DualPinçš„æ ‡å‡†ï¼ŒLet&#39;s keep it simpleï¼Œå‘½åTVï¼š public class TV implements DualPin &#123; @Override//æ—¢ç„¶æ˜¯ä¸¤é¡¹æ’å¤´ï¼Œå½“ç„¶å®ç°ä¸¤é¡¹æ’æ ‡å‡† public void electrify(int l, int n) &#123; System.out.println(&quot;ç«çº¿é€šç”µï¼š&quot; + l); System.out.println(&quot;é›¶çº¿é€šç”µï¼š&quot; + n); &#125;&#125; é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¢™ä¸Šçš„æ¥å£æ˜¯ä¸‰æ’æ ‡å‡†ï¼Œç”µè§†å®ç°çš„æ˜¯ä¸¤æ’æ ‡å‡†ï¼Œæ— æ³•é€šç”µã€‚æ€ä¹ˆåŠï¼ŸæŠŠç”µè§†æ‹†äº†é‡æ–°ä¿®æ”¹å®ç°ä¸‰æ’æ ‡å‡†ä¹ˆï¼Ÿæš´åŠ›ä»½å­ä½ åˆæ¥ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯å¦å®šçš„ï¼Œæ—¢ç„¶æ˜¯è®¾è®¡æ¨¡å¼ï¼Œæœæ–­è½¬æ¢æ’å¤´å•Šï¼å¥½ï¼Œå†™ä¸ªAdapterè§£å†³ä»–ä»¬ä¹‹é—´ä¸å¯è°ƒå’Œçš„çŸ›ç›¾ã€‚ public class Adapter implements TriplePin &#123; private DualPin dualPinDevice; //åˆ›å»ºé€‚é…å™¨åœ°æ—¶å€™ï¼Œéœ€è¦æŠŠåŒæ’è®¾å¤‡æ¥å…¥è¿›æ¥ public Adapter(DualPin dualPinDevice) &#123; this.dualPinDevice = dualPinDevice; &#125; //é€‚é…å™¨å®ç°çš„æ˜¯ç›®æ ‡æ¥å£ @Override public void electrify(int l, int n, int e) &#123; //å®é™…ä¸Šè°ƒç”¨äº†è¢«é€‚é…è®¾å¤‡çš„åŒæ’é€šç”µï¼Œåœ°çº¿eè¢«ä¸¢å¼ƒäº†ã€‚ dualPinDevice.electrify(l, n); &#125;&#125; æ³¨æ„äº†æœ€å…³é”®æœ€ç²¾åçš„éƒ¨åˆ†æ¥äº†ï¼Œprivate DualPin dualPinDevice; ä»£ç æ„å‘³ç€è¿™ä¸ªé€‚é…å™¨å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ªåŒæ’æ¥å£çš„ï¼Œå¯¹äºä»»ä½•åŒæ’æ ‡å‡†çš„è®¾å¤‡éƒ½æ˜¯å¯ä»¥å…¼å®¹çš„OKå—ï¼Ÿä¸æ˜ç™½èµ¶ç´§çœ‹çœ‹ä½ å®¶é‡Œçš„é€‚é…å™¨ã€‚public Adapter(DualPin dualPinDevice) &#123;...&#125;æ–¹æ³•çš„ä»£ç å®Œæˆçš„è¿‡ç¨‹å®é™…å°±æ˜¯ä½ æŠŠç”µè§†æ’å¤´æ¥å…¥Adapteräº†ï¼Œå…¶å®é€‚é…å™¨å¹¶ä¸åœ¨æ„æ˜¯ä»€ä¹ˆè®¾å¤‡ï¼Œæ´—è¡£æœºå†°ç®±éƒ½å¯ä»¥çš„ï¼Œåªè¦æ˜¯åŒæ’æ ‡å‡†å°±å¯ä»¥æ¥å…¥ï¼ˆç¬¬ä¸€èŠ‚è®²è¿‡çš„å¤šæ€æ¦‚å¿µï¼‰ã€‚electrify()é€šç”µæ–¹æ³•å®ç°çš„æ˜¯ä¸‰æ’æ ‡å‡†ï¼Œä½†æ–¹æ³•ä½“å†…éƒ¨dualPinDevice.electrify(l, n);å®é™…ä¸Šæ˜¯åœ¨ç»™â€œæŸä¸ªè®¾å¤‡â€ï¼ˆæ˜¯ä»€ä¹ˆè®¾å¤‡å°±çœ‹ä½ æ¥ä»€ä¹ˆäº†ï¼‰çš„åŒæ’ä¾›ç”µï¼Œåœ°çº¿eé‚£ä¸ªå‚æ•°æ˜¯ç”¨ä¸ä¸Šçš„ï¼Œæ‰€ä»¥å°±æ²¡æœ‰æ¥é€šï¼Œå¾ˆæ¸…æ™°é€å½»å§ï¼Ÿ å½“ç„¶ï¼Œé™¤äº†ä»¥ä¸Šçš„æ³¨å…¥æ’å¤´çš„æ–¹å¼ï¼ˆå¯¹è±¡é€‚é…ï¼‰ï¼Œè¿˜æœ‰å¦ä¸€ç§æ›´ç®€å•çš„æ–¹å¼å«åšâ€œç±»é€‚é…å™¨â€æˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š public class ClassAdapter extends TV implements TriplePin&#123; @Override public void electrify(int l, int n, int e) &#123; super.electrify(l, n); &#125;&#125; çœ‹å‡ºæ¥åŒºåˆ«æ²¡æœ‰ï¼Ÿè¿™é‡Œå¹¶æ²¡æœ‰æ³¨å…¥æ’å¤´ï¼ˆå¯¹è±¡ç»„åˆï¼‰ï¼Œè€Œæ˜¯æŠŠç”µè§†æœºç»™ç»§æ‰¿äº†ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨çˆ¶ç±»ï¼ˆTVï¼‰çš„åŒæ’é€šç”µè€Œä¸æ˜¯æ³¨å…¥è¿›æ¥å»è°ƒç”¨ï¼Œç¼ºç‚¹å¤§å®¶ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™é€‚é…å™¨ç»§æ‰¿ä¸ºTVå„¿å­ä¸“ç”¨äº†ï¼Œæ´—è¡£æœºæ˜¯ç”¨ä¸äº†å•¦ï¼Œä½œæ­»ï¼Ÿå…¶å®ä¹Ÿä¸æ˜¯å®Œå…¨ä¸å¥½ï¼Œè¦çœ‹å…·ä½“åº”ç”¨åœºæ™¯å“ˆã€‚ è‡³æ­¤ï¼Œæˆ‘ä»¬çš„Adapterå°±å·®ä¸å¤šå®Œæˆäº†ï¼Œä»¥åå†ä¹Ÿä¸ç”¨ç ´åæ’å¤´äº†ï¼Œå› ä¸ºè¿™æ ·é‡å†™æ¥å£æˆ–è€…ä¿®æ”¹ç±»çš„ä»£ä»·å¤ªå¤§ï¼Œå¦‚æœå…¶ä»–ç±»è¿˜æœ‰ä¾èµ–çš„è¯ï¼Œé‚£ç»Ÿç»Ÿè¦ä¿®æ”¹ï¼Œå¼•å…¥äº†æ²¡æœ‰å¿…è¦çš„é‡æ„ï¼Œæ€»ä¹‹æš´åŠ›ä¿®æ”¹æ˜¯è¿åè®¾è®¡æ¨¡å¼çš„åŸºæœ¬åŸåˆ™çš„ï¼Œå¼€é—­åŸåˆ™ï¼ŒæŒ‡çš„å°±æ˜¯å¯¹æ‰©å±•å¼€æ”¾ï¼Œè€Œå¯¹ä¿®æ”¹å…³é—­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸è¦å»æ”¹åŠ¨åŸå§‹ç±»ï¼Œè€Œæ˜¯æ‰©å±•ç°æœ‰åŠŸèƒ½ï¼Œæä¾›å¦ä¸€ç§æœºåˆ¶è®©æ•´ä¸ªç³»ç»Ÿå®ç°æƒ³è¦çš„åŠŸèƒ½ã€‚ æœ€åè¯´ä¸‹é‚£äº›æ¦‚å¿µï¼Œå½’ç±»ï¼Œåå­—ï¼Œä»€ä¹ˆâ€œç±»é€‚é…å™¨â€ï¼Œâ€œå¯¹è±¡é€‚é…å™¨â€å•Šï¼Œå…¶å®ï¼Œç†è§£ä¸äº†å°±ç®—äº†æ— æ‰€è°“ï¼ŒçœŸæ­£çš„æ„ä¹‰åœ¨äºæ€ä¹ˆæ ·åœ¨å®é™…å·¥ä½œä¸­çµæ´»è¿ç”¨ï¼Œå®ç°æ–¹å¼æ˜¯æ— ç©·æ— å°½çš„ï¼Œé“ä¸æ¸…è¯´ä¸å°½çš„ï¼Œæ²¡å¿…è¦å¤ªçº ç»“å®ƒåˆ°åº•å«ä»€ä¹ˆï¼Œå½’äºå“ªä¸€ç±»ï¼ŒæŒæ§å…¶èƒŒåçš„é“æ‰æ˜¯æœ€æ ¹æœ¬çš„ï¼Œæ­£å¦‚æè€³å›æ‰€è¨€ï¼šâ€œé“å¯é“ï¼Œéå¸¸é“ã€‚åå¯åï¼Œéå¸¸åã€‚â€","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼","date":"2019-02-20T07:37:39.000Z","path":"2019/02/20/242438ad.html","text":"è®¾è®¡æ¨¡å¼ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ å•ä¾‹æ¨¡å¼å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯ Java ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚ è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚ æ³¨æ„ 1ã€å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚ 2ã€å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚ 3ã€å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚ ä»‹ç»æ„å›¾ï¼šä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚ ä¸»è¦è§£å†³ï¼šä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯ã€‚ ä½•æ—¶ä½¿ç”¨ï¼šå½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™ã€‚ å¦‚ä½•è§£å†³ï¼šåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºã€‚ å…³é”®ä»£ç ï¼šæ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚ å®ä¾‹åº”ç”¨ ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆå•ä¾‹ï¼‰ å•ä¾‹ï¼Œé¡¾åæ€ä¹‰ï¼Œæ•´ä¸ªç³»ç»Ÿå…¶å®å°±åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨ï¼Œä¸èƒ½å†å¤šï¼Œå¦åˆ™å°±ä¸å«å•ä¾‹ã€‚é‚£æˆ‘ä»¬æŠŠæ•´ä¸ªå®‡å®™çœ‹åšæ˜¯ä¸€ä¸ªåºå¤§çš„ç³»ç»Ÿï¼Œè¿™å®‡å®™é‡Œæœ‰å„ç§å¯¹è±¡å­˜åœ¨ï¼Œäººå•Šï¼ŒåŠ¨ç‰©å•Šï¼Œæ¤ç‰©å•Šä¸èƒœæšä¸¾ï¼Œè¿™äº›éƒ½æ˜¯å®ä¾‹ï¼Œä¸°å¯Œå¤šå½©çš„ä¸–ç•Œæ˜¯ç¾å¥½çš„ã€‚ç„¶è€Œï¼ŒæŒç»­å‡ åƒå¹´çš„æˆ˜äº‰ç»™ä¸–ç•Œå¸¦æ¥äº†å·¨å¤§ç¾éš¾ï¼Œå°¤å…¶æ˜¯å®—æ•™æˆ˜äº‰æœ€ä¸ºæ®‹å¿ï¼Œå„ä¸ªä¿¡ä»°é—´å­˜åœ¨æå¤§çš„ä¸–ç•Œè§‚ä»·å€¼è§‚å†²çªã€‚ å•å°åº¦ä¸€ä¸ªå›½å®¶å°±æœ‰å‡ ç™¾ä¸ªç¥ï¼Œäººä»¬å„ä¿¡å„çš„ï¼Œé£ä¿—å„å¼‚ï¼Œå„é‚¦æ–‡åŒ–å†²çªä¸æ–­ï¼Œè¯­è¨€ä¸é€šï¼ŒåŠäº‹æ•ˆç‡æä½ã€‚ ä¸ºäº†è®©å¹¸ç¦ç¾å¥½æ´’æ»¡äººé—´ï¼Œé‚£æˆ‘ä»¬å°±å®šä¹‰ä¸€ä½ç¥å§ï¼Œç‹¬ä¸€æ— äºŒçš„ç¥ã€‚ æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªGodç±»å§ï¼Œç±»ä¸­ç©ºç©ºå¦‚ä¹Ÿï¼Œä¸–ç•Œå¦‚æ­¤æ¸…å‡€ï¼Œè™šæ— ç¼¥ç¼ˆã€‚ public class God &#123;&#125; é¦–å…ˆæˆ‘ä»¬å¾—ä¿è¯ä»»ä½•äººéƒ½ä¸èƒ½å»åˆ›å»ºç¥çš„å®ä¾‹ï¼Œå¦åˆ™å¦‚ï¼šnew God()ï¼Œè¿™æ ·ä¸–ç•Œåˆè¦é™·å…¥æˆ˜äº‰çš„ç¾éš¾ï¼Œå„ç§é€ ç¥è¿åŠ¨ï¼Œæˆ–æ˜¯æŸå¤©åˆå‡ºæ¥ä¸ªä»€ä¹ˆç¥æ£å…ˆçŸ¥å‘Šè¯‰ä¿¡å¾’è¯´ä»–ä»¬è‚šå­é‡Œæœ‰ä¸ªè½®å­ã€‚é‚£å°±ä¸å†™æ„é€ æ–¹æ³•å§ï¼Ÿä¸è¡Œï¼Œå› ä¸ºæœ‰é»˜è®¤çš„æ— å‚æ„é€ å™¨ï¼é‚£å°±æŠŠæ„é€ æ–¹æ³•æ”¹æˆprivateå§ï¼Œä¹Ÿå°±æ˜¯ç¥å¯ä»¥è‡ªå·±åˆ›é€ è‡ªå·±ï¼Œä½†åˆ«äººä¸èƒ½ã€‚ public class God &#123; private God()&#123;&#125;//æ„é€ æ–¹æ³•ç§æœ‰åŒ–&#125; Godç±»é‡Œé¢å°è£…ä¸€ä¸ªGodè‡ªå·±ï¼Œå¯¹ï¼Œä¸€åˆ‡éƒ½æ˜¯ç¥åˆ›é€ çš„ï¼ŒåŒ…æ‹¬æˆ‘ä»¬äººç±»ã€‚æœ‰äººå¼€å§‹è´¨ç–‘ï¼Œé‚£ç¥æ˜¯è°ï¼Ÿç¥è‡ªå·±æ˜¯è°é€ çš„ï¼Ÿè¿™æ˜¯ä¸ªå“²å­¦é—®é¢˜ã€‚ç¥è¯´â€œI am who I am.â€ æˆ‘æ˜¯æˆ‘æ‰€æ˜¯ï¼Œæˆ‘å°±æ˜¯æˆ‘ï¼Œè‡ªæœ‰æ°¸æœ‰ï¼Œè¶…è¶Šæ—¶ç©ºã€‚å¾ˆé€†å¤©å§ï¼Ÿ å¥½å§ï¼Œè°ä¹Ÿä¸èƒ½é€ ä¸Šå¸ï¼Œç¥è‡ªå·±é€ è‡ªå·±ã€‚ public class God &#123; private static final God god = new God();//è‡ªæœ‰æ°¸æœ‰çš„ç¥å•ä¾‹ private God()&#123;&#125;//æ„é€ æ–¹æ³•ç§æœ‰åŒ–&#125; ä»¥ä¸Šprivateå…³é”®å­—ä¿è¯äº†ä¸Šå¸çš„ç§æœ‰æ€§ï¼Œä¸å¯è§æ€§ï¼Œä¸å¯è®¿é—®æ€§ï¼Œæˆ‘æƒ³æ²¡æœ‰æ´»äººè§è¿‡ä¸Šå¸å§ï¼Ÿstaticå…³é”®å­—ä¿è¯ä¸Šå¸çš„é™æ€æ€§ï¼Œä»–ä¸ç±»åŒåœ¨ï¼Œä¸ä¾èµ–äºç±»çš„å®ä¾‹åŒ–å°±è‡ªæœ‰æ°¸æœ‰ï¼Œä»–å°†åœ¨å†…å­˜ä¸­æ°¸ç”Ÿï¼ŒGCåƒåœ¾å›æ”¶å™¨ä¹Ÿå›æ”¶ä¸äº†ä»–ã€‚finalå…³é”®å­—åˆ™ä¿è¯è¿™ä½ç¥æ˜¯å’Œå¸¸é‡ï¼Œè¡¡é‡ï¼Œä»–æ˜¯ç»ˆæä¸Šå¸ï¼Œä¸èƒ½å†æ”¹ã€‚ æ­£å¦‚åŒé™æ€æ–¹æ³•main()ï¼Œä¸éœ€è¦å®ä¾‹åŒ–ç±»å°±èƒ½è¿è¡Œçš„å…¥å£ï¼ŒåŒæ ·æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé™æ€æ–¹æ³•getInstance()æ¥è¯·ç¥ï¼Œæ–¹æ³•ä½“å†…æˆ‘ä»¬å°±è¿”å›è¿™ä¸ªåœ¨å”¯ä¸€çš„çœŸç¥ï¼Œå½“ç„¶æ–¹æ³•å®ƒå¿…é¡»æ˜¯publicå…¬å¼€çš„ï¼Œä¸ç„¶è°éƒ½è®¿é—®ä¸äº†ã€‚ public class God &#123; private static final God god = new God();//è‡ªæœ‰æ°¸æœ‰çš„ç¥å•ä¾‹ private God()&#123;&#125;//æ„é€ æ–¹æ³•ç§æœ‰åŒ– public static God getInstance()&#123;//è¯·ç¥æ–¹æ³•å…¬å¼€åŒ– return god; &#125;&#125; ä»¥ä¸Šçš„ç¥ç±»é›å½¢å·²ç»å†™å¥½äº†ï¼Œå½“ç„¶ä½ è¿˜å¯ä»¥åŠ å…¶ä»–çš„åŠŸèƒ½æ–¹æ³•ï¼Œæ¯”å¦‚è¯´åˆ›ä¸–çºªç¥é€ äº†å…‰ï¼Œé€ äº†ä¸–ç•Œã€åŠ¨ç‰©ã€äººã€äºšå½“å¤å¨ƒç­‰ç­‰åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸åœ¨èµ˜è¿°äº†ã€‚é‚£å¯¹äºå¤–éƒ¨æ¥è¯´åªè¦è°ƒç”¨God.getInstance();å°±å¯ä»¥æ‹¿åˆ°ç¥äº†ï¼Œè€Œä¸”ä¸ç®¡è°æ‹¿ï¼Œæ‹¿å‡ æ¬¡ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªç¥ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•´ä¸ªç³»ç»Ÿä¸­ç¥çš„å”¯ä¸€æ€§ï¼Œä¸å¯ä¼ªé€ æ€§ï¼Œè‡³äºå…¶ä»–å…ˆçŸ¥é‚£ä¹Ÿåªæ˜¯ç¥çš„ä»£ç†äººï¼Œåªèƒ½å¸®è¯·ç¥è€Œå·²ã€‚ å¥½äº†ï¼Œå…¶å®æˆ‘ä»¬å·²ç»å­¦ä¼šäº†å•ä¾‹æ¨¡å¼çš„â€œç—´æ±‰æ¨¡å¼ï¼ˆEager loadï¼‰â€ï¼Œä»£ç ç¬¬ä¸€è¡Œä¸€å¼€å§‹å°±é€ å‡ºäº†ç¥ï¼ˆnew Godé‚£ä¸€å¥ï¼‰ï¼Œå·²ç»å‡†å¤‡å¥½äº†éšæ—¶ç»™ä½ è¯·ç¥ï¼Œè¿™æ ·å°±æœ‰äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ²¡äººè¯·ç¥é‚£ä¸æ˜¯ç™½é€ äº†ï¼Ÿæå‰å¤‡è´§å¦‚æœä»·æ ¼è·Œäº†ä¸æ˜¯å¾ˆæƒ¨ï¼Ÿååº”åœ¨ç³»ç»Ÿä¸­çš„é—®é¢˜å°±æ˜¯å ç”¨äº†å†…å­˜ç©ºé—´ã€‚äºæ˜¯åˆæœ‰äº†â€œæ‡’æ±‰æ¨¡å¼ï¼ˆLazy loadï¼‰â€ public class God &#123; private static God god;//è¿™é‡Œä¸è¿›è¡Œå®ä¾‹åŒ– private God()&#123;&#125; public static God getInstance() &#123; if (god == null) &#123;//å¦‚æœæ— ç¥æ‰é€ ç¥ god = new God(); &#125; return god; &#125;&#125; è¿™æˆ‘ä»¬çœ‹åˆ°ä¸€å¼€å§‹å°±æ²¡æœ‰é€ ç¥ï¼Œåªæœ‰æŸäººç¬¬ä¸€æ¬¡æ±‚ç¥æ—¶æ‰å®ä¾‹åŒ–ï¼Œä¹‹åå†æ±‚çš„å°±ç›´æ¥è¿”å›äº†ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯çœäº†ä¸€æ®µæ—¶é—´çš„å†…å­˜ï¼ˆæ— æ±‚ç¥æœŸé—´ï¼‰ï¼Œåå¤„æ˜¯ç¬¬ä¸€æ¬¡è¯·ç¥çš„æ—¶å€™é€Ÿåº¦ç›¸è¾ƒä¹‹å‰çš„ç—´æ±‰æ¨¡å¼ä¼šæ…¢ï¼Œå› ä¸ºè¦æ¶ˆè€—CPUå»é€ ç¥ã€‚ å…¶å®è¿™ä¹ˆå†™æ˜¯åœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹æ˜¯æœ‰é™·é˜±çš„ï¼Œè¯•æƒ³å¤šäººåŒæ—¶å¹¶å‘è¯·ç¥çš„è¯ï¼Œä¾ç„¶ä¼šé€ æˆå¤šç¥ï¼Œå¥½å§æˆ‘ä»¬å†æ¥æ”¹è‰¯ä¸€ä¸‹ï¼ŒæŠŠè¯·ç¥æ–¹æ³•åŠ ä¸Šsynchronizedï¼Œå£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼ŒæŸçº¿ç¨‹è°ƒç”¨å‰å¿…é¡»è·å–åŒæ­¥é”ï¼Œè°ƒç”¨å®Œåä¼šé‡Šæ”¾é”ç»™å…¶ä»–çº¿ç¨‹ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯·ç¥çš„å¿…é¡»æ’é˜Ÿï¼Œå¤§å®¶ä¸€ä¸ªä¸€ä¸ªæŒ‰é¡ºåºæ¥ã€‚ public class God &#123; private static God god;//è¿™é‡Œä¸è¿›è¡Œå®ä¾‹åŒ– private God()&#123;&#125; public static synchronized God getInstance() &#123;//æ­¤å¤„åŠ å…¥åŒæ­¥ if (god == null) &#123;//å¦‚æœæ— ç¥æ‰é€ ç¥ god = new God(); &#125; return god; &#125;&#125; ç„¶è€Œï¼Œè¿™æ ·åšæ˜¯è¦ä»˜å‡ºä»£ä»·çš„ï¼Œè¿˜æ²¡è¿›åº™å‘¢ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€è¯·ç¥çš„ç›´æ¥ç»™åŠ é”æ’é˜Ÿï¼Œç»“æœé˜Ÿä¼ä»åŒ—è¾¹çš„åº™æ’åˆ°äº†å—å¤©é—¨ï¼Œäººä»¬éƒ½è¦æ¥ä¸€ä¸ªä¸€ä¸ªæ‹œä½›æ±‚ç¥ï¼Œè¿™é€ æˆäº†å·¨å¤§æ—¶é—´æµªè´¹ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨CPUèµ„æºå¹¶å‘ä¼˜åŠ¿ï¼ˆç‰¹åˆ«æ˜¯å¤šæ ¸æƒ…å†µï¼‰ã€‚å¥½å§ï¼Œé‚£è¿˜æ˜¯è®©äººä»¬æŠ¢å¥½äº†ï¼Œä½†ä¾ç„¶å¾—ä¿è¯å•ä¾‹ç¥çš„æƒ…å†µä¸‹ã€‚ è¿™é‡Œæˆ‘ä»¬å»æ‰æ–¹æ³•ä¸Šçš„åŒæ­¥å…³é”®å­—ï¼Œæ¢åˆ°æ–¹æ³•ä½“å†…éƒ¨åšåŒæ­¥ï¼Œæ•´ä¸ªæ–¹æ³•å¼€æ”¾å¹¶å‘å¤§å®¶éƒ½å¯ä»¥åŒæ—¶å…¥åº™ï¼Œå½“ç„¶èµ·æ—©è´ªé»‘çš„è™”è¯šä¿¡å¾’ä»¬è¦æŠ¢å¤´é¦™æ˜¯å¿…é¡»è¦å…¥å ‚æ’é˜Ÿçš„ã€‚ä¸€æ—¦å¤´é¦™è¯ç”Ÿï¼Œé‚£å…¶ä»–æŠ¢é¦™çš„éƒ½ç™½æ—©èµ·ï¼Œç™½æ’é˜Ÿäº†ã€‚å†ä¹‹åçš„äº‹æƒ…æˆ‘ä»¬éƒ½å¯ä»¥é¢„è§äº†ï¼Œå¤´æ³¨é¦™è¢«æŠ¢åå ‚å†…æ’é˜Ÿå†æ— å¿…è¦æ¥äº†ï¼Œå¤§å®¶å¯ä»¥åœ¨å ‚å¤–åŒæ—¶å¹¶å‘æ‹œä½›æ±‚ç¥ï¼Œè¿™å°±æå¤§çš„åˆ©ç”¨äº†CPUèµ„æºã€‚ç®€è€Œè¨€ä¹‹ï¼šåªæœ‰ç¬¬ä¸€æ‰¹æŠ¢å¤´é¦™çš„åœ¨æ’é˜Ÿï¼Œä¹‹åå¤§å®¶éƒ½ä¸å¿…æ’é˜Ÿäº†ï¼Œä»£ç å¦‚ä¸‹ã€‚ public class God &#123; private volatile static God god; private God()&#123;&#125; public static God getInstance() &#123;//åº™æ˜¯å¼€æ”¾çš„ä¸ç”¨æ’é˜Ÿè¿›å…¥ if (god == null) &#123;//å¦‚æœå¤´æŸ±é¦™æœªäº§ç”Ÿï¼Œè¿™æ‰¹æŠ¢é¦™äººè¿›å…¥å ‚å†…æ’é˜Ÿã€‚ synchronized(God.class)&#123; if (god == null) &#123;//åªæœ‰å¤´é¦™é€ äº†ç¥ï¼Œå…¶ä»–æŠ¢é¦™çš„ç™½æ’é˜Ÿäº† god = new God(); &#125; &#125; &#125; //æ­¤å¤„å¤´æŸ±é¦™äº§ç”Ÿåä¸å¿…å†æ’é˜Ÿ return god; &#125;&#125; å…¶å®åœ¨è¿™ä¹‹ä¸Šè¿˜å‘å±•å‡ºäº†å„ç§å„æ ·çš„å•ä¾‹æ¨¡å¼å˜ç§ï¼Œæˆ‘ä»¬è¿™é‡Œåªè®²äº†æœ€åŸºç¡€çš„ä¸¤ç§ï¼Œå…¶å®ä»–ä»¬éƒ½å„æœ‰ä¼˜ç¼ºï¼Œæˆ‘ä»¬è¦åšåˆ°çµæ´»è¿ç”¨ï¼Œå„å–æ‰€éœ€ã€‚å¯¹äºæˆ‘ä¸ªäººæ¥è®²å€¾å‘äºç—´æ±‰æ¨¡å¼ï¼Œç°åœ¨å†…å­˜æˆæœ¬æ ¹æœ¬ä¸ç®—é—®é¢˜ï¼Œå†µä¸”è¿Ÿæ—©è¦è¢«å®ä¾‹åŒ–å ç”¨å†…å­˜ï¼ŒåŠ é”è§£é”æ›´æ˜¯ä¸€ç§æµªè´¹ï¼Œè¿˜æœ‰åŒæ­¥æ•ˆç‡ä½ç­‰é—®é¢˜ï¼Œå¦‚æœä¸Šå¸ä¸æ˜¯å¾ˆå ç©ºé—´é‚£å°±æ²¡å¿…è¦å»æ‡’æ±‰å»¶è¿ŸåŠ è½½ï¼Œè¶Šå¤æ‚é—®é¢˜è¶Šå¤šï¼Œé£é™©è¶Šå¤§ã€‚ å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°æ–¹å¼æ‡’æ±‰å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šå¦ å®ç°éš¾åº¦ï¼šæ˜“ æè¿°ï¼šè¿™ç§æ–¹å¼æ˜¯æœ€åŸºæœ¬çš„å®ç°æ–¹å¼ï¼Œè¿™ç§å®ç°æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹ã€‚å› ä¸ºæ²¡æœ‰åŠ é” synchronizedï¼Œæ‰€ä»¥ä¸¥æ ¼æ„ä¹‰ä¸Šå®ƒå¹¶ä¸ç®—å•ä¾‹æ¨¡å¼ã€‚è¿™ç§æ–¹å¼ lazy loading å¾ˆæ˜æ˜¾ï¼Œä¸è¦æ±‚çº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¤šçº¿ç¨‹ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚ å®ä¾‹ï¼š public class Singleton &#123; private static Singleton instance; private Singleton ()&#123;&#125; public static Singleton getInstance() &#123; if (instance == null) &#123; instance = new Singleton(); &#125; return instance; &#125; &#125; æ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šæ˜“ æè¿°ï¼šè¿™ç§æ–¹å¼å…·å¤‡å¾ˆå¥½çš„ lazy loadingï¼Œèƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ä¸­å¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯ï¼Œæ•ˆç‡å¾ˆä½ï¼Œ99% æƒ…å†µä¸‹ä¸éœ€è¦åŒæ­¥ã€‚ä¼˜ç‚¹ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ‰åˆå§‹åŒ–ï¼Œé¿å…å†…å­˜æµªè´¹ã€‚ç¼ºç‚¹ï¼šå¿…é¡»åŠ é” synchronized æ‰èƒ½ä¿è¯å•ä¾‹ï¼Œä½†åŠ é”ä¼šå½±å“æ•ˆç‡ã€‚getInstance() çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºä¸æ˜¯å¾ˆå…³é”®ï¼ˆè¯¥æ–¹æ³•ä½¿ç”¨ä¸å¤ªé¢‘ç¹ï¼‰ã€‚ å®ä¾‹ï¼š public class Singleton &#123; private static Singleton instance; private Singleton ()&#123;&#125; public static synchronized Singleton getInstance() &#123; if (instance == null) &#123; instance = new Singleton(); &#125; return instance; &#125; &#125; é¥¿æ±‰å¼æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šå¦ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šæ˜“ æè¿°ï¼šè¿™ç§æ–¹å¼æ¯”è¾ƒå¸¸ç”¨ï¼Œä½†å®¹æ˜“äº§ç”Ÿåƒåœ¾å¯¹è±¡ã€‚ä¼˜ç‚¹ï¼šæ²¡æœ‰åŠ é”ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šæé«˜ã€‚ç¼ºç‚¹ï¼šç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œæµªè´¹å†…å­˜ã€‚å®ƒåŸºäº classloader æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ï¼Œä¸è¿‡ï¼Œinstance åœ¨ç±»è£…è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œè™½ç„¶å¯¼è‡´ç±»è£…è½½çš„åŸå› æœ‰å¾ˆå¤šç§ï¼Œåœ¨å•ä¾‹æ¨¡å¼ä¸­å¤§å¤šæ•°éƒ½æ˜¯è°ƒç”¨ getInstance æ–¹æ³•ï¼Œ ä½†æ˜¯ä¹Ÿä¸èƒ½ç¡®å®šæœ‰å…¶ä»–çš„æ–¹å¼ï¼ˆæˆ–è€…å…¶ä»–çš„é™æ€æ–¹æ³•ï¼‰å¯¼è‡´ç±»è£…è½½ï¼Œè¿™æ—¶å€™åˆå§‹åŒ– instance æ˜¾ç„¶æ²¡æœ‰è¾¾åˆ° lazy loading çš„æ•ˆæœã€‚ å®ä¾‹ï¼š public class Singleton &#123; private static Singleton instance = new Singleton(); private Singleton ()&#123;&#125; public static Singleton getInstance() &#123; return instance; &#125; &#125; åŒæ£€é”/åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³ double-checked lockingï¼‰JDK ç‰ˆæœ¬ï¼šJDK1.5 èµ· æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šè¾ƒå¤æ‚ æè¿°ï¼šè¿™ç§æ–¹å¼é‡‡ç”¨åŒé”æœºåˆ¶ï¼Œå®‰å…¨ä¸”åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹èƒ½ä¿æŒé«˜æ€§èƒ½ã€‚getInstance() çš„æ€§èƒ½å¯¹åº”ç”¨ç¨‹åºå¾ˆå…³é”®ã€‚ å®ä¾‹ï¼š public class Singleton &#123; private volatile static Singleton singleton; private Singleton ()&#123;&#125; public static Singleton getSingleton() &#123; if (singleton == null) &#123; synchronized (Singleton.class) &#123; if (singleton == null) &#123; singleton = new Singleton(); &#125; &#125; &#125; return singleton; &#125; &#125; ç™»è®°å¼/é™æ€å†…éƒ¨ç±»æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šæ˜¯ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šä¸€èˆ¬ æè¿°ï¼šè¿™ç§æ–¹å¼èƒ½è¾¾åˆ°åŒæ£€é”æ–¹å¼ä¸€æ ·çš„åŠŸæ•ˆï¼Œä½†å®ç°æ›´ç®€å•ã€‚å¯¹é™æ€åŸŸä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåº”ä½¿ç”¨è¿™ç§æ–¹å¼è€Œä¸æ˜¯åŒæ£€é”æ–¹å¼ã€‚è¿™ç§æ–¹å¼åªé€‚ç”¨äºé™æ€åŸŸçš„æƒ…å†µï¼ŒåŒæ£€é”æ–¹å¼å¯åœ¨å®ä¾‹åŸŸéœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æ—¶ä½¿ç”¨ã€‚è¿™ç§æ–¹å¼åŒæ ·åˆ©ç”¨äº† classloader æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ– instance æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒè·Ÿç¬¬ 3 ç§æ–¹å¼ä¸åŒçš„æ˜¯ï¼šç¬¬ 3 ç§æ–¹å¼åªè¦ Singleton ç±»è¢«è£…è½½äº†ï¼Œé‚£ä¹ˆ instance å°±ä¼šè¢«å®ä¾‹åŒ–ï¼ˆæ²¡æœ‰è¾¾åˆ° lazy loading æ•ˆæœï¼‰ï¼Œè€Œè¿™ç§æ–¹å¼æ˜¯ Singleton ç±»è¢«è£…è½½äº†ï¼Œinstance ä¸ä¸€å®šè¢«åˆå§‹åŒ–ã€‚å› ä¸º SingletonHolder ç±»æ²¡æœ‰è¢«ä¸»åŠ¨ä½¿ç”¨ï¼Œåªæœ‰é€šè¿‡æ˜¾å¼è°ƒç”¨ getInstance æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ˜¾å¼è£…è½½ SingletonHolder ç±»ï¼Œä»è€Œå®ä¾‹åŒ– instanceã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœå®ä¾‹åŒ– instance å¾ˆæ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥æƒ³è®©å®ƒå»¶è¿ŸåŠ è½½ï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œåˆä¸å¸Œæœ›åœ¨ Singleton ç±»åŠ è½½æ—¶å°±å®ä¾‹åŒ–ï¼Œå› ä¸ºä¸èƒ½ç¡®ä¿ Singleton ç±»è¿˜å¯èƒ½åœ¨å…¶ä»–çš„åœ°æ–¹è¢«ä¸»åŠ¨ä½¿ç”¨ä»è€Œè¢«åŠ è½½ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®ä¾‹åŒ– instance æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿™ç§æ–¹å¼ç›¸æ¯”ç¬¬ 3 ç§æ–¹å¼å°±æ˜¾å¾—å¾ˆåˆç†ã€‚ å®ä¾‹ï¼š public class Singleton &#123; private static class SingletonHolder &#123; private static final Singleton INSTANCE = new Singleton(); &#125; private Singleton ()&#123;&#125; public static final Singleton getInstance() &#123; return SingletonHolder.INSTANCE; &#125; &#125; æšä¸¾JDK ç‰ˆæœ¬ï¼šJDK1.5 èµ· æ˜¯å¦ Lazy åˆå§‹åŒ–ï¼šå¦ æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ï¼šæ˜¯ å®ç°éš¾åº¦ï¼šæ˜“ æè¿°ï¼šè¿™ç§å®ç°æ–¹å¼è¿˜æ²¡æœ‰è¢«å¹¿æ³›é‡‡ç”¨ï¼Œä½†è¿™æ˜¯å®ç°å•ä¾‹æ¨¡å¼çš„æœ€ä½³æ–¹æ³•ã€‚å®ƒæ›´ç®€æ´ï¼Œè‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ã€‚è¿™ç§æ–¹å¼æ˜¯ Effective Java ä½œè€… Josh Bloch æå€¡çš„æ–¹å¼ï¼Œå®ƒä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè€Œä¸”è¿˜è‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œé˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ã€‚ä¸è¿‡ï¼Œç”±äº JDK1.5 ä¹‹åæ‰åŠ å…¥ enum ç‰¹æ€§ï¼Œç”¨è¿™ç§æ–¹å¼å†™ä¸å…è®©äººæ„Ÿè§‰ç”Ÿç–ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œä¹Ÿå¾ˆå°‘ç”¨ã€‚ä¸èƒ½é€šè¿‡ reflection attack æ¥è°ƒç”¨ç§æœ‰æ„é€ æ–¹æ³•ã€‚ å®ä¾‹ï¼š public enum Singleton &#123; INSTANCE; public void whateverMethod() &#123; &#125; &#125; ç»éªŒä¹‹è°ˆï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ç¬¬ 1 ç§å’Œç¬¬ 2 ç§æ‡’æ±‰æ–¹å¼ï¼Œå»ºè®®ä½¿ç”¨ç¬¬ 3 ç§é¥¿æ±‰æ–¹å¼ã€‚åªæœ‰åœ¨è¦æ˜ç¡®å®ç° lazy loading æ•ˆæœæ—¶ï¼Œæ‰ä¼šä½¿ç”¨ç¬¬ 5 ç§ç™»è®°æ–¹å¼ã€‚å¦‚æœæ¶‰åŠåˆ°ååºåˆ—åŒ–åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ç¬¬ 6 ç§æšä¸¾æ–¹å¼ã€‚å¦‚æœæœ‰å…¶ä»–ç‰¹æ®Šçš„éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç¬¬ 4 ç§åŒæ£€é”æ–¹å¼ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"Javaè®¾è®¡æ¨¡å¼ä¹‹åŸå‹æ¨¡å¼","date":"2019-02-14T07:33:50.000Z","path":"2019/02/14/44e9b870.html","text":"è®¾è®¡æ¨¡å¼ç›¸å…³æ–‡ç« ï¼Œç”¨äºæ•´ç†ç½‘ç»œä¸­å¯¹åº”çš„è®¾è®¡æ¨¡å¼çš„ä¸€äº›è§£è¯»ã€‚ åŸå‹æ¨¡å¼åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æ˜¯ç”¨äºåˆ›å»ºé‡å¤çš„å¯¹è±¡ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ€§èƒ½ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚ è¿™ç§æ¨¡å¼æ˜¯å®ç°äº†ä¸€ä¸ªåŸå‹æ¥å£ï¼Œè¯¥æ¥å£ç”¨äºåˆ›å»ºå½“å‰å¯¹è±¡çš„å…‹éš†ã€‚å½“ç›´æ¥åˆ›å»ºå¯¹è±¡çš„ä»£ä»·æ¯”è¾ƒå¤§æ—¶ï¼Œåˆ™é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¯¹è±¡éœ€è¦åœ¨ä¸€ä¸ªé«˜ä»£ä»·çš„æ•°æ®åº“æ“ä½œä¹‹åè¢«åˆ›å»ºã€‚æˆ‘ä»¬å¯ä»¥ç¼“å­˜è¯¥å¯¹è±¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶è¿”å›å®ƒçš„å…‹éš†ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ›´æ–°æ•°æ®åº“ï¼Œä»¥æ­¤æ¥å‡å°‘æ•°æ®åº“è°ƒç”¨ã€‚ ä»‹ç»æ„å›¾ï¼šç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ ä¸»è¦è§£å†³ï¼šåœ¨è¿è¡ŒæœŸå»ºç«‹å’Œåˆ é™¤åŸå‹ã€‚ ä½•æ—¶ä½¿ç”¨ï¼š 1ã€å½“ä¸€ä¸ªç³»ç»Ÿåº”è¯¥ç‹¬ç«‹äºå®ƒçš„äº§å“åˆ›å»ºï¼Œæ„æˆå’Œè¡¨ç¤ºæ—¶ã€‚ 2ã€å½“è¦å®ä¾‹åŒ–çš„ç±»æ˜¯åœ¨è¿è¡Œæ—¶åˆ»æŒ‡å®šæ—¶ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡åŠ¨æ€è£…è½½ã€‚ 3ã€ä¸ºäº†é¿å…åˆ›å»ºä¸€ä¸ªä¸äº§å“ç±»å±‚æ¬¡å¹³è¡Œçš„å·¥å‚ç±»å±‚æ¬¡æ—¶ã€‚ 4ã€å½“ä¸€ä¸ªç±»çš„å®ä¾‹åªèƒ½æœ‰å‡ ä¸ªä¸åŒçŠ¶æ€ç»„åˆä¸­çš„ä¸€ç§æ—¶ã€‚å»ºç«‹ç›¸åº”æ•°ç›®çš„åŸå‹å¹¶å…‹éš†å®ƒä»¬å¯èƒ½æ¯”æ¯æ¬¡ç”¨åˆé€‚çš„çŠ¶æ€æ‰‹å·¥å®ä¾‹åŒ–è¯¥ç±»æ›´æ–¹ä¾¿ä¸€äº›ã€‚ å¦‚ä½•è§£å†³ï¼šåˆ©ç”¨å·²æœ‰çš„ä¸€ä¸ªåŸå‹å¯¹è±¡ï¼Œå¿«é€Ÿåœ°ç”Ÿæˆå’ŒåŸå‹å¯¹è±¡ä¸€æ ·çš„å®ä¾‹ã€‚ å…³é”®ä»£ç ï¼š 1ã€å®ç°å…‹éš†æ“ä½œï¼Œåœ¨ JAVA ç»§æ‰¿ Cloneableï¼Œé‡å†™ clone()ï¼Œåœ¨ .NET ä¸­å¯ä»¥ä½¿ç”¨ Object ç±»çš„ MemberwiseClone() æ–¹æ³•æ¥å®ç°å¯¹è±¡çš„æµ…æ‹·è´æˆ–é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼æ¥å®ç°æ·±æ‹·è´ã€‚ 2ã€åŸå‹æ¨¡å¼åŒæ ·ç”¨äºéš”ç¦»ç±»å¯¹è±¡çš„ä½¿ç”¨è€…å’Œå…·ä½“ç±»å‹ï¼ˆæ˜“å˜ç±»ï¼‰ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œå®ƒåŒæ ·è¦æ±‚è¿™äº›â€æ˜“å˜ç±»â€æ‹¥æœ‰ç¨³å®šçš„æ¥å£ã€‚ åº”ç”¨å®ä¾‹ï¼š 1ã€ç»†èƒåˆ†è£‚ã€‚ 2ã€JAVA ä¸­çš„ Object clone() æ–¹æ³•ã€‚ ä¼˜ç‚¹ï¼š 1ã€æ€§èƒ½æé«˜ã€‚ 2ã€é€ƒé¿æ„é€ å‡½æ•°çš„çº¦æŸã€‚ ç¼ºç‚¹ï¼š 1ã€é…å¤‡å…‹éš†æ–¹æ³•éœ€è¦å¯¹ç±»çš„åŠŸèƒ½è¿›è¡Œé€šç›˜è€ƒè™‘ï¼Œè¿™å¯¹äºå…¨æ–°çš„ç±»ä¸æ˜¯å¾ˆéš¾ï¼Œä½†å¯¹äºå·²æœ‰çš„ç±»ä¸ä¸€å®šå¾ˆå®¹æ˜“ï¼Œç‰¹åˆ«å½“ä¸€ä¸ªç±»å¼•ç”¨ä¸æ”¯æŒä¸²è¡ŒåŒ–çš„é—´æ¥å¯¹è±¡ï¼Œæˆ–è€…å¼•ç”¨å«æœ‰å¾ªç¯ç»“æ„çš„æ—¶å€™ã€‚ 2ã€å¿…é¡»å®ç° Cloneable æ¥å£ã€‚ ä½¿ç”¨åœºæ™¯ï¼š 1ã€èµ„æºä¼˜åŒ–åœºæ™¯ã€‚ 2ã€ç±»åˆå§‹åŒ–éœ€è¦æ¶ˆåŒ–éå¸¸å¤šçš„èµ„æºï¼Œè¿™ä¸ªèµ„æºåŒ…æ‹¬æ•°æ®ã€ç¡¬ä»¶èµ„æºç­‰ã€‚ 3ã€æ€§èƒ½å’Œå®‰å…¨è¦æ±‚çš„åœºæ™¯ã€‚ 4ã€é€šè¿‡ new äº§ç”Ÿä¸€ä¸ªå¯¹è±¡éœ€è¦éå¸¸ç¹ççš„æ•°æ®å‡†å¤‡æˆ–è®¿é—®æƒé™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼ã€‚ 5ã€ä¸€ä¸ªå¯¹è±¡å¤šä¸ªä¿®æ”¹è€…çš„åœºæ™¯ã€‚ 6ã€ä¸€ä¸ªå¯¹è±¡éœ€è¦æä¾›ç»™å…¶ä»–å¯¹è±¡è®¿é—®ï¼Œè€Œä¸”å„ä¸ªè°ƒç”¨è€…å¯èƒ½éƒ½éœ€è¦ä¿®æ”¹å…¶å€¼æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åŸå‹æ¨¡å¼æ‹·è´å¤šä¸ªå¯¹è±¡ä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚ 7ã€åœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒåŸå‹æ¨¡å¼å¾ˆå°‘å•ç‹¬å‡ºç°ï¼Œä¸€èˆ¬æ˜¯å’Œå·¥å‚æ–¹æ³•æ¨¡å¼ä¸€èµ·å‡ºç°ï¼Œé€šè¿‡ clone çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åç”±å·¥å‚æ–¹æ³•æä¾›ç»™è°ƒç”¨è€…ã€‚åŸå‹æ¨¡å¼å·²ç»ä¸ Java èä¸ºæµ‘ç„¶ä¸€ä½“ï¼Œå¤§å®¶å¯ä»¥éšæ‰‹æ‹¿æ¥ä½¿ç”¨ã€‚ æ³¨æ„äº‹é¡¹ï¼šä¸é€šè¿‡å¯¹ä¸€ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–æ¥æ„é€ æ–°å¯¹è±¡ä¸åŒçš„æ˜¯ï¼ŒåŸå‹æ¨¡å¼æ˜¯é€šè¿‡æ‹·è´ä¸€ä¸ªç°æœ‰å¯¹è±¡ç”Ÿæˆæ–°å¯¹è±¡çš„ã€‚æµ…æ‹·è´å®ç° Cloneableï¼Œé‡å†™ï¼Œæ·±æ‹·è´æ˜¯é€šè¿‡å®ç° Serializable è¯»å–äºŒè¿›åˆ¶æµã€‚ å®ä¾‹ ä»¥ä¸‹å®ä¾‹æ¥æºäºå¾®ä¿¡å…¬ä¼—å·ï¼ˆJavaçŸ¥éŸ³ï¼‰æ–‡ç« ï¼Œè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆåŸå‹ï¼‰ å‡è®¾æˆ‘ä»¬è¦åšä¸€ä¸ªæ‰“é£æœºæ¸¸æˆï¼Œæ¸¸æˆè®¾å®šä½çºµç‰ˆç§»åŠ¨ï¼Œå•æ‰“ã€‚ æ—¢ç„¶æ˜¯å•æ‰“ï¼Œé‚£æˆ‘ä»¬çš„ä¸»è§’é£æœºå½“ç„¶åªæœ‰ä¸€æ¶ï¼Œäºæ˜¯æˆ‘ä»¬å†™ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œæ­¤å¤„æˆ‘ä»¬çœç•¥ä¸»è§’ä»£ç ã€‚é‚£ä¹ˆæ•Œæœºå‘¢ï¼Ÿå½“ç„¶æœ‰å¾ˆå¤šæ¶äº†ï¼Œå¥½ï¼Œä¸ºäº†è¯´æ˜é—®é¢˜æˆ‘ä»¬å»ç¹å°±ç®€ï¼Œå…ˆå†™ä¸€ä¸ªæ•Œæœºç±»ã€‚ public class EnemyPlane &#123; private int x;//æ•Œæœºæ¨ªåæ ‡ private int y = 0;//æ•Œæœºçºµåæ ‡ public EnemyPlane(int x) &#123;//æ„é€ å™¨ this.x = x; &#125; public int getX() &#123; return x; &#125; public int getY() &#123; return y; &#125; public void fly()&#123;//è®©æ•Œæœºé£ y++;//æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œæ•Œæœºé£è¡Œæ—¶çºµåæ ‡ï¼‹1 &#125;&#125; ä»£ç public EnemyPlane(int x) &#123;//æ„é€ å™¨....å¼€å§‹ï¼Œåˆå§‹åŒ–åªæ¥æ”¶xåæ ‡ï¼Œå› ä¸ºæ•Œæœºä¸€å¼€å§‹æ˜¯ä»é¡¶éƒ¨å‡ºæ¥æ‰€ä»¥çºµåæ ‡yå¿…ç„¶æ˜¯0ã€‚æ­¤ç±»åªæä¾›getterè€Œæ²¡æœ‰setterï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½åœ¨åˆå§‹åŒ–æ—¶ç¡®å®šæ•Œæœºçš„æ¨ªåæ ‡xï¼Œåç»­æ˜¯ä¸éœ€è¦æ›´æ”¹åæ ‡äº†ï¼Œåªè¦è¿ç»­è°ƒç”¨ç¬¬17è¡Œçš„flyæ–¹æ³•å³å¯è®©é£æœºè·Ÿé›¨ç‚¹ä¸€æ ·å¾€ä¸‹ç ¸ã€‚ å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹ç»˜åˆ¶æ•ŒæœºåŠ¨ç”»äº†ï¼Œå…ˆå®ä¾‹åŒ–å‡º50æ¶å§ã€‚ public class Client &#123; public static void main(String[] args) &#123; List&lt;EnemyPlane&gt; enemyPlanes = new ArrayList&lt;EnemyPlane&gt;(); for (int i = 0; i &lt; 50; i++) &#123; //æ­¤å¤„éšæœºä½ç½®äº§ç”Ÿæ•Œæœº EnemyPlane ep = new EnemyPlane(new Random().nextInt(200)); enemyPlanes.add(ep); &#125; &#125;&#125; æ³¨æ„ä»£ç EnemyPlane ep = new EnemyPlane(new Random().nextInt(200));ï¼Œè§‰ä¸è§‰å¾—æ¯ä¸ªè¿­ä»£éƒ½å®ä¾‹åŒ–newå‡ºä¸€ä¸ªå¯¹è±¡å­˜åœ¨æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™ä¸ªå®ä¾‹åŒ–çš„è¿‡ç¨‹æ˜¯å¾—ä¸å¿å¤±çš„ï¼Œæ„é€ æ–¹æ³•ä¼šè¢«è°ƒç”¨50æ¬¡ï¼Œcpuè¢«æå¤§æµªè´¹äº†ï¼Œå†…å­˜è¢«æå¤§æµªè´¹äº†ï¼Œå°¤å…¶å¯¹äºæ¸¸æˆæ¥è¯´æ€§èƒ½ç“¶é¢ˆç»å¯¹æ˜¯å¤§å¿Œï¼Œè¿™ä¼šé€ æˆç”¨æˆ·ä½“éªŒé—®é¢˜ï¼Œè°ä¹Ÿä¸å¸Œæœ›ç©æ¸¸æˆä¼šå¡å¸§å§ã€‚ é‚£åˆ°åº•ä»€ä¹ˆæ—¶å€™å»newï¼Ÿæ¸¸æˆåœºæ™¯åˆå§‹åŒ–å°±newæ•Œæœºï¼ˆå¦‚ä»¥ä¸Šä»£ç ï¼‰ï¼Ÿè¿™å…³ä¼šå‡ºç°500ä¸ªæ•Œæœºé‚£æˆ‘ä»¬ä¸€æ¬¡éƒ½newå‡ºæ¥å§ï¼Ÿæµªè´¹å†…å­˜ï¼é‚£æˆ‘ä»¬å®æ—¶çš„å»newï¼Œæ¯åˆ°ä¸€ä¸ªåœ°æ–¹æ‰newå‡ºæ¥ä¸€ä¸ªï¼æµªè´¹CPUï¼å¦‚æœæ•Œæœºçº¿ç¨‹è¿‡å¤šé€ æˆCPUèµ„æºè€—å°½ï¼Œæ¯å‡ºä¸€ä¸ªæ•Œæœºæ¸¸æˆä¼šå¡ä¸€ä¸‹ï¼Œè¯•æƒ³ä¸€ä¸‹è¿™ç§æç«¯æƒ…å†µä¸‹ï¼Œæ¸¸æˆå¯¹è±¡å®ä¾‹å¾ˆå¤šçš„è¯å°±æ˜¯åœ¨ä½œæ­»ã€‚ è§£å†³æ–¹æ¡ˆåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¥½ï¼ŒåŸå‹æ¨¡å¼Prototypeï¼ä¸Šä»£ç ï¼æˆ‘ä»¬æŠŠä¸Šé¢çš„æ•Œæœºç±»æ”¹é€ ä¸€ä¸‹ï¼Œè®©å®ƒæ”¯æŒåŸå‹æ‹·è´ã€‚ public class EnemyPlane implements Cloneable&#123;//æ­¤å¤„å®ç°å…‹éš†æ¥å£ private int x;//æ•Œæœºæ¨ªåæ ‡ private int y = 0;//æ•Œæœºçºµåæ ‡ public EnemyPlane(int x) &#123;//æ„é€ å™¨ this.x = x; &#125; public int getX() &#123; return x; &#125; public int getY() &#123; return y; &#125; public void fly()&#123;//è®©æ•Œæœºé£ y++;//æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œæ•Œæœºé£è¡Œæ—¶çºµåæ ‡ï¼‹1 &#125; //æ­¤å¤„å¼€æ”¾setXï¼Œä¸ºäº†è®©å…‹éš†åçš„å®ä¾‹é‡æ–°ä¿®æ”¹xåæ ‡ public void setX(int x) &#123; this.x = x; &#125; //ä¸ºäº†ä¿è¯é£æœºé£è¡Œçš„è¿è´¯æ€§ //è¿™é‡Œæˆ‘ä»¬å…³é—­setYæ–¹æ³•ï¼Œä¸æ”¯æŒéšæ„æ›´æ”¹Yçºµåæ ‡// public void setY(int y) &#123;// this.y = y;// &#125; //é‡å†™å…‹éš†æ–¹æ³• @Override public EnemyPlane clone() throws CloneNotSupportedException &#123; return (EnemyPlane)super.clone(); &#125;&#125; setX()æ–¹æ³•ä¸ºäº†ä¿è¯å…‹éš†é£æœºçš„ä¸ªæ€§åŒ–ï¼Œå› ä¸ºå®ƒä»¬å‡ºç°çš„ä½ç½®æ˜¯ä¸åŒçš„ã€‚å…‹éš†æ–¹æ³•é‡å†™æˆ‘ä»¬è°ƒç”¨äº†çˆ¶ç±»Objectçš„å…‹éš†æ–¹æ³•ï¼Œè¿™é‡ŒJVMä¼šè¿›è¡Œå†…å­˜æ“ä½œç›´æ¥æ‹·è´åŸå§‹æ•°æ®æµï¼Œç®€å•ç²—æš´ï¼Œä¸ä¼šæœ‰å…¶ä»–æ›´å¤šçš„å¤æ‚æ“ä½œï¼ˆç±»åŠ è½½ï¼Œå®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–ç­‰ç­‰ï¼‰ï¼Œé€Ÿåº¦è¿œè¿œå¿«äºå®ä¾‹åŒ–æ“ä½œã€‚OKï¼Œæˆ‘ä»¬çœ‹æ€ä¹ˆå…‹éš†è¿™äº›æ•Œæœºï¼Œåšä¸€ä¸ªé€ é£æœºçš„å·¥å‚å§ã€‚ public class EnemyPlaneFactory &#123; //æ­¤å¤„ç”¨ç—´æ±‰æ¨¡å¼é€ ä¸€ä¸ªæ•ŒæœºåŸå‹ private static EnemyPlane protoType = new EnemyPlane(200); //è·å–æ•Œæœºå…‹éš†å®ä¾‹ public static EnemyPlane getInstance(int x)&#123; EnemyPlane clone = protoType.clone();//å¤åˆ¶åŸå‹æœº clone.setX(x);//é‡æ–°è®¾ç½®å…‹éš†æœºçš„xåæ ‡ return clone; &#125;&#125; æ­¤å¤„æˆ‘ä»¬çœå»æŠ“å¼‚å¸¸ï¼Œéšåçš„äº‹æƒ…å°±éå¸¸ç®€å•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å¾ˆç®€å•åœ°è°ƒç”¨EnemyPlaneFactory.getInstance(int x)å¹¶å£°æ˜xåæ ‡ä½ç½®ï¼Œä¸€æ¶æ•Œæœºå¾ˆå¿«åœ°å°±åšå¥½äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¿è¯æ˜¯åœ¨æ•Œæœºå‡ºç°çš„æ—¶å€™å†å»å…‹éš†ï¼Œç¡®ä¿ä¸è¦ä¸€å¼€å±€å°±å…¨éƒ¨å…‹éš†å‡ºæ¥ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ—¢ä¿è¯äº†å®æ—¶æ€§èŠ‚çœäº†å†…å­˜ç©ºé—´ï¼Œåˆä¿è¯äº†æ•Œæœºå®ä¾‹åŒ–çš„é€Ÿåº¦ï¼Œæ¸¸æˆç»ä¸ä¼šå¡å¸§ï¼ æœ€åï¼Œè¿˜è¦å¼ºè°ƒä¸€ç‚¹å°±æ˜¯æµ…æ‹·è´å’Œæ·±æ‹·è´çš„é—®é¢˜ã€‚å‡å¦‚æˆ‘ä»¬çš„æ•Œæœºç±»é‡Œæœ‰ä¸€é¢—å­å¼¹bulletå¯ä»¥å°„å‡»æˆ‘ä»¬çš„ä¸»è§’ï¼Œå¦‚ä¸‹ã€‚ public class EnemyPlane implements Cloneable&#123; private Bullet bullet = new Bullet(); private int x;//æ•Œæœºæ¨ªåæ ‡ private int y = 0;//æ•Œæœºçºµåæ ‡ //ä¹‹åä»£ç çœç•¥â€¦â€¦&#125; æˆ‘ä»¬éƒ½çŸ¥é“Javaä¸­çš„å˜é‡åˆ†ä¸ºåŸå§‹ç±»å‹å’Œå¼•ç”¨ç±»å‹ï¼Œæ‰€è°“æµ…æ‹·è´åªæ˜¯æ‹·è´åŸå§‹ç±»å‹çš„æŒ‡ï¼Œæ¯”å¦‚åæ ‡x, yçš„æŒ‡ä¼šè¢«æ‹·è´åˆ°å…‹éš†å¯¹è±¡ä¸­ï¼Œå¯¹äºå¯¹è±¡bulletä¹Ÿä¼šè¢«æ‹·è´ï¼Œä½†æ˜¯è¯·æ³¨æ„æ‹·è´çš„åªæ˜¯åœ°å€è€Œå·²ï¼Œé‚£ä¹ˆå¤šä¸ªåœ°å€å…¶å®çœŸæ­£æŒ‡å‘çš„å¯¹è±¡è¿˜æ˜¯åŒä¸€ä¸ªbulletã€‚ ç”±äºæˆ‘ä»¬è°ƒç”¨çˆ¶ç±»Objectçš„cloneæ–¹æ³•è¿›è¡Œçš„æ˜¯æµ…æ‹·è´ï¼Œæ‰€ä»¥æ­¤å¤„çš„bulletå¹¶æ²¡æœ‰è¢«å…‹éš†æˆåŠŸï¼Œæ¯”å¦‚æˆ‘ä»¬æ¯æ¶æ•Œæœºå¿…é¡»æºå¸¦çš„å­å¼¹æ˜¯ä¸åŒçš„å®ä¾‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»è¿›è¡Œæ·±æ‹·è´ï¼Œäºæ˜¯æˆ‘ä»¬çš„ä»£ç å°±å¾—åšè¿™æ ·çš„æ”¹åŠ¨ã€‚ public class EnemyPlane implements Cloneable&#123; private Bullet bullet = new Bullet(); public void setBullet(Bullet bullet) &#123; this.bullet = bullet; &#125; @Override protected EnemyPlane clone() throws CloneNotSupportedException &#123; // å…ˆå…‹éš†å‡ºæ•Œæœºï¼Œå…¶ä¸­å­å¼¹è¿˜æœªè¿›è¡Œå…‹éš†ã€‚ EnemyPlane clonePlane = (EnemyPlane) super.clone(); // å¯¹å­å¼¹è¿›è¡Œæ·±æ‹·è´ clonePlane.setBullet(this.bullet.clone()); return clonePlane; &#125; //ä¹‹åä»£ç çœç•¥â€¦â€¦&#125; ç›¸ä¿¡å¤§å®¶çœ‹æ³¨é‡Šå°±èƒ½æ‡‚äº†ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šè§£é‡Šï¼Œå½“ç„¶å¯¹äºBulletç±»ä¹ŸåŒæ ·å®ç°äº†å…‹éš†æ¥å£ï¼Œä»£ç ä¸ç”¨å†å†™äº†å§ï¼Ÿç›¸ä¿¡å¤§å®¶éƒ½å­¦ä¼šäº†ä¸¾ä¸€åä¸‰ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æ¯ä¸ªæ•Œæœºæºå¸¦çš„å¼¹è¯ä¹ŸåŒæ ·è¢«å…‹éš†å®Œæ¯•äº†ï¼Œå†ä¹Ÿä¸å¿…æ‹…å¿ƒæ¸¸æˆçš„æµç•…æ€§äº†ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"JDK8ç‰¹æ€§ä¸€è§ˆ","date":"2019-01-22T08:02:21.000Z","path":"2019/01/22/1abc3648.html","text":"è½¬è‡ªï¼šhttps://github.com/winterbe/java8-tutorial è½¬è‡ªï¼šJava8 æ–°ç‰¹æ€§æŒ‡å¯¼æ‰‹å†Œ æ¥å£å†…å…è®¸æ·»åŠ é»˜è®¤å®ç°çš„æ–¹æ³•Java 8 å…è®¸æˆ‘ä»¬é€šè¿‡ default å…³é”®å­—å¯¹æ¥å£ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•æä¾›ä¸€ä¸ªé»˜è®¤çš„å®ç°ã€‚ è¯·çœ‹ä¸‹é¢ç¤ºä¾‹ä»£ç ï¼š // å®šä¹‰ä¸€ä¸ªå…¬å¼æ¥å£interface Formula &#123; // è®¡ç®— double calculate(int a); // æ±‚å¹³æ–¹æ ¹ default double sqrt(int a) &#123; return Math.sqrt(a); &#125;&#125; åœ¨ä¸Šé¢è¿™ä¸ªæ¥å£ä¸­ï¼Œæˆ‘ä»¬é™¤äº†å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³• calculateï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å®ç°çš„æ–¹æ³• sqrtã€‚ æˆ‘ä»¬åœ¨å®ç°è¿™ä¸ªæ¥å£æ—¶ï¼Œå¯ä»¥åªéœ€è¦å®ç° calculate æ–¹æ³•ï¼Œé»˜è®¤æ–¹æ³• sqrt å¯ä»¥ç›´æ¥è°ƒç”¨å³å¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ä¸å¿…å¼ºåˆ¶å®ç° sqrt æ–¹æ³•ã€‚ è¡¥å……ï¼šé€šè¿‡ default å…³é”®å­—è¿™ä¸ªæ–°ç‰¹æ€§ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å¯¹ä¹‹å‰çš„æ¥å£åšæ‹“å±•ï¼Œè€Œæ­¤æ¥å£çš„å®ç°ç±»ä¸å¿…åšä»»ä½•æ”¹åŠ¨ã€‚ Formula formula = new Formula() &#123; @Override public double calculate(int a) &#123; return sqrt(a * 100); &#125;&#125;;formula.calculate(100); // 100.0formula.sqrt(16); // 4.0 ä¸Šé¢é€šè¿‡åŒ¿åå¯¹è±¡å®ç°äº† Formula æ¥å£ã€‚ä½†æ˜¯å³ä½¿æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä¸ºäº†å®Œæˆä¸€ä¸ª sqrt(a * 100)ç®€å•è®¡ç®—ï¼Œå°±å†™äº† 6 è¡Œä»£ç ï¼Œå¾ˆæ˜¯å†—ä½™ã€‚ Lamdbaè¡¨è¾¾å¼åœ¨å­¦ä¹  Lambda è¡¨è¾¾å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µè€ç‰ˆæœ¬çš„ç¤ºä¾‹ä»£ç ï¼Œå…¶å¯¹ä¸€ä¸ªå«æœ‰å­—ç¬¦ä¸²çš„é›†åˆè¿›è¡Œæ’åºï¼š List&lt;String&gt; names = Arrays.asList(&quot;peter&quot;, &quot;anna&quot;, &quot;mike&quot;, &quot;xenia&quot;);Collections.sort(names, new Comparator&lt;String&gt;() &#123; @Override public int compare(String a, String b) &#123; return b.compareTo(a); &#125;&#125;); Collections å·¥å…·ç±»æä¾›äº†é™æ€æ–¹æ³• sort æ–¹æ³•ï¼Œå…¥å‚æ˜¯ä¸€ä¸ª List é›†åˆï¼Œå’Œä¸€ä¸ª Comparator æ¯”è¾ƒå™¨ï¼Œä»¥ä¾¿å¯¹ç»™å®šçš„ List é›†åˆè¿›è¡Œ æ’åºã€‚ä¸Šé¢çš„ç¤ºä¾‹ä»£ç åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ä½œä¸ºå…¥å‚ï¼Œè¿™ç§ç±»ä¼¼çš„æ“ä½œåœ¨æˆ‘ä»¬æ—¥å¸¸çš„å·¥ä½œä¸­éšå¤„å¯è§ã€‚ Java 8 ä¸­ä¸å†æ¨èè¿™ç§å†™æ³•ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨ Lambda è¡¨è¾¾ï¼š Collections.sort(names, (String a, String b) -&gt; &#123; return b.compareTo(a);&#125;); æ­£å¦‚ä½ çœ‹åˆ°çš„ï¼Œä¸Šé¢è¿™æ®µä»£ç å˜å¾—ç®€çŸ­å¾ˆå¤šè€Œä¸”æ˜“äºé˜…è¯»ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥å†ç²¾ç‚¼ä¸€ç‚¹ï¼š Collections.sort(names, (String a, String b) -&gt; b.compareTo(a)); List é›†åˆç°åœ¨å·²ç»æ·»åŠ äº† sort æ–¹æ³•ã€‚è€Œä¸” Java ç¼–è¯‘å™¨èƒ½å¤Ÿæ ¹æ®ç±»å‹æ¨æ–­æœºåˆ¶åˆ¤æ–­å‡ºå‚æ•°ç±»å‹ï¼Œè¿™æ ·ï¼Œè¿å…¥å‚çš„ç±»å‹éƒ½å¯ä»¥çœç•¥äº†ï¼ å‡½æ•°å¼æ¥å£ Functional InterfaceæŠ›å‡ºä¸€ä¸ªç–‘é—®ï¼šåœ¨æˆ‘ä»¬ä¹¦å†™ä¸€æ®µ Lambda è¡¨è¾¾å¼åï¼ˆæ¯”å¦‚ä¸Šä¸€ç« èŠ‚ä¸­åŒ¿åå†…éƒ¨ç±»çš„ Lambda è¡¨è¾¾å¼ç¼©å†™å½¢å¼ï¼‰ï¼ŒJava ç¼–è¯‘å™¨æ˜¯å¦‚ä½•è¿›è¡Œç±»å‹æ¨æ–­çš„ï¼Œå®ƒåˆæ˜¯æ€ä¹ˆçŸ¥é“é‡å†™çš„å“ªä¸ªæ–¹æ³•çš„ï¼Ÿ éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸æ˜¯æ¯ä¸ªæ¥å£éƒ½å¯ä»¥ç¼©å†™æˆ Lambda è¡¨è¾¾å¼ã€‚åªæœ‰é‚£äº›å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰æ‰èƒ½ç¼©å†™æˆ Lambda è¡¨ç¤ºå¼ã€‚ é‚£ä¹ˆä»€ä¹ˆæ˜¯å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰å‘¢ï¼Ÿ æ‰€è°“å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰å°±æ˜¯åªåŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„å£°æ˜ã€‚é’ˆå¯¹è¯¥æ¥å£ç±»å‹çš„æ‰€æœ‰ Lambda è¡¨è¾¾å¼éƒ½ä¼šä¸è¿™ä¸ªæŠ½è±¡æ–¹æ³•åŒ¹é…ã€‚ æ³¨æ„ï¼šä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼ŒJava 8 ä¸­ä¸æ˜¯å…è®¸é€šè¿‡ defualt å…³é”®å­—æ¥ä¸ºæ¥å£æ·»åŠ é»˜è®¤æ–¹æ³•å—ï¼Ÿé‚£å®ƒç®—ä¸ç®—æŠ½è±¡æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸ç®—ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ¯«æ— é¡¾å¿Œçš„æ·»åŠ é»˜è®¤æ–¹æ³•ï¼Œå®ƒå¹¶ä¸è¿åå‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰çš„å®šä¹‰ã€‚ æ€»ç»“ä¸€ä¸‹ï¼šåªè¦æ¥å£ä¸­ä»…ä»…åŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å…¶æ”¹å†™ä¸º Lambda è¡¨è¾¾å¼ã€‚ä¸ºäº†ä¿è¯ä¸€ä¸ªæ¥å£æ˜ç¡®çš„è¢«å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¯¥æ¥å£æ·»åŠ æ³¨è§£ï¼š@FunctionalInterfaceã€‚è¿™æ ·ï¼Œä¸€æ—¦ä½ æ·»åŠ äº†ç¬¬äºŒä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç¼–è¯‘å™¨ä¼šç«‹åˆ»æŠ›å‡ºé”™è¯¯æç¤ºã€‚ ç¤ºä¾‹ä»£ç ï¼š @FunctionalInterfaceinterface Converter&lt;F, T&gt; &#123; T convert(F from);&#125; ç¤ºä¾‹ä»£ç 2ï¼š Converter&lt;String, Integer&gt; converter = (from) -&gt; Integer.valueOf(from);Integer converted = converter.convert(&quot;123&quot;);System.out.println(converted); // 123 æ³¨æ„ï¼šä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œå³ä½¿å»æ‰ @FunctionalInterface ä¹Ÿæ˜¯å¥½ä½¿çš„ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ç§çº¦æŸè€Œå·²ã€‚ ä¾¿æ·çš„å¼•ç”¨ç±»çš„æ„é€ å™¨åŠæ–¹æ³•å°ä¼™ä¼´ä»¬ï¼Œè¿˜è®°å¾—ä¸Šä¸€ä¸ªç« èŠ‚è¿™æ®µç¤ºä¾‹ä»£ç ä¹ˆï¼š @FunctionalInterfaceinterface Converter&lt;F, T&gt; &#123; T convert(F from);&#125; Converter&lt;String, Integer&gt; converter = (from) -&gt; Integer.valueOf(from);Integer converted = converter.convert(&quot;123&quot;);System.out.println(converted); // 123 ä¸Šé¢è¿™æ®µä»£ç ï¼Œé€šè¿‡ Java 8 çš„æ–°ç‰¹æ€§ï¼Œè¿›ä¸€æ­¥ç®€åŒ–ä¸Šé¢çš„ä»£ç ï¼š Converter&lt;String, Integer&gt; converter = Integer::valueOf;Integer converted = converter.convert(&quot;123&quot;);System.out.println(converted); // 123 Java 8 ä¸­å…è®¸ä½ é€šè¿‡ :: å…³é”®å­—æ¥å¼•ç”¨ç±»çš„æ–¹æ³•æˆ–æ„é€ å™¨ã€‚ä¸Šé¢çš„ä»£ç ç®€å•çš„ç¤ºä¾‹äº†å¦‚ä½•å¼•ç”¨é™æ€æ–¹æ³•ï¼Œå½“ç„¶ï¼Œé™¤äº†é™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¼•ç”¨æ™®é€šæ–¹æ³•ï¼š class Something &#123; String startsWith(String s) &#123; return String.valueOf(s.charAt(0)); &#125;&#125; Something something = new Something();Converter&lt;String, String&gt; converter = something::startsWith;String converted = converter.convert(&quot;Java&quot;);System.out.println(converted); // &quot;J&quot; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡ :: å…³é”®å­—æ¥å¼•ç”¨ç±»çš„æ„é€ å™¨ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªç¤ºä¾‹ç±»ï¼Œåœ¨ç±»ä¸­å£°æ˜ä¸¤ä¸ªæ„é€ å™¨ï¼š class Person &#123; String firstName; String lastName; Person() &#123;&#125; Person(String firstName, String lastName) &#123; this.firstName = firstName; this.lastName = lastName; &#125;&#125; ç„¶åï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªå·¥å‚æ¥å£ï¼Œç”¨æ¥ç”Ÿæˆ Person ç±»ï¼š // Person å·¥å‚interface PersonFactory&lt;P extends Person&gt; &#123; P create(String firstName, String lastName);&#125; æˆ‘ä»¬å¯ä»¥é€šè¿‡ :: å…³é”®å­—æ¥å¼•ç”¨ Person ç±»çš„æ„é€ å™¨ï¼Œæ¥ä»£æ›¿æ‰‹åŠ¨å»å®ç°è¿™ä¸ªå·¥å‚æ¥å£ï¼š // ç›´æ¥å¼•ç”¨ Person æ„é€ å™¨PersonFactory&lt;Person&gt; personFactory = Person::new;Person person = personFactory.create(&quot;Peter&quot;, &quot;Parker&quot;); Person::new è¿™æ®µä»£ç ï¼Œèƒ½å¤Ÿç›´æ¥å¼•ç”¨ Person ç±»çš„æ„é€ å™¨ã€‚ç„¶å Java ç¼–è¯‘å™¨èƒ½å¤Ÿæ ¹æ®ä¸Šä¸‹æ–‡é€‰ä¸­æ­£ç¡®çš„æ„é€ å™¨å»å®ç° PersonFactory.create æ–¹æ³•ã€‚ Lamdbaè®¿é—®å¤–éƒ¨å˜é‡åŠæ¥å£é»˜è®¤æ–¹æ³•åœ¨æœ¬ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºå¦‚ä½•åœ¨ lambda è¡¨è¾¾å¼ä¸­è®¿é—®å¤–éƒ¨å˜é‡ï¼ˆåŒ…æ‹¬ï¼šå±€éƒ¨å˜é‡ï¼Œæˆå‘˜å˜é‡ï¼Œé™æ€å˜é‡ï¼Œæ¥å£çš„é»˜è®¤æ–¹æ³•.ï¼‰ï¼Œå®ƒä¸åŒ¿åå†…éƒ¨ç±»è®¿é—®å¤–éƒ¨å˜é‡å¾ˆç›¸ä¼¼ã€‚ è®¿é—®å±€éƒ¨å˜é‡åœ¨ Lambda è¡¨è¾¾å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®å¤–éƒ¨çš„ final ç±»å‹å˜é‡ï¼Œå¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š // è½¬æ¢å™¨@FunctionalInterfaceinterface Converter&lt;F, T&gt; &#123; T convert(F from);&#125;å¤åˆ¶ä»£ç final int num = 1;Converter&lt;Integer, String&gt; stringConverter = (from) -&gt; String.valueOf(from + num);stringConverter.convert(2); // 3å¤åˆ¶ä»£ç  ä¸åŒ¿åå†…éƒ¨ç±»ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…æ˜¾å¼å£°æ˜ num å˜é‡ä¸º final ç±»å‹ï¼Œä¸‹é¢è¿™æ®µä»£ç åŒæ ·æœ‰æ•ˆï¼š int num = 1;Converter&lt;Integer, String&gt; stringConverter = (from) -&gt; String.valueOf(from + num);stringConverter.convert(2); // 3 ä½†æ˜¯ num å˜é‡å¿…é¡»ä¸ºéšå¼çš„ final ç±»å‹ï¼Œä½•ä¸ºéšå¼çš„ final å‘¢ï¼Ÿå°±æ˜¯è¯´åˆ°ç¼–è¯‘æœŸä¸ºæ­¢ï¼Œnum å¯¹è±¡æ˜¯ä¸èƒ½è¢«æ”¹å˜çš„ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå°±ä¸èƒ½è¢«ç¼–è¯‘é€šè¿‡ï¼š int num = 1;Converter&lt;Integer, String&gt; stringConverter = (from) -&gt; String.valueOf(from + num);num = 3; åœ¨ lambda è¡¨è¾¾å¼å†…éƒ¨æ”¹å˜ num å€¼åŒæ ·ç¼–è¯‘ä¸é€šè¿‡ï¼Œéœ€è¦æ³¨æ„, æ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š int num = 1;Converter&lt;Integer, String&gt; converter = (from) -&gt; &#123; String value = String.valueOf(from + num); num = 3; return value;&#125;; è®¿é—®æˆå‘˜å˜é‡å’Œé™æ€å˜é‡ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œäº†è§£äº†å¦‚ä½•åœ¨ Lambda è¡¨è¾¾å¼ä¸­è®¿é—®å±€éƒ¨å˜é‡ã€‚ä¸å±€éƒ¨å˜é‡ç›¸æ¯”ï¼Œåœ¨ Lambda è¡¨è¾¾å¼ä¸­å¯¹æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ‹¥æœ‰è¯»å†™æƒé™ï¼š @FunctionalInterfaceinterface Converter&lt;F, T&gt; &#123; T convert(F from);&#125; class Lambda4 &#123; // é™æ€å˜é‡ static int outerStaticNum; // æˆå‘˜å˜é‡ int outerNum; void testScopes() &#123; Converter&lt;Integer, String&gt; stringConverter1 = (from) -&gt; &#123; // å¯¹æˆå‘˜å˜é‡èµ‹å€¼ outerNum = 23; return String.valueOf(from); &#125;; Converter&lt;Integer, String&gt; stringConverter2 = (from) -&gt; &#123; // å¯¹é™æ€å˜é‡èµ‹å€¼ outerStaticNum = 72; return String.valueOf(from); &#125;; &#125;&#125; è®¿é—®æ¥å£çš„é»˜è®¤æ–¹æ³•è¿˜è®°å¾—ç¬¬ä¸€ç« èŠ‚ä¸­å®šä¹‰çš„é‚£ä¸ª Formula (å…¬å¼) æ¥å£å—ï¼Ÿ @FunctionalInterfaceinterface Formula &#123; // è®¡ç®— double calculate(int a); // æ±‚å¹³æ–¹æ ¹ default double sqrt(int a) &#123; return Math.sqrt(a); &#125;&#125; å½“æ—¶ï¼Œæˆ‘ä»¬åœ¨æ¥å£ä¸­å®šä¹‰äº†ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å®ç°çš„ sqrt æ±‚å¹³æ–¹æ ¹æ–¹æ³•ï¼Œåœ¨åŒ¿åå†…éƒ¨ç±»ä¸­æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¿é—®æ­¤æ–¹æ³•ï¼š Formula formula = new Formula() &#123; @Override public double calculate(int a) &#123; return sqrt(a * 100); &#125;&#125;; ä½†æ˜¯åœ¨ lambda è¡¨è¾¾å¼ä¸­å¯ä¸è¡Œï¼š Formula formula = (a) -&gt; sqrt(a * 100); å¸¦æœ‰é»˜è®¤å®ç°çš„æ¥å£æ–¹æ³•ï¼Œæ˜¯ä¸èƒ½åœ¨ lambda è¡¨è¾¾å¼ä¸­è®¿é—®çš„ï¼Œä¸Šé¢è¿™æ®µä»£ç å°†æ— æ³•è¢«ç¼–è¯‘é€šè¿‡ã€‚ å†…ç½®çš„å‡½æ•°å¼æ¥å£JDK 1.8 API åŒ…å«äº†å¾ˆå¤šå†…ç½®çš„å‡½æ•°å¼æ¥å£ã€‚å…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬åœ¨è€ç‰ˆæœ¬ä¸­ç»å¸¸è§åˆ°çš„ Comparator å’Œ Runnableï¼ŒJava 8 ä¸ºä»–ä»¬éƒ½æ·»åŠ äº† @FunctionalInterface æ³¨è§£ï¼Œä»¥ç”¨æ¥æ”¯æŒ Lambda è¡¨è¾¾å¼ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé™¤äº† Comparator å’Œ Runnable å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ–°çš„å‡½æ•°å¼æ¥å£ï¼Œå®ƒä»¬å¾ˆå¤šéƒ½å€Ÿé‰´äºçŸ¥åçš„ Google Guava åº“ã€‚ Predicateæ–­è¨€Predicate æ˜¯ä¸€ä¸ªå¯ä»¥æŒ‡å®šå…¥å‚ç±»å‹ï¼Œå¹¶è¿”å› boolean å€¼çš„å‡½æ•°å¼æ¥å£ã€‚å®ƒå†…éƒ¨æä¾›äº†ä¸€äº›å¸¦æœ‰é»˜è®¤å®ç°çš„æ–¹æ³•ï¼Œå¯ä»¥ è¢«ç”¨æ¥ç»„åˆä¸€ä¸ªå¤æ‚çš„é€»è¾‘åˆ¤æ–­ï¼ˆand, or, negateï¼‰ï¼š Predicate&lt;String&gt; predicate = (s) -&gt; s.length() &gt; 0;predicate.test(&quot;foo&quot;); // truepredicate.negate().test(&quot;foo&quot;); // falsePredicate&lt;Boolean&gt; nonNull = Objects::nonNull;Predicate&lt;Boolean&gt; isNull = Objects::isNull;Predicate&lt;String&gt; isEmpty = String::isEmpty;Predicate&lt;String&gt; isNotEmpty = isEmpty.negate(); FunctionFunction å‡½æ•°å¼æ¥å£çš„ä½œç”¨æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå…¶æä¾›ä¸€ä¸ªåŸæ–™ï¼Œä»–ç»™ç”Ÿäº§ä¸€ä¸ªæœ€ç»ˆçš„äº§å“ã€‚é€šè¿‡å®ƒæä¾›çš„é»˜è®¤æ–¹æ³•ï¼Œç»„åˆ,é“¾è¡Œå¤„ç†(compose, andThen)ï¼š Function&lt;String, Integer&gt; toInteger = Integer::valueOf;Function&lt;String, String&gt; backToString = toInteger.andThen(String::valueOf);backToString.apply(&quot;123&quot;); // &quot;123&quot; Supplierç”Ÿäº§è€…Supplier ä¸ Function ä¸åŒï¼Œå®ƒä¸æ¥å—å…¥å‚ï¼Œç›´æ¥ä¸ºæˆ‘ä»¬ç”Ÿäº§ä¸€ä¸ªæŒ‡å®šçš„ç»“æœï¼Œæœ‰ç‚¹åƒç”Ÿäº§è€…æ¨¡å¼ï¼š class Person &#123; String firstName; String lastName; Person() &#123;&#125; Person(String firstName, String lastName) &#123; this.firstName = firstName; this.lastName = lastName; &#125;&#125; Supplier&lt;Person&gt; personSupplier = Person::new;personSupplier.get(); // new Person ###Consumeræ¶ˆè´¹è€… å¯¹äº Consumerï¼Œæˆ‘ä»¬éœ€è¦æä¾›å…¥å‚ï¼Œç”¨æ¥è¢«æ¶ˆè´¹ï¼Œå¦‚ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼š class Person &#123; String firstName; String lastName; Person() &#123;&#125; Person(String firstName, String lastName) &#123; this.firstName = firstName; this.lastName = lastName; &#125;&#125; Consumer&lt;Person&gt; greeter = (p) -&gt; System.out.println(&quot;Hello, &quot; + p.firstName);greeter.accept(new Person(&quot;Luke&quot;, &quot;Skywalker&quot;)); ComparatorComparator åœ¨ Java 8 ä¹‹å‰æ˜¯ä½¿ç”¨æ¯”è¾ƒæ™®éçš„ã€‚Java 8 ä¸­é™¤äº†å°†å…¶å‡çº§æˆäº†å‡½æ•°å¼æ¥å£ï¼Œè¿˜ä¸ºå®ƒæ‹“å±•äº†ä¸€äº›é»˜è®¤æ–¹æ³•ï¼š Comparator&lt;Person&gt; comparator = (p1, p2) -&gt; p1.firstName.compareTo(p2.firstName);Person p1 = new Person(&quot;John&quot;, &quot;Doe&quot;);Person p2 = new Person(&quot;Alice&quot;, &quot;Wonderland&quot;);comparator.compare(p1, p2); // &gt; 0comparator.reversed().compare(p1, p2); // &lt; 0 Optionalé¦–å…ˆï¼ŒOptional å®ƒä¸æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œè®¾è®¡å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ˆNullPointerExceptionï¼‰ï¼Œè¦çŸ¥é“åœ¨ Java ç¼–ç¨‹ä¸­ï¼Œ ç©ºæŒ‡é’ˆå¼‚å¸¸å¯æ˜¯è‡­åæ˜­è‘—çš„ã€‚ è®©æˆ‘ä»¬æ¥å¿«é€Ÿäº†è§£ä¸€ä¸‹ Optional è¦å¦‚ä½•ä½¿ç”¨ï¼ä½ å¯ä»¥å°† Optional çœ‹åšæ˜¯åŒ…è£…å¯¹è±¡ï¼ˆå¯èƒ½æ˜¯ null, ä¹Ÿæœ‰å¯èƒ½é nullï¼‰çš„å®¹å™¨ã€‚å½“ä½ å®šä¹‰äº† ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡å¯èƒ½æ˜¯ç©ºï¼Œä¹Ÿæœ‰å¯èƒ½éç©ºçš„æ—¶å€™ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ç”¨ Optional æ¥åŒ…è£…å®ƒï¼Œè¿™ä¹Ÿæ˜¯åœ¨ Java 8 è¢«æ¨èä½¿ç”¨çš„åšæ³•ã€‚ Optional&lt;String&gt; optional = Optional.of(&quot;bam&quot;);optional.isPresent(); // trueoptional.get(); // &quot;bam&quot;optional.orElse(&quot;fallback&quot;); // &quot;bam&quot;optional.ifPresent((s) -&gt; System.out.println(s.charAt(0))); // &quot;b&quot; Streamæµä»€ä¹ˆæ˜¯ Stream æµï¼Ÿ ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ java.util.Stream å¯¹ä¸€ä¸ªåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ çš„é›†åˆåšå„ç§æ“ä½œã€‚è¿™äº›æ“ä½œå¯èƒ½æ˜¯ ä¸­é—´æ“ä½œ äº¦æˆ–æ˜¯ ç»ˆç«¯æ“ä½œã€‚ ç»ˆç«¯æ“ä½œä¼šè¿”å›ä¸€ä¸ªç»“æœï¼Œè€Œä¸­é—´æ“ä½œä¼šè¿”å›ä¸€ä¸ª Stream æµã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ åªèƒ½å¯¹å®ç°äº† java.util.Collection æ¥å£çš„ç±»åšæµçš„æ“ä½œã€‚ Map ä¸æ”¯æŒ Stream æµã€‚ Stream æµæ”¯æŒåŒæ­¥æ‰§è¡Œï¼Œä¹Ÿæ”¯æŒå¹¶å‘æ‰§è¡Œã€‚ Filterè¿‡æ»¤é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª List é›†åˆï¼š List&lt;String&gt; stringCollection = new ArrayList&lt;&gt;();stringCollection.add(&quot;ddd2&quot;);stringCollection.add(&quot;aaa2&quot;);stringCollection.add(&quot;bbb1&quot;);stringCollection.add(&quot;aaa1&quot;);stringCollection.add(&quot;bbb3&quot;);stringCollection.add(&quot;ccc&quot;);stringCollection.add(&quot;bbb2&quot;);stringCollection.add(&quot;ddd1&quot;); Filter çš„å…¥å‚æ˜¯ä¸€ä¸ª Predicate, ä¸Šé¢å·²ç»è¯´åˆ°ï¼ŒPredicate æ˜¯ä¸€ä¸ªæ–­è¨€çš„ä¸­é—´æ“ä½œï¼Œå®ƒèƒ½å¤Ÿå¸®æˆ‘ä»¬ç­›é€‰å‡ºæˆ‘ä»¬éœ€è¦çš„é›†åˆå…ƒç´ ã€‚å®ƒçš„è¿”å‚åŒæ · æ˜¯ä¸€ä¸ª Stream æµï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ foreachç»ˆç«¯æ“ä½œï¼Œæ¥æ‰“å°è¢«ç­›é€‰çš„å…ƒç´ ï¼š stringCollection .stream() .filter((s) -&gt; s.startsWith(&quot;a&quot;)) .forEach(System.out::println);// &quot;aaa2&quot;, &quot;aaa1&quot; æ³¨æ„ï¼šforeach æ˜¯ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œå®ƒçš„è¿”å‚æ˜¯ void, æˆ‘ä»¬æ— æ³•å¯¹å…¶å†æ¬¡è¿›è¡Œæµæ“ä½œã€‚ Sortedæ’åºSorted åŒæ ·æ˜¯ä¸€ä¸ªä¸­é—´æ“ä½œï¼Œå®ƒçš„è¿”å‚æ˜¯ä¸€ä¸ª Stream æµã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ª Comparator ç”¨æ¥è‡ªå®šä¹‰æ’åºï¼Œå¦‚æœä¸ä¼ ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æ’åºè§„åˆ™ã€‚ stringCollection .stream() .sorted() .filter((s) -&gt; s.startsWith(&quot;a&quot;)) .forEach(System.out::println);// &quot;aaa1&quot;, &quot;aaa2&quot; éœ€è¦æ³¨æ„ï¼Œsorted ä¸ä¼šå¯¹ stringCollection åšå‡ºä»»ä½•æ”¹å˜ï¼ŒstringCollection è¿˜æ˜¯åŸæœ‰çš„é‚£äº›ä¸ªå…ƒç´ ï¼Œä¸”é¡ºåºä¸å˜ï¼š System.out.println(stringCollection);// ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1 Mapè½¬æ¢ä¸­é—´æ“ä½œ Map èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å°† List ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ åšåŠŸèƒ½å¤„ç†ã€‚ä¾‹å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼Œé€šè¿‡ mapæˆ‘ä»¬å°†æ¯ä¸€ä¸ª string è½¬æˆå¤§å†™ï¼š stringCollection .stream() .map(String::toUpperCase) .sorted((a, b) -&gt; b.compareTo(a)) .forEach(System.out::println);// &quot;DDD2&quot;, &quot;DDD1&quot;, &quot;CCC&quot;, &quot;BBB3&quot;, &quot;BBB2&quot;, &quot;AAA2&quot;, &quot;AAA1&quot; å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšå¯¹è±¡ä¹‹é—´çš„è½¬æ¢ï¼Œä¸šåŠ¡ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯å°† DOï¼ˆæ•°æ®åº“å¯¹è±¡ï¼‰ è½¬æ¢æˆ BOï¼ˆä¸šåŠ¡å¯¹è±¡ï¼‰ ã€‚ MatchåŒ¹é…é¡¾åæ€ä¹‰ï¼Œmatch ç”¨æ¥åšåŒ¹é…æ“ä½œï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ª boolean ç±»å‹ã€‚é€šè¿‡ match, æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„éªŒè¯ä¸€ä¸ª list ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªç±»å‹çš„å…ƒç´ ã€‚ // éªŒè¯ list ä¸­ string æ˜¯å¦æœ‰ä»¥ a å¼€å¤´çš„, åŒ¹é…åˆ°ç¬¬ä¸€ä¸ªï¼Œå³è¿”å› trueboolean anyStartsWithA = stringCollection .stream() .anyMatch((s) -&gt; s.startsWith(&quot;a&quot;));System.out.println(anyStartsWithA); // true// éªŒè¯ list ä¸­ string æ˜¯å¦éƒ½æ˜¯ä»¥ a å¼€å¤´çš„boolean allStartsWithA = stringCollection .stream() .allMatch((s) -&gt; s.startsWith(&quot;a&quot;));System.out.println(allStartsWithA); // false// éªŒè¯ list ä¸­ string æ˜¯å¦éƒ½ä¸æ˜¯ä»¥ z å¼€å¤´çš„,boolean noneStartsWithZ = stringCollection .stream() .noneMatch((s) -&gt; s.startsWith(&quot;z&quot;));System.out.println(noneStartsWithZ); // true Countè®¡æ•°count æ˜¯ä¸€ä¸ªç»ˆç«¯æ“ä½œï¼Œå®ƒèƒ½å¤Ÿç»Ÿè®¡ stream æµä¸­çš„å…ƒç´ æ€»æ•°ï¼Œè¿”å›å€¼æ˜¯ long ç±»å‹ã€‚ // å…ˆå¯¹ list ä¸­å­—ç¬¦ä¸²å¼€å¤´ä¸º b è¿›è¡Œè¿‡æ»¤ï¼Œè®©åç»Ÿè®¡æ•°é‡long startsWithB = stringCollection .stream() .filter((s) -&gt; s.startsWith(&quot;b&quot;)) .count();System.out.println(startsWithB); // 3 Reduceæ±‡èšReduce ä¸­æ–‡ç¿»è¯‘ä¸ºï¼šå‡å°‘ã€ç¼©å°ã€‚é€šè¿‡å…¥å‚çš„ Functionï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°† list å½’çº¦æˆä¸€ä¸ªå€¼ã€‚å®ƒçš„è¿”å›ç±»å‹æ˜¯ Optional ç±»å‹ã€‚ Optional&lt;String&gt; reduced = stringCollection .stream() .sorted() .reduce((s1, s2) -&gt; s1 + &quot;#&quot; + s2);reduced.ifPresent(System.out::println);// &quot;aaa1#aaa2#bbb1#bbb2#bbb3#ccc#ddd1#ddd2&quot; ##Parallel Streamså¹¶è¡Œæµ å‰é¢ç« èŠ‚æˆ‘ä»¬è¯´è¿‡ï¼Œstream æµæ˜¯æ”¯æŒé¡ºåºå’Œå¹¶è¡Œçš„ã€‚é¡ºåºæµæ“ä½œæ˜¯å•çº¿ç¨‹æ“ä½œï¼Œè€Œå¹¶è¡Œæµæ˜¯é€šè¿‡å¤šçº¿ç¨‹æ¥å¤„ç†çš„ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç‰©ç†æœº å¤šæ ¸ CPU çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¤„ç†é€Ÿåº¦æ›´å¿«ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å« 1000000 UUID list é›†åˆã€‚ int max = 1000000;List&lt;String&gt; values = new ArrayList&lt;&gt;(max);for (int i = 0; i &lt; max; i++) &#123; UUID uuid = UUID.randomUUID(); values.add(uuid.toString());&#125; åˆ†åˆ«é€šè¿‡é¡ºåºæµå’Œå¹¶è¡Œæµï¼Œå¯¹è¿™ä¸ª list è¿›è¡Œæ’åºï¼Œæµ‹ç®—è€—æ—¶: é¡ºåºæµæ’åº// çº³ç§’long t0 = System.nanoTime();long count = values.stream().sorted().count();System.out.println(count);long t1 = System.nanoTime();// çº³ç§’è½¬å¾®ç§’long millis = TimeUnit.NANOSECONDS.toMillis(t1 - t0);System.out.println(String.format(&quot;é¡ºåºæµæ’åºè€—æ—¶: %d ms&quot;, millis));// é¡ºåºæµæ’åºè€—æ—¶: 899 ms å¹¶è¡Œæµæ’åº// çº³ç§’long t0 = System.nanoTime();long count = values.parallelStream().sorted().count();System.out.println(count);long t1 = System.nanoTime();// çº³ç§’è½¬å¾®ç§’long millis = TimeUnit.NANOSECONDS.toMillis(t1 - t0);System.out.println(String.format(&quot;å¹¶è¡Œæµæ’åºè€—æ—¶: %d ms&quot;, millis));// å¹¶è¡Œæµæ’åºè€—æ—¶: 472 ms æ­£å¦‚ä½ æ‰€è§ï¼ŒåŒæ ·çš„é€»è¾‘å¤„ç†ï¼Œé€šè¿‡å¹¶è¡Œæµï¼Œæˆ‘ä»¬çš„æ€§èƒ½æå‡äº†è¿‘ **50%**ã€‚å®Œæˆè¿™ä¸€åˆ‡ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ä»…ä»…æ˜¯å°† stream æ”¹æˆäº† parallelStreamã€‚ Mapé›†åˆå‰é¢å·²ç»æåˆ°è¿‡ Map æ˜¯ä¸æ”¯æŒ Stream æµçš„ï¼Œå› ä¸º Map æ¥å£å¹¶æ²¡æœ‰åƒ Collection æ¥å£é‚£æ ·ï¼Œå®šä¹‰äº† stream() æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶ key, values, entry ä½¿ç”¨ æµæ“ä½œï¼Œå¦‚ map.keySet().stream(), map.values().stream() å’Œ map.entrySet().stream(). å¦å¤–, JDK 8 ä¸­å¯¹ map æä¾›äº†ä¸€äº›å…¶ä»–æ–°ç‰¹æ€§: Map&lt;Integer, String&gt; map = new HashMap&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; // ä¸è€ç‰ˆä¸åŒçš„æ˜¯ï¼ŒputIfAbent() æ–¹æ³•åœ¨ put ä¹‹å‰ï¼Œ // ä¼šåˆ¤æ–­ key æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å› value, å¦åˆ™ put, å†è¿”å› value map.putIfAbsent(i, &quot;val&quot; + i);&#125;// forEach å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹ map è¿›è¡Œéå†æ“ä½œmap.forEach((key, value) -&gt; System.out.println(value)); é™¤äº†ä¸Šé¢çš„ putIfAbsent() å’Œ forEach() å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹æŸä¸ª key çš„å€¼åšç›¸å…³æ“ä½œï¼š // computeIfPresent(), å½“ key å­˜åœ¨æ—¶ï¼Œæ‰ä¼šåšç›¸å…³å¤„ç†// å¦‚ä¸‹ï¼šå¯¹ key ä¸º 3 çš„å€¼ï¼Œå†…éƒ¨ä¼šå…ˆåˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™åš value + key çš„æ‹¼æ¥æ“ä½œmap.computeIfPresent(3, (num, val) -&gt; val + num);map.get(3); // val33// å…ˆåˆ¤æ–­ key ä¸º 9 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™åšåˆ é™¤æ“ä½œmap.computeIfPresent(9, (num, val) -&gt; null);map.containsKey(9); // false// computeIfAbsent(), å½“ key ä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šåšç›¸å…³å¤„ç†// å¦‚ä¸‹ï¼šå…ˆåˆ¤æ–­ key ä¸º 23 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ map.computeIfAbsent(23, num -&gt; &quot;val&quot; + num);map.containsKey(23); // true// å…ˆåˆ¤æ–­ key ä¸º 3 çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†map.computeIfAbsent(3, num -&gt; &quot;bam&quot;);map.get(3); // val33 å…³äºåˆ é™¤æ“ä½œï¼ŒJDK 8 ä¸­æä¾›äº†èƒ½å¤Ÿæ–°çš„ remove() API: map.remove(3, &quot;val3&quot;);map.get(3); // val33map.remove(3, &quot;val33&quot;);map.get(3); // null å¦‚ä¸Šä»£ç ï¼Œåªæœ‰å½“ç»™å®šçš„ key å’Œ value å®Œå…¨åŒ¹é…æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œåˆ é™¤æ“ä½œã€‚ å…³äºæ·»åŠ æ–¹æ³•ï¼ŒJDK 8 ä¸­æä¾›äº†å¸¦æœ‰é»˜è®¤å€¼çš„ getOrDefault() æ–¹æ³•ï¼š // è‹¥ key 42 ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› not foundmap.getOrDefault(42, &quot;not found&quot;); // not found å¯¹äº value çš„åˆå¹¶æ“ä½œä¹Ÿå˜å¾—æ›´åŠ ç®€å•ï¼š // merge æ–¹æ³•ï¼Œä¼šå…ˆåˆ¤æ–­è¿›è¡Œåˆå¹¶çš„ key æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ·»åŠ å…ƒç´ map.merge(9, &quot;val9&quot;, (value, newValue) -&gt; value.concat(newValue));map.get(9); // val9// è‹¥ key çš„å…ƒç´ å­˜åœ¨ï¼Œåˆ™å¯¹ value æ‰§è¡Œæ‹¼æ¥æ“ä½œmap.merge(9, &quot;concat&quot;, (value, newValue) -&gt; value.concat(newValue));map.get(9); // val9concat æ–°çš„æ—¥æœŸAPIJava 8 ä¸­åœ¨åŒ… java.time ä¸‹æ·»åŠ äº†æ–°çš„æ—¥æœŸ API. å®ƒå’Œ Joda-Time åº“ç›¸ä¼¼ï¼Œä½†åˆä¸å®Œå…¨ç›¸åŒã€‚ ClockClock æä¾›å¯¹å½“å‰æ—¥æœŸå’Œæ—¶é—´çš„è®¿é—®ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥æ›¿ä»£ System.currentTimeMillis() æ–¹æ³•ã€‚å¦å¤–ï¼Œé€šè¿‡ clock.instant() èƒ½å¤Ÿè·å–ä¸€ä¸ª instant å®ä¾‹ï¼Œ æ­¤å®ä¾‹èƒ½å¤Ÿæ–¹ä¾¿åœ°è½¬æ¢æˆè€ç‰ˆæœ¬ä¸­çš„ java.util.Date å¯¹è±¡ã€‚ Clock clock = Clock.systemDefaultZone();long millis = clock.millis();Instant instant = clock.instant();Date legacyDate = Date.from(instant); // è€ç‰ˆæœ¬ java.util.Date Timezonesæ—¶åŒºZoneId ä»£è¡¨æ—¶åŒºç±»ã€‚é€šè¿‡é™æ€å·¥å‚æ–¹æ³•æ–¹ä¾¿åœ°è·å–å®ƒï¼Œå…¥å‚æˆ‘ä»¬å¯ä»¥ä¼ å…¥æŸä¸ªæ—¶åŒºç¼–ç ã€‚å¦å¤–ï¼Œæ—¶åŒºç±»è¿˜å®šä¹‰äº†ä¸€ä¸ªåç§»é‡ï¼Œç”¨æ¥åœ¨å½“å‰æ—¶åˆ»æˆ–æŸæ—¶é—´ ä¸ç›®æ ‡æ—¶åŒºæ—¶é—´ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ System.out.println(ZoneId.getAvailableZoneIds());// prints all available timezone idsZoneId zone1 = ZoneId.of(&quot;Europe/Berlin&quot;);ZoneId zone2 = ZoneId.of(&quot;Brazil/East&quot;);System.out.println(zone1.getRules());System.out.println(zone2.getRules());// ZoneRules[currentStandardOffset=+01:00]// ZoneRules[currentStandardOffset=-03:00] LocalTimeLocalTime è¡¨ç¤ºä¸€ä¸ªæ²¡æœ‰æŒ‡å®šæ—¶åŒºçš„æ—¶é—´ç±»ï¼Œä¾‹å¦‚ï¼Œ10 p.m.æˆ–è€… 17ï¼š30:15ï¼Œä¸‹é¢ç¤ºä¾‹ä»£ç ä¸­ï¼Œå°†ä¼šä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ æ—¶åŒºå¯¹è±¡åˆ›å»ºä¸¤ä¸ª LocalTimeã€‚ç„¶åæˆ‘ä»¬ä¼šæ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ï¼Œå¹¶è®¡ç®—å®ƒä»¬ä¹‹é—´çš„å°æ—¶å’Œåˆ†é’Ÿçš„ä¸åŒã€‚ LocalTime now1 = LocalTime.now(zone1);LocalTime now2 = LocalTime.now(zone2);System.out.println(now1.isBefore(now2)); // falselong hoursBetween = ChronoUnit.HOURS.between(now1, now2);long minutesBetween = ChronoUnit.MINUTES.between(now1, now2);System.out.println(hoursBetween); // -3System.out.println(minutesBetween); // -239 LocalTime æä¾›å¤šä¸ªé™æ€å·¥å‚æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¯¹æ—¶é—´å¯¹è±¡å®ä¾‹çš„åˆ›å»ºå’Œæ“ä½œï¼ŒåŒ…æ‹¬å¯¹æ—¶é—´å­—ç¬¦ä¸²è¿›è¡Œè§£æçš„æ“ä½œç­‰ã€‚ LocalTime late = LocalTime.of(23, 59, 59);System.out.println(late); // 23:59:59DateTimeFormatter germanFormatter = DateTimeFormatter .ofLocalizedTime(FormatStyle.SHORT) .withLocale(Locale.GERMAN);LocalTime leetTime = LocalTime.parse(&quot;13:37&quot;, germanFormatter);System.out.println(leetTime); // 13:37 LocalDateLocalDate æ˜¯ä¸€ä¸ªæ—¥æœŸå¯¹è±¡ï¼Œä¾‹å¦‚ï¼š2014-03-11ã€‚å®ƒå’Œ LocalTime ä¸€æ ·æ˜¯ä¸ª final ç±»å‹å¯¹è±¡ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡åŠ å‡æ—¥ï¼Œæœˆï¼Œå¹´ç­‰æ¥è®¡ç®—ä¸€ä¸ªæ–°çš„æ—¥æœŸã€‚ LocalDate, LocalTime, å› ä¸ºæ˜¯ final ç±»å‹çš„å¯¹è±¡ï¼Œæ¯ä¸€æ¬¡æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„æ—¶é—´å¯¹è±¡ã€‚ LocalDate today = LocalDate.now();// ä»Šå¤©åŠ ä¸€å¤©LocalDate tomorrow = today.plus(1, ChronoUnit.DAYS);// æ˜å¤©å‡ä¸¤å¤©LocalDate yesterday = tomorrow.minusDays(2);// 2014 å¹´ä¸ƒæœˆçš„ç¬¬å››å¤©LocalDate independenceDay = LocalDate.of(2014, Month.JULY, 4);DayOfWeek dayOfWeek = independenceDay.getDayOfWeek();System.out.println(dayOfWeek); // æ˜ŸæœŸäº” ä¹Ÿå¯ä»¥ç›´æ¥è§£ææ—¥æœŸå­—ç¬¦ä¸²ï¼Œç”Ÿæˆ LocalDate å®ä¾‹ã€‚ï¼ˆå’Œ LocalTime æ“ä½œä¸€æ ·ç®€å•ï¼‰ DateTimeFormatter germanFormatter = DateTimeFormatter .ofLocalizedDate(FormatStyle.MEDIUM) .withLocale(Locale.GERMAN);LocalDate xmas = LocalDate.parse(&quot;24.12.2014&quot;, germanFormatter);System.out.println(xmas); // 2014-12-24 LocalDateTimeLocalDateTime æ˜¯ä¸€ä¸ªæ—¥æœŸ-æ—¶é—´å¯¹è±¡ã€‚ä½ ä¹Ÿå¯ä»¥å°†å…¶çœ‹æˆæ˜¯ LocalDate å’Œ LocalTime çš„ç»“åˆä½“ã€‚æ“ä½œä¸Šï¼Œä¹Ÿå¤§è‡´ç›¸åŒã€‚ LocalDateTime åŒæ ·æ˜¯ä¸€ä¸ª final ç±»å‹å¯¹è±¡ã€‚ LocalDateTime sylvester = LocalDateTime.of(2014, Month.DECEMBER, 31, 23, 59, 59);DayOfWeek dayOfWeek = sylvester.getDayOfWeek();System.out.println(dayOfWeek); // æ˜ŸæœŸä¸‰Month month = sylvester.getMonth();System.out.println(month); // åäºŒæœˆ// è·å–æ”¹æ—¶é—´æ˜¯è¯¥å¤©ä¸­çš„ç¬¬å‡ åˆ†é’Ÿlong minuteOfDay = sylvester.getLong(ChronoField.MINUTE_OF_DAY);System.out.println(minuteOfDay); // 1439 å¦‚æœå†åŠ ä¸Šçš„æ—¶åŒºä¿¡æ¯ï¼ŒLocalDateTime è¿˜èƒ½å¤Ÿè¢«è½¬æ¢æˆ Instance å®ä¾‹ã€‚Instance èƒ½å¤Ÿè¢«è½¬æ¢æˆè€ç‰ˆæœ¬ä¸­ java.util.Date å¯¹è±¡ã€‚ Instant instant = sylvester .atZone(ZoneId.systemDefault()) .toInstant();Date legacyDate = Date.from(instant);System.out.println(legacyDate); // Wed Dec 31 23:59:59 CET 2014 æ ¼å¼åŒ– LocalDateTime å¯¹è±¡å°±å’Œæ ¼å¼åŒ– LocalDate æˆ–è€… LocalTime ä¸€æ ·ã€‚é™¤äº†ä½¿ç”¨é¢„å®šä¹‰çš„æ ¼å¼ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ ¼å¼åŒ–è¾“å‡ºã€‚ DateTimeFormatter formatter = DateTimeFormatter .ofPattern(&quot;MMM dd, yyyy - HH:mm&quot;);LocalDateTime parsed = LocalDateTime.parse(&quot;Nov 03, 2014 - 07:13&quot;, formatter);String string = formatter.format(parsed);System.out.println(string); // Nov 03, 2014 - 07:13 æ³¨æ„ï¼šå’Œ java.text.NumberFormat ä¸åŒï¼Œæ–°çš„ DateTimeFormatter ç±»æ˜¯ final ç±»å‹çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ Annotationsæ³¨è§£åœ¨ Java 8 ä¸­ï¼Œæ³¨è§£æ˜¯å¯ä»¥é‡å¤çš„ã€‚è®©æˆ‘é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œæ¥çœ‹çœ‹åˆ°åº•æ˜¯å’‹å›äº‹ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ…è£…æ³¨è§£ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªæœ‰ç€å®é™…æ³¨è§£çš„æ•°ç»„ï¼š @interface Hints &#123; Hint[] value();&#125;@Repeatable(Hints.class)@interface Hint &#123; String value();&#125; Java 8 ä¸­ï¼Œé€šè¿‡ @Repeatableï¼Œå…è®¸æˆ‘ä»¬å¯¹åŒä¸€ä¸ªç±»ä½¿ç”¨å¤šé‡æ³¨è§£ï¼š ç¬¬ä¸€ç§å½¢æ€ï¼šä½¿ç”¨æ³¨è§£å®¹å™¨ï¼ˆè€æ–¹æ³•ï¼‰ @Hints(&#123;@Hint(&quot;hint1&quot;), @Hint(&quot;hint2&quot;)&#125;)class Person &#123;&#125; ç¬¬äºŒç§å½¢æ€ï¼šä½¿ç”¨å¯é‡å¤æ³¨è§£ï¼ˆæ–°æ–¹æ³•ï¼‰ @Hint(&quot;hint1&quot;)@Hint(&quot;hint2&quot;)class Person &#123;&#125; ä½¿ç”¨ç¬¬äºŒç§å½¢æ€ï¼ŒJava ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨å†…éƒ¨è‡ªåŠ¨å¯¹ @Hint è¿›è¡Œè®¾ç½®ã€‚è¿™å¯¹äºéœ€è¦é€šè¿‡åå°„æ¥è¯»å–æ³¨è§£ä¿¡æ¯æ—¶ï¼Œæ˜¯éå¸¸é‡è¦çš„ã€‚ Hint hint = Person.class.getAnnotation(Hint.class);System.out.println(hint); // nullHints hints1 = Person.class.getAnnotation(Hints.class);System.out.println(hints1.value().length); // 2Hint[] hints2 = Person.class.getAnnotationsByType(Hint.class);System.out.println(hints2.length); // 2 å°½ç®¡æˆ‘ä»¬ç»å¯¹ä¸ä¼šåœ¨ Person ç±»ä¸Šå£°æ˜ @Hints æ³¨è§£ï¼Œä½†æ˜¯å®ƒçš„ä¿¡æ¯ä»ç„¶æ˜¯å¯ä»¥é€šè¿‡ getAnnotation(Hints.class) æ¥è¯»å–çš„ã€‚ å¹¶ä¸”ï¼ŒgetAnnotationsByType æ–¹æ³•ä¼šæ›´æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒèµ‹äºˆäº†æ‰€æœ‰ @Hints æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ç›´æ¥çš„è®¿é—®æƒé™ã€‚ @Target(&#123;ElementType.TYPE_PARAMETER, ElementType.TYPE_USE&#125;)@interface MyAnnotation &#123;&#125;","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"}]},{"title":"SpringCloudï¼ˆåˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªï¼‰","date":"2019-01-04T02:39:41.000Z","path":"2019/01/04/a773bf3d.html","text":"Spring Cloud Sleuthä¸€èˆ¬çš„ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡è·Ÿè¸ªç³»ç»Ÿä¸»è¦ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š æ•°æ®æ”¶é›† æ•°æ®å­˜å‚¨ æ•°æ®å±•ç¤º æ ¹æ®ç³»ç»Ÿå¤§å°ä¸åŒï¼Œæ¯ä¸€éƒ¨åˆ†çš„ç»“æ„åˆæœ‰ä¸€å®šå˜åŒ–ã€‚è­¬å¦‚ï¼Œå¯¹äºå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ•°æ®å­˜å‚¨å¯åˆ†ä¸ºå®æ—¶æ•°æ®å’Œå…¨é‡æ•°æ®ä¸¤éƒ¨åˆ†ï¼Œå®æ—¶æ•°æ®ç”¨äºæ•…éšœæ’æŸ¥ï¼ˆTrouble Shootingï¼‰ï¼Œå…¨é‡æ•°æ®ç”¨äºç³»ç»Ÿä¼˜åŒ–ï¼›æ•°æ®æ”¶é›†é™¤äº†æ”¯æŒå¹³å°æ— å…³å’Œå¼€å‘è¯­è¨€æ— å…³ç³»ç»Ÿçš„æ•°æ®æ”¶é›†ï¼Œè¿˜åŒ…æ‹¬å¼‚æ­¥æ•°æ®æ”¶é›†ï¼ˆéœ€è¦è·Ÿè¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œä¿è¯è°ƒç”¨çš„è¿è´¯æ€§ï¼‰ï¼Œä»¥åŠç¡®ä¿æ›´å°çš„ä¾µå…¥æ€§ï¼›æ•°æ®å±•ç¤ºåˆæ¶‰åŠåˆ°æ•°æ®æŒ–æ˜å’Œåˆ†æã€‚è™½ç„¶æ¯ä¸€éƒ¨åˆ†éƒ½å¯èƒ½å˜å¾—å¾ˆå¤æ‚ï¼Œä½†åŸºæœ¬åŸç†éƒ½ç±»ä¼¼ã€‚ æœåŠ¡è¿½è¸ªçš„è¿½è¸ªå•å…ƒæ˜¯ä»å®¢æˆ·å‘èµ·è¯·æ±‚ï¼ˆrequestï¼‰æŠµè¾¾è¢«è¿½è¸ªç³»ç»Ÿçš„è¾¹ç•Œå¼€å§‹ï¼Œåˆ°è¢«è¿½è¸ªç³»ç»Ÿå‘å®¢æˆ·è¿”å›å“åº”ï¼ˆresponseï¼‰ä¸ºæ­¢çš„è¿‡ç¨‹ï¼Œç§°ä¸ºä¸€ä¸ªtraceã€‚æ¯ä¸ª trace ä¸­ä¼šè°ƒç”¨è‹¥å¹²ä¸ªæœåŠ¡ï¼Œä¸ºäº†è®°å½•è°ƒç”¨äº†å“ªäº›æœåŠ¡ï¼Œä»¥åŠæ¯æ¬¡è°ƒç”¨çš„æ¶ˆè€—æ—¶é—´ç­‰ä¿¡æ¯ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨æœåŠ¡æ—¶ï¼ŒåŸ‹å…¥ä¸€ä¸ªè°ƒç”¨è®°å½•ï¼Œç§°ä¸ºä¸€ä¸ªspanã€‚è¿™æ ·ï¼Œè‹¥å¹²ä¸ªæœ‰åºçš„ span å°±ç»„æˆäº†ä¸€ä¸ª traceã€‚åœ¨ç³»ç»Ÿå‘å¤–ç•Œæä¾›æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸æ–­åœ°æœ‰è¯·æ±‚å’Œå“åº”å‘ç”Ÿï¼Œä¹Ÿå°±ä¼šä¸æ–­ç”Ÿæˆ traceï¼ŒæŠŠè¿™äº›å¸¦æœ‰span çš„ trace è®°å½•ä¸‹æ¥ï¼Œå°±å¯ä»¥æç»˜å‡ºä¸€å¹…ç³»ç»Ÿçš„æœåŠ¡æ‹“æ‰‘å›¾ã€‚é™„å¸¦ä¸Š span ä¸­çš„å“åº”æ—¶é—´ï¼Œä»¥åŠè¯·æ±‚æˆåŠŸä¸å¦ç­‰ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨å‘ç”Ÿé—®é¢˜çš„æ—¶å€™ï¼Œæ‰¾åˆ°å¼‚å¸¸çš„æœåŠ¡ï¼›æ ¹æ®å†å²æ•°æ®ï¼Œè¿˜å¯ä»¥ä»ç³»ç»Ÿæ•´ä½“å±‚é¢åˆ†æå‡ºå“ªé‡Œæ€§èƒ½å·®ï¼Œå®šä½æ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ã€‚ Spring Cloud Sleuthä¸ºæœåŠ¡ä¹‹é—´è°ƒç”¨æä¾›é“¾è·¯è¿½è¸ªã€‚é€šè¿‡Sleuthå¯ä»¥å¾ˆæ¸…æ¥šçš„äº†è§£åˆ°ä¸€ä¸ªæœåŠ¡è¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡å¤„ç†èŠ±è´¹äº†å¤šé•¿ã€‚ä»è€Œè®©æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç†æ¸…å„å¾®æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»ã€‚æ­¤å¤–Sleuthå¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼š è€—æ—¶åˆ†æ: é€šè¿‡Sleuthå¯ä»¥å¾ˆæ–¹ä¾¿çš„äº†è§£åˆ°æ¯ä¸ªé‡‡æ ·è¯·æ±‚çš„è€—æ—¶ï¼Œä»è€Œåˆ†æå‡ºå“ªäº›æœåŠ¡è°ƒç”¨æ¯”è¾ƒè€—æ—¶; å¯è§†åŒ–é”™è¯¯: å¯¹äºç¨‹åºæœªæ•æ‰çš„å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡é›†æˆZipkinæœåŠ¡ç•Œé¢ä¸Šçœ‹åˆ°; é“¾è·¯ä¼˜åŒ–: å¯¹äºè°ƒç”¨æ¯”è¾ƒé¢‘ç¹çš„æœåŠ¡ï¼Œå¯ä»¥é’ˆå¯¹è¿™äº›æœåŠ¡å®æ–½ä¸€äº›ä¼˜åŒ–æªæ–½ã€‚ spring cloud sleuthå¯ä»¥ç»“åˆzipkinï¼Œå°†ä¿¡æ¯å‘é€åˆ°zipkinï¼Œåˆ©ç”¨zipkinçš„å­˜å‚¨æ¥å­˜å‚¨ä¿¡æ¯ï¼Œåˆ©ç”¨zipkin uiæ¥å±•ç¤ºæ•°æ®ã€‚ è¿™æ˜¯Spring Cloud Sleuthçš„æ¦‚å¿µå›¾ï¼š - ZipKinZipkin æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”±Twitterå…¬å¸å¼€æºï¼Œå®ƒè‡´åŠ›äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚ æ¯ä¸ªæœåŠ¡å‘zipkinæŠ¥å‘Šè®¡æ—¶æ•°æ®ï¼Œzipkinä¼šæ ¹æ®è°ƒç”¨å…³ç³»é€šè¿‡Zipkin UIç”Ÿæˆä¾èµ–å…³ç³»å›¾ï¼Œæ˜¾ç¤ºäº†å¤šå°‘è·Ÿè¸ªè¯·æ±‚é€šè¿‡æ¯ä¸ªæœåŠ¡ï¼Œè¯¥ç³»ç»Ÿè®©å¼€å‘è€…å¯é€šè¿‡ä¸€ä¸ª Web å‰ç«¯è½»æ¾çš„æ”¶é›†å’Œåˆ†ææ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·æ¯æ¬¡è¯·æ±‚æœåŠ¡çš„å¤„ç†æ—¶é—´ç­‰ï¼Œå¯æ–¹ä¾¿çš„ç›‘æµ‹ç³»ç»Ÿä¸­å­˜åœ¨çš„ç“¶é¢ˆã€‚ Zipkinæä¾›äº†å¯æ’æ‹”æ•°æ®å­˜å‚¨æ–¹å¼ï¼šIn-Memoryã€MySqlã€Cassandraä»¥åŠElasticsearchã€‚ å®è·µZipkin åˆ†ä¸ºä¸¤ç«¯ï¼Œä¸€ä¸ªæ˜¯ Zipkin æœåŠ¡ç«¯ï¼Œä¸€ä¸ªæ˜¯ Zipkin å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯å¾®æœåŠ¡çš„åº”ç”¨ã€‚å®¢æˆ·ç«¯ä¼šé…ç½®æœåŠ¡ç«¯çš„ URL åœ°å€ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡é—´çš„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè¢«é…ç½®åœ¨å¾®æœåŠ¡é‡Œé¢çš„ Sleuth çš„ç›‘å¬å™¨ç›‘å¬ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ Trace å’Œ Span ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚å‘é€çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ HTTP æŠ¥æ–‡çš„æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ¶ˆæ¯æ€»çº¿çš„æ–¹å¼å¦‚ RabbitMQã€‚ å‡†å¤‡å·¥ä½œæ— è®ºæ˜¯ç”¨HTTPçš„æ–¹å¼è¿˜æ˜¯æ¶ˆæ¯æ€»çº¿çš„æ–¹å¼ï¼Œéƒ½éœ€è¦ï¼š ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨ä¹‹å‰çš„å°±è¡Œ ä¸€ä¸ªZipkinæœåŠ¡ç«¯ ä¸¤ä¸ªå¾®æœåŠ¡åº”ç”¨ï¼Œtrace-aå’Œtrace-bï¼Œå…¶ä¸­trace-aä¸­æœ‰ä¸€ä¸ª REST æ¥å£/trace-aï¼Œè°ƒç”¨è¯¥æ¥å£åå°†è§¦å‘å¯¹trace-båº”ç”¨çš„è°ƒç”¨ã€‚ ZipkinæœåŠ¡ç«¯ä½¿ç”¨Dockerï¼š pull image docker pull openzipkin/zipkin run container docker run -d -p 9411:9411 openzipkin/zipkin å¯åŠ¨åï¼Œè®¿é—®http://localhost:9411/zipkin/å°±èƒ½çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š - æœåŠ¡ç«¯OKã€‚ å¾®æœåŠ¡åº”ç”¨åˆ›å»ºä¸¤ä¸ªåŸºæœ¬çš„Spring Bootå·¥ç¨‹ï¼Œåˆ†åˆ«åä¸ºtrace-aå’Œtrace-bã€‚ pomé…ç½®ä¸¤ä¸ªå·¥ç¨‹çš„pomæ–‡ä»¶é…ç½®éƒ½å¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; é…ç½®æ–‡ä»¶ä¸¤è€…çš„é…ç½®æ–‡ä»¶ä¹Ÿä¸€æ ·ï¼ˆé™¤äº†spring. application.nameå’Œserver.portï¼Œè‡ªè¡Œä¿®æ”¹ï¼‰ spring: application: name: trace-a sleuth: web: client: enabled: true sampler: probability: 1.0 # å°†é‡‡æ ·æ¯”ä¾‹è®¾ç½®ä¸º 1.0ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨éƒ½éœ€è¦ã€‚é»˜è®¤æ˜¯ 0.1 zipkin: base-url: http://localhost:9411/ # æŒ‡å®šäº† Zipkin æœåŠ¡å™¨çš„åœ°å€server: port: 28092eureka: client: service-url: defaultZone: http://localhost:28081/eureka/ Spring Cloud Sleuth æœ‰ä¸€ä¸ª Sampler ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå®ç°ç±»æ¥æ§åˆ¶é‡‡æ ·ç®—æ³•ã€‚é‡‡æ ·å™¨ä¸ä¼šé˜»ç¢ span ç›¸å…³ id çš„äº§ç”Ÿï¼Œä½†æ˜¯ä¼šå¯¹å¯¼å‡ºä»¥åŠé™„åŠ äº‹ä»¶æ ‡ç­¾çš„ç›¸å…³æ“ä½œé€ æˆå½±å“ã€‚ Sleuth é»˜è®¤é‡‡æ ·ç®—æ³•çš„å®ç°æ˜¯ Reservoir samplingï¼Œå…·ä½“çš„å®ç°ç±»æ˜¯ PercentageBasedSamplerï¼Œé»˜è®¤çš„é‡‡æ ·æ¯”ä¾‹ä¸º: 0.1(å³ 10%)ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡spring.sleuth.sampler.percentageæ¥è®¾ç½®ï¼Œæ‰€è®¾ç½®çš„å€¼ä»‹äº 0.0 åˆ° 1.0 ä¹‹é—´ï¼Œ1.0 åˆ™è¡¨ç¤ºå…¨éƒ¨é‡‡é›†ã€‚ ç¼–ç å¯¹trace-aå’Œtrace-bè¿›è¡Œç¼–ç ã€‚ trace-aé…ç½®ä¸€ä¸ªWebClient Beanï¼š @SpringBootApplicationpublic class TraceAApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(TraceAApplication.class, args); &#125; @Autowired private LoadBalancerExchangeFilterFunction lbFunction; @Bean public WebClient webClient() &#123; return WebClient.builder() .baseUrl(&quot;http://trace-b&quot;) .filter(lbFunction).build(); &#125;&#125; åˆ›å»ºä¸€ä¸ªTraceAControllerï¼š @RestControllerpublic class TraceAController &#123; @Autowired private WebClient webClient; @GetMapping(&quot;/trace-a&quot;) public Mono&lt;String&gt; trace() &#123; System.out.println(&quot;call trace-a.&quot;); return webClient.get().uri(&quot;/trace-b&quot;) .retrieve().bodyToMono(String.class); &#125;&#125; trace-btrace-bçš„å¯åŠ¨ç±»å¦‚ä¸‹ï¼Œä½¿ç”¨é»˜è®¤çš„ä»£ç ï¼Œä¸éœ€ä¿®æ”¹ï¼š @SpringBootApplicationpublic class TraceBApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(TraceBApplication.class, args); &#125;&#125; åˆ›å»ºä¸€ä¸ªTraceBControllerï¼š @RestControllerpublic class TraceBController &#123; @GetMapping(&quot;/trace-b&quot;) public Mono&lt;String&gt; trace() &#123; System.out.println(&quot;call trace-b.&quot;); return Mono.just(&quot;Trace.&quot;); &#125;&#125; è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚*Spring åº”ç”¨åœ¨ç›‘æµ‹åˆ° classpath ä¸­æœ‰ Sleuth å’Œ Zipkin åï¼Œä¼šè‡ªåŠ¨åœ¨ WebClientï¼ˆæˆ– RestTemplateï¼‰çš„è°ƒç”¨è¿‡ç¨‹ä¸­å‘ HTTP è¯·æ±‚æ³¨å…¥è¿½è¸ªä¿¡æ¯ï¼Œå¹¶å‘ Zipkin Server å‘é€è¿™äº›ä¿¡æ¯ã€‚* éªŒè¯åˆ†åˆ«å¯åŠ¨æœåŠ¡æ³¨å†Œä¸­å¿ƒã€trace-aå’Œtrace-bï¼Œè®¿é—®http://localhost:28092/trace-aï¼Œå¯ä»¥å¾—åˆ°è¿”å›å€¼Trace.ï¼ŒåŒæ—¶åœ¨ä¸¤ä¸ªå·¥ç¨‹çš„æ§åˆ¶å°éƒ½èƒ½çœ‹åˆ°ç›¸å…³æ—¥å¿—è¾“å‡ºï¼š # trace-aå·¥ç¨‹æ§åˆ¶å°call trace-a.# trace-bå·¥ç¨‹æ§åˆ¶å°call trace-b. è®¿é—®http://localhost:9411ï¼Œç‚¹å‡»Find Tracesçœ‹åˆ°æœ‰ä¸€æ¡è®°å½•ï¼š - ç‚¹å‡»è¿›å»å¯ä»¥çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ï¼š - æ¶ˆæ¯æ€»çº¿-RabbitMQæ–¹å¼Zipkin ä¸å†æ¨èæˆ‘ä»¬æ¥è‡ªå®šä¹‰ Server ç«¯äº†ï¼Œæ‰€ä»¥åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Spring Cloud ä¾èµ–ç®¡ç†é‡Œå·²ç»æ‰¾ä¸åˆ° zipkin-server äº†ã€‚ é€šè¿‡ç¯å¢ƒå˜é‡è®©Zipkinä»RabbitMQä¸­è¯»å–ä¿¡æ¯ï¼š RABBIT_ADDRESSES=localhost java -jar zipkin.jar å…³äº Zipkin çš„ Client ç«¯ï¼Œä¹Ÿå°±æ˜¯å¾®æœåŠ¡åº”ç”¨ï¼Œæˆ‘ä»¬å°±åœ¨ä¹‹å‰ trace-aã€trace-b çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼Œåªè¦åœ¨ä»–ä»¬çš„ä¾èµ–é‡Œéƒ½å¼•å…¥spring-cloud-stream-binder-rabbitå°±å¥½äº†ï¼Œåˆ«çš„ä¸ç”¨æ”¹ã€‚ &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-stream-binder-rabbit&lt;/artifactId&gt;&lt;/dependency&gt; å‚è€ƒ åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ª Sleuth ä¸ Zipkinã€Finchley ç‰ˆã€‘ ä½¿ç”¨Spring Cloud Sleuthå’ŒZipkinè¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ª","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆæœåŠ¡ç½‘å…³zuulï¼‰","date":"2019-01-03T02:00:46.000Z","path":"2019/01/03/d3f1148e.html","text":"API GatewayAPI Gatewayæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼šhttp://dockone.io/article/482ã€‚ API Gatewayæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯è¿›å…¥ç³»ç»Ÿçš„å”¯ä¸€èŠ‚ç‚¹ã€‚è¿™è·Ÿé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ä¸­çš„Facadeæ¨¡å¼å¾ˆåƒã€‚API Gatewayå°è£…å†…éƒ¨ç³»ç»Ÿçš„æ¶æ„ï¼Œå¹¶ä¸”æä¾›APIç»™å„ä¸ªå®¢æˆ·ç«¯ã€‚å®ƒè¿˜å¯èƒ½æœ‰å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æˆæƒã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡å’Œç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰ã€‚ API Gatewayè´Ÿè´£è¯·æ±‚è½¬å‘ã€åˆæˆå’Œåè®®è½¬æ¢ã€‚æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½è¦å…ˆç»è¿‡API Gatewayï¼Œç„¶åè·¯ç”±è¿™äº›è¯·æ±‚åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚API Gatewayå°†ç»å¸¸é€šè¿‡è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚ä»¥åŠèšåˆå¤šä¸ªæœåŠ¡çš„ç»“æœã€‚å®ƒå¯ä»¥åœ¨webåè®®ä¸å†…éƒ¨ä½¿ç”¨çš„éWebå‹å¥½å‹åè®®é—´è¿›è¡Œè½¬æ¢ï¼Œå¦‚HTTPåè®®ã€WebSocketåè®®ã€‚ API Gatewayå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„APIã€‚å®ƒæš´éœ²ä¸€ä¸ªç²—ç²’åº¦APIç»™ç§»åŠ¨å®¢æˆ·ç«¯ã€‚ä»¥äº§å“æœ€ç»ˆé¡µè¿™ä¸ªä½¿ç”¨åœºæ™¯ä¸ºä¾‹ã€‚API Gatewayæä¾›ä¸€ä¸ªæœåŠ¡æä¾›ç‚¹ï¼ˆ/productdetails?productid=xxxï¼‰ä½¿å¾—ç§»åŠ¨å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ£€ç´¢åˆ°äº§å“æœ€ç»ˆé¡µçš„å…¨éƒ¨æ•°æ®ã€‚API Gatewayé€šè¿‡è°ƒç”¨å¤šä¸ªæœåŠ¡æ¥å¤„ç†è¿™ä¸€ä¸ªè¯·æ±‚å¹¶è¿”å›ç»“æœï¼Œæ¶‰åŠäº§å“ä¿¡æ¯ã€æ¨èã€è¯„è®ºç­‰ã€‚ ä¸€ä¸ªå¾ˆå¥½çš„API Gatewayä¾‹å­æ˜¯Netfix API Gatewayã€‚NetflixæµæœåŠ¡æä¾›æ•°ç™¾ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼ŒåŒ…æ‹¬ç”µè§†ã€æœºé¡¶ç›’ã€æ™ºèƒ½æ‰‹æœºã€æ¸¸æˆç³»ç»Ÿã€å¹³æ¿ç”µè„‘ç­‰ã€‚èµ·åˆï¼ŒNetflixè§†å›¾æä¾›ä¸€ä¸ªé€‚ç”¨å…¨åœºæ™¯çš„APIã€‚ä½†æ˜¯ï¼Œä»–ä»¬å‘ç°è¿™ç§å½¢å¼ä¸å¥½ç”¨ï¼Œå› ä¸ºæ¶‰åŠåˆ°å„å¼å„æ ·çš„è®¾å¤‡ä»¥åŠå®ƒä»¬ç‹¬ç‰¹çš„éœ€æ±‚ã€‚ç°åœ¨ï¼Œä»–ä»¬é‡‡ç”¨ä¸€ä¸ªAPI Gatewayæ¥æä¾›å®¹é”™æ€§é«˜çš„APIï¼Œé’ˆå¯¹ä¸åŒç±»å‹è®¾å¤‡æœ‰ç›¸åº”ä»£ç ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªé€‚é…å™¨å¤„ç†ä¸€ä¸ªè¯·æ±‚å¹³å‡è¦è°ƒç”¨6åˆ°8ä¸ªåç«¯æœåŠ¡ã€‚Netflix API Gatewayæ¯å¤©å¤„ç†æ•°åäº¿çš„è¯·æ±‚ã€‚ API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹å¦‚ä½ æ‰€æ–™ï¼Œé‡‡ç”¨API Gatewayä¹Ÿæ˜¯ä¼˜ç¼ºç‚¹å¹¶å­˜çš„ã€‚API Gatewayçš„ä¸€ä¸ªæœ€å¤§å¥½å¤„æ˜¯å°è£…åº”ç”¨å†…éƒ¨ç»“æ„ã€‚ç›¸æ¯”èµ·æ¥è°ƒç”¨æŒ‡å®šçš„æœåŠ¡ï¼Œå®¢æˆ·ç«¯ç›´æ¥è·Ÿgatwayäº¤äº’æ›´ç®€å•ç‚¹ã€‚API Gatewayæä¾›ç»™æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªç‰¹å®šAPIï¼Œè¿™æ ·å‡å°‘äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡æ¬¡æ•°ï¼Œä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚ API Gatewayä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„ç»„ä»¶ï¼Œå¿…é¡»è¦å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒå¯èƒ½æˆä¸ºå¼€å‘çš„ä¸€ä¸ªç“¶é¢ˆã€‚å¼€å‘è€…å¿…é¡»æ›´æ–°API Gatewayæ¥æä¾›æ–°æœåŠ¡æä¾›ç‚¹æ¥æ”¯æŒæ–°æš´éœ²çš„å¾®æœåŠ¡ã€‚æ›´æ–°API Gatewayæ—¶å¿…é¡»è¶Šè½»é‡çº§è¶Šå¥½ã€‚å¦åˆ™ï¼Œå¼€å‘è€…å°†å› ä¸ºæ›´æ–°Gatewayè€Œæ’é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œé™¤äº†è¿™äº›ç¼ºç‚¹ï¼Œå¯¹äºå¤§éƒ¨åˆ†çš„åº”ç”¨ï¼Œé‡‡ç”¨API Gatewayçš„æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ ä½¿ç”¨API Gatewayåï¼Œå®¢æˆ·ç«¯å’Œå¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œå›¾å˜æˆä¸‹å›¾ï¼š é€šè¿‡API Gatewayï¼Œå¯ä»¥ç»Ÿä¸€å‘å¤–éƒ¨ç³»ç»Ÿæä¾›REST APIã€‚Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ ZuulNetflixå¼€æºçš„å¾®æœåŠ¡ç½‘å…³ï¼Œæ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—è¿‡æ»¤å™¨ï¼š èº«ä»½è®¤è¯å®‰å…¨ å®¡æŸ¥ä¸ç›‘æ§ åŠ¨æ€è·¯ç”± å‹åŠ›æµ‹è¯• é™„å†åˆ†é… é™æ€å“åº”å¤„ç† å¤šåŒºåŸŸå¼¹æ€§ Zuulè¿‡æ»¤å™¨Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ä¸»è¦ä¸º4ç§æ ‡å‡†ç±»å‹ï¼š PREï¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ ROUTINGï¼šè¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡ POSTï¼šåœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œ ERRORï¼šåœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶è‡ªä¿¡è¯¥è¿‡æ»¤å™¨ Spring Cloud ZuulSpring Cloud Zuulè·¯ç”±æ˜¯å¾®æœåŠ¡æ¶æ„çš„ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œæä¾›åŠ¨æ€è·¯ç”±ï¼Œç›‘æ§ï¼Œå¼¹æ€§ï¼Œå®‰å…¨ç­‰çš„è¾¹ç¼˜æœåŠ¡ã€‚Zuulæ˜¯Netflixå‡ºå“çš„ä¸€ä¸ªåŸºäºJVMè·¯ç”±å’ŒæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡å™¨ã€‚ å‡†å¤‡å·¥ä½œæ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œå‘½åä¸ºï¼šapi-gatewayï¼Œ POMé…ç½®åœ¨pom.xmlä¸­å¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;com.cayzlh&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-demos-parent&lt;/artifactId&gt; &lt;version&gt;0.0.1&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;artifactId&gt;api-gateway&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;api-gateway&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; é…ç½®æ–‡ä»¶åœ¨é…ç½®æ–‡ä»¶ application.yml ä¸­åŠ å…¥æœåŠ¡åã€ç«¯å£å·ã€Eureka æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼š spring: application: name: api-gatewayserver: port: 28091eureka: client: service-url: defaultZone: http://localhost:28081/eureka/ å¯åŠ¨ç±»ä½¿ç”¨@EnableZuulProxyæ³¨è§£å¼€å¯ZuulåŠŸèƒ½ï¼š @EnableZuulProxy@SpringBootApplicationpublic class ApiGatewayApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ApiGatewayApplication.class, args); &#125;&#125; è‡³æ­¤ï¼Œä¸€ä¸ªåŸºäºSpring Cloud Zuulçš„æœåŠ¡ç½‘å…³å°±å·²ç»æ„å»ºå®Œæˆã€‚åˆ†åˆ«å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç”Ÿäº§è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€API-GATEWAYï¼š å¯åŠ¨å®Œæˆåï¼Œè®¿é—®http://localhost:208081ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ç»“æœã€‚ æµ‹è¯•ç”±äº Spring Cloud Zuul åœ¨æ•´åˆäº† Eureka ä¹‹åï¼Œå…·å¤‡é»˜è®¤çš„æœåŠ¡è·¯ç”±åŠŸèƒ½ï¼Œå³ï¼šå½“æˆ‘ä»¬è¿™é‡Œæ„å»ºçš„api-gatewayåº”ç”¨å¯åŠ¨å¹¶æ³¨å†Œåˆ° Eureka ä¹‹åï¼ŒæœåŠ¡ç½‘å…³ä¼šå‘ç°ä¸Šé¢æˆ‘ä»¬å¯åŠ¨çš„ä¸¤ä¸ªæœåŠ¡producerå’Œconsumerï¼Œè¿™æ—¶å€™ Zuul å°±ä¼šåˆ›å»ºä¸¤ä¸ªè·¯ç”±è§„åˆ™ã€‚æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å¤–éƒ¨è¯·æ±‚çš„åŒ¹é…è§„åˆ™ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯è·¯ç”±çš„æœåŠ¡ IDã€‚é’ˆå¯¹å½“å‰ç¤ºä¾‹çš„æƒ…å†µï¼ŒZuul ä¼šåˆ›å»ºä¸‹é¢çš„ä¸¤ä¸ªè·¯ç”±è§„åˆ™ï¼š è½¬å‘åˆ°eureka-produceræœåŠ¡çš„è¯·æ±‚è§„åˆ™ä¸ºï¼š/eureka-producer/** è½¬å‘åˆ°eureka-consumeræœåŠ¡çš„è¯·æ±‚è§„åˆ™ä¸ºï¼š/eureka-consumer/** æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®28091ç«¯å£çš„æœåŠ¡ç½‘å…³æ¥éªŒè¯ä¸Šè¿°è·¯ç”±çš„æ­£ç¡®æ€§ï¼š æ¯”å¦‚è®¿é—®ï¼šhttp://localhost:28091/eureka-consumer/hello/zhangsanï¼Œè¯¥è¯·æ±‚å°†æœ€ç»ˆè¢«è·¯ç”±åˆ°consumerçš„/helloæ¥å£ä¸Šï¼š ä»¥ä¸Šç»“æœè¯´æ˜zuulå·²ç»å¼€å§‹ç”Ÿæ•ˆäº†ã€‚ è¿‡æ»¤å™¨Zuulè¿˜æœ‰æ›´å¤šçš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ï¼šé‰´æƒã€æµé‡è½¬å‘ã€è¯·æ±‚ç»Ÿè®¡ç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¯ä»¥ä½¿ç”¨Zuulæ¥å®ç°ã€‚ Zuulçš„æ ¸å¿ƒFilteræ˜¯Zuulçš„æ ¸å¿ƒï¼Œç”¨æ¥å®ç°å¯¹å¤–æœåŠ¡çš„æ§åˆ¶ã€‚Filterçš„ç”Ÿå‘½å‘¨æœŸæœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯PREã€ROUTINGã€POSTã€ERRORï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š Zuulå¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯é€šè¿‡è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œè¿™äº›è¿‡æ»¤å™¨ç±»å‹å¯¹åº”äºè¯·æ±‚çš„å…¸å‹ç”Ÿå‘½å‘¨æœŸã€‚ PREï¼š è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚ ROUTINGï¼šè¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡ã€‚è¿™ç§è¿‡æ»¤å™¨ç”¨äºæ„å»ºå‘é€ç»™å¾®æœåŠ¡çš„è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨Apache HttpClientæˆ–Netfilx Ribbonè¯·æ±‚å¾®æœåŠ¡ã€‚ POSTï¼šè¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚ ERRORï¼šåœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶æ‰§è¡Œè¯¥è¿‡æ»¤å™¨ã€‚ é™¤äº†é»˜è®¤çš„è¿‡æ»¤å™¨ç±»å‹ï¼ŒZuulè¿˜å…è®¸æˆ‘ä»¬åˆ›å»ºè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ä¸€ç§STATICç±»å‹çš„è¿‡æ»¤å™¨ï¼Œç›´æ¥åœ¨Zuulä¸­ç”Ÿæˆå“åº”ï¼Œè€Œä¸å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ã€‚ Zuulä¸­é»˜è®¤å®ç°çš„Filter ç±»å‹ é¡ºåº è¿‡æ»¤å™¨ åŠŸèƒ½ pre -3 ServletDetectionFilter æ ‡è®°å¤„ç†Servletçš„ç±»å‹ pre -2 Servlet30WrapperFilter åŒ…è£…HttpServletRequestè¯·æ±‚ pre -1 FormBodyWrapperFilter åŒ…è£…è¯·æ±‚ä½“ route 1 DebugFilter æ ‡è®°è°ƒè¯•æ ‡å¿— route 5 PreDecorationFilter å¤„ç†è¯·æ±‚ä¸Šä¸‹æ–‡ä¾›åç»­ä½¿ç”¨ route 10 RibbonRoutingFilter serviceIdè¯·æ±‚è½¬å‘ route 100 SimpleHostRoutingFilter urlè¯·æ±‚è½¬å‘ route 500 SendForwardFilter forwardè¯·æ±‚è½¬å‘ post 0 SendErrorFilter å¤„ç†æœ‰é”™è¯¯çš„è¯·æ±‚å“åº” post 1000 SendResponseFilter å¤„ç†æ­£å¸¸çš„è¯·æ±‚å“åº” - ç¦ç”¨æŒ‡å®šçš„Filterå¯ä»¥åœ¨application.xmlä¸­é…ç½®éœ€è¦ç¦ç”¨çš„filterï¼Œä»¥zuul.&lt;SimpleClassName&gt;.&lt;filterType&gt;.disable=trueè¿™æ ·çš„æ ¼å¼é…ç½®ï¼Œæ¯”å¦‚è¦ç¦ç”¨org.springframework.cloud.netflix.zuul.filters.post.SendResponseFilterå°±è®¾ç½®ï¼š zuul: SendResponseFilter: post: disable: true è‡ªå®šä¹‰Filteræˆ‘ä»¬å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå› ä¸ºæœåŠ¡ç½‘å…³åº”å¯¹çš„æ˜¯å¤–éƒ¨çš„æ‰€æœ‰è¯·æ±‚ï¼Œä¸ºäº†é¿å…äº§ç”Ÿå®‰å…¨éšæ‚£ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¯·æ±‚åšä¸€å®šçš„é™åˆ¶ï¼Œæ¯”å¦‚è¯·æ±‚ä¸­å«æœ‰ Token ä¾¿è®©è¯·æ±‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œå¦‚æœè¯·æ±‚ä¸å¸¦ Token å°±ç›´æ¥è¿”å›å¹¶ç»™å‡ºæç¤ºã€‚ é¦–å…ˆè‡ªå®šä¹‰ä¸€ä¸ª Filterï¼Œç»§æ‰¿ ZuulFilter æŠ½è±¡ç±»ï¼Œåœ¨ run() æ–¹æ³•ä¸­éªŒè¯å‚æ•°æ˜¯å¦å«æœ‰ Tokenï¼Œå…·ä½“å¦‚ä¸‹ï¼š public class TokenFilter extends ZuulFilter &#123; /** * è¿‡æ»¤å™¨çš„ç±»å‹ï¼Œå®ƒå†³å®šè¿‡æ»¤å™¨åœ¨è¯·æ±‚çš„å“ªä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œã€‚ * è¿™é‡Œå®šä¹‰ä¸ºpreï¼Œä»£è¡¨ä¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œã€‚ * * @return */ @Override public String filterType() &#123; return &quot;pre&quot;; &#125; /** * filteræ‰§è¡Œé¡ºåºï¼Œé€šè¿‡æ•°å­—æŒ‡å®šã€‚ * æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚ * * @return */ @Override public int filterOrder() &#123; return 0; &#125; /** * åˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥è¿”å›äº†trueï¼Œå› æ­¤è¯¥è¿‡æ»¤å™¨å¯¹æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”Ÿæ•ˆã€‚ * å®é™…è¿ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ¥æŒ‡å®šè¿‡æ»¤å™¨çš„æœ‰æ•ˆèŒƒå›´ã€‚ * * @return */ @Override public boolean shouldFilter() &#123; return true; &#125; /** * è¿‡æ»¤å™¨çš„å…·ä½“é€»è¾‘ * * @return */ @Override public Object run() &#123; RequestContext ctx = RequestContext.getCurrentContext(); HttpServletRequest request = ctx.getRequest(); String token = request.getParameter(&quot;token&quot;); if (token == null || token.isEmpty()) &#123; ctx.setSendZuulResponse(false); ctx.setResponseStatusCode(401); ctx.setResponseBody(&quot;token is empty&quot;); &#125; return null; &#125;&#125; åœ¨ä¸Šé¢å®ç°çš„è¿‡æ»¤å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç»§æ‰¿ZuulFilteræŠ½è±¡ç±»å¹¶é‡å†™äº†ä¸‹é¢çš„å››ä¸ªæ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ã€‚è¿™å››ä¸ªæ–¹æ³•åˆ†åˆ«å®šä¹‰äº†ï¼š filterType()ï¼šè¿‡æ»¤å™¨çš„ç±»å‹ï¼Œå®ƒå†³å®šè¿‡æ»¤å™¨åœ¨è¯·æ±‚çš„å“ªä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œã€‚è¿™é‡Œå®šä¹‰ä¸ºpreï¼Œä»£è¡¨ä¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œã€‚ filterOrder()ï¼šè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºã€‚å½“è¯·æ±‚åœ¨ä¸€ä¸ªé˜¶æ®µä¸­å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨æ—¶ï¼Œéœ€è¦æ ¹æ®è¯¥æ–¹æ³•è¿”å›çš„å€¼æ¥ä¾æ¬¡æ‰§è¡Œã€‚é€šè¿‡æ•°å­—æŒ‡å®šï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚ shouldFilter()ï¼šåˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦è¢«æ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥è¿”å›äº†trueï¼Œå› æ­¤è¯¥è¿‡æ»¤å™¨å¯¹æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”Ÿæ•ˆã€‚å®é™…è¿ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ¥æŒ‡å®šè¿‡æ»¤å™¨çš„æœ‰æ•ˆèŒƒå›´ã€‚ run()ï¼šè¿‡æ»¤å™¨çš„å…·ä½“é€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡ctx.setSendZuulResponse(false)ä»¤ Zuul è¿‡æ»¤è¯¥è¯·æ±‚ï¼Œä¸å¯¹å…¶è¿›è¡Œè·¯ç”±ï¼Œç„¶åé€šè¿‡ctx.setResponseStatusCode(401)è®¾ç½®äº†å…¶è¿”å›çš„é”™è¯¯ç ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æˆ‘ä»¬çš„è¿”å›ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡ctx.setResponseBody(body)å¯¹è¿”å› body å†…å®¹è¿›è¡Œç¼–è¾‘ç­‰ã€‚ åœ¨å®ç°äº†è‡ªå®šä¹‰è¿‡æ»¤å™¨ä¹‹åï¼Œå®ƒå¹¶ä¸ä¼šç›´æ¥ç”Ÿæ•ˆï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸ºå…¶åˆ›å»ºå…·ä½“çš„ Bean æ‰èƒ½å¯åŠ¨è¯¥è¿‡æ»¤å™¨ï¼Œæ¯”å¦‚ï¼Œåœ¨åº”ç”¨ä¸»ç±»ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹ï¼š @EnableZuulProxy@SpringBootApplicationpublic class ApiGatewayApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ApiGatewayApplication.class, args); &#125; @Bean public TokenFilter tokenFilter() &#123; return new TokenFilter(); &#125;&#125; åœ¨å¯¹api-gatewayæœåŠ¡å®Œæˆäº†ä¸Šé¢çš„æ”¹é€ ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¯åŠ¨å®ƒï¼Œå¹¶å‘èµ·ä¸‹é¢çš„è¯·æ±‚ï¼Œå¯¹ä¸Šé¢å®šä¹‰çš„è¿‡æ»¤å™¨åšä¸€ä¸ªéªŒè¯ï¼š è®¿é—® http://localhost:14000/eureka-consumer/hello/zhangsan è¿”å› 401 é”™è¯¯å’Œtoken is empty è®¿é—® http://localhost:14000/eureka-consumer/hello/zhangsan?token=token æ­£ç¡®è·¯ç”±åˆ°eureka-consumerçš„/helloæ¥å£ï¼Œå¹¶è¿”å›Hello, zhangsan!, ç°åœ¨æ—¶é—´ï¼š1546506130007 è·¯ç”±ç†”æ–­å½“æˆ‘ä»¬çš„åç«¯æœåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å°†å¼‚å¸¸æŠ›å‡ºç»™æœ€å¤–å±‚ï¼ŒæœŸæœ›æœåŠ¡å¯ä»¥è‡ªåŠ¨è¿›è¡Œä¸€é™çº§ã€‚Zuulç»™æˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ”¯æŒã€‚å½“æŸä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥è¿”å›æˆ‘ä»¬é¢„è®¾çš„ä¿¡æ¯ã€‚ æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰çš„fallbackæ–¹æ³•ï¼Œå¹¶ä¸”å°†å…¶æŒ‡å®šç»™æŸä¸ªrouteæ¥å®ç°è¯¥routeè®¿é—®å‡ºé—®é¢˜çš„ç†”æ–­å¤„ç†ã€‚ä¸»è¦ç»§æ‰¿ZuulFallbackProvideræ¥å£æ¥å®ç°ï¼ŒZuulFallbackProvideré»˜è®¤æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥æŒ‡æ˜ç†”æ–­æ‹¦æˆªå“ªä¸ªæœåŠ¡ï¼Œä¸€ä¸ªå®šåˆ¶è¿”å›å†…å®¹ã€‚ public interface ZuulFallbackProvider &#123; /** * The route this fallback will be used for. * @return The route the fallback will be used for. */ public String getRoute(); /** * Provides a fallback response. * @return The fallback response. */ public ClientHttpResponse fallbackResponse();&#125; å®ç°ç±»é€šè¿‡å®ç°getRouteæ–¹æ³•ï¼Œå‘Šè¯‰Zuulå®ƒæ˜¯è´Ÿè´£å“ªä¸ªrouteå®šä¹‰çš„ç†”æ–­ã€‚è€ŒfallbackResponseæ–¹æ³•åˆ™æ˜¯å‘Šè¯‰ Zuul æ–­è·¯å‡ºç°æ—¶ï¼Œå®ƒä¼šæä¾›ä¸€ä¸ªä»€ä¹ˆè¿”å›å€¼æ¥å¤„ç†è¯·æ±‚ã€‚ åæ¥Springåˆæ‰©å±•äº†æ­¤ç±»ï¼Œä¸°å¯Œäº†è¿”å›æ–¹å¼ï¼Œåœ¨è¿”å›çš„å†…å®¹ä¸­æ·»åŠ äº†å¼‚å¸¸ä¿¡æ¯ï¼Œå› æ­¤æœ€æ–°ç‰ˆæœ¬å»ºè®®ç›´æ¥ç»§æ‰¿ç±»FallbackProvider ã€‚ è·¯ç”±é‡è¯•æœ‰æ—¶å€™å› ä¸ºç½‘ç»œæˆ–è€…å…¶å®ƒåŸå› ï¼ŒæœåŠ¡å¯èƒ½ä¼šæš‚æ—¶çš„ä¸å¯ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›å¯ä»¥å†æ¬¡å¯¹æœåŠ¡è¿›è¡Œé‡è¯•ï¼ŒZuulä¹Ÿå¸®æˆ‘ä»¬å®ç°äº†æ­¤åŠŸèƒ½ï¼Œéœ€è¦ç»“åˆSpring Retry ä¸€èµ·æ¥å®ç°ã€‚éœ€è¦æ·»åŠ ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.retry&lt;/groupId&gt; &lt;artifactId&gt;spring-retry&lt;/artifactId&gt;&lt;/dependency&gt; å¼€å¯é‡è¯•åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚å½“å‹åŠ›è¿‡å¤§ï¼Œä¸€ä¸ªå®ä¾‹åœæ­¢å“åº”æ—¶ï¼Œè·¯ç”±å°†æµé‡è½¬åˆ°å¦ä¸€ä¸ªå®ä¾‹ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æœ€ç»ˆæ‰€æœ‰çš„å®ä¾‹å…¨è¢«å‹å®ã€‚è¯´åˆ°åº•ï¼Œæ–­è·¯å™¨çš„å…¶ä¸­ä¸€ä¸ªä½œç”¨å°±æ˜¯é˜²æ­¢æ•…éšœæˆ–è€…å‹åŠ›æ‰©æ•£ã€‚ç”¨äº†retryï¼Œæ–­è·¯å™¨å°±åªæœ‰åœ¨è¯¥æœåŠ¡çš„æ‰€æœ‰å®ä¾‹éƒ½æ— æ³•è¿ä½œçš„æƒ…å†µä¸‹æ‰èƒ½èµ·ä½œç”¨ã€‚è¿™ç§æ—¶å€™ï¼Œæ–­è·¯å™¨çš„å½¢å¼æ›´åƒæ˜¯æä¾›ä¸€ç§å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ–è€…å‡è£…æœåŠ¡æ­£å¸¸è¿è¡Œçš„å‡è±¡ç»™ä½¿ç”¨è€…ã€‚ ä¸ç”¨retryï¼Œä»…ä½¿ç”¨è´Ÿè½½å‡è¡¡å’Œç†”æ–­ï¼Œå°±å¿…é¡»è€ƒè™‘åˆ°æ˜¯å¦èƒ½å¤Ÿæ¥å—å•ä¸ªæœåŠ¡å®ä¾‹å…³é—­å’Œeurekaåˆ·æ–°æœåŠ¡åˆ—è¡¨ä¹‹é—´å¸¦æ¥çš„çŸ­æ—¶é—´çš„ç†”æ–­ã€‚å¦‚æœå¯ä»¥æ¥å—ï¼Œå°±æ— éœ€ä½¿ç”¨retryã€‚ - Zuulé«˜å¯ç”¨ä¸åŒçš„å®¢æˆ·ç«¯ä½¿ç”¨ä¸åŒçš„è´Ÿè½½å°†è¯·æ±‚åˆ†å‘åˆ°åç«¯çš„Zuulï¼ŒZuulåœ¨é€šè¿‡Eurekaè°ƒç”¨åç«¯æœåŠ¡ï¼Œæœ€åå¯¹å¤–è¾“å‡ºã€‚å› æ­¤ä¸ºäº†ä¿è¯Zuulçš„é«˜å¯ç”¨æ€§ï¼Œå‰ç«¯å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ªZuulå®ä¾‹è¿›è¡Œè´Ÿè½½ï¼Œåœ¨Zuulçš„å‰ç«¯ä½¿ç”¨Nginxæˆ–è€…F5è¿›è¡Œè´Ÿè½½è½¬å‘ä»¥è¾¾åˆ°é«˜å¯ç”¨æ€§ã€‚ å‚è€ƒ æœåŠ¡ç½‘å…³ Zuulï¼ˆè·¯ç”±ï¼‰ã€Finchley ç‰ˆã€‘ æœåŠ¡ç½‘å…³zuulåˆçº§ç¯‡ æœåŠ¡ç½‘å…³Zuulé«˜çº§ç¯‡ æœåŠ¡ç½‘å…³ Zuulï¼ˆè¿‡æ»¤å™¨ï¼‰ã€Finchley ç‰ˆã€‘","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆé…ç½®ä¸­å¿ƒå’Œæ¶ˆæ¯æ€»çº¿ï¼‰","date":"2019-01-01T01:16:17.000Z","path":"2019/01/01/b2f3c839.html","text":"åœ¨SpringCloudï¼ˆGitç‰ˆé…ç½®ä¸­å¿ƒï¼‰ä¸­æœ‰æåˆ°è¿‡ï¼Œå¦‚æœéœ€è¦å®¢æˆ·ç«¯è·å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯éœ€è¦æ‰§è¡Œrefreshï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨webhookçš„æœºåˆ¶æ¯æ¬¡æäº¤ä»£ç å‘é€è¯·æ±‚æ¥åˆ·æ–°å®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ‰§è¡Œä¸€éï¼Œè¿™ç§æ–¹æ¡ˆå°±ä¸å¤ªé€‚åˆäº†ã€‚ä½¿ç”¨Spring Cloud Buså¯ä»¥å®Œç¾è§£å†³è¿™ä¸€é—®é¢˜ã€‚ Spring Cloud BusSpring cloud busé€šè¿‡è½»é‡æ¶ˆæ¯ä»£ç†è¿æ¥å„ä¸ªåˆ†å¸ƒçš„èŠ‚ç‚¹ã€‚è¿™ä¼šç”¨åœ¨å¹¿æ’­çŠ¶æ€çš„å˜åŒ–ï¼ˆä¾‹å¦‚é…ç½®å˜åŒ–ï¼‰æˆ–è€…å…¶ä»–çš„æ¶ˆæ¯æŒ‡ä»¤ã€‚Spring busçš„ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡åˆ†å¸ƒå¼çš„å¯åŠ¨å™¨å¯¹spring bootåº”ç”¨è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å»ºç«‹ä¸€ä¸ªå¤šä¸ªåº”ç”¨ä¹‹é—´çš„é€šä¿¡é¢‘é“ã€‚ç›®å‰å”¯ä¸€å®ç°çš„æ–¹å¼æ˜¯ç”¨AMQPæ¶ˆæ¯ä»£ç†ä½œä¸ºé€šé“ï¼ŒåŒæ ·ç‰¹æ€§çš„è®¾ç½®ï¼ˆæœ‰äº›å–å†³äºé€šé“çš„è®¾ç½®ï¼‰åœ¨æ›´å¤šé€šé“çš„æ–‡æ¡£ä¸­ã€‚ Spring cloud buså¯ä»¥å°†å®ƒç†è§£ä¸ºç®¡ç†å’Œä¼ æ’­æ‰€æœ‰åˆ†å¸ƒå¼é¡¹ç›®ä¸­çš„æ¶ˆæ¯æ—¢å¯ï¼Œå…¶å®æœ¬è´¨æ˜¯åˆ©ç”¨äº†MQçš„å¹¿æ’­æœºåˆ¶åœ¨åˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ä¼ æ’­æ¶ˆæ¯ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰Kafkaå’ŒRabbitMQã€‚åˆ©ç”¨busçš„æœºåˆ¶å¯ä»¥åšå¾ˆå¤šçš„äº‹æƒ…ï¼Œå…¶ä¸­é…ç½®ä¸­å¿ƒå®¢æˆ·ç«¯åˆ·æ–°å°±æ˜¯å…¸å‹çš„åº”ç”¨åœºæ™¯ä¹‹ä¸€ï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æè¿°busåœ¨é…ç½®ä¸­å¿ƒä½¿ç”¨çš„æœºåˆ¶ã€‚ æ ¹æ®æ­¤å›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºåˆ©ç”¨Spring Cloud Busåšé…ç½®æ›´æ–°çš„æ­¥éª¤: æäº¤ä»£ç è§¦å‘postç»™å®¢æˆ·ç«¯Aå‘é€bus/refresh å®¢æˆ·ç«¯Aæ¥æ”¶åˆ°è¯·æ±‚ä»Serverç«¯æ›´æ–°é…ç½®å¹¶ä¸”å‘é€ç»™Spring Cloud Bus Spring Cloud busæ¥åˆ°æ¶ˆæ¯å¹¶é€šçŸ¥ç»™å…¶å®ƒå®¢æˆ·ç«¯ å…¶å®ƒå®¢æˆ·ç«¯æ¥æ”¶åˆ°é€šçŸ¥ï¼Œè¯·æ±‚Serverç«¯è·å–æœ€æ–°é…ç½® å…¨éƒ¨å®¢æˆ·ç«¯å‡è·å–åˆ°æœ€æ–°çš„é…ç½® RabbitMQç”±äºéœ€è¦ç”¨åˆ°MQï¼Œè¿™é‡Œä½¿ç”¨Dockerå®‰è£…RabbitMQæ¥ç”¨ä½œç¤ºä¾‹ï¼ŒDockeræ•™ç¨‹ã€‚ Dockerä¸­ä½¿ç”¨RabbitMQRabbitMQæ˜¯å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆæœ‰æ—¶ç§°ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ï¼Œå®ƒå®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰ã€‚RabbitMQæœåŠ¡å™¨é‡‡ç”¨Erlangç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼Œæ„å»ºäºOpen Telecom Platformæ¡†æ¶ä¹‹ä¸Šï¼Œç”¨äºé›†ç¾¤å’Œæ•…éšœè½¬ç§»ã€‚ä¸ä»£ç†æ¥å£çš„å®¢æˆ·ç«¯åº“å¯ç”¨äºæ‰€æœ‰ä¸»è¦ç¼–ç¨‹è¯­è¨€ã€‚ æ‹‰å–rabbitmqé•œåƒæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ‹‰å–latestç‰ˆå®˜æ–¹é•œåƒï¼š docker pull rabbitmq:management ä½¿ç”¨å¸¦ç®¡ç†ç•Œé¢çš„é•œåƒã€‚ ä½¿ç”¨é•œåƒæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä½¿ç”¨é•œåƒï¼š docker run -d --name rabbitmq --publish 5671:5671 \\ --publish 5672:5672 --publish 4369:4369 \\ --publish 25672:25672 --publish 15671:15671 --publish 15672:15672 \\rabbitmq:management å¯åŠ¨ä¹‹åè®¿é—®http://localhost:15672/èƒ½å¤Ÿçœ‹åˆ°Webç®¡ç†ç•Œé¢ï¼Œä½¿ç”¨guest / guestç™»å½•ä¹‹åçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œè¯´æ˜é•œåƒå·²ç»è¿è¡Œã€‚ å¾ˆå¥½ï¼Œ ç°åœ¨å¼€å§‹æ”¹é€ ä»£ç ã€‚ æœåŠ¡ç«¯pomé…ç½®åœ¨pom.xmlä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-bus&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-stream-binder-rabbit&lt;/artifactId&gt;&lt;/dependency&gt; ä»¥ä¸Šå››ä¸ªä¾èµ–æ˜¯å¿…é¡»çš„ é…ç½®æ–‡ä»¶ä¿®æ”¹application.ymlæ–‡ä»¶ï¼š spring: application: name: config-server cloud: config: server: git: uri: https://github.com/cayzlh/SpringCloudDemos # é…ç½®gitä»“åº“çš„åœ°å€ search-paths: config-repo # gitä»“åº“åœ°å€ä¸‹çš„ç›¸å¯¹åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œç”¨,åˆ†å‰²ã€‚ bus: enabled: true trace: enabled: trueserver: port: 28088eureka: client: service-url: defaultZone: http://localhost:28081/eureka/management: endpoints: web: exposure: include: bus-refresh ä¸»è¦å¢åŠ çš„å†…å®¹æœ‰ï¼š spring.cloud.bus.enable spring.cloud.bus.trace.enable Management.endpoints.web.exposure.include å¯åŠ¨ç±»æ·»åŠ @EnableConfigServeræ³¨è§£ï¼š @EnableDiscoveryClient@EnableConfigServer@SpringBootApplicationpublic class ConfigServerGitApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerGitApplication.class, args); &#125;&#125; å®¢æˆ·ç«¯pomé…ç½®åœ¨ pom.xml é‡Œæ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼Œå‰ 5 ä¸ªæ˜¯å¿…é¡»çš„ï¼Œæœ€åä¸€ä¸ª webflux å¯ä»¥ç”¨ web æ¥ä»£æ›¿ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-bus&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-stream-binder-rabbit&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;&lt;/dependency&gt; å¦‚æœç¼ºäº†spring-boot-starter-actuatorï¼Œå½“å¯¹æœåŠ¡ç«¯æ‰§è¡Œ/actuator/bus-refreshçš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯æ¥æ”¶ä¸åˆ°ä¿¡æ¯ã€‚ é…ç½®æ–‡ä»¶æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œapplication.xmlï¼š spring: application: name: config-client-git cloud: enabled: true bus: trace: enabled: trueserver: port: 28089management: endpoints: web: exposure: include: refresh å¯ç”¨spring cloud busï¼Œbootstrap.xmlï¼š spring: cloud: config: name: test-config profile: test label: master discovery: enabled: true service-id: config-servereureka: client: service-url: defaultZone: http://localhost:28081/eureka/ controlleråŸºæœ¬ä¸Šæ²¡æœ‰å•¥æ”¹åŠ¨ @RefreshScope@RestControllerpublic class HelloController &#123; @Value(&quot;$&#123;test.hello:error&#125;&quot;) private String profile; @GetMapping(&quot;/info&quot;) public Mono&lt;String&gt; hello() &#123; return Mono.justOrEmpty(profile); &#125;&#125; @RefreshScopeæ³¨è§£å¿…é¡»åŠ ä¸Šï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šå—åˆ°æœåŠ¡ç«¯çš„æ›´æ–°æ¶ˆæ¯ï¼Œä½†æ˜¯æ›´æ–°ä¸äº†ï¼Œå› ä¸ºä¸çŸ¥é“æ›´æ–°å“ªé‡Œçš„ã€‚ å¯åŠ¨ç±»é»˜è®¤çš„å°±å¯ä»¥ @EnableDiscoveryClient@SpringBootApplicationpublic class ConfitClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfitClientApplication.class, args); &#125;&#125; æµ‹è¯•åˆ†åˆ«å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€config-server-gitã€config-clientï¼ˆå…¶ä¸­clientåˆ†åˆ«ç”¨ä¸åŒç«¯å£å¯åŠ¨ä¸¤ä¸ªä»¥ä¸Šå®ä¾‹ï¼Œç”¨ä»¥æ¨¡æ‹Ÿå¤šä¸ªå®¢æˆ·ç«¯ï¼‰ï¼Œå¯åŠ¨åï¼ŒRabbitMQ ä¸­ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª topic ç±»å‹çš„ Exchange å’Œä¸¤ä¸ªä»¥springCloudBus.anonymous.å¼€å¤´çš„åŒ¿å Queueï¼š - - ä½¿ç”¨postmanè¯·æ±‚http://localhost:28089/infoï¼Œå¾—åˆ°ç»“æœï¼ˆå„ä¸ªç«¯å£çš„å®¢æˆ·ç«¯æ¥å£éƒ½è¯·æ±‚ï¼‰ï¼š - ä¿®æ”¹test-config-test.ymlï¼Œå°†é‡Œé¢çš„å†…å®¹æ”¹æˆï¼š test: hello: test, are you ok ?? bus !! å°†å…¶pushåˆ°GitHubï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š curl -X POST http://localhost:28088/actuator/bus-refresh/ å†æ¬¡è¯·æ±‚ä¸¤ä¸ªå®¢æˆ·ç«¯çš„http://localhost:28089/infoæ¥å£ï¼Œéƒ½èƒ½å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¯´æ˜æˆåŠŸäº†ï¼š - åªè¦å¼€å¯ Spring Cloud Bus åï¼Œä¸ç®¡æ˜¯å¯¹ config-server è¿˜æ˜¯ config-client æ‰§è¡Œ/actuator/bus-refreshéƒ½æ˜¯å¯ä»¥æ›´æ–°é…ç½®çš„ã€‚ å…¶ä»–å½“ä½¿ç”¨SpringBoot-2.1.1.RELEASEçš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥é”™ä»¥ä¸‹é”™è¯¯ï¼š Failed to introspect Class \\[org.springframework.cloud.stream.config.BindingServiceConfiguration] from ClassLoader \\[sun.misc.Launcher$AppClassLoader@18b4aac2] è¿™ä¸ªç•™ç€ä»¥åç ”ç©¶ã€‚ã€‚ å‚è€ƒ é…ç½®ä¸­å¿ƒå’Œæ¶ˆæ¯æ€»çº¿ï¼ˆé…ç½®ä¸­å¿ƒç»ˆç»“ç‰ˆï¼‰ é…ç½®ä¸­å¿ƒï¼ˆæ¶ˆæ¯æ€»çº¿ï¼‰ã€Finchley ç‰ˆã€‘","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆé…ç½®ä¸­å¿ƒæœåŠ¡åŒ–ä¸é«˜å¯ç”¨ï¼‰","date":"2018-12-31T06:48:58.000Z","path":"2018/12/31/2f34c065.html","text":"ä½¿ç”¨é…ç½®ä¸­å¿ƒçš„å®¢æˆ·ç«¯éƒ½æ˜¯ç›´æ¥è°ƒç”¨é…ç½®ä¸­å¿ƒçš„serverç«¯æ¥è·å–é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚è¿™æ ·å°±å­˜åœ¨äº†ä¸€ä¸ªé—®é¢˜ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è€¦åˆæ€§å¤ªé«˜ï¼Œå¦‚æœserverç«¯è¦åšé›†ç¾¤ï¼Œå®¢æˆ·ç«¯åªèƒ½é€šè¿‡åŸå§‹çš„æ–¹å¼æ¥è·¯ç”±ï¼Œserverç«¯æ”¹å˜IPåœ°å€çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¹Ÿéœ€è¦ä¿®æ”¹é…ç½®ï¼Œä¸ç¬¦åˆspringcloudæœåŠ¡æ²»ç†çš„ç†å¿µã€‚springcloudæä¾›äº†è¿™æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†serverç«¯å½“åšä¸€ä¸ªæœåŠ¡æ³¨å†Œåˆ°eurekaä¸­ï¼Œclientç«¯å»eurekaä¸­å»è·å–é…ç½®ä¸­å¿ƒserverç«¯çš„æœåŠ¡æ—¢å¯ã€‚ åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å®Œæˆäº†ï¼š æ„å»ºäº† config-serverï¼Œè¿æ¥åˆ° Git ä»“åº“ åœ¨ Git ä¸Šåˆ›å»ºäº†ä¸€ä¸ª config-repo ç›®å½•ï¼Œç”¨æ¥å­˜å‚¨é…ç½®ä¿¡æ¯ æ„å»ºäº† config-clientï¼Œæ¥è·å– Git ä¸­çš„é…ç½®ä¿¡æ¯ åœ¨ config-client ä¸­å¼€å¯äº† Refreshï¼ŒåŠ¨æ€åˆ·æ–°é…ç½®ä¿¡æ¯ æ¥ä¸‹æ¥ï¼ŒåŸºäºé…ç½®ä¸­å¿ƒGitç‰ˆæœ¬æ¥è¿›è¡Œæ”¹é€ ã€‚ Serverç«¯æ”¹é€ POMåœ¨pom.xmlæ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt; é…ç½®æ–‡ä»¶åœ¨application.ymlä¸­æ·»åŠ eruekaé…ç½®ï¼š eureka: client: service-url: defaultZone: http://localhost:28081/eureka/ å¯åŠ¨ç±»ç»™å¯åŠ¨ç±»åŠ ä¸Š@EnableDiscoveryClientæ³¨è§£ï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š @EnableDiscoveryClient@EnableConfigServer@SpringBootApplicationpublic class ConfigServerGitApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerGitApplication.class, args); &#125;&#125; Serverç«¯æ”¹é€ å®Œæˆï¼Œä¾æ¬¡å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€config-serverï¼Œè®¿é—®http://localhost:28081ï¼Œå°±ä¼šçœ‹åˆ°config-serverå·²æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒã€‚ å®¢æˆ·ç«¯æ”¹é€ POMåœ¨pom.xmlä¸­æ·»åŠ ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt; bootstrap.ymlä¿®æ”¹bootstrap.ymlé…ç½®æ–‡ä»¶ï¼š spring: cloud: config: name: test-config profile: dev label: master discovery: enabled: true service-id: config-servereureka: client: service-url: defaultZone: http://localhost:28081/eureka/ ä¸»è¦æ˜¯å»æ‰äº†spring.cloud.config.uriç›´æ¥æŒ‡å‘ Server ç«¯åœ°å€çš„é…ç½®ï¼Œå¢åŠ äº†æœ€åçš„ä¸‰ä¸ªé…ç½®ï¼š spring.cloud.config.discovery.enabledï¼šå¼€å¯ Config æœåŠ¡å‘ç°æ”¯æŒ spring.cloud.config.discovery.serviceIdï¼šæŒ‡å®š Server ç«¯çš„ name, ä¹Ÿå°±æ˜¯ Server ç«¯spring.application.nameçš„å€¼ eureka.client.service-url.defaultZoneï¼šæŒ‡å‘é…ç½®ä¸­å¿ƒçš„åœ°å€ è¿™ä¸‰ä¸ªé…ç½®æ–‡ä»¶éƒ½éœ€è¦æ”¾åˆ°bootstrap.ymlçš„é…ç½®ä¸­ã€‚ å¯åŠ¨ç±»å¯åŠ¨ç±»ç»™å¯åŠ¨ç±»åŠ ä¸Š@EnableDiscoveryClientæ³¨è§£ï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š @EnableDiscoveryClient@SpringBootApplicationpublic class ConfitClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfitClientApplication.class, args); &#125;&#125; Clientç«¯ä¹Ÿæ”¹é€ å®Œæˆï¼Œå¯åŠ¨Clientç«¯ï¼Œè®¿é—®http://localhost:28081ï¼Œå¯ä»¥çœ‹åˆ°Clientä¹Ÿå·²ç»æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ: æµ‹è¯•åœ¨postmanè¯·æ±‚http://localhost:28089/infoï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼Œè¯´æ˜æ”¹é€ æˆåŠŸï¼š é«˜å¯ç”¨å¯åŠ¨ä¸¤ä¸ª Server ç«¯ï¼Œç«¯å£åˆ†åˆ«ä¸º 28088 å’Œ 28090ï¼Œæä¾›é«˜å¯ç”¨çš„ Server ç«¯æ”¯æŒã€‚è¿™æ ·åœ¨å…¶ä¸­ä¸€ä¸ªServeræŒ‚æ‰çš„æ—¶å€™ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªServerå¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚ å…·ä½“å®æ–½ï¼š # æ‰“åŒ…./mvn clean package -Dmaven.test.skip=true# å¯åŠ¨ä¸¤ä¸ª Serverjava -jar target/config-server-git-0.0.1-SNAPSHOT.jar --server.port=28089java -jar target/config-server-git-0.0.1-SNAPSHOT.jar --server.port=28090 åˆ†åˆ«ä½¿ç”¨postmanå»è¯·æ±‚ä¸¤ä¸ªç«¯å£çš„æœåŠ¡ç«¯ï¼Œéƒ½èƒ½æ­£ç¡®è¿”å›é…ç½®ä¿¡æ¯ï¼Œè¯´æ˜é«˜å¯ç”¨é›†æˆæˆåŠŸã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆGitç‰ˆé…ç½®ä¸­å¿ƒï¼‰","date":"2018-12-30T07:00:19.000Z","path":"2018/12/30/5e7c1be9.html","text":"Spring Cloud Configéšç€çº¿ä¸Šé¡¹ç›®å˜çš„æ—¥ç›Šåºå¤§ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½æ•£è½ç€å„ç§é…ç½®æ–‡ä»¶ï¼Œå¦‚æœé‡‡ç”¨åˆ†å¸ƒå¼çš„å¼€å‘æ¨¡å¼ï¼Œéœ€è¦çš„é…ç½®æ–‡ä»¶éšç€æœåŠ¡å¢åŠ è€Œä¸æ–­å¢å¤šã€‚æŸä¸€ä¸ªåŸºç¡€æœåŠ¡ä¿¡æ¯å˜æ›´ï¼Œéƒ½ä¼šå¼•èµ·ä¸€ç³»åˆ—çš„æ›´æ–°å’Œé‡å¯ï¼Œè¿ç»´è‹¦ä¸å ªè¨€ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚é…ç½®ä¸­å¿ƒä¾¿æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„çµä¸¹å¦™è¯ã€‚**Spring Cloud Configï¼Œå› ä¸ºå®ƒåŠŸèƒ½å…¨é¢å¼ºå¤§ï¼Œå¯ä»¥æ— ç¼çš„å’Œspringä½“ç³»ç›¸ç»“åˆã€‚** Spring Cloud Config æ˜¯ Spring Cloud å›¢é˜Ÿåˆ›å»ºçš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œç”¨æ¥ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åŸºç¡€è®¾æ–½å’Œå¾®æœåŠ¡åº”ç”¨æä¾›é›†ä¸­åŒ–çš„å¤–éƒ¨é…ç½®æ”¯æŒï¼Œå®ƒåˆ†ä¸ºæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¸¤ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­æœåŠ¡ç«¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡åº”ç”¨ï¼Œç”¨æ¥è¿æ¥é…ç½®ä»“åº“å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›è·å–é…ç½®ä¿¡æ¯ã€åŠ å¯† / è§£å¯†ä¿¡æ¯ç­‰è®¿é—®æ¥å£ï¼›è€Œå®¢æˆ·ç«¯åˆ™æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å„ä¸ªå¾®æœåŠ¡åº”ç”¨æˆ–åŸºç¡€è®¾æ–½ï¼Œå®ƒä»¬é€šè¿‡æŒ‡å®šçš„é…ç½®ä¸­å¿ƒæ¥ç®¡ç†åº”ç”¨èµ„æºä¸ä¸šåŠ¡ç›¸å…³çš„é…ç½®å†…å®¹ï¼Œå¹¶åœ¨å¯åŠ¨çš„æ—¶å€™ä»é…ç½®ä¸­å¿ƒè·å–å’ŒåŠ è½½é…ç½®ä¿¡æ¯ã€‚Spring Cloud Config å®ç°äº†å¯¹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸­ç¯å¢ƒå˜é‡å’Œå±æ€§é…ç½®çš„æŠ½è±¡æ˜ å°„ï¼Œæ‰€ä»¥å®ƒé™¤äº†é€‚ç”¨äº Spring æ„å»ºçš„åº”ç”¨ç¨‹åºä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»ä½•å…¶ä»–è¯­è¨€è¿è¡Œçš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚ç”±äº Spring Cloud Config å®ç°çš„é…ç½®ä¸­å¿ƒé»˜è®¤é‡‡ç”¨ Git æ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥ä½¿ç”¨ Spring Cloud Config æ„å»ºçš„é…ç½®æœåŠ¡å™¨ï¼Œå¤©ç„¶å°±æ”¯æŒå¯¹å¾®æœåŠ¡åº”ç”¨é…ç½®ä¿¡æ¯çš„ç‰ˆæœ¬ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ Git å®¢æˆ·ç«¯å·¥å…·æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ã€‚å½“ç„¶å®ƒä¹Ÿæä¾›äº†å¯¹å…¶ä»–å­˜å‚¨æ–¹å¼çš„æ”¯æŒï¼Œæ¯”å¦‚ï¼šSVN ä»“åº“ã€æœ¬åœ°åŒ–æ–‡ä»¶ç³»ç»Ÿã€‚ é…ç½®ä¸­å¿ƒæä¾›çš„åŠŸèƒ½ï¼š æä¾›æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ”¯æŒ é›†ä¸­ç®¡ç†å„ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ é…ç½®æ–‡ä»¶ä¿®æ”¹ä¹‹åï¼Œå¯ä»¥å¿«é€Ÿçš„ç”Ÿæ•ˆ å¯ä»¥è¿›è¡Œç‰ˆæœ¬ç®¡ç† æ”¯æŒå¤§çš„å¹¶å‘æŸ¥è¯¢ æ”¯æŒå„ç§è¯­è¨€ å‡†å¤‡å·¥ä½œåœ¨ Github ä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ config-repo ç”¨æ¥å­˜æ”¾é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºä»¥ä¸‹ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼š &#x2F;&#x2F; å¼€å‘ç¯å¢ƒtest-config-dev.yml&#x2F;&#x2F; æµ‹è¯•ç¯å¢ƒtest-config-test.yml&#x2F;&#x2F; ç”Ÿäº§ç¯å¢ƒtest-config-prod.yml æ¯ä¸ªæ–‡ä»¶éƒ½å†™ä¸€ä¸ªtest.helloå±æ€§ï¼Œå±æ€§å€¼åˆ†åˆ«æ˜¯devã€testã€prodï¼Œå¦‚ï¼š test: hello: test Serverç«¯åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Spring Boot å·¥ç¨‹ï¼Œå‘½åä¸ºï¼šconfig-server-gitã€‚ POM&lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; æ·»åŠ spring-cloud-config-serverä¾èµ–ã€‚ é…ç½®æ–‡ä»¶åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®æœåŠ¡çš„åŸºæœ¬ä¿¡æ¯ä»¥åŠgitçš„åœ°å€ï¼š spring: application: name: config-server cloud: config: server: git: uri: https://github.com/cayzlh/SpringCloudDemos # é…ç½®gitä»“åº“çš„åœ°å€ search-paths: config-repo # gitä»“åº“åœ°å€ä¸‹çš„ç›¸å¯¹åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œç”¨,åˆ†å‰²ã€‚server: port: 28088 Spring Cloud Config ä¹Ÿæä¾›æœ¬åœ°å­˜å‚¨é…ç½®çš„æ–¹å¼ã€‚æˆ‘ä»¬åªéœ€è¦è®¾ç½®å±æ€§spring.profiles.active=nativeï¼ŒConfig Server ä¼šé»˜è®¤ä»åº”ç”¨çš„src/main/resourceç›®å½•ä¸‹æ£€ç´¢é…ç½®æ–‡ä»¶ã€‚ä¹Ÿå¯ä»¥é€šè¿‡spring.cloud.config.server.native.searchLocations=file:E:/properties/å±æ€§æ¥æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚è™½ç„¶ Spring Cloud Config æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸ºäº†æ”¯æŒæ›´å¥½çš„ç®¡ç†å†…å®¹å’Œç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨ Git çš„æ–¹å¼ã€‚ å¦‚æœæˆ‘ä»¬çš„ Git ä»“åº“éœ€è¦æƒé™è®¿é—®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡é…ç½®ä¸‹é¢çš„ä¸¤ä¸ªå±æ€§æ¥å®ç°ï¼›spring.cloud.config.server.git.usernameï¼šè®¿é—® Git ä»“åº“çš„ç”¨æˆ·åspring.cloud.config.server.git.passwordï¼šè®¿é—® Git ä»“åº“çš„ç”¨æˆ·å¯†ç  å¯åŠ¨ç±»å¯åŠ¨ç±»æ·»åŠ @EnableConfigServerï¼Œæ¿€æ´»å¯¹é…ç½®ä¸­å¿ƒçš„æ”¯æŒï¼š @EnableConfigServer@SpringBootApplicationpublic class ConfigServerGitApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerGitApplication.class, args); &#125;&#125; Serverç«¯çš„é…ç½®åˆ°æ­¤ä¸ºæ­¢ æµ‹è¯•æµ‹è¯• Server ç«¯æ˜¯å¦å¯ä»¥è¯»å–åˆ° github ä¸Šé¢çš„é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡postmanè¯·æ±‚http://localhost:28088/test-config/testï¼Œè¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š &#123; &quot;name&quot;: &quot;test-config&quot;, &quot;profiles&quot;: [ &quot;test&quot; ], &quot;label&quot;: null, &quot;version&quot;: &quot;cd3f7acc23d556b64499d08ea9a14d2ee23c4534&quot;, &quot;state&quot;: null, &quot;propertySources&quot;: [ &#123; &quot;name&quot;: &quot;https://github.com/cayzlh/\\ SpringCloudDemos/config-repo/test-config-test.yml&quot;, &quot;source&quot;: &#123; &quot;test.hello&quot;: &quot;test&quot; &#125; &#125; ]&#125; æ³¨ï¼šè·¯å¾„ä¸­çš„test-configæ˜¯æŒ‡config-repoä¸­çš„æ–‡ä»¶åå‰ç¼€ã€‚ ä¿®æ”¹test-config-test.ymlä¸­çš„å†…å®¹ï¼Œå†æ¬¡åœ¨postmanè¯·æ±‚ï¼Œå‘ç°è¿”å›çš„å†…å®¹æ˜¯æœ€æ–°çš„äº†ï¼Œè¯´æ˜Serverç«¯ä¼šè‡ªåŠ¨è¯»å–æœ€æ–°æäº¤çš„å†…å®¹ã€‚ ä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶ä¼šè¢«è½¬æ¢æˆ Web æ¥å£ï¼Œè®¿é—®å¯ä»¥å‚ç…§ä»¥ä¸‹çš„è§„åˆ™ï¼š /{application}/{profile}[/{label}] /{application}-{profile}.yml /{label}/{application}-{profile}.yml /{application}-{profile}.properties /{label}/{application}-{profile}.properties ä¸Šé¢çš„ URL ä¼šæ˜ å°„&#123;application&#125;-&#123;profile&#125;.ymlå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­&#123;label&#125;å¯¹åº” Git ä¸Šä¸åŒçš„åˆ†æ”¯ï¼Œé»˜è®¤ä¸º masterã€‚ä»¥ config-client-dev.yml ä¸ºä¾‹å­ï¼Œå®ƒçš„ application æ˜¯ config-clientï¼Œprofile æ˜¯ devã€‚ Clientç«¯åœ¨å¾®æœåŠ¡åº”ç”¨ä¸­è·å–ä¸Šè¿°çš„é…ç½®ä¿¡æ¯ã€‚å†åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Spring Boot åº”ç”¨ï¼Œå‘½åä¸º config-clientã€‚ POMä¿®æ”¹pomæ–‡ä»¶ï¼Œå¼•å…¥å¦‚ä¸‹é…ç½®ï¼š &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; spring-boot-starter-webflux æ˜¯ä¸ºäº†æ–¹ä¾¿ Web æµ‹è¯•ã€‚Spring WebFlux æ˜¯éš Spring 5 æ¨å‡ºçš„å“åº”å¼ Web æ¡†æ¶ã€‚ é…ç½®æ–‡ä»¶éœ€è¦ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œapplication.ymlå’Œbootstrap.ymlã€‚ application.ymlï¼š spring: application: name: config-client-gitserver: port: 28089 bootstrap.ymlï¼š spring: cloud: config: uri: http://localhost:28088 # é…ç½®ä¸­å¿ƒçš„å…·ä½“åœ°å€ï¼Œå³ config-server name: test-config # å¯¹åº” &#123;application&#125; éƒ¨åˆ† profile: test # å¯¹åº” &#123;profile&#125; éƒ¨åˆ† label: master # å¯¹åº” &#123;label&#125; éƒ¨åˆ†ï¼Œå³ Git çš„åˆ†æ”¯ã€‚å¦‚æœé…ç½®ä¸­å¿ƒä½¿ç”¨çš„æ˜¯æœ¬åœ°å­˜å‚¨ï¼Œåˆ™è¯¥å‚æ•°æ— ç”¨ spring.application.nameï¼šå¯¹åº”{application}éƒ¨åˆ† spring.cloud.config.profileï¼šå¯¹åº”{profile}éƒ¨åˆ† spring.cloud.config.labelï¼šå¯¹åº”gitçš„åˆ†æ”¯ã€‚å¦‚æœé…ç½®ä¸­å¿ƒä½¿ç”¨çš„æ˜¯æœ¬åœ°å­˜å‚¨ï¼Œåˆ™è¯¥å‚æ•°æ— ç”¨ spring.cloud.config.uriï¼šé…ç½®ä¸­å¿ƒçš„å…·ä½“åœ°å€ spring.cloud.config.discovery.service-idï¼šæŒ‡å®šé…ç½®ä¸­å¿ƒçš„service-idï¼Œä¾¿äºæ‰©å±•ä¸ºé«˜å¯ç”¨é…ç½®é›†ç¾¤ã€‚ ä¸Šé¢è¿™äº›ä¸ Spring Cloud Config ç›¸å…³çš„å±æ€§å¿…é¡»é…ç½®åœ¨ bootstrap.yml ä¸­ï¼Œconfig éƒ¨åˆ†å†…å®¹æ‰èƒ½è¢«æ­£ç¡®åŠ è½½ã€‚å› ä¸º config çš„ç›¸å…³é…ç½®ä¼šå…ˆäº application.ymlï¼Œè€Œ bootstrap.yml çš„åŠ è½½ä¹Ÿæ˜¯å…ˆäº application.ymlã€‚ å¯åŠ¨ç±»ä¸éœ€è¦ä¿®æ”¹ï¼š @SpringBootApplicationpublic class ConfitClientApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfitClientApplication.class, args); &#125;&#125; æ–°å»ºHelloControllerï¼Œä½¿ç”¨@valueæ³¨è§£æ¥è·å–Serverç«¯å‚æ•°çš„å€¼ @RestControllerpublic class HelloController &#123; @Value(&quot;$&#123;test.hello:error&#125;&quot;) private String profile; @GetMapping(&quot;/info&quot;) public Mono&lt;String&gt; hello() &#123; return Mono.justOrEmpty(profile); &#125;&#125; æµ‹è¯•ä½¿ç”¨postmanè¯·æ±‚http://localhost:28089/infoï¼Œè¿”å›å¦‚ä¸‹ç»“æœï¼Œåˆ™è¯´æ˜Clientç«¯æˆåŠŸè·å–åˆ°äº†Serverç«¯çš„é…ç½®å€¼ã€‚ è‡³æ­¤ï¼ŒSpringCloudçš„Gitç‰ˆé…ç½®ä¸­å¿ƒå°±å®Œæˆäº†ã€‚ RefreshSpring Cloud Configåˆ†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯è´Ÿè´£å°†gitï¼ˆsvnï¼‰ä¸­å­˜å‚¨çš„é…ç½®æ–‡ä»¶å‘å¸ƒæˆRESTæ¥å£ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»æœåŠ¡ç«¯RESTæ¥å£è·å–é…ç½®ã€‚ä½†å®¢æˆ·ç«¯å¹¶ä¸èƒ½ä¸»åŠ¨æ„ŸçŸ¥åˆ°é…ç½®çš„å˜åŒ–ï¼Œä»è€Œä¸»åŠ¨å»è·å–æ–°çš„é…ç½®ã€‚å®¢æˆ·ç«¯å¦‚ä½•å»ä¸»åŠ¨è·å–æ–°çš„é…ç½®ä¿¡æ¯å‘¢ï¼Œspringcloudå·²ç»ç»™æˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œæ¯ä¸ªå®¢æˆ·ç«¯é€šè¿‡POSTæ–¹æ³•è§¦å‘å„è‡ªçš„/refreshã€‚ ä»…ä¿®æ”¹å®¢æˆ·ç«¯é¡¹ç›®ï¼Œå°±å¯ä»¥å®ç° refresh çš„åŠŸèƒ½ã€‚ æ·»åŠ ä¾èµ–&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; å¢åŠ äº†spring-boot-starter-actuatoråŒ…ï¼Œspring-boot-starter-actuatoræ˜¯ä¸€å¥—ç›‘æ§çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›‘æ§ç¨‹åºåœ¨è¿è¡Œæ—¶çŠ¶æ€ï¼Œå…¶ä¸­å°±åŒ…æ‹¬/actuator/refreshçš„åŠŸèƒ½ã€‚ å¼€å¯æ›´æ–°æœºåˆ¶éœ€è¦ç»™åŠ è½½å˜é‡çš„ç±»ä¸Šé¢åŠ è½½@RefreshScopeï¼Œåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ/actuator/refreshçš„æ—¶å€™å°±ä¼šæ›´æ–°æ­¤ç±»ä¸‹é¢çš„å˜é‡å€¼ã€‚ @RefreshScope@RestControllerpublic class HelloController &#123; @Value(&quot;$&#123;test.hello:error&#125;&quot;) private String profile; @GetMapping(&quot;/info&quot;) public Mono&lt;String&gt; hello() &#123; return Mono.justOrEmpty(profile); &#125;&#125; é…ç½®æ–‡ä»¶SpringBoot1.5ä»¥åéœ€è¦æ·»åŠ ä»¥ä¸‹é…ç½®ä»¥å°†/actuator/refreshè¿™ä¸ª Endpoint æš´éœ²å‡ºæ¥ï¼š management: endpoints: web: exposure: include: refresh æµ‹è¯•é‡å¯ config-clientï¼Œæˆ‘ä»¬ä»¥ POST è¯·æ±‚çš„æ–¹å¼æ¥è®¿é—®http://localhost:28089/actuator/refreshå°±ä¼šæ›´æ–°é…ç½®æ–‡ä»¶è‡³æœ€æ–°ç‰ˆæœ¬ã€‚ ä¿®æ”¹test-config-test.ymlæ–‡ä»¶çš„å†…å®¹ ä½¿ç”¨postmanè¯·æ±‚http://localhost:28089/actuator/refreshæ¥å£ å†è¯·æ±‚http://localhost:28089/infoæ¥å£ å‘ç°é…ç½®å†…å®¹å·²ç»æ›´æ–°åˆ°æœ€æ–°äº† è‡³æ­¤ï¼Œé…ç½®ä¸­å¿ƒçš„é…ç½®åˆ·æ–°å°±ç®—å®Œæˆäº†ï¼Œä½†æ˜¯è¿™æ ·åšæœ‰ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ›´æ–°äº†é…ç½®ä¹‹åéƒ½è¦è¯·æ±‚refreshæ¥å£ï¼Œè¿™å°±å¾ˆéº»çƒ¦ã€‚ã€‚ WebhookWebhook æ˜¯å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡å‘é€ HTTP POST è¯·æ±‚çš„æ–¹å¼æ¥é€šçŸ¥ä¿¡æ¯æ¥æ”¶æ–¹ã€‚Webhook æ¥ç›‘æµ‹ä½ åœ¨ Github.com ä¸Šçš„å„ç§äº‹ä»¶ï¼Œæœ€å¸¸è§çš„è«è¿‡äº push äº‹ä»¶ã€‚å¦‚æœä½ è®¾ç½®äº†ä¸€ä¸ªç›‘æµ‹ push äº‹ä»¶çš„ Webhookï¼Œé‚£ä¹ˆæ¯å½“ä½ çš„è¿™ä¸ªé¡¹ç›®æœ‰äº†ä»»ä½•æäº¤ï¼Œè¿™ä¸ª Webhook éƒ½ä¼šè¢«è§¦å‘ï¼Œè¿™æ—¶ Github å°±ä¼šå‘é€ä¸€ä¸ª HTTP POST è¯·æ±‚åˆ°ä½ é…ç½®å¥½çš„åœ°å€ã€‚ å¦‚æ­¤ä¸€æ¥ï¼Œä½ å°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å»è‡ªåŠ¨å®Œæˆä¸€äº›é‡å¤æ€§å·¥ä½œï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ Webhook æ¥è‡ªåŠ¨è§¦å‘ä¸€äº›æŒç»­é›†æˆï¼ˆCIï¼‰å·¥å…·çš„è¿ä½œï¼Œæ¯”å¦‚ Travis CIï¼›åˆæˆ–è€…æ˜¯é€šè¿‡ Webhook å»éƒ¨ç½²ä½ çš„çº¿ä¸ŠæœåŠ¡å™¨ã€‚ä¸‹å›¾å°±æ˜¯ Github ä¸Šé¢çš„ Webhook é…ç½®ã€‚ Payload URL ï¼šè§¦å‘åå›è°ƒçš„ URL Content type ï¼šæ•°æ®æ ¼å¼ï¼Œä¸¤ç§ä¸€èˆ¬ä½¿ç”¨ json Secret ï¼šç”¨ä½œç»™ POST çš„ body åŠ å¯†çš„å­—ç¬¦ä¸²ã€‚é‡‡ç”¨ HMAC ç®—æ³• events ï¼šè§¦å‘çš„äº‹ä»¶åˆ—è¡¨ã€‚ - events äº‹ä»¶ç±»å‹ æè¿° push ä»“åº“æœ‰ push æ—¶è§¦å‘ã€‚é»˜è®¤äº‹ä»¶ create å½“æœ‰åˆ†æ”¯æˆ–æ ‡ç­¾è¢«åˆ›å»ºæ—¶è§¦å‘ delete å½“æœ‰åˆ†æ”¯æˆ–æ ‡ç­¾è¢«åˆ é™¤æ—¶è§¦å‘ - è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ hook çš„æœºåˆ¶å»è§¦å‘å®¢æˆ·ç«¯çš„æ›´æ–°ï¼Œä½†æ˜¯å½“å®¢æˆ·ç«¯è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œhook æœºåˆ¶ä¹Ÿä¸å¤Ÿä¼˜é›…äº†ï¼Œå¦å¤–æ¯æ¬¡å¢åŠ å®¢æˆ·ç«¯éƒ½éœ€è¦æ”¹åŠ¨ hook ä¹Ÿæ˜¯ä¸ç°å®çš„ã€‚å…¶å®ï¼ŒSpring Cloud ç»™äº†æˆ‘ä»¬æ›´å¥½è§£å†³æ–¹æ¡ˆâ€”â€”Spring Cloud Busã€‚ å‚è€ƒ é…ç½®ä¸­å¿ƒgitç¤ºä¾‹ é…ç½®ä¸­å¿ƒsvnç¤ºä¾‹å’Œrefresh Spring Cloudï¼ˆä¸ƒï¼‰ï¼šé…ç½®ä¸­å¿ƒï¼ˆGit ç‰ˆä¸åŠ¨æ€åˆ·æ–°ï¼‰ã€Finchley ç‰ˆã€‘","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆHystrixç›‘æ§æ•°æ®èšåˆTurbineï¼‰","date":"2018-12-29T14:42:33.000Z","path":"2018/12/29/9090e9d4.html","text":"åœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹ç»å¸¸éœ€è¦éƒ¨ç½²ä¸Šç™¾ç”šè‡³ä¸Šåƒä¸ªï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿ç»´äººå‘˜å¸Œæœ›èƒ½å¤ŸæŠŠç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹çŠ¶æ€ä»¥ä¸€ä¸ªæ•´ä½“é›†ç¾¤çš„å½¢å¼å±•ç°å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„æŠŠæ¡æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ã€‚ ä¸ºæ­¤ï¼ŒNetflixæä¾›äº†ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ˆTurbineï¼‰æ¥æä¾›æŠŠå¤šä¸ªhystrix.streamçš„å†…å®¹èšåˆä¸ºä¸€ä¸ªæ•°æ®æºä¾›Dashboardå±•ç¤ºã€‚ åˆ›å»ºTurbineåˆ›å»ºä¸€ä¸ªåä¸ºTurbineçš„Spring Bootå·¥ç¨‹ POMåœ¨pom.xmlä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-turbine&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; å¯åŠ¨ç±»åœ¨å¯åŠ¨ç±»ä¸Šä½¿ç”¨@EnableTurbineæ³¨è§£å¼€å¯ Turbine @EnableTurbine@SpringBootApplicationpublic class TurbineApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(TurbineApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶åœ¨ application.yml åŠ å…¥ Eureka å’Œ Turbine çš„ç›¸å…³é…ç½® spring: application: name: hystrix-dashboard-turbineserver: port: 28087management: port: 28088eureka: client: service-url: defaultZone: http://localhost:28081/eureka/turbine: app-config: eureka-consumer cluster-name-expression: new String(&quot;default&quot;) combine-host-port: true å‚æ•°ï¼š turbine.app-configå‚æ•°æŒ‡å®šäº†éœ€è¦æ”¶é›†ç›‘æ§ä¿¡æ¯çš„æœåŠ¡åï¼› turbine.cluster-name-expression å‚æ•°æŒ‡å®šäº†é›†ç¾¤åç§°ä¸º defaultï¼Œå½“æˆ‘ä»¬æœåŠ¡æ•°é‡éå¸¸å¤šçš„æ—¶å€™ï¼Œå¯ä»¥å¯åŠ¨å¤šä¸ª Turbine æœåŠ¡æ¥æ„å»ºä¸åŒçš„èšåˆé›†ç¾¤ï¼Œè€Œè¯¥å‚æ•°å¯ä»¥ç”¨æ¥åŒºåˆ†è¿™äº›ä¸åŒçš„èšåˆé›†ç¾¤ï¼ŒåŒæ—¶è¯¥å‚æ•°å€¼å¯ä»¥åœ¨ Hystrix ä»ªè¡¨ç›˜ä¸­ç”¨æ¥å®šä½ä¸åŒçš„èšåˆé›†ç¾¤ï¼Œåªéœ€è¦åœ¨ Hystrix Stream çš„ URL ä¸­é€šè¿‡ cluster å‚æ•°æ¥æŒ‡å®šï¼› turbine.combine-host-portå‚æ•°è®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è®©åŒä¸€ä¸»æœºä¸Šçš„æœåŠ¡é€šè¿‡ä¸»æœºåä¸ç«¯å£å·çš„ç»„åˆæ¥è¿›è¡ŒåŒºåˆ†ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä»¥ host æ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡ï¼Œè¿™ä¼šä½¿å¾—åœ¨æœ¬åœ°è°ƒè¯•çš„æ—¶å€™ï¼Œæœ¬æœºä¸Šçš„ä¸åŒæœåŠ¡èšåˆæˆä¸€ä¸ªæœåŠ¡æ¥ç»Ÿè®¡ã€‚ å…¶ä¸­ï¼šnew String(&quot;default&quot;)è¿™ä¸ªä¸€å®šè¦ç”¨ String æ¥åŒ…ä¸€ä¸‹ï¼Œå¦åˆ™å¯åŠ¨çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š org.springframework.expression.spel.SpelEvaluationException: EL1008E: Property or field &#x27;default&#x27; cannot be found on object of type &#x27;com.netflix.appinfo.InstanceInfo&#x27; - maybe not public or not valid? æµ‹è¯•å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®http://localhost:28086/hystrixï¼Œå¼€å¯å¯¹http://localhost:28087/turbine.streamçš„ç›‘æ§ï¼Œèƒ½å¤Ÿçœ‹åˆ°é’ˆå¯¹æœåŠ¡eureka-consumerçš„èšåˆç›‘æ§æ•°æ®ã€‚ æ­¤æ—¶çš„æœåŠ¡æ¶æ„å¦‚ä¸‹å›¾ï¼š å‚è€ƒ Spring Cloudï¼ˆå…­ï¼‰ï¼šHystrix ç›‘æ§æ•°æ®èšåˆ Turbineã€Finchley ç‰ˆã€‘ springcloud(äº”)ï¼šç†”æ–­ç›‘æ§Hystrix Dashboardå’ŒTurbine","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆHystrixç†”æ–­ç›‘æ§é¢æ¿ï¼‰","date":"2018-12-23T06:48:06.000Z","path":"2018/12/23/c10f5abe.html","text":"æ–‡ç« å†…å®¹éƒ¨åˆ†æ‘˜æŠ„è‡ªspringcloud(äº”)ï¼šç†”æ–­ç›‘æ§Hystrix Dashboardå’ŒTurbine æ–­è·¯å™¨æ˜¯æ ¹æ®ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ¥åˆ¤æ–­å¹¶æ“ä½œæ–­è·¯å™¨çš„æ‰“å¼€å’Œå…³é—­çŠ¶æ€çš„ã€‚ Hystrix-dashboardæ˜¯ä¸€æ¬¾é’ˆå¯¹Hystrixè¿›è¡Œå®æ—¶ç›‘æ§çš„å·¥å…·ï¼Œé€šè¿‡Hystrix Dashboardæˆ‘ä»¬å¯ä»¥åœ¨ç›´è§‚åœ°çœ‹åˆ°å„Hystrix Commandçš„è¯·æ±‚å“åº”æ—¶é—´, è¯·æ±‚æˆåŠŸç‡ç­‰æ•°æ®ã€‚ä½†æ˜¯åªä½¿ç”¨Hystrix Dashboardçš„è¯, ä½ åªèƒ½çœ‹åˆ°å•ä¸ªåº”ç”¨å†…çš„æœåŠ¡ä¿¡æ¯, è¿™æ˜æ˜¾ä¸å¤Ÿ. æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·èƒ½è®©æˆ‘ä»¬æ±‡æ€»ç³»ç»Ÿå†…å¤šä¸ªæœåŠ¡çš„æ•°æ®å¹¶æ˜¾ç¤ºåˆ°Hystrix Dashboardä¸Š, è¿™ä¸ªå·¥å…·å°±æ˜¯Turbine. Hystrix Dashboardåˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹ï¼Œèµ·åä¸ºhystrix-dashboardã€‚ pomé…ç½®åœ¨pom.xmlä¸­å¼•å…¥ç›¸å…³ä¾èµ–ï¼š &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; å¯åŠ¨ç±»å¯åŠ¨ç±»åŠ ä¸Š@EnableHystrixDashboardæ³¨è§£ @EnableHystrixDashboard@SpringBootApplicationpublic class HystrixDashboardApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(HystrixDashboardApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š spring: application: name: hystrix-dashboardserver: port: 28086 å¯åŠ¨æœåŠ¡å¯åŠ¨æœåŠ¡ï¼Œè®¿é—®http://localhost:28086/hystrixï¼Œçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š è¯´æ˜ è¿™æ®µæ¥æºï¼šhttps://windmt.com/2018/04/16/spring-cloud-5-hystrix-dashboard/ é€šè¿‡ Hystrix Dashboard ä¸»é¡µé¢çš„æ–‡å­—ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒHystrix Dashboard å…±æ”¯æŒä¸‰ç§ä¸åŒçš„ç›‘æ§æ–¹å¼ï¼š é»˜è®¤çš„é›†ç¾¤ç›‘æ§ï¼šé€šè¿‡ URLï¼šhttp://turbine-hostname:port/turbine.stream å¼€å¯ï¼Œå®ç°å¯¹é»˜è®¤é›†ç¾¤çš„ç›‘æ§ã€‚ æŒ‡å®šçš„é›†ç¾¤ç›‘æ§ï¼šé€šè¿‡ URLï¼šhttp://turbine-hostname:port/turbine.stream?cluster=[clusterName] å¼€å¯ï¼Œå®ç°å¯¹ clusterName é›†ç¾¤çš„ç›‘æ§ã€‚ å•ä½“åº”ç”¨çš„ç›‘æ§ï¼š é€šè¿‡ URLï¼šhttp://hystrix-app:port/hystrix.stream å¼€å¯ ï¼Œå®ç°å¯¹å…·ä½“æŸä¸ªæœåŠ¡å®ä¾‹çš„ç›‘æ§ã€‚ï¼ˆç°åœ¨è¿™é‡Œçš„ URL åº”è¯¥ä¸º http://hystrix-app:port/actuator/hystrix.streamï¼ŒActuator 2.x ä»¥å \b\b endpoints å…¨éƒ¨åœ¨/actuatorä¸‹ï¼Œå¯ä»¥é€šè¿‡management.endpoints.web.base-pathä¿®æ”¹ï¼‰ å‰ä¸¤è€…éƒ½å¯¹é›†ç¾¤çš„ç›‘æ§ï¼Œéœ€è¦æ•´åˆ Turbine æ‰èƒ½å®ç°ã€‚è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å…ˆå®ç°å¯¹å•ä½“åº”ç”¨çš„ç›‘æ§ï¼Œè¿™é‡Œçš„å•ä½“åº”ç”¨å°±ç”¨æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ Feign å’Œ Hystrix å®ç°çš„æœåŠ¡æ¶ˆè´¹è€…â€”â€”eureka-consumerã€‚ é¡µé¢ä¸Šçš„å¦å¤–ä¸¤ä¸ªå‚æ•°ï¼š Delayï¼šæ§åˆ¶æœåŠ¡å™¨ä¸Šè½®è¯¢ç›‘æ§ä¿¡æ¯çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º 2000 æ¯«ç§’ï¼Œå¯ä»¥é€šè¿‡é…ç½®è¯¥å±æ€§æ¥é™ä½å®¢æˆ·ç«¯çš„ç½‘ç»œå’Œ CPU æ¶ˆè€—ã€‚ Titleï¼šè¯¥å‚æ•°å¯ä»¥å±•ç¤ºåˆé€‚çš„æ ‡é¢˜ã€‚ æ·»åŠ endpointæ—¢ç„¶ Hystrix Dashboard ç›‘æ§å•å®ä¾‹èŠ‚ç‚¹éœ€è¦é€šè¿‡è®¿é—®å®ä¾‹çš„/actuator/hystrix.streamæ¥å£æ¥å®ç°ï¼Œè‡ªç„¶æˆ‘ä»¬éœ€è¦ä¸ºæœåŠ¡å®ä¾‹æ·»åŠ è¿™ä¸ª endpointã€‚ ä½¿ç”¨å‰é¢çš„eureka-consumerå·¥ç¨‹ï¼› ä¿®æ”¹pomé…ç½®åœ¨dependenciesèŠ‚ç‚¹ä¸‹æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; å¯åŠ¨ç±»ä¿®æ”¹å¯åŠ¨ç±»ï¼Œæ·»åŠ @EnableCircuitBreakeræˆ–è€…@EnableHystrixæ³¨è§£ï¼Œå¼€å¯æ–­è·¯å™¨åŠŸèƒ½ï¼› @EnableCircuitBreaker@EnableFeignClients@SpringBootApplicationpublic class EurekaConsumerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaConsumerApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š management: endpoints: web: exposure: include: hystrix.stream management.endpoints.web.exposure.includeè¿™ä¸ªæ˜¯ç”¨æ¥æš´éœ² endpoints çš„ã€‚ç”±äº endpoints ä¸­ä¼šåŒ…å«å¾ˆå¤šæ•æ„Ÿä¿¡æ¯ï¼Œé™¤äº† health å’Œ info ä¸¤ä¸ªæ”¯æŒ web è®¿é—®å¤–ï¼Œå…¶ä»–çš„é»˜è®¤ä¸æ”¯æŒ web è®¿é—®ã€‚ æµ‹è¯• åˆ†åˆ«å†å¯åŠ¨æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç”Ÿäº§è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€‚ åœ¨Hystrix Dashboardä¸­è¾“å…¥http://localhost:28085/actuator/hystrix.streamï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹çš„Monitor StreamæŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°Lodingç•Œé¢ã€‚ è¿™ä¸ªæ—¶å€™è®¿é—®http://localhost:28085/hello/zhangsanï¼Œè®¿é—®æˆåŠŸåå†å›æ¥DashBoardé¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ï¼š å›¾åƒè§£è¯»ä»¥ä¸Šå›¾æ¥è¯´æ˜å…¶ä¸­å„å…ƒç´ çš„å…·ä½“å«ä¹‰ï¼š å®å¿ƒåœ†ï¼šå®ƒæœ‰é¢œè‰²å’Œå¤§å°ä¹‹åˆ†ï¼Œåˆ†åˆ«ä»£è¡¨å®ä¾‹çš„ç›‘æ§ç¨‹åº¦å’Œæµé‡å¤§å°ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒçš„å¥åº·åº¦ä»ç»¿è‰²ã€é»„è‰²ã€æ©™è‰²ã€çº¢è‰²é€’å‡ã€‚é€šè¿‡è¯¥å®å¿ƒåœ†çš„å±•ç¤ºï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¤§é‡çš„å®ä¾‹ä¸­å¿«é€Ÿçš„å‘ç°æ•…éšœå®ä¾‹å’Œé«˜å‹åŠ›å®ä¾‹ã€‚ æ›²çº¿ï¼šç”¨æ¥è®°å½• 2 åˆ†é’Ÿå†…æµé‡çš„ç›¸å¯¹å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è§‚å¯Ÿåˆ°æµé‡çš„ä¸Šå‡å’Œä¸‹é™è¶‹åŠ¿ã€‚ å…¶ä»–æ•°é‡æŒ‡æ ‡ ç»“æŸåˆ°æ­¤ï¼Œå•ä¸ªæœåŠ¡çš„ç†”æ–­ç›‘æ§å·²ç»å®Œæˆã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆç†”æ–­å™¨Hystrixï¼‰","date":"2018-12-22T08:04:16.000Z","path":"2018/12/22/5a724b6.html","text":"ä½¿ç”¨Feign Hystrixåšç†”æ–­å™¨ç†”æ–­ä½œç”¨åœ¨æœåŠ¡è°ƒç”¨çš„ä¸€ç«¯ï¼Œè¦å®ç°ç†”æ–­å™¨ï¼Œ åªéœ€åœ¨æœåŠ¡æ¶ˆè´¹è€…ï¼ˆeureka-consumerï¼‰ä¸Šåšæ”¹åŠ¨å°±è¡Œã€‚ Feignä¸­å·²ç»ä¾èµ–äº†Hystrixæ‰€ä»¥åœ¨mavené…ç½®ä¸Šä¸ç”¨åšä»»ä½•æ”¹åŠ¨ã€‚ ä¿®æ”¹é…ç½®æ–‡ä»¶spring: application: name: eureka-consumereureka: client: service-url: defaultZone: http://localhost:28081/eureka/server: port: 28085feign: hystrix: enabled: true åˆ›å»ºä¸€ä¸ªå›è°ƒæ–¹æ³•ç±»åˆ›å»º HelloRemoteHystrix ç±»å®ç° HelloRemote ä¸­å®ç°å›è°ƒçš„æ–¹æ³• @Componentpublic class HelloRemoteHystrix implements HelloRemote &#123; @Override public String hello(@RequestParam(value = &quot;name&quot;) String name) &#123; return &quot;Helloï¼Œ&quot;+name+&quot; ï¼Œå½“å‰æœåŠ¡å´©äº†ã€‚&quot;; &#125;&#125; è®¾ç½®fallbackå±æ€§åœ¨HelloRemoteç±»æ·»åŠ æŒ‡å®š fallback ç±»ï¼Œåœ¨æœåŠ¡ç†”æ–­çš„æ—¶å€™è¿”å› fallback ç±»ä¸­çš„å†…å®¹ã€‚ @FeignClient(name = &quot;eureka-producer&quot;, fallback = HelloRemoteHystrix.class)public interface HelloRemote &#123; @GetMapping(&quot;/hello/&quot;) String hello(@RequestParam(value = &quot;name&quot;) String name);&#125; ä»£ç éƒ¨åˆ†ï¼Œåˆ°æ­¤ä¸ºæ­¢å°±okäº†ã€‚ æµ‹è¯•å¯åŠ¨ä¸‰ä¸ªé¡¹ç›®ï¼ˆæ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ï¼‰ è®¿é—®http://localhost:28085/hello/zhangsanè¿”å›ç»“æœï¼š å¯ä»¥çœ‹åˆ°å½“å‰æ˜¯æ­£å¸¸è¿”å›ç»“æœçš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒæŠŠæœåŠ¡æä¾›è€…çš„æœåŠ¡killæ‰ï¼Œå†æ¬¡è®¿é—®http://localhost:28085/hello/zhangsanï¼Œè¿”å›ç»“æœï¼š è¯´æ˜ç†”æ–­æˆåŠŸï¼ é›ªå´©æ•ˆåº” è¿™æ®µæ‘˜è‡ªçº¯æ´çš„å¾®ç¬‘åšå®¢ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­é€šå¸¸ä¼šæœ‰å¤šä¸ªæœåŠ¡å±‚è°ƒç”¨ï¼ŒåŸºç¡€æœåŠ¡çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœï¼Œè¿›è€Œé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”ã€‚æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å› â€œæœåŠ¡æä¾›è€…â€çš„ä¸å¯ç”¨å¯¼è‡´â€œæœåŠ¡æ¶ˆè´¹è€…â€çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§çš„è¿‡ç¨‹ã€‚ å¦‚æœä¸‹å›¾æ‰€ç¤ºï¼šAä½œä¸ºæœåŠ¡æä¾›è€…ï¼ŒBä¸ºAçš„æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCå’ŒDæ˜¯Bçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚Aä¸å¯ç”¨å¼•èµ·äº†Bçš„ä¸å¯ç”¨ï¼Œå¹¶å°†ä¸å¯ç”¨åƒæ»šé›ªçƒä¸€æ ·æ”¾å¤§åˆ°Cå’ŒDæ—¶ï¼Œé›ªå´©æ•ˆåº”å°±å½¢æˆäº†ã€‚ ç†”æ–­å™¨ è¿™æ®µæ‘˜è‡ªçº¯æ´çš„å¾®ç¬‘åšå®¢ ç†”æ–­å™¨çš„åŸç†å¾ˆç®€å•ï¼Œå¦‚åŒç”µåŠ›è¿‡è½½ä¿æŠ¤å™¨ã€‚å®ƒå¯ä»¥å®ç°å¿«é€Ÿå¤±è´¥ï¼Œå¦‚æœå®ƒåœ¨ä¸€æ®µæ—¶é—´å†…ä¾¦æµ‹åˆ°è®¸å¤šç±»ä¼¼çš„é”™è¯¯ï¼Œä¼šå¼ºè¿«å…¶ä»¥åçš„å¤šä¸ªè°ƒç”¨å¿«é€Ÿå¤±è´¥ï¼Œä¸å†è®¿é—®è¿œç¨‹æœåŠ¡å™¨ï¼Œä»è€Œé˜²æ­¢åº”ç”¨ç¨‹åºä¸æ–­åœ°å°è¯•æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œï¼Œä½¿å¾—åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œè€Œä¸ç”¨ç­‰å¾…ä¿®æ­£é”™è¯¯ï¼Œæˆ–è€…æµªè´¹CPUæ—¶é—´å»ç­‰åˆ°é•¿æ—¶é—´çš„è¶…æ—¶äº§ç”Ÿã€‚ç†”æ–­å™¨ä¹Ÿå¯ä»¥ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè¯Šæ–­é”™è¯¯æ˜¯å¦å·²ç»ä¿®æ­£ï¼Œå¦‚æœå·²ç»ä¿®æ­£ï¼Œåº”ç”¨ç¨‹åºä¼šå†æ¬¡å°è¯•è°ƒç”¨æ“ä½œã€‚ ç†”æ–­å™¨æ¨¡å¼å°±åƒæ˜¯é‚£äº›å®¹æ˜“å¯¼è‡´é”™è¯¯çš„æ“ä½œçš„ä¸€ç§ä»£ç†ã€‚è¿™ç§ä»£ç†èƒ½å¤Ÿè®°å½•æœ€è¿‘è°ƒç”¨å‘ç”Ÿé”™è¯¯çš„æ¬¡æ•°ï¼Œç„¶åå†³å®šä½¿ç”¨å…è®¸æ“ä½œç»§ç»­ï¼Œæˆ–è€…ç«‹å³è¿”å›é”™è¯¯ã€‚ ç†”æ–­å™¨å¼€å…³ç›¸äº’è½¬æ¢çš„é€»è¾‘å¦‚ä¸‹å›¾ï¼š ç†”æ–­å™¨å°±æ˜¯ä¿æŠ¤æœåŠ¡é«˜å¯ç”¨çš„æœ€åä¸€é“é˜²çº¿ã€‚ Hystrixç‰¹æ€§æ–­è·¯å™¨æœºåˆ¶æ–­è·¯å™¨å¾ˆå¥½ç†è§£, å½“Hystrix Commandè¯·æ±‚åç«¯æœåŠ¡å¤±è´¥æ•°é‡è¶…è¿‡ä¸€å®šæ¯”ä¾‹(é»˜è®¤50%), æ–­è·¯å™¨ä¼šåˆ‡æ¢åˆ°å¼€è·¯çŠ¶æ€(Open). è¿™æ—¶æ‰€æœ‰è¯·æ±‚ä¼šç›´æ¥å¤±è´¥è€Œä¸ä¼šå‘é€åˆ°åç«¯æœåŠ¡. æ–­è·¯å™¨ä¿æŒåœ¨å¼€è·¯çŠ¶æ€ä¸€æ®µæ—¶é—´å(é»˜è®¤5ç§’), è‡ªåŠ¨åˆ‡æ¢åˆ°åŠå¼€è·¯çŠ¶æ€(HALF-OPEN). è¿™æ—¶ä¼šåˆ¤æ–­ä¸‹ä¸€æ¬¡è¯·æ±‚çš„è¿”å›æƒ…å†µ, å¦‚æœè¯·æ±‚æˆåŠŸ, æ–­è·¯å™¨åˆ‡å›é—­è·¯çŠ¶æ€(CLOSED), å¦åˆ™é‡æ–°åˆ‡æ¢åˆ°å¼€è·¯çŠ¶æ€(OPEN). Hystrixçš„æ–­è·¯å™¨å°±åƒæˆ‘ä»¬å®¶åº­ç”µè·¯ä¸­çš„ä¿é™©ä¸, ä¸€æ—¦åç«¯æœåŠ¡ä¸å¯ç”¨, æ–­è·¯å™¨ä¼šç›´æ¥åˆ‡æ–­è¯·æ±‚é“¾, é¿å…å‘é€å¤§é‡æ— æ•ˆè¯·æ±‚å½±å“ç³»ç»Ÿååé‡, å¹¶ä¸”æ–­è·¯å™¨æœ‰è‡ªæˆ‘æ£€æµ‹å¹¶æ¢å¤çš„èƒ½åŠ›. FallbackFallbackç›¸å½“äºæ˜¯é™çº§æ“ä½œ. å¯¹äºæŸ¥è¯¢æ“ä½œ, æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªfallbackæ–¹æ³•, å½“è¯·æ±‚åç«¯æœåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™, å¯ä»¥ä½¿ç”¨fallbackæ–¹æ³•è¿”å›çš„å€¼. fallbackæ–¹æ³•çš„è¿”å›å€¼ä¸€èˆ¬æ˜¯è®¾ç½®çš„é»˜è®¤å€¼æˆ–è€…æ¥è‡ªç¼“å­˜. èµ„æºéš”ç¦»åœ¨Hystrixä¸­, ä¸»è¦é€šè¿‡çº¿ç¨‹æ± æ¥å®ç°èµ„æºéš”ç¦». é€šå¸¸åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä¼šæ ¹æ®è°ƒç”¨çš„è¿œç¨‹æœåŠ¡åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹æ± . ä¾‹å¦‚è°ƒç”¨äº§å“æœåŠ¡çš„Commandæ”¾å…¥Açº¿ç¨‹æ± , è°ƒç”¨è´¦æˆ·æœåŠ¡çš„Commandæ”¾å…¥Bçº¿ç¨‹æ± . è¿™æ ·åšçš„ä¸»è¦ä¼˜ç‚¹æ˜¯è¿è¡Œç¯å¢ƒè¢«éš”ç¦»å¼€äº†. è¿™æ ·å°±ç®—è°ƒç”¨æœåŠ¡çš„ä»£ç å­˜åœ¨bugæˆ–è€…ç”±äºå…¶ä»–åŸå› å¯¼è‡´è‡ªå·±æ‰€åœ¨çº¿ç¨‹æ± è¢«è€—å°½æ—¶, ä¸ä¼šå¯¹ç³»ç»Ÿçš„å…¶ä»–æœåŠ¡é€ æˆå½±å“. ä½†æ˜¯å¸¦æ¥çš„ä»£ä»·å°±æ˜¯ç»´æŠ¤å¤šä¸ªçº¿ç¨‹æ± ä¼šå¯¹ç³»ç»Ÿå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€. å¦‚æœæ˜¯å¯¹æ€§èƒ½æœ‰ä¸¥æ ¼è¦æ±‚è€Œä¸”ç¡®ä¿¡è‡ªå·±è°ƒç”¨æœåŠ¡çš„å®¢æˆ·ç«¯ä»£ç ä¸ä¼šå‡ºé—®é¢˜çš„è¯, å¯ä»¥ä½¿ç”¨Hystrixçš„ä¿¡å·æ¨¡å¼(Semaphores)æ¥éš”ç¦»èµ„æº. æ€»ç»“é€šè¿‡ä½¿ç”¨ Hystrixï¼Œæˆ‘ä»¬èƒ½æ–¹ä¾¿çš„é˜²æ­¢é›ªå´©æ•ˆåº”ï¼ŒåŒæ—¶ä½¿ç³»ç»Ÿå…·æœ‰è‡ªåŠ¨é™çº§å’Œè‡ªåŠ¨æ¢å¤æœåŠ¡çš„æ•ˆæœã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆæœåŠ¡æä¾›ä¸å‘ç°Eurekaï¼‰","date":"2018-12-20T02:41:15.000Z","path":"2018/12/20/b6f15c0c.html","text":"æä¾›ä¸‰ä¸ªè§’è‰²ï¼šæœåŠ¡æ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€‚ç”¨æ¥æ¨¡æ‹ŸEurekaæœåŠ¡æä¾›è€…ä¸æ¶ˆè´¹è€…å…³ç³»ã€‚ æµç¨‹ å¯åŠ¨æ³¨å†Œä¸­å¿ƒ æœåŠ¡æä¾›è€…ç”Ÿäº§æœåŠ¡å¹¶æ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒä¸­ æ¶ˆè´¹è€…ä»æœåŠ¡ä¸­å¿ƒä¸­è·å–æœåŠ¡å¹¶æ‰§è¡Œ ï¼ˆå›¾ç‰‡æ¥æºäºç½‘ç»œï¼‰ æœåŠ¡æ³¨å†Œä¸­å¿ƒå‚è€ƒå¦ä¸€ç‰‡ç¬”è®°ã€ŠSpringCloudï¼ˆæ³¨å†Œä¸­å¿ƒEurekaï¼‰ã€‹ æœåŠ¡æä¾›è€…æä¾›ä¸€ä¸ªhello()æ–¹æ³•æ‰“å°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ æ–°å»ºä¸€ä¸ªåä¸ºspring-cloud-producerçš„SpringBootå·¥ç¨‹POMæ–‡ä»¶éƒ¨åˆ†é…ç½®&lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; application.ymlæ–‡ä»¶é…ç½®spring: application: name: eureka-producereureka: client: service-url: defaultZone: http://localhost:28081/eureka/server: port: 28084 é€šè¿‡spring.application.nameå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¾®æœåŠ¡çš„åç§°åç»­åœ¨è°ƒç”¨çš„æ—¶å€™åªéœ€è¦ä½¿ç”¨è¯¥åç§°å°±å¯ä»¥è¿›è¡ŒæœåŠ¡çš„è®¿é—®ã€‚eureka.client.serviceUrl.defaultZoneå±æ€§å¯¹åº”æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®å†…å®¹ï¼ŒæŒ‡å®šæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„ä½ç½®ã€‚ä¸ºäº†åœ¨æœ¬æœºä¸Šæµ‹è¯•åŒºåˆ†æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨server.portå±æ€§è®¾ç½®ä¸åŒçš„ç«¯å£ã€‚ å¯åŠ¨ç±»ä¿æŒé»˜è®¤ç”Ÿæˆçš„å³å¯ï¼Œ Finchley.RC1 è¿™ä¸ªç‰ˆæœ¬çš„ Spring Cloud å·²ç»æ— éœ€æ·»åŠ @EnableDiscoveryClientæ³¨è§£äº†ã€‚å¦‚æœå¼•å…¥äº†ç›¸å…³çš„jaråŒ…ï¼Œéœ€è¦ç¦ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œåªéœ€è®¾ç½®eureka.client.enabled=false @SpringBootApplicationpublic class SpringCloudProducerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(SpringCloudProducerApplication.class, args); &#125;&#125; å®šä¹‰ä¸€ä¸ªç®€å•Controlleræ¥å£ï¼Œç”¨æ¥æä¾›helloæœåŠ¡@RestController@RequestMapping(&quot;/hello&quot;)public class HelloController &#123; @GetMapping(&quot;/&quot;) public String hello(@RequestParam String name) &#123; return &quot;Hello, &quot; + name + &quot;, ç°åœ¨æ—¶é—´ï¼š&quot; + System.currentTimeMillis(); &#125;&#125; è‡³æ­¤ï¼ŒæœåŠ¡æä¾›è€…å°±å¼€å‘å®Œæˆäº†ã€‚åˆ†åˆ«å¯åŠ¨æœåŠ¡æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡æä¾›è€…ï¼Œå¯ä»¥åœ¨æ³¨å†Œhttp://localhost:28081ä¸­å¿ƒçœ‹åˆ°EUERKA-PRODUCERæœåŠ¡ã€‚ è®¿é—®http://localhost:28084/hello/?name=zhangsan å¯ä»¥çœ‹åˆ°æœ‰è¿”å›ç»“æœï¼Œè¯´æ˜æœåŠ¡æä¾›è€…å·²ç»é…ç½®å®Œæˆã€‚ æœåŠ¡æ¶ˆè´¹è€…åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…æ ¹æ®ä½¿ç”¨ API çš„ä¸åŒï¼Œå¤§è‡´åˆ†ä¸ºä¸‰ç§æ–¹å¼ï¼ˆLoadBalancerClientã€Spring Cloud Ribbonå’ŒFeign è°ƒç”¨å®ç°ï¼‰ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ç”¨çš„åº”è¯¥éƒ½æ˜¯ Feignï¼Œè¿™é‡Œåªè®°å½•Feignã€‚ åˆ›å»ºä¸€ä¸ªåä¸ºeureka-consumerçš„SpringBootå·¥ç¨‹POMåŒ…é…ç½®&lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; é…ç½®æ–‡ä»¶spring: application: name: eureka-consumereureka: client: service-url: defaultZone: http://localhost:28081/eureka/server: port: 28085 å¯åŠ¨ç±»åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š@EnableFeignClients @EnableFeignClients@SpringBootApplicationpublic class EurekaConsumerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaConsumerApplication.class, args); &#125;&#125; Feign è°ƒç”¨å®ç°åˆ›å»ºä¸€ä¸ª Feign çš„å®¢æˆ·ç«¯æ¥å£å®šä¹‰ã€‚ä½¿ç”¨@FeignClientæ³¨è§£æ¥æŒ‡å®šè¿™ä¸ªæ¥å£æ‰€è¦è°ƒç”¨çš„æœåŠ¡åç§°ï¼Œæ¥å£ä¸­å®šä¹‰çš„å„ä¸ªå‡½æ•°ä½¿ç”¨ Spring MVC çš„æ³¨è§£å°±å¯ä»¥æ¥ç»‘å®šæœåŠ¡æä¾›æ–¹çš„ REST æ¥å£ï¼Œæ¯”å¦‚ä¸‹é¢å°±æ˜¯ç»‘å®š eureka-producer æœåŠ¡çš„/hello/æ¥å£çš„ä¾‹å­ï¼š @FeignClient(name = &quot;eureka-producer&quot;)public interface HelloRemote &#123; @GetMapping(&quot;/hello/&quot;) String hello(@RequestParam(value = &quot;name&quot;) String name);&#125; æ­¤ç±»ä¸­çš„æ–¹æ³•å’Œè¿œç¨‹æœåŠ¡ä¸­ Contoller ä¸­çš„æ–¹æ³•åå’Œå‚æ•°éœ€ä¿æŒä¸€è‡´ã€‚ Controllerå°†HelloRemoteæ³¨å…¥åˆ°Controllerä¸­ï¼Œåƒæ™®é€šæ–¹æ³•ä¸€æ ·è°ƒç”¨ã€‚ @RestController@RequestMapping(&quot;/hello&quot;)public class HelloController &#123; @Autowired HelloRemote helloRemote; @GetMapping(&quot;/&#123;name&#125;&quot;) public String index(@PathVariable(&quot;name&quot;) String name) &#123; return helloRemote.hello(name + &quot;!&quot;); &#125;&#125; é€šè¿‡ Spring Cloud Feign æ¥å®ç°æœåŠ¡è°ƒç”¨çš„æ–¹å¼éå¸¸ç®€å•ï¼Œé€šè¿‡@FeignClientå®šä¹‰çš„æ¥å£æ¥ç»Ÿä¸€çš„å£°æ˜æˆ‘ä»¬éœ€è¦ä¾èµ–çš„å¾®æœåŠ¡æ¥å£ã€‚è€Œåœ¨å…·ä½“ä½¿ç”¨çš„æ—¶å€™å°±è·Ÿè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€ç‚¹çš„è¿›è¡Œè°ƒç”¨å³å¯ã€‚ç”±äº Feign æ˜¯åŸºäº Ribbon å®ç°çš„ï¼Œæ‰€ä»¥å®ƒè‡ªå¸¦äº†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Ribbon çš„ IRule è¿›è¡Œç­–ç•¥æ‰©å±•ã€‚å¦å¤–ï¼ŒFeign è¿˜æ•´åˆçš„ Hystrix æ¥å®ç°æœåŠ¡çš„å®¹é”™ä¿æŠ¤ã€‚ åœ¨ Finchley.RC1 ç‰ˆæœ¬ä¸­ï¼ŒFeign çš„ Hystrix é»˜è®¤æ˜¯å…³é—­çš„ã€‚ å¯åŠ¨æœåŠ¡ï¼Œåœ¨æ³¨å†Œhttp://localhost:28081ä¸­å¿ƒçœ‹åˆ°eureka-consumeræœåŠ¡ã€‚ è®¿é—®http://localhost:28085/hello/zhangsanï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¯´æ˜æ¶ˆè´¹è€…æˆåŠŸæ¶ˆè´¹äº†æä¾›è€…çš„æœåŠ¡ã€‚ å…¶ä»–è¦æƒ³ä½¿ç”¨ Feignï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªä¾èµ– spring-boot-starter-web spring-cloud-starter-openfeign spring-cloud-starter-netflix-eureka-cli HelloRemoteç±»ä¸­çš„æ–¹æ³•å‚æ•°è¦åŠ ä¸Š@RequestParamæ³¨è§£Getè¯·æ±‚çš„ç±»å‹ï¼Œ è¦åŠ ä¸Š@RequestParamæ³¨è§£ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ã€‚ å½“å‚æ•°æ²¡æœ‰è¢«@RequestParamæ³¨è§£ä¿®é¥°æ—¶ï¼Œä¼šè‡ªåŠ¨è¢«å½“åš request body æ¥å¤„ç†ã€‚åªè¦æœ‰ bodyï¼Œå°±ä¼šè¢« Feign è®¤ä¸ºæ˜¯ POST è¯·æ±‚ï¼Œæ‰€ä»¥æ•´ä¸ªæœåŠ¡æ˜¯è¢«å½“ä½œå¸¦æœ‰ request parameter å’Œ body çš„ POST è¯·æ±‚å‘é€å‡ºå»çš„ã€‚ è´Ÿè½½å‡è¡¡å°†producerå·¥ç¨‹æ‰“åŒ…æˆJaråŒ…ï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚ å½“é€šè¿‡æ¶ˆè´¹è€…è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šäº¤æ›¿æ¶ˆè´¹ä¸¤ä¸ªæœåŠ¡ï¼Œä»¥æ­¤æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"SpringCloudï¼ˆæ³¨å†Œä¸­å¿ƒEurekaï¼‰","date":"2018-12-16T05:25:28.000Z","path":"2018/12/16/b21e91d6.html","text":"Eurekaæ˜¯Netflixå¼€æºçš„ä¸€æ¬¾æä¾›æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„äº§å“ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„Service Registryå’ŒService Discoveryå®ç°ã€‚ä¹Ÿæ˜¯springcloudä½“ç³»ä¸­æœ€é‡è¦æœ€æ ¸å¿ƒçš„ç»„ä»¶ä¹‹ä¸€ã€‚ æœåŠ¡ä¸­å¿ƒæœåŠ¡ä¸­å¿ƒåˆç§°æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†å„ç§æœåŠ¡åŠŸèƒ½åŒ…æ‹¬æœåŠ¡çš„æ³¨å†Œã€å‘ç°ã€ç†”æ–­ã€è´Ÿè½½ã€é™çº§ç­‰ï¼Œæ¯”å¦‚dubbo adminåå°çš„å„ç§åŠŸèƒ½ã€‚ EurekaEureka æ˜¯ä¸€ä¸ªåŸºäº REST çš„æœåŠ¡ï¼Œä¸»è¦åœ¨ AWS äº‘ä¸­ä½¿ç”¨, å®šä½æœåŠ¡æ¥è¿›è¡Œä¸­é—´å±‚æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ã€‚ Spring Cloud å°è£…äº† Netflix å…¬å¸å¼€å‘çš„ Eureka æ¨¡å—æ¥å®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚Eureka é‡‡ç”¨äº† C-S çš„è®¾è®¡æ¶æ„ã€‚Eureka Server ä½œä¸ºæœåŠ¡æ³¨å†ŒåŠŸèƒ½çš„æœåŠ¡å™¨ï¼Œå®ƒæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚è€Œç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ï¼Œä½¿ç”¨ Eureka çš„å®¢æˆ·ç«¯è¿æ¥åˆ° Eureka Serverï¼Œå¹¶ç»´æŒå¿ƒè·³è¿æ¥ã€‚è¿™æ ·ç³»ç»Ÿçš„ç»´æŠ¤äººå‘˜å°±å¯ä»¥é€šè¿‡ Eureka Server æ¥ç›‘æ§ç³»ç»Ÿä¸­å„ä¸ªå¾®æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚Spring Cloud çš„ä¸€äº›å…¶ä»–æ¨¡å—ï¼ˆæ¯”å¦‚Zuulï¼‰å°±å¯ä»¥é€šè¿‡ Eureka Server æ¥å‘ç°ç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ï¼Œå¹¶æ‰§è¡Œç›¸å…³çš„é€»è¾‘ã€‚ Eurekaç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼šEurekaæœåŠ¡å™¨å’ŒEurekaå®¢æˆ·ç«¯ã€‚EurekaæœåŠ¡å™¨ç”¨ä½œæœåŠ¡æ³¨å†ŒæœåŠ¡å™¨ã€‚Eurekaå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªjavaå®¢æˆ·ç«¯ï¼Œç”¨æ¥ç®€åŒ–ä¸æœåŠ¡å™¨çš„äº¤äº’ã€ä½œä¸ºè½®è¯¢è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶æä¾›æœåŠ¡çš„æ•…éšœåˆ‡æ¢æ”¯æŒã€‚Netflixåœ¨å…¶ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„æ˜¯å¦å¤–çš„å®¢æˆ·ç«¯ï¼Œå®ƒæä¾›åŸºäºæµé‡ã€èµ„æºåˆ©ç”¨ç‡ä»¥åŠå‡ºé”™çŠ¶æ€çš„åŠ æƒè´Ÿè½½å‡è¡¡ã€‚ Eurekaçš„åŸºæœ¬æ¶æ„ï¼Œç”±3ä¸ªè§’è‰²ç»„æˆï¼š 1ã€Eureka Server æä¾›æœåŠ¡æ³¨å†Œå’Œå‘ç° 2ã€Service Provider æœåŠ¡æä¾›æ–¹ å°†è‡ªèº«æœåŠ¡æ³¨å†Œåˆ°Eurekaï¼Œä»è€Œä½¿æœåŠ¡æ¶ˆè´¹æ–¹èƒ½å¤Ÿæ‰¾åˆ° 3ã€Service Consumer æœåŠ¡æ¶ˆè´¹æ–¹ ä»Eurekaè·å–æ³¨å†ŒæœåŠ¡åˆ—è¡¨ï¼Œä»è€Œèƒ½å¤Ÿæ¶ˆè´¹æœåŠ¡ æ¡ˆä¾‹Eureka Serverspring cloudå·²ç»å¸®æˆ‘å®ç°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦å¾ˆç®€å•çš„å‡ ä¸ªæ­¥éª¤å°±å¯ä»¥å®Œæˆã€‚ æ–°å»ºä¸€ä¸ªSpringBootå·¥ç¨‹ï¼Œå–åä¸ºeureka-serverï¼Œspringbootä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯2.1.1.RELEASE åœ¨pomä¸­æ·»åŠ ä¾èµ–ï¼š &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Finchley.RELEASE&lt;/spring-cloud.version&gt; &lt;/properties&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; è¿™é‡Œspring-cloudçš„ç‰ˆæœ¬ç”¨çš„æ˜¯Finchley.RELEASEï¼Œspring-bootçš„ç‰ˆæœ¬æ˜¯2.1.1.RELEASEã€‚å› æ­¤ä¾èµ–ä½¿ç”¨çš„æ˜¯spring-cloud-starter-netflix-eureka-server. åœ¨å¯åŠ¨ç±»ä¸­åŠ ä¸Š@EnableEurekaServeræ³¨è§£ @EnableEurekaServer@SpringBootApplicationpublic class EurekaServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaServerApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶ï¼š server: port: 28081spring: application: name: eureka-servereureka: client: fetch-registry: false register-with-eureka: false service-url: defaultZone: http://localhost:$&#123;server.port&#125;/eureka/ eureka.client.register-with-eureka ï¼šè¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverï¼Œé»˜è®¤ä¸ºtrueã€‚ eureka.client.fetch-registry ï¼šè¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚ eureka.client.serviceUrl.defaultZone ï¼šè®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€ï¼ŒæŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€ã€‚é»˜è®¤æ˜¯http://localhost:8761/eureka ï¼›å¤šä¸ªåœ°å€å¯ä½¿ç”¨ , åˆ†éš”ã€‚ å¯åŠ¨å·¥ç¨‹åï¼Œè®¿é—®ï¼šhttp://localhost:28081ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼Œå…¶ä¸­è¿˜æ²¡æœ‰å‘ç°ä»»ä½•æœåŠ¡ã€‚ é›†ç¾¤æ³¨å†Œä¸­å¿ƒè¿™ä¹ˆå…³é”®çš„æœåŠ¡ï¼Œå¦‚æœæ˜¯å•ç‚¹è¯ï¼Œé‡åˆ°æ•…éšœå°±æ˜¯æ¯ç­æ€§çš„ã€‚åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯æœ€é‡è¦çš„åŸºç¡€éƒ¨åˆ†ï¼Œç†åº”éšæ—¶å¤„äºå¯ä»¥æä¾›æœåŠ¡çš„çŠ¶æ€ã€‚ä¸ºäº†ç»´æŒå…¶å¯ç”¨æ€§ï¼Œä½¿ç”¨é›†ç¾¤æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚Eurekaé€šè¿‡äº’ç›¸æ³¨å†Œçš„æ–¹å¼æ¥å®ç°é«˜å¯ç”¨çš„éƒ¨ç½²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†Eureke Serveré…ç½®å…¶ä»–å¯ç”¨çš„serviceUrlå°±èƒ½å®ç°é«˜å¯ç”¨éƒ¨ç½²ã€‚ ä¸‰èŠ‚ç‚¹æ³¨å†Œä¸­å¿ƒå°è¯•ä¸€ä¸‹ä¸‰èŠ‚ç‚¹çš„æ³¨å†Œä¸­å¿ƒçš„æ­å»ºã€‚ ä¿®æ”¹application.ymlæ–‡ä»¶ï¼š spring: profiles: active: peer1---server: port: 28081spring: profiles: peer1 application: name: eureka-servereureka: instance: hostname: peer1 client: fetch-registry: false register-with-eureka: false service-url: defaultZone: http://peer2:28082/eureka/,http://peer3:28083/eureka/---server: port: 28082spring: profiles: peer2 application: name: eureka-servereureka: instance: hostname: peer2 client: fetch-registry: false register-with-eureka: false service-url: defaultZone: http://peer1:28081/eureka/,http://peer3:28083/eureka/---server: port: 28083spring: profiles: peer3 application: name: eureka-servereureka: instance: hostname: peer3 client: fetch-registry: false register-with-eureka: false service-url: defaultZone: http://peer2:28082/eureka/,http://peer1:28081/eureka/ ä¿®æ”¹æœ¬æœºçš„hostsæ–‡ä»¶ sudo vi /etc/hosts æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š 127.0.0.1 peer1 peer2 peer3 ç”¨æ¥æ¨¡æ‹Ÿä¸åŒçš„ç¯å¢ƒã€‚ æ‰“å¼€ideaçš„Terminalï¼Œä¾æ¬¡æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š # æ‰“åŒ…mvn clean package -Dmaven.test.skip=true# åˆ†åˆ«ä»¥ peer1 å’Œ peer2 é…ç½®ä¿¡æ¯å¯åŠ¨ Eurekajava -jar target/eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer1java -jar target/eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer2java -jar target/eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer3 ä¾æ¬¡å¯åŠ¨å®Œæˆåï¼Œè®¿é—®http://peer1:28081ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š åˆ°æ­¤ä¸‰èŠ‚ç‚¹çš„é…ç½®å·²ç»å®Œæˆã€‚ æ³¨æ„äº‹é¡¹ åœ¨æ­å»º Eureka Server é›†ç¾¤çš„æ—¶å€™ï¼Œè¦æŠŠeureka.client.register-with-eurekaå’Œeureka.client.fetch-registryå‡æ”¹ä¸ºtrueï¼ˆé»˜è®¤ï¼‰ã€‚å¦åˆ™ä¼šå‡ºç°å®ä¾‹åˆ—è¡¨ä¸ºç©ºï¼Œä¸” peer2 ä¸åœ¨ available-replicas è€Œåœ¨ unavailable-replicas çš„æƒ…å†µï¼ˆè¿™æ—¶å…¶å®åªæ˜¯å¯åŠ¨äº†ä¸¤ä¸ªå•ç‚¹å®ä¾‹ï¼‰ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"å¾®æœåŠ¡çš„ä¼˜ç¼ºç‚¹","date":"2018-12-15T05:51:26.000Z","path":"2018/12/15/ded3e7ee.html","text":"æœ¬æ–‡æ¥è‡ªNginxå®˜æ–¹åšå®¢ï¼Œæ˜¯å¾®æœåŠ¡ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œä¸»è¦æ¢è®¨äº†ä¼ ç»Ÿçš„å•ä½“å¼åº”ç”¨çš„ä¸è¶³ï¼Œä»¥åŠå¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜ã€‚æ­£å¦‚ä½œè€…æ‰€è¯´ï¼Œå¾®æœåŠ¡æ¶æ„æ›´é€‚åˆç”¨äºæ„å»ºå¤æ‚çš„åº”ç”¨ï¼Œå°½ç®¡å®ƒä¹Ÿæœ‰è‡ªå·±çš„ä¸è¶³ã€‚ è½¬è‡ªï¼šå¾®æœåŠ¡å®æˆ˜ï¼ˆä¸€ï¼‰ï¼šå¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ä¸ä¸è¶³ å•ä½“å¼åº”ç”¨çš„ä¸è¶³å•ä½“å¼åº”ç”¨å¼€å‘ç®€å•å´æœ‰å¾ˆå¤§çš„å±€é™æ€§ã€‚ä¸€ä¸ªç®€å•çš„åº”ç”¨ä¼šéšç€æ—¶é—´æ¨ç§»é€æ¸å˜å¤§ã€‚åœ¨æ¯æ¬¡çš„sprintä¸­ï¼Œå¼€å‘å›¢é˜Ÿéƒ½ä¼šé¢å¯¹æ–°â€œæ•…äº‹â€ï¼Œç„¶åå¼€å‘è®¸å¤šæ–°ä»£ç ã€‚å‡ å¹´åï¼Œè¿™ä¸ªå°è€Œç®€å•çš„åº”ç”¨ä¼šå˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„æ€ªç‰©ã€‚ ä¸€æ—¦ä½ çš„åº”ç”¨å˜æˆä¸€ä¸ªåˆå¤§åˆå¤æ‚çš„æ€ªç‰©ï¼Œé‚£å¼€å‘å›¢é˜Ÿè‚¯å®šå¾ˆç—›è‹¦ã€‚æ•æ·å¼€å‘å’Œéƒ¨ç½²ä¸¾æ­¥ç»´è‰°ï¼Œå…¶ä¸­æœ€ä¸»è¦é—®é¢˜å°±æ˜¯è¿™ä¸ªåº”ç”¨å¤ªå¤æ‚ï¼Œä»¥è‡³äºä»»ä½•å•ä¸ªå¼€å‘è€…éƒ½ä¸å¯èƒ½ææ‡‚å®ƒã€‚å› æ­¤ï¼Œä¿®æ­£bugå’Œæ­£ç¡®çš„æ·»åŠ æ–°åŠŸèƒ½å˜çš„éå¸¸å›°éš¾ï¼Œå¹¶ä¸”å¾ˆè€—æ—¶ã€‚å¦å¤–ï¼Œå›¢é˜Ÿå£«æ°”ä¹Ÿä¼šèµ°ä¸‹å¡è·¯ã€‚å¦‚æœä»£ç éš¾äºç†è§£ï¼Œå°±ä¸å¯èƒ½è¢«æ­£ç¡®çš„ä¿®æ”¹ã€‚æœ€ç»ˆä¼šèµ°å‘å·¨å¤§çš„ã€ä¸å¯ç†è§£çš„æ³¥æ½­ã€‚ å•ä½“å¼åº”ç”¨ä¹Ÿä¼šé™ä½å¼€å‘é€Ÿåº¦ã€‚åº”ç”¨è¶Šå¤§ï¼Œå¯åŠ¨æ—¶é—´ä¼šè¶Šé•¿ã€‚æ¯”å¦‚ï¼Œæœ€è¿‘çš„ä¸€ä¸ªè°ƒæŸ¥è¡¨æ˜ï¼Œæœ‰æ—¶å€™åº”ç”¨çš„å¯åŠ¨æ—¶é—´å±…ç„¶è¶…è¿‡äº†12åˆ†é’Ÿã€‚æˆ‘è¿˜å¬è¯´æŸäº›åº”ç”¨éœ€è¦40åˆ†é’Ÿå¯åŠ¨æ—¶é—´ã€‚å¦‚æœå¼€å‘è€…éœ€è¦ç»å¸¸é‡å¯åº”ç”¨ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†æ—¶é—´å°±è¦åœ¨ç­‰å¾…ä¸­æ¸¡è¿‡ï¼Œç”Ÿäº§æ•ˆç‡å—åˆ°æå¤§å½±å“ã€‚ å¦å¤–ï¼Œå¤æ‚è€Œå·¨å¤§çš„å•ä½“å¼åº”ç”¨ä¹Ÿä¸åˆ©äºæŒç»­æ€§å¼€å‘ã€‚ä»Šå¤©ï¼ŒSaaSåº”ç”¨å¸¸æ€å°±æ˜¯æ¯å¤©ä¼šæ”¹å˜å¾ˆå¤šæ¬¡ï¼Œè€Œè¿™å¯¹äºå•ä½“å¼åº”ç”¨æ¨¡å¼éå¸¸å›°éš¾ã€‚å¦å¤–ï¼Œè¿™ç§å˜åŒ–å¸¦æ¥çš„å½±å“å¹¶æ²¡æœ‰å¾ˆå¥½çš„è¢«ç†è§£ï¼Œæ‰€ä»¥ä¸å¾—ä¸åšå¾ˆå¤šæ‰‹å·¥æµ‹è¯•ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒæŒç»­éƒ¨ç½²ä¹Ÿä¼šå¾ˆè‰°éš¾ã€‚ å•ä½“å¼åº”ç”¨åœ¨ä¸åŒæ¨¡å—å‘ç”Ÿèµ„æºå†²çªæ—¶ï¼Œæ‰©å±•å°†ä¼šéå¸¸å›°éš¾ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å®Œæˆä¸€ä¸ªCPUæ•æ„Ÿé€»è¾‘ï¼Œåº”è¯¥éƒ¨ç½²åœ¨AWS EC2 Compute Optimized instancesï¼Œè€Œå¦å¤–ä¸€ä¸ªå†…å­˜æ•°æ®åº“æ¨¡å—æ›´åˆé€‚äºEC2 Memory-optimized instancesã€‚ç„¶è€Œï¼Œç”±äºè¿™äº›æ¨¡å—éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œå› æ­¤ä¸å¾—ä¸åœ¨ç¡¬ä»¶é€‰æ‹©ä¸Šåšä¸€ä¸ªå¦¥åã€‚ å•ä½“å¼åº”ç”¨å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯å¯é æ€§ã€‚å› ä¸ºæ‰€æœ‰æ¨¡å—éƒ½è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæ¨¡å—ä¸­çš„ä¸€ä¸ªbugï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²ï¼Œå°†ä¼šæœ‰å¯èƒ½å¼„å®æ•´ä¸ªè¿›ç¨‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå› ä¸ºæ‰€æœ‰åº”ç”¨å®ä¾‹éƒ½æ˜¯å”¯ä¸€çš„ï¼Œè¿™ä¸ªbugå°†ä¼šå½±å“åˆ°æ•´ä¸ªåº”ç”¨çš„å¯é æ€§ã€‚ æœ€åï¼Œå•ä½“å¼åº”ç”¨ä½¿å¾—é‡‡ç”¨æ–°æ¶æ„å’Œè¯­è¨€éå¸¸å›°éš¾ã€‚æ¯”å¦‚ï¼Œè®¾æƒ³ä½ æœ‰ä¸¤ç™¾ä¸‡è¡Œé‡‡ç”¨XYZæ¡†æ¶å†™çš„ä»£ç ã€‚å¦‚æœæƒ³æ”¹æˆABCæ¡†æ¶ï¼Œæ— è®ºæ˜¯æ—¶é—´è¿˜æ˜¯æˆæœ¬éƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œå³ä½¿ABCæ¡†æ¶æ›´å¥½ã€‚å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— æ³•é€¾è¶Šçš„é¸¿æ²Ÿã€‚ä½ ä¸å¾—ä¸åœ¨æœ€åˆé€‰æ‹©é¢å‰ä½å¤´ã€‚ æ€»ç»“ä¸€ä¸‹ï¼šä¸€å¼€å§‹ä½ æœ‰ä¸€ä¸ªå¾ˆæˆåŠŸçš„å…³é”®ä¸šåŠ¡åº”ç”¨ï¼Œåæ¥å°±å˜æˆäº†ä¸€ä¸ªå·¨å¤§çš„ï¼Œæ— æ³•ç†è§£çš„æ€ªç‰©ã€‚å› ä¸ºé‡‡ç”¨è¿‡æ—¶çš„ï¼Œæ•ˆç‡ä½çš„æŠ€æœ¯ï¼Œä½¿å¾—é›‡ä½£æœ‰æ½œåŠ›çš„å¼€å‘è€…å¾ˆå›°éš¾ã€‚åº”ç”¨æ— æ³•æ‰©å±•ï¼Œå¯é æ€§å¾ˆä½ï¼Œæœ€ç»ˆï¼Œæ•æ·æ€§å¼€å‘å’Œéƒ¨ç½²å˜çš„æ— æ³•å®Œæˆã€‚ å¾®å¤„ç†æ¶æ„â€”â€”å¤„ç†å¤æ‚äº‹ç‰©è®¸å¤šå…¬å¸ï¼Œæ¯”å¦‚Amazonã€eBayå’ŒNetFlixï¼Œé€šè¿‡é‡‡ç”¨å¾®å¤„ç†ç»“æ„æ¨¡å¼è§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚å…¶æ€è·¯ä¸æ˜¯å¼€å‘ä¸€ä¸ªå·¨å¤§çš„å•ä½“å¼çš„åº”ç”¨ï¼Œè€Œæ˜¯å°†åº”ç”¨åˆ†è§£ä¸ºå°çš„ã€äº’ç›¸è¿æ¥çš„å¾®æœåŠ¡ã€‚ ä¸€ä¸ªå¾®æœåŠ¡ä¸€èˆ¬å®ŒæˆæŸä¸ªç‰¹å®šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸‹å•ç®¡ç†ã€å®¢æˆ·ç®¡ç†ç­‰ç­‰ã€‚æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å¾®å‹å…­è§’å½¢åº”ç”¨ï¼Œéƒ½æœ‰è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å’Œé€‚é…å™¨ã€‚ä¸€äº›å¾®æœåŠ¡è¿˜ä¼šå‘å¸ƒAPIç»™å…¶å®ƒå¾®æœåŠ¡å’Œåº”ç”¨å®¢æˆ·ç«¯ä½¿ç”¨ã€‚å…¶å®ƒå¾®æœåŠ¡å®Œæˆä¸€ä¸ªWeb UIï¼Œè¿è¡Œæ—¶ï¼Œæ¯ä¸€ä¸ªå®ä¾‹å¯èƒ½æ˜¯ä¸€ä¸ªäº‘VMæˆ–è€…æ˜¯Dockerå®¹å™¨ã€‚ å¾®æœåŠ¡æ¶æ„æ¨¡å¼åœ¨ä¸Šå›¾ä¸­å¯¹åº”äºä»£è¡¨å¯æ‰©å±•Scale Cubeçš„Yè½´ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨ã€ŠThe Art of Scalabilityã€‹ä¹¦ä¸­æè¿°è¿‡çš„ä¸‰ç»´æ‰©å±•æ¨¡å‹ã€‚å¦å¤–ä¸¤ä¸ªå¯æ‰©å±•è½´ï¼ŒXè½´ç”±è´Ÿè½½å‡è¡¡å™¨åç«¯è¿è¡Œçš„å¤šä¸ªåº”ç”¨å‰¯æœ¬ç»„æˆï¼ŒZè½´æ˜¯å°†éœ€æ±‚è·¯ç”±åˆ°ç›¸å…³æœåŠ¡ã€‚ åº”ç”¨åŸºæœ¬å¯ä»¥ç”¨ä»¥ä¸Šä¸‰ä¸ªç»´åº¦æ¥è¡¨ç¤ºï¼ŒYè½´ä»£è¡¨å°†åº”ç”¨åˆ†è§£ä¸ºå¾®æœåŠ¡ã€‚è¿è¡Œæ—¶ï¼ŒXè½´ä»£è¡¨è¿è¡Œå¤šä¸ªéšè—åœ¨è´Ÿè½½å‡è¡¡å™¨ä¹‹åçš„å®ä¾‹ï¼Œæä¾›ååèƒ½åŠ›ã€‚ä¸€äº›åº”ç”¨å¯èƒ½è¿˜æ˜¯ç”¨Zè½´å°†æœåŠ¡åˆ†åŒºã€‚ä¸‹é¢çš„å›¾æ¼”ç¤ºè¡Œç¨‹ç®¡ç†æœåŠ¡å¦‚ä½•éƒ¨ç½²åœ¨è¿è¡ŒäºAWS EC2ä¸Šçš„Dockerä¸Šã€‚ è¿è¡Œæ—¶ï¼Œè¡Œç¨‹ç®¡ç†æœåŠ¡ç”±å¤šä¸ªæœåŠ¡å®ä¾‹æ„æˆã€‚æ¯ä¸€ä¸ªæœåŠ¡å®ä¾‹éƒ½æ˜¯ä¸€ä¸ªDockerå®¹å™¨ã€‚ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œè¿™äº›å®¹å™¨ä¸€èˆ¬éƒ½è¿è¡Œåœ¨å¤šä¸ªäº‘VMä¸Šã€‚æœåŠ¡å®ä¾‹å‰æ˜¯ä¸€å±‚è¯¸å¦‚NGINXçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä»–ä»¬è´Ÿè´£åœ¨å„ä¸ªå®ä¾‹é—´åˆ†å‘è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡å™¨ä¹ŸåŒæ—¶å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œä¾‹å¦‚ç¼“å­˜ã€æƒé™æ§åˆ¶ã€APIç»Ÿè®¡å’Œç›‘æ§ã€‚ è¿™ç§å¾®æœåŠ¡æ¶æ„æ¨¡å¼æ·±åˆ»å½±å“äº†åº”ç”¨å’Œæ•°æ®åº“ä¹‹é—´çš„å…³ç³»ï¼Œä¸åƒä¼ ç»Ÿå¤šä¸ªæœåŠ¡å…±äº«ä¸€ä¸ªæ•°æ®åº“ï¼Œå¾®æœåŠ¡æ¶æ„æ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“ã€‚å¦å¤–ï¼Œè¿™ç§æ€è·¯ä¹Ÿå½±å“åˆ°äº†ä¼ä¸šçº§æ•°æ®æ¨¡å¼ã€‚åŒæ—¶ï¼Œè¿™ç§æ¨¡å¼æ„å‘³ç€å¤šä»½æ•°æ®ï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³è·å¾—å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼Œæ¯ä¸ªæœåŠ¡ç‹¬æœ‰ä¸€ä¸ªæ•°æ®åº“æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºè¿™ç§æ¶æ„éœ€è¦è¿™ç§æ¾è€¦åˆã€‚ä¸‹é¢çš„å›¾æ¼”ç¤ºç¤ºä¾‹åº”ç”¨æ•°æ®åº“æ¶æ„ã€‚ æ¯ç§æœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œå¦å¤–ï¼Œæ¯ç§æœåŠ¡å¯ä»¥ç”¨æ›´é€‚åˆè‡ªå·±çš„æ•°æ®åº“ç±»å‹ï¼Œä¹Ÿè¢«ç§°ä½œå¤šè¯­è¨€ä¸€è‡´æ€§æ¶æ„ã€‚æ¯”å¦‚ï¼Œé©¾é©¶å‘˜ç®¡ç†ï¼ˆå‘ç°å“ªä¸ªé©¾é©¶å‘˜æ›´é è¿‘ä¹˜å®¢ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨æ”¯æŒåœ°ç†ä¿¡æ¯æŸ¥è¯¢çš„æ•°æ®åº“ã€‚ è¡¨é¢ä¸Šçœ‹æ¥ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æœ‰ç‚¹åƒSOAï¼Œä»–ä»¬éƒ½ç”±å¤šä¸ªæœåŠ¡æ„æˆã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä»å¦å¤–ä¸€ä¸ªè§’åº¦çœ‹æ­¤é—®é¢˜ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æ˜¯ä¸€ä¸ªä¸åŒ…å«WebæœåŠ¡ï¼ˆWS-ï¼‰å’ŒESBæœåŠ¡çš„SOAã€‚å¾®æœåŠ¡åº”ç”¨ä¹äºé‡‡ç”¨ç®€å•è½»é‡çº§åè®®ï¼Œæ¯”å¦‚RESTï¼Œè€Œä¸æ˜¯WS-ï¼Œåœ¨å¾®æœåŠ¡å†…éƒ¨é¿å…ä½¿ç”¨ESBä»¥åŠESBç±»ä¼¼åŠŸèƒ½ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ä¹Ÿæ‹’ç»ä½¿ç”¨canonical schemaç­‰SOAæ¦‚å¿µã€‚ å¾®æœåŠ¡çš„å¥½å¤„å¾®æœåŠ¡æ¶æ„æ¨¡å¼æœ‰å¾ˆå¤šå¥½å¤„ã€‚é¦–å…ˆï¼Œé€šè¿‡åˆ†è§£å·¨å¤§å•ä½“å¼åº”ç”¨ä¸ºå¤šä¸ªæœåŠ¡æ–¹æ³•è§£å†³äº†å¤æ‚æ€§é—®é¢˜ã€‚åœ¨åŠŸèƒ½ä¸å˜çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨è¢«åˆ†è§£ä¸ºå¤šä¸ªå¯ç®¡ç†çš„åˆ†æ”¯æˆ–æœåŠ¡ã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªç”¨RPC-æˆ–è€…æ¶ˆæ¯é©±åŠ¨APIå®šä¹‰æ¸…æ¥šçš„è¾¹ç•Œã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ç»™é‡‡ç”¨å•ä½“å¼ç¼–ç æ–¹å¼å¾ˆéš¾å®ç°çš„åŠŸèƒ½æä¾›äº†æ¨¡å—åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œç”±æ­¤ï¼Œå•ä¸ªæœåŠ¡å¾ˆå®¹æ˜“å¼€å‘ã€ç†è§£å’Œç»´æŠ¤ã€‚ ç¬¬äºŒï¼Œè¿™ç§æ¶æ„ä½¿å¾—æ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥æœ‰ä¸“é—¨å¼€å‘å›¢é˜Ÿæ¥å¼€å‘ã€‚å¼€å‘è€…å¯ä»¥è‡ªç”±é€‰æ‹©å¼€å‘æŠ€æœ¯ï¼Œæä¾›APIæœåŠ¡ã€‚å½“ç„¶ï¼Œè®¸å¤šå…¬å¸è¯•å›¾é¿å…æ··ä¹±ï¼Œåªæä¾›æŸäº›æŠ€æœ¯é€‰æ‹©ã€‚ç„¶åï¼Œè¿™ç§è‡ªç”±æ„å‘³ç€å¼€å‘è€…ä¸éœ€è¦è¢«è¿«ä½¿ç”¨æŸé¡¹ç›®å¼€å§‹æ—¶é‡‡ç”¨çš„è¿‡æ—¶æŠ€æœ¯ï¼Œä»–ä»¬å¯ä»¥é€‰æ‹©ç°åœ¨çš„æŠ€æœ¯ã€‚ç”šè‡³äºï¼Œå› ä¸ºæœåŠ¡éƒ½æ˜¯ç›¸å¯¹ç®€å•ï¼Œå³ä½¿ç”¨ç°åœ¨æŠ€æœ¯é‡å†™ä»¥å‰ä»£ç ä¹Ÿä¸æ˜¯å¾ˆå›°éš¾çš„äº‹æƒ…ã€‚ ç¬¬ä¸‰ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼æ˜¯æ¯ä¸ªå¾®æœåŠ¡ç‹¬ç«‹çš„éƒ¨ç½²ã€‚å¼€å‘è€…ä¸å†éœ€è¦åè°ƒå…¶å®ƒæœåŠ¡éƒ¨ç½²å¯¹æœ¬æœåŠ¡çš„å½±å“ã€‚è¿™ç§æ”¹å˜å¯ä»¥åŠ å¿«éƒ¨ç½²é€Ÿåº¦ã€‚UIå›¢é˜Ÿå¯ä»¥é‡‡ç”¨ABæµ‹è¯•ï¼Œå¿«é€Ÿçš„éƒ¨ç½²å˜åŒ–ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æŒç»­åŒ–éƒ¨ç½²æˆä¸ºå¯èƒ½ã€‚ æœ€åï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ‰©å±•ã€‚ä½ å¯ä»¥æ ¹æ®æ¯ä¸ªæœåŠ¡çš„è§„æ¨¡æ¥éƒ¨ç½²æ»¡è¶³éœ€æ±‚çš„è§„æ¨¡ã€‚ç”šè‡³äºï¼Œä½ å¯ä»¥ä½¿ç”¨æ›´é€‚åˆäºæœåŠ¡èµ„æºéœ€æ±‚çš„ç¡¬ä»¶ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨EC2 Compute Optimized instancesä¸Šéƒ¨ç½²CPUæ•æ„Ÿçš„æœåŠ¡ï¼Œè€Œåœ¨EC2 memory-optimized instancesä¸Šéƒ¨ç½²å†…å­˜æ•°æ®åº“ã€‚ å¾®æœåŠ¡çš„ä¸è¶³Fred Brooksåœ¨30å¹´å‰å†™é“ï¼Œâ€œthere are no silver bulletsâ€ï¼Œåƒä»»ä½•å…¶å®ƒç§‘æŠ€ä¸€æ ·ï¼Œå¾®æœåŠ¡æ¶æ„ä¹Ÿæœ‰ä¸è¶³ã€‚å…¶ä¸­ä¸€ä¸ªè·Ÿä»–çš„åå­—ç±»ä¼¼ï¼Œã€å¾®æœåŠ¡ã€å¼ºè°ƒäº†æœåŠ¡å¤§å°ï¼Œå®é™…ä¸Šï¼Œæœ‰ä¸€äº›å¼€å‘è€…é¼“å¹å»ºç«‹ç¨å¾®å¤§ä¸€äº›çš„ï¼Œ10-100 LOCæœåŠ¡ç»„ã€‚å°½ç®¡å°æœåŠ¡æ›´ä¹äºè¢«é‡‡ç”¨ï¼Œä½†æ˜¯ä¸è¦å¿˜äº†è¿™åªæ˜¯ç»ˆç«¯çš„é€‰æ‹©è€Œä¸æ˜¯æœ€ç»ˆçš„ç›®çš„ã€‚å¾®æœåŠ¡çš„ç›®çš„æ˜¯æœ‰æ•ˆçš„æ‹†åˆ†åº”ç”¨ï¼Œå®ç°æ•æ·å¼€å‘å’Œéƒ¨ç½²ã€‚ å¦å¤–ä¸€ä¸ªä¸»è¦çš„ä¸è¶³æ˜¯ï¼Œå¾®æœåŠ¡åº”ç”¨æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”±æ­¤ä¼šå¸¦æ¥å›ºæœ‰çš„å¤æ‚æ€§ã€‚å¼€å‘è€…éœ€è¦åœ¨RPCæˆ–è€…æ¶ˆæ¯ä¼ é€’ä¹‹é—´é€‰æ‹©å¹¶å®Œæˆè¿›ç¨‹é—´é€šè®¯æœºåˆ¶ã€‚æ›´ç”šäºï¼Œä»–ä»¬å¿…é¡»å†™ä»£ç æ¥å¤„ç†æ¶ˆæ¯ä¼ é€’ä¸­é€Ÿåº¦è¿‡æ…¢æˆ–è€…ä¸å¯ç”¨ç­‰å±€éƒ¨å¤±æ•ˆé—®é¢˜ã€‚å½“ç„¶è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼Œä½†ç›¸å¯¹äºå•ä½“å¼åº”ç”¨ä¸­é€šè¿‡è¯­è¨€å±‚çº§çš„æ–¹æ³•æˆ–è€…è¿›ç¨‹è°ƒç”¨ï¼Œå¾®æœåŠ¡ä¸‹è¿™ç§æŠ€æœ¯æ˜¾å¾—æ›´å¤æ‚ä¸€äº›ã€‚ å¦å¤–ä¸€ä¸ªå…³äºå¾®æœåŠ¡çš„æŒ‘æˆ˜æ¥è‡ªäºåˆ†åŒºçš„æ•°æ®åº“æ¶æ„ã€‚å•†ä¸šäº¤æ˜“ä¸­åŒæ—¶ç»™å¤šä¸ªä¸šåŠ¡åˆ†ä¸»ä½“æ›´æ–°æ¶ˆæ¯å¾ˆæ™®éã€‚è¿™ç§äº¤æ˜“å¯¹äºå•ä½“å¼åº”ç”¨æ¥è¯´å¾ˆå®¹æ˜“ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªæ•°æ®åº“ã€‚åœ¨å¾®æœåŠ¡æ¶æ„åº”ç”¨ä¸­ï¼Œéœ€è¦æ›´æ–°ä¸åŒæœåŠ¡æ‰€ä½¿ç”¨çš„ä¸åŒçš„æ•°æ®åº“ã€‚ä½¿ç”¨åˆ†å¸ƒå¼äº¤æ˜“å¹¶ä¸ä¸€å®šæ˜¯å¥½çš„é€‰æ‹©ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºCAPç†è®ºï¼Œè¿˜å› ä¸ºä»Šå¤©é«˜æ‰©å±•æ€§çš„NoSQLæ•°æ®åº“å’Œæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶å¹¶ä¸æ”¯æŒè¿™ä¸€éœ€æ±‚ã€‚æœ€ç»ˆä½ ä¸å¾—ä¸ä½¿ç”¨ä¸€ä¸ªæœ€ç»ˆä¸€è‡´æ€§çš„æ–¹æ³•ï¼Œä»è€Œå¯¹å¼€å‘è€…æå‡ºäº†æ›´é«˜çš„è¦æ±‚å’ŒæŒ‘æˆ˜ã€‚ æµ‹è¯•ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„åº”ç”¨ä¹Ÿæ˜¯å¾ˆå¤æ‚çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼Œé‡‡ç”¨æµè¡Œçš„Spring Bootæ¶æ„ï¼Œå¯¹ä¸€ä¸ªå•ä½“å¼webåº”ç”¨ï¼Œæµ‹è¯•å®ƒçš„REST APIï¼Œæ˜¯å¾ˆå®¹æ˜“çš„äº‹æƒ…ã€‚åè¿‡æ¥ï¼ŒåŒæ ·çš„æœåŠ¡æµ‹è¯•éœ€è¦å¯åŠ¨å’Œå®ƒæœ‰å…³çš„æ‰€æœ‰æœåŠ¡ï¼ˆè‡³å°‘éœ€è¦è¿™äº›æœåŠ¡çš„stubsï¼‰ã€‚å†é‡ç”³ä¸€æ¬¡ï¼Œä¸èƒ½ä½ä¼°äº†é‡‡ç”¨å¾®æœåŠ¡æ¶æ„å¸¦æ¥çš„å¤æ‚æ€§ã€‚ å¦å¤–ä¸€ä¸ªæŒ‘æˆ˜åœ¨äºï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼åº”ç”¨çš„æ”¹å˜å°†ä¼šæ³¢åŠå¤šä¸ªæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå‡è®¾ä½ åœ¨å®Œæˆä¸€ä¸ªæ¡ˆä¾‹ï¼Œéœ€è¦ä¿®æ”¹æœåŠ¡Aã€Bã€Cï¼Œè€ŒAä¾èµ–Bï¼ŒBä¾èµ–Cã€‚åœ¨å•ä½“å¼åº”ç”¨ä¸­ï¼Œä½ åªéœ€è¦æ”¹å˜ç›¸å…³æ¨¡å—ï¼Œæ•´åˆå˜åŒ–ï¼Œéƒ¨ç½²å°±å¥½äº†ã€‚å¯¹æ¯”ä¹‹ä¸‹ï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼å°±éœ€è¦è€ƒè™‘ç›¸å…³æ”¹å˜å¯¹ä¸åŒæœåŠ¡çš„å½±å“ã€‚æ¯”å¦‚ï¼Œä½ éœ€è¦æ›´æ–°æœåŠ¡Cï¼Œç„¶åæ˜¯Bï¼Œæœ€åæ‰æ˜¯Aï¼Œå¹¸è¿çš„æ˜¯ï¼Œè®¸å¤šæ”¹å˜ä¸€èˆ¬åªå½±å“ä¸€ä¸ªæœåŠ¡ï¼Œè€Œéœ€è¦åè°ƒå¤šæœåŠ¡çš„æ”¹å˜å¾ˆå°‘ã€‚ éƒ¨ç½²ä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨ä¹Ÿå¾ˆå¤æ‚ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨åªéœ€è¦ç®€å•åœ¨å¤æ‚å‡è¡¡å™¨åé¢éƒ¨ç½²å„è‡ªçš„æœåŠ¡å™¨å°±å¥½äº†ã€‚æ¯ä¸ªåº”ç”¨å®ä¾‹æ˜¯éœ€è¦é…ç½®è¯¸å¦‚æ•°æ®åº“å’Œæ¶ˆæ¯ä¸­é—´ä»¶ç­‰åŸºç¡€æœåŠ¡ã€‚ç›¸å¯¹æ¯”ï¼Œä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨ä¸€èˆ¬ç”±å¤§æ‰¹æœåŠ¡æ„æˆã€‚ä¾‹å¦‚ï¼Œæ ¹æ®Adrian Cockcroftï¼ŒHailoæœ‰160ä¸ªä¸åŒæœåŠ¡æ„æˆï¼ŒNetFlixæœ‰å¤§çº¦600ä¸ªæœåŠ¡ã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰å¤šä¸ªå®ä¾‹ã€‚è¿™å°±é€ æˆè®¸å¤šéœ€è¦é…ç½®ã€éƒ¨ç½²ã€æ‰©å±•å’Œç›‘æ§çš„éƒ¨åˆ†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜éœ€è¦å®Œæˆä¸€ä¸ªæœåŠ¡å‘ç°æœºåˆ¶ï¼ˆåç»­æ–‡ç« ä¸­å‘è¡¨ï¼‰ï¼Œä»¥ç”¨æ¥å‘ç°ä¸å®ƒé€šè®¯æœåŠ¡çš„åœ°å€ï¼ˆåŒ…æ‹¬æœåŠ¡å™¨åœ°å€å’Œç«¯å£ï¼‰ã€‚ä¼ ç»Ÿçš„è§£å†³é—®é¢˜åŠæ³•ä¸èƒ½ç”¨äºè§£å†³è¿™ä¹ˆå¤æ‚çš„é—®é¢˜ã€‚æ¥ç»­è€Œæ¥ï¼ŒæˆåŠŸéƒ¨ç½²ä¸€ä¸ªå¾®æœåŠ¡åº”ç”¨éœ€è¦å¼€å‘è€…æœ‰è¶³å¤Ÿçš„æ§åˆ¶éƒ¨ç½²æ–¹æ³•ï¼Œå¹¶é«˜åº¦è‡ªåŠ¨åŒ–ã€‚ ä¸€ç§è‡ªåŠ¨åŒ–æ–¹æ³•æ˜¯ä½¿ç”¨PaaSæœåŠ¡ï¼Œä¾‹å¦‚Cloud Foundryã€‚PaaSç»™å¼€å‘è€…æä¾›ä¸€ä¸ªéƒ¨ç½²å’Œç®¡ç†å¾®æœåŠ¡çš„ç®€å•æ–¹æ³•ï¼Œå®ƒæŠŠæ‰€æœ‰è¿™äº›é—®é¢˜éƒ½æ‰“åŒ…å†…ç½®è§£å†³äº†ã€‚åŒæ—¶ï¼Œé…ç½®PaaSçš„ç³»ç»Ÿå’Œç½‘ç»œä¸“å®¶å¯ä»¥é‡‡ç”¨æœ€ä½³å®è·µå’Œç­–ç•¥æ¥ç®€åŒ–è¿™äº›é—®é¢˜ã€‚å¦å¤–ä¸€ä¸ªè‡ªåŠ¨éƒ¨ç½²å¾®æœåŠ¡åº”ç”¨çš„æ–¹æ³•æ˜¯å¼€å‘å¯¹äºä½ æ¥è¯´æœ€åŸºç¡€çš„PaaSç³»ç»Ÿã€‚ä¸€ä¸ªå…¸å‹çš„å¼€å§‹ç‚¹æ˜¯ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤åŒ–æ–¹æ¡ˆï¼Œæ¯”å¦‚é…åˆDockerä½¿ç”¨Mesosæˆ–è€…Kubernetesã€‚åé¢çš„ç³»åˆ—æˆ‘ä»¬ä¼šçœ‹çœ‹å¦‚ä½•åŸºäºè½¯ä»¶éƒ¨ç½²æ–¹æ³•ä¾‹å¦‚NGINXï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨å¾®æœåŠ¡å±‚é¢æä¾›ç¼“å­˜ã€æƒé™æ§åˆ¶ã€APIç»Ÿè®¡å’Œç›‘æ§ã€‚ æ€»ç»“æ„å»ºå¤æ‚çš„åº”ç”¨çœŸçš„æ˜¯éå¸¸å›°éš¾ã€‚å•ä½“å¼çš„æ¶æ„æ›´é€‚åˆè½»é‡çº§çš„ç®€å•åº”ç”¨ã€‚å¦‚æœä½ ç”¨å®ƒæ¥å¼€å‘å¤æ‚åº”ç”¨ï¼Œé‚£çœŸçš„ä¼šå¾ˆç³Ÿç³•ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼å¯ä»¥ç”¨æ¥æ„å»ºå¤æ‚åº”ç”¨ï¼Œå½“ç„¶ï¼Œè¿™ç§æ¶æ„æ¨¡å‹ä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹å’ŒæŒ‘æˆ˜ã€‚","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}]},{"title":"Spring Cloudä¸­çš„åè¯è§£é‡Š","date":"2018-12-02T07:49:29.000Z","path":"2018/12/02/60e9e95d.html","text":"å¾®æœåŠ¡è¿‘å¹´æ¥ï¼Œåœ¨è½¯ä»¶å¼€å‘é¢†åŸŸå…³äºå¾®æœåŠ¡çš„è®¨è®ºå‘ˆç°å‡ºç«çˆ†çš„å±€é¢ï¼Œæœ‰äººå€¾å‘äºåœ¨ç³»ç»Ÿè®¾è®¡ä¸å¼€å‘ä¸­é‡‡ç”¨å¾®æœåŠ¡æ–¹å¼å®ç°è½¯ä»¶ç³»ç»Ÿçš„æ¾è€¦åˆã€è·¨éƒ¨é—¨å¼€å‘ï¼Œè¢«è®¤ä¸ºæ˜¯ITè½¯ä»¶æ¶æ„çš„æœªæ¥æ–¹å‘ï¼ŒMartin Fowlerä¹Ÿç»™å¾®æœåŠ¡æ¶æ„æé«˜çš„è¯„ä»·ï¼›åŒæ—¶ï¼Œåå¯¹ä¹‹å£°ä¹Ÿå¾ˆå¼ºçƒˆï¼ŒæŒåå¯¹è§‚ç‚¹çš„äººè¡¨ç¤ºå¾®æœåŠ¡å¢åŠ äº†ç³»ç»Ÿç»´æŠ¤ã€éƒ¨ç½²çš„éš¾åº¦ï¼Œå¯¼è‡´ä¸€äº›åŠŸèƒ½æ¨¡å—æˆ–ä»£ç æ— æ³•å¤ç”¨ï¼ŒåŒæ—¶å¾®æœåŠ¡å…è®¸ä½¿ç”¨ä¸åŒçš„è¯­è¨€å’Œæ¡†æ¶æ¥å¼€å‘å„ä¸ªç³»ç»Ÿæ¨¡å—ï¼Œè¿™åˆä¼šå¢åŠ ç³»ç»Ÿé›†æˆä¸æµ‹è¯•çš„éš¾åº¦ï¼Œè€Œä¸”éšç€ç³»ç»Ÿè§„æ¨¡çš„æ—¥æ¸å¢é•¿ï¼Œå¾®æœåŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿä¼šå¯¼è‡´ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚å°½ç®¡ä¸€äº›å…¬å¸å·²ç»åœ¨ç”Ÿäº§ç³»ç»Ÿä¸­é‡‡ç”¨äº†å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶ä¸”å–å¾—äº†è‰¯å¥½çš„æ•ˆæœï¼›ä½†æ›´å¤šå…¬å¸è¿˜æ˜¯å¤„åœ¨è§‚æœ›çš„æ€åº¦ã€‚ ä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ¶æ„å‘¢ï¼Ÿç®€å•è¯´å°±æ˜¯å°†ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ï¼ˆå•ä½“åº”ç”¨ï¼‰æŒ‰ç…§ä¸€å®šçš„æ‹†åˆ†è§„åˆ™ï¼ˆåæ–‡è®²è¿°ï¼‰æ‹†åˆ†æˆå¤šä¸ªä¸åŒçš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½èƒ½ç‹¬ç«‹åœ°è¿›è¡Œå¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•ã€‚æœåŠ¡äºæœåŠ¡ä¹‹é—´é€šè¿‡æ³¨å…¥RESTful apiæˆ–å…¶ä»–æ–¹å¼è°ƒç”¨ã€‚ ç‰ˆæœ¬ç‰ˆæœ¬å·åŒ…å« è‹±æ–‡å•è¯ï¼ˆrelease trainï¼‰ + SRXï¼ˆservice releaseï¼‰ï¼ˆXï¼šæ•°å­—ï¼‰ release trainï¼šæŒ‰ä¼¦æ•¦åœ°é“ç«™åA-Zè¿›è¡Œé¦–å­—æ¯è¿­ä»£æ’åº SRï¼šä¸€èˆ¬è¡¨ç¤ºå½“å‰ä¿®å¤BUGçš„ç‰ˆæœ¬ç¼–å· ä¾‹ï¼šCamden SR4ã€Camden SR5ã€Dalston SR1 è€Œå¤§å¤šæ•°Springé¡¹ç›®éƒ½ä»¥â€œä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.å¢é‡ç‰ˆæœ¬å·.é‡Œç¨‹ç¢‘ç‰ˆæœ¬å·â€çš„å½¢å¼å‘½åç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ Spring Framework ç¨³å®šç‰ˆæœ¬ 4.3.5.RELEASEã€é‡Œç¨‹ç¢‘ç‰ˆæœ¬ 5.0.0.M4 ç­‰ã€‚ Spring CloudSpring Cloudæ˜¯åœ¨Spring Bootçš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œç”¨äºç®€åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿæ„å»ºçš„å·¥å…·é›†ï¼Œä¸ºå¼€å‘äººå‘˜æä¾›å¿«é€Ÿå»ºç«‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€äº›å¸¸è§çš„æ¨¡å¼ã€‚ ä¾‹å¦‚ï¼šé…ç½®ç®¡ç†ï¼ˆconfiguration managementï¼‰ï¼ŒæœåŠ¡å‘ç°ï¼ˆservice discoveryï¼‰ï¼Œæ–­è·¯å™¨ï¼ˆcircuit breakersï¼‰ï¼Œæ™ºèƒ½è·¯ç”±ï¼ˆ intelligent routingï¼‰ï¼Œå¾®ä»£ç†ï¼ˆmicro-proxyï¼‰ï¼Œæ§åˆ¶æ€»çº¿ï¼ˆcontrol busï¼‰ï¼Œä¸€æ¬¡æ€§ä»¤ç‰Œï¼ˆ one-time tokensï¼‰ï¼Œå…¨å±€é”ï¼ˆglobal locksï¼‰ï¼Œé¢†å¯¼é€‰ä¸¾ï¼ˆleadership electionï¼‰ï¼Œåˆ†å¸ƒå¼ä¼šè¯ï¼ˆdistributed sessionsï¼‰ï¼Œé›†ç¾¤çŠ¶æ€ï¼ˆcluster stateï¼‰ã€‚ Spring Cloud åŒ…å«äº†å¤šä¸ªå­é¡¹ç›®ï¼š ä¾‹å¦‚ï¼šSpring Cloud Configã€Spring Cloud Netflixç­‰ Spring Cloud é¡¹ç›®ä¸»é¡µï¼šhttp://projects.spring.io/spring-cloud/ æœåŠ¡å‘ç°åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰æ˜¯å…³é”®åŸåˆ™ä¹‹ä¸€ã€‚æ‰‹åŠ¨é…ç½®æ¯ä¸ªå®¢æˆ·ç«¯æˆ–æŸç§å½¢å¼çš„çº¦å®šæ˜¯å¾ˆéš¾åšçš„ï¼Œå¹¶ä¸”å¾ˆè„†å¼±ã€‚Spring Cloudæä¾›äº†å¤šç§æœåŠ¡å‘ç°çš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚ï¼šEurekaã€Consulã€Zookeeperã€‚ EurekaEurekaæ˜¯Netflixå¼€å‘çš„æœåŠ¡å‘ç°ç»„ä»¶ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªåŸºäºRESTçš„æœåŠ¡ã€‚ Spring Cloudå°†å®ƒé›†æˆåœ¨å…¶å­é¡¹ç›®spring-cloud-netflixä¸­ï¼Œä»¥å®ç°Spring Cloudçš„æœåŠ¡å‘ç°åŠŸèƒ½ã€‚ ConsulConsul æ˜¯ HashiCorp å…¬å¸æ¨å‡ºçš„å¼€æºå·¥å…·ï¼Œç”¨äºå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœåŠ¡å‘ç°ä¸é…ç½®ã€‚ä¸å…¶ä»–åˆ†å¸ƒå¼æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ–¹æ¡ˆï¼ŒConsulçš„æ–¹æ¡ˆæ›´â€œä¸€ç«™å¼â€ï¼Œå†…ç½®äº†æœåŠ¡æ³¨å†Œä¸å‘ç°æ¡† æ¶ã€åˆ†å¸ƒä¸€è‡´æ€§åè®®å®ç°ã€å¥åº·æ£€æŸ¥ã€Key/Valueå­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒæ–¹æ¡ˆï¼Œä¸å†éœ€è¦ä¾èµ–å…¶ä»–å·¥å…·ï¼ˆæ¯”å¦‚ZooKeeperç­‰ï¼‰ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒ ä¸ºç®€å•ã€‚Consulä½¿ç”¨Goè¯­è¨€ç¼–å†™ï¼Œå› æ­¤å…·æœ‰å¤©ç„¶å¯ç§»æ¤æ€§(æ”¯æŒLinuxã€windowså’ŒMac OS X)ï¼›å®‰è£…åŒ…ä»…åŒ…å«ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–¹ä¾¿éƒ¨ç½²ï¼Œä¸Dockerç­‰è½»é‡çº§å®¹å™¨å¯æ— ç¼é…åˆ ã€‚ RibbonRibbonæ˜¯Netflixå‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå°†Netflixçš„ä¸­é—´å±‚æœåŠ¡è¿æ¥åœ¨ä¸€èµ·ã€‚Ribbonå®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ—å‡ºLoad Balanceråé¢æ‰€æœ‰çš„æœºå™¨ï¼ŒRibbonä¼šè‡ªåŠ¨çš„å¸®åŠ©ä½ åŸºäºæŸç§è§„åˆ™ï¼ˆå¦‚ç®€å•è½®è¯¢ï¼Œéšæœºè¿æ¥ç­‰ï¼‰å»è¿æ¥è¿™äº›æœºå™¨ã€‚æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨Ribbonå®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚ç®€å•åœ°è¯´ï¼ŒRibbonæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ã€‚ Ribbonå·¥ä½œæ—¶åˆ†ä¸ºä¸¤æ­¥ï¼šç¬¬ä¸€æ­¥å…ˆé€‰æ‹© Eureka Server, å®ƒä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªZoneä¸”è´Ÿè½½è¾ƒå°‘çš„Serverï¼›ç¬¬äºŒæ­¥å†æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œåœ¨ä»Serverå–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚å…¶ä¸­Ribbonæä¾›äº†å¤šç§ç­–ç•¥ï¼Œä¾‹å¦‚è½®è¯¢ã€éšæœºã€æ ¹æ®å“åº”æ—¶é—´åŠ æƒç­‰ã€‚ FeignFeignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„web serviceå®¢æˆ·ç«¯ï¼Œå®ƒä½¿å¾—ç¼–å†™web serviceå®¢æˆ·ç«¯æ›´ä¸ºå®¹æ˜“ã€‚åˆ›å»ºæ¥å£ï¼Œä¸ºæ¥å£æ·»åŠ æ³¨è§£ï¼Œå³å¯ä½¿ç”¨Feignã€‚Feignå¯ä»¥ä½¿ç”¨Feignæ³¨è§£æˆ–è€…JAX-RSæ³¨è§£ï¼Œè¿˜æ”¯æŒçƒ­æ’æ‹”çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚Spring Cloudä¸ºFeignæ·»åŠ äº†Spring MVCçš„æ³¨è§£æ”¯æŒï¼Œå¹¶æ•´åˆäº†Ribbonå’ŒEurekaæ¥ä¸ºä½¿ç”¨Feignæ—¶æä¾›è´Ÿè½½å‡è¡¡ã€‚ ç†”æ–­å™¨é›ªå´©æ•ˆåº”åœ¨å¾®æœåŠ¡æ¶æ„ä¸­é€šå¸¸ä¼šæœ‰å¤šä¸ªæœåŠ¡å±‚è°ƒç”¨ï¼ŒåŸºç¡€æœåŠ¡çš„æ•…éšœå¯èƒ½ä¼šå¯¼è‡´çº§è”æ•…éšœï¼Œè¿›è€Œé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µï¼Œè¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”ã€‚æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å› â€œæœåŠ¡æä¾›è€…â€çš„ä¸å¯ç”¨å¯¼è‡´â€œæœåŠ¡æ¶ˆè´¹è€…â€çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§çš„è¿‡ç¨‹ã€‚ å¦‚æœä¸‹å›¾æ‰€ç¤ºï¼šAä½œä¸ºæœåŠ¡æä¾›è€…ï¼ŒBä¸ºAçš„æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCå’ŒDæ˜¯Bçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚Aä¸å¯ç”¨å¼•èµ·äº†Bçš„ä¸å¯ç”¨ï¼Œå¹¶å°†ä¸å¯ç”¨åƒæ»šé›ªçƒä¸€æ ·æ”¾å¤§åˆ°Cå’ŒDæ—¶ï¼Œé›ªå´©æ•ˆåº”å°±å½¢æˆäº†ã€‚ ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰ç†”æ–­å™¨çš„åŸç†å¾ˆç®€å•ï¼Œå¦‚åŒç”µåŠ›è¿‡è½½ä¿æŠ¤å™¨ã€‚å®ƒå¯ä»¥å®ç°å¿«é€Ÿå¤±è´¥ï¼Œå¦‚æœå®ƒåœ¨ä¸€æ®µæ—¶é—´å†…ä¾¦æµ‹åˆ°è®¸å¤šç±»ä¼¼çš„é”™è¯¯ï¼Œä¼šå¼ºè¿«å…¶ä»¥åçš„å¤šä¸ªè°ƒç”¨å¿«é€Ÿå¤±è´¥ï¼Œä¸å†è®¿é—®è¿œç¨‹æœåŠ¡å™¨ï¼Œä»è€Œé˜²æ­¢åº”ç”¨ç¨‹åºä¸æ–­åœ°å°è¯•æ‰§è¡Œå¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œï¼Œä½¿å¾—åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œè€Œä¸ç”¨ç­‰å¾…ä¿®æ­£é”™è¯¯ï¼Œæˆ–è€…æµªè´¹CPUæ—¶é—´å»ç­‰åˆ°é•¿æ—¶é—´çš„è¶…æ—¶äº§ç”Ÿã€‚ç†”æ–­å™¨ä¹Ÿå¯ä»¥ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè¯Šæ–­é”™è¯¯æ˜¯å¦å·²ç»ä¿®æ­£ï¼Œå¦‚æœå·²ç»ä¿®æ­£ï¼Œåº”ç”¨ç¨‹åºä¼šå†æ¬¡å°è¯•è°ƒç”¨æ“ä½œã€‚ ç†”æ–­å™¨æ¨¡å¼å°±åƒæ˜¯é‚£äº›å®¹æ˜“å¯¼è‡´é”™è¯¯çš„æ“ä½œçš„ä¸€ç§ä»£ç†ã€‚è¿™ç§ä»£ç†èƒ½å¤Ÿè®°å½•æœ€è¿‘è°ƒç”¨å‘ç”Ÿé”™è¯¯çš„æ¬¡æ•°ï¼Œç„¶åå†³å®šä½¿ç”¨å…è®¸æ“ä½œç»§ç»­ï¼Œæˆ–è€…ç«‹å³è¿”å›é”™è¯¯ã€‚ ç†”æ–­å™¨å¼€å…³ç›¸äº’è½¬æ¢çš„é€»è¾‘å¦‚ä¸‹å›¾ï¼š Hystrixåœ¨Spring Cloudä¸­ä½¿ç”¨äº†Netflixå¼€å‘çš„Hystrixæ¥å®ç°ç†”æ–­å™¨ã€‚ Hystrix DashboardHystrixç›‘æ§ï¼Œé™¤äº†éš”ç¦»ä¾èµ–æœåŠ¡çš„è°ƒç”¨ä»¥å¤–ï¼ŒHystrixè¿˜æä¾›äº†è¿‘å®æ—¶çš„ç›‘æ§ï¼ŒHystrixä¼šå®æ—¶ã€ç´¯åŠ åœ°è®°å½•æ‰€æœ‰å…³äºHystrixCommandçš„æ‰§è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ç§’æ‰§è¡Œå¤šå°‘è¯·æ±‚å¤šå°‘æˆåŠŸï¼Œå¤šå°‘å¤±è´¥ç­‰ã€‚Netflixé€šè¿‡hystrix-metrics-event-streamé¡¹ç›®å®ç°äº†å¯¹ä»¥ä¸ŠæŒ‡æ ‡çš„ç›‘æ§ã€‚ Turbineåœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹ç»å¸¸éœ€è¦éƒ¨ç½²ä¸Šç™¾ç”šè‡³ä¸Šåƒä¸ªï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿ç»´äººå‘˜å¸Œæœ›èƒ½å¤ŸæŠŠç›¸åŒæœåŠ¡çš„èŠ‚ç‚¹çŠ¶æ€ä»¥ä¸€ä¸ªæ•´ä½“é›†ç¾¤çš„å½¢å¼å±•ç°å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„æŠŠæ¡æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ã€‚ ä¸ºæ­¤ï¼ŒNetflixæä¾›äº†ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ˆTurbineï¼‰æ¥æä¾›æŠŠå¤šä¸ªhystrix.streamçš„å†…å®¹èšåˆä¸ºä¸€ä¸ªæ•°æ®æºä¾›Dashboardå±•ç¤ºã€‚ å’ŒHystrix Dashboardä¸€æ ·ï¼ŒTurbineä¹Ÿå¯ä»¥ä¸‹è½½waråŒ…éƒ¨ç½²åˆ°Webå®¹å™¨ã€‚ ZuulNetflixå¼€æºçš„å¾®æœåŠ¡ç½‘å…³ï¼Œæ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—è¿‡æ»¤å™¨ï¼š èº«ä»½è®¤è¯å®‰å…¨ å®¡æŸ¥ä¸ç›‘æ§ åŠ¨æ€è·¯ç”± å‹åŠ›æµ‹è¯• é™„å†åˆ†é… é™æ€å“åº”å¤„ç† å¤šåŒºåŸŸå¼¹æ€§ Zuulè¿‡æ»¤å™¨Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ä¸»è¦ä¸º4ç§æ ‡å‡†ç±»å‹ï¼š PREï¼šåœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ ROUTINGï¼šè¿™ç§è¿‡æ»¤å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡ POSTï¼šåœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œ ERRORï¼šåœ¨å…¶ä»–é˜¶æ®µå‘ç”Ÿé”™è¯¯æ—¶è‡ªä¿¡è¯¥è¿‡æ»¤å™¨ Sleuthä¸ºSpring Cloud æä¾›äº†åˆ†å¸ƒå¼è·Ÿè¸ªçš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¤§é‡å€ŸåŠ©äº†Google Dapperã€Twitter Zipkin å’Œ Apache HTraceçš„è®¾è®¡ã€‚Sleuthçš„æœ¯è¯­ï¼šspanï¼ˆè·¨åº¦ï¼‰ã€traceï¼ˆè·Ÿè¸ªï¼‰ã€annotationï¼ˆæ ‡æ³¨ï¼‰ é…ç½®ä¸­å¿ƒSpring Cloud Configæä¾›äº†ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤–éƒ¨åŒ–é…ç½®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ”¯æŒã€‚é…ç½®æœåŠ¡å™¨æœ‰ä¸€ä¸ªä¸­å¿ƒä½ç½®ï¼Œç®¡ç†æ‰€æœ‰ç¯å¢ƒä¸‹çš„åº”ç”¨çš„å¤–éƒ¨å±æ€§ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ˜ å°„åˆ°ç›¸åŒSpring Eventment å’Œ PropertySrouceæŠ½è±¡çš„æ¦‚å¿µï¼Œæ‰€ä»¥éå¸¸é€‚åˆSpringåº”ç”¨ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨ä»»ä½•è¯­è¨€å¼€å‘çš„ä»»ä½•åº”ç”¨ä¸­ä½¿ç”¨ã€‚åœ¨ä¸€ä¸ªåº”ç”¨ä»å¼€å‘ã€æµ‹è¯•åˆ°ç”Ÿäº§çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥åˆ†åˆ«åœ°ç®¡ç†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„é…ç½®ï¼Œå¹¶ä¸”åœ¨è¿ç§»çš„æ—¶å€™è·å–ç›¸åº”çš„é…ç½®æ¥è¿è¡Œã€‚ Config Server å­˜å‚¨åç«¯é»˜è®¤ä½¿ç”¨gitå­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œå› æ­¤å¯ä»¥å¾ˆå®¹æ˜“æ”¯æŒæ ‡è®°é…ç½®ç¯å¢ƒçš„ç‰ˆæœ¬ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä½¿ç”¨å¹¿æ³›çš„å·¥å…·ç®¡ç†é…ç½®å†…å®¹ã€‚å½“ç„¶æ·»åŠ å…¶ä»–æ–¹å¼çš„å­˜å‚¨å®ç°ä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„ã€‚ API GatewayAPI Gatewayæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼šhttp://dockone.io/article/482ã€‚ API Gatewayæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯è¿›å…¥ç³»ç»Ÿçš„å”¯ä¸€èŠ‚ç‚¹ã€‚è¿™è·Ÿé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ä¸­çš„Facadeæ¨¡å¼å¾ˆåƒã€‚API Gatewayå°è£…å†…éƒ¨ç³»ç»Ÿçš„æ¶æ„ï¼Œå¹¶ä¸”æä¾›APIç»™å„ä¸ªå®¢æˆ·ç«¯ã€‚å®ƒè¿˜å¯èƒ½æœ‰å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æˆæƒã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡å’Œç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰ã€‚ API Gatewayè´Ÿè´£è¯·æ±‚è½¬å‘ã€åˆæˆå’Œåè®®è½¬æ¢ã€‚æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½è¦å…ˆç»è¿‡API Gatewayï¼Œç„¶åè·¯ç”±è¿™äº›è¯·æ±‚åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚API Gatewayå°†ç»å¸¸é€šè¿‡è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚ä»¥åŠèšåˆå¤šä¸ªæœåŠ¡çš„ç»“æœã€‚å®ƒå¯ä»¥åœ¨webåè®®ä¸å†…éƒ¨ä½¿ç”¨çš„éWebå‹å¥½å‹åè®®é—´è¿›è¡Œè½¬æ¢ï¼Œå¦‚HTTPåè®®ã€WebSocketåè®®ã€‚ API Gatewayå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„APIã€‚å®ƒæš´éœ²ä¸€ä¸ªç²—ç²’åº¦APIç»™ç§»åŠ¨å®¢æˆ·ç«¯ã€‚ä»¥äº§å“æœ€ç»ˆé¡µè¿™ä¸ªä½¿ç”¨åœºæ™¯ä¸ºä¾‹ã€‚API Gatewayæä¾›ä¸€ä¸ªæœåŠ¡æä¾›ç‚¹ï¼ˆ/productdetails?productid=xxxï¼‰ä½¿å¾—ç§»åŠ¨å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ£€ç´¢åˆ°äº§å“æœ€ç»ˆé¡µçš„å…¨éƒ¨æ•°æ®ã€‚API Gatewayé€šè¿‡è°ƒç”¨å¤šä¸ªæœåŠ¡æ¥å¤„ç†è¿™ä¸€ä¸ªè¯·æ±‚å¹¶è¿”å›ç»“æœï¼Œæ¶‰åŠäº§å“ä¿¡æ¯ã€æ¨èã€è¯„è®ºç­‰ã€‚ ä¸€ä¸ªå¾ˆå¥½çš„API Gatewayä¾‹å­æ˜¯Netfix API Gatewayã€‚NetflixæµæœåŠ¡æä¾›æ•°ç™¾ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼ŒåŒ…æ‹¬ç”µè§†ã€æœºé¡¶ç›’ã€æ™ºèƒ½æ‰‹æœºã€æ¸¸æˆç³»ç»Ÿã€å¹³æ¿ç”µè„‘ç­‰ã€‚èµ·åˆï¼ŒNetflixè§†å›¾æä¾›ä¸€ä¸ªé€‚ç”¨å…¨åœºæ™¯çš„APIã€‚ä½†æ˜¯ï¼Œä»–ä»¬å‘ç°è¿™ç§å½¢å¼ä¸å¥½ç”¨ï¼Œå› ä¸ºæ¶‰åŠåˆ°å„å¼å„æ ·çš„è®¾å¤‡ä»¥åŠå®ƒä»¬ç‹¬ç‰¹çš„éœ€æ±‚ã€‚ç°åœ¨ï¼Œä»–ä»¬é‡‡ç”¨ä¸€ä¸ªAPI Gatewayæ¥æä¾›å®¹é”™æ€§é«˜çš„APIï¼Œé’ˆå¯¹ä¸åŒç±»å‹è®¾å¤‡æœ‰ç›¸åº”ä»£ç ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªé€‚é…å™¨å¤„ç†ä¸€ä¸ªè¯·æ±‚å¹³å‡è¦è°ƒç”¨6åˆ°8ä¸ªåç«¯æœåŠ¡ã€‚Netflix API Gatewayæ¯å¤©å¤„ç†æ•°åäº¿çš„è¯·æ±‚ã€‚ API Gatewayçš„ä¼˜ç‚¹å’Œç¼ºç‚¹å¦‚ä½ æ‰€æ–™ï¼Œé‡‡ç”¨API Gatewayä¹Ÿæ˜¯ä¼˜ç¼ºç‚¹å¹¶å­˜çš„ã€‚API Gatewayçš„ä¸€ä¸ªæœ€å¤§å¥½å¤„æ˜¯å°è£…åº”ç”¨å†…éƒ¨ç»“æ„ã€‚ç›¸æ¯”èµ·æ¥è°ƒç”¨æŒ‡å®šçš„æœåŠ¡ï¼Œå®¢æˆ·ç«¯ç›´æ¥è·Ÿgatwayäº¤äº’æ›´ç®€å•ç‚¹ã€‚API Gatewayæä¾›ç»™æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªç‰¹å®šAPIï¼Œè¿™æ ·å‡å°‘äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡æ¬¡æ•°ï¼Œä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚ API Gatewayä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„ç»„ä»¶ï¼Œå¿…é¡»è¦å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒå¯èƒ½æˆä¸ºå¼€å‘çš„ä¸€ä¸ªç“¶é¢ˆã€‚å¼€å‘è€…å¿…é¡»æ›´æ–°API Gatewayæ¥æä¾›æ–°æœåŠ¡æä¾›ç‚¹æ¥æ”¯æŒæ–°æš´éœ²çš„å¾®æœåŠ¡ã€‚æ›´æ–°API Gatewayæ—¶å¿…é¡»è¶Šè½»é‡çº§è¶Šå¥½ã€‚å¦åˆ™ï¼Œå¼€å‘è€…å°†å› ä¸ºæ›´æ–°Gatewayè€Œæ’é˜Ÿåˆ—ã€‚ä½†æ˜¯ï¼Œé™¤äº†è¿™äº›ç¼ºç‚¹ï¼Œå¯¹äºå¤§éƒ¨åˆ†çš„åº”ç”¨ï¼Œé‡‡ç”¨API Gatewayçš„æ–¹å¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ ä½¿ç”¨API Gatewayåï¼Œå®¢æˆ·ç«¯å’Œå¾®æœåŠ¡ä¹‹é—´çš„ç½‘ç»œå›¾å˜æˆä¸‹å›¾ï¼š é€šè¿‡API Gatewayï¼Œå¯ä»¥ç»Ÿä¸€å‘å¤–éƒ¨ç³»ç»Ÿæä¾›REST APIã€‚Spring Cloudä¸­ä½¿ç”¨Zuulä½œä¸ºAPI Gatewayã€‚Zuulæä¾›äº†åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨ç­‰åŠŸèƒ½ã€‚ å›¾æ–‡æ¥æºï¼šhttps://github.com/eacdy/spring-cloud-bookã€Google","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"}]},{"title":"çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–","date":"2018-09-21T08:28:32.000Z","path":"2018/09/21/7876bd5d.html","text":"å¹¶å‘å¤„ç†çš„å¹¿æ³›åº”ç”¨æ˜¯ä½¿å¾—Amdahlå®šå¾‹ä»£æ›¿æ‘©å°”å®šå¾‹æˆä¸ºè®¡ç®—æœºæ€§èƒ½å‘å±•æºåŠ¨åŠ›çš„æ ¹æœ¬åŸå› ï¼Œä¹Ÿæ˜¯äººç±»å‹æ¦¨è®¡ç®—æœºè¿ç®—èƒ½åŠ›æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚ æ¦‚è¿°åœ¨è½¯ä»¶ä¸šå‘å±•çš„åˆæœŸï¼Œç¨‹åºç¼–å†™éƒ½æ˜¯ä»¥ç®—æ³•ä¸ºæ ¸å¿ƒçš„ï¼Œç¨‹åºå‘˜ä¼šæŠŠæ•°æ®å’Œè¿‡ç¨‹åˆ†åˆ«ä½œä¸ºç‹¬ç«‹çš„éƒ¨åˆ†æ¥è€ƒè™‘ï¼Œæ•°æ®ä»£è¡¨é—®é¢˜ç©ºé—´ä¸­çš„å®¢ä½“ï¼Œç¨‹åºä»£ç åˆ™ç”¨äºå¤„ç†è¿™äº›æ•°æ®ï¼Œè¿™ç§æ€ç»´æ–¹å¼æ˜¯ç›´æ¥ç«™åœ¨è®¡ç®—æœºçš„è§’åº¦å»æŠ½è±¡é—®é¢˜å’Œè§£å†³é—®é¢˜ï¼Œç§°ä¸ºé¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹æ€æƒ³ã€‚ä¸æ­¤ç›¸å¯¹ï¼Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³åˆ™ç«™åœ¨ç°å®ä¸–ç•Œçš„è§’åº¦å»æŠ½è±¡å’Œè§£å†³é—®é¢˜ï¼Œå®ƒæŠŠæ•°æ®å’Œè¡Œä¸ºéƒ½çœ‹ä½œæ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥è®©ç¨‹åºå‘˜èƒ½ä»¥ç¬¦åˆç°å®ä¸–ç•Œçš„æ€ç»´æ–¹å¼æ¥ç¼–å†™å’Œç»„ç»‡ç¨‹åºã€‚ äººä»¬å¾ˆéš¾æƒ³è±¡ç°å®ä¸­çš„å¯¹è±¡åœ¨ä¸€é¡¹å·¥ä½œè¿›è¡Œå™¨ä»¶ï¼Œä¼šè¢«ä¸åœåœ°ä¸­æ–­å’Œåˆ‡æ¢ï¼Œå¯¹è±¡åœ°å±æ€§å¯èƒ½ä¼šåœ¨ä¸­æ–­æœŸé—´è¢«ä¿®æ”¹å’Œå˜è„ï¼Œè€Œè¿™äº›äº‹ä»¶åœ¨è®¡ç®—æœºä¸–ç•Œä¸­æ˜¯å¾ˆæ­£å¸¸åœ°äº‹æƒ…ã€‚è‰¯å¥½åœ°è®¾è®¡åŸåˆ™ä¸å¾—ä¸å‘ç°å®åšå‡ºä¸€äº›è®©æ­¥ï¼Œæˆ‘ä»¬å¿…é¡»è®©ç¨‹åºåœ¨è®¡ç®—æœºä¸­æ­£ç¡®æ— è¯¯åœ°è¿è¡Œï¼Œç„¶åå†è€ƒè™‘å¦‚ä½•å°†ä»£ç ç»„ç»‡å¾—æ›´å¥½ï¼Œè®©ç¨‹åºè¿è¡Œå¾—æ›´å¿«ã€‚ çº¿ç¨‹å®‰å…¨ â€œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹å¾—è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„ååŒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£è¿™ä¸ªå¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚â€ â€”â€” ã€ŠJava Concurrency In Practiceã€‹çš„ä½œè€…Brian Goetzå¯¹â€œçº¿ç¨‹å®‰å…¨â€çš„å®šä¹‰ è¿™ä¸ªå®šä¹‰å¾ˆä¸¥è°¨ï¼Œå®ƒè¦æ±‚äº†çº¿ç¨‹å®‰å…¨çš„ä»£ç å¿…é¡»éƒ½å…·å¤‡ä¸€ä¸ªç‰¹å¾ï¼šä»£ç æœ¬èº«å°è£…äº†æ‰€æœ‰å¿…è¦çš„æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µï¼ˆå¦‚äº’æ–¥åŒæ­¥ç­‰ï¼‰ï¼Œä»¤è°ƒç”¨è€…æ— é¡»å…³ç³»å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œæ›´æ— é¡»è‡ªå·±å®ç°ä»»ä½•æªæ–½æ¥ä¿è¯å¤šçº¿ç¨‹çš„æ­£ç¡®è°ƒç”¨ã€‚è¿™ç‚¹å¹¶ä¸å®¹æ˜“åšåˆ°ã€‚ Javaè¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨æˆ‘ä»¬è®¨è®ºçº¿ç¨‹å®‰å…¨ï¼Œå°±é™å®šäºå¤šä¸ªçº¿ç¨‹ä¹‹é—´å­˜åœ¨å…±äº«æ•°æ®è®¿é—®è¿™ä¸ªå‰æï¼Œå› ä¸ºå¦‚æœä¸€æ®µä»£ç æ ¹æœ¬ä¸ä¼šä¸å…¶ä»–çº¿ç¨‹å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆä»çº¿ç¨‹å®‰å…¨çš„è§’åº¦ä¸Šçœ‹ï¼Œç¨‹åºæ—¶ä¸²è¡Œæ‰§è¡Œè¿˜æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œå¯¹å®ƒæ¥è¯´æ˜¯å®Œå…¨æ²¡æœ‰åŒºåˆ«çš„ã€‚ æŒ‰ç…§çº¿ç¨‹å®‰å…¨çš„â€œå®‰å…¨ç¨‹åº¦â€ç”±å¼ºè‡³å¼±æ¥æ’åºï¼Œå¯ä»¥å°†Javaè¯­è¨€ä¸­å„ç§æ“ä½œå…±äº«çš„æ•°æ®åˆ†ä¸ºäº”ç±»ï¼šä¸å¯å˜ã€ç»å¯¹çº¿ç¨‹å®‰å…¨ã€ç›¸å¯¹çº¿ç¨‹å®‰å…¨ã€å¿åŸå…¼å®¹å’Œçº¿ç¨‹å¯¹ç«‹ã€‚ ä¸å¯å˜åœ¨Javaè¯­è¨€é‡Œé¢ï¼Œä¸å¯å˜çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— è®ºæ˜¯å¯¹è±¡çš„æ–¹æ³•å®ç°è¿˜æ˜¯æ–¹æ³•çš„è°ƒç”¨è€…ï¼Œéƒ½ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ï¼Œåªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®çš„æ„å»ºå‡ºæ¥ï¼ˆæ²¡æœ‰å‘ç”Ÿthisé€ƒé€¸çš„æƒ…å†µï¼‰ï¼Œé‚£å…¶å¤–éƒ¨çš„å¯è§çŠ¶æ€æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒå†å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„ç‹‚æ€ã€‚â€œä¸å¯å˜â€å¸¦æ¥çš„å®‰å…¨æ€§æ˜¯æœ€ç®€å•æœ€çº¯ç²¹çš„ã€‚ å¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªä¸€æœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆåªè¦å†å®šä¹‰æ—¶ä½¿ç”¨finalå…³é”®å­—ä¿®é¥°å®ƒå°±å¯ä»¥ä¿è¯å®ƒæ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±éœ€è¦ä¿è¯å¯¹è±¡çš„è¡Œä¸ºä¸ä¼šå¯¹å…¶çŠ¶æ€äº§ç”Ÿä»»ä½•å½±å“æ‰è¡Œã€‚java.lang.Stringç±»çš„å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„ä¸å¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬è°ƒç”¨å®ƒçš„substring()ã€replace()å’Œconcat()è¿™äº›æ–¹æ³•éƒ½ä¸ä¼šå½±å“å®ƒåŸæ¥çš„å€¼ï¼Œåªä¼šè¿”å›ä¸€ä¸ªæ–°æ„é€ çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚ ä¿è¯å¯¹è±¡è¡Œä¸ºä¸å½±å“è‡ªå·±çŠ¶æ€çš„é€”å¾„ç”±å¾ˆå¤šç§ï¼Œå…¶ä¸­æœ€ç®€å•çš„å°±æ˜¯æŠŠå¯¹è±¡ä¸­å¸¦æœ‰çŠ¶æ€çš„å˜é‡éƒ½å£°æ˜ä¸ºfinalï¼Œè¿™æ ·åœ¨æ„é€ å‡½æ•°ç»“æŸä¹‹åï¼Œ å®ƒå°±æ˜¯ä¸å¯å˜çš„ã€‚ java.lang.Integeræ„é€ å‡½æ•°ï¼Œå®ƒé€šè¿‡å°†å†…éƒ¨çŠ¶æ€å˜é‡valueå®šä¹‰ä¸ºfinalæ¥ä¿éšœçŠ¶æ€ä¸å˜ï¼š /** * The value of the &#123;@code Integer&#125;. * * @serial */ private final int value; /** * Constructs a newly allocated &#123;@code Integer&#125; object that * represents the specified &#123;@code int&#125; value. * * @param value the value to be represented by the * &#123;@code Integer&#125; object. */ public Integer(int value) &#123; this.value = value; &#125; åœ¨Java APIä¸­ç¬¦åˆä¸å¯å˜è¦æ±‚çš„ç±»å‹ï¼Œé™¤äº†Stringä¹‹å¤–ï¼Œå¸¸ç”¨çš„è¿˜æœ‰æšä¸¾ç±»å‹ï¼Œä»¥åŠjava.lang.Numberçš„éƒ¨åˆ†å­ç±»ã€‚ ç»å¯¹çº¿ç¨‹å®‰å…¨ç»å¯¹çº¿ç¨‹å®‰å…¨å®Œå…¨æ»¡è¶³Brian Goetzç»™å‡ºçš„çº¿ç¨‹å®‰å…¨çš„å®šä¹‰ï¼Œè¿™ä¸ªå®šä¹‰å…¶å®æ˜¯å¾ˆä¸¥æ ¼çš„ï¼Œä¸€ä¸ªç±»è¦è¾¾åˆ°â€œä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒå¦‚ä½•ï¼Œè°ƒç”¨è€…éƒ½ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æªæ–½â€é€šå¸¸éœ€è¦ä»˜å‡ºå¾ˆå¤§çš„ï¼Œç”šè‡³æ˜¯ä¸åˆ‡å®é™…çš„ä»£ä»·ã€‚åœ¨Java APIä¸­æ ‡æ³¨è‡ªå·±æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œå¤§å¤šæ•°éƒ½ä¸æ˜¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ã€‚ java.util.Vectoræ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œå› ä¸ºå®ƒçš„add()ã€get()å’Œsize()è¿™ç±»æ–¹æ³•éƒ½æ˜¯è¢«synchronizedä¿®é¥°çš„ï¼Œå°½ç®¡è¿™æ ·æ•ˆç‡å¾ˆä½ï¼Œä½†ç¡®å®æ˜¯å®‰å…¨çš„ã€‚ä½†æ˜¯ï¼Œå³ä½¿å®ƒæ‰€æœ‰çš„æ–¹æ³•éƒ½è¢«ä¿®é¥°æˆåŒæ­¥ï¼Œä¹Ÿä¸æ„å‘³ç€è°ƒç”¨å®ƒçš„æ—¶å€™æ°¸è¿œéƒ½ä¸å†éœ€è¦åŒæ­¥æ‰‹æ®µäº†ã€‚ ä»£ç æ¸…å•ï¼Œå¯¹Vectorçº¿ç¨‹å®‰å…¨çš„æµ‹è¯•ï¼š package com.cayzlh.jvmdemo;import java.util.Vector;/** * @author Antä¸¶ */public class VectorSaveTest &#123; private static Vector&lt;Integer&gt; vector = new Vector&lt;&gt;(); public static void main(String[] args) &#123; while (true) &#123; for (int i = 0; i &lt; 10; i++) &#123; vector.add(i); &#125; Thread removeThread = new Thread(new Runnable() &#123; @Override public void run() &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.remove(i); &#125; &#125; &#125;); Thread printThread = new Thread(new Runnable() &#123; @Override public void run() &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; System.out.println(vector.get(i)); &#125; &#125; &#125;); removeThread.start(); printThread.start(); // ä¸è¦åŒæ—¶äº§ç”Ÿè¿‡å¤šçš„çº¿ç¨‹ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå‡æ­» while (Thread.activeCount() &gt; 20) &#123; &#125; &#125; &#125;&#125; è¿è¡Œç»“æœï¼š å°½ç®¡è¿™é‡Œä½¿ç”¨åˆ°çš„Vectorçš„get()ã€remove()å’Œsize()æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœä¸åœ¨æ–¹æ³•è°ƒç”¨ç«¯åšé¢å¤–çš„ä¸åŒæªæ–½ï¼Œä½¿ç”¨è¿™æ®µä»£ç ä»ç„¶æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹åˆ‡å¥½åœ¨é”™è¯¯çš„æ—¶é—´é‡Œåˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œå¯¼è‡´åºå·iå·²ç»ä¸å†å¯ç”¨çš„è¯ï¼Œget()æ–¹æ³•å°±ä¼šæŠ›å‡ºä¸€ä¸ªArrayIndexOutOfBoundsExceptionã€‚ è¦ä¿è¯è¿™æ®µä»£ç èƒ½æ­£ç¡®åœ°æ‰§è¡Œä¸‹å»ï¼Œè¦å¯¹removeThreadå’ŒprintThreadåšä¸€äº›ä¿®æ”¹ï¼š Thread removeThread = new Thread(new Runnable() &#123; @Override public void run() &#123; synchronized (vector) &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.remove(i); &#125; &#125; &#125;&#125;);Thread printThread = new Thread(new Runnable() &#123; @Override public void run() &#123; synchronized (vector) &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; System.out.println(vector.get(i)); &#125; &#125; &#125;&#125;); ç›¸å¯¹çº¿ç¨‹å®‰å…¨ç›¸å¯¹çº¿ç¨‹å®‰å…¨å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šæ‰€è®²çš„çº¿ç¨‹å®‰å…¨ï¼Œ å®ƒéœ€è¦ä¿è¯å¯¹è¿™ä¸ªå¯¹è±¡å•ç‹¬çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨é¢å¤–çš„åŒæ­¥æ‰‹æ®µæ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚ åœ¨Javaè¯­è¨€ä¸­ï¼Œå¤§éƒ¨åˆ†çš„çº¿ç¨‹å®‰å…¨ç±»éƒ½å±äºè¿™ç§ç±»å‹ï¼Œä¾‹å¦‚Vectorã€HashTableã€Collectionsçš„synchronizedCollection()æ–¹æ³•åŒ…è£…çš„é›†åˆç­‰ã€‚ çº¿ç¨‹å…¼å®¹çº¿ç¨‹å…¼å®¹æ˜¯æŒ‡å¯¹è±¡æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®åœ°ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡åœ¨å¹¶å‘ç¯å¢ƒä¸­å®‰å…¨åœ°ä½¿ç”¨ï¼Œæˆ‘ä»¬å¹³å¸¸è¯´ä¸€ä¸ªç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç»å¤§å¤šæ•°æŒ‡çš„éƒ½æ˜¯è¿™ç§æƒ…å†µã€‚Java APIä¸­å¤§éƒ¨åˆ†çš„ç±»éƒ½æ˜¯çº¿ç¨‹å…¼å®¹çš„ï¼Œå¦‚Vectorå’ŒHashtableç›¸å¯¹åº”çš„é›†åˆç±»ArrayListå’ŒHashMapç­‰ã€‚ çº¿ç¨‹å¯¹ç«‹çº¿ç¨‹å¯¹ç«‹æ˜¯æŒ‡ä¸ç®¡è°ƒç”¨ç«¯æ˜¯å¦é‡‡å–äº†åŒæ­¥æªæ–½ï¼Œéƒ½æ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘ä½¿ç”¨çš„ä»£ç ã€‚ç”±äºJavaè¯­è¨€å¤©ç”Ÿå°±å…·å¤‡å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œçº¿ç¨‹å¯¹ç«‹è¿™ç§æ’æ–¥å¤šçº¿ç¨‹çš„ä»£ç å¾ˆå°‘å‡ºç°ï¼Œè€Œä¸”é€šå¸¸æ˜¯æœ‰å®³çš„ï¼Œåº”å°½é‡é¿å…ã€‚ ä¸€ä¸ªçº¿ç¨‹å¯¹ç«‹çš„ä¾‹å­æ˜¯Threadç±»çš„suspend()å’Œresume()æ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä¸€ä¸ªå°è¯•å»ä¸­æ–­çº¿ç¨‹ï¼Œä¸€ä¸ªå°è¯•å»æ¢å¤çº¿ç¨‹ï¼Œå¦‚æœå¹¶å‘è¿›è¡Œçš„è¯ï¼Œ æ— è®ºè°ƒç”¨æ—¶æ˜¯å¦è¿›è¡Œäº†åŒæ­¥ï¼Œç›®æ ‡çº¿ç¨‹éƒ½æ˜¯å­˜åœ¨æ­»é”é£é™©çš„ï¼Œå¦‚æœsuspend()ä¸­æ–­çš„çº¿ç¨‹å°±æ˜¯å³å°†è¦æ‰§è¡Œresume()çš„é‚£ä¸ªçº¿ç¨‹ï¼Œé‚£å°±è‚¯å®šäº§ç”Ÿæ­»é”äº†ã€‚ çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•å¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨ä¸ä»£ç çš„ç¼–å†™æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œä½†è™šæ‹Ÿæœºæä¾›çš„åŒæ­¥å’Œé”æœºåˆ¶ä¹Ÿèµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚ äº’æ–¥åŒæ­¥äº’æ–¥åŒæ­¥æ˜¯æœ€å¸¸è§çš„ä¸€ç§å¹¶å‘æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µï¼ŒåŒæ­¥æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€æ¡çº¿ç¨‹ä½¿ç”¨ã€‚è€Œäº’æ–¥æ˜¯å®ç°åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼Œä¸´ç•ŒåŒºã€äº’æ–¥é‡å’Œä¿¡å·é‡éƒ½æ˜¯ä¸»è¦çš„äº’æ–¥å®ç°æ–¹å¼ã€‚äº’æ–¥æ˜¯å› ï¼ŒåŒæ­¥æ˜¯æœï¼Œäº’æ–¥æ˜¯æ–¹æ³•ï¼ŒåŒæ­¥æ˜¯ç›®çš„ã€‚ åœ¨Javaé‡Œé¢ï¼Œæœ€åŸºæœ¬çš„äº’æ–¥åŒæ­¥æ‰‹æ®µå°±æ˜¯synchronizedå…³é”®å­—ï¼Œsynchronizedå…³é”®å­—ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œä¼šåœ¨åŒæ­¥å—çš„å‰ååˆ†åˆ«å½¢æˆmonitorenterå’Œmonitorexitè¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç éƒ½éœ€è¦ä¸€ä¸ªreferenceç±»å‹çš„å‚æ•°æ¥æŒ‡æ˜è¦é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚å¦‚æœJavaç¨‹åºä¸­çš„synchronizedæ˜ç¡®æŒ‡å®šäº†å¯¹è±¡å‚æ•°ï¼Œé‚£å°±æ˜¯å¯¹è¿™ä¸ªå‚æ•°çš„referenceï¼›å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œé‚£å°±æ ¹æ®synchronizedä¿®é¥°çš„å®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œå»å–å¯¹åº”çš„å¯¹è±¡å®ä¾‹æˆ–Classå¯¹è±¡æ¥ä½œä¸ºé”å¯¹è±¡ã€‚ åœ¨æ‰§è¡ŒmonitorenteræŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆè¦å°è¯•è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œæˆ–è€…å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†é‚£ä¸ªå¯¹è±¡çš„é”ï¼ŒæŠŠé”çš„è®¡æ•°å™¨åŠ 1ï¼Œç›¸åº”åœ°ï¼Œåœ¨æ‰§è¡ŒmonitorexitæŒ‡ä»¤æ—¶ä¼šè®²é”è®¡æ•°å™¨å‡1ï¼Œå½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œé”å°±é‡Šæ”¾äº†ã€‚å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥äº†ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚ é¦–å…ˆsynchronizedåŒæ­¥å—å¯¹åŒä¸€æ¡çº¿ç¨‹æ¥è¯´æ˜¯å¯é‡å…¥çš„ï¼Œä¸ä¼šå‡ºç°è‡ªå·±æŠŠè‡ªå·±é”æ­»çš„é—®é¢˜ã€‚å…¶æ¬¡ï¼ŒåŒæ­¥å—åœ¨å·²è¿›å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¼šé˜»å¡åé¢å…¶ä»–çº¿ç¨‹çš„è¿›å…¥ã€‚Javaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸå£°çº¿ç¨‹ä¸Šçš„ï¼Œå¦‚æœè¦é˜»å¡æˆ–å”¤é†’ä¸€æ¡çº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿæ¥å¸®å¿™å®Œæˆï¼Œè¿™å°±éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ä¸­ï¼Œå› æ­¤çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´ã€‚å¯¹äºä»£ç ç®€å•çš„åŒæ­¥å—ï¼ŒçŠ¶æ€è½¬æ¢æ¶ˆè€—çš„æ—¶é—´å¯èƒ½æ¯”ç”¨æˆ·ä»£ç æ‰§è¡Œçš„æ—¶é—´è¿˜è¦å¸¸ã€‚æ‰€ä»¥synchronizedæ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ä¸ªé‡é‡çº§çš„æ“ä½œï¼Œåœ¨å¿…è¦çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨è¿™ç§æ“ä½œã€‚è™šæ‹Ÿæœºæœ¬èº«ä¹Ÿä¼šè¿›è¡Œä¸€äº›ä¼˜åŒ–ï¼Œè­¬å¦‚åœ¨é€šçŸ¥æ“ä½œç³»ç»Ÿé˜»å¡çº¿ç¨‹ä¹‹å‰åŠ å…¥ä¸€æ®µè‡ªæ—‹ç­‰å¾…è¿‡ç¨‹ï¼Œé¿å…é¢‘ç¹åœ°åˆ‡å…¥åˆ°æ ¸å¿ƒæ€ä¹‹ä¸­ã€‚ éé˜»å¡åŒæ­¥äº’æ–¥åŒæ­¥æœ€è¦çš„é—®é¢˜æ˜¯è¿›è¡Œçº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿè¢«ç§°ä¸ºé˜»å¡åŒæ­¥ã€‚å¦å¤–ï¼Œå®ƒå±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºé—®é¢˜ï¼Œæ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦è¢«å”¤é†’ç­‰æ“ä½œã€‚ éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæœ‰äº†å¦å¤–ä¸€ä¸ªé€‰æ‹©ï¼šåŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥ï¼Œé€šä¿—åœ°è¯´å°±æ˜¯å…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼›å¦‚æœå…±äº«æ•°æ®æœ‰äº‰ç”¨ï¼Œäº§ç”Ÿäº†å†²çªï¼Œé‚£å°±å†è¿›è¡Œå…¶ä»–çš„è¡¥å¿æªæ–½ï¼ˆä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰ï¼Œè¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šé¦–å…ˆéƒ½ä¸éœ€è¦æŠŠçº¿ç¨‹æŒ‚èµ·ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œè¢«ç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚ æ— åŒæ­¥æ–¹æ¡ˆè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸æ˜¯ä»¥é¡¶è¦è¿›è¡ŒåŒæ­¥ï¼Œä¸¤è€…æ²¡æœ‰å› æœå…³ç³»ã€‚åŒæ­¥åªæ˜¯ä¿éšœå…±äº«æ•°æ®ç«äº‰ç”¨æ—¶çš„æ­£ç¡®æ€§çš„æ‰‹æ®µï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£å®ƒè‡ªç„¶å°±æ— éœ€ä»»ä½•åŒæ­¥æªæ–½å»ä¿è¯æ­£ç¡®æ€§ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›ä»£ç å¤©ç”Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š å¯é‡å…¥ä»£ç è¿™ç§ä»£ç ä¹Ÿå«çº¯ä»£ç ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºå‡ºç°ä»»ä½•é”™è¯¯ã€‚ç›¸å¯¹çº¿ç¨‹å®‰å…¨æ¥è¯´ï¼Œ å¯é‡å…¥æ€§æ˜¯æ›´åŸºæœ¬çš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå³æ‰€æœ‰çš„å¯é‡å…¥çš„ä»£ç éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¹¶éæ‰€æœ‰çš„çº¿ç¨‹å®‰å…¨çš„ä»£ç éƒ½æ˜¯å¯é‡å…¥çš„ã€‚ å¯é‡å…¥ä»£ç æœ‰ä¸€äº›å…±åŒçš„ç‰¹å¾ï¼šä¾‹å¦‚ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½ç”±å‚æ•°ä¸­ä¼ å…¥ã€ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚åˆ¤æ–­ä»£ç æ˜¯å¦å…·å¤‡å¯é‡å…¥ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›çš„ç»“æœæ˜¯å¯ä»¥é¢„æµ‹çš„ï¼Œåªè¦è¾“å…¥äº†ç›¸åŒçš„æ•°æ®ï¼Œå°±èƒ½è¿”å›ç›¸åŒçš„ç»“æœï¼Œé‚£å®ƒæ»¡è¶³å¯é‡å…¥æ€§çš„è¦æ±‚ï¼Œå½“ç„¶ä¹Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸€æ®µä»£ç ä¸­æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹èƒ½å¦å¦æ­£è¿™äº›å…±äº«æ•°æ®åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œè¿™æ ·ï¼Œæ— é¡»åŒæ­¥ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚æœ€å¸¸è§çš„åº”ç”¨å°±æ˜¯æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶æ„æ¨¡å¼ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼‰ï¼Œéƒ½ä¼šè®²äº§å“çš„æ¶ˆè´¹è¿‡ç¨‹å°½é‡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¶ˆè´¹å®Œï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹å°±æ˜¯Webäº¤äº’æ¨¡å‹ä¸­çš„â€œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹çš„å¤„ç†æ–¹å¼ï¼Œè¿™ç§å¤„ç†æ–¹å¼çš„å¹¿æ³›åº”ç”¨ä½¿å¾—WebæœåŠ¡ç«¯çš„å¾ˆå¤šåº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚â€ Javaè¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡è¦è¢«å¤šçº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨volatileå…³é”®å­—å£°æ˜å®ƒä¸ºâ€œæ˜“å˜çš„â€ï¼›å¦‚æœä¸€ä¸ªå˜é‡è¦è¢«æŸä¸ªçº¿ç¨‹ç‹¬äº«ï¼Œå¯ä»¥é€šè¿‡java.lang.ThreadLocalç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹çš„Threadå¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªThreadLocalMapå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å­˜å‚¨äº†ä¸€ç»„ä»¥ThreadLocal.threadLocalHashCodeä¸ºé”®ï¼Œä»¥æœ¬åœ°çº¿ç¨‹å˜é‡ä¸ºå€¼çš„K-Vå€¼å¯¹ï¼ŒThreadLocalå¯¹è±¡å°±æ˜¯å½“å‰çº¿ç¨‹çš„ThreadLocalMapçš„è®¿é—®å…¥å£ï¼Œæ¯ä¸ªThreadLocalå¯¹è±¡éƒ½åŒ…å«äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„threadLocalHashCodeå€¼ï¼Œä½¿ç”¨è¿™ä¸ªå€¼å°±å¯ä»¥åœ¨çº¿ç¨‹K-Vå€¼å¯¹ä¸­æ‰¾å›å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹å˜é‡ã€‚ é”ä¼˜åŒ–è™šæ‹Ÿæœºå¼€å‘å›¢é˜Ÿå®ç°å„ç§é”ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚é€‚åº”æ€§è‡ªæ—‹ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€è½»é‡çº§é”ã€åå‘é”ç­‰ï¼Œè¿™äº›æŠ€æœ¯éƒ½æ˜¯ä¸ºäº†çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œä»¥åŠè§£å†³ç«äº‰é—®é¢˜ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹äº’æ–¥åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡çš„å®ç°ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å†…æ ¸æ€ä¸­å®Œæˆï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚åŒæ—¶ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœç‰©ç†æœºå™¨æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å¤„ç†å™¨ï¼Œèƒ½è®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå°±å¯ä»¥è®©åé¢è¯·æ±‚é”çš„é‚£ä¸ªçº¿ç¨‹â€œç¨ç­‰ä¸€ä¼šå„¿â€ï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹å•Šå¯èƒ½æŒæœ‰é”æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œåªé¡»è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“è‡ªæ—‹é”ã€‚ è‡ªæ—‹ç­‰å¾…ä¸èƒ½ä»£æ›¿é˜»å¡ï¼Œå…ˆä¸è¯´å¯¹å¤„ç†å™¨æ•°é‡çš„è¦æ±‚ï¼Œè‡ªæ—‹ç­‰å¾…æœ¬èº«è™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å®ƒæ˜¯è¦å ç”¨å¤„ç†å™¨æ—¶é—´çš„ï¼Œæ‰€ä»¥å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œåä¹‹å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šæ‹œæ‹œæ¶ˆè€—å¤„ç†å™¨èµ„æºï¼Œè€Œä¸ä¼šåšä»»ä½•æ¸¸æ³³çš„å·¥ä½œï¼Œåè€Œä¼šå¸¦æ¥æ€§èƒ½çš„æµªè´¹ã€‚å› æ­¤è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”å½“ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ã€‚ è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œæ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ã€‚å¦å¤–ä¸€æ–¹é¢ï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä¸€é¢æµªè´¹å¤„ç†å™¨èµ„æºã€‚ æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œå’Œæ€§èƒ½ç›‘æ§ä¿¡æ¯çš„ä¸æ–­å®Œå–„ï¼Œè™šæ‹Ÿæœºå¯¹ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼Œè™šæ‹Ÿæœºå°±ä¼šå˜å¾—è¶Šæ¥è¶Šâ€œèªæ˜â€ã€‚ é”æ¶ˆé™¤é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤æ–­ä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åˆ°ä¸€æ®µä»£ç ä¸­ï¼Œåœ¨å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬åšæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶å°±æ— é¡»è¿›è¡Œã€‚ é”ç²—åŒ–åŸåˆ™ä¸Šï¼Œåœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæ¨èå°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°â€”â€”åªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°ï¼Œå¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé‚£ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿèƒ½å°½å¿«æ‹¿åˆ°é”ã€‚ å¦‚æœä¸€ç³»åˆ—è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹çš„ç«äº‰ï¼Œé¢‘ç¹åœ°è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚ å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰è¿™æ ·çš„ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ªæ“ä½œä¹‹åï¼Œè¿™æ ·åªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚ è½»é‡çº§é” è½»é‡çº§æ˜¯ç›¸å¯¹äºæ“ä½œç³»ç»Ÿäº’æ–¥é‡æ¥å®ç°çš„ä¼ ç»Ÿé”è€Œè¨€çš„ï¼Œå› æ­¤ä¼ ç»Ÿçš„é”æœºåˆ¶å°±è¢«ç§°ä¸ºé‡é‡çº§é”ã€‚ è½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ï¼Œå®ƒæœ¬æ„æ˜¯åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ã€‚ åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœæ­¤åŒæ­¥å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ã€‚ç„¶åï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆã€‚å¦‚æœè¿™ä¸ªæ›´æ–°åŠ¨ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½å°†è½¬å˜ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å‡ºäºè½»é‡çº§é”çš„çŠ¶æ€ã€‚ å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯å°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜è¿™ä¸ªé”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ã€‚å¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œè¦è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚ è½»é‡çº§é”èƒ½æ›¿èº«ç¨‹åºåŒæ­¥æ€§èƒ½çš„ä¾æ®æ˜¯â€œå¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„â€ï¼Œè¿™æ˜¯ä¸€ä¸ªç»éªŒæ•°æ®ã€‚å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œè½»é‡çº§é”ä½¿ç”¨CASé¿å…äº†ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€ï¼Œä½†å¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œå‡ºäº†äº’æ–¥é‡çš„å¼€é”€å¤–ï¼Œè¿˜é¢å¤–å‘ç”Ÿäº†CASæ“ä½œï¼Œå› æ­¤åœ¨æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é”å›é¿ä¼ ç»Ÿçš„é‡é‡çº§é”æ›´æ…¢ã€‚ åå‘é”åå‘é”çš„ç›®çš„æ˜¯æ¶ˆé™¤æ•°æ®åœ¨æ— ç«äº‰æƒ…å†µä¸‹çš„åŒæ­¥åŸè¯­ï¼Œè¿›ä¸€æ­¥æé«˜ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚å¦‚æœè¯´è½»é‡çº§é”æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹ä½¿ç”¨CASæ“ä½œå»æ¶ˆé™¤åŒæ­¥ä½¿ç”¨çš„äº’æ–¥é‡ï¼Œé‚£åå‘é”å°±æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹æŠŠæ•´ä¸ªåŒæ­¥éƒ½æ¶ˆé™¤ï¼Œè¿CASæ“ä½œéƒ½ä¸åšäº†ã€‚ åå‘é”çš„â€œåâ€ï¼Œæ„æ€æ˜¯è¿™ä¸ªé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹ï¼Œå¦‚æœåœ¨æ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯¥é”æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹çš„è·å–ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹å°†æ°¸è¿œä¸éœ€è¦å†è¿›è¡ŒåŒæ­¥ã€‚ å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”æ—¶ï¼Œåå‘æ¨¡å¼å°±å®£å‘Šç»“æŸã€‚æ ¹æ®é”å¯¹è±¡ç›®å‰æ˜¯å¦è¢«é”å®šçš„çŠ¶æ€ï¼Œæ’¤é”€åå‘åæ¢å¤åˆ°æœªé”å®šæˆ–è½»é‡çº§é”å®šçš„çŠ¶æ€ï¼Œåç»­çš„åŒæ­¥æ“ä½œå°±å¦‚è½»é‡çº§é”é‚£æ ·æ‰§è¡Œã€‚ åå‘é”å¯ä»¥æé«˜å¸¦æœ‰ä¸åŒä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚å®ƒåŒæ ·æ˜¯ä¸€ä¸ªå¸¦æœ‰åˆ©ç›Šæƒè¡¡æ€§è´¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¸€å®šæ€»æ˜¯å¯¹ç¨‹åºè¿è¡Œæœ‰åˆ©ï¼Œå¦‚æœç¨‹åºä¸­å¤§å¤šæ•°é”éƒ½æ€»æ˜¯è¢«å¤šä¸ªä¸åŒçš„çº¿ç¨‹è®¿é—®ï¼Œé‚£åå‘æ¨¡å¼å°±æ˜¯å¤šä½™çš„ã€‚ å°ç»“ä»‹ç»äº†çº¿ç¨‹å®‰å…¨æ¶‰åŠçš„æ¦‚å¿µå’Œåˆ†ç±»ã€åŒæ­¥å®ç°çš„æ–¹å¼åŠè™šæ‹Ÿæœºçš„åº•å±‚è¿ä½œåŸç†ï¼Œå¹¶ä¸”ä»‹ç»äº†è™šæ‹Ÿæœºå®ç°é«˜æ•ˆå¹¶å‘æ‰€ä½œçš„ä¸€ç³»åˆ—é”ä¼˜åŒ–æªæ–½ã€‚ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹","date":"2018-09-18T08:28:32.000Z","path":"2018/09/18/badf9669.html","text":"å¹¶å‘å¤„ç†çš„å¹¿æ³›åº”ç”¨æ˜¯ä½¿å¾—Amdahlå®šå¾‹ä»£æ›¿æ‘©å°”å®šå¾‹æˆä¸ºè®¡ç®—æœºæ€§èƒ½å‘å±•æºåŠ¨åŠ›çš„æ ¹æœ¬åŸå› ï¼Œä¹Ÿæ˜¯äººç±»å‹æ¦¨è®¡ç®—æœºè¿ç®—èƒ½åŠ›æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚ æ¦‚è¿°é™¤äº†å……åˆ†åˆ©ç”¨è®¡ç®—æœºå¤„ç†å™¨çš„èƒ½åŠ›å¤–ï¼Œä¸€ä¸ªæœåŠ¡ç«¯åŒæ—¶å¯¹å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡æ˜¯ä¸€ä¸ªå…·ä½“çš„å¹¶å‘åº”ç”¨çš„åœºæ™¯ã€‚è¡¡é‡ä¸€ä¸ªæœåŠ¡å™¨æ€§èƒ½çš„é«˜ä½å¥½åï¼Œæ¯ç§’äº‹åŠ¡å¤„ç†æ•°ï¼ˆTransactions Per Secondï¼ŒTPSï¼‰æ˜¯æœ€é‡è¦çš„æŒ‡æ ‡ä¹‹ä¸€ï¼Œå®ƒä»£è¡¨ç€ä¸€ç§’å†…æœåŠ¡ç«¯å¹³å‡èƒ½å“åº”çš„è¯·æ±‚æ€»æ•°ï¼ŒäºŒTPSå€¼ä¸ç¨‹åºçš„å¹¶å‘èƒ½åŠ›åˆæœ‰éå¸¸å¯†åˆ‡çš„å…³ç³»ã€‚å¯¹äºè®¡ç®—é‡ç›¸åŒçš„ä»»åŠ¡ï¼Œç¨‹åºçº¿ç¨‹å¹¶å‘åè°ƒå¾—è¶Šæœ‰æ¡ä¸ç´Šï¼Œæ•ˆç‡è‡ªç„¶å°±ä¼šè¶Šé«˜ï¼›åä¹‹ï¼Œçº¿ç¨‹ä¹‹é—´é¢‘ç¹é˜»å¡ç”šè‡³æ­»é”ï¼Œå°†ä¼šå¤§å¤§é™ä½ç¨‹åºçš„å¹¶å‘èƒ½åŠ›ã€‚ æœåŠ¡ç«¯æ˜¯Javaè¯­è¨€æœ€æ“…é•¿çš„é¢†åŸŸä¹‹ä¸€ï¼Œè¿™ä¸ªé¢†å–çš„åº”ç”¨å äº†Javaåº”ç”¨ä¸­æœ€å¤§çš„ä¸€å—ä»½é¢ï¼Œä¸è¿‡å¦‚ä½•å†™å¥½å¹¶å‘åº”ç”¨ç¨‹åºç¡®å®ç¨‹åºå¼€å‘çš„éš¾ç‚¹ä¹‹ä¸€ï¼Œå¤„ç†å¥½å¹¶å‘æ–¹é¢çš„é—®é¢˜é€šå¸¸éœ€è¦æ›´å¤šçš„ç»éªŒã€‚æ— è®ºè¯­è¨€ã€ä¸­é—´ä»¶å’Œæ¡†æ¶å¦‚ä½•å…ˆè¿›ï¼Œæˆ‘ä»¬éƒ½ä¸èƒ½æœŸæœ›å®ƒä»¬èƒ½ç‹¬ç«‹å®Œæˆå¹¶å‘å¤„ç†çš„æ‰€æœ‰äº‹æƒ…ï¼Œäº†è§£å¹¶å‘çš„å†…å¹•ä¹Ÿæ˜¯ä¸å¯ç¼ºå°‘çš„è¯¾ç¨‹ã€‚ ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§ç”±äºè®¡ç®—æœºçš„å­˜å‚¨è®¾å¤‡ä¸å¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦ä¹‹é—´æœ‰ç€å‡ ä¸ªæ•°é‡çº§çš„å·®è·ï¼Œæ‰€ä»¥ç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½ä¸å¾—ä¸åŠ å…¥ä¸€å±‚è¯»å†™å°½å¯èƒ½æ¥è¿‘å¤„ç†å™¨è¿ç®—é€Ÿåº¦çš„é«˜é€Ÿç¼“å­˜ï¼ˆCacheï¼‰æ¥ä½œä¸ºå†…å­˜ä¸å¤„ç†å™¨ä¹‹é—´çš„ç¼“å†²ï¼šå°†è¿ç®—éœ€è¦ä½¿ç”¨çš„æ•°æ®èµ‹å€¼åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚ åŸºäºé«˜é€Ÿç¼“å­˜çš„å­˜å‚¨äº¤äº’å¾ˆå¥½åœ°è§£å†³äº†å¤„ç†å™¨ä¸å†…å­˜åœ°é€Ÿåº¦çŸ›ç›¾ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§ï¼ˆCache Coherenceï¼‰ã€‚æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±åœ°é«˜é€Ÿç¼“å­˜ï¼Œè€Œå®ƒä»¬åˆå…±äº«åŒä¸€ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ã€‚å½“å¤šä¸ªå¤„ç†å™¨åœ°è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåŒä¸€å—ä¸»å†…å­˜åŒºåŸŸæ—¶ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªåœ°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´åœ°æƒ…å†µã€‚ä¸ºäº†è§£å†³ä¸€è‡´æ€§åœ°é—®é¢˜ï¼Œéœ€è¦å„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®æ¥è¿›è¡Œæ“ä½œã€‚Javaè™šæ‹Ÿæœºå†…å­˜æ¨¡å‹ä¸­å®šä¹‰åœ°å†…å­˜è®¿é—®æ“ä½œä¸ç¡¬ä»¶åœ°ç¼“å­˜è®¿é—®æ“ä½œæ—¶å…·æœ‰å¯æ¯”æ€§åœ°ã€‚ ä¸ºäº†ä½¿å¾—å¤„ç†å™¨å†…éƒ¨åœ°è¿ç®—å•å…ƒèƒ½å°½é‡è¢«å……åˆ†åˆ©ç”¨ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼ˆOut-Of-Order Executionï¼‰ä¼˜åŒ–ï¼Œå¤„ç†å™¨ä¼šåœ¨è®¡ç®—ä¹‹åå°†ä¹±åºæ‰§è¡Œåœ°ç»“æœé‡ç»„ï¼Œä¿è¯è¯¥ç»“æœä¸é¡ºåºæ‰§è¡Œåœ°ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä½†å¹¶ä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥è®¡ç®—çš„å…ˆåé¡ºåºä¸è¾“å…¥ä»£ç çš„é¡ºåºä¸€è‡´ï¼Œå› æ­¤å¦‚æœå­˜åœ¨ä¸€ä¸ªè®¡ç®—ä»»åŠ¡ä¾èµ–å¦ä¸€ä¸ªè®¡ç®—ä»»åŠ¡çš„ä¸­é—´ç»“æœï¼Œé‚£ä¹ˆå…¶é¡ºåºæ€§å¹¶ä¸èƒ½é ä»£ç çš„å…ˆåé¡ºåºæ¥ä¿è¯ã€‚ä¸å¤„ç†å™¨çš„ä¹±åºæ‰§è¡Œä¼˜åŒ–ç±»ä¼¼ï¼ŒJavaè™šæ‹Ÿæœºçš„å³æ—¶ç¼–è¯‘å™¨ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ä¼˜åŒ–ã€‚ Javaå†…å­˜æ¨¡å‹Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯•å›¾å®šä¹‰ä¸€ç§Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å¹¶å‘æ•ˆæœã€‚ ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜Javaå†…å­˜æ¨¡å‹çš„ä¸»è¦ç›®æ ‡æ˜¯å®šä¹‰ç¨‹åºä¸­å„ä¸ªå˜é‡çš„è®¿é—®è§„åˆ™ï¼Œå³åœ¨è™šæ‹Ÿæœºä¸­å°†å˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºæ¥å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚æ­¤å¤„çš„å˜é‡ä¸Javaç¼–ç¨‹ä¸­æ‰€è¯´çš„å˜é‡æœ‰åŒºåˆ«ï¼Œå®ƒåŒ…æ‹¬äº†å®ä¾‹å­—æ®µã€é™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡ä¸æ–¹æ³•å‚æ•°ï¼Œå› ä¸ºåè€…æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸ä¼šè¢«å…±äº«ï¼Œè‡ªç„¶å°±ä¸å­˜åœ¨ç«äº‰é—®é¢˜ã€‚ ä¸ºäº†è·å¾—è¾ƒå¥½çš„æ‰§è¡Œæ•ˆèƒ½ï¼ŒJavaå†…å­˜æ¨¡å‹å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„ç‰¹å®šå¯„å­˜å™¨æˆ–ç¼“å­˜æ¥å’Œä¸»å†…å­˜è¿›è¡Œäº¤äº’ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶å³æ—¶ç¼–è¯‘å™¨è°ƒæ•´ä»£ç æ‰§è¡Œé¡ºåºè¿™ç±»æƒåˆ©ã€‚ Javaå†…å­˜æ¨¡å‹è§„å®šäº†æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ã€‚æ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆWorking Menoryï¼Œç±»æ¯”é«˜é€Ÿç¼“å­˜ï¼‰ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„å€¼ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚ è¿™é‡Œæ‰€è®²çš„ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸Javaå†…å­˜åŒºåŸŸä¸­çš„Javaå †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ã€‚ä»å˜é‡ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜çš„å®šä¹‰æ¥çœ‹ï¼Œä¸»å†…å­˜ä¸»è¦å¯¹åº”Javaå †ä¸­å¯¹è±¡çš„å®ä¾‹æ•°æ®éƒ¨åˆ†ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸã€‚ä»æ›´ä½çš„å±‚æ¬¡æ¥è¯´ï¼Œä¸»å†…å­˜å°±æ˜¯ç¡¬ä»¶çš„å†…å­˜ï¼Œè€Œä¸ºäº†è·å¾—æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹ŸæœºåŠç¡¬ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨ä¸å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ã€‚ å†…å­˜é—´äº¤äº’æ“ä½œå…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¹‹ç±»çš„å®ç°ç»†èŠ‚ï¼ŒJavaå†…å­˜æ¨¡å‹é¡¶äº†å…«ç§æ“ä½œæ¥å®Œæˆï¼š lockï¼ˆé”å®šï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çš„çŠ¶æ€ã€‚ unlockï¼ˆè§£é”ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚ readï¼ˆè¯»å–ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ã€‚ loadï¼ˆè½½å…¥ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»å†…ä¸»å†…å­˜å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚ useï¼ˆä½¿ç”¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨åˆ°å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚ assignï¼ˆèµ‹å€¼ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚ storeï¼ˆå­˜å‚¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeæ“ä½œä½¿ç”¨ã€‚ writeï¼ˆå†™å…¥ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚ å¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜ï¼Œé‚£å°±è¦æŒ‰é¡ºåºæ‰§è¡Œreadå’Œloadæ“ä½œï¼Œå¦‚æœè¦æŠŠå˜é‡ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ï¼Œå°±è¦æŒ‰é¡ºåºåœ°æ‰§è¡Œstoreå’Œwriteæ“ä½œã€‚ Javaå†…å­˜æ¨¡å‹åªè¦æ±‚ä¸Šè¿°ä¸¤ä¸ªæ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œè€Œæ²¡æœ‰ä¿è¯å¿…é¡»è¿ç»­æ‰§è¡Œã€‚ Javaå†…å­˜æ¨¡å‹è¿˜è§„å®šäº†åœ¨æ‰§è¡Œä¸Šè¿°å…«ç§åŸºæœ¬æ“ä½œæ—¶å¿…é¡»æ»¡è¶³ï¼š ä¸å…è®¸readå’Œloadã€storeå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜è¯»å–äº†ä½†å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…ä»å·¥ä½œå†…å­˜å‘èµ·å›å†™äº†ä½†ä¸»å†…å­˜ä¸æ¥å—åœ°æƒ…å†µå‡ºç°ã€‚ ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒæœ€å¿Œä½ åœ°assignæ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚ ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°æŠŠæ•°æ®ä»çº¿ç¨‹åœ°å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚ ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆloadæˆ–assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½useå’Œstoreæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº†assignå’Œloadæ“ä½œã€‚ ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œï¼Œä½†lockæ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œlockåï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„unlockæ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚ å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œlockæ“ä½œï¼Œå°†ä¼šæ™´ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œloadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚ å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢«lockæ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œunlockæ“ä½œï¼›ä¹Ÿä¸å…è®¸unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚ å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä½å†…å­˜ä¸­ï¼ˆæ‰§è¡Œstoreå’Œwriteæ“ä½œï¼‰ã€‚ å¯¹äºvolatileå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™ å…³é”®å­—volatileå¯ä»¥è¯´æ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„æœ€è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å®¹æ˜“è¢«æ­£ç¡®åœ°ã€å®Œæ•´åœ°ç†è§£ï¼Œä»¥è‡³äºå¾ˆå¤šæ—¶å€™éƒ½ä¸å»ä½¿ç”¨å®ƒï¼Œé‡åˆ°éœ€è¦å¤„ç†å¤šçº¿ç¨‹æ•°æ®ç«äº‰çš„æ—¶å€™ä¸€å¾‹ä½¿ç”¨synchronizeæ¥è¿›è¡ŒåŒæ­¥ã€‚ å½“ä¸€ä¸ªå˜é‡è¢«å®šä¹‰æˆvolatileä¹‹åï¼Œå®ƒå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼š ç¬¬ä¸€ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ï¼Œè¿™é‡Œçš„â€œå¯è§æ€§â€æ˜¯æŒ‡å½“ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œæ–°å€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯ä»¥ç«‹å³å¾—çŸ¥çš„ã€‚è€Œæ™®é€šå˜é‡ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œå˜é‡å€¼åœ¨çº¿ç¨‹é—´ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚ volatileå˜é‡åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¸å­˜åœ¨ä¸€æ‰§è¡Œé—®é¢˜ï¼ˆåœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­volatileå˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯ç”±äºæ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½è¦å…ˆåˆ·æ–°ï¼Œæ‰§è¡Œå¼•æ“çœ‹ä¸åˆ°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºä¸å­˜åœ¨ä¸€æ‰§è¡Œé—®é¢˜ï¼‰ï¼Œä½†æ˜¯Javaé‡Œé¢çš„è¿ç®—å¹¶éåŸå­æ“ä½œï¼Œå¯¼è‡´volatileå˜é‡çš„è¿ç®—åœ¨å¹¶å‘ä¸‹ä¸€æ ·ä¸æ˜¯å®‰å…¨çš„ã€‚ ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨è§£é‡Šæ‰§è¡Œæ—¶ï¼Œè§£é‡Šå™¨å°†è¦è¿è¡Œè®¸å¤šè¡Œä»£ç æ‰èƒ½å®ç°å®ƒçš„è¯­ä¹‰ï¼Œå¦‚æœæ˜¯ç¼–è¯‘æ‰§è¡Œï¼Œä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤ä¹Ÿå¯èƒ½è½¬åŒ–æˆè‹¥å¹²æ¡æœ¬åœ°æœºå™¨ç æŒ‡ä»¤ã€‚ ç”±äºvolatileå˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œåœ¨ä¸ç¬¦åˆä»¥ä¸‹ä¸¤ç§è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸­ï¼Œä»ç„¶è¦é€šè¿‡æ·é”ï¼ˆä½¿ç”¨synchronizedæˆ–java.util.concurrentä¸­çš„åŸå­ç±»ï¼‰æ¥ä¿è¯åŸå­æ€§ã€‚ è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼ã€‚ å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚ ä½¿ç”¨ä½¿ç”¨volatileæ¥æ§åˆ¶å¹¶å‘çš„ä»£ç ï¼š volatile boolean shutdownRequested;public void shutdown() &#123; shutdownRequested = false;&#125;public void doWork() &#123; while (!shutdownRequested) &#123; // do stuff &#125;&#125; ç¬¬äºŒç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œæ™®é€šçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚å› ä¸ºåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç‚¹ï¼Œè¿™å°±æ˜¯Javaå†…å­˜æ¨¡å‹ä¸­æè¿°çš„æ‰€è°“çš„â€œçº¿ç¨‹å†…å­˜è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ï¼ˆWithin-Thread As-If-Serial Semanticsï¼‰ã€‚ æŒ‡ä»¤é‡æ’åºä¼šå¹²æ‰°ç¨‹åºçš„å¹¶ç½šæ‰§è¡Œçš„ä¾‹å­ï¼š Map configOptions;char[] configText;// æ­¤å˜é‡å¿…é¡»å®šä¹‰ä¸ºvolatilevolatile boolean initialized = false;// å‡è®¾ä»¥ä¸‹ä»£ç åœ¨çº¿ç¨‹Aä¸­æ‰§è¡Œ// æ¨¡æ‹Ÿè¯»å–é…ç½®ä¿¡æ¯ï¼Œå½“è¯»å–å®Œæˆåï¼Œå°†initializedè®¾ç½®ä¸ºtrueæ¥é€šçŸ¥å…¶ä»–çº¿ç¨‹é…ç½®å¯ç”¨configOptions = new HashMap();configText = readConfigFile(fileName);processConfigOptions(configText, configOptions);initialized = true;// å‡è®¾ä»¥ä¸‹ä»£ç åœ¨çº¿ç¨‹Bä¸­æ‰§è¡Œ// ç­‰å¾…initializedä¸ºtrueï¼Œä»£è¡¨çº¿ç¨‹Aå·²ç»æŠŠé…ç½®ä¿¡æ¯åˆå§‹åŒ–å®Œæˆ while (!initialized) &#123; sleep();&#125;// ä½¿ç”¨çº¿ç¨‹Aä¸­åˆå§‹åŒ–å¥½çš„é…ç½®ä¿¡æ¯doSomethingWithConfig(); è¿™æ®µä¼ªä»£ç æè¿°çš„åœºæ™¯ååˆ†å¸¸è§ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨å¤„ç†é…ç½®æ–‡ä»¶æ—¶ä¸€èˆ¬ä¸ä¼šå‡ºç°å¹¶å‘è€Œå·²ã€‚å¦‚æœinitializedæ²¡æœ‰ä½¿ç”¨volatileä¿®é¥°ï¼Œå°±å¯èƒ½ä¼šç”±äºæŒ‡ä»¤é‡æ’åºçš„ä¼˜åŒ–ï¼Œå¯¼è‡´çº¿ç¨‹Aä¸­æœ€åä¸€å¥ä¸­çš„â€œinitialized = true;â€è¢«æå‰æ‰§è¡Œï¼Œè¿™æ ·çº¿ç¨‹Bä¸­ä½¿ç”¨é…ç½®ä¿¡æ¯çš„ä»£ç å°±å¯èƒ½å‡ºç°é”™è¯¯ï¼Œè€Œvolatileå¯ä»¥é¿å…è¿™ç±»æƒ…å†µçš„å‘ç”Ÿã€‚ Javaå†…å­˜æ¨¡å‹ä¸­å¯¹volatileå˜é‡å®šä¹‰çš„ç‰¹æ®Šè§„åˆ™ã€‚å‡å®šTè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼ŒVå’ŒWåˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªvolatileå‹å˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œreadã€loadã€useã€asignã€storeå’Œwriteæ“ä½œæ—¶éœ€è¦æ»¡è¶³å¦‚ä¸‹çš„è§„åˆ™ï¼š åªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„å‰ä¸€ä¸ªåŠ¨ä½œæ—¶loadçš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡ŒuseåŠ¨ä½œï¼›å¹¶ä¸”ï¼Œåªæœ‰çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„åä¸€ä¸ªåŠ¨ä½œæ—¶useçš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹Væ‰§è¡ŒloadåŠ¨ä½œã€‚ç¨‹åºTå¯¹å˜é‡Vçš„useåŠ¨ä½œå¯ä»¥è®¤ä¸ºæ˜¯ä¸çº¿ç¨‹Tå¯¹å˜é‡Vçš„loadå’ŒreadåŠ¨ä½œç›¸å…³è”çš„ï¼Œå¿…é¡»ä¸€èµ·è¿ç»­å‡ºç°ã€‚ï¼ˆè¿™æ¡è§„åˆ™è¦æ±‚åœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨Vå‰éƒ½å¿…é¡»ä»ä¸»å†…å­˜åˆ·æ–°æœ€å…ˆçš„å€¼ï¼Œç”¨äºä¿è¯èƒ½çœ‹è§å…¶ä»–çº¿ç¨‹å¯¹å˜é‡Væ‰€åšçš„ä¿®æ”¹åçš„å€¼ï¼‰ã€‚ åªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡Væ‰§è¡Œçš„å‰ä¸€ä¸ªåŠ¨ä½œæ—¶assignçš„æ—¶å€™ï¼Œ çº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡ŒstoreåŠ¨ä½œï¼›å¹¶ä¸”ï¼Œåªæœ‰å½“çº¿ç¨‹Tå¯¹å˜é‡æ‰§è¡Œçš„åä¸€ä¸ªåŠ¨ä½œæ—¶storeçš„æ—¶å€™ï¼Œçº¿ç¨‹Tæ‰èƒ½å¯¹å˜é‡Væ‰§è¡ŒassignåŠ¨ä½œã€‚çº¿ç¨‹Tå¯¹å˜é‡Vçš„assignåŠ¨ä½œå¯ä»¥è®¤ä¸ºæ˜¯ä¸çº¿ç¨‹Tå¯¹å˜é‡Vçš„storeå’ŒwrityåŠ¨ä½œç›¸å…³è”çš„ï¼Œå¿…é¡»ä¸€èµ·è¿ç»­å‡ºç°ï¼ˆè¿™æ¡è§„åˆ™è¦æ±‚åœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä¿®æ”¹Våéƒ½å¿…é¡»ç«‹åˆ»åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼Œç”¨äºä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹åˆ°è‡ªå·±å¯¹å˜é‡Væ‰€åšçš„çš„ä¿®æ”¹ï¼‰ã€‚ å‡å®šåŠ¨ä½œAæ˜¯çº¿ç¨‹Tå¯¹å˜é‡Vå®æ–½çš„useæˆ–assignåŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œFæ˜¯ä¸åŠ¨ä½œAç›¸å…³è”çš„loadå’ŒstoreåŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œPæ˜¯ä¸åŠ¨ä½œFç›¸åº”çš„å¯¹å˜é‡Vçš„readæˆ–writeåŠ¨ä½œï¼›ç±»ä¼¼çš„ï¼Œå‡å®šåŠ¨ä½œBæ˜¯çº¿ç¨‹Tå¯¹å˜é‡Wå®æ–½çš„useæˆ–assignåŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œGæ˜¯ä¸åŠ¨ä½œBç›¸å…³çš„loadæˆ–storeåŠ¨ä½œï¼Œå‡å®šåŠ¨ä½œQæ˜¯ä¸åŠ¨ä½œGç›¸åº”çš„å¯¹å˜é‡Wçš„readæˆ–writeåŠ¨ä½œã€‚å¦‚æœAå…ˆäºBï¼Œé‚£ä¹ˆPå…ˆäºQï¼ˆè¿™æ¡è§„åˆ™è¦æ±‚volatileä¿®é¥°çš„å˜é‡ä¸å›å‘—æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œä¿è¯ä»£ç çš„æ‰§è¡Œé¡ºåºä¸ç¨‹åºçš„é¡ºåºç›¸åŒï¼‰ã€‚ å¯¹äºlongå’Œdoubleå‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™Javaå†…å­˜æ¨¡å‹è¦æ±‚lockã€unlockã€readã€loadã€assignã€useã€storeå’Œwriteè¿™å…«ä¸ªæ“ä½œéƒ½å…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯å¯¹äº64ä½çš„æ•°æ®ç±»å‹ï¼ˆlongå’Œdoubleï¼‰ï¼Œåœ¨æ¨¡å‹ä¸­ç‰¹åˆ«å®šä¹‰äº†ä¸€æ¡å®½æ¾çš„è§„å®šï¼šå…è®¸è™šæ‹Ÿæœºå°†æ²¡æœ‰è¢«volatileä¿®é¥°çš„64ä½æ•°æ®çš„è¯»å†™æ“ä½œåˆ’åˆ†ä¸ºä¸¤æ¬¡32ä½çš„æ“ä½œæ¥è¿›è¡Œï¼Œå³å…è®¸è™šæ‹Ÿæœºå®ç°é€‰æ‹©å¯ä»¥ä¸ä¿è¯64ä½æ•°æ®ç±»å‹çš„loadã€storeã€readå’Œwriteè¿™å››ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œè¿™ç‚¹å°±æ˜¯æ‰€è°“çš„longå’Œdoubleçš„éåŸå­æ€§åå®šã€‚åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸éœ€è¦å°†ç”¨åˆ°çš„longå’Œdoubleå˜é‡ä¸“é—¨å£°æ˜ä¸ºvolatileã€‚ åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§Javaå†…å­˜æ¨¡å‹æ—¶å›´ç»•ç€åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§è¿™ä¸‰ä¸ªç‰¹å¾æ¥å»ºç«‹çš„ã€‚ åŸå­æ€§ç”±Javaå†…å­˜æ¨¡å‹æ¥ç›´æ¥ä¿è¯çš„åŸå­æ€§å˜é‡æ“ä½œåŒ…æ‹¬readã€loadã€assignã€useã€storeå’Œwriteè¿™å…­ä¸ªï¼Œå¤§è‡´å¯ä»¥è®¤ä¸ºåŸºæœ¬æ•°æ®ç±»å‹çš„è®¿é—®å’Œè¯»å†™æ—¶å…·å¤‡åŸå­æ€§çš„ã€‚ å¦‚æœéœ€è¦ä¸€ä¸ªæ›´å¤§èŒƒå›´çš„åŸå­æ€§ä¿è¯ï¼ŒJavaå†…å­˜æ¨¡å‹æä¾›äº†lockå’Œunlockæ“ä½œæ¥æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œå°½ç®¡è™šæ‹ŸæœºæœªæŠŠlockå’Œunlockæ“ä½œç›´æ¥å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ˜¯å´æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤monitorenterå’Œmonitorexitæ¥éšå¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ“ä½œï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç åæ˜ åˆ°Javaä»£ç ä¸­å°±æ˜¯ç—›ä¸å¿«â€”â€”synchronizedå…³é”®å­—ï¼Œå› æ­¤åœ¨synchronizedå—ä¹‹é—´çš„æ“ä½œä¹Ÿå…·å¤‡åŸå­æ€§ã€‚ å¯è§æ€§å¯è§æ€§æ˜¯æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚Javaå†…å­˜æ¨¡å‹æ—¶é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°å¯è§æ€§çš„ï¼Œæ— è®ºæ˜¯æ™®é€šçš„å˜é‡è¿˜æ˜¯volatileå˜é‡éƒ½æ˜¯å¦‚æ­¤ï¼Œæ™®é€šå˜é‡ä¸volatileå˜é‡çš„åŒºåˆ«æ˜¯volatileçš„ç‰¹æ®Šè§„åˆ™ä¿è¯äº†æ–°å€¼èƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œä»¥åŠæ¯æ¬¡ä½¿ç”¨å‰ç«‹å³ä»ä¸»å†…å­˜åˆ·æ–°ã€‚ é™¤äº†volatileå¤–ï¼ŒJavaçš„synchronizedå’Œfinalå…³é”®å­—ä¹Ÿèƒ½å®ç°å¯è§æ€§ã€‚ æœ‰åºæ€§å¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚å‰åŠå¥æ˜¯æŒ‡â€œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ï¼ŒååŠå¥æ˜¯æŒ‡â€œæŒ‡ä»¤é‡æ’åºç°è±¡â€å’Œâ€œå·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿâ€ç°è±¡ã€‚ Javaè¯­è¨€æä¾›äº†volatileå’Œsynchronizedä¸¤ä¸ªå…³é”®å­—æ¥ä¿è¯çº¿ç¨‹ä¹‹é—´çš„æ“ä½œçš„æœ‰åºæ€§ï¼Œvolatileå…³é”®å­—æœ¬èº«å°±åŒ…å«äº†ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„è¯­ä¹‰ï¼Œè€Œsynchronizedåˆ™æ˜¯ç”±â€œä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œâ€è¿™æ¡è§„åˆ™è·å¾—çš„ï¼Œè¿™ä¸ªè§„åˆ™å†³å®šäº†æŒæœ‰åŒä¸€ä¸ªé”çš„ä¸¤ä¸ªåŒæ­¥å—åªèƒ½ä¸²è¡Œåœ°è¿›å…¥ã€‚ å…ˆè¡Œå‘ç”ŸåŸåˆ™å…ˆè¡Œå‘ç”Ÿæ—¶Javaå†…å­˜æ¨¡å‹ä¸­å®šä¹‰çš„ä¸¤é¡¹æ“ä½œä¹‹é—´çš„ååºå…³ç³»ï¼Œå¦‚æœè¯´æ“ä½œAå…ˆè¡Œå‘ç”Ÿä¸æ“ä½œBï¼Œå…¶å®å°±æ˜¯è¯´åœ¨å‘ç”Ÿæ“ä½œBä¹‹å‰ï¼Œæ“ä½œAäº§ç”Ÿçš„å½±å“èƒ½å‘—æ“ä½œBè§‚å¯Ÿåˆ°ï¼Œâ€œå½±å“â€åŒ…æ‹¬ä¿®æ”¹äº†å†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ã€å‘é€äº†æ¶ˆæ¯ã€è°ƒç”¨äº†æ–¹æ³•ç­‰ã€‚ Javaå†…å­˜æ¨¡å‹ä¸‹ä¸€äº›å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š ç¨‹åºæ¬¡åºè§„åˆ™ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ç¨‹åºä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿä¸ä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚å‡†ç¡®çš„è¯´åº”è¯¥æ˜¯æ§åˆ¶æµé¡ºåºè€Œä¸æ˜¯ç¨‹åºä»£ç é¡ºåºï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚ ç®¡ç¨‹é”è§„åˆ™ï¼šä¸€ä¸ªunlockæ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„lockæ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯åŒä¸€ä¸ªé”ï¼Œè€Œåé¢æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚ volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„æ¯’æ“ä½œï¼Œè¿™é‡Œçš„åé¢åŒæ ·æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚ çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚ çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ã€‚ çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿã€‚ å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆå…ˆè¡Œå‘ç”Ÿäºå®ƒçš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚ ä¼ é€’æ€§ï¼šå¦‚æœæ“ä½œAå…ˆè¡Œå‘ç”Ÿäºæ“ä½œBï¼Œæ“ä½œBå…ˆè¡Œå‘ç”ŸäºCï¼Œé‚£å°±å¯ä»¥å¾—å‡ºAæ“ä½œå…ˆè¡Œå‘ç”Ÿäºæ“ä½œCçš„ç»“è®ºã€‚ äº‹ä»¶ä¸Šå…ˆåé¡ºåºä¸å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹é—´åŸºæœ¬æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¡¡é‡å¹¶å‘å®‰å…¨é—®é¢˜æ—¶ä¸è¦æ”¶åˆ°äº‹ä»¶é¡ºåºçš„å¹²æ‰°ï¼Œä¸€åˆ‡å¿…é¡»ä»¥å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¸ºå‡†ã€‚ Javaä¸çº¿ç¨‹å¹¶å‘ä¸ä¸€å®šè¦ä¾èµ–å¤šçº¿ç¨‹ï¼Œä½†æ˜¯åœ¨Javaé‡Œé¢è°ˆè®ºå¹¶å‘ï¼Œå¤§å¤šæ•°éƒ½ä¸çº¿ç¨‹è„±ä¸å¼€å…³ç³»ã€‚ çº¿ç¨‹çš„å®ç°ä¸»æµçš„æ“ä½œç³»ç»Ÿéƒ½æä¾›äº†çº¿ç¨‹å®ç°ï¼ŒJavaè¯­è¨€åˆ™æä¾›äº†åœ¨ä¸åŒç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå¹³å°ä¸‹å¯¹çº¿ç¨‹æ“ä½œçš„ç»Ÿä¸€å¤„ç†ï¼Œæ¯ä¸ªjava.lang.Threadç±»çš„å®ä¾‹å°±ä»£è¡¨äº†ä¸€ä¸ªçº¿ç¨‹ã€‚ä¸è¿‡Threadç±»ä¸å¤§éƒ¨åˆ†çš„Java APIæœ‰ç€æ˜¾è‘—çš„åŒºåˆ«ï¼Œå®ƒçš„æ‰€æœ‰å…³é”®æ–¹æ³•éƒ½è¢«å£°æ˜ä¸ºNativeã€‚åœ¨Java APIä¸­ä¸€ä¸ªNativeæ–¹æ³•å¯èƒ½å°±ä»¥ä¸ºç€è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨å¹³å°æ— å…³çš„æ‰‹æ®µæ¥å®ç°ã€‚ å®ç°çº¿ç¨‹ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼šä½¿ç”¨å†…æ ¸å®ç°ï¼Œä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°ï¼Œä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°ã€‚ ä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°ç›´æ¥ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒçš„çº¿ç¨‹ï¼Œè¿™ç§çº¿ç¨‹ç”±å†…æ ¸çº¿ç¨‹æ¥å®Œæˆåˆ‡æ¢ï¼Œå†…æ ¸é€šè¿‡æ“çºµè°ƒåº¦å™¨å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œå¹¶è´Ÿè´£å°†çº¿ç¨‹çš„ä»»åŠ¡æ˜ å°„åˆ°å„ä¸ªå¤„ç†å™¨ä¸Šã€‚ç¨‹åºä¸€èˆ¬ä¸ä¼šç›´æ¥å»ä½¿ç”¨å†…æ ¸çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨å†…æ ¸çº¿ç¨‹çš„ä¸€ç§é«˜çº§æ¥å£â€”â€”è½»é‡çº§è¿›ç¨‹ï¼Œè½»é‡çº§è¿›ç¨‹å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šæ‰€å°†çš„çº¿ç¨‹ï¼Œç”±äºæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½ç”±ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ”¯æŒï¼Œå› æ­¤åªæœ‰å…ˆæ”¯æŒå†…æ ¸çº¿ç¨‹ï¼Œæ‰èƒ½æœ‰è½»é‡çº§è¿›ç¨‹ã€‚ ç”±äºå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå³ä½¿æœ‰ä¸€ä¸ªè½»é‡çº§è¿›ç¨‹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­é˜»å¡äº†ï¼Œä¹Ÿä¸ä¼šå½±å“æ•´ä¸ªè¿›ç¨‹ç»§ç»­å·¥ä½œï¼Œä½†æ˜¯è½»é‡çº§è¿›ç¨‹å…·æœ‰å®ƒçš„å±€é™æ€§ï¼šé¦–å…ˆï¼Œç”±äºæ˜¯åŸºäºå†…æ ¸çº¿ç¨‹å®ç°çš„ï¼Œæ‰€ä»¥å„ç§è¿›ç¨‹æ“ä½œï¼Œå¦‚åˆ›å»ºã€ææ„åŠåŒæ­¥ï¼Œéƒ½éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚è€Œç³»ç»Ÿè°ƒç”¨çš„ä»£ä»·ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸­æ¥å›åˆ‡æ¢ã€‚å…¶æ¬¡ï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œå› æ­¤è½»é‡çº§è¿›ç¨‹è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼Œå› æ­¤ä¸€ä¸ªç³»ç»Ÿæ”¯æŒè½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚ ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°å¹¿ä¹‰ä¸Šæ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹åªè¦ä¸æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œé‚£å°±å¯ä»¥è®¤ä¸ºæ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œå› æ­¤ä»è¿™ä¸ªå®šä¹‰ä¸Šæ¥è®²è½»é‡çº§è¿›ç¨‹ä¹Ÿå±äºç”¨æˆ·çº¿ç¨‹ï¼Œä½†è½»é‡çº§è¿›ç¨‹çš„å®ç°å§‹ç»ˆæ˜¯å»ºç«‹åœ¨å†…æ ¸ä¹‹ä¸Šçš„ï¼Œè®¸å¤šæ“ä½œéƒ½è¦è¿›è¡Œç³»ç»Ÿå—²ç”¨ï¼Œå› æ­¤æ•ˆç‡ä¼šæ”¶åˆ°é™åˆ¶ã€‚ ç‹­ä¹‰ä¸Šæ¥è®²ï¼Œç”¨æˆ·çš„çº¿ç¨‹æŒ‡çš„æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´çš„çº¿ç¨‹åº“ä¸Šï¼Œç³»ç»Ÿå†…æ ¸ä¸èƒ½æ„ŸçŸ¥åˆ°çº¿ç¨‹å­˜åœ¨çš„å®ç°ã€‚ç”¨æˆ·çº¿ç¨‹çš„å»ºç«‹ã€åŒæ­¥ã€é”€æ¯å’Œè°ƒåº¦å®Œå…¨åœ¨ç”¨æˆ·æ€ä¸­å®Œæˆï¼Œä¸éœ€è¦å†…æ ¸çš„å¸®åŠ©ã€‚å¦‚æœç¨‹åºå®ç°å¾—å½“ï¼Œè¿™ç§çº¿ç¨‹ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå› æ­¤æ“ä½œå¯ä»¥æ˜¯éå¸¸å¿«ä¸”ä½æ¶ˆè€—çš„ï¼Œä¹Ÿå¯ä»¥æ”¯æŒè§„æ¨¡æ›´å¤§çš„çº¿ç¨‹æ•°é‡ï¼Œéƒ¨åˆ†é«˜æ€§èƒ½æ•°æ®åº“ä¸­çš„å¤šçº¿ç¨‹å°±æ˜¯ç”±ç”¨æˆ·çº¿ç¨‹å®ç°çš„ã€‚ ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹çš„ä¼˜åŠ¿åœ¨äºä¸éœ€è¦ç³»ç»Ÿå†…æ ¸æ”¯æ´ï¼ŒåŠ£åŠ¿åœ¨äºæ²¡æœ‰ç³»ç»Ÿå†…æ ¸çš„æ”¯æ´ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æ“ä½œéƒ½éœ€è¦ç”¨æˆ·ç¨‹åºè‡ªå·±å¤„ç†ã€‚çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢å’Œè°ƒåº¦éƒ½æ˜¯éœ€è¦è€ƒè™‘é—®é¢˜ã€‚ æ··åˆå®ç°çº¿ç¨‹é™¤äº†ä¾èµ–å†…æ ¸çº¿ç¨‹å®ç°å’Œå®Œå…¨ç”±ç”¨æˆ·ç¨‹åºè‡ªå·±å®ç°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°†å†…æ ¸çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·ä½¿ç”¨çš„å®ç°æ–¹å¼ã€‚åœ¨è¿™ç§æ··åˆå®ç°ä¸‹ï¼Œæ—¢æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œä¹Ÿå­˜åœ¨è½»é‡çº§è¿›ç¨‹ã€‚ç”¨æˆ·å¿åŸè¿˜æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œå› æ­¤ç”¨æˆ·çº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€ææ„ç­‰æ“ä½œä¾ç„¶å»‰ä»·ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒå¤§è§„æ¨¡çš„ç”¨æˆ·çº¿ç¨‹å¹¶å‘ã€‚è€Œæ“ä½œç³»ç»Ÿæä¾›æ”¯æŒçš„è½»é‡çº§è¿›ç¨‹åˆ™ä½œä¸ºç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹ä¹‹é—´çš„æ¡¥æ¢ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨å†…æ ¸æä¾›çš„çº¿ç¨‹è°ƒåº¦åŠŸèƒ½åŠå¤„ç†å™¨æ˜ å°„ï¼Œå¹¶ä¸”ç”¨æˆ·çº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨è¦é€šè¿‡è½»é‡çº§çº¿ç¨‹æ¥å®Œæˆï¼Œå¤§å¤§é™ä½äº†è¿›ç¨‹è¢«é˜»å¡çš„é£é™©ã€‚ Javaçº¿ç¨‹çš„å®ç°æ“ä½œç³»ç»Ÿæ”¯æŒæ€æ ·çš„çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨å¾ˆå¤§æˆéƒ½ä¸Šå°±å†³å®šäº†Javaè™šæ‹Ÿæœºçš„çº¿ç¨‹æ˜¯æ€ä¹ˆæ ·æ˜ å°„çš„ï¼Œè¿™ç‚¹åœ¨ä¸åŒçš„å¹³å°ä¸Šæ²¡æœ‰åŠæ³•è¾¾æˆä¸€è‡´ï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿå¹¶æœªé™å®šJavaçº¿ç¨‹éœ€è¦ä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹æ¥å®ç°ã€‚ Javaçº¿ç¨‹è°ƒåº¦çº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é…å¤„ç†å™¨ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œä¸»è¦è°ƒåº¦æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ååŒå¼çº¿ç¨‹è°ƒåº¦å’ŒæŠ¢å å¼çº¿ç¨‹è°ƒåº¦ã€‚ ååŒå¼è°ƒåº¦çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ¥æ§åˆ¶ï¼Œçº¿ç¨‹æŠŠè‡ªå·±çš„å·¥ä½œæ‰§è¡Œå®Œäº†ä¹‹åï¼Œè¦ä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸Šå»ã€‚ååŒå¼å¤šçº¿ç¨‹çš„æœ€å¤§å¥½å¤„æ˜¯å®ç°ç®€å•ï¼Œè€Œä¸”ç”±äºçº¿ç¨‹è¦æŠŠè‡ªå·±çš„äº‹æƒ…å¹²å®Œåæ‰ä¼šè¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œåˆ‡æ¢æ“ä½œå¯¹çº¿ç¨‹è‡ªå·±æ˜¯å¯çŸ¥çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚ æŠ¢å å¼è°ƒåº¦æ¯ä¸ªçº¿ç¨‹ç”±ç³»ç»Ÿæ¥åˆ†é…æ‰§è¡Œæ—¶é—´ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸ç”±çº¿ç¨‹æœ¬èº«æ¥å†³å®šã€‚åœ¨è¿™ç§å®ç°çº¿ç¨‹è°ƒåº¦çš„æ–¹å¼ä¸‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´æ˜¯ç³»ç»Ÿå¯æ§çš„ï¼Œä¹Ÿä¸ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¼è‡´æ•´ä¸ªè¿›ç¨‹é˜»å¡çš„é—®é¢˜ï¼ŒJavaä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ–¹å¼å°±æ˜¯æŠ¢å å¼è°ƒåº¦ã€‚ çŠ¶æ€è½¬æ¢Javaå®šä¹‰äº†5ç§è¿›ç¨‹çŠ¶æ€ï¼Œåœ¨ä»»æ„ä¸€ä¸ªæ—¶é—´ç‚¹ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹åªèƒ½ç”±ä¸”åªæœ‰ä¸€ç§çŠ¶æ€ï¼š æ–°å»ºï¼šåˆ›å»ºåå°šæœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€ è¿è¡Œï¼šRunableåŒ…æ‹¬äº†æ“ä½œç³»ç»Ÿçº¿ç¨‹çŠ¶æ€ä¸­çš„Runningå’ŒReadyï¼Œä¹Ÿå°±æ˜¯å¤„äºæ­¤çŠ¶æ€çš„çº¿ç¨‹æœ‰å¯èƒ½æ­£åœ¨æ‰§è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½æ­£åœ¨ç­‰å¾…ç€CPUä¸ºå®ƒåˆ†é…æ‰§è¡Œæ—¶é—´ã€‚ æ— é™æœŸç­‰å¾…ï¼šå¤„äºè¿™ç§çŠ¶æ€çš„è¿›ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œå®ƒä»¬è¦ç­‰å¾…è¢«å…¶ä»–çº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ã€‚ä»¥ä¸‹æ–¹æ³•ä¼šè®©çº¿ç¨‹é™·å…¥æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼š æ²¡æœ‰è®¾ç½®Timeoutå‚æ•°åœ°Object.wait()æ–¹æ³•ã€‚ æ²¡æœ‰è®¾ç½®Timeoutå‚æ•°åœ°Thread.join()æ–¹æ³•ã€‚ LockSupport.park()æ–¹æ³•ã€‚ é™æœŸç­‰å¾…ï¼šå¤„äºè¿™ç§çŠ¶æ€çš„è¿›ç¨‹ä¹Ÿä¸ä¼šåˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œä¸è¿‡æ— é¡»ç­‰å¾…è¢«å…¶ä»–çº¿ç¨‹æ˜¾å¼å”¤é†’ï¼Œåœ¨ä¸€å®šæ—¶é—´ä¹‹åä»–ä»¬ä¼šç”±ç³»ç»Ÿè‡ªåŠ¨å”¤é†’ã€‚ä»¥ä¸‹æ–¹æ³•ä¼šè®©çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…çŠ¶æ€ï¼š Thread.sleep()æ–¹æ³•ã€‚ è®¾ç½®äº†Timeoutå‚æ•°çš„Object.wait()æ–¹æ³•ã€‚ è®¾ç½®äº†Timeoutå‚æ•°çš„Thread.join()æ–¹æ³•ã€‚ LockSupport.parkNanos()æ–¹æ³•ã€‚ LockSupport.parkUntil()æ–¹æ³•ã€‚ é˜»å¡ï¼šè¿›ç¨‹è¢«é˜»å¡äº†ï¼Œé˜»å¡çŠ¶æ€åœ¨ç­‰å¾…ç€è·å–åˆ°ä¸€ä¸ªæ’ä»–é”ï¼Œè¿™ä¸ªäº‹ä»¶å°†åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒè¿™ä¸ªé”çš„æ—¶å€™å‘ç”Ÿï¼›ç­‰å¾…çŠ¶æ€åˆ™æ˜¯åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…å”¤é†’åŠ¨ä½œçš„å‘ç”Ÿã€‚åœ¨ç¨‹åºç­‰å¾…è¿›å…¥åŒæ­¥åŒºåŸŸçš„æ—¶å€™ï¼Œ çº¿ç¨‹å°†è¿›å…¥è¿™ç§çŠ¶æ€ã€‚ ç»“æŸï¼šå·²ç»ˆæ­¢çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ï¼Œçº¿ç¨‹å·²ç»ç»“æŸæ‰§è¡Œã€‚ çº¿ç¨‹çŠ¶æ€è½¬æ¢å…³ç³»ï¼š å°ç»“äº†è§£äº†è™šæ‹ŸæœºJavaå†…å­˜æ¨¡å‹çš„ç»“æ„åŠæ“ä½œï¼Œè®²è§£äº†åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§åœ¨Javaå†…å­˜æ¨¡å‹ä¸­çš„ä½“ç°ï¼Œå…ˆè¡Œå‘ç”ŸåŸåˆ™çš„è§„åˆ™åŠä½¿ç”¨ã€‚è¿˜æœ‰çº¿ç¨‹åœ¨Javaè¯­è¨€ä¹‹ä¸­æ—¶å¦‚ä½•å®ç°çš„ã€‚ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ å›¾ç‰‡æ¥æº","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“","date":"2018-09-16T06:37:26.000Z","path":"2018/09/16/4cd43d51.html","text":"ä»£ç ç¼–è¯‘çš„ç»“æœä»æœ¬åœ°æœºå™¨ç å˜ä¸ºå­—èŠ‚ç ï¼Œæ˜¯å­˜å‚¨æ ¼å¼å‘å±•çš„ä¸€å°æ­¥ï¼Œç¡®å®ç¼–ç¨‹è¯­è¨€å‘å±•çš„ä¸€å¤§æ­¥ æ¦‚è¿°æ‰§è¡Œå¼•æ“æ˜¯Javaè™šæ‹Ÿæœºæœ€æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¡¬ä»¶ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è‡ªå·±å®ç°çš„ï¼Œå› æ­¤å¯ä»¥è‡ªè¡Œåˆ¶å®šæŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‰§è¡Œå“ªäº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†å¤Ÿæ ¼å¼ã€‚ Javaè™šæ‹Ÿæœºè§„èŒƒä¸­åˆ¶å®šäº†è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“çš„æ¦‚å¿µæ¨¡å‹ï¼Œè¿™ä¸ªæ¦‚å¿µæ¨¡å‹æˆä¸ºå„ç§è™šæ‹Ÿæœºæ‰§è¡Œå¼•æ“çš„ç»Ÿä¸€å¤–è§‚ï¼ˆFacadeï¼‰ã€‚åœ¨ä¸åŒçš„è™šæ‹Ÿæœºå®ç°é‡Œé¢ï¼Œæ‰§è¡Œå¼•æ“åœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™å¯èƒ½æœ‰è§£é‡Šæ‰§è¡Œï¼ˆé€šè¿‡è§£é‡Šå™¨æ‰§è¡Œï¼‰å’Œç¼–è¯‘æ‰§è¡Œï¼ˆé€šè¿‡å³æ—¶ç¼–è¯‘å™¨äº§ç”Ÿæœ¬åœ°ä»£ç æ‰§è¡Œï¼‰ä¸¤ç§é€‰æ‹©ï¼Œä¹Ÿå¯èƒ½ä¸¤è€…å…¼å¤‡ï¼Œç”šè‡³è¿˜å¯èƒ½åŒ…å«å‡ ä¸ªä¸åŒçº§åˆ«çš„ç¼–è¯‘å™¨æ‰§è¡Œå¼•æ“ã€‚ä½†ä»å¤–è§‚ä¸Šçœ‹èµ·æ¥ï¼Œæ‰€æœ‰Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“éƒ½æ˜¯ä¸€è‡´çš„ï¼šè¾“å…¥çš„æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£æçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œç»“æœã€‚ è¿è¡Œæ—¶æ ˆå¸§ç»“æ„æ ˆå¸§ï¼ˆStack Frameï¼‰æ˜¯ç”¨äºæ”¯æŒè™šæ‹Ÿæœºè¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºä¸­çš„è™šæ‹Ÿæœºæ ˆçš„æ ˆå…ƒç´ ã€‚æ ˆå¸§å­˜å‚¨çš„æ–¹æ³•çš„çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥å’Œæ–¹æ³•è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚ æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨å¼€å§‹åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆé‡Œé¢ä»å…¥æ ˆé“å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ æ¯ä¸€ä¸ªæ ˆå¸§éƒ½åŒ…æ‹¬äº†å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€å’Œä¸€äº›é¢å¤–çš„é™„åŠ ä¿¡æ¯ã€‚åœ¨ç¼–è¯‘ç¨‹åºä»£ç çš„æ—¶å€™ï¼Œæ ˆå¸§ä¸­éœ€è¦å¤šå¤§çš„å±€éƒ¨å˜é‡è¡¨ã€å¤šæ·±çš„æ“ä½œæ•°æ ˆéƒ½å·²ç»å®Œå…¨ç¡®å®šäº†ï¼Œå¹¶ä¸”å†™å…¥åˆ°æ–¹æ³•è¡¨çš„Codeå±æ€§ä¹‹ä¸­ï¼Œå› æ­¤ä¸€ä¸ªæ ˆå¸§éœ€è¦åˆ†é…å¤šå°‘å†…å­˜ï¼Œä¸ä¼šæ”¶åˆ°ç¨‹åºè¿è¡ŒæœŸå˜é‡æ•°æ®çš„å½±å“ï¼Œè€Œä»…ä»…å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚ ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ–¹æ³•è°ƒç”¨é“¾å¯èƒ½å›å¾ˆé•¿ï¼Œå¾ˆå¤šæ–¹æ³•éƒ½åŒäº‹å¤„äºæ‰§è¡ŒçŠ¶æ€ã€‚å¯¹äºæ‰§è¡Œå¼•æ“æ¥è®²ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œåªæœ‰æ ˆé¡¶æ˜¯æœ‰æ•ˆçš„ï¼Œç§°ä¸ºå½“å‰æ ˆå¸§ï¼Œè¿™ä¸ªæ ˆå¸§æ‰€å…³è”çš„æ–¹æ³•ç§°ä¸ºå½“å‰æ–¹æ³•ã€‚æ‰§è¡Œå¼•æ“æ‰€è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤éƒ½åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚ å±€éƒ¨å˜é‡è¡¨å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œç”¨äºå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚Javaç¨‹åºè¢«ç¼–è¯‘ä¸ºClassæ–‡ä»¶æ—¶ï¼Œå°±åœ¨æ–¹æ³•çš„Codeå±æ€§çš„mac_localsæ•°æ®é¡¹ä¸­ç¡®å®šäº†è¯¥æ–¹æ³•æ‰€éœ€è¦åˆ†é…çš„æœ€å¤§å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ã€‚ å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ä»¥å˜é‡æ§½ï¼ˆVariable Slotï¼‰ä¸ºæœ€å°å•ä½ï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®æŒ‡æ˜ä¸€ä¸ªSlotåº”å å†…å­˜ç©ºé—´å¤§å°ï¼Œåªæ˜¯è¯´æ˜æ¯ä¸ªSlotéƒ½åº”è¯¥èƒ½å­˜æ”¾ä¸€ä¸ªbooleanã€btyeã€charã€shortã€intã€floatã€referenceæˆ–returnAddressç±»å‹çš„æ•°æ®ï¼Œå®ƒå…è®¸Slotçš„é•¿åº¦éšç€å¤„ç†å™¨ã€æ“ä½œç³»ç»Ÿæˆ–è™šæ‹Ÿæœºçš„ä¸åŒè€Œå‘ç”Ÿå˜åŒ–ã€‚ä¸è¿‡æ— è®ºå¦‚ä½•ï¼Œå³ä½¿åœ¨64ä½è™šæ‹Ÿæœºä¸­ä½¿ç”¨äº†64ä½é•¿åº¦çš„å†…å­˜ç©ºé—´é‡Œçˆ±å®ç°ä¸€ä¸ªSlotï¼Œè™šæ‹Ÿæœºä»è¦ä½¿ç”¨å¯¹é½å’Œè¡¥ç™½çš„æ‰‹æ®µè®©Slotåœ¨å¤–è§‚ä¸Šçœ‹èµ·æ¥ä¸32ä½è™šæ‹Ÿæœºçš„ä¸€è‡´ã€‚ å¯¹äº64ä½çš„æ•°æ®ç±»å‹ï¼Œè™šæ‹Ÿæœºä¼šä»¥é«˜ä½åœ¨å‰çš„æ–¹å¼ä¸ºå…¶åˆ†é…ä¸¤ä¸ªè¿ç»­çš„Slotç©ºé—´ã€‚Javaè¯­è¨€ä¸­æ˜ç¡®è§„å®šçš„64ä½çš„æ•°æ®ç±»å‹åªæœ‰longå’Œdoubleä¸¤ç§ã€‚ è¿™é‡ŒæŠŠlongå’Œdoubleæ•°æ®ç±»å‹åˆ†å‰²å­˜å‚¨çš„åšæ³•ä¸â€œlongå’Œdoubleçš„éåŸå­æ€§åå®šâ€ä¸­æŠŠlongå’Œdoubleæ•°æ®ç±»å‹è¯»å†™åˆ†å‰²ä¸ºä¸¤æ¬¡32ä½è¯»å†™çš„åšæ³•ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œç”±äºå±€éƒ¨å˜é‡è¡¨å»ºç«‹åœ¨çº¿ç¨‹çš„å¯¹æˆ˜ä¸Šï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œæ— è®ºè¯»å†™ä¸¤ä¸ªè¿ç»­çš„Slotæ˜¯å¦æ˜¯åŸå­æ“ä½œï¼Œéƒ½ä¸ä¼šå¼•èµ·æ•°æ®å®‰å…¨é—®é¢˜ã€‚ è™šæ‹Ÿæœºé€šè¿‡ç´¢å¼•å®šä½çš„æ–¹å¼ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨ï¼Œç´¢å¼•å€¼çš„èŒƒå›´æ˜¯ä»0å¼€å§‹åˆ°å±€éƒ¨å˜é‡è¡¨æœ€å¤§çš„Slotå˜é‡ã€‚å¦‚æœæ˜¯32ä½æ•°æ®ç±»å‹çš„å˜é‡ï¼Œç´¢å¼•nå°±ä»£è¡¨äº†ä½¿ç”¨ç¬¬nä¸ªSlotï¼Œå¦‚æœæ˜¯64ä½æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™è¯´æ˜è¦ä½¿ç”¨ç¬¬nå’Œç¬¬n+1ä¸¤ä¸ªSlotã€‚ æ“ä½œæ•°æ ˆæ“ä½œæ•°æ ˆä¹Ÿå¸¸è¢«ç§°ä¸ºæ“ä½œæ ˆï¼Œæ˜¯ä¸€ä¸ªåå…¥å…ˆå‡ºï¼ˆLast In First Outï¼ŒLIFOï¼‰æ ˆã€‚åŒå±€éƒ¨å˜é‡è¡¨ä¸€æ ·ï¼Œæ“ä½œæ ˆçš„æœ€å¤§æ·±åº¦ä¹Ÿåœ¨ç¼–è¯‘çš„æ—¶å€™è¢«å†™å…¥åˆ°Codeå±æ€§çš„max_stacksæ•°æ®é¡¹ä¸­ã€‚æ“ä½œæ ˆçš„æ¯ä¸€ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„Javaæ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬longå’Œdoubleã€‚32ä½çš„æ•°æ®ç±»å‹æ‰€æ ˆçš„æ ˆå®¹é‡ä¸º1ï¼Œ64ä½çš„æ•°æ®ç±»å‹æ‰€å çš„æ ˆå®¹é‡ä¸º2ã€‚åœ¨æ–¹æ³•æ‰§è¡Œçš„ä»»ä½•æ—¶å€™ï¼Œæ“ä½œæ•°æ ˆçš„æ·±åº¦éƒ½ä¸ä¼šè¶…è¿‡åœ¨max_stacksæ•°æ®é¡¹ä¸­è®¾å®šçš„æœ€å¤§å€¼ã€‚ å½“ä¸€ä¸ªæ–¹æ³•åˆšåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å„ç§å­—èŠ‚ç æŒ‡ä»¤å‘æ“ä½œæ•°æ ˆä¸­å†™å…¥å’Œæå–å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å…¥æ ˆå‡ºæ ˆæ“ä½œã€‚ ä¾‹å¦‚ï¼Œåœ¨åšç®—æœ¯è¿ç®—çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œçš„ï¼Œåˆæˆ–è€…åœ¨è°ƒç”¨å…¶ä»–æ–¹æ³•çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œå‚æ•°ä¼ é€’çš„ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæ•´æ•°åŠ æ³•çš„å­—èŠ‚ç æŒ‡ä»¤iaddåœ¨è¿è¡Œçš„æ—¶å€™è¦æ±‚æ“ä½œæ•°æ ˆä¸­æœ€æ¥è¿‘æ ˆé¡¶çš„ä¸¤ä¸ªå…ƒç´ å·²ç»å­˜å…¥äº†ä¸¤ä¸ªintå‹çš„æ•°å€¼ï¼Œå½“æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤æ—¶ï¼Œä¼šå°†è¿™ä¸¤ä¸ªintå€¼å‡ºæ ˆå¹¶ç›¸åŠ ï¼Œç„¶åå°†ç›¸åŠ çš„ç»“æœå…¥æ ˆã€‚ åœ¨æ¦‚å¿µæ¨¡å‹ä¸­ï¼Œä¸¤ä¸ªæ ˆå¸§ä½œä¸ºè™šæ‹Ÿæœºæ ˆçš„å…ƒç´ ï¼Œç›¸äº’ä¹‹é—´æ—¶å®Œå…¨ç‹¬ç«‹çš„ã€‚ä½†æ˜¯å¤§å¤šæ•°è™šæ‹Ÿæœºçš„å®ç°é‡Œéƒ½ä¼šåšä¸€äº›ä¼˜åŒ–å¤„ç†ï¼Œä»¤ä¸¤ä¸ªæ ˆå¸§å‡ºç°ä¸€éƒ¨åˆ†é‡å ã€‚è®©ä¸‹é¢æ ˆå¸§çš„éƒ¨åˆ†æ“ä½œæ•°æ ˆä¸ä¸Šé¢æ ˆå¸§çš„éƒ¨åˆ†å±€éƒ¨å˜é‡è¡¨é‡å åœ¨ä¸€èµ·ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶å°±å¯ä»¥å…±ç”¨ä¸€éƒ¨åˆ†æ•°æ®ï¼Œè€Œæ— é¡»è¿›è¡Œé¢å¤–çš„å‚æ•°å¤åˆ¶ä¼ é€’äº†ã€‚ Javaè™šæ‹Ÿæœºçš„è§£é‡Šæ‰§è¡Œå¼•æ“ç§°ä¸ºâ€œåŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“â€ï¼Œå…¶ä¸­æ‰€æŒ‡çš„â€œæ ˆâ€å°±æ˜¯æ“ä½œæ•°æ ˆã€‚ åŠ¨æ€è¿æ¥æ¯ä¸ªæ ˆå¸§éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆæ‰€å±çš„æ–¹æ³•çš„å¼•ç”¨ï¼ŒæŒæœ‰è¿™ä¸ªå¼•ç”¨æ—¶ä¸ºäº†æ”¯æŒæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€è¿æ¥ã€‚å­—èŠ‚ç ä¸­çš„æ–¹æ³•è°ƒç”¨æŒ‡ä»¤å°±ä»¥å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ä¸ºå‚æ•°ã€‚è¿™äº›ç¬¦å·å¼•ç”¨ä¸€éƒ¨åˆ†ä¼šåœ¨ç±»åŠ è½½é˜¶æ®µæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™ç§è½¬åŒ–ç§°ä¸ºé™æ€è§£æã€‚å¦å¤–ä¸€éƒ¨åˆ†å°†åœ¨æ¯ä¸€æ¬¡çš„è¿è¡ŒæœŸé—´è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†ç§°ä¸ºåŠ¨æ€è¿æ¥ã€‚ æ–¹æ³•è¿”å›åœ°å€å½“ä¸€ä¸ªæ–¹æ³•è¢«æ‰§è¡Œåï¼Œæœ‰ä¸¤ç§æ–¹å¼é€€å‡ºè¿™ä¸ªæ–¹æ³•ã€‚ æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œæ˜¯å¦æœ‰è¿”å›å€¼å’Œè¿”å›å€¼çš„ç±»å‹å°†æ ¹æ®é‡åˆ°ä½•ç§æ–¹æ³•è¿”å›æŒ‡ä»¤æ¥å†³å®šï¼Œè¿™ç§é€€å‡ºæ–¹æ³•çš„æ–¹å¼ç§°ä¸ºæ­£å¸¸å®Œæˆå‡ºå£ã€‚ åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•ä½“å†…å¾—åˆ°å¤„ç†ï¼Œæ— è®ºæ˜¯Javaè™šæ‹Ÿæœºå†…éƒ¨äº§ç”Ÿçš„å¼‚å¸¸ï¼Œè¿˜æ˜¯ä»£ç ä¸­ä½¿ç”¨athrowå­—èŠ‚ç æŒ‡ä»¤äº§ç”Ÿçš„å¼‚å¸¸ï¼Œåªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œè¿™ç§é€€å‡ºæ–¹æ³•çš„æ–¹å¼ç§°ä¸ºå¼‚å¸¸å®Œæˆå‡ºå£ã€‚ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨å¼‚å¸¸å®Œæˆå‡ºå£çš„æ–¹å¼é€€å‡ºï¼Œæ˜¯ä¸ä¼šç»™å®ƒçš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿè¿”å›å€¼çš„ã€‚ æ— è®ºé‡‡ç”¨ä½•ç§é€€å‡ºæ–¹å¼ï¼Œåœ¨æ–¹æ³•é€€å‡ºä¹‹åï¼Œéƒ½éœ€è¦è¿”å›åˆ°æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ï¼Œç¨‹åºè—èƒ½ç»§ç»­æ‰§è¡Œï¼Œæ–¹æ³•è¿”å›æ—¶å¯èƒ½éœ€è¦åœ¨æ ˆå¸§ä¸­ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œç”¨æ¥å¸®åŠ©æ¢å¤å®ƒçš„ä¸Šå±‚æ–¹æ³•æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼å°±å¯ä»¥ä½œä¸ºè¿”å›åœ°å€ï¼Œæ ˆå¸§ä¸­å¾ˆå¯èƒ½ä¼šä¿å­˜è¿™ä¸ªè®¡æ•°å™¨å€¼ã€‚è€Œæ–¹æ³•å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€æ—¶è¦é€šè¿‡å¼‚å¸¸å¤„ç†å™¨è¡¨æ¥ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚ æ–¹æ³•é€€å‡ºçš„è¿‡ç¨‹å®é™…ä¸Šç­‰åŒäºæŠŠå½“å‰æ ˆå¸§å‡ºæ ˆï¼Œå› æ­¤é€€å‡ºæ—¶å¯èƒ½æ‰§è¡Œçš„æ“ä½œæœ‰ï¼š æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆ æŠŠè¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ è°ƒæ•´PCè®¡æ•°å™¨çš„å€¼ä»¥æŒ‡å‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åé¢çš„ä¸€æ¡æŒ‡ä»¤ é™„åŠ ä¿¡æ¯è™šæ‹Ÿæœºè§„èŒƒå…è®¸å…·ä½“çš„è™šæ‹Ÿæœºå®ç°å¢åŠ ä¸€äº›è§„èŒƒé‡Œæ²¡æœ‰æè¿°çš„ä¿¡æ¯åˆ°æ ˆå¸§ä¹‹ä¸­ï¼Œä¾‹å¦‚ä¸è°ƒè¯•ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å®Œå…¨å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸€èˆ¬ä¼šæŠŠåŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€ä¸å…¶ä»–é™„åŠ ä¿¡æ¯å…¨éƒ¨å½’ä½ä¸€ç±»ï¼Œç§°ä¸ºæ ˆå¸§ä¿¡æ¯ã€‚ æ–¹æ³•è°ƒç”¨æ–¹æ³•è°ƒç”¨å¹¶ä¸ç­‰åŒäºæ–¹æ³•æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨é˜¶æ®µå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šè¢«è°ƒç”¨æ–¹æ³•çš„ç‰ˆæœ¬ï¼ˆå³è°ƒç”¨å“ªä¸€ä¸ªæ–¹æ³•ï¼‰ï¼Œæš‚æ—¶è¿˜ä¸æ¶‰åŠæ–¹æ³•å†…éƒ¨çš„å…·ä½“è¿è¡Œè¿‡ç¨‹ã€‚ åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶æœ€æ™®éã€æœ€é¢‘ç¹çš„æ“ä½œï¼Œä½†å‰é¢å·²ç»è®²è¿‡ï¼ŒClassæ–‡ä»¶è¿›è¡Œç¼–è¯‘è¿‡ç¨‹ä¸­ä¸åŒ…å«ä¼ ç»Ÿç¼–è¯‘ä¸­çš„è¿ç»­æ­¥éª¤ï¼Œä¸€åˆ‡æ–¹æ³•è°ƒç”¨åœ¨Classæ–‡ä»¶é‡Œå­˜å‚¨çš„éƒ½åªæ˜¯ç¬¦å·å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ–¹æ³•åœ¨å®é™…è¿è¡Œæ—¶å†…å­˜å¸ƒå±€ä¸­çš„å…¥å£åœ°å€ã€‚è¿™ä¸ªç‰¹æ€§ç»™Javaå¸¦æ¥äº†æ›´å¼ºå¤§çš„åŠ¨æ€æ‰©å±•èƒ½åŠ›ï¼Œä½†ä¹Ÿä½¿å¾—Javaæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å˜å¾—ç›¸å¯¹å¤æ‚èµ·æ¥ï¼Œéœ€è¦åœ¨ç±»åŠ è½½æœŸé—´ç”šè‡³åˆ°è¿è¡ŒæœŸé—´æ‰èƒ½ç¡®å®šç›®æ ‡æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚ è§£ææ‰€æœ‰æ–¹æ³•è°ƒç”¨ä¸­çš„ç›®æ ‡æ–¹æ³•åœ¨Classæ–‡ä»¶é‡Œé¢éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨ï¼Œåœ¨ç±»åŠ è½½çš„è§£æé˜¶æ®µï¼Œä¼šå°†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¿™ç§è§£æèƒ½æˆç«‹çš„å‰ææ˜¯ï¼šæ–¹æ³•åœ¨ç¨‹åºçœŸæ­£æ‰§è¡Œä¹‹å‰å°±æœ‰ä¸€ä¸ªç¡®å®šçš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ç§è§£æèƒ½æˆç«‹çš„å‰ææ˜¯ï¼šæ–¹æ³•åœ¨ç¨‹åºçœŸæ­£è¿è¡Œä¹‹å‰å°±æœ‰ä¸€ä¸ªå¯ç¡®å®šçš„è°ƒç”¨ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ç‰ˆæœ¬åœ¨è¿è¡ŒæœŸæ˜¯ä¸å¯æ”¹å˜çš„ã€‚æ¢å¥è¯è¯´ï¼Œè°ƒç”¨ç›®æ ‡åœ¨ç¨‹åºä»£ç å†™å¥½ã€ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æ—¶å°±å¿…é¡»ç¡®å®šä¸‹æ¥ã€‚è¿™ç±»æ–¹æ³•çš„è°ƒç”¨ç§°ä¸ºè§£æã€‚ åœ¨Javaè¯­è¨€ä¸­ï¼Œç¬¦åˆâ€œç¼–è¯‘å™¨å¯çŸ¥ï¼Œè¿è¡ŒæœŸä¸å¯å˜â€è¿™ä¸ªè¦æ±‚çš„æ–¹æ³•ä¸»è¦æœ‰é™æ€æ–¹æ³•å’Œç§æœ‰æ–¹æ³•ä¸¤å¤§ç±»ï¼Œå‰è€…ä¸ç±»å‹ç›´æ¥å…³è”ï¼Œåè€…åœ¨å¤–éƒ¨ä¸å¯è¢«è®¿é—®ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸å¯èƒ½é€šè¿‡ç»§æ‰¿æˆ–åˆ«çš„æ–¹å¼å……è¡€å‡ºå…¶ä»–ç‰ˆæœ¬ï¼Œå› æ­¤å®ƒä»¬éƒ½é€‚åˆåœ¨ç±»åŠ è½½é˜¶æ®µè¿›è¡Œè§£æã€‚ è§£æè°ƒç”¨ä¸€å®šæ˜¯ä¸ªé™æ€çš„è¿‡ç¨‹ï¼Œåœ¨ç¼–è¯‘æœŸé—´å°±å®Œå…¨ç¡®å®šï¼Œåœ¨ç±»è£…è½½çš„è§£æé˜¶æ®µå°±ä¼šæŠŠæ¶‰åŠçš„ç¬¦å·å¼•ç”¨å…¨éƒ¨è½¬å˜ä¸ºå¯ç¡®å®šçš„ç›´æ¥å¼•ç”¨ï¼Œä¸ä¼šå»¶è¿Ÿåˆ°è¿è¡ŒæœŸå†å»å®Œæˆã€‚è€Œåˆ†æ´¾è°ƒç”¨åˆ™å¯èƒ½æ—¶é™æ€çš„ä¹Ÿå¯èƒ½æ—¶åŠ¨æ€çš„ï¼Œæ ¹æ®åˆ†æ´¾ä¸€å¥çš„å®—é‡æ•°å¯åˆ†ä¸ºå•åˆ†æ´¾å’Œå¤šåˆ†æ´¾ã€‚è¿™ä¸¤ç±»åˆ†æ´¾æ–¹å¼ä¸¤ä¸¤ç»„åˆå°±æ„æˆäº†é™æ€å•åˆ†æ´¾ã€é™æ€å¤šåˆ†æ´¾ã€åŠ¨æ€å•åˆ†æ´¾ã€åŠ¨æ€å¤šåˆ†æ´¾å››ç§åˆ†æ´¾æƒ…å†µã€‚ åˆ†æ´¾Javaæ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå› ä¸ºJavaå…·å¤‡é¢å‘å¯¹è±¡çš„ä¸‰ä¸ªç‰¹å¾ï¼šç»§æ‰¿ã€å°è£…å’Œå¤šæ€ã€‚åˆ†æ´¾è°ƒç”¨è¿‡ç¨‹å°†ä¼šæ­ç¤ºå¤šæ€ç‰¹æ€§çš„ä¸€äº›æœ€åŸºæœ¬çš„ä½“ç°ï¼ˆå¦‚â€œé‡è½½â€å’Œâ€œé‡å†™â€ï¼‰ã€‚ é™æ€åˆ†æ´¾ä»£ç æ¸…å•ï¼ˆæ–¹æ³•é™æ€åˆ†æ´¾æ¼”ç¤ºï¼‰ï¼š package com.cayzlh.demo;/** * æ–¹æ³•é™æ€åˆ†æ´¾æ¼”ç¤º */public class StaticDispatch &#123; static abstract class Human&#123;&#125; static class Man extends Human &#123;&#125; static class Woman extends Human &#123;&#125; public void sayHello(Human guy) &#123; System.out.println(&quot;Hello, guy!&quot;); &#125; public void sayHello(Man guy) &#123; System.out.println(&quot;Hello, gentleman!&quot;); &#125; public void sayHello(Woman guy) &#123; System.out.println(&quot;Hello, lady!&quot;); &#125; public static void main(String[] args) &#123; Human man = new Man(); Human women = new Woman(); StaticDispatch sd = new StaticDispatch(); sd.sayHello(man); sd.sayHello(women); &#125;&#125; è¿è¡Œç»“æœï¼š Hello, guy!Hello, guy! ç›¸ä¿¡å¯¹Javaç¨å¾®æœ‰ç»éªŒçš„ç¨‹åºå‘˜çœ‹å®Œç¨‹åºåéƒ½èƒ½å¾—å‡ºæ­£ç¡®çš„è¿è¡Œç»“æœï¼Œä½†ä¸ºä»€ä¹ˆä¼šé€‰æ‹©æ‰§è¡Œå‚æ•°ç±»å‹ä¸ºhumançš„é‡è½½å‘¢ï¼Ÿåœ¨è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œå…ˆæŒ‰å¦‚ä¸‹ä»£ç å®šä¹‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š Human man = new Man(); æŠŠä¸Šé¢ä»£ç ä¸­çš„â€œHumanâ€ç§°ä¸ºå˜é‡çš„é™æ€ç±»å‹ï¼ˆStatic Typeï¼‰æˆ–è€…å¤–è§‚ç±»å‹ï¼ˆApparent Typeï¼‰ï¼Œåé¢çš„â€œManâ€åˆ™ç§°ä¸ºå˜é‡çš„å®é™…ç±»å‹ï¼ˆActual Typeï¼‰ï¼Œé™æ€ç±»å‹å’Œå®é™…ç±»å‹åœ¨ç¨‹åºä¸­éƒ½å¯ä»¥å‘ç”Ÿä¸€äº›å˜åŒ–ï¼ŒåŒºåˆ«æ˜¯é™æ€ç±»å‹çš„å˜åŒ–ä»…ä»…åœ¨ä½¿ç”¨æ—¶å‘ç”Ÿï¼Œå˜é‡æœ¬èº«çš„é™æ€å˜é‡ç±»å‹ä¸ä¼šæ”¹å˜ï¼Œå¹¶ä¸”æœ€ç»ˆçš„é™æ€ç±»å‹æ˜¯åœ¨ç¼–è¯‘æœŸå¯çŸ¥çš„ï¼›è€Œå®é™…ç±»å‹å˜åŒ–çš„ç»“æœåœ¨è¿è¡ŒæœŸæ‰å¯ç¡®å®šï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘ç¨‹åºçš„æ—¶å€™å¹¶ä¸çŸ¥é“ä¸€ä¸ªå¯¹è±¡çš„å®é™…ç±»å‹æ˜¯ä»€ä¹ˆã€‚ // å®é™…ç±»å‹å˜åŒ–Human man = new Man();man = new Women();// é™æ€ç±»å‹å˜åŒ–sd.sayHello((Man) man);sd.sayHello((Women) women); ä¼šåˆ°ä»£ç ä¸­ï¼Œmain()é‡Œé¢ä¸¤æ¬¡sayHello()æ–¹æ³•è°ƒç”¨ï¼Œåœ¨æ–¹æ³•æ¥æ”¶è€…å·²ç»ç¡®å®šæ˜¯å¯¹è±¡sdçš„å‰æä¸‹ï¼Œä½¿ç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬ï¼Œå°±å®Œå…¨å–å†³äºä¼ å…¥å‚æ•°çš„æ•°é‡å’Œæ•°æ®ç±»å‹ã€‚ä»£ç ä¸­å®šä¹‰äº†ä¸¤ä¸ªé™æ€ç±»å‹ç›¸åŒã€å®é™…ç±»å‹ä¸åŒçš„å˜é‡ï¼Œå•è™šæ‹Ÿæœºåœ¨é‡è½½æ—¶æ˜¯é€šè¿‡å‚æ•°çš„é™æ€ç±»å‹è€Œä¸æ˜¯å®é™…ç±»å‹ä½œä¸ºåˆ¤å®šä¾æ®çš„ã€‚å¹¶ä¸”é™æ€ç±»å‹æ˜¯ç¼–è¯‘æœŸå¯çŸ¥çš„ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒJavacç¼–è¯‘å™¨å°±æ ¹æ®å‚æ•°çš„é™æ€ç±»å‹å†³å®šä½¿ç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬ã€‚ æ‰€æœ‰ä¾èµ–é™æ€ç±»å‹æ¥å®šä½æ–¹æ³•æ‰§è¡Œç‰ˆæœ¬çš„åˆ†æ´¾åŠ¨ä½œï¼Œéƒ½ç§°ä¸ºé™æ€åˆ†æ´¾ã€‚é™æ€åˆ†æ´¾çš„æœ€å…¸å‹åº”ç”¨å°±æ˜¯æ–¹æ³•é‡è½½ã€‚é™æ€åˆ†æ´¾å‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå› æ­¤é™æ€åˆ†æ´¾çš„åŠ¨ä½œå®é™…ä¸Šä¸æ˜¯ç”±è™šæ‹Ÿæœºæ¥æ‰§è¡Œçš„ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è™½ç„¶èƒ½ç¡®å®šå‡ºæ–¹æ³•çš„é‡è½½ç‰ˆæœ¬ï¼Œä½†åœ¨å¾ˆå¤šæƒ…å†µä¸‹è¿™ä¸ªé‡è½½ç‰ˆæœ¬å¹¶ä¸æ˜¯â€œå”¯ä¸€çš„â€ï¼Œå¾€å¾€åªèƒ½ç¡®å®šä¸€ä¸ªâ€œæ›´åŠ é€‚åˆçš„â€ç‰ˆæœ¬ã€‚ åŠ¨æ€åˆ†æ´¾åŠ¨æ€åˆ†æ´¾å’Œå¤šæ€æ€§çš„å¦å¤–ä¸€ä¸ªé‡è¦ä½“ç°â€”â€”é‡å†™ï¼ˆOverrideï¼‰æœ‰ç€å¾ˆå¯†åˆ‡çš„å…³è”ã€‚ ä»£ç æ¸…å•ï¼š package com.cayzlh.demo;/** * æ–¹æ³•åŠ¨æ€åˆ†æ´¾æ¼”ç¤º */public class DynamicDispatch &#123; static abstract class Human &#123; protected abstract void sayHello(); &#125; static class Man extends Human &#123; @Override protected void sayHello() &#123; System.out.println(&quot;man say hello&quot;); &#125; &#125; static class Women extends Human &#123; @Override protected void sayHello() &#123; System.out.println(&quot;women say hello&quot;); &#125; &#125; public static void main(String[] args) &#123; Human man = new Man(); Human women = new Women(); man.sayHello(); women.sayHello(); man = new Women(); man.sayHello(); &#125;&#125; è¿è¡Œç»“æœï¼š man say hellowomen say hellowomen say hello æ˜¾ç„¶è¿™é‡Œæ˜¯ä¸å¯èƒ½æ ¹æ®é™æ€ç±»å‹æ¥å†³å®šçš„ï¼Œå› ä¸ºé™æ€ç±»å‹éƒ½æ˜¯Humançš„ä¸¤ä¸ªå˜é‡manå’Œwomenåœ¨è°ƒç”¨sayHello()æ–¹æ³•æ—¶æ‰§è¡Œäº†ä¸åŒçš„è¡Œä¸ºï¼Œå¹¶ä¸”å˜é‡manåœ¨ä¸¤æ¬¡è°ƒç”¨ä¸­æ‰§è¡Œäº†ä¸åŒçš„æ–¹æ³•ã€‚å¯¼è‡´è¿™ä¸ªç°è±¡çš„åŸå› å¾ˆæ˜æ˜¾ï¼Œæ˜¯è¿™ä¸¤ä¸ªå˜é‡çš„å®é™…ç±»å‹ä¸åŒã€‚ å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾æ–¹æ³•çš„æ¥æ”¶è€…ä¸æ–¹æ³•çš„å‚æ•°ç»Ÿç§°ä¸ºæ–¹æ³•çš„å®—é‡ã€‚æ ¹æ®åˆ†æ´¾åŸºäºå¤šå°‘ç§å®—é‡ï¼Œå¯ä»¥å°†åˆ†æ´¾åˆ’åˆ†ä¸ºå•åˆ†æ´¾å’Œå¤šåˆ†æ´¾ä¸¤ç§ã€‚å•åˆ†æ´¾æ˜¯æ ¹æ®ä¸€ä¸ªå®—é‡å¯¹ç›®æ ‡è¿›è¡Œé€‰æ‹©ï¼Œå¤šåˆ†æ´¾åˆ™æ˜¯æ ¹æ®å¤šä½™ä¸€ä¸ªçš„å®—é‡å¯¹ç›®æ ‡è¿›è¡Œé€‰æ‹©ã€‚ ä»£ç æ¸…å•ï¼ˆåˆ—ä¸¾ä¸€ä¸ªFatherå’ŒSonä¸€èµ·æ¥åšå‡ºâ€œä¸€ä¸ªè‰°éš¾çš„å†³å®šâ€çš„ä¾‹å­ï¼‰ï¼š package com.cayzlh.demo;/** * å•åˆ†æ´¾ä¸å¤šåˆ†æ´¾ */public class Dispatch &#123; static class QQ &#123; &#125; static class _360 &#123; &#125; public static class Father &#123; public void hardChoice(QQ arg) &#123; System.out.println(&quot;father choose qq&quot;); &#125; public void hardChoice(_360 arg) &#123; System.out.println(&quot;father choose 360&quot;); &#125; &#125; public static class Son extends Father &#123; public void hardChoice(QQ arg) &#123; System.out.println(&quot;son choose qq&quot;); &#125; public void hardChoice(_360 arg) &#123; System.out.println(&quot;son choose 360&quot;); &#125; &#125; public static void main(String[] args) &#123; Father father = new Father(); Father son = new Son(); father.hardChoice(new _360()); son.hardChoice(new QQ()); &#125;&#125; è¿è¡Œç»“æœï¼š father choose 360son choose qq ç¼–è¯‘èŠ‚ç‚¹ç¼–è¯‘æœŸçš„é€‰æ‹©è¿‡ç¨‹ï¼Œå³é™æ€åˆ†æ´¾çš„è¿‡ç¨‹ã€‚è¿™æ—¶å€™é€‰æ‹©ç›®æ ‡æ–¹æ³•çš„ä¾æ®æœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯é™æ€ç±»å‹æ˜¯Fatherè¿˜æ˜¯Sonï¼ŒäºŒæ˜¯æ–¹æ³•å‚æ•°æ˜¯QQè¿˜æ˜¯360ã€‚è¿™æ¬¡é€‰æ‹©ç»“æœçš„æœ€ç»ˆäº§ç‰©æ˜¯äº§ç”Ÿäº†ä¸¤æ¡invokevirtualæŒ‡ä»¤ï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„å‚æ•°åˆ†åˆ«ä¸ºå¸¸é‡æ± ä¸­æŒ‡å‘Father.hardChoince(360)åŠFather.hardChoice(QQ)æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ã€‚å› ä¸ºæ˜¯æ ¹æ®ä¸¤ä¸ªå®—é‡è¿›è¡Œé€‰æ‹©ï¼Œæ‰€ä»¥Javaè¯­è¨€çš„é™æ€åˆ†æ´¾å±äºå¤šåˆ†æ´¾ç±»å‹ã€‚ è¿è¡Œé˜¶æ®µè™šæ‹Ÿæœºçš„é€‰æ‹©ï¼Œå³åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ã€‚åœ¨æ‰§è¡Œâ€son.hardChoice(new QQ())â€è¿™å¥ä»£ç æ—¶ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œåœ¨æ‰§è¡Œè¿™å¥ä»£ç æ‰€å¯¹åº”çš„invokevirtualæŒ‡ä»¤æ—¶ï¼Œç”±äºç¼–è¯‘æœŸå·²ç»å†³å®šç›®æ ‡æ–¹æ³•çš„ç­¾åå¿…é¡»ä¸ºhardChoice(QQ)ï¼Œè™šæ‹Ÿæœºæ­¤æ—¶ä¸ä¼šå…³å¿ƒä¼ é€’è¿‡æ¥çš„å‚æ•°æ˜¯â€œQQâ€åˆ°åº•æ˜¯â€œè…¾è®¯QQâ€è¿˜æ˜¯â€œå¥‡ç‘QQâ€ï¼Œå› ä¸ºè¿™æ—¶å‚æ•°çš„é™æ€ç±»å‹ã€å®é™…ç±»å‹éƒ½ä¸ä¼šå¯¹æ–¹æ³•çš„é€‰æ‹©æ„æˆä»»ä½•å½±å“ï¼Œå”¯ä¸€å¯ä»¥å½±å“è™šæ‹Ÿæœºé€‰æ‹©çš„å› ç´ åªæœ‰æ­¤æ–¹æ³•çš„æ¥æ”¶è€…çš„å®é™…ç±»å‹æ˜¯Fatherè¿˜æ˜¯Sonã€‚å› ä¸ºåªæœ‰ä¸€ä¸ªå®—é‡ä½œä¸ºé€‰æ‹©ä¾æ®ï¼Œæ‰€ä»¥Javaè¯­è¨€çš„åŠ¨æ€åˆ†æ´¾å±äºå•åˆ†æ´¾ç±»å‹ã€‚ è™šæ‹ŸæœºåŠ¨æ€åˆ†æ´¾çš„å®ç°ç”±äºåŠ¨æ€åˆ†æ´¾æ˜¯éå¸¸é¢‘ç¹çš„åŠ¨ä½œï¼Œè€Œä¸”åŠ¨æ€åˆ†æ´¾çš„æ–¹æ³•ç‰ˆæœ¬é€‰æ‹©è¿‡ç¨‹éœ€è¦è¿è¡Œæ—¶åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤åœ¨è™šæ‹Ÿæœºçš„å®é™…å®ç°ä¸­åŸºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œå¤§éƒ¨åˆ†å®ç°éƒ½ä¸ä¼šçœŸçš„è¿›è¡Œå¦‚æ­¤é¢‘ç¹çš„æœç´¢ã€‚ é¢å¯¹è¿™ç§æƒ…å†µï¼Œæœ€å¸¸ç”¨çš„â€œç¨³å®šä¼˜åŒ–â€æ‰‹æ®µå°±æ˜¯**åœ¨ç±»çš„æ–¹æ³•åŒºä¸­å»ºç«‹ä¸€ä¸ªå¾æ–¹æ³•è¡¨ï¼Œä½¿ç”¨è™šæ‹Ÿæ–¹æ³•è¡¨ç´¢å¼•æ¥ä»£æ›¿åŸæ•°æ®æŸ¥æ‰¾ä»¥æé«˜æ€§èƒ½ã€‚ è™šæ–¹æ³•è¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£åœ°å€ã€‚å¦‚æœæŸä¸ªæ–¹æ³•åœ¨å­ç±»ä¸­æ²¡æœ‰è¢«é‡å†™ï¼Œé‚£ä¹ˆå­ç±»çš„è™šæ–¹æ³•è¡¨é‡Œé¢çš„åœ°å€å…¥å£å’Œçˆ¶ç±»ç›¸åŒæ–¹æ³•çš„å…¥å£æ—¶ä¸€è‡´çš„ï¼Œéƒ½æŒ‡å‘çˆ¶ç±»çš„å®ç°å…¥å£ã€‚å¦‚æœå­ç±»ä¸­é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œå­ç±»æ–¹æ³•è¡¨ä¸­çš„åœ°å€å°†ä¼šè¢«æ›¿æ¢ä¸ºæŒ‡å‘å­å˜å®ç°ç‰ˆæœ¬çš„å…¥å£åœ°å€ã€‚ ä¸ºäº†ç¨‹åºå®ç°ä¸Šçš„æ–¹ä¾¿ï¼Œå…·æœ‰ç›¸åŒç­¾åçš„æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»ã€å­ç±»çš„è™šæ–¹æ³•è¡¨ä¸­éƒ½åº”å½“å…·æœ‰ä¸€æ ·çš„ç´¢å¼•åºå·ï¼Œè¿™æ ·å½“ç±»å‹å˜æ¢æ—¶ï¼Œä»…éœ€è¦å˜æ›´æŸ¥æ‰¾çš„æ–¹æ³•è¡¨ï¼Œå°±å¯ä»¥ä»ä¸åŒçš„è™šæ–¹æ³•è¡¨ä¸­æŒ‰ç´¢å¼•è½¬æ¢å‡ºæ‰€éœ€çš„å…¥å£åœ°å€ã€‚ æ–¹æ³•è¡¨ä¸€èˆ¬åœ¨ç±»åŠ è½½çš„è¿æ¥é˜¶æ®µè¿›è¡Œåˆå§‹åŒ–ï¼Œå‡†å¤‡äº†ç±»çš„å˜é‡åˆå§‹å€¼åï¼Œè™šæ‹Ÿæœºä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚ åŸºäºæ ˆçš„å­—èŠ‚ç è§£é‡Šæ‰§è¡Œå¼•æ“è§£é‡Šæ‰§è¡Œä¸è®ºæ˜¯è§£é‡Šè¿˜æ˜¯ç¼–è¯‘ï¼Œä¹Ÿä¸è®ºæ˜¯ç‰©ç†æœºè¿˜æ˜¯è™šæ‹Ÿæœºï¼Œå¯¹äºåº”ç”¨ç¨‹åºï¼Œæœºå™¨éƒ½ä¸å¯èƒ½å¦‚äººé‚£æ ·é˜…è¯»å’Œç†è§£ï¼Œç„¶åå‡ è·å¾—äº†ç†è§£èƒ½åŠ›ã€‚å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç åˆ°ç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ç¼–è¯‘è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾ï¼Œä¸­ä¸‹é¢çš„é‚£æ¡åˆ†æ”¯ï¼Œå°±æ˜¯ä¼ ç»Ÿç¼–è¯‘åŸç†ä¸­ç¨‹åºä»£ç åˆ°ç›®æ ‡æœºå™¨ä»£ç çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œè€Œä¸­é—´çš„é‚£æ¡åˆ†æ”¯è‡ªç„¶å°±æ˜¯è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ã€‚ å¦‚ä»Šï¼ŒåŸºäºç‰©ç†æœºã€Javaè™šæ‹Ÿæœºæˆ–è€…æ˜¯éJavaçš„å…¶ä»–é«˜çº§è¯­è¨€è™šæ‹Ÿæœºçš„è¯­è¨€ï¼Œå¤§å¤šéƒ½éµå¾ªç€ä¸­åŸºäºç°ä»£ç»å…¸ç¼–è¯‘åŸç†çš„æ€è·¯ï¼Œåœ¨æ‰§è¡Œå‰å…ˆå¯¹ç¨‹åºæºç è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æå¤„ç†ï¼ŒæŠŠæºç è½¬åŒ–ä¸ºæŠ½è±¡è¯­æ³•æœ¯ã€‚å¯¹äºä¸€é—¨å…·ä½“è¯­è¨€çš„å®ç°æ¥è¯´ï¼Œè¯æ³•å’Œè¯­æ³•åˆ†æä¹ƒè‡³åé¢çš„ä¼˜åŒ–å™¨å’Œç›®æ ‡ä»£ç ç”Ÿæˆå™¨éƒ½å¯ä»¥é€‰æ‹©ç‹¬ç«‹äºæ‰§è¡Œå¼•æ“ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´æ„ä¹‰çš„ç¼–è¯‘å™¨å»å®ç°ï¼Œè¿™ç±»ä»£è¡¨æ˜¯C/C++è¯­è¨€ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æŠŠå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ­¥éª¤å®ç°ä¸ºä¸€ä¸ªåŠç‹¬ç«‹çš„ç¼–è¯‘å™¨ï¼Œè¿™ç±»ä»£è¡¨æ˜¯Javaè¯­è¨€ã€‚åˆæˆ–è€…æŠŠè¿™äº›æ­¥éª¤å’Œæ‰§è¡Œå¼•æ“å…¨éƒ¨é›†ä¸­å°è£…åœ¨ä¸€ä¸ªå°é—­çš„é»‘å¤¹å­ä¹‹ä¸­ï¼Œå¦‚å¤§å¤šæ•°çš„JavaScriptæ‰§è¡Œå™¨ï¼Œ Javaè¯­è¨€ä¸­ï¼ŒJavacç¼–è¯‘å™¨å®Œæˆäº†ç¨‹åºä»£ç ç»è¿‡è¯æ³•åˆ†æã€è¯­æ³•åˆ†æåˆ°æŠ½è±¡è¯­æ³•ä¹¦ï¼Œå†ä¾¿éå†è¯­æ³•æœ¯ç”Ÿæˆçº¿æ€§çš„å­—èŠ‚ç æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚å› ä¸ºè¿™ä¸€éƒ¨åˆ†åŠ¨ä½œæ˜¯åœ¨Javaè™šæ‹Ÿæœºä¹‹å¤–è¿›è¡Œçš„ï¼Œè€Œè§£é‡Šå™¨åœ¨è™šæ‹Ÿæœºçš„å†…éƒ¨ï¼Œæ‰€ä»¥Javaçš„ç¼–è¯‘å°±æ˜¯åŠç‹¬ç«‹çš„å®ç°ã€‚ åŸºäºæ ˆçš„æŒ‡ä»¤é›†ä¸åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†Javaç¼–è¯‘å™¨è¾“å‡ºçš„æŒ‡ä»¤æµï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ç§åŸºäºæ ˆçš„æŒ‡ä»¤é›†æ¶æ„ï¼ŒæŒ‡ä»¤æµé‡Œé¢çš„æŒ‡ä»¤å¤§éƒ¨åˆ†éƒ½æ˜¯é›¶åœ°å€æŒ‡ä»¤ï¼Œå®ƒä»¬ä¾èµ–æ“ä½œæ•°æ ˆè¿›è¡Œå·¥ä½œã€‚ä¸ä¹‹ç›¸å¯¹çš„å¦å¤–ä¸€å¥—å¸¸ç”¨çš„æŒ‡ä»¤é›†æ¶æ„å¸ˆåŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†ï¼Œæœ€å…¸å‹çš„å°±æ˜¯x86çš„äºŒåœ°å€æŒ‡ä»¤é›†ã€‚ åŸºäºæ ˆçš„æŒ‡ä»¤é›†æœ€ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯å¯ç§»æ¤æ€§ï¼Œå¯„å­˜å™¨ç”±ç¡¬ä»¶ç›´æ¥æä¾›ï¼Œç¨‹åºç›´æ¥ä»¥æ¥è¿™äº›ç¡¬ä»¶å¯„å­˜å™¨åˆ™ä¸å¯é¿å…åœ°è¦å—åˆ°çº¦æŸã€‚ æ ˆæ¶æ„æŒ‡ä»¤é›†çš„ä¸»è¦ç¼ºç‚¹æ˜¯æ‰§è¡Œé€Ÿåº¦ç›¸å¯¹æ¥è¯´ç¨æ…¢ä¸€äº›ã€‚æ‰€æœ‰ä¸»æµç‰©ç†æœºçš„æŒ‡ä»¤é›†éƒ½æ˜¯å¯„å­˜å™¨æ¶æ„ä¹Ÿä»ä¾§é¢å°è¯äº†è¿™ä¸€ç‚¹ã€‚ æ ˆæ¶æ„æŒ‡ä»¤é›†çš„ä»£ç è™½ç„¶ç´§å‡‘ï¼Œä½†æ˜¯å®Œæˆç›¸åŒåŠŸèƒ½æ‰€éœ€çš„æŒ‡ä»¤æ•°é‡ä¸€èˆ¬ä¼šæ¯”å¯„å­˜å™¨æ¶æ„å¤šï¼Œå› ä¸ºå‡ºæ ˆã€å…¥æ ˆæ“ä½œæœ¬èº«å°±äº§ç”Ÿäº†ç›¸å½“å¤šçš„æŒ‡ä»¤ã€‚æ›´é‡è¦çš„æ˜¯æ ˆå®ç°åœ¨å†…å­˜ä¹‹ä¸­ï¼Œé¢‘ç¹çš„æ ˆè®¿é—®ä¹Ÿå°±æ„å‘³ç€é¢‘ç¹çš„å†…å­˜è®¿é—®ï¼Œç›¸å¯¹äºå¤„ç†å™¨æ¥è¯´ï¼Œå†…å­˜å§‹ç»ˆæ˜¯æ‰§è¡Œé€Ÿåº¦çš„ç“¶é¢ˆã€‚å°½ç®¡è™šæ‹Ÿæœºå¯ä»¥é‡‡å–æ ˆé¡¶ç¼“å­˜çš„æ‰‹æ®µï¼ŒæŠŠæœ€é•¿ç”¨çš„æ“ä½œæ˜ å°„åˆ°å¯„å­˜å™¨ä¸­ä»¥é¿å…ç›´æ¥å†…å­˜è®¿é—®ï¼Œä½†è¿™ä¹Ÿåªèƒ½æ˜¯ä¼˜åŒ–æªæ–½è€Œä¸æ˜¯è§£å†³æœ¬è´¨é—®é¢˜çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œ**ç”±äºæŒ‡ä»¤æ•°é‡å’Œå†…å­˜è®¿é—®çš„åŸå› ï¼Œå¯¼è‡´äº†æ ˆæ¶æ„æŒ‡ä»¤é›†çš„æ‰§è¡Œé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚ å°ç»“åˆ†æäº†è™šæ‹Ÿæœºåœ¨æ‰§è¡Œä»£ç æ—¶å¦‚ä½•æ‰¾åˆ°æ­£ç¡®çš„æ–¹æ³•ï¼Œå¦‚ä½•æ‰§è¡Œæ–¹æ³•å†…çš„å­—èŠ‚ç ï¼Œä»¥åŠæ‰§è¡Œä»£ç æ—¶æ¶‰åŠçš„å†…å­˜ç»“æ„ã€‚é’ˆå¯¹Javaç¨‹åºæ—¶å¦‚ä½•å­˜å‚¨çš„ã€å¦‚ä½•è½½å…¥ï¼ˆåˆ›å»ºï¼‰çš„ä»¥åŠå¦‚ä½•æ‰§è¡Œçš„é—®é¢˜ç›¸å…³çŸ¥è¯†è®²è§£äº†ä¸€ä¸‹ã€‚ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶","date":"2018-09-14T02:44:37.000Z","path":"2018/09/14/cdffca23.html","text":"ä»£ç ç¼–è¯‘çš„ç»“æœä»æœ¬åœ°æœºå™¨ç å˜ä¸ºå­—èŠ‚ç ï¼Œæ˜¯å­˜å‚¨æ ¼å¼å‘å±•çš„ä¸€å°æ­¥ï¼Œç¡®å®ç¼–ç¨‹è¯­è¨€å‘å±•çš„ä¸€å¤§æ­¥ æ¦‚è¿°è™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è½¬æ¢è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œè¿™å°±æ˜¯è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶ã€‚ ä¸å“ªäº›ç¼–è¯‘æ—¶éœ€è¦è¿›è¡Œè¿æ¥å·¥ä½œçš„è¯­è¨€ä¸åŒï¼Œåœ¨Javaè¯­è¨€é‡Œé¢ï¼Œç±»å‹çš„åŠ è½½å’Œè¿æ¥è¿‡ç¨‹éƒ½æ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å®Œæˆçš„ï¼Œè¿™æ ·ä¼šåœ¨ç±»åŠ è½½æ—¶ç¨å¾®å¢åŠ ä¸€äº›æ€§èƒ½å¼€é”€ï¼Œä½†æ—¶å´èƒ½ä¸ºJavaåº”ç”¨ç¨‹åºæä¾›é«˜åº¦çš„çµæ´»æ€§ï¼ŒJavaä¸­å¤©ç”Ÿå¯ä»¥åŠ¨æ€æ‰©å±•çš„è¯­è¨€ç‰¹æ€§å°±æ˜¯ä¾èµ–è¿è¡ŒæœŸåŠ¨æ€åŠ è½½å’ŒåŠ¨æ€è¿æ¥è¿™ä¸ªç‰¹ç‚¹å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¼–å†™ä¸€ä¸ªä½¿ç”¨æ¥å£çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç­‰åˆ°è¿è¡Œæ—¶å†æŒ‡å®šå…¶å®é™…çš„å®ç°ã€‚è¿™ç§ç»„è£…åº”ç”¨ç¨‹åºçš„æ–¹å¼å¹¿æ³›åº”ç”¨äºJavaç¨‹åºä¹‹ä¸­ã€‚ ç±»åŠ è½½çš„æ—¶æœºç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œåˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼šåŠ è½½ï¼ˆLoadingï¼‰ã€éªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰ã€ä½¿ç”¨ï¼ˆUsingï¼‰å’Œå¸è½½ï¼ˆUnloadingï¼‰ä¸ƒä¸ªé˜¶æ®µã€‚å…¶ä¸­éªŒè¯ã€å‡†å¤‡å’Œè§£æä¸‰ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºè¿æ¥ï¼ˆLinkingï¼‰ã€‚ åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½è¿™äº”ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰éƒ¨å°±ç­åœ°å¼€å§‹ï¼Œè€Œè§£æé˜¶æ®µåˆ™ä¸ä¸€å®šï¼šå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒJavaè¯­è¨€çš„è¿è¡Œæ—¶ç»‘å®šï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€ç»‘å®šæˆ–æ™šæœŸç»‘å®šï¼‰ã€‚æ³¨æ„è¿™é‡Œæ˜¯æŒ‰éƒ¨å°±ç­åœ°â€œå¼€å§‹â€ï¼Œè€Œä¸æ˜¯æŒ‰éƒ¨å°±ç­åœ°â€œè¿›è¡Œâ€æˆ–â€œå®Œæˆâ€ï¼Œå› ä¸ºè¿™äº›é˜¶æ®µé€šå¸¸éƒ½æ˜¯äº’ç›¸äº¤å‰åœ°æ··åˆå¼è¿›è¡Œåœ°ï¼Œé€šå¸¸ä¼šå†ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œåœ°è¿‡ç¨‹ä¸­è°ƒç”¨æˆ–æ¿€æ´»å¦å¤–ä¸€ä¸ªé˜¶æ®µã€‚ Javaè™šæ‹Ÿæœºè§„èŒƒä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰å››ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œâ€œåˆå§‹åŒ–â€ï¼ˆè€ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡è‡ªç„¶éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ï¼‰ï¼š é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤åœ°æœ€å¸¸è§åœ°Javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡åœ°æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± åœ°é™æ€å­—æ®µé™¤å¤–ï¼‰åœ°æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»åœ°é™æ€æ–¹æ³•åœ°æ—¶å€™ã€‚ ä½¿ç”¨java.lang.reflectåŒ…åœ°æ–¹æ³•å¯¹ç±»è¿›è¡Œå‘å°„è°ƒç”¨åœ°æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ å½“åˆå§‹åŒ–ä¸€ä¸ªç±»åœ°æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»åœ°åˆå§‹åŒ–ã€‚ å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œåœ°ä¸»ç±»ï¼ˆåŒ…æ‹¬main()æ–¹æ³•åœ°é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚ è¢«åŠ¨å¼•ç”¨åœ°ä¾‹å­ä¹‹ä¸€çˆ¶ç±»ï¼š package com.cayzlh.reference1;/** * è¢«åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤ºä¸€ * é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ– */public class SuperClass &#123; static &#123; System.out.println(&quot;SuperClass init..&quot;); &#125; public static int value = 123;&#125; å­ç±»ï¼š package com.cayzlh.reference1;public class SubClass extends SuperClass &#123; static &#123; System.out.println(&quot;SubClass init..&quot;); &#125;&#125; æ‰§è¡Œï¼š package com.cayzlh.reference1;/** * éä¸»åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤º */public class NotInitialization &#123; public static void main(String[] args) &#123; System.out.println(SuperClass.value); &#125;&#125; è¿è¡Œç»“æœï¼š ä¸Šè¿°ä»£ç è¿è¡Œä¹‹åï¼Œ åªä¼šè¾“å‡ºâ€œSuperClass init..â€ï¼Œè€Œä¸ä¼šè¾“å‡ºâ€œSubClass init..â€ã€‚å¯¹äºé™æ€å­—æ®µï¼Œåªæœ‰ç›´æ¥å®šä¹‰è¿™ä¸ªå­—æ®µçš„ç±»æ‰ä¼šè¢«åˆå§‹åŒ–ï¼Œå› æ­¤é€šè¿‡å­ç±»æ¥å¼•ç”¨çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€å­—æ®µï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–è€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–ã€‚è‡³äºæ˜¯å¦è¦è§¦å‘å­ç±»çš„åŠ è½½å’ŒéªŒè¯ï¼Œå†è™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®è§„å®šï¼Œè¿™ç‚¹å–å†³äºè™šæ‹Ÿæœºçš„å…·ä½“å®ç°ã€‚ è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹äºŒä»£ç ï¼š package com.cayzlh.reference2;import com.cayzlh.reference1.SuperClass;/** * é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ– */public class NotInitialization &#123; public static void main(String[] args) &#123; SuperClass[] sca = new SuperClass[10]; &#125;&#125; è¿è¡Œç»“æœï¼š è¿è¡Œä¹‹åå‘ç°æ²¡æœ‰è¾“å‡ºâ€œSuperClass init..â€ï¼Œè¯´æ˜å¹¶æ²¡æœ‰è§¦å‘SuperClassç±»çš„åˆå§‹åŒ–é˜¶æ®µã€‚ è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­ä¹‹ä¸‰ä»£ç 1ï¼š package com.cayzlh.reference3;/** * å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œ * æœ¬è´¨ä¸Šæ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å®šä¹‰å¸¸é‡çš„ç±»ï¼Œ * å› æ­¤ä¸èƒ½è§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ– */public class ConstClass &#123; static &#123; System.out.println(&quot;ConstClass init..&quot;); &#125; public static final String HELLOWORLD = &quot;Hello World.&quot;;&#125; ä»£ç 2ï¼š package com.cayzlh.reference3;/** * éä¸»åŠ¨ä½¿ç”¨ç±»å­—æ®µæ¼”ç¤º */public class NotInitialization &#123; public static void main(String[] args) &#123; System.out.println(ConstClass.HELLOWORLD); &#125;&#125; è¿è¡Œç»“æœï¼š ä¸Šè¿°ä»£ç è¿è¡Œä¹‹åï¼Œæ²¡æœ‰è¾“å‡ºâ€œConstClass init..â€ï¼Œè¿™æ˜¯å› ä¸ºè™½ç„¶åœ¨Javaæºç ä¸­å¼•ç”¨äº†ConstClassç±»ä¸­çš„å¸¸é‡HELLOWORLDï¼Œä½†æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå°†æ­¤å¸¸é‡çš„å€¼â€Hello World.â€å­˜å‚¨åˆ°äº†NotInitializationç±»çš„å¸¸é‡æ± ä¸­ï¼Œå¯¹å¸¸é‡ConstClass.HELLOWORLDçš„å¼•ç”¨éƒ½è¢«è½¬åŒ–ä¸ºNotInitializationç±»å¯¹è‡ªèº«å¸¸é‡æ± çš„å¼•ç”¨äº†ã€‚ä¹Ÿå°±æ˜¯è¯´å®é™…ä¸ŠNotInitializationçš„Classæ–‡ä»¶ä¹‹ä¸­å¹¶æ²¡æœ‰ConstClassç±»çš„ç¬¦å·å¼•ç”¨å…¥å£ï¼Œè¿™ä¸¤ä¸ªç±»åœ¨ç¼–è¯‘æˆClassä¹‹åå°±ä¸å†å­˜åœ¨ä»»ä½•è”ç³»äº†ã€‚ ç±»åŠ è½½çš„è¿‡ç¨‹ç±»åŠ è½½çš„çš„å…¨è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–è¿™äº”ä¸ªé˜¶æ®µçš„è¿‡ç¨‹ã€‚ åŠ è½½â€œåŠ è½½â€ï¼ˆLoadingï¼‰é˜¶æ®µæ˜¯â€œç±»åŠ è½½â€ï¼ˆClass Loadingï¼‰è¿‡ç¨‹çš„ä¸€ä¸ªé˜¶æ®µã€‚åœ¨åŠ è½½é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦å®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…ï¼š 1ï¼‰é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ 2ï¼‰å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ 3ï¼‰åœ¨Javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºå°†è¿™äº›æ•°æ®çš„è®¿é—®å…¥å£ è™šæ‹Ÿæœºè§„èŒƒçš„è¿™ä¸‰ç‚¹è¦æ±‚å®é™…ä¸Šå¹¶ä¸å…·ä½“ï¼Œå› æ­¤è™šæ‹Ÿæœºå®ç°ä¸å…·ä½“åº”ç”¨çš„çµæ´»åº¦ç›¸å½“å¤§ã€‚ç›¸å¯¹äºç±»åŠ è½½è¿‡ç¨‹çš„å…¶ä»–é˜¶æ®µï¼ŒåŠ è½½é˜¶æ®µï¼ˆåŠ è½½é˜¶æ®µä¸­è·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠ¨ä½œï¼‰æ˜¯å¼€å‘æœŸå¯æ§æ€§æœ€å¼ºçš„é˜¶æ®µï¼Œå› ä¸ºåŠ è½½é˜¶æ®µæ˜¯æ—¢å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨æ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å»å®Œæˆï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨å»æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ã€‚ éªŒè¯ éªŒè¯æ—¶è¿æ¥é˜¶æ®µçš„ç¬¬ä¸€æ­¥ï¼Œè¿™ä¸€é˜¶æ®µçš„ç›®çš„æ—¶ä¸ºäº†ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚ Classæ–‡ä»¶å¹¶ä¸ä¸€å®šè¦æ±‚ç”¨Javaæºç ç¼–è¯‘è€Œæ¥ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•é€”å¾„ï¼ŒåŒ…æ‹¬ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨ç›´æ¥ç¼–å†™æ¥äº§ç”ŸClassæ–‡ä»¶ã€‚å¦‚æœè™šæ‹Ÿæœºä¸æ£€æŸ¥è¾“å…¥çš„å­—èŠ‚æµï¼Œå¯¹å…¶å®Œå…¨ä¿¡ä»»çš„è¯ï¼Œå¾ˆå¯èƒ½ä¼šå› ä¸ºè½½å…¥äº†æœ‰å®³çš„å­—èŠ‚æµè€Œå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ‰€ä»¥éªŒè¯æ—¶è™šæ‹Ÿæœºè‡ªèº«ä¿æŠ¤çš„ä¸€é¡¹é‡è¦å·¥ä½œã€‚ è™šæ‹Ÿæœºå¤§è‡´ä¸Šä¼šå®Œæˆä¸‹é¢å››ä¸ªé˜¶æ®µçš„æ£€æŸ¥è¿‡ç¨‹ï¼šæ–‡ä»¶æ ¼å¼éªŒè¯ã€å…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯å’Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚ æ–‡ä»¶æ ¼å¼éªŒè¯ç¬¬ä¸€é˜¶æ®µè¦éªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ï¼š æ˜¯å¦ä»¥é­”æ•°0xCAFEBABEå¼€å¤´ ä¸»ã€æ¬¡ç‰ˆæœ¬å·æ˜¯å¦åœ¨å½“å‰è™šæ‹Ÿæœºå¤„ç†èŒƒå›´ä¹‹å†… å¸¸é‡æ± çš„å¸¸é‡ä¸­æ˜¯å¦æœ‰ä¸è¢«æ”¯æŒçš„å¸¸é‡ç±»å‹ æŒ‡å‘å¸¸é‡çš„å„ç§ç´¢å¼•å€¼æ˜¯å¦æœ‰åªæƒ³ä¸å­˜åœ¨å¸¸é‡æˆ–ä¸ç¬¦åˆç±»å‹çš„å¸¸é‡ CONSTANT_Utf8_infoå‹çš„å¸¸é‡ä¸­æ˜¯å¦æœ‰ä¸ç¬¦åˆUTF8ç¼–ç çš„æ•°æ® Classæ–‡ä»¶ä¸­å„ä¸ªéƒ¨åˆ†åŠæ–‡ä»¶æœ¬èº«æ˜¯å¦æœ‰è¢«åˆ é™¤çš„é¢æˆ–é™„åŠ çš„å…¶ä»–ä¿¡æ¯ Â·Â·Â·Â·Â·Â· å®é™…ä¸Šç¬¬ä¸€é˜¶æ®µçš„éªŒè¯è¿˜è¿œè¿œä¸æ­¢è¿™äº›ï¼Œè¯¥éªŒè¯é˜¶æ®µçš„ä¸»è¦ç›®çš„æ—¶ä¿è¯è¾“å…¥çš„å­—èŠ‚æµèƒ½æ­£ç¡®åœ°è§£æå¹¶å­˜å‚¨ä¸æ–¹æ³•åŒºä¹‹å†…ï¼Œæ ¼å¼ä¸Šç¬¦åˆæè¿°ä¸€ä¸ªJavaç±»å‹ä¿¡æ¯åœ°è¦æ±‚ã€‚è¿™é˜¶æ®µçš„éªŒè¯æ—¶åŸºäºå­—èŠ‚æµè¿›è¡Œçš„ï¼Œç»è¿‡è¿™ä¸ªé˜¶æ®µçš„éªŒè¯ä¹‹åï¼Œå­—èŠ‚æµæ‰ä¼šæµå…¥å†…å­˜çš„æ–¹æ³•åŒºä¸­è¿›è¡Œå­˜å‚¨ï¼Œæ‰€ä»¥ä»¥åçš„ä¸‰ä¸ªéªŒè¯é˜¶æ®µéƒ½æ˜¯åŸºäºæ–¹æ³•åŒºå­˜å‚¨ç»“æ„è¿›è¡Œçš„ã€‚ å…ƒæ•°æ®éªŒè¯ç¬¬äºŒé˜¶æ®µæ˜¯å †å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆJavaè¯­è¨€çš„è§„èŒƒçš„è¦æ±‚ï¼Œè¿™ä¸ªé˜¶æ®µåŒ…æ‹¬ï¼š è¿™ä¸ªç±»æ˜¯å¦æœ‰çˆ¶ç±»ï¼ˆé™¤äº†java.lang.Objectï¼Œæ‰€æœ‰çš„ç±»éƒ½åº”å½“æœ‰çˆ¶ç±»ï¼‰ è¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯å¦ç»§æ‰¿äº†ä¸å…è®¸è¢«ç»§æ‰¿çš„ç±»ï¼ˆè¢«finalä¿®é¥°çš„ç±»ï¼‰ å¦‚æœè¿™ä¸ªç±»ä¸æ˜¯æŠ½è±¡ç±»ï¼Œæ˜¯å¦å®ç°äº†å…¶çˆ¶ç±»æˆ–æ¥å£ä¹‹ä¸­è¦æ±‚å®ç°çš„æ‰€æœ‰æ–¹æ³• ç±»ä¸­çš„å­—æ®µã€æ–¹æ³•æ˜¯å¦ä¸çˆ¶ç±»äº§ç”Ÿäº†çŸ›ç›¾ï¼ˆä¾‹å¦‚è¦†ç›–äº†çˆ¶ç±»çš„finalå­—æ®µï¼Œæˆ–è€…å‡ºç°ä¸ç¬¦åˆè§„åˆ™çš„æ–¹æ³•é‡è½½ï¼Œä¾‹å¦‚æ–¹æ³•å‚æ•°éƒ½ä¸€è‡´ï¼Œä½†è¿”å›å€¼ç±»å‹å´ä¸åŒç­‰ï¼‰ Â·Â·Â·Â·Â·Â· ç¬¬äºŒé˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯å¯¹ç±»çš„å…ƒæ•°æ®ä¿¡æ¯è¿›è¡Œè¯­ä¹‰æ ¡éªŒï¼Œä¿è¯ä¸å­˜åœ¨ä¸ç¬¦åˆJavaè¯­è¨€è§„èŒƒçš„å…ƒæ•°æ®ä¿¡æ¯ã€‚ å­—èŠ‚ç éªŒè¯ç¬¬ä¸‰é˜¶æ®µæ˜¯æ•´ä¸ªéªŒè¯è¿‡ç¨‹ä¸­æœ€å¤æ‚çš„ä¸€ä¸ªé˜¶æ®µï¼Œä¸»è¦å·¥ä½œæ˜¯è¿›è¡Œæ•°æ®æµå’Œæ§åˆ¶æµåˆ†æã€‚åœ¨ç¬¬äºŒé˜¶æ®µå¯¹å…ƒæ•°æ®ä¿¡æ¯ä¸­çš„æ•°æ®ç±»å‹åšå®Œæ ¡éªŒåï¼Œè¿™é˜¶æ®µå¯¹ç±»çš„æ–¹æ³•ä½“è¿›è¡Œæ ¡éªŒåˆ†æã€‚è¿™é˜¶æ®µçš„ä»»åŠ¡æ˜¯ä¿è¯è¢«æ ¡éªŒç±»çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šåšå‡ºå±å®³è™šæ‹Ÿæœºå®‰å…¨çš„è¡Œä¸ºï¼š ä¿è¯ä»»æ„æ—¶åˆ»æ“ä½œæ•°æ®æ ˆä¸æŒ‡ä»¤ä»£ç åºåˆ—éƒ½èƒ½é…åˆå·¥ä½œï¼Œä¾‹å¦‚ä¸ä¼šå‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼šåœ¨æ“ä½œæ ˆä¸­æ”¾ç½®äº†ä¸€ä¸ªintç±»å‹çš„æ•°æ®ï¼Œä½¿ç”¨æ—¶å´æŒ‰longç±»å‹æ¥åŠ è½½å¦‚æœ¬åœ°å˜é‡è¡¨ä¸­ã€‚ ä¿è¯è·³è½¬æŒ‡ä»¤ä¸ä¼šè·³è½¬åˆ°æ–¹æ³•ä½“æ„å¤–çš„å­—èŠ‚ç æŒ‡ä»¤ä¸Šã€‚ ä¿è¯æ–¹æ³•ä½“ä¸­çš„ç±»å‹è½¬æ¢æ˜¯æœ‰æ•ˆçš„ï¼Œä¾‹å¦‚å¯ä»¥æŠŠä¸€ä¸ªå­ç±»å¯¹è±¡èµ‹å€¼ç»™çˆ¶ç±»æ•°æ®ç±»å‹ï¼Œè¿™æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯æŠŠçˆ¶ç±»å¯¹è±¡èµ‹å€¼ç»™å­ç±»æ•°æ®ç±»å‹ï¼Œç”šè‡³æŠŠå¯¹è±¡èµ‹å€¼ç»™ä¸å®ƒæ¯«æ— å…³ç³»ã€å®Œå…¨ä¸ç›¸å¹²çš„æ•°æ®ç±»å‹ï¼Œåˆ™æ˜¯å±é™©å’Œä¸åˆæ³•çš„ã€‚ Â·Â·Â·Â·Â·Â· å¦‚æœä¸€ä¸ªç±»çš„æ–¹æ³•ä½“çš„å­—èŠ‚ç æ²¡æœ‰é€šè¿‡å­—èŠ‚ç éªŒè¯ï¼Œé‚£è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ï¼›ä½†å¦‚æœä¸€ä¸ªæ–¹æ³•ä½“é€šè¿‡äº†å­—èŠ‚ç éªŒè¯ï¼Œä¹Ÿä¸èƒ½è¯´æ˜å…¶ä¸€å®šå°±æ˜¯å®‰å…¨çš„ã€‚å³ä½¿å­—èŠ‚ç éªŒè¯ä¹‹ä¸­è¿›è¡Œäº†å¤§é‡çš„æ£€æŸ¥ï¼Œä¹Ÿä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚é€šä¿—ä¸€ç‚¹è®²å°±æ˜¯ï¼Œé€šè¿‡ç¨‹åºå»æ ¡éªŒç¨‹åºé€»è¾‘æ˜¯æ— æ³•åšåˆ°ç»å¯¹å‡†ç¡®çš„â€”â€”ä¸èƒ½é€šè¿‡ç¨‹åºå‡†ç¡®çš„æ£€æŸ¥å‡ºç¨‹åºæ˜¯å¦èƒ½åœ¨æœ‰é™çš„æ—¶é—´ä¹‹å†…ç»“æŸè¿è¡Œã€‚ ç¬¦å·å¼•ç”¨éªŒè¯æœ€åä¸€ä¸ªé˜¶æ®µçš„æ ¡éªŒå‘ç”Ÿåœ¨è™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬åŒ–ç›´æ¥å¼•ç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªè‡ªåŠ¨è½¬åŒ–å°†åœ¨è¿æ¥çš„ç¬¬ä¸‰ä¸ªé˜¶æ®µâ€”â€”è§£æé˜¶æ®µä¸­å‘ç”Ÿã€‚ç¬¦å·å¼•ç”¨éªŒè¯å¯ä»¥çœ‹ä½œæ˜¯å¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆå¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§çš„æ ¡éªŒï¼š ç¬¦å·å¼•ç”¨ä¸­é€šè¿‡ç¬¦å·ä¸²æè¿°çš„å…¨é™å®šåæ˜¯å¦èƒ½æ‰¾åˆ°å¯¹è±¡çš„ç±»ã€‚ åœ¨æŒ‡å®šç±»ä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆæ–¹æ³•çš„å­—æ®µæè¿°ç¬¦åŠç®€å•åç§°æ‰€æè¿°çš„æ–¹æ³•å’Œå­—æ®µã€‚ ç¬¦å·å¼•ç”¨ä¸­çš„ç±»ã€å­—æ®µå’Œæ–¹æ³•çš„è®¿é—®è¡Œï¼ˆprivateã€protectedã€publicã€defaultï¼‰æ˜¯å¦å¯è¢«å½“å‰ç±»è®¿é—®ã€‚ Â·Â·Â·Â·Â·Â· ç¬¦å·å¼•ç”¨éªŒè¯çš„ç›®çš„æ˜¯ç¡®ä¿è§£æåŠ¨ä½œèƒ½æ­£å¸¸æ‰§è¡Œã€‚ éªŒè¯é˜¶æ®µå¯¹äºè™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ã€ä½†ä¸ä¸€å®šæ—¶å¿…è¦çš„é˜¶æ®µã€‚å¦‚æœæ‰€è¿è¡Œçš„å…¨éƒ¨ä»£ç ï¼ˆåŒ…æ‹¬è‡ªå·±å†™çš„ã€ç¬¬ä¸‰æ–¹åŒ…ä¸­çš„ä»£ç ï¼‰éƒ½å·²ç»è¢«åå¤ä½¿ç”¨å’ŒéªŒè¯è¿‡ï¼Œåœ¨å®æ–½é˜¶æ®µå°±å£å¯ä»¥è€ƒè™‘ä½¿ç”¨-Xverify:noneå‚æ•°æ¥å…³é—­å¤§éƒ¨åˆ†çš„ç±»éªŒè¯æªæ–½ï¼Œä»¥ç¼©çŸ­è™šæ‹Ÿæœºç±»åŠ è½½çš„æ—¶é—´ã€‚ å‡†å¤‡å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µï¼Œè¿™äº›å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…ã€‚è¿™ä¸ªé˜¶æ®µä¸­æœ‰ä¸¤ä¸ªå®¹æ˜“äº§ç”Ÿæ··æ·†çš„æ¦‚å¿µéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œé¦–å…ˆæ˜¯è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆè¢«staticä¿®é¥°çš„å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚å…¶æ¬¡æ—¶è¿™é‡Œæ‰€è¯´çš„åˆå§‹å€¼â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ—¶æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œå‡è®¾ä¸€ä¸ªç±»å˜é‡å®šä¹‰ä¸ºï¼š public static int value = 123; é‚£ä¹ˆå˜é‡valueåœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼æ˜¯0è€Œä¸æ˜¯123ï¼Œå› ä¸ºè¿™æ—¶å€™å°šæœªå¼€å§‹æ‰§è¡Œä»»ä½•Javaæ–¹æ³•ï¼Œè€ŒæŠŠvalueèµ‹å€¼ä¸º123çš„putstaticæŒ‡ä»¤æ˜¯ç¨‹åºè¢«ç¼–è¯‘åï¼Œå­˜æ”¾äºç±»ç»“æ„å™¨()æ–¹æ³•ä¹‹ä¸­ï¼Œæ‰€ä»¥valueèµ‹å€¼ä¸º123çš„åŠ¨ä½œå°†åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«æ‰§è¡Œã€‚ â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ—¶æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œé‚£ç›¸å¯¹çš„ä¼šæœ‰ä¸€äº›â€œç‰¹æ®Šæƒ…å†µâ€ï¼šå¦‚æœç±»å­—æ®µçš„å­—æ®µå±æ€§è¡¨ä¸­å­˜åœ¨ConstantValueå±æ€§ï¼Œé‚£åœ¨å‡†å¤‡é˜¶æ®µå˜é‡valueå°±ä¼šè¢«åˆå§‹åŒ–ä¸ºConstantValueå±æ€§æ‰€æŒ‡çš„å€¼ï¼Œå¦‚ï¼š public static final int value = 123; ç¼–è¯‘æ—¶å°†ä¼šä¸ºvalueç”ŸæˆConstantValueså±æ€§ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ®ConstantValueçš„è®¾ç½®å°†valueèµ‹å€¼ä¸º123ã€‚ è§£æè§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚è§£æé˜¶æ®µä¸­æ‰€è¯´çš„ç›´æ¥å¼•ç”¨ä¸ç¬¦å·å¼•ç”¨æœ‰ä»€ä¹ˆå…³è”å‘¢ï¼Ÿ ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰ï¼šç¬¦å·å¼•ç”¨ä»¥ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚å¯Œè±ªå¼•ç”¨ä¸è™šæ‹Ÿæœºå®ç°åœ°å†…å­˜å¸ƒå±€æ— å…³ï¼Œå¼•ç”¨åœ°ç›®æ ‡å¹¶ä¸ä¸€å®šå·²ç»åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ ç›´æ¥å¼•ç”¨ï¼ˆDirect Referenceï¼‰ï¼šç›´æ¥å¼•ç”¨å¯ä»¥æ—¶ç›´æ¥æŒ‡å‘ç›®æ ‡åœ°æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–æ˜¯ä¸€ä¸ªèƒ½é—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ç›´æ¥å¼•ç”¨æ˜¯ä¸è™šæ‹Ÿæœºå®ç°çš„å†…å­˜å¸ƒå±€ç›¸å…³çš„ï¼ŒåŒä¸€ä¸ªç¬¦å·å¼•ç”¨åœ¨ä¸åŒè™šæ‹Ÿæœºå®ä¾‹ä¸Šç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¸€èˆ¬ä¸ä¼šç›¸åŒã€‚å¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£å¼•ç”¨çš„ç›®æ ‡å¿…å®šå·²ç»åœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚ è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•å››ç±»ç¬¦å·å¼•ç”¨è¿›è¡Œï¼Œåˆ†åˆ«å¯¹åº”äºå¸¸é‡æ± ä¸­çš„CONSTANT_Class_infoã€CONSTANT_Fieldref_infoã€CONSTANT_Methodref_infoåŠCONSTANT_InterfaceMethodref_infoå››ç§å¸¸é‡ç±»å‹ã€‚ ç±»æˆ–æ¥å£çš„è§£æè¦æŠŠä¸€ä¸ªç±»æˆ–è€…æ¥å£çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ï¼Œéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š å¦‚æœè¯¥ç¬¦å·å¼•ç”¨ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†ä¼šæŠŠè¯¥ç¬¦å·ä»£è¡¨çš„å…¨é™å®šåç§°ä¼ é€’ç»™ç±»åŠ è½½å™¨å»åŠ è½½è¿™ä¸ªç±»ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±äºæ¶‰åŠéªŒè¯è¿‡ç¨‹æ‰€ä»¥å¯èƒ½ä¼šè§¦å‘å…¶ä»–ç›¸å…³ç±»çš„åŠ è½½ å¦‚æœè¯¥ç¬¦å·å¼•ç”¨æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œå¹¶ä¸”è¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯å¯¹è±¡ã€‚æˆ‘ä»¬çŸ¥é“ç¬¦å·å¼•ç”¨æ˜¯å­˜åœ¨æ–¹æ³•åŒºçš„å¸¸é‡æ± ä¸­çš„ï¼Œè¯¥ç¬¦å·å¼•ç”¨çš„æè¿°ç¬¦ä¼šç±»ä¼¼â€[java/lang/Integerâ€çš„å½¢å¼ï¼Œå°†ä¼šæŒ‰ç…§ä¸Šé¢çš„è§„åˆ™è¿›è¡ŒåŠ è½½æ•°ç»„å…ƒç´ ç±»å‹ï¼Œå¦‚æœæè¿°ç¬¦å¦‚å‰é¢å‡è®¾çš„å½¢å¼ï¼Œéœ€è¦åŠ è½½çš„å…ƒç´ ç±»å‹å°±æ˜¯java.lang.Integer ,æ¥ç€ç”±è™šæ‹Ÿæœºå°†ä¼šç”Ÿæˆä¸€ä¸ªä»£è¡¨æ­¤æ•°ç»„å¯¹è±¡çš„ç›´æ¥å¼•ç”¨ å¦‚æœä¸Šé¢çš„æ­¥éª¤éƒ½æ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥ç¬¦å·å¼•ç”¨å·²ç»åœ¨è™šæ‹Ÿæœºä¸­äº§ç”Ÿäº†ä¸€ä¸ªç›´æ¥å¼•ç”¨ï¼Œä½†æ˜¯åœ¨è§£æå®Œæˆä¹‹å‰éœ€è¦å¯¹ç¬¦å·å¼•ç”¨è¿›è¡ŒéªŒè¯ï¼Œä¸»è¦æ˜¯ç¡®è®¤å½“å‰è°ƒç”¨è¿™ä¸ªç¬¦å·å¼•ç”¨çš„ç±»æ˜¯å¦å…·æœ‰è®¿é—®æƒé™ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™å°†æŠ›å‡ºjava.lang.IllegalAccesså¼‚å¸¸ å­—æ®µè§£æå¯¹å­—æ®µçš„è§£æéœ€è¦é¦–å…ˆå¯¹å…¶æ‰€å±çš„ç±»è¿›è¡Œè§£æï¼Œå› ä¸ºå­—æ®µæ˜¯å±äºç±»çš„ï¼Œåªæœ‰åœ¨æ­£ç¡®è§£æå¾—åˆ°å…¶ç±»çš„æ­£ç¡®çš„ç›´æ¥å¼•ç”¨æ‰èƒ½ç»§ç»­å¯¹å­—æ®µçš„è§£æã€‚å¯¹å­—æ®µçš„è§£æä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š å¦‚æœè¯¥å­—æ®µç¬¦å·å¼•ç”¨å°±åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ä¸ç›®æ ‡ç›¸åŒ¹é…çš„å­—æ®µï¼Œåˆ™è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ å¦åˆ™ï¼Œå¦‚æœåœ¨è¯¥ç¬¦å·çš„ç±»å®ç°äº†æ¥å£ï¼Œå°†ä¼šæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šé€’å½’æœç´¢å„ä¸ªæ¥å£å’Œå®ƒçš„çˆ¶æ¥å£ï¼Œå¦‚æœåœ¨æ¥å£ä¸­åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ä¸ç›®æ ‡ç›¸åŒ¹é…çš„å­—æ®µï¼Œé‚£ä¹ˆä¹…ç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ å¦åˆ™ï¼Œå¦‚æœè¯¥ç¬¦å·æ‰€åœ¨çš„ç±»ä¸æ˜¯Objectç±»çš„è¯ï¼Œå°†ä¼šæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šé€’å½’æœç´¢å…¶çˆ¶ç±»ï¼Œå¦‚æœåœ¨çˆ¶ç±»ä¸­åŒ…å«äº†ç®€å•åç§°å’Œå­—æ®µæè¿°ç¬¦éƒ½ç›¸åŒ¹é…çš„å­—æ®µï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œè§£æç»“æŸ å¦åˆ™ï¼Œè§£æå¤±è´¥ï¼ŒæŠ›å‡ºjava.lang.NoSuchFieldErrorå¼‚å¸¸ å¦‚æœæœ€ç»ˆè¿”å›äº†è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼Œå°±è¿›è¡Œæƒé™éªŒè¯ï¼Œå¦‚æœå‘ç°ä¸å…·å¤‡å¯¹å­—æ®µçš„è®¿é—®æƒé™ï¼Œå°†æŠ›å‡ºjava.lang.IllegalAccessErrorå¼‚å¸¸ ç±»æ–¹æ³•è§£æè¿›è¡Œç±»æ–¹æ³•çš„è§£æä»ç„¶éœ€è¦å…ˆè§£ææ­¤ç±»æ–¹æ³•çš„ç±»ï¼Œåœ¨æ­£ç¡®è§£æä¹‹åéœ€è¦è¿›è¡Œå¦‚ä¸‹çš„æ­¥éª¤ï¼š ç±»æ–¹æ³•å’Œæ¥å£æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ˜¯åˆ†å¼€çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨ç±»æ–¹æ³•è¡¨ä¸­å‘ç°class_indexï¼ˆç±»ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ï¼‰çš„ç´¢å¼•æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºjava.lang.IncompatibleClassChangeErrorçš„å¼‚å¸¸ å¦‚æœclass_indexçš„ç´¢å¼•ç¡®å®æ˜¯ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯å°±è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾ç»“æŸ å¦åˆ™ï¼Œåœ¨è¯¥ç±»çš„çˆ¶ç±»ä¸­é€’å½’æŸ¥æ‰¾æ˜¯å¦å…·æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªå­—æ®µçš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾ç»“æŸ å¦åˆ™ï¼Œåœ¨è¿™ä¸ªç±»çš„æ¥å£ä»¥åŠå®ƒçš„çˆ¶æ¥å£ä¸­é€’å½’æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯å°±è¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒæŸ¥æ‰¾ç»“æŸï¼Œè¿”å›java.lang.AbstractMethodErrorå¼‚å¸¸ å¦åˆ™ï¼ŒæŸ¥æ‰¾å¤±è´¥ï¼ŒæŠ›å‡ºjava.lang.NoSuchMethodErrorå¼‚å¸¸ å¦‚æœæœ€ç»ˆè¿”å›äº†ç›´æ¥å¼•ç”¨ï¼Œè¿˜éœ€è¦å¯¹è¯¥ç¬¦å·å¼•ç”¨è¿›è¡Œæƒé™éªŒè¯ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™ï¼Œå°±æŠ›å‡ºjava.lang.IllegalAccessErrorå¼‚å¸¸ã€‚ æ¥å£æ–¹æ³•è§£æåŒç±»æ–¹æ³•è§£æä¸€æ ·ï¼Œä¹Ÿéœ€è¦å…ˆè§£æå‡ºè¯¥æ–¹æ³•çš„ç±»æˆ–è€…æ¥å£çš„ç¬¦å·å¼•ç”¨ï¼Œå¦‚æœè§£ææˆåŠŸï¼Œå°±è¿›è¡Œä¸‹é¢çš„è§£æå·¥ä½œï¼š å¦‚æœåœ¨æ¥å£æ–¹æ³•è¡¨ä¸­å‘ç°class_indexçš„ç´¢å¼•æ˜¯ä¸€ä¸ªç±»è€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆä¹Ÿä¼šæŠ›å‡ºjava.lang.IncompatibleClassChangeErrorçš„å¼‚å¸¸ å¦åˆ™ï¼Œåœ¨è¯¥æ¥å£æ–¹æ³•çš„æ‰€å±çš„æ¥å£ä¸­æŸ¥æ‰¾æ˜¯å¦å…·æœ‰ç®€å•åç§°å’Œæè¿°ç¬¦éƒ½ä¸ç›®æ ‡å­—æ®µç›¸åŒ¹é…çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚ å¦åˆ™ï¼Œåœ¨è¯¥æ¥å£ä»¥åŠå…¶çˆ¶æ¥å£ä¸­æŸ¥æ‰¾ï¼Œç›´åˆ°Objectç±»ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ å¦åˆ™ï¼ŒæŸ¥æ‰¾å¤±è´¥ æ¥å£çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯publicï¼Œæ‰€ä»¥ä¸å­˜åœ¨è®¿é—®æƒé™é—®é¢˜ åˆå§‹åŒ–åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„javaç¨‹åºä»£ç ã€‚ åˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨()æ–¹æ³•çš„è¿‡ç¨‹ã€‚åœ¨ä»¥ä¸‹å››ç§æƒ…å†µä¸‹åˆå§‹åŒ–è¿‡ç¨‹ä¼šè¢«è§¦å‘æ‰§è¡Œï¼š é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤çš„æœ€å¸¸è§çš„javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µ(è¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–)çš„æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚ ä½¿ç”¨java.lang.reflectåŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ã€åˆ™éœ€è¦å…ˆå‡ºå‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ– jvmå¯åŠ¨æ—¶ï¼Œç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ‰§è¡Œçš„ä¸»ç±»(åŒ…å«mainæ–¹æ³•çš„é‚£ä¸ªç±»)ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªç±» åœ¨å‡†å¤‡é˜¶æ®µï¼Œå˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼ï¼ŒäºŒåœ¨åˆå§‹é˜¶æ®µï¼Œåˆ™æ˜¯æ ¹æ®ç¨‹åºå‘˜é€šè¿‡ç¨‹åºåˆ¶å®šçš„ä¸»è§‚è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶ä»–èµ„æºã€‚ ç±»åŠ è½½å™¨ è™šæ‹Ÿæœºè®¾è®¡å›¢é˜ŸæŠŠç±»åŠ è½½é˜¶æ®µä¸­çš„â€œé€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµâ€è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°Javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—è¢«ç§°ä¸ºâ€œç±»åŠ è½½å™¨â€ã€‚ ç±»åŠ è½½å™¨å¯ä»¥è¯´æ˜¯Javaè¯­è¨€çš„ä¸€é¡¹åˆ›æ–°ï¼Œä¹Ÿæ˜¯Javaè¯­è¨€æµè¡Œçš„é‡è¦åŸå› ä¹‹ä¸€ã€‚ ç±»ä¸ç±»åŠ è½½å™¨ç±»åŠ è½½å™¨è™½ç„¶åªç”¨äºå®ç°ç±»çš„åŠ è½½åŠ¨ä½œï¼Œä½†å®ƒåœ¨Javaç¨‹åºä¸­èµ·åˆ°çš„ä½œç”¨å´è¿œè¿œä¸é™äºç±»åŠ è½½é˜¶æ®µã€‚å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®å®šå…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ã€‚é€šä¿—ä¸€ç‚¹ï¼šæ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦â€œç›¸ç­‰â€ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¹‹ä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå¦åˆ™ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œåªè¦è®°è½½ä»–ä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ã€‚ åŒäº²å§”æ´¾æ¨¡å‹ç«™åœ¨Javaè™šæ‹Ÿæœºçš„è§’åº¦çœ‹ï¼Œåªå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼šä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼›å¦å¤–ä¸€ç§å°±æ˜¯æ‰€æœ‰å…¶ä»–çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±»java.lang.ClassLoaderã€‚ ç»å¤§éƒ¨åˆ†Javaç¨‹åºéƒ½ä¼šä½¿ç”¨åˆ°ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ï¼š å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šè´Ÿè´£å°†å­˜æ”¾åœ¨binç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«-Xbootclasspathå‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨ã€‚ æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½lib\\extç›®å½•ä¸­ï¼Œæˆ–è€…è¢«java.ext.dirsç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚ åº”ç”¨ç¨‹åºåŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ï¼šç”±äºè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ClassLoaderä¸­çš„getSystemClassLoader()æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚è´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±è¿™ä¸‰ç§ç±»åŠ è½½å™¨äº’ç›¸é…åˆè¿›è¡ŒåŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥åŠ å…¥è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚è¿™äº›ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ä¸€èˆ¬å¦‚å›¾æ‰€ç¤ºï¼š åŒäº²å§”æ´¾æ¨¡å‹é™¤äº†è¦æ±‚é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸ä¼šä»¥ç»§æ‰¿çš„å…³ç³»å®ç°ï¼Œè€Œæ˜¯éƒ½ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶ç±»åŠ è½½å™¨çš„ä»£ç ã€‚ åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡æ˜¯ï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“é™„åŠ åœ¨ä¸ƒåé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚ ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ¥ç»„ç»‡ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ï¼Œå¥½å¤„å°±æ˜¯Javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚åŒäº²å§”æ´¾æ¨¡å‹å¯¹äºä¿è¯Javaç¨‹åºçš„ç¨³å®šè¿è¡Œå¾ˆé‡è¦ï¼Œä½†å®ƒçš„å®ç°å´éå¸¸ç®€å•ï¼Œå®ç°åŒäº²å§”æ´¾çš„ä»£ç éƒ½é›†ä¸­åœ¨java.lang.ClassLoaderçš„loadClass()æ–¹æ³•ä¹‹ä¸­ã€‚å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡ï¼Œè‹¥æ²¡æœ‰åŠ è½½åˆ™è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼Œè‹¥çˆ¶ç±»åŠ è½½å™¨ä¸ºç©ºåˆ™é»˜è®¤ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ä½œä¸ºçˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œåˆ™åœ¨æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸åï¼Œå†è°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚ ç ´ååŒäº²å§”æ´¾æ¨¡å‹ç¬¬ä¸€æ¬¡ç ´åç”±äºåŒäº²å§”æ´¾æ¨¡å‹æ˜¯åœ¨JDK1.2ä¹‹åæ‰è¢«å¼•å…¥çš„ï¼Œè€Œç±»åŠ è½½å™¨å’ŒæŠ½è±¡ç±»java.lang.ClassLoaderåˆ™åœ¨JDK1.0æ—¶ä»£å°±å·²ç»å­˜åœ¨ï¼Œé¢å¯¹å·²ç»å­˜åœ¨çš„ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°ä»£ç ï¼ŒJavaè®¾è®¡è€…å¼•å…¥åŒäº²å§”æ´¾æ¨¡å‹æ—¶ä¸å¾—ä¸åšå‡ºä¸€äº›å¦¥åã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç”¨æˆ·å»ç»§æ‰¿java.lang.ClassLoaderçš„å”¯ä¸€ç›®çš„å°±æ˜¯ä¸ºäº†é‡å†™loadClass()æ–¹æ³•ï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ä¼šè°ƒç”¨åŠ è½½å™¨çš„ç§æœ‰æ–¹æ³•loadClassInternal()ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å”¯ä¸€é€»è¾‘å°±æ˜¯å»è°ƒç”¨è‡ªå·±çš„loadClass()ã€‚ ç¬¬äºŒæ¬¡ç ´ååŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·æ‰€å¯¼è‡´çš„ï¼ŒåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨çš„åŸºç¡€ç±»çš„åŒä¸€é—®é¢˜ï¼ˆè¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼‰ï¼ŒåŸºç¡€ç±»ä¹‹æ‰€ä»¥ç§°ä¸ºâ€œåŸºç¡€â€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ€»æ˜¯ä½œä¸ºè¢«ç”¨æˆ·ä»£ç è°ƒç”¨çš„APIï¼Œä½†ä¸–äº‹å¾€å¾€æ²¡æœ‰ç»å¯¹çš„å®Œç¾ã€‚ å¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥ä¹ˆåŠï¼Ÿä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯JNDIæœåŠ¡ï¼ŒJNDIç°åœ¨å·²ç»æ˜¯Javaçš„æ ‡å‡†æœåŠ¡ï¼Œ å®ƒçš„ä»£ç ç”±å¯åŠ¨ç±»åŠ è½½å™¨å»åŠ è½½ï¼ˆåœ¨JDK1.3æ—¶æ”¾è¿›å»çš„rt.jarï¼‰ï¼Œä½†JNDIçš„ç›®çš„å°±æ˜¯å¯¹èµ„æºè¿›è¡Œé›†ä¸­ç®¡ç†å’ŒæŸ¥æ‰¾ï¼Œå®ƒéœ€è¦è°ƒç”¨ç”±ç‹¬ç«‹å‚å•†å®ç°å¹¶éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºçš„ClassPathä¸‹çš„JNDIæ¥å£æä¾›è€…çš„ä»£ç ï¼Œä½†å¯åŠ¨ç±»åŠ è½½å™¨ä¸å¯èƒ½â€œè®¤è¯†â€è¿™äº›ä»£ç ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaè®¾è®¡å›¢é˜Ÿåªå¥½å¼•å…¥äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(Thread Context ClassLoader)ã€‚è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡java.lang.Threadç±»çš„setContextClassLoader()æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œä»–å°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚ æœ‰äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼ŒJNDIæœåŠ¡å°±å¯ä»¥ä½¿ç”¨å®ƒå»åŠ è½½æ‰€éœ€è¦çš„SPIä»£ç ï¼Œä¹Ÿå°±æ˜¯çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»å®Œæˆç±»åŠ è½½çš„åŠ¨ä½œï¼Œè¿™ç§è¡Œä¸ºå®é™…ä¸Šå°±æ˜¯æ‰“é€šäº†åŒäº²å§”æ´¾æ¨¡å‹å±‚æ¬¡ç»“æ„æ¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå®é™…ä¸Šå·²ç»è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸€èˆ¬æ€§åŸåˆ™ï¼Œä½†è¿™ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ã€‚Javaä¸­æ‰€æœ‰æ¶‰åŠSPIçš„åŠ è½½åŠ¨ä½œåŸºæœ¬ä¸Šéƒ½é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚JNDIã€JDBCã€JCEã€JAXBå’ŒJBIç­‰ã€‚ ç¬¬ä¸‰æ¬¡ç ´ååŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚å¯¼è‡´çš„ï¼Œè¿™é‡Œæ‰€è¯´çš„â€œåŠ¨æ€æ€§â€æŒ‡çš„æ˜¯å½“å‰ä¸€äº›éå¸¸â€œçƒ­é—¨â€çš„åè¯ï¼šä»£ç çƒ­æ›¿æ¢ã€æ¨¡å—çƒ­éƒ¨ç½²ç­‰ï¼Œç®€ç­”çš„è¯´å°±æ˜¯æœºå™¨ä¸ç”¨é‡å¯ï¼Œåªè¦éƒ¨ç½²ä¸Šå°±èƒ½ç”¨ã€‚ OSGiå®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®åˆ™æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ã€‚æ¯ä¸€ä¸ªç¨‹åºæ¨¡å—(Bundle)éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“éœ€è¦æ›´æ¢ä¸€ä¸ªBundleæ—¶ï¼Œå°±æŠŠBundleè¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ã€‚åœ¨OSGiå¹»å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ä¸­çš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„ç½‘çŠ¶ç»“æ„ï¼Œå½“å—åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGiå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢ï¼š 1ï¼‰å°†java.ï¼Šå¼€å¤´çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚ 2ï¼‰å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚ 3ï¼‰å¦åˆ™ï¼Œå°†Importåˆ—è¡¨ä¸­çš„ç±»å§”æ´¾ç»™Exportè¿™ä¸ªç±»çš„Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 4ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰Bundleçš„ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 5ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„Fragment Bundleä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å§”æ´¾ç»™Fragment Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 6ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾Dynamic Importåˆ—è¡¨çš„Bundleï¼Œå§”æ´¾ç»™å¯¹åº”Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 7ï¼‰å¦åˆ™ï¼Œç±»åŠ è½½å™¨å¤±è´¥ã€‚ å°ç»“ä»‹ç»äº†ç±»åŠ è½½è¿‡ç¨‹çš„åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–äº”ä¸ªé˜¶æ®µä¸­è™šæ‹Ÿæœºè¿›è¡Œäº†å“ªäº›åŠ¨ä½œï¼Œè¿˜ä»‹ç»äº†ç±»åŠ è½½å™¨çš„å·¥ä½œåŸç†åŠå…¶å †è™šæ‹Ÿæœºçš„æ„ä¹‰ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ ç ´ååŒäº²å§”æ´¾æ¨¡å‹","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·","date":"2018-09-13T08:14:28.000Z","path":"2018/09/13/fea7515.html","text":"Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå». æ¦‚è¿°ç»å¸¸ä½¿ç”¨é€‚å½“çš„è™šæ‹Ÿæœºç›‘æ§å’Œåˆ†æçš„å·¥å…·å¯ä»¥åŠ å¿«æˆ‘ä»¬åˆ†ææ•°æ®å’Œå®šä½é—®é¢˜çš„é€Ÿåº¦ï¼Œä½†æˆ‘ä»¬åœ¨å­¦ä¹ å·¥å…·å‰ï¼Œä¹Ÿåº”å½“æ„è¯†åˆ°å·¥å…·æ°¸è¿œéƒ½æ˜¯çŸ¥è¯†æŠ€èƒ½çš„ä¸€å±‚åŒ…è£…ï¼Œæ²¡æœ‰ä»€ä¹ˆå·¥å…·æ˜¯â€œç§˜å¯†æ­¦å™¨â€ï¼Œå­¦ä¼šäº†å°±èƒ½åŒ…æ²»ç™¾ç—…ã€‚ JDKçš„å‘½ä»¤è¡Œå·¥å…·Javaå¼€å‘äººå‘˜è‚¯å®šéƒ½çŸ¥é“JDKçš„binç›®å½•ä¸‹æœ‰â€œjava.exeâ€å’Œâ€œjavac.exeâ€è¿™ä¸¤ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä½†å¹¶éæ‰€æœ‰ç¨‹åºå‘˜éƒ½äº†è§£è¿‡JDKçš„binç›®å½•ä¹‹ä¸­å…¶ä»–å‘½ä»¤è¡Œç¨‹åºçš„ä½œç”¨ã€‚ è¿™äº›å·¥å…·ä¸­åŒ…å«äº†ç”¨äºç›‘è§†è™šæ‹Ÿæœºå’Œå…¬ç« å¤„ç†çš„å·¥å…·ã€‚è¿™äº›å·¥å…·éƒ½éå¸¸ç¨³å®šè€Œä¸”åŠŸèƒ½å¼ºå¤§ï¼Œèƒ½åœ¨å¤„ç†åº”ç”¨ç¨‹åºåº”èƒ½é—®é¢˜ã€å®šä½æ•…éšœæ—¶å‘æŒ¥å¾ˆå¤§çš„ä½œç”¨ã€‚ JDKå¼€å‘å›¢é˜Ÿé€‰æ‹©é‡‡ç”¨Javaä»£ç æ¥å®ç°è¿™äº›ç›‘æ§å·¥å…·æ—¶æœ‰ç‰¹åˆ«ç”¨æ„çš„ï¼šå½“ç”¨ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒåï¼Œæ— è®ºæ˜¯ç›´æ¥è§£é™¤ç‰©ç†æœåŠ¡å™¨è¿˜æ˜¯è¿œç¨‹Telnetåˆ°æœåŠ¡å™¨ä¸Šéƒ½å¯èƒ½ä¼šæ”¶åˆ°é™åˆ¶ã€‚å€ŸåŠ©tools.jarç±»åº“é‡Œé¢çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°å¼ºå¤§çš„ç›‘æ§åˆ†æåŠŸèƒ½ã€‚ jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·JDKçš„å¾ˆå¤šå°å·¥å…·çš„åå­—éƒ½å‚è€ƒäº†Unixå‘½ä»¤çš„å‘½åæ–¹å¼ï¼Œjpsï¼ˆJVM Process Status Toolï¼‰æ˜¯å…¶ä¸­çš„å…¸å‹ã€‚å¯ä»¥åˆ—å‡ºçœŸè¯¥è¿è¡Œçš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºè™šæ‹Ÿæœºæ‰§è¡Œä¸»ç±»ï¼ˆMain Classï¼Œmain() å‡½æ•°æ‰€åœ¨çš„ç±»ï¼‰çš„åç§°ï¼Œä»¥åŠè¿™äº›è¿›ç¨‹çš„æœ¬åœ°è™šæ‹Ÿæœºçš„å”¯ä¸€IDï¼ˆLVMIDï¼ŒLocal Virtual Machine Identifierï¼‰ã€‚å¯¹äºæœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹æ¥è¯´ï¼ŒLVMIDä¸æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹IDï¼ˆPIDï¼ŒProcess Identifierï¼‰æ˜¯ä¸€è‡´çš„ï¼Œä½¿ç”¨Windowsçš„ä»»åŠ¡ç®¡ç†å™¨æˆ–Unixçš„pså‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥è¯¢åˆ°è™šæ‹Ÿæœºè¿›ç¨‹çš„LVMIDï¼Œä½†å¦‚æœåŒæ—¶å¯åŠ¨äº†å¤šä¸ªè™šæ‹Ÿæœºè¿›ç¨‹ï¼Œæ— æ³•æ ¹æ®è¿›ç¨‹åç§°å®šä¸ºæ—¶ï¼Œé‚£å°±åªèƒ½ä»¥æ¥jpså‘½ä»¤æ˜¾ç¤ºä¸»ç±»çš„åŠŸèƒ½æ‰èƒ½åŒºåˆ†äº†ã€‚ jpså‘½ä»¤æ ¼å¼ï¼š jps [ options ] [ hostid ] æ ·ä¾‹ï¼š jps -l jpså¯ä»¥é€šè¿‡RMIåè®®æŸ¥è¯¢å¼€å¯äº†RMIæœåŠ¡å™¨çš„è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹çŠ¶æ€ï¼Œhostidä¸ºRMIæ³¨å†Œè¡¨ä¸­æ³¨å†Œçš„ä¸»æœºåã€‚ jpså·¥å…·ä¸»è¦é€‰é¡¹ é€‰é¡¹ ä½œç”¨ -q åªè¾“å‡ºLVMIDï¼Œçœç•¥ä¸»ç±»çš„åç§° -m è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶ä¼ é€’ç»™ä¸»ç±»main()å‡½æ•°çš„å‚æ•° -l è¾“å‡ºä¸»ç±»çš„å…¨åï¼Œå¦‚æœè¿›ç¨‹æ‰§è¡Œçš„æ˜¯JaråŒ…ï¼Œè¾“å‡ºJarè·¯å¾„ -v è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶JVMå‚æ•° â€“ jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·jstatï¼ˆJVM Statistics Monitoring Toolï¼‰æ˜¯ç”¨äºç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»åŠ è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ï¼Œåœ¨æ²¡æœ‰GUIå›¾å½¢ç•Œé¢ï¼Œåªæä¾›äº†çº¯æ–‡æœ¬æ§åˆ¶å°ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒå°†æ˜¯è¿è¡ŒæœŸå®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜çš„é¦–é€‰å·¥å…·ã€‚ jstatå‘½ä»¤æ ¼å¼ï¼š jstat [ option vmid [ interval[s|ms] [ count ] ] ] å‚æ•°intervalå’Œcountä»£è¡¨æŸ¥è¯¢é—´éš”å’Œæ¬¡æ•°ï¼Œå¦‚æœçœç•¥è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè¯´æ˜åªæŸ¥è¯¢ä¸€æ¬¡ã€‚å‡è®¾éœ€è¦æ¯250æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›ç¨‹2764åƒåœ¾æ”¶é›†çš„çŠ¶å†µï¼Œä¸€å…±æŸ¥è¯¢20æ­¤ï¼Œé‚£å‘½ä»¤åº”å½“æ˜¯ï¼š jstat -gc 2764 250 20 é€‰é¡¹optionä»£è¡¨ç€ç”¨æˆ·å¸Œæœ›æŸ¥è¯¢çš„è™šæ‹Ÿæœºä¿¡æ¯ï¼Œä¸»è¦åˆ†3ç±»ï¼šç±»è£…è½½ã€åƒåœ¾æ”¶é›†å’Œè¿è¡ŒæœŸç¼–è¯‘çŠ¶å†µï¼Œå…·ä½“é€‰é¡¹åŠä½œç”¨å‚è€ƒä¸‹è¡¨ï¼š é€‰é¡¹ ä½œç”¨ -class ç›‘è§†ç±»è£…è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´åŠç±»è£…è½½æ‰€è€—è´¹çš„æ—¶é—´ -gc ç›‘è§†Javaå †çŠ¶å†µï¼ŒåŒ…æ‹¬EdenåŒºã€2ä¸ªSurvivoråŒºã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ç­‰çš„å®¹é‡ã€å·²ç”¨ç©ºé—´ã€GCæ—¶é—´åˆè®¡ç­‰ä¿¡æ¯ -gccapacity ç›‘è§†å†…å®¹ä¸-gcåŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨Javaå †å„ä¸ªåŒºåŸŸä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcutil ç›‘è§†å†…å®¹ä¸-gcåŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨å·²ä½¿ç”¨ç©ºé—´å æ€»ç©ºé—´çš„ç™¾åˆ†æ¯” -gccause ä¸-gcutilçš„åŠŸèƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé¢å¤–è¾“å‡ºå¯¼è‡´ä¸Šä¸€æ¬¡GCäº§ç”Ÿçš„åŸå›  -gcnew ç›‘è§†æ–°ç”Ÿä»£GCçš„çŠ¶å†µ -gcnewcapacity ç›‘è§†å†…å®¹ä¸-gcnewåŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcold ç›‘è§†è€å¹´ä»£GCçš„çŠ¶å†µ -gcoldcapacity ç›‘è§†å†…å®¹ä¸-gcoldåŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcpermcapacity è¾“å‡ºæ°¸ä¹…ä»£ä½¿ç”¨çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -compiler è¾“å‡ºJITç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯ -printcompilation è¾“å‡ºå·²ç»è¢«JITç¼–è¯‘çš„æ–¹æ³• â€“ jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·jinfoï¼ˆConfiguration Info for Javaï¼‰çš„ä½œç”¨æ˜¯å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºçš„å„é¡¹å‚æ•°ã€‚ æ ¼å¼ï¼š jinfo [ option ] pid æ ·ä¾‹ï¼šæŸ¥è¯¢CMSInitiatingOccupancyFractionå‚æ•°å€¼ã€‚ jinfo -flag CMSInitiatingOccupancyFraction 1444 jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·jmapï¼ˆMemory Map for Javaï¼‰å‘½ä»¤ç”¨äºç”Ÿæˆå †è½¬å‚¨å¿«ç…§ï¼ˆä¸€èˆ¬ç§°ä¸ºheapdumpæˆ–dumpæ–‡ä»¶ï¼‰ã€‚jmapçš„ä½œç”¨å¹¶ä¸ä»…ä»…æ˜¯ä¸ºäº†è·å–dumpæ–‡ä»¶ï¼Œå®ƒè¿˜å¯ä»¥æŸ¥è¯¢finalizeæ‰§è¡Œé˜Ÿåˆ—ï¼ŒJavaå †å’Œæ°¸ä¹…ä»£çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ç©ºé—´ä½¿ç”¨ç‡ã€å½“å‰ç”¨çš„æ˜¯å“ªç§æ”¶é›†å™¨ç­‰ã€‚ æ ¼å¼ï¼š jmap [ option ] vmid å‚æ•°è¡¨ï¼š é€‰é¡¹ ä½œç”¨ -dump ç”ŸæˆJavaå †è½¬å‚¨å¿«ç…§ï¼Œæ ¼å¼ï¼š-dump:[live,]format=b,file=filename,å…¶ä¸­liveå­å‚æ•°è¯´æ˜æ˜¯å¦åªdumpå‡ºå­˜æ´»çš„å¯¹è±¡ -finalizerinfo æ˜¾ç¤ºåœ¨F-Queueä¸­ç­‰å¾…Finalizerçº¿ç¨‹æ‰§è¡Œfinalizeæ–¹æ³•çš„å¯¹è±¡ã€‚åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ -heap æ˜¾ç¤ºJavaå †è¯¦ç»†ä¿¡æ¯ï¼Œ å¦‚ä½¿ç”¨é‚£ç§å›æ”¶å™¨ã€å‚æ•°é…ç½®åˆ†ä»£çŠ¶å†µç­‰ã€‚åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ -histo æ˜¾ç¤ºå †ä¸­å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»ã€å®ä¾‹æ•°é‡å’Œåˆè®¡å®¹é‡ -permstat ä»¥ClassLoaderä¸ºç»Ÿè®¡å£å¾„æ˜¾ç¤ºæ°¸ä¹…ä»£çš„å†…å­˜çŠ¶æ€ã€‚åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ -F å½“è™šæ‹Ÿæœºè¿›ç¨‹å †-dumpé€‰é¡¹æ²¡æœ‰å“åº”æ—¶ï¼Œå¯ä½¿ç”¨è¿™ä¸ªé€‰é¡¹å¼ºåˆ¶ç”Ÿæˆdumpå¿«ç…§ã€‚åªåœ¨Liux/Solariså¹³å°æœ‰æ•ˆ â€“ jhatï¼šè™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·ä¸jmapæ­é…ä½¿ç”¨ï¼Œæ¥åˆ†æjmapç”Ÿæˆçš„å †è½¬å‚¨å¿«ç…§ã€‚ jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·jstackï¼ˆStack Trace for Javaï¼‰å‘½ä»¤ç”¨äºç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»å¿«ç…§ã€‚çº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆï¼Œç”Ÿæˆçº¿ç¨‹å¿«ç…§çš„ä¸»è¦ç›®çš„æ˜¯å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œå¦‚çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´ç­‰å¾…éƒ½æ˜¯å¯¼è‡´çº¿ç¨‹é•¿æ—¶é—´åœé¡¿çš„å¸¸è§åŸå› ã€‚ æ ¼å¼ï¼š jstack [ option ] vmid å‚æ•°è¡¨ï¼š é€‰é¡¹ ä½œç”¨ -F å½“æ­£å¸¸è¾“å‡ºè¯·æ±‚ä¸è¢«å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆ -l é™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºé”çš„é™„åŠ ä¿¡æ¯ -m å¦‚æœè°ƒç”¨åˆ°æœ¬åœ°æ–¹æ³•çš„è¯ï¼Œå¯ä»¥æ˜¾ç¤ºC/C++çš„å †æ ˆ â€“ JDKçš„å¯è§†åŒ–å·¥å…·JDKä¸­é™¤äº†æä¾›å¤§é‡çš„å‘½ä»¤è¡Œå·¥å…·å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–å·¥å…·ï¼šJConsoleå’ŒVisualVMï¼Œè¿™ä¸¤ä¸ªå·¥å…·æ—¶JDKçš„æ­£å¼æˆå‘˜ã€‚ JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°JConsoleæ˜¯ä¸€æ¬¾åŸºäºJMXçš„å¯è§†åŒ–ç›‘è§†ç®¡ç†çš„å·¥å…·ã€‚å®ƒç®¡ç†éƒ¨åˆ†çš„åŠŸèƒ½æ—¶é’ˆå¯¹JMX MBeanè¿›è¡Œç®¡ç†ï¼ŒMBeanå¯ä»¥ä½¿ç”¨ä»£ç ã€ä¸­é—´ä»¶æœåŠ¡å™¨çš„ç®¡ç†æ§åˆ¶å°æˆ–è€…æ‰€æœ‰ç¬¦åˆJMXè§„èŒƒçš„è½¯ä»¶è¿›è¡Œè®¿é—®ã€‚ å‚è€ƒæ–‡çŒ®ï¼š å®˜æ–¹æ–‡æ¡£ å¦‚ä½•åˆ©ç”¨ JConsoleè§‚å¯Ÿåˆ†æJavaç¨‹åºçš„è¿è¡Œï¼Œè¿›è¡Œæ’é”™è°ƒä¼˜ JVMæ£€æµ‹åˆ†æJConsole VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·VisualVMæ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒéšJDKå‘å¸ƒçš„åŠŸèƒ½æœ€å¼ºå¤§çš„è¿è¡Œç›‘è§†å’Œæ•…éšœå¤„ç†ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥é¢„è§åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…éƒ½æ˜¯å®˜æ–¹ä¸»åŠ›å‘å±•çš„è™šæ‹Ÿæœºæ•…éšœå¤„ç†å·¥å…·ã€‚ å‚è€ƒæ–‡çŒ®ï¼š https://visualvm.github.io/ ä½¿ç”¨ VisualVM è¿›è¡Œæ€§èƒ½åˆ†æåŠè°ƒä¼˜ å­¦ä¹ Java VisualVMçš„ä½¿ç”¨ å°ç»“ä»‹ç»äº†éšJDKå‘å¸ƒçš„6ä¸ªå‘½ä»¤è¡Œå·¥å…·å’Œ2ä¸ªå¯è§†åŒ–çš„æ•…éšœå¤„ç†å·¥å…·ï¼Œçµæ´»ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¯ä»¥ç»™å¤„ç†é—®é¢˜å¸¦æ¥å¾ˆå¤§çš„ä¾¿åˆ©ã€‚ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥","date":"2018-09-11T08:34:53.000Z","path":"2018/09/11/ddb92a08.html","text":"Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå». ä¸€ã€æ¦‚è¿°åƒåœ¾æ”¶é›†éœ€è¦å®Œæˆçš„ä¸‰ä»¶äº‹æƒ…ï¼š å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ å¦‚ä½•å›æ”¶ï¼Ÿ å†…å­˜çš„åŠ¨æ€åˆ†é…å’Œå†…å­˜å›æ”¶æŠ€æœ¯å·²ç»ç›¸å½“æˆç†Ÿï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å»äº†è§£GCå’Œå†…å­˜åˆ†é…å‘¢ï¼Ÿ ç­”æ¡ˆå¾ˆç®€å•ï¼šå½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æ”¶é›†æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚ Javaè¿è¡Œæ—¶åŒºåŸŸçš„å„ä¸ªéƒ¨åˆ†ä¸­ï¼Œç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆä¸‰ä¸ªåŒºåŸŸéšçº¿ç¨‹è€Œç”Ÿï¼Œéšçº¿ç¨‹è€Œç­ï¼›æ ˆä¸­çš„æ ˆå¸§éšç€æ–¹æ³•çš„è¿›å…¥å’Œé€€å‡ºè€Œæœ‰æ¡ä¸ç´Šçš„æ‰§è¡Œç€å‡ºæ ˆå’Œå…¥æ ˆæ“ä½œã€‚æ¯ä¸ªæ ˆå¸§ä¸­åˆ†é…å¤šå°‘å†…å­˜åŸºæœ¬ä¸Šæ˜¯åœ¨ç±»ç»“æ„ç¡®å®šä¸‹æ¥æ—¶å°±æ˜¯å·²ç»çŸ¥é“çš„ï¼Œå› æ­¤è¿™å‡ ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½å…·å¤‡ç¡®å®šæ€§ï¼Œåœ¨è¿™å‡ ä¸ªåŒºåŸŸå†…ä¸éœ€è¦è¿‡å¤šè€ƒè™‘å›æ”¶é—®é¢˜ï¼Œå› ä¸ºåœ¨æ–¹æ³•ç»“æŸæˆ–çº¿ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œå†…å­˜è‡ªç„¶å°±è·Ÿç€å›æ”¶äº†ã€‚ Javaå †å’Œæ–¹æ³•åŒºåˆ™ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ¥å£ä¸­çš„å¤šä¸ªå®ç°ç±»éœ€è¦çš„å†…å­˜å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ–¹æ³•ä¸­çš„å¤šä¸ªåˆ†æ”¯éœ€è¦çš„å†…å­˜ä¹Ÿå¯èƒ½ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªæœ‰åœ¨ç¨‹åºå¤„äºè¿è¡ŒæœŸé—´æ—¶æ‰èƒ½çŸ¥é“ä¼šåˆ›å»ºå“ªäº›å¯¹è±¡ï¼Œè¿™éƒ¨åˆ†çš„åˆ†é…å’Œå›æ”¶éƒ½æ˜¯åŠ¨æ€çš„ï¼Œåƒåœ¾æ”¶é›†å™¨æ‰€å…³æ³¨çš„æ˜¯è¿™éƒ¨åˆ†å†…å­˜ã€‚ äºŒã€å¯¹è±¡å·²æ­»ï¼Ÿ å †ä¸­å‡ ä¹å­˜æ”¾è¿™Javaä¸–ç•Œä¸­æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼Œåƒåœ¾æ”¶é›†å™¨åœ¨å¯¹å †è¿›è¡Œå›æ”¶å‰ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯è¦ç¡®å®šè¿™äº›å¯¹è±¡æœ‰å“ªäº›è¿˜â€œæ´»ç€â€ï¼Œå“ªäº›å·²ç»â€œæ­»å»â€ã€‚ 1ã€å¼•ç”¨è®¡æ•°ç®—æ³•ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨æ¶ˆå¤±æ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡1ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨éƒ½ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚ Javaè¯­è¨€ä¸­æ²¡æœ‰é€‰ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•å‘çš„é—®é¢˜ã€‚ ä¾‹ï¼šå½“ä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œé™¤æ­¤ä¹‹å¤–ä¸¤ä¸ªå¯¹è±¡å†æ— ä»»ä½•å¼•ç”¨ï¼Œå®é™…ä¸Šè¿™ä¸¤ä¸ªå¯¹è±¡å·²ç»ä¸å¯èƒ½å†è¢«è®¿é—®ï¼Œä½†æ˜¯ä»–ä»¬å› ä¸ºäº’ç›¸å¼•ç”¨ç€å¯¹æ–¹ï¼Œå¯¼è‡´ä»–ä»¬çš„å¼•ç”¨è®¡æ•°éƒ½ä¸ä¸º0ï¼Œäºæ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•é€šçŸ¥GCæ”¶é›†å™¨å›æ”¶å®ƒä»¬ã€‚ 2ã€æ ¹æœç´¢ç®—æ³•åœ¨ä¸»æµçš„å•†ç”¨ç¨‹åºè¯­è¨€ä¸­ï¼ˆJavaå’ŒC#ï¼‰éƒ½ä½¿ç”¨æ ¹æœç´¢ç®—æ³•ï¼ˆGC Roots Tracingï¼‰åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—åä¸ºâ€œGC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€æœ‰èµ°è¿‡çš„è·¯å¾„æˆä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼ˆç”¨å›¾è®ºçš„è¯æ¥è¯´å°±æ˜¯ä»GC Rootsåˆ°è¿™ä¸ªå¯¹è±¡ä¸å¯è¾¾ï¼‰æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚ åœ¨Javaè¯­è¨€é‡Œï¼Œå¯ä½œä¸ºGC Rootsçš„å¯¹è±¡åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­çš„å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰çš„å¼•ç”¨çš„å¯¹è±¡ 3ã€å¼•ç”¨æ— è®ºæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯ é€šè¿‡æ ¹æœç´¢ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨é“¾æ˜¯å¦å¯è¾¾ï¼Œåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»éƒ½ä¸â€œå¼•ç”¨â€æœ‰å…³ã€‚ åœ¨JDK1.2ä¹‹å‰ï¼ŒJavaä¸­çš„å¼•ç”¨çš„å®šä¹‰å¾ˆä¼ ç»Ÿï¼šå¦‚æœreferenceç±»å‹çš„æ•°æ®ä¸­å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦å¤–ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ç€ä¸€ä¸ªå¼•ç”¨ã€‚ è¿™ç§å®šä¹‰å¾ˆå­˜ç²¹ï¼Œä½†æ˜¯å¤ªè¿‡ç‹­éš˜ï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™ç§å®šä¹‰ä¸‹åªæœ‰è¢«å¼•ç”¨æˆ–è€…æ²¡æœ‰è¢«å¼•ç”¨ä¸¤ç§çŠ¶æ€ã€‚å¸Œæœ›èƒ½æè¿°è¿™æ ·ä¸€ç±»å¯¹è±¡ï¼šå½“å†…å­˜ç©ºé—´è¿˜è¶³å¤Ÿæ—¶ï¼Œåˆ™èƒ½ä¿ç•™åœ¨å†…å­˜ä¹‹ä¸­ï¼›å¦‚æœå†…å­˜åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†åè¿˜æ˜¯éå¸¸è¿›åœºï¼Œåˆ™å¯ä»¥æŠ›å¼ƒè¿™äº›å¯¹è±¡ã€‚ Javaå †å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºï¼šå¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ã€è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ã€å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ã€è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰å››ç§ï¼Œè¿™å››ç§å¼•ç”¨çš„å¼ºåº¦ä¸€æ¬¡ç»„å»ºå‡å¼±ã€‚ å¼ºå¼•ç”¨ï¼šåœ¨ç¨‹åºä»£ç ä¹‹é—´æ™®éå­˜åœ¨çš„ï¼Œç±»ä¼¼â€œObject obj = new Object()â€è¿™ç±»çš„å¼•ç”¨ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨æ°¸è¿œä¸ä¼šå›æ”¶è°ƒè¢«å¼•ç”¨çš„å¯¹è±¡ã€‚ è½¯å¼•ç”¨ï¼šç”¨æ¥æè¿°ä¸€äº›è¿˜ç”¨ï¼Œä½†å¹¶éå¿…é¡»çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­å¹¶è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ å¼±å¼•ç”¨ï¼šç”¨æ¥æè¿°éå¿…é¡»çš„å¯¹è±¡çš„ï¼Œå®ƒçš„å¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚ xuè™šå¼•ç”¨ï¼šåˆç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯å¸Œæœ›èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶å—åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚ 4ã€ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡åœ¨è·Ÿæœç´¢ç®—æ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ—¶â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™ä¸ªæ—¶å€™ä»–ä»¬å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µï¼Œè¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š å¦‚æœå¯¹è±¡åœ¨è¿›è¡Œè·Ÿæœç´¢åå‘ç°æ²¡æœ‰ä¸GC Rootsç›¸è¿æ¥çš„å¼•ç”¨é“¾ï¼Œé‚£å®ƒå°†ä¼šè¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ—¶æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ã€‚ å½“å¯¹è±¡æ²¡æœ‰è¦†ç›–finalize()æ–¹æ³•ï¼Œæˆ–è€…finalize()æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºç”¨è¿‡ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µéƒ½è§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ã€‚ å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸ºæœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªåä¸ºF-Queueçš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€æ¡ç”±è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹å»æ‰§è¡Œã€‚ ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•éƒ½åªä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå¯¹è±¡é¢ä¸´ä¸‹ä¸€æ¬¡å›æ”¶ï¼Œå®ƒçš„finalize()æ–¹æ³•ä¸ä¼šå†æ¬¡æ‰§è¡Œ finalize()èƒ½åšçš„æ‰€æœ‰å·¥ä½œï¼Œä½¿ç”¨try-finallyæˆ–è€…å…¶ä»–æ–¹å¼éƒ½å¯ä»¥åšå¾—æ›´å¥½ã€æ›´åŠæ—¶ã€‚å®Œå…¨å¯ä»¥å¿˜æ‰Javaè¯­è¨€ä¸­è¿˜æœ‰è¿™ä¸ªæ–¹æ³•å­˜åœ¨ã€‚ 5ã€å›æ”¶æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰ Javaè™šæ‹Ÿæœºè§„èŒƒä¸­è¯´è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºå†æ–¹æ³•åŒºå®ç°åƒåœ¾æ”¶é›†ï¼Œè€Œä¸”å†æ–¹æ³•åŒºè¿›è¡Œåƒåœ¾æ”¶é›†çš„â€œæ€§ä»·æ¯”â€ä¸€èˆ¬æ¯”è¾ƒä½ï¼šå†å †ä¸­ï¼Œå°¤å…¶æ˜¯å†æ–°ç”Ÿä»£ä¸­ï¼Œå¸¸è§„åº”ç”¨è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†ä¸€èˆ¬å¯ä»¥å›æ”¶70%~95%çš„ç©ºé—´ï¼Œè€Œæ°¸ä¹…ä»£çš„åƒåœ¾æ”¶é›†æ•ˆç‡è¿œä½äºæ­¤ã€‚ æ°¸ä¹…ä»£çš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šåºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±»ã€‚ åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦æ˜¯â€œåºŸå¼ƒå¸¸é‡â€æ¯”è¾ƒç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯â€œæ— ç”¨çš„ç±»â€çš„æ¡ä»¶åˆ™ç›¸å¯¹è‹›åˆ»è®¸å¤šã€‚ç±»éœ€è¦æ»¡è¶³3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯â€œæ— ç”¨çš„ç±»ï¼šâ€ è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶ è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ è™šæ‹Ÿæœºå¯ä»¥å †æ»¡è¶³ä¸Šè¿°3ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œä¸ä½¿ç”¨äº†å°±å¿…ç„¶ä¼šè¢«å›æ”¶ã€‚ åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLibç­‰bytecodeæ¡†æ¶çš„åœºæ™¯ï¼Œä»¥åŠåŠ¨æ€ç”ŸæˆJSPå’ŒOSGiè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ClassLoaderçš„åœºæ™¯éƒ½éœ€è¦è™šæ‹Ÿæœºå…·å¤‡ç±»å¸è½½çš„åŠŸèƒ½ï¼Œä»¥ä¿è¯æ°¸ä¹…ä»£ä¸ä¼šæº¢å‡ºã€‚ ä¸‰ã€åƒåœ¾æ”¶é›†ç®—æ³•ä»‹ç»å‡ ç§ç®—æ³•çš„æ€æƒ³åŠå…¶å‘å±•è¿‡ç¨‹ã€‚ 1ã€æ ‡è®°-æ¸…é™¤ç®—æ³•æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•æ˜¯â€œæ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰â€ç®—æ³•ï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶è°ƒæ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚å®ƒä¸»è¦ç¼ºç‚¹æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯æ•ˆç‡é—®é¢˜ï¼Œæ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›å¦å¤–ä¸€ä¸ªæ˜¯ç©ºé—´é—®é¢˜ï¼Œæ ‡è®°æ¸…é™¤ä¹‹åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œç©ºé—´ç¢ç‰‡å¤ªå¤šå¯èƒ½ä¼šå¯¼è‡´ï¼Œå½“ç¨‹åºåœ¨ä»¥åçš„è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶æ— æ³•æ‰¾åˆ°è¶³å¤Ÿçš„è¿ç»­å†…å­˜è€Œä¸å¾—ä¸æå‰è§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œã€‚ 2ã€å¤åˆ¶ç®—æ³•ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œäºæ˜¯å°±æœ‰äº†â€œå¤åˆ¶ï¼ˆCopyingï¼‰â€ç®—æ³•ã€‚å®ƒå°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·ä½¿å¾—æ¯æ¬¡éƒ½æ˜¯å †å…¶ä¸­çš„ä¸€å—è¿›è¡Œå†…å­˜å›æ”¶ï¼Œå†…å­˜åˆ†é…æ—¶ä¹Ÿå°±ä¸ç”¨è€ƒè™‘å†…å­˜ç¢ç‰‡ç­‰å¤æ‚æƒ…å†µï¼Œåªè¦ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆï¼ŒæŒ‰é¡ºåºåˆ†é…å†…å­˜å³å¯ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚ä½†æ˜¯è¿™ç§ç®—æ³•çš„ä»£ä»·æ—¶å°†å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€èˆ¬ã€‚ ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½é‡‡ç”¨è¿™ç§æ”¶é›†ç®—æ³•æ¥å›æ”¶æ–°ç”Ÿä»£ï¼ŒIBMçš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡98%æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æŒ‰ç…§1:1çš„æ¯”ä¾‹æ¥åˆ’åˆ†å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯å°†å†…å­˜åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„Edenç©ºé—´å’Œä¸¤å—è¾ƒå°çš„Survivorç©ºé—´ï¼Œæ¯æ¬¡ä½¿ç”¨Edenå’Œå…¶ä¸­çš„ä¸€å—Survivorã€‚å½“å›æ”¶æ—¶ï¼Œå°†Edenå’ŒSurvivorä¸­è¿˜æ´»ç€çš„å¯¹è±¡ä¸€æ¬¡æ€§æ‹·è´åˆ°å¦å¤–ä¸€å—Survivorç©ºé—´ä¸Šï¼Œæœ€åæ¸…ç†è°ƒEdenå’Œåˆšæ‰ç”¨è¿‡çš„Survivorçš„ç©ºé—´ã€‚ Hotspotè™šæ‹Ÿæœºé»˜è®¤Edenå’ŒSurvivorçš„å¤§å°æ¯”ä¾‹æ—¶8:1ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡æ–°ç”Ÿä»£ä¸­å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ•´ä¸ªæ–°ç”Ÿä»£å®¹é‡çš„90%(80%+10%)ï¼Œåªæœ‰10%çš„å†…å­˜æ˜¯ä¼šè¢«â€œæµªè´¹â€çš„ã€‚ 3ã€æ ‡è®°-æ•´ç†ç®—æ³•å¤åˆ¶æ”¶é›†ç®—æ³•åœ¨å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜æ—¶å°±è¦æ‰§è¡Œè¾ƒå¤šçš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡å°†ä¼šå˜ä½ã€‚æ›´å…³é”®çš„æ˜¯ï¼Œå¦‚æœä¸æƒ³æµªè´¹50%çš„ç©ºé—´ï¼Œå°±éœ€è¦æœ‰é¢å¤–çš„ç©ºé—´è¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œä»¥åº”å¯¹è¢«ä½¿ç”¨çš„å†…å­˜ä¸­æ‰€æœ‰å¯¹è±¡éƒ½100%å­˜æ´»çš„æç«¯æƒ…å†µï¼Œæ‰€ä»¥åœ¨è€å¹´ä»£ä¸€èˆ¬ä¸èƒ½ç›´æ¥é€‰ç”¨è¿™ç§ç®—æ³•ã€‚ æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹ï¼Œæå‡ºäº†â€æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰â€œç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€æ ‡è®°-æ¸…é™¤â€œç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å †å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†è°ƒç«¯è¾¹ç•Œæ„å¤–çš„å†…å­˜ã€‚ 4ã€åˆ†ä»£æ”¶é›†ç®—æ³•å½“å‰å•†ä¸šè™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨â€åˆ†ä»£æ”¶é›†â€œï¼ˆGenerational Collectionï¼‰ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆæ–°çš„æ€æƒ³ï¼Œåªæ˜¯æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬æ˜¯æŠŠJavaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é‡‡ç”¨æœ€é€‚åˆçš„æ”¶é›†ç®—æ³•ã€‚ åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†æ—¶éƒ½å‘ç°æœ‰å¤§æ‰¹å¯¹è±¡æ­»å»ï¼Œåªæœ‰å°‘é‡å­˜æ´»ï¼Œé‚£å°±é€‰ç”¨å¤åˆ¶ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å­˜è´§å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ”¶é›†ã€‚ åœ¨è€å¹´ä»£ä¸­å› ä¸ºå¯¹è±¡å­˜æ´»ç‡é«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å †å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»ä½¿ç”¨â€æ ‡è®°-æ¸…ç†â€œæˆ–â€æ ‡è®°-æ•´ç†â€œç®—æ³•æ¥è¿›è¡Œå›æ”¶ã€‚ å››ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥ Javaè®¡æ•°ä¹ é¢˜ä¸­æ‰€æå€¡çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœ€ç»ˆå¯ä»¥å½’ç»“ä¸ºè‡ªåŠ¨åŒ–åœ°è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼šç»™å¯¹è±¡åˆ†é…å†…å­˜ä»¥åŠå›æ”¶åˆ†é…ç»™å¯¹è±¡çš„å†…å­˜ã€‚ å¯¹è±¡çš„é‚£å†…å­˜åˆ†é…ï¼Œå¾€å¤§æ–¹å‘ä¸Šè®²ï¼Œå°±æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼Œå¯¹è±¡ä¸»è¦åˆ†é…åœ¨æ–°ç”Ÿä»£çš„EdenåŒºä¸Šï¼Œå¦‚æœå¯åŠ¨äº†æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼Œå°†æŒ‰çº¿ç¨‹ä¼˜å…ˆåœ¨TLABä¸Šåˆ†é…ã€‚å°‘æ•°æƒ…å†µä¸‹ä¹Ÿå¯èƒ½ä¼šç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ä¸­ï¼Œåˆ†é…çš„è§„åˆ™å¹¶ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾å›ºå®šçš„ï¼Œå…¶ç»†èŠ‚å–å†³äºå½“å‰ä½¿ç”¨çš„æ—¶å“ªä¸€ç§åƒåœ¾æ”¶é›†å™¨ç»„åˆï¼Œè¿˜æœ‰è™šæ‹Ÿæœºä¸­ä¸å†…å­˜ç›¸å…³çš„å‚æ•°çš„è®¾ç½®ã€‚ 1ã€å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ å¯¹è±¡å­—æ–°ç”Ÿä»£EdenåŒºä¸­åˆ†é…ã€‚å½“EdenåŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡Minor GCã€‚ Minor GCå’ŒFull GCçš„åŒºåˆ«ï¼Ÿ æ–°ç”Ÿä»£GCï¼ˆMinor GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œï¼Œå› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚ è€å¹´ä»£GCï¼ˆMajor GC / Full GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå‡ºç°äº†Major GCï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼‰ã€‚Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10æ¯ä»¥ä¸Šã€‚ 2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£æ‰€è°“å¤§å¯¹è±¡æ˜¯æŒ‡ï¼Œéœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„Javaå¯¹è±¡ï¼Œæœ€ç»å…¸çš„å¤§å¯¹è±¡å°±æ˜¯é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²åŠæ•°ç»„ã€‚ å¤§å¯¹è±¡å †è™šæ‹Ÿæœºçš„å†…å­˜åˆ†é…æ¥è¯´å°±æ˜¯ä¸€ä¸ªåæ¶ˆæ¯ï¼Œç»å¸¸å‡ºç°å¤§å¯¹è±¡å®¹æ˜“å¯¼è‡´å†…å­˜è¿˜æœ‰ä¸å°‘ç©ºé—´æ—¶å°±æå‰è§¦å‘åƒåœ¾æ”¶é›†ä»¥è·å–è¶³å¤Ÿçš„è¿ç»­ç©ºé—´æ¥â€œå®‰ç½®â€å®ƒä»¬ã€‚ 3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£è™šæ‹Ÿæœºæ—¢ç„¶é‡‡ç”¨äº†åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œé‚£å†…å­˜å›æ”¶æ—¶å°±å¿…é¡»èƒ½è¯†åˆ«å“ªäº›å¯¹è±¡åº”å½“æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œå“ªäº›å¯¹è±¡åº”æ”¾åœ¨è€å¹´ä»£ä¸­ã€‚ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œ å°†è¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨SurvivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆ15ï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚ 4ã€åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®šä¸ºäº†èƒ½æ›´å¥½çš„åœ°é€‚åº”ä¸åŒç¨‹åºçš„å†…å­˜çŠ¶å†µï¼Œè™šæ‹Ÿæœºå¹¶ä¸èƒ½æ€»æ˜¯è¦æ±‚å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ°MaxTenuringThresholdæ‰èƒ½æ™‹å‡è€å¹´ä»£ï¼Œå¦‚æœåœ¨Survivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚ 5ã€ç©ºé—´åˆ†é…æ‹…ä¿åœ¨å‘ç”ŸMinor GCæ—¶ï¼Œè™šæ‹Ÿæœºä¼šæ£€æµ‹ä¹‹å‰æ¯æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹³å‡å¤§å°æ˜¯å¦å¤§äºè€å¹´ä»£çš„ç”Ÿäºç©ºé—´å¤§å°ï¼Œå¦‚æœå¤§äºï¼Œåˆ™æ”¹ä¸ºç›´æ¥è¿›è¡Œä¸€æ¬¡Full GCã€‚å¦‚æœå°äºï¼Œåˆ™æŸ¥çœ‹HandlePromotionFailureè®¾ç½®æ˜¯å¦å…è®¸æ‹…ä¿æ—¶æŠ¥ï¼›å¦‚æœå…è®¸ï¼Œé‚£æŒ‡æŒ¥è¿›è¡ŒMinor GCï¼›å¦‚æœä¸å…è®¸ï¼Œåˆ™ä¹Ÿè¦æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚ å°ç»“å†…å­˜å›æ”¶ä¸åƒåœ¾æ”¶é›†å™¨åœ¨å¾ˆå¤šæ—¶å€™éƒ½æ—¶å½±å“ç³»ç»Ÿæ€§èƒ½ã€å¹¶å‘èƒ½åŠ›çš„ä¸»è¦å› ç´ ä¹‹ä¸€ï¼Œè™šæ‹Ÿæœºä¹‹æ‰€ä»¥æä¾›å¤šç§ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨åŠå¤§é‡çš„è°ƒèŠ‚å‚æ•°ï¼Œæ˜¯å› ä¸ºåªæœ‰æ ¹æ®å®é™…åº”ç”¨éœ€è¦ã€å®ç°æ–¹å¼é€‰æ‹©æœ€ä¼˜çš„æ”¶é›†æ–¹å¼æ‰èƒ½è·å–æœ€å¥½çš„æ€§èƒ½ã€‚ æ²¡æœ‰å›ºå®šæ”¶é›†å™¨ã€å‚æ•°ç»„åˆï¼Œä¹Ÿæ²¡æœ‰æœ€ä¼˜çš„è°ƒä¼˜æ–¹æ³•ï¼Œè™šæ‹Ÿæœºä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¿…ç„¶çš„å†…å­˜å›æ”¶è¡Œä¸ºã€‚ å› æ­¤å­¦ä¹ è™šæ‹Ÿæœºå†…å­˜åªæ˜¯ï¼Œå¦‚æœè¦åˆ°å®è·µè°ƒä¼˜é˜¶æ®µï¼Œå¿…é¡»äº†è§£æ¯ä¸ªå…·ä½“æ”¶é›†å™¨çš„è¡Œä¸ºï¼Œä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€è°ƒèŠ‚å‚æ•°ã€‚ å‚è€ƒ å›¾ç‰‡æ¥æºï¼Œjvmåƒåœ¾æ”¶é›†ï¼ˆæ ‡è®°-æ¸…é™¤,å¤åˆ¶ï¼Œæ ‡è®°-æ•´ç†ï¼Œåˆ†ä»£ï¼‰ç®—æ³• å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"Javaå†…å­˜åŒºåŸŸå†…å­˜æº¢å‡ºå¼‚å¸¸","date":"2018-09-08T14:19:36.000Z","path":"2018/09/08/bc3decee.html","text":"Javaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†å›´åŸçš„é«˜å¢™ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›æ¥ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºå». æ¦‚è¿°å¯¹äºä»äº‹Cå’ŒC++ç¨‹åºå¼€å‘çš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œåœ¨å†…å­˜ç®¡ç†é¢†åŸŸï¼Œä»–ä»¬æ—¢æ˜¯æ‹¥æœ‰æœ€é«˜æƒåŠ›çš„çš‡å¸ï¼Œåˆæ˜¯ä»äº‹æœ€åŸºç¡€å·¥ä½œçš„åŠ³åŠ¨äººæ°‘â€”â€”æ—¢æ‹¥æœ‰æ¯ä¸€ä¸ªå¯¹è±¡çš„â€œæ‰€æœ‰æƒâ€ï¼Œåˆæ‹…è´Ÿç€æ¯ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å¼€å§‹åˆ°ä¸­ç§¯æè€Œçš„ç»´æŠ¤è´£ä»»ã€‚ ä½†å¯¹äºJavaç¨‹åºå‘˜æ¥è¯´ï¼Œåœ¨è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶çš„å¸®åŠ©ä¸‹ï¼Œä¸å†éœ€è¦ä¸ºæ¯ä¸€ä¸ªnewæ“ä½œå»å†™é…å¯¹çš„delete/freeä»£ç ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºå’Œå†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œçœ‹èµ·æ¥ç”±è™šæ‹Ÿæœºç®¡ç†å†…å­˜ä¸€åˆ‡éƒ½å¾ˆç¾å¥½ã€‚ ä¸è¿‡ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºJavaç¨‹åºå‘˜æŠŠå†…å­˜æ§åˆ¶çš„æƒåŠ›äº¤ç»™äº†Javaè™šæ‹Ÿæœºï¼Œä¸€æ—¦å‡ºç°å†…å­˜æ³„æ¼å’Œæº¢å‡ºæ–¹é¢çš„é—®é¢˜ï¼Œå¦‚æœä¸äº†è§£è™šæ‹Ÿæœºæ˜¯æ€ä¹ˆæ ·ä½¿ç”¨å†…å­˜çš„ï¼Œé‚£æ’æŸ¥é”™è¯¯å°†ä¼šæˆä¸ºä¸€é¡¹å¼‚å¸¸è‰°éš¾çš„å·¥ä½œã€‚ è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ Javaè™šæ‹Ÿæœºåœ¨æ‰§è¡ŒJavaç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²ä¸åŒçš„æ•°æ®åŒºåŸŸã€‚è¿™äº›åŒºåŸŸéƒ½æœ‰å„è‡ªçš„ç”¨é€”ï¼Œä»¥åŠåˆ›å»ºå’Œé”€æ¯çš„æ—¶é—´ï¼Œæœ‰çš„åŒºåŸŸéšç€è™šæ‹Ÿæœºè¿›ç¨‹çš„å¯åŠ¨è€Œå­˜åœ¨ï¼Œæœ‰äº›åŒºåŸŸåˆ™ä¾èµ–ç”¨æˆ·çº¿ç¨‹çš„å¯åŠ¨å’Œç»“æŸè€Œå»ºç«‹å’Œé”€æ¯ã€‚ ç¨‹åºè®¡æ•°å™¨ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒçš„ä½œç”¨å¯ä»¥çœ‹æˆæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚åœ¨è™šæ‹Ÿæœºçš„æ¦‚å¿µæ¨¡å‹é‡Œï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–å“ä¸€è·³éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚ ç”±äºJavaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„å‘½ä»¤ã€‚å› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ã€‚ å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œ è¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯Natvieæ–¹æ³•ï¼Œ è¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™ä¸ºç©ºï¼ˆUndefinedï¼‰ã€‚æ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OOMæƒ…å†µçš„åŒºåŸŸã€‚ Javaè™šæ‹Ÿæœºæ ˆJavaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚ è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåŒäº‹åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚ æ¯ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­ä»å…¥æ ˆé“å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ ç»å¸¸æ‰€è¯´çš„å †å†…å­˜ï¼ˆHeapï¼‰å’Œæ ˆå†…å­˜ï¼ˆStackï¼‰æ˜¯ç§æ¯”è¾ƒç²—ç³™çš„åˆ†å‘ï¼ŒJavaå†…å­˜åŒºåŸŸçš„åˆ’åˆ†å®é™…ä¸Šä¼šå¤æ‚å¾ˆå¤šã€‚è¿™é‡Œæ‰€æŒ‡çš„â€œæ ˆâ€å°±æ˜¯è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´è™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ã€‚ å±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œæ ¹æ®ä¸åŒçš„è™šæ‹Ÿæœºå®ç°ï¼Œå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªå¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’ŒreturnAddressç±»å‹ï¼ˆæŒ‡å‘ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚ 64ä½é•¿åº¦çš„longå’Œdoubleç±»å‹çš„æ•°æ®ä¼šå ç”¨2ä¸ªå±€éƒ¨å˜é‡ç©ºé—´ï¼ˆSlotï¼‰ï¼Œå…¶ä½™çš„æ•°æ®åªå ç”¨ä¸€ä¸ªã€‚ å±€éƒ¨å˜é‡è¡¨æ‰€éœ€è¦çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æœŸé—´å®Œæˆåˆ†é…ã€‚å½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨å¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚ è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ï¼› å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå½“æ‰©å±•åˆ°æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ï¼› å½“å‰å¤§éƒ¨åˆ†çš„Javaè™šæ‹Ÿæœºéƒ½å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œåªä¸è¿‡Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿå…è®¸å›ºå®šé•¿åº¦çš„è™šæ‹Ÿæœºæ ˆã€‚ æœ¬åœ°æ–¹æ³•æ ˆæœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stacksï¼‰ä¸è™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨æ—¶éå¸¸ç›¸ä¼¼çš„ã€‚ åŒºåˆ« è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ æœ¬åœ°æ–¹æ³•æ ˆåˆ™æ˜¯ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„NativeæœåŠ¡ã€‚ è™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„æ–¹æ³•ä½¿ç”¨çš„è¯­è¨€ã€ä½¿ç”¨æ–¹å¼ä¸æ•°æ®ç»“æ„å¹¶æ²¡æœ‰å¼ºåˆ¶è§„å®šï¼Œå› æ­¤å…·ä½“çš„è™šæ‹Ÿæœºå¯ä»¥è‡ªç”±å®ç°å®ƒã€‚æœ‰äº›è™šæ‹Ÿæœºï¼ˆSun Hotspotï¼‰ç›´æ¥æŠŠæœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚ ä¸è™šæ‹Ÿæœºæ ˆä¸€æ ·ï¼Œæœ¬åœ°æ–¹æ³•æ ˆåŒºåŸŸä¹Ÿä¼šæŠ›å‡ºStackOverflowErrorå’ŒOutOfMemoryErrorå¼‚å¸¸ã€‚ Javaå † å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´ï¼ŒJavaå †ï¼ˆJava Heapï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚ Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°ï¼šæ‰€æœ‰å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…ã€‚ Javaå †äº‹è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚ æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚ Javaå †äº‹åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™ä¹Ÿç§°ä½œâ€œGCå †â€ï¼ˆGarbage Collected Heapï¼‰ã€‚ Javaå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯ï¼Œå°±åƒæˆ‘ä»¬çš„ç£ç›˜ç©ºé—´ä¸€æ ·ã€‚ ä»å†…å­˜å›æ”¶è§’åº¦çœ‹ï¼Œç”±äºç°åœ¨æ”¶é›†é½åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£æ‰‹æœºç®—æ³•ï¼Œæ‰€ä»¥Javaå †ä¸­è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼›å†ç»†åˆ†æœ‰Edenç©ºé—´ã€From Survivorç©ºé—´ã€To Survivorç©ºé—´ç­‰ã€‚ ä»å†…å­˜åˆ†é…çš„è§’åº¦çœ‹ï¼Œçº¿ç¨‹å…±äº«çš„Javaå †ä¸­å¯èƒ½åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºã€‚ æ— è®ºå¦‚ä½•åˆ’åˆ†ï¼Œéƒ½ä¸å­˜æ”¾å†…å®¹æ— å…³ï¼Œæ— è®ºå“ªä¸ªåŒºåŸŸï¼Œå­˜å‚¨çš„éƒ½ä»ç„¶æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿›ä¸€æ­¥åˆ’åˆ†æ˜¯ä¸ºäº†æ›´å¥½çš„å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«çš„åˆ†é…å†…å­˜ã€‚ä¸»æµçš„è™šæ‹Ÿæœºéƒ½æ˜¯æŒ‰ç…§å¯æ‰©å±•æ¥å®ç°çš„ï¼ˆé€šè¿‡-Xmxå’Œ-Xmsæ§åˆ¶ï¼‰ã€‚å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ æ–¹æ³•åŒºæ–¹æ³•åŒºï¼ˆMethod Areaï¼‰å’ŒJavaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹Ÿæœºå®¶åœ¨çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚ è™½ç„¶Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªåˆ«åå«NonHeapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸Javaå †åŒºåˆ†å¼€æ¥ã€‚ Javaè™šæ‹Ÿæœºè§„èŒƒå †è¿™ä¸ªåŒºåŸŸçš„é™åˆ¶éå¸¸å®½æ¾ï¼Œé™¤äº†å’ŒJavaå †ä¸€æ ·ä¸éœ€è¦è¿ç»­çš„å†…å­˜å’Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©ä¸å®ç°åƒåœ¾æ”¶é›†ã€‚ ç›¸å¯¹è€Œè¨€ï¼Œåƒåœ¾æ”¶é›†è¡Œä¸ºåœ¨è¿™ä¸ªåŒºåŸŸæ˜¯æ¯”è¾ƒå°‘å‡ºç°çš„ï¼Œä½†å¹¶éæ•°æ®è¿›å…¥äº†æ–¹æ³•åŒºå°±å¦‚æ°¸ä¹…ä»£çš„åå­—ä¸€æ ·â€œæ°¸ä¹…â€å­˜åœ¨äº†ã€‚ è¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶ç›®æ ‡ä¸»è¦æ˜¯é’ˆå¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹ç±»å‹çš„å¸è½½ï¼Œè¿™ä¸ªåŒºåŸŸçš„å›æ”¶â€œæˆç»©â€æ¯”è¾ƒéš¾ä»¥ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶çš„ç¡®æ˜¯æœ‰å¿…è¦çš„ã€‚ æ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒçš„è§„å®šï¼Œå½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Classæ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ—¶å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢äº®å’Œç¬¦å·é¥®ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºè¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚ Javaè™šæ‹Ÿæœºå¯¹Classçš„æ¯ä¸€éƒ¨åˆ†çš„æ ¼å¼éƒ½æœ‰ä¸¥æ ¼çš„è§„å®šï¼Œæ¯ä¸€ä¸ªå­—èŠ‚ç”¨äºå­˜å‚¨å“ªç§æ•°æ®éƒ½å¿…é¡»ç¬¦åˆè§„èŒƒä¸Šçš„è¦æ±‚ï¼Œè¿™æ ·æ‰ä¼šè¢«è™šæ‹Ÿæœºè®¤å¯ã€è£…è½½å’Œæ‰§è¡Œã€‚ä½†æ˜¯å¯¹äºå¸¸é‡æ± ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒæ²¡æœ‰åšä»»ä½•ç»†èŠ‚çš„è¦æ±‚ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé™¤äº†ä¿å­˜Classæ–‡ä»¶ä¸­æè¿°çš„ç¬¦å·å¼•ç”¨å¤–ï¼Œè¿˜ä¼šæŠŠç¿»è¯‘å‡ºæ¥çš„ç›´æ¥é¥®ç”¨ä¹Ÿå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·æœ‰åŠ¨æ€æ€§ï¼ŒJavaè¯­è¨€å¹¶ä¸è¦æ±‚å¸¸é‡ä¸€å®šåªèƒ½åœ¨ç¼–è¯‘æœŸäº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯å¹¶éé¢„ç½®å…¥Classæ–‡ä»¶ä¸­å¸¸é‡æ± çš„å†…å®¹æ‰èƒ½è¿›å…¥æ–¹æ³•åŒºè¿è¡Œæ—¶çš„å¸¸é‡æ± ï¼Œè¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨çš„æ¯”è¾ƒå¤šçš„ä¾¿æ˜¯**Stringç±»çš„intern()**æ–¹æ³•ã€‚ public String intern(); è¿”å›å­—ç¬¦ä¸²å¯¹è±¡çš„è§„èŒƒåŒ–è¡¨ç¤ºå½¢å¼ã€‚ ä¸€ä¸ªåˆå§‹æ—¶ä¸ºç©ºçš„å­—ç¬¦ä¸²æ± ï¼Œå®ƒç”±ç±» String ç§æœ‰åœ°ç»´æŠ¤ã€‚ å½“è°ƒç”¨ intern æ–¹æ³•æ—¶ï¼Œå¦‚æœæ± å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼ˆè¯¥å¯¹è±¡ç”± equals(Object) æ–¹æ³•ç¡®å®šï¼‰ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œå°†æ­¤ String å¯¹è±¡æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶ä¸”è¿”å›æ­¤ String å¯¹è±¡çš„å¼•ç”¨ã€‚ å®ƒéµå¾ªå¯¹äºä»»ä½•ä¸¤ä¸ªå­—ç¬¦ä¸² s å’Œ tï¼Œå½“ä¸”ä»…å½“ s.equals(t) ä¸º true æ—¶ï¼Œs.intern() == t.intern() æ‰ä¸º trueã€‚ æ‰€æœ‰å­—é¢å€¼å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²èµ‹å€¼å¸¸é‡è¡¨è¾¾å¼éƒ½æ˜¯å†…éƒ¨çš„ã€‚ è¿”å›ï¼š ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†…å®¹ä¸æ­¤å­—ç¬¦ä¸²ç›¸åŒï¼Œä½†å®ƒä¿è¯æ¥è‡ªå­—ç¬¦ä¸²æ± ä¸­ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œè‡ªç„¶ä¼šæ”¶åˆ°æ–¹æ³•åŒºå†…çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ ç›´æ¥å†…å­˜ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErrorå¼‚å¸¸å‡ºç°ã€‚ æœ¬æœºå†…å­˜çš„åˆ†é…ä¸ä¼šæ”¶åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜ï¼Œåˆ™è‚¯å®šè¿˜æ˜¯ä¼šæ”¶åˆ°æœ¬æœºæ€»å†…å­˜ï¼ˆRAMåŠSWAPåŒºæˆ–è€…åˆ†é¡µæ–‡ä»¶ï¼‰çš„å¤§å°åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚åˆ†é…è™šæ‹Ÿæœºå‚æ•°æ—¶ï¼Œå®¹æ˜“å¿½ç•¥æ‰ç›´æ¥å†…å­˜ï¼Œä½¿å¾—å„ä¸ªå†…å­˜åŒºåŸŸçš„æ€»å’Œå¤§äºç‰©ç†å†…å­˜é™åˆ¶ï¼Œä»è€Œå¯¼è‡´åŠ¨æ€æ‰©å±•æ—¶å‡ºç°OutOfMemoryErrorå¼‚å¸¸ã€‚ å¯¹è±¡è®¿é—®å¯¹è±¡çš„è®¿é—®åœ¨Javaè¯­è¨€ä¸­æ— å¤„ä¸åœ¨ï¼Œæ—¶æœ€æ™®é€šçš„ç¨‹åºè¡Œä¸ºï¼Œä½†å³ä½¿æ—¶æœ€ç®€å•çš„è®¿é—®ï¼Œä¹Ÿä¼šå»æ¶‰åŠJavaæ ˆã€Javaå †ã€æ–¹æ³•åŒºè¿™ä¸‰ä¸ªæœ€é‡è¦çš„å†…å­˜åŒºåŸŸä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¦‚ï¼š Object obj = new Object(); å‡è®¾è¿™å¥ä»£ç å‡ºç°åœ¨æ–¹æ³•ä½“ä¸­ï¼š â€œObject objâ€è¿™éƒ¨åˆ†çš„è¯­ä¹‰å°†ä¼šåæ˜ åˆ°Javaæ ˆçš„æœ¬åœ°å˜é‡è¡¨ä¸­ï¼Œä½œä¸ºä¸€ä¸ªreferenceç±»å‹æ•°æ®å‡ºç°ã€‚ â€œnew Object( )â€è¿™éƒ¨åˆ†è¯­ä¹‰å°†ä¼šåæ˜ åˆ°Javaå †ä¸­ å½¢æˆä¸€å—å­˜å‚¨äº†Objectç±»å‹æ‰€æœ‰å®ä¾‹æ•°æ®å€¼ï¼ˆInstance Dataï¼Œå¯¹è±¡ä¸­å„ä¸ªå®ä¾‹å­—æ®µçš„æ•°æ®ï¼‰çš„ç»“æ„åŒ–å†…å­˜ï¼Œæ ¹æ®å…·ä½“ç±»å‹ä»¥åŠè™šæ‹Ÿæœºå®ç°çš„å¯¹è±¡å†…å­˜å¸ƒå±€çš„ä¸åŒï¼Œè¿™å—å†…å­˜çš„é•¿åº¦æ—¶ä¸å›ºå®šçš„ã€‚Javaå †ä¸­è¿˜å¿…é¡»åŒ…å«èƒ½æŸ¥æ‰¾åˆ°æ­¤å¯¹è±¡ç±»å‹æ•°æ®ï¼ˆå¦‚å¯¹è±¡ç±»å‹ã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ã€æ–¹æ³•ç­‰ï¼‰çš„åœ°å€ä¿¡æ¯ï¼Œè¿™äº›ç±»å‹æ•°æ®åˆ™å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚ ä¸åŒè™šæ‹Ÿæœºå®ç°çš„å¯¹è±¡è®¿é—®æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒã€‚ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰ä¸¤ç§ï¼š ä½¿ç”¨å¥æŸ„ Javaå †ä¸­ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜ä½œä¸ºå¥æŸ„æ± ï¼Œreferenceä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®å’Œç±»å‹æ•°æ®å„è‡ªçš„å…·ä½“åœ°å€ä¿¡æ¯ã€‚ /2.png) å¥æŸ„è®¿é—®æ–¹å¼æœ€å¤§çš„å¥½å¤„å°±æ˜¯**referenceä¸­å­˜å‚¨çš„äº‹ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡æ—¶éå¸¸æ™®éçš„è¡Œä¸ºï¼‰åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œreferenceæœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚** ç›´æ¥æŒ‡é’ˆ Javaå †å¯¹è±¡çš„å¸ƒå±€ä¸­å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œreferenceä¸­ç›´æ¥å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡åœ°å€ã€‚ æŒ‡é’ˆè®¿é—®æ–¹å¼åœ¨æœ€å¤§å¥½å¤„å°±æ˜¯é€Ÿåº¦æ›´å¿«ï¼Œå®ƒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ï¼Œç”±äºå¯¹è±¡çš„è®¿é—®åœ¨Javaä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤è¿™ç±»å¼€é”€ç§¯å°‘æˆå¤šåä¹Ÿæ˜¯ä¸€é¡¹éå¸¸å¯è§‚çš„æ‰§è¡Œæˆæœ¬ã€‚ é‡ç°OOMå¼‚å¸¸åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒçš„æè¿°ä¸­ï¼Œé™¤äº†ç¨‹åºè®¡æ•°å™¨å¤–ï¼Œè™šæ‹Ÿæœºå†…å­˜çš„å…¶ä»–å‡ ä¸ªè¿è¡Œæ—¶åŒºåŸŸéƒ½æœ‰å‘ç”ŸOOMå¼‚å¸¸çš„å¯èƒ½ã€‚ Javaå †æº¢å‡ºJavaå †ç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹ï¼Œæˆ‘ä»¬åªè¦ä¸æ–­çš„åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¿è¯GC Rootsåˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥é¿å…åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤è¿™äº›å¯¹è±¡ï¼Œå°±ä¼šåœ¨å¯¹è±¡æ•°é‡è¾¾åˆ°æœ€å¤§å †å®¹é‡é™åˆ¶åäº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError public class HeapOOM &#123; static class OOMObject &#123; &#125; public static void main(Stringp[] args) &#123; List&lt;OOMObject&gt; list = new ArrayList&lt;OOMObject&gt;; while(true) &#123; list.add(new OOMObject()); &#125; &#125;&#125; è¿è¡Œä»£ç å°†ä¼šæŠ›å‡ºï¼šjava.lang.OutOfMemoryError: Java heap space. è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ—¶å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆåˆ†æ¸…æ¥šåˆ°åº•æ—¶å‡ºç°äº†å†…å­˜æ³„æ¼è¿˜æ˜¯å†…å­˜æº¢å‡ºã€‚ å¦‚æœæ—¶å†…å­˜æ³„æ¼ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GC Rootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚ å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé‚£å°±åº”è¯¥æ£€æŸ¥è™šæ‹Ÿæœºå †å‚æ•°ï¼ˆ-Xmx å’Œ -Xmsï¼‰ä¸æœºå™¨æ— åŠ›å†…å­˜å¯¹æ¯”æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µã€‚å°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚ è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º å¯¹äºHotSpotæ¥è¯´ï¼Œ**-Xosså‚æ•°ï¼ˆè®¾ç½®æœ¬åœ°æ–¹æ³•æ ˆå¤§å°ï¼‰è™½ç„¶å­˜åœ¨ï¼Œä½†å®é™…ä¸Šæ˜¯æ— æ•ˆçš„**ï¼Œæ ˆå®¹é‡åªç”±-Xsså‚æ•°è®¾å®šã€‚ å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ã€‚ å¦‚æœè™šæ‹Ÿæœºåœ¨æ‹“å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -Xss128k public class JavaVMStackSOF &#123; private int stackLength = 1; public void stackLeak() &#123; stackLength++; stackLeak(); &#125; public static void main(String[] args) throws Throwable &#123; JavaVMStackSOF oom = new JavaVMStackSOF(); try &#123; oom.stackLeak(); &#125; catch (Throwable e) &#123; System.out.println(&quot;stack length:&quot; + ooo.stackLength); throw e; &#125; &#125;&#125; è¿è¡Œç»“æœï¼š Stack length:2402 Exception in thread â€œmainâ€ java.lang.StackOverflowError Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·åç»­å¼‚å¸¸æ ˆä¿¡æ¯çœç•¥ã€‚ ç»“æœè¯æ˜ï¼šåœ¨å•ä¸ªçº¿ç¨‹ä¸‹ï¼Œæ— è®ºæ˜¯ç”±äºæ ˆå¸§å¤ªå¤§ï¼Œè¿˜æ˜¯è™šæ‹Ÿæœºæ ˆå®¹é‡å¤ªå°ï¼Œå½“å†…å­˜æ— æ³•åˆ†é…çš„æ—¶å€™ï¼Œ è™šæ‹ŸæœºæŠ›å‡ºçš„éƒ½æ˜¯StackOverflowErrorå¼‚å¸¸ã€‚\u0010 åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -Xss2M public class JavaVMStackOOM &#123; private void dontStop() &#123; while (true) &#123; &#125; &#125; public void stackLeakThread() &#123; while (true) &#123; Thread thread = new Thread(new Runnable() &#123; @Override public void run () &#123; dontStop(); &#125; &#125;); thread.start(); &#125; &#125; public static void main(String[] args) throws Throwable &#123; JavaVMStackOOM oom = new JavaVMStackOOM(); oom.stackLeakThread(); &#125;&#125; æ³¨ï¼šå¦‚æœè¦è¿è¡Œè¿™é¡¿å•Šä»£ç ï¼Œè®°å¾—è¦å…ˆä¿å­˜å½“å‰çš„å·¥ä½œï¼Œç”±äºåœ¨Windowså¹³å°çš„è™šæ‹Ÿæœºä¸­ï¼ŒJavaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹ä¸Šçš„ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç æ‰§è¡Œæ—¶æœ‰è¾ƒå¤§çš„é£é™©ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå‡æ­»ã€‚ è¿è¡Œç»“æœï¼š Exception in thread â€œmainâ€ java.lang.OutOfMemoryError: unable to create new native thread å®éªŒè¯æ˜ï¼š é€šè¿‡ä¸æ–­çš„å»ºç«‹çº¿ç¨‹çš„æ–¹å¼å¯ä»¥äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯ï¼Œè¿™æ ·äº§ç”Ÿçš„å†…å­˜æº¢å‡ºå¼‚å¸¸ä¸æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿå¤§å¹¶ä¸å­˜åœ¨ä»»ä½•è”ç³»ï¼Œæˆ–è€…å‡†ç¡®çš„è¯´ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç»™æ¯ä¸ªçº¿ç¨‹çš„æ ˆåˆ†é…çš„å†…å­˜è¶Šå¤§ï¼Œåè€Œè¶Šå®¹æ˜“äº§ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ å¦‚æœæ˜¯å»ºç«‹è¿‡å¤šçº¿ç¨‹å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼Œåœ¨ä¸èƒ½å‡å°‘çº¿ç¨‹æ•°æˆ–è€…æ›´æ¢64ä½è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼Œå°±åªèƒ½é€šè¿‡å‡å°‘æœ€å¤§å †å’Œå‡å°‘æ ˆå®¹é‡æ¥æ¢å–æ›´å¤šçš„çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰è¿™æ–¹é¢çš„ç»éªŒï¼Œè¿™ç§é€šè¿‡â€œå‡å°‘å†…å­˜â€çš„æ‰‹æ®µæ¥è§£å†³å†…å­˜æº¢å‡ºçš„æ–¹å¼ä¼šæ¯”è¾ƒéš¾ä»¥æƒ³åˆ°ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡ºå¦‚æœè¦å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­æ·»åŠ å†…å®¹ï¼Œ å˜´è´±çš„åšæ³•å°±æ˜¯ä½¿ç”¨String.intern()è¿™ä¸ªNativeæ–¹æ³•ã€‚è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå¦‚æœæ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤Stringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”ä»£è¡¨æ± ä¸­è¿™ä¸ªå­—ç¬¦ä¸²çš„Stringå¯¹è±¡ï¼›å¦åˆ™ï¼Œå°†æ­¤Stringå¯¹è±¡åŒ…å«çš„å­—ç¬¦ä¸²çš„æ·»åŠ åˆ°å¸¸é‡æ± ä¸­ï¼Œå¹¶ä¸”è¿”å›æ­¤Stringå¯¹è±¡çš„å¼•ç”¨ã€‚ åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -XXPermSize=10M -XX:MaxPermSize=10M public class RuntimeConstantPoolOOM &#123; public static void main(String[] args) &#123; // ä½¿ç”¨Listä¿å­˜ç€å¸¸é‡æ± å¼•ç”¨ï¼Œé¿å…Full GCå›æ”¶å¸¸é‡æ± è¡Œä¸º List&lt;String&gt; list = new ArrayList&lt;String&gt;(); int i = 0; while (true) &#123; list.add(String.valueOf(i++).intern()); &#125; &#125;&#125; è¿è¡Œç»“æœï¼š Exception in thread â€œmainâ€ java.lang.OutOfMemoryError: PermGen space å®éªŒç»“æœï¼š è¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡ºï¼Œåœ¨OOMåé¢è·Ÿéšç€çš„æç¤ºä¿¡æ¯æ˜¯PermGen spaceï¼Œè¯´æ˜è¿è¡Œæ—¶å¸¸é‡æ± å±äºæ–¹æ³•åŒºï¼ˆHotSpotè™šæ‹Ÿæœºä¸­çš„æ°¸ä¹…ä»£ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚ æ–¹æ³•åŒºæº¢å‡ºæ–¹æ³•åŒºç”¨äºå­˜æ”¾Classçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ç±»åã€è®¿é—®ä¿®é¥°ç¬¦ã€å¸¸é‡æ± ã€å­—æ®µæè¿°ã€æ–¹æ³•æè¿°ç­‰ã€‚è¿™ä¸ªå®éªŒéœ€è¦é€šè¿‡ç”Ÿæˆå¤§é‡çš„åŠ¨æ€ç±»æ¥å®ç°ï¼Œä½¿ç”¨CGLibè¿™ç±»å­—èŠ‚ç æŠ€æœ¯ï¼Œå¢å¼ºçš„ç±»è¶Šå¤šï¼Œå°±éœ€è¦è¶Šå¤§çš„æ–¹æ³•åŒºæ¥ä¿è¯åŠ¨æ€ç”Ÿæˆçš„Classå¯ä»¥åŠ è½½å¦‚å†…å­˜ã€‚ åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -XX:PermSize=10M -XX:MaxPermSize=10M public class JavaMethodAreaOOM &#123; public static void main(String[] args) &#123; while (true) &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(OOMObject.class); enhancer.setUseCache(false); enhancer.setCallback(new MethodInterceptor() &#123; public Object intercept(Object object, Method method, Object[] args, MethodProxy mhodProxy) throws Throwable &#123; return proxy.invokeSuper(obj, args); &#125; &#125;); enhancer.create(); &#125; &#125; static class OOMObject();&#125; è¿è¡Œç»“æœï¼š Caused by: java.lang.OutOfMemoryError: PermGen space å®éªŒç»“æœï¼š æ–¹æ³•åŒºæº¢å‡ºä¹Ÿæ˜¯ä¸€ç§å¸¸è§çš„å†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä¸€ä¸ªç±»å¦‚æœè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ‰ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯éå¸¸è‹›åˆ»çš„ã€‚åœ¨ç»å¸¸åŠ¨æ€ç”Ÿæˆå¤§é‡Classçš„åº”ç”¨ä¸­ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç±»çš„å›æ”¶çŠ¶æ€ã€‚ æœ¬æœºç›´æ¥å†…å­˜æº¢å‡ºé€šè¿‡åå°„è·å–Unsafeå®ä¾‹è¿›è¡Œå†…å­˜åˆ†é…ï¼ˆUnsafeç±»çš„getUnSafe()æ–¹æ³•é™åˆ¶äº†åªæœ‰å¼•å¯¼ç±»åŠ è½½å™¨æ‰ä¼šè¿”å›å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è®¾è®¡è€…å¸Œæœ›åªæœ‰rt.jarä¸­çš„ç±»å¯ä»¥ä½¿ç”¨Unsafeçš„åŠŸèƒ½ï¼‰ã€‚å› ä¸ºï¼Œè™½ç„¶ä½¿ç”¨DirectByteBufferåˆ†é…å†…å­˜ä¹Ÿä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ï¼Œä½†å®ƒæŠ›å‡ºå¼‚å¸¸æ—¶å¹¶æ²¡æœ‰çœŸæ­£å‘æ“ä½œç³»ç»Ÿç”³è¯·åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡è®¡ç®—å¾—çŸ¥å†…å­˜æ— æ³•åˆ†é…ï¼Œäºæ˜¯æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼ŒçœŸæ­£ç”³è¯·åˆ†é…å†…å­˜çš„æ–¹æ³•æ˜¯unsafe.allocateMemory()ã€‚ åœ¨IDEï¼ˆå¦‚IDEAï¼‰é‡Œè®¾ç½®JVMå‚æ•°ï¼š -Xmx20M -XX:MaxDirectMemorySize=10M public class DirectMemoryOOM &#123; private static final int _1MB = 1024 * 1024; public static void main(String[] args) throws Exception &#123; Field unsafeField = Unsafe.class.getDeclaredFields()[0]; unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe) unsafeField.get(null); while (true) &#123; unsafe.allocateMemory(_1MB); &#125; &#125;&#125; è¿è¡Œç»“æœï¼š Exception in thread â€œmainâ€ java.lang.OutOfMemoryError å°ç»“ å†…å­˜æ˜¯å¦‚ä½•åˆ’åˆ†çš„ å“ªéƒ¨åˆ†åŒºåŸŸã€ä»€ä¹ˆæ ·çš„ä»£ç å’Œæ“ä½œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºå¼‚å¸¸ è™½ç„¶Javaæœ‰åƒåœ¾æ”¶é›†æœºåˆ¶ï¼Œä½†å†…å­˜æº¢å‡ºå¼‚å¸¸ç¦»æˆ‘ä»¬å¹¶ä¸é¥è¿œï¼Œæœ¬ç« è®²è§£äº†è§£äº†å„ä¸ªåŒºåŸŸå‡ºç°å†…å­˜æº¢å‡ºå¼‚å¸¸çš„åŸå› ã€‚ å‚è€ƒ å‘¨å¿—æ˜ï¼Œæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}],"categories":[{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]},{"title":"Springäº‹åŠ¡ç®¡ç†","date":"2018-09-03T12:54:11.000Z","path":"2018/09/03/762945f0.html","text":"äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ. äº‹åŠ¡çš„ç‰¹æ€§(ACID) åŸå­æ€§ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼› ä¸€è‡´æ€§ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼› éš”ç¦»æ€§ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹ç‰©ä¸è¢«å…¶ä»–äº‹ç‰©æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼› æŒä¹…æ€§: ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ Springäº‹åŠ¡ç®¡ç†æ¥å£PlatformTransactionManagerï¼š ï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨Springå¹¶ä¸ç›´æ¥ç®¡ç†äº‹åŠ¡ï¼Œè€Œæ˜¯æä¾›äº†å¤šç§äº‹åŠ¡ç®¡ç†å™¨ ï¼Œä»–ä»¬å°†äº‹åŠ¡ç®¡ç†çš„èŒè´£å§”æ‰˜ç»™Hibernateæˆ–è€…JTAç­‰æŒä¹…åŒ–æœºåˆ¶æ‰€æä¾›çš„ç›¸å…³å¹³å°æ¡†æ¶çš„äº‹åŠ¡æ¥å®ç°ã€‚ Springäº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£æ˜¯ï¼š org.springframework.transaction.PlatformTransactionManager ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼ŒSpringä¸ºå„ä¸ªå¹³å°å¦‚JDBCã€Hibernateç­‰éƒ½æä¾›äº†å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°å°±æ˜¯å„ä¸ªå¹³å°è‡ªå·±çš„äº‹æƒ…äº†ã€‚ PlatformTransactionManageræ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š Public interface PlatformTransactionManager()...&#123; // Return a currently active transaction or create a new one, according to the specified propagation behaviorï¼ˆæ ¹æ®æŒ‡å®šçš„ä¼ æ’­è¡Œä¸ºï¼Œè¿”å›å½“å‰æ´»åŠ¨çš„äº‹åŠ¡æˆ–åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ã€‚ï¼‰ TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException; // Commit the given transaction, with regard to its statusï¼ˆä½¿ç”¨äº‹åŠ¡ç›®å‰çš„çŠ¶æ€æäº¤äº‹åŠ¡ï¼‰ Void commit(TransactionStatus status) throws TransactionException; // Perform a rollback of the given transactionï¼ˆå¯¹æ‰§è¡Œçš„äº‹åŠ¡è¿›è¡Œå›æ»šï¼‰ Void rollback(TransactionStatus status) throws TransactionException; &#125; Springä¸­PlatformTransactionManageræ ¹æ®ä¸åŒæŒä¹…å±‚æ¡†æ¶æ‰€å¯¹åº”çš„æ¥å£å®ç°ç±» TransactionDefinitionï¼š äº‹åŠ¡å®šä¹‰ä¿¡æ¯(äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™)äº‹åŠ¡ç®¡ç†å™¨æ¥å£ PlatformTransactionManager é€šè¿‡ getTransaction(TransactionDefinition definition) æ–¹æ³•æ¥å¾—åˆ°ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å‚æ•°æ˜¯ TransactionDefinitionç±» ï¼Œè¿™ä¸ªç±»å°±å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„äº‹åŠ¡å±æ€§ã€‚ é‚£ä¹ˆä»€ä¹ˆæ˜¯äº‹åŠ¡å±æ€§å‘¢ï¼Ÿ äº‹åŠ¡å±æ€§å¯ä»¥ç†è§£æˆäº‹åŠ¡çš„ä¸€äº›åŸºæœ¬é…ç½®ï¼Œæè¿°äº†äº‹åŠ¡ç­–ç•¥å¦‚ä½•åº”ç”¨åˆ°æ–¹æ³•ä¸Šã€‚äº‹åŠ¡å±æ€§åŒ…å«äº†5ä¸ªæ–¹é¢ã€‚ TransactionDefinitionæ¥å£ä¸­çš„æ–¹æ³•å¦‚ä¸‹ï¼š TransactionDefinitionæ¥å£ä¸­å®šä¹‰äº†5ä¸ªæ–¹æ³•ä»¥åŠä¸€äº›è¡¨ç¤ºäº‹åŠ¡å±æ€§çš„å¸¸é‡æ¯”å¦‚éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰ç­‰çš„å¸¸é‡ã€‚ æˆ‘ä¸‹é¢åªæ˜¯åˆ—å‡ºäº†TransactionDefinitionæ¥å£ä¸­çš„æ–¹æ³•è€Œæ²¡æœ‰ç»™å‡ºæ¥å£ä¸­å®šä¹‰çš„å¸¸é‡ public interface TransactionDefinition &#123; // è¿”å›äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º int getPropagationBehavior(); // è¿”å›äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡ç®¡ç†å™¨æ ¹æ®å®ƒæ¥æ§åˆ¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯ä»¥çœ‹åˆ°æœ¬äº‹åŠ¡å†…çš„å“ªäº›æ•°æ® int getIsolationLevel(); // è¿”å›äº‹åŠ¡å¿…é¡»åœ¨å¤šå°‘ç§’å†…å®Œæˆ //è¿”å›äº‹åŠ¡çš„åå­— String getName()ï¼› int getTimeout(); // è¿”å›æ˜¯å¦ä¼˜åŒ–ä¸ºåªè¯»äº‹åŠ¡ã€‚ boolean isReadOnly();&#125; TransactionStatusï¼š äº‹åŠ¡è¿è¡ŒçŠ¶æ€TransactionStatusæ¥å£ç”¨æ¥è®°å½•äº‹åŠ¡çš„çŠ¶æ€ è¯¥æ¥å£å®šä¹‰äº†ä¸€ç»„æ–¹æ³•,ç”¨æ¥è·å–æˆ–åˆ¤æ–­äº‹åŠ¡çš„ç›¸åº”çŠ¶æ€ä¿¡æ¯. PlatformTransactionManager.getTransaction(â€¦) æ–¹æ³•è¿”å›ä¸€ä¸ª TransactionStatus å¯¹è±¡ã€‚è¿”å›çš„TransactionStatus å¯¹è±¡å¯èƒ½ä»£è¡¨ä¸€ä¸ªæ–°çš„æˆ–å·²ç»å­˜åœ¨çš„äº‹åŠ¡ï¼ˆå¦‚æœåœ¨å½“å‰è°ƒç”¨å †æ ˆæœ‰ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„äº‹åŠ¡ï¼‰ã€‚ TransactionStatusæ¥å£æ¥å£å†…å®¹å¦‚ä¸‹ï¼š public interface TransactionStatus&#123; boolean isNewTransaction(); // æ˜¯å¦æ˜¯æ–°çš„äº‹ç‰© boolean hasSavepoint(); // æ˜¯å¦æœ‰æ¢å¤ç‚¹ void setRollbackOnly(); // è®¾ç½®ä¸ºåªå›æ»š boolean isRollbackOnly(); // æ˜¯å¦ä¸ºåªå›æ»š boolean isCompleted; // æ˜¯å¦å·²å®Œæˆ&#125; æ‰€è°“äº‹åŠ¡ç®¡ç†ï¼Œå…¶å®å°±æ˜¯â€œæŒ‰ç…§ç»™å®šçš„äº‹åŠ¡è§„åˆ™æ¥æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæ“ä½œâ€ã€‚ å‚è€ƒé“¾æ¥ https://juejin.im/post/5b00c52ef265da0b95276091","tags":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"}]},{"title":"volatile","date":"2018-08-30T14:28:56.000Z","path":"2018/08/30/fe4c9cb6.html","text":"volatileçš„ç”¨æ³•volatileé€šå¸¸è¢«æ¯”å–»æˆâ€è½»é‡çº§çš„synchronizedâ€œï¼Œä¹Ÿæ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå…³é”®å­—ã€‚å’Œsynchronizedä¸åŒï¼Œvolatileæ˜¯ä¸€ä¸ªå˜é‡ä¿®é¥°ç¬¦ï¼Œåªèƒ½ç”¨æ¥ä¿®é¥°å˜é‡ã€‚æ— æ³•ä¿®é¥°æ–¹æ³•åŠä»£ç å—ç­‰ã€‚ volatileçš„ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨å£°æ˜ä¸€ä¸ªå¯èƒ½è¢«å¤šçº¿ç¨‹åŒæ—¶è®¿é—®çš„å˜é‡æ—¶ï¼Œä½¿ç”¨volatileä¿®é¥°å°±å¯ä»¥äº†ã€‚ public class Singleton &#123; private volatile static Singleton singleton; private Singleton ()&#123;&#125; public static Singleton getSingleton() &#123; if (singleton == null) &#123; synchronized (Singleton.class) &#123; if (singleton == null) &#123; singleton = new Singleton(); &#125; &#125; &#125; return singleton; &#125; &#125; å¦‚ä»¥ä¸Šä»£ç ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åŒé‡é”æ ¡éªŒçš„å½¢å¼å®ç°å•ä¾‹çš„ï¼Œå…¶ä¸­ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åˆ°çš„singletonã€‚ volatileçš„åŸç† ä¸ºäº†æé«˜å¤„ç†å™¨çš„æ‰§è¡Œé€Ÿåº¦ï¼Œåœ¨å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´å¢åŠ äº†å¤šçº§ç¼“å­˜æ¥æå‡ã€‚ä½†æ˜¯ç”±äºå¼•å…¥äº†å¤šçº§ç¼“å­˜ï¼Œå°±å­˜åœ¨ç¼“å­˜æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ ä½†æ˜¯ï¼Œå¯¹äºvolatileå˜é‡ï¼Œå½“å¯¹volatileå˜é‡è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼ŒJVMä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡lockå‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªç¼“å­˜ä¸­çš„å˜é‡å›å†™åˆ°ç³»ç»Ÿä¸»å­˜ä¸­ã€‚ ä½†æ˜¯å°±ç®—å†™å›åˆ°å†…å­˜ï¼Œå¦‚æœå…¶ä»–å¤„ç†å™¨ç¼“å­˜çš„å€¼è¿˜æ˜¯æ—§çš„ï¼Œå†æ‰§è¡Œè®¡ç®—æ“ä½œå°±ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å¤šå¤„ç†å™¨ä¸‹ï¼Œä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¼šå®ç°ç¼“å­˜ä¸€è‡´æ€§åè®® ç¼“å­˜ä¸€è‡´æ€§åè®®æ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨è¦å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šå¼ºåˆ¶é‡æ–°ä»ç³»ç»Ÿå†…å­˜é‡ŒæŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜é‡Œã€‚ æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªå˜é‡è¢«volatileæ‰€ä¿®é¥°çš„è¯ï¼Œåœ¨æ¯æ¬¡æ•°æ®å˜åŒ–ä¹‹åï¼Œå…¶å€¼éƒ½ä¼šè¢«å¼ºåˆ¶åˆ·å…¥ä¸»å­˜ã€‚è€Œå…¶ä»–å¤„ç†å™¨çš„ç¼“å­˜ç”±äºéµå®ˆäº†ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä¹Ÿä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼ä»ä¸»å­˜åŠ è½½åˆ°è‡ªå·±çš„ç¼“å­˜ä¸­ã€‚è¿™å°±ä¿è¯äº†ä¸€ä¸ªvolatileåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå…¶å€¼åœ¨å¤šä¸ªç¼“å­˜ä¸­æ˜¯å¯è§çš„ã€‚ volatileä¸å¯è§æ€§å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚ Javaå†…å­˜æ¨¡å‹è§„å®šäº†æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¯¥çº¿ç¨‹ä¸­æ˜¯ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ã€‚ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„ä¼ é€’å‡éœ€è¦è‡ªå·±çš„å·¥ä½œå†…å­˜å’Œä¸»å­˜ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥è¿›è¡Œã€‚æ‰€ä»¥ï¼Œå°±å¯èƒ½å‡ºç°çº¿ç¨‹1æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œä½†æ˜¯çº¿ç¨‹2ä¸å¯è§çš„æƒ…å†µã€‚ Javaä¸­çš„volatileå…³é”®å­—æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œè¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡æ˜¯ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨volatileæ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚ volatileå¯¹äºå¯è§æ€§çš„å®ç°ï¼Œå†…å­˜å±éšœä¹Ÿèµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚å› ä¸ºå†…å­˜å±éšœç›¸å½“äºä¸€ä¸ªæ•°æ®åŒæ­¥ç‚¹ï¼Œä»–è¦ä¿è¯åœ¨è¿™ä¸ªåŒæ­¥ç‚¹ä¹‹åçš„è¯»å†™æ“ä½œå¿…é¡»åœ¨è¿™ä¸ªç‚¹ä¹‹å‰çš„è¯»å†™æ“ä½œéƒ½æ‰§è¡Œå®Œä¹‹åæ‰å¯ä»¥æ‰§è¡Œã€‚å¹¶ä¸”åœ¨é‡åˆ°å†…å­˜å±éšœçš„æ—¶å€™ï¼Œç¼“å­˜æ•°æ®ä¼šå’Œä¸»å­˜è¿›è¡ŒåŒæ­¥ï¼Œæˆ–è€…æŠŠç¼“å­˜æ•°æ®å†™å…¥ä¸»å­˜ã€æˆ–è€…ä»ä¸»å­˜æŠŠæ•°æ®è¯»å–åˆ°ç¼“å­˜ã€‚ å†…å­˜ä¸€è‡´æ€§æ¨¡å‹çš„å®ç°å¯ä»¥é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®ç°ã€‚åŒæ—¶ï¼Œç•™äº†ä¸€ä¸ªé—®é¢˜ï¼šå·²ç»æœ‰äº†ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦volatileï¼Ÿ 1ã€å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶æ¶æ„éƒ½æä¾›äº†ç›¸åŒçš„ä¸€è‡´æ€§ä¿è¯ï¼ŒJavaä½œä¸ºä¸€é—¨è·¨å¹³å°è¯­è¨€ï¼ŒJVMéœ€è¦æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è¯­ä¹‰ã€‚ 2ã€æ“ä½œç³»ç»Ÿä¸­çš„ç¼“å­˜å’ŒJVMä¸­çº¿ç¨‹çš„æœ¬åœ°å†…å­˜å¹¶ä¸æ˜¯ä¸€å›äº‹ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼šMESIå¯ä»¥è§£å†³ç¼“å­˜å±‚é¢çš„å¯è§æ€§é—®é¢˜ã€‚ä½¿ç”¨volatileå…³é”®å­—ï¼Œå¯ä»¥è§£å†³JVMå±‚é¢çš„å¯è§æ€§é—®é¢˜ã€‚ 3ã€ç¼“å­˜å¯è§æ€§é—®é¢˜çš„å»¶ä¼¸ï¼šç”±äºä¼ ç»Ÿçš„MESIåè®®çš„æ‰§è¡Œæˆæœ¬æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥CPUé€šè¿‡Store Bufferå’ŒInvalidate Queueç»„ä»¶æ¥è§£å†³ï¼Œä½†æ˜¯ç”±äºè¿™ä¸¤ä¸ªç»„ä»¶çš„å¼•å…¥ï¼Œä¹Ÿå¯¼è‡´ç¼“å­˜å’Œä¸»å­˜ä¹‹é—´çš„é€šä¿¡å¹¶ä¸æ˜¯å®æ—¶çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼“å­˜ä¸€è‡´æ€§æ¨¡å‹åªèƒ½ä¿è¯ç¼“å­˜å˜æ›´å¯ä»¥ä¿è¯å…¶ä»–ç¼“å­˜ä¹Ÿè·Ÿç€æ”¹å˜ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯ç«‹åˆ»ã€é©¬ä¸Šæ‰§è¡Œã€‚ å†™å†…å­˜å±éšœï¼ˆStore Memory Barrierï¼‰å¯ä»¥ä¿ƒä½¿å¤„ç†å™¨å°†å½“å‰store bufferï¼ˆå­˜å‚¨ç¼“å­˜ï¼‰çš„å€¼å†™å›ä¸»å­˜ã€‚ è¯»å†…å­˜å±éšœï¼ˆLoad Memory Barrierï¼‰å¯ä»¥ä¿ƒä½¿å¤„ç†å™¨å¤„ç†invalidate queueï¼ˆå¤±æ•ˆé˜Ÿåˆ—ï¼‰ã€‚ æ‰€ä»¥ï¼Œå†…å­˜å±éšœä¹Ÿæ˜¯ä¿è¯å¯è§æ€§çš„é‡è¦æ‰‹æ®µï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡å†…å­˜å±éšœä¿è¯ç¼“å­˜é—´çš„å¯è§æ€§ï¼ŒJVMé€šè¿‡ç»™volatileå˜é‡åŠ å…¥å†…å­˜å±éšœä¿è¯çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€‚è¿›è€Œé¿å…ç”±äºStore Bufferå’ŒInvalidate Queueçš„éå®æ—¶æ€§å¸¦æ¥çš„é—®é¢˜ã€‚ å†…å­˜å±éšœJavaä¸­çš„å†…å­˜å±éšœï¼šç”¨äºæ§åˆ¶ç‰¹å®šæ¡ä»¶ä¸‹çš„é‡æ’åºå’Œå†…å­˜å¯è§æ€§é—®é¢˜ã€‚Javaç¼–è¯‘å™¨ä¹Ÿä¼šæ ¹æ®å†…å­˜å±éšœçš„è§„åˆ™ç¦æ­¢é‡æ’åºã€‚ volatileä¸æœ‰åºæ€§ æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ é™¤äº†å¼•å…¥äº†æ—¶é—´ç‰‡ä»¥å¤–ï¼Œç”±äºå¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ç­‰ï¼ŒCPUè¿˜å¯èƒ½å¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼Œæ¯”å¦‚load-&gt;add-&gt;save æœ‰å¯èƒ½è¢«ä¼˜åŒ–æˆload-&gt;save-&gt;add ã€‚è¿™å°±æ˜¯å¯èƒ½å­˜åœ¨æœ‰åºæ€§é—®é¢˜ã€‚ è€Œvolatileé™¤äº†å¯ä»¥ä¿è¯æ•°æ®çš„å¯è§æ€§ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯ä»–å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–ç­‰ã€‚ æ™®é€šçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡çš„èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚ volatileå¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œè¿™å°±ä¿è¯äº†ä»£ç çš„ç¨‹åºä¼šä¸¥æ ¼æŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚è¿™å°±ä¿è¯äº†æœ‰åºæ€§ã€‚è¢«volatileä¿®é¥°çš„å˜é‡çš„æ“ä½œï¼Œä¼šä¸¥æ ¼æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œï¼Œload-&gt;add-&gt;save çš„æ‰§è¡Œé¡ºåºå°±æ˜¯ï¼šloadã€addã€saveã€‚ volatileæ˜¯é€šè¿‡å†…å­˜å±éšœæ¥æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’çš„ã€‚ å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰æ˜¯ä¸€ç±»åŒæ­¥å±éšœæŒ‡ä»¤ï¼Œæ˜¯CPUæˆ–ç¼–è¯‘å™¨åœ¨å¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œã€‚ä¸‹è¡¨æè¿°äº†å’Œvolatileæœ‰å…³çš„æŒ‡ä»¤é‡æ’ç¦æ­¢è¡Œä¸ºï¼š å¯ä»¥çœ‹å‡ºï¼š å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileå†™ä¹‹åã€‚ å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileè¯»ä¹‹å‰ã€‚ å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚ å…·ä½“å®ç°æ–¹å¼æ˜¯åœ¨ç¼–è¯‘æœŸç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­å¢åŠ å†…å­˜å±éšœæ¥ä¿è¯ï¼Œä¸‹é¢æ˜¯åŸºäºä¿å®ˆç­–ç•¥çš„JMMå†…å­˜å±éšœæ’å…¥ç­–ç•¥ï¼š åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœã€‚ å¯¹äºè¿™æ ·çš„è¯­å¥Store1; StoreLoad; Store2ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥æ“ä½œå¯¹å…¶å®ƒå¤„ç†å™¨å¯è§ã€‚ åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœã€‚ å¯¹äºè¿™æ ·çš„è¯­å¥Store1; StoreLoad; Load2ï¼Œåœ¨Load2åŠåç»­æ‰€æœ‰è¯»å–æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥å¯¹æ‰€æœ‰å¤„ç†å™¨å¯è§ã€‚ åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚ å¯¹äºè¿™æ ·çš„è¯­å¥Load1;LoadLoad; Load2ï¼Œåœ¨Load2åŠåç»­è¯»å–æ“ä½œè¦è¯»å–çš„æ•°æ®è¢«è®¿é—®å‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚ åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœã€‚ å¯¹äºè¿™æ ·çš„è¯­å¥Load1; LoadStore; Store2ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œè¢«åˆ·å‡ºå‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚ æ‰€ä»¥ï¼Œvolatileé€šè¿‡åœ¨volatileå˜é‡çš„æ“ä½œå‰åæ’å…¥å†…å­˜å±éšœçš„æ–¹å¼ï¼Œæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œè¿›è€Œä¿è¯å¤šçº¿ç¨‹æƒ…å†µä¸‹å¯¹å…±äº«å˜é‡çš„æœ‰åºæ€§ã€‚ volatileä¸åŸå­æ€§ åŸå­æ€§æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œè¦å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±éƒ½ä¸æ‰§è¡Œã€‚ çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚CPUæœ‰æ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œä¼šæ ¹æ®ä¸åŒçš„è°ƒåº¦ç®—æ³•è¿›è¡Œçº¿ç¨‹è°ƒåº¦ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å¾—æ—¶é—´ç‰‡ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œåœ¨æ—¶é—´ç‰‡è€—å°½ä¹‹åï¼Œå°±ä¼šå¤±å»CPUä½¿ç”¨æƒã€‚æ‰€ä»¥åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œç”±äºæ—¶é—´ç‰‡åœ¨çº¿ç¨‹é—´è½®æ¢ï¼Œå°±ä¼šå‘ç”ŸåŸå­æ€§é—®é¢˜ã€‚ synchronizedæåˆ°è¿‡ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œéœ€è¦é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤monitorenterå’Œmonitorexitï¼Œä½†æ˜¯volatileå’Œè¿™ä¸¤ä¸ªæŒ‡ä»¤ä¹‹é—´æ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„ã€‚ æ‰€ä»¥ï¼Œvolatileæ˜¯ä¸èƒ½ä¿è¯åŸå­æ€§çš„ã€‚ åœ¨ä»¥ä¸‹ä¸¤ä¸ªåœºæ™¯ä¸­å¯ä»¥ä½¿ç”¨volatileæ¥ä»£æ›¿synchronizedï¼š 1ã€è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¼šä¿®æ”¹å˜é‡çš„å€¼ã€‚ 2ã€å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚ é™¤ä»¥ä¸Šåœºæ™¯å¤–ï¼Œéƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼æ¥ä¿è¯åŸå­æ€§ï¼Œå¦‚synchronizedæˆ–è€…concurrentåŒ…ã€‚ çœ‹å¦‚ä¸‹ä»£ç ï¼š public class Test &#123; public volatile int i = 0; public void increase() &#123; i++; &#125; public static void main(String[] args) &#123; final Test test = new Test(); for(int i=0;i&lt;10;i++)&#123; new Thread()&#123; public void run() &#123; for(int j=0;j&lt;1000;j++) test.increase(); &#125;; &#125;.start(); &#125; while(Thread.activeCount()&gt;1) //ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ Thread.yield(); System.out.println(test.i); &#125;&#125; ä»¥ä¸Šä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œç„¶ååˆ†åˆ«æ‰§è¡Œ1000æ¬¡i++æ“ä½œã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œç¨‹åºçš„è¾“å‡ºç»“æœåº”è¯¥æ˜¯10000ï¼Œä½†æ˜¯ï¼Œå¤šæ¬¡æ‰§è¡Œçš„ç»“æœéƒ½å°äº10000ã€‚è¿™å…¶å®å°±æ˜¯volatileæ— æ³•æ»¡è¶³åŸå­æ€§çš„åŸå› ã€‚ ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Œé‚£å°±æ˜¯å› ä¸ºè™½ç„¶volatileå¯ä»¥ä¿è¯iåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€‚ä½†æ˜¯æ— æ³•ä¿è¯i++çš„åŸå­æ€§ã€‚ i++æ“ä½œï¼Œä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼šload i ï¼Œadd i ,save iã€‚åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œå¦‚æœè¿™ä¸‰ä¸ªæ­¥éª¤æ— æ³•æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é—®é¢˜ã€‚ å…¶ä»–ç”±äºCPUæŒ‰ç…§æ—¶é—´ç‰‡æ¥è¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„ï¼Œåªè¦æ˜¯åŒ…å«å¤šä¸ªæ­¥éª¤çš„æ“ä½œçš„æ‰§è¡Œï¼Œå¤©ç„¶å°±æ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„ã€‚å› ä¸ºè¿™ç§çº¿ç¨‹æ‰§è¡Œï¼Œåˆä¸åƒæ•°æ®åº“ä¸€æ ·å¯ä»¥å›æ»šã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¦æ‰§è¡Œçš„æ­¥éª¤æœ‰5æ­¥ï¼Œæ‰§è¡Œå®Œ3æ­¥å°±å¤±å»äº†CPUäº†ï¼Œå¤±å»åå°±å¯èƒ½å†ä¹Ÿä¸ä¼šè¢«è°ƒåº¦ï¼Œè¿™æ€ä¹ˆå¯èƒ½ä¿è¯åŸå­æ€§å‘¢ã€‚ ä¸ºä»€ä¹ˆsynchronizedå¯ä»¥ä¿è¯åŸå­æ€§ ï¼Œå› ä¸ºè¢«synchronizedä¿®é¥°çš„ä»£ç ç‰‡æ®µï¼Œåœ¨è¿›å…¥ä¹‹å‰åŠ äº†é”ï¼Œåªè¦ä»–æ²¡æ‰§è¡Œå®Œï¼Œå…¶ä»–çº¿ç¨‹æ˜¯æ— æ³•è·å¾—é”æ‰§è¡Œè¿™æ®µä»£ç ç‰‡æ®µçš„ï¼Œå°±å¯ä»¥ä¿è¯ä»–å†…éƒ¨çš„ä»£ç å¯ä»¥å…¨éƒ¨è¢«æ‰§è¡Œã€‚è¿›è€Œä¿è¯åŸå­æ€§ã€‚ ä½†æ˜¯synchronizedå¯¹åŸå­æ€§ä¿è¯ä¹Ÿä¸ç»å¯¹ï¼Œä¸€æ—¦ä»£ç è¿è¡Œå¼‚å¸¸ï¼Œä¹Ÿæ²¡åŠæ³•å›æ»šã€‚æ‰€ä»¥å‘¢ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼ŒåŸå­æ€§çš„å®šä¹‰ä¸åº”è¯¥å’Œäº‹åŠ¡ä¸­çš„åŸå­æ€§ä¸€æ ·ã€‚ä»–åº”è¯¥å®šä¹‰ä¸ºï¼šä¸€æ®µä»£ç ï¼Œæˆ–è€…ä¸€ä¸ªå˜é‡çš„æ“ä½œï¼Œåœ¨æ²¡æœ‰æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆvolatileä¸èƒ½ä¿è¯åŸå­æ€§å‘¢ï¼Ÿå› ä¸ºä»–ä¸æ˜¯é”ï¼Œä»–æ²¡åšä»»ä½•å¯ä»¥ä¿è¯åŸå­æ€§çš„å¤„ç†ã€‚å½“ç„¶å°±ä¸èƒ½ä¿è¯åŸå­æ€§äº†ã€‚","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]},{"title":"synchronized","date":"2018-08-28T14:28:56.000Z","path":"2018/08/28/edea11bc.html","text":"Javaè¯­è¨€ä¸ºäº†è§£å†³å¹¶å‘ç¼–ç¨‹ä¸­å­˜åœ¨çš„åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼Œæä¾›äº†ä¸€ç³»åˆ—å’Œå¹¶å‘å¤„ç†ç›¸å…³çš„å…³é”®å­—ï¼Œæ¯”å¦‚synchronizedã€volatileã€finalã€concurrenåŒ…ç­‰ã€‚ åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ®µè¯ï¼š synchronizedå…³é”®å­—åœ¨éœ€è¦åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§è¿™ä¸‰ç§ç‰¹æ€§çš„æ—¶å€™éƒ½å¯ä»¥ä½œä¸ºå…¶ä¸­ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œçœ‹èµ·æ¥æ˜¯â€œä¸‡èƒ½â€çš„ã€‚çš„ç¡®ï¼Œå¤§éƒ¨åˆ†å¹¶å‘æ§åˆ¶æ“ä½œéƒ½èƒ½ä½¿ç”¨synchronizedæ¥å®Œæˆã€‚ synchronizedåªæ˜¯ä¸ªå…³é”®å­—è€Œå·²ï¼Œç”¨èµ·æ¥å¾ˆç®€å•ã€‚ä¹‹æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å¤„ç†å¤šçº¿ç¨‹é—®é¢˜æ—¶å¯ä»¥ä¸ç”¨è€ƒè™‘å¤ªå¤šï¼Œå°±æ˜¯å› ä¸ºè¿™ä¸ªå…³é”®å­—å¸®æˆ‘ä»¬å±è”½äº†å¾ˆå¤šç»†èŠ‚ã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»synchronizedçš„ç”¨æ³•ã€åŸç†ï¼Œä»¥åŠå¦‚ä½•æä¾›åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ä¿éšœçš„ç­‰ã€‚ synchronizedçš„ç”¨æ³•synchronizedæ˜¯Javaæä¾›çš„ä¸€ä¸ªå¹¶å‘æ§åˆ¶çš„å…³é”®å­—ã€‚ä¸»è¦æœ‰ä¸¤ç§ç”¨æ³•ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œsynchronizedæ—¢å¯ä»¥ä¿®é¥°æ–¹æ³•ä¹Ÿå¯ä»¥ä¿®é¥°ä»£ç å—ã€‚ä»£ç å¦‚ä¸‹ï¼š public class SynchronizedDemo &#123; //åŒæ­¥æ–¹æ³• public synchronized void doSomeThing()&#123; System.out.println(&quot;Hello World&quot;); &#125; //åŒæ­¥ä»£ç å— public void doOtherThing()&#123; synchronized (SynchronizedDemo.class)&#123; System.out.println(&quot;Hello World&quot;); &#125; &#125;&#125; è¢«synchronizedä¿®é¥°çš„ä»£ç å—åŠæ–¹æ³•ï¼Œåœ¨åŒä¸€æ—¶é—´ï¼Œåªèƒ½è¢«å•ä¸ªçº¿ç¨‹è®¿é—®ã€‚ synchronizedçš„å®ç°åŸç† synchronizedï¼Œæ˜¯Javaä¸­ç”¨äºè§£å†³å¹¶å‘æƒ…å†µä¸‹æ•°æ®åŒæ­¥è®¿é—®çš„ä¸€ä¸ªå¾ˆé‡è¦çš„å…³é”®å­—ã€‚å½“æˆ‘ä»¬æƒ³è¦ä¿è¯ä¸€ä¸ªå…±äº«èµ„æºåœ¨åŒä¸€æ—¶é—´åªä¼šè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®åˆ°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨synchronizedå…³é”®å­—å¯¹ç±»æˆ–è€…å¯¹è±¡åŠ é”ã€‚ æˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œåç¼–è¯‘ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä»£ç ï¼š public class com.cayzlh.SynchronizedDemo &#123; public com.cayzlh.SynchronizedDemo(); Code: 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return public synchronized void doSomeThing(); Code: 0: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream; 3: ldc #3 // String Hello World 5: invokevirtual #4 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 8: return public void doOtherThing(); Code: 0: ldc #5 // class com/cayzlh/SynchronizedDemo 2: dup 3: astore_1 4: monitorenter 5: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream; 8: ldc #3 // String Hello World 10: invokevirtual #4 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 13: aload_1 14: monitorexit 15: goto 23 18: astore_2 19: aload_1 20: monitorexit 21: aload_2 22: athrow 23: return Exception table: from to target type 5 15 18 any 18 21 18 any&#125; å¯ä»¥çœ‹å‡ºï¼š å¯¹äºåŒæ­¥æ–¹æ³•ï¼ŒJVMé‡‡ç”¨ACC_SYNCHRONIZEDæ ‡è®°ç¬¦æ¥å®ç°åŒæ­¥ã€‚ å¯¹äºåŒæ­¥ä»£ç å—ã€‚JVMé‡‡ç”¨monitorenterã€monitorexitä¸¤ä¸ªæŒ‡ä»¤æ¥å®ç°åŒæ­¥ã€‚ åœ¨The JavaÂ® Virtual Machine Specificationä¸­æœ‰å…³äºåŒæ­¥æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—çš„å®ç°åŸç†çš„ä»‹ç»: Method-level synchronization is performed implicitly, as part of method invocation and return. A synchronized method is distinguished in the run-time constant poolâ€™s methodinfo structure by the ACCSYNCHRONIZED flag, which is checked by the method invocation instructions. When invoking a method for which ACC_SYNCHRONIZED is set, the executing thread enters a monitor, invokes the method itself, and exits the monitor whether the method invocation completes normally or abruptly. During the time the executing thread owns the monitor, no other thread may enter it. If an exception is thrown during invocation of the synchronized method and the synchronized method does not handle the exception, the monitor for the method is automatically exited before the exception is rethrown out of the synchronized method. æ–¹æ³•çº§çš„åŒæ­¥æ˜¯éšå¼çš„ã€‚åŒæ­¥æ–¹æ³•çš„å¸¸é‡æ± ä¸­ä¼šæœ‰ä¸€ä¸ªACC_SYNCHRONIZEDæ ‡å¿—ã€‚å½“æŸä¸ªçº¿ç¨‹è¦è®¿é—®æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰ACC_SYNCHRONIZEDï¼Œå¦‚æœæœ‰è®¾ç½®ï¼Œåˆ™éœ€è¦å…ˆè·å¾—ç›‘è§†å™¨é”ï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ–¹æ³•ï¼Œæ–¹æ³•æ‰§è¡Œä¹‹åå†é‡Šæ”¾ç›‘è§†å™¨é”ã€‚è¿™æ—¶å¦‚æœå…¶ä»–çº¿ç¨‹æ¥è¯·æ±‚æ‰§è¡Œæ–¹æ³•ï¼Œä¼šå› ä¸ºæ— æ³•è·å¾—ç›‘è§†å™¨é”è€Œè¢«é˜»æ–­ä½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¹¶ä¸”æ–¹æ³•å†…éƒ¨å¹¶æ²¡æœ‰å¤„ç†è¯¥å¼‚å¸¸ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸è¢«æŠ›åˆ°æ–¹æ³•å¤–é¢ä¹‹å‰ç›‘è§†å™¨é”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚ åŒæ­¥ä»£ç å—ä½¿ç”¨monitorenterå’Œmonitorexitä¸¤ä¸ªæŒ‡ä»¤å®ç°ã€‚å¯ä»¥æŠŠæ‰§è¡ŒmonitorenteræŒ‡ä»¤ç†è§£ä¸ºåŠ é”ï¼Œæ‰§è¡Œmonitorexitç†è§£ä¸ºé‡Šæ”¾é”ã€‚ æ¯ä¸ªå¯¹è±¡ç»´æŠ¤ç€ä¸€ä¸ªè®°å½•ç€è¢«é”æ¬¡æ•°çš„è®¡æ•°å™¨ã€‚æœªè¢«é”å®šçš„å¯¹è±¡çš„è¯¥è®¡æ•°å™¨ä¸º0ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ï¼ˆæ‰§è¡Œmonitorenterï¼‰åï¼Œè¯¥è®¡æ•°å™¨è‡ªå¢å˜ä¸º 1 ï¼Œå½“åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å¾—è¯¥å¯¹è±¡çš„é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨å†æ¬¡è‡ªå¢ã€‚å½“åŒä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”ï¼ˆæ‰§è¡ŒmonitorexitæŒ‡ä»¤ï¼‰çš„æ—¶å€™ï¼Œè®¡æ•°å™¨å†è‡ªå‡ã€‚å½“è®¡æ•°å™¨ä¸º0çš„æ—¶å€™ã€‚é”å°†è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿å¯ä»¥è·å¾—é”ã€‚ æ— è®ºæ˜¯ACC_SYNCHRONIZEDè¿˜æ˜¯monitorenterã€monitorexitéƒ½æ˜¯åŸºäºMonitorå®ç°çš„ï¼Œåœ¨Javaè™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitoræ˜¯åŸºäºC++å®ç°çš„ï¼Œç”±ObjectMonitorå®ç°ã€‚ ObjectMonitorç±»ä¸­æä¾›äº†å‡ ä¸ªæ–¹æ³•ï¼Œå¦‚enterã€exitã€waitã€notifyã€notifyAllç­‰ã€‚sychronizedåŠ é”çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨objectMonitorçš„enteræ–¹æ³•ï¼Œè§£é”çš„æ—¶å€™ä¼šè°ƒç”¨exitæ–¹æ³•ã€‚ synchronizedä¸æœ‰åºæ€§æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ ç”±äºå¤„ç†å™¨ä¼˜åŒ–å’ŒæŒ‡ä»¤é‡æ’ç­‰ï¼ŒCPUè¿˜å¯èƒ½å¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œï¼Œæ¯”å¦‚load-&gt;add-&gt;save æœ‰å¯èƒ½è¢«ä¼˜åŒ–æˆload-&gt;save-&gt;add ã€‚è¿™å°±æ˜¯å¯èƒ½å­˜åœ¨æœ‰åºæ€§é—®é¢˜ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œsynchronizedæ˜¯æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsynchronizedæ— æ³•é¿å…ä¸Šè¿°æåˆ°çš„é—®é¢˜ã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜è¯´synchronizedä¹Ÿæä¾›äº†æœ‰åºæ€§ä¿è¯å‘¢ï¼Ÿ Javaç¨‹åºä¸­å¤©ç„¶çš„æœ‰åºæ€§å¯ä»¥æ€»ç»“ä¸ºä¸€å¥è¯ï¼šå¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯å¤©ç„¶æœ‰åºçš„ã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚ ä»¥ä¸Šè¿™å¥è¯ä¹Ÿæ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­çš„åŸå¥ï¼Œè¿™å’Œas-if-serialè¯­ä¹‰æœ‰å…³ã€‚ as-if-serialè¯­ä¹‰çš„æ„æ€æŒ‡ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œå•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœéƒ½ä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ— è®ºå¦‚ä½•ä¼˜åŒ–ï¼Œéƒ½å¿…é¡»éµå®ˆas-if-serialè¯­ä¹‰ã€‚ ç®€å•è¯´å°±æ˜¯ï¼Œas-if-serialè¯­ä¹‰ä¿è¯äº†å•çº¿ç¨‹ä¸­ï¼ŒæŒ‡ä»¤é‡æ’æ˜¯æœ‰ä¸€å®šçš„é™åˆ¶çš„ï¼Œè€Œåªè¦ç¼–è¯‘å™¨å’Œå¤„ç†å™¨éƒ½éµå®ˆäº†è¿™ä¸ªè¯­ä¹‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚å½“ç„¶ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰é‡æ’çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬æ— é¡»å…³å¿ƒè¿™ç§é‡æ’çš„å¹²æ‰°ã€‚ æ‰€ä»¥å‘¢ï¼Œç”±äºsynchronizedä¿®é¥°çš„ä»£ç ï¼ŒåŒä¸€æ—¶é—´åªèƒ½è¢«åŒä¸€çº¿ç¨‹è®¿é—®ã€‚é‚£ä¹ˆä¹Ÿå°±æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ä¿è¯å…¶æœ‰åºæ€§ã€‚ synchronizedä¸é”ä¼˜åŒ–synchronizedå…¶å®æ˜¯å€ŸåŠ©Monitorå®ç°çš„ï¼Œåœ¨åŠ é”æ—¶ä¼šè°ƒç”¨objectMonitorçš„enteræ–¹æ³•ï¼Œè§£é”çš„æ—¶å€™ä¼šè°ƒç”¨exitæ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œåªæœ‰åœ¨JDK1.6ä¹‹å‰ï¼Œsynchronizedçš„å®ç°æ‰ä¼šç›´æ¥è°ƒç”¨ObjectMonitorçš„enterå’Œexitï¼Œè¿™ç§é”è¢«ç§°ä¹‹ä¸ºé‡é‡çº§é”ã€‚ æ‰€ä»¥ï¼Œåœ¨JDK1.6ä¸­å‡ºç°å¯¹é”è¿›è¡Œäº†å¾ˆå¤šçš„ä¼˜åŒ–ï¼Œè¿›è€Œå‡ºç°è½»é‡çº§é”ï¼Œåå‘é”ï¼Œé”æ¶ˆé™¤ï¼Œé€‚åº”æ€§è‡ªæ—‹é”ï¼Œé”ç²—åŒ–(è‡ªæ—‹é”åœ¨1.4å°±æœ‰ï¼Œåªä¸è¿‡é»˜è®¤çš„æ˜¯å…³é—­çš„ï¼Œjdk1.6æ˜¯é»˜è®¤å¼€å¯çš„)ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆçš„å…±äº«æ•°æ® ï¼Œè§£å†³ç«äº‰é—®é¢˜ã€‚","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]},{"title":"Javaå†…å­˜æ¨¡å‹çš„å®ç°","date":"2018-08-28T14:15:18.000Z","path":"2018/08/28/2e82a2db.html","text":"åœ¨Javaä¸­æä¾›äº†ä¸€ç³»åˆ—å’Œå¹¶å‘å¤„ç†ç›¸å…³çš„å…³é”®å­—ï¼Œæ¯”å¦‚volatileã€synchronizedã€finalã€concurrenåŒ…ç­‰ã€‚å…¶å®è¿™äº›å°±æ˜¯Javaå†…å­˜æ¨¡å‹å°è£…äº†åº•å±‚çš„å®ç°åæä¾›ç»™ç¨‹åºå‘˜ä½¿ç”¨çš„ä¸€äº›å…³é”®å­—ã€‚ ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ ï¼Ÿç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€å¤„ç†å™¨å™¨ä¼˜åŒ–çš„æŒ‡ä»¤é‡æ’é—®é¢˜æ˜¯ç¡¬ä»¶çš„ä¸æ–­å‡çº§å¯¼è‡´çš„ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæœºåˆ¶å¯ä»¥å¾ˆå¥½çš„è§£å†³ä¸Šé¢çš„è¿™äº›é—®é¢˜å‘¢ï¼Ÿ æœ€ç®€å•ç›´æ¥çš„åšæ³•å°±æ˜¯åºŸé™¤å¤„ç†å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–æŠ€æœ¯ã€åºŸé™¤CPUç¼“å­˜ï¼Œè®©CPUç›´æ¥å’Œä¸»å­˜äº¤äº’ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆåšè™½ç„¶å¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™å°±æœ‰ç‚¹å› å™åºŸé£Ÿäº†ã€‚ æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯å¹¶å‘ç¼–ç¨‹ä¸­å¯ä»¥æ»¡è¶³åŸå­æ€§ã€å¯è§æ€§åŠæœ‰åºæ€§ã€‚æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯â€”â€”å†…å­˜æ¨¡å‹ã€‚ ä¸ºäº†ä¿è¯å…±äº«å†…å­˜çš„æ­£ç¡®æ€§ï¼ˆå¯è§æ€§ã€æœ‰åºæ€§ã€åŸå­æ€§ï¼‰ï¼Œå†…å­˜æ¨¡å‹å®šä¹‰äº†å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¤šçº¿ç¨‹ç¨‹åºè¯»å†™æ“ä½œè¡Œä¸ºçš„è§„èŒƒã€‚é€šè¿‡è¿™äº›è§„åˆ™æ¥è§„èŒƒå¯¹å†…å­˜çš„è¯»å†™æ“ä½œï¼Œä»è€Œä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚å®ƒä¸å¤„ç†å™¨æœ‰å…³ã€ä¸ç¼“å­˜æœ‰å…³ã€ä¸å¹¶å‘æœ‰å…³ã€ä¸ç¼–è¯‘å™¨ä¹Ÿæœ‰å…³ã€‚ä»–è§£å†³äº†CPUå¤šçº§ç¼“å­˜ã€å¤„ç†å™¨ä¼˜åŒ–ã€æŒ‡ä»¤é‡æ’ç­‰å¯¼è‡´çš„å†…å­˜è®¿é—®é—®é¢˜ï¼Œä¿è¯äº†å¹¶å‘åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§ã€‚ åœ¨å¼€å‘å¤šçº¿ç¨‹çš„ä»£ç çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨synchronizedç­‰å…³é”®å­—æ¥æ§åˆ¶å¹¶å‘ï¼Œä»æ¥å°±ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„ç¼–è¯‘å™¨ä¼˜åŒ–ã€ç¼“å­˜ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚æ‰€ä»¥ï¼ŒJavaå†…å­˜æ¨¡å‹ï¼Œé™¤äº†å®šä¹‰äº†ä¸€å¥—è§„èŒƒï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—åŸè¯­ï¼Œå°è£…äº†åº•å±‚å®ç°åï¼Œä¾›å¼€å‘è€…ç›´æ¥ä½¿ç”¨ã€‚ åŸå­æ€§ åœ¨ä¸€ä¸ªæ“ä½œä¸­å°±æ˜¯cpuä¸å¯ä»¥åœ¨ä¸­é€”æš‚åœç„¶åå†è°ƒåº¦ï¼Œæ—¢ä¸è¢«ä¸­æ–­æ“ä½œï¼Œè¦ä¸æ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±ä¸æ‰§è¡Œ åœ¨Javaä¸­ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæä¾›äº†ä¸¤ä¸ªé«˜çº§çš„å­—èŠ‚ç æŒ‡ä»¤monitorenterå’Œmonitorexitã€‚è¿™ä¸¤ä¸ªå­—èŠ‚ç ï¼Œåœ¨Javaä¸­å¯¹åº”çš„å…³é”®å­—å°±æ˜¯synchronizedã€‚ å› æ­¤ï¼Œåœ¨Javaä¸­å¯ä»¥ä½¿ç”¨synchronizedæ¥ä¿è¯æ–¹æ³•å’Œä»£ç å—å†…çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚ å¯è§æ€§ å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ Javaå†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼çš„è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°çš„ã€‚ Javaä¸­çš„volatileå…³é”®å­—æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œè¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡æ˜¯ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨volatileæ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚ é™¤äº†volatileï¼ŒJavaä¸­çš„synchronizedå’Œfinalä¸¤ä¸ªå…³é”®å­—ä¹Ÿå¯ä»¥å®ç°å¯è§æ€§ã€‚åªä¸è¿‡å®ç°æ–¹å¼ä¸åŒï¼Œè¿™é‡Œä¸å†å±•å¼€äº†ã€‚ æœ‰åºæ€§ ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œ åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨synchronizedå’Œvolatileæ¥ä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚å®ç°æ–¹å¼æœ‰æ‰€åŒºåˆ«ï¼š volatileå…³é”®å­—ä¼šç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚synchronizedå…³é”®å­—ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œã€‚ ENDsynchronizedçš„ä¸€äº›è®°å½•ã€‚","tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"}]},{"title":"JVM (åƒåœ¾æ”¶é›†)","date":"2018-08-19T09:16:34.000Z","path":"2018/08/19/99ebe472.html","text":"åƒåœ¾æ”¶é›†ç®—æ³•ç»å…¸çš„åƒåœ¾å›æ”¶ç®—æ³•ä»¥ä¸‹å‡ ç§ï¼š æ ‡è®°â€“æ¸…é™¤ç®—æ³•(Mark-Sweep)å›æ”¶å‰çŠ¶æ€ï¼š å›æ”¶åçŠ¶æ€ï¼š ä¼˜ç¼ºç‚¹ï¼šä¼˜ç‚¹ï¼šç®—æ³•æ‰§è¡Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µæ ‡è®°ä¸æ¸…é™¤ï¼Œæ‰€æœ‰çš„å›æ”¶ç®—æ³•ï¼ŒåŸºæœ¬éƒ½åŸºäºæ ‡è®°å›æ”¶ç®—æ³•åšäº†æ·±åº¦ä¼˜åŒ– ç¼ºç‚¹ï¼šæ•ˆç‡é—®é¢˜ï¼Œå†…å­˜ç©ºé—´ç¢ç‰‡ï¼ˆä¸è¿ç»­çš„ç©ºé—´ï¼‰ å¤åˆ¶ç®—æ³•(Copying)å›æ”¶å‰çŠ¶æ€ï¼š Edenå†…å­˜ç©ºé—´ 8 Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1 Survivor2ç©ºé—´(Toç©ºé—´) 1 Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1 å›æ”¶åçŠ¶æ€ï¼š Survivor1ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰1 Edenå†…å­˜ç©ºé—´ä¸Survivorç©ºé—´ 8:1 ä¼˜ç¼ºç‚¹ï¼šä¼˜ç‚¹æ¯”è¾ƒæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œé¿å…äº†å›æ”¶é€ æˆçš„å†…å­˜ç¢ç‰‡é—®é¢˜ ç¼ºç‚¹ï¼šä»¥å±€éƒ¨çš„å†…å­˜ç©ºé—´ç‰ºç‰²ä¸ºä»£ä»·ï¼Œä¸è¿‡ç©ºé—´çš„æµªè´¹æ¯”è¾ƒå°ï¼Œé»˜è®¤8:1çš„æ¯”ä¾‹1æ˜¯æµªè´¹çš„ã€‚å¤åˆ¶ä¹Ÿæœ‰ä¸€å®šçš„æ•ˆç‡ä¸ç©ºé—´æˆæœ¬ æ ‡è®°æ•´ç†ç®—æ³•(Mark-Compact)å›æ”¶å‰çŠ¶æ€ï¼š å›æ”¶åçŠ¶æ€ï¼š ä¼˜ç¼ºç‚¹ï¼šä¼˜ç‚¹ï¼šé¿å…äº†ï¼Œç©ºé—´çš„æµªè´¹ï¼Œä¸å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚ ç¼ºç‚¹ï¼šæ•´ç†æ—¶å¤åˆ¶æœ‰æ•ˆç‡æˆæœ¬ã€‚â€‹ åƒåœ¾æ”¶é›†å™¨ä¸ƒç§åƒåœ¾æ”¶é›†å™¨ 1ã€ Serialï¼ˆä¸²è¡ŒGCï¼‰-XX:+UseSerialGC 2ã€ ParNewï¼ˆå¹¶è¡ŒGCï¼‰-XX:+UseParNewGC 3ã€ Parallel Scavengeï¼ˆå¹¶è¡Œå›æ”¶GCï¼‰ 4ã€ Serial Oldï¼ˆMSCï¼‰ï¼ˆä¸²è¡ŒGCï¼‰-XX:+UseSerialGC 5ã€ CMSï¼ˆå¹¶å‘GCï¼‰-XX:+UseConcMarkSweepGC 6ã€ Parallel Oldï¼ˆå¹¶è¡ŒGCï¼‰-XX:+UseParallelOldGC 7ã€ G1ï¼ˆJDK1.7update14æ‰å¯ä»¥æ­£å¼å•†ç”¨ï¼‰ è°ƒä¼˜æ–¹æ³•æ–°å¯¹è±¡é¢„ç•™æ–°ç”Ÿä»£ç”±äºfullGC(è€å¹´ä»£)çš„æˆæœ¬è¿œæ¯”minorGCï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼‰çš„æˆæœ¬å¤§ï¼Œæ‰€ä»¥ç»™åº”ç”¨åˆ†é…ä¸€ä¸ªåˆç†çš„æ–°ç”Ÿä»£ç©ºé—´ï¼Œå°½é‡å°†å¯¹è±¡åˆ†é…åˆ°æ–°ç”Ÿä»£å‡å°fullGCçš„é¢‘ç‡ å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£å°†å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼Œä¿æŒæ–°ç”Ÿä»£å¯¹è±¡çš„ç»“æ„çš„å®Œæ•´æ€§ï¼Œä»¥æé«˜GCæ•ˆç‡ï¼Œ ä»¥é€šè¿‡-XX:PretenureSizeThresholdè®¾ç½®è¿›å…¥è€å¹´ä»£çš„é˜€å€¼ ç¨³å®šä¸éœ‡è¡çš„å †å¤§å°ç¨³å®šçš„å¯¹å¤§å°æ˜¯å¯¹åƒåœ¾å›æ”¶æœ‰åˆ©çš„ï¼Œæ–¹æ³•å°†-Xmså’Œ-Xmxçš„å¤§å°ä¸€è‡´ ååé‡ä¼˜å…ˆå°½å¯èƒ½å‡å°‘ç³»ç»Ÿæ‰§è¡Œåƒåœ¾å›æ”¶çš„æ€»æ—¶é—´ï¼Œæ•…é‡‡ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶å™¨ -XX:+UseParallelGCæˆ–ä½¿ç”¨-XX:+UseParallelOldGC é™ä½åœé¡¿ä½¿ç”¨CMSå›æ”¶å™¨,åŒæ—¶å‡å°‘fullGCçš„æ¬¡æ•° è·å–gcä¿¡æ¯çš„æ–¹æ³• -verbose:gcæˆ–è€…-XX:+PrintGC è·å–gcä¿¡æ¯ -XX:+PrintGCDetails è·å–æ›´åŠ è¯¦ç»†çš„gcä¿¡æ¯ -XX:+PrintGCTimeStamps è·å–GCçš„é¢‘ç‡å’Œé—´éš” -XX:+PrintHeapAtGC è·å–å †çš„ä½¿ç”¨æƒ…å†µ -Xloggc:D:\\gc.log æŒ‡å®šæ—¥å¿—æƒ…å†µçš„ä¿å­˜è·¯å¾„ jvmè°ƒä¼˜å®æˆ˜-tomcatå¯åŠ¨åŠ é€Ÿåœ¨tomcatçš„bin/catalina.batæ–‡ä»¶çš„å¼€å¤´æ·»åŠ ç›¸å…³çš„é…ç½®","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]},{"title":"JVM (å†…å­˜åŒºåŸŸæ§åˆ¶å‚æ•°åŠå¯¹åº”æº¢å‡ºå¼‚å¸¸)","date":"2018-08-19T09:16:34.000Z","path":"2018/08/19/95c0309a.html","text":"å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ–ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ¯æ¬¡é‡åˆ°OutOfMemoryå¼‚å¸¸æˆ–GCå¼‚å¸¸æˆ–StackOverflowErrorå¼‚å¸¸æˆ‘ä»¬éƒ½æ˜¯ä¸€å †å‚æ•°ä¹±é…ï¼Œéƒ½æŠŠå€¼è°ƒå¤§ï¼Œåªæ˜¯å¤§ä½“çŸ¥é“æ˜¯è·Ÿjvmå†…å­˜åˆ†é…æœ‰å…³, å…·ä½“åº”è¯¥æ€ä¹ˆè°ƒï¼Œå¯¹åº”çš„å¼‚å¸¸åº”è¯¥è°ƒæ•´é‚£äº›å‚æ•°ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œjvmå†…å­˜åˆ†é…åŒºåŸŸä¸­éƒ½åˆ†åˆ«å¯¹åº”é‚£äº›å‚æ•°å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä¸çŸ¥é“çš„ï¼Œåªæ˜¯æŠŠç›¸å…³çš„å‚æ•°è·³ä¸Šå»ï¼Œé¢„æœŸç»“æœéƒ½æ˜¯åº”è¯¥èµ·ä½œç”¨ï¼Œåˆ°åº•èƒ½ä¸èƒ½èµ·ä½œç”¨ï¼Œè‡ªå·±å¿ƒé‡Œä¹Ÿæ²¡åº•ã€‚ä¸‹é¢å°±æ¥è¯´ä¸€ä¸‹jvmå †ã€æ ˆã€æ–¹æ³•åŒºç­‰å†…å­˜åŒºåŸŸå¯¹åº”çš„å‚æ•°ï¼ŒåŠæ¯ä¸ªåŒºåŸŸå¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå‘ç”Ÿå¼‚å¸¸çš„åœºæ™¯åˆ†æã€‚ å‚æ•°ç±»å‹ å †ç©ºé—´å‚æ•° æ ˆç©ºé—´å‚æ•° æ–¹æ³•åŒºç©ºé—´å‚æ•° æœ¬æœºç›´æ¥å†…å­˜å‚æ•° å¼‚å¸¸ç±»å‹ 1.OutOfMemoryå¼‚å¸¸ 2.StackOverflowErrorå¼‚å¸¸ è¾…åŠ©å‚æ•°è¯´æ˜ -XX:+HeapDumpOnOutOfMemoryError æ‰“å°å †å†…å­˜å¼‚å¸¸æ—¶æ‰“å°å‡ºå¿«ç…§ä¿¡æ¯ -XX:+HeapDumpPath å¿«ç…§è¾“å‡ºè·¯å¾„ -XmnæŒ‡å®šedenåŒºçš„å¤§å° -XX:SurvirorRationæ¥è°ƒæ•´å¹¸å­˜åŒºçš„å¤§å° -XX:PretenureSizeThresholdè®¾ç½®è¿›å…¥è€å¹´ä»£çš„é˜€å€¼ å‚æ•°è¯´æ˜ã€å¯¹åº”åœºæ™¯çš„å¼‚å¸¸å †å†…å­˜å‚æ•°-Xmsï¼šå †æœ€å°å€¼ï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹å’Œï¼‰ -Xmxï¼šå †æœ€å¤§å€¼ï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹å’Œï¼‰ å½“æœ€å°å€¼=æœ€å¤§å€¼æ—¶ï¼Œè¿™æ—¶å †å†…å­˜æ˜¯ä¸å¯æ‰©å±•çš„ã€‚ ä¾‹ï¼š-Xms80M -Xmx80M é€šå¸¸å°†-Xmxå’Œ-Xmsè®¾ç½®ä¸ºä¸€æ ·çš„å¤§å°æ¥å‡å°‘gcçš„æ¬¡æ•°ï¼Œå †å†…å­˜ä¸è¶³æ—¶æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ æ ˆå†…å­˜å‚æ•°-Xss ä¾‹ï¼š-Xss128k å•çº¿ç¨‹ä¸‹æ— è®ºæ ˆå¸§å¤ªå¤§è¿˜æ˜¯æ ˆå®¹é‡å¤ªå°ï¼ŒåŠå¼•ç”¨æ·±åº¦è¶…è¿‡è™šæ‹Ÿæœºå…è®¸æ·±åº¦éƒ½ä¼šæŠ›å‡ºStackOverflowErroræ¯ä¸ªæ–¹æ³•å‹å…¥æ ˆçš„å¸§å¤§å°æ˜¯ä¸ä¸€è‡´çš„ã€‚å¤šçº¿ç¨‹ä¸‹å½“æ¯ä¸ªçº¿ç¨‹åˆ†é…æ ˆå¸§å¤ªå¤§å†…å­˜ä¸èƒ½å¤Ÿæ‰©å±•æ—¶æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸çº¿ç¨‹æ ˆå¸§è¶Šå¤§ï¼Œå¯åˆ›å»ºçš„çº¿ç¨‹è¶Šå°‘ã€‚ æ–¹æ³•åŒºå‚æ•°-XX:PermSizeæ–¹æ³•åŒºå†…å­˜æœ€å°å€¼ -XX:MaxPermSize æ–¹æ³•åŒºå†…å­˜æœ€å¤§å€¼ å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œä¸»è¦ç”¨æ¥å­˜å‚¨ç±»çš„å…ƒæ•°æ®ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ® ä¾‹ï¼š-XX:PermSize=20M -XX:MaxPermSize=20M å¼‚å¸¸ç±»å‹ OutOfMemoryError : åŸå› ï¼šå¸¸é‡è¿‡å¤šï¼Œæˆ–ä»£ç†åå°„ç­‰ä½¿ç”¨é¢‘ç¹ æœ¬æœºç›´æ¥å†…å­˜å‚æ•°-XX:MaxDirectMemorySize ä¾‹ï¼š-XX:MaxDirectMemorySize=10M ä¸è¶³æ—¶æŠ›å‡ºOutOfMemoryå¼‚å¸¸","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]},{"title":"JVM (å¯¹è±¡è®¿é—®å†…éƒ¨å®ç°è¿‡ç¨‹)","date":"2018-08-19T09:16:34.000Z","path":"2018/08/19/e43d0ef1.html","text":"å¯¹è±¡è®¿é—® æ¶‰åŠåˆ°å¯¹è±¡çš„åœ°å€å˜æ›´çŠ¶æ€å˜æ›´ï¼Œå†…å­˜åœ°å€ç§»åŠ¨ï¼Œå˜é‡ã€æ¥å£ã€å®ç°ç±»ã€æ–¹æ³•ã€çˆ¶ç±»å‹ç­‰ã€‚ å¥æŸ„æ–¹å¼ (è®¿é—®) æŒ‡é’ˆæ–¹å¼ (è®¿é—®) ä¼˜ç¼ºç‚¹å¥æŸ„è®¿é—®æ–¹å¼ï¼šreferenceä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„åœ°å€ï¼Œå¯¹è±¡å˜æ›´æ—¶åªä¼šæ”¹å˜å¥æŸ„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œå¼•ç”¨æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚ æŒ‡é’ˆè®¿é—®æ–¹å¼ï¼šä¼˜ç‚¹é€Ÿåº¦å¿«ï¼ŒèŠ‚çœäº†æŒ‡é’ˆå®šä½æ—¶é—´å¼€é”€ã€‚","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]},{"title":"JVM (è™šæ‹Ÿæœºå†…å­˜)","date":"2018-08-19T09:16:34.000Z","path":"2018/08/19/b8276f2d.html","text":"JAVAç¨‹åºè¿è¡Œä¸è™šæ‹Ÿæœºä¹‹ä¸Šï¼Œè¿è¡Œæ—¶éœ€è¦å†…å­˜ç©ºé—´ã€‚è™šæ‹Ÿæœºæ‰§è¡ŒJAVAç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºä¸åŒçš„æ•°æ®åŒºåŸŸæ–¹ä¾¿ç®¡ç†ã€‚ è™šæ‹Ÿæœºç®¡ç†å†…å­˜æ•°æ®åŒºåŸŸåˆ’åˆ†å¦‚ä¸‹å›¾ï¼š æ•°æ®åŒºåŸŸåˆ†ç±»: æ–¹æ³•åŒºï¼š(Method Area) è™šæ‹Ÿæœºæ ˆï¼š(VM Stack) æœ¬åœ°æ–¹æ³•æ ˆ ï¼š(Native Method Stack) å †ï¼š(Heap) ç¨‹åºè®¡æ•°å™¨ ï¼š(Program Counter Register) ç›´æ¥å†…å­˜ï¼š(Direct Memory) è¯´æ˜ï¼š ç¨‹åºè®¡æ•°å™¨è¡Œå·æŒ‡ç¤ºå™¨ï¼Œå­—èŠ‚ç æŒ‡ä»¤çš„åˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤(CPUåˆ‡æ¢)ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ï¼Œçº¿ç¨‹ç§æœ‰å†…å­˜äº’ä¸å½±å“,è¯¥åŒºåŸŸä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ è™šæ‹Ÿæœºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå£°æ˜å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œè™šæ‹Ÿæœºæ ˆæ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œå³æ–¹æ³•è¿è¡ŒæœŸé—´çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚æ ˆå¸§ç”¨äºå­˜å‚¨ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ï¼Œæ¯ä¸ªæ–¹æ³•æ‰§è¡Œä¸­éƒ½å¯¹åº”è™šæ‹Ÿæœºæ ˆå¸§ä»å…¥æ ˆåˆ°å¤„æ ˆçš„è¿‡ç¨‹ã€‚ æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯è™šæ‹Ÿæœºä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼Œå¯¹åº”ç‰©ç†å±‚ä¹‹ä¸Šçš„ç¨‹åºæ•°æ®æ¨¡å‹ã€‚ å±€éƒ¨å˜é‡è¡¨ï¼Œæ˜¯ä¸€ç§ç¨‹åºè¿è¡Œæ•°æ®æ¨¡å‹ï¼Œå­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»å‹ä¾‹å¦‚ï¼š Booleanã€byteã€charã€shortã€intã€floatã€longã€doubleã€å¯¹è±¡å¼•ç”¨ç±»å‹(å¯¹è±¡å†…å­˜åœ°å€å˜é‡ï¼ŒæŒ‡é’ˆæˆ–å¥æŸ„)ã€‚ç¨‹åºè¿è¡Œæ—¶ï¼Œæ ¹æ®å±€éƒ¨å˜é‡è¡¨åˆ†é…æ ˆå¸§ç©ºé—´å¤§å°ï¼Œåœ¨è¿è¡Œä¸­ï¼Œå¤§å°æ˜¯ä¸å˜çš„å¼‚å¸¸ç±»å‹ï¼šstackOverFlowError çº¿ç¨‹è¯·æ±‚æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºå…è®¸æ·±åº¦ OutOfMemory å†…å­˜ç©ºé—´è€—å°½æ— æ³•è¿›è¡Œæ‰©å±•ã€‚ æœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œè™šæ‹Ÿæœºæ ˆä¸ºJavaç¨‹åºæœåŠ¡ï¼Œæœ¬åœ°æ–¹æ³•æ ˆæ”¯æŒè™šæ‹Ÿæœºçš„è¿è¡ŒæœåŠ¡ï¼Œå…·ä½“å®ç°ç”±è™šæ‹Ÿæœºå‚å•†å†³å®šï¼Œä¹Ÿä¼šæŠ›å‡º stackOverFlowErrorã€OutOfMemoryå¼‚å¸¸ã€‚ å †æ˜¯è™šæ‹Ÿæœºç®¡ç†å†…å­˜ä¸­æœ€å¤§çš„ä¸€éƒ¨åˆ†ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹(å¯¹è±¡ã€æ•°ç»„)ï¼Œç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç”±äºGCæ”¶é›†å™¨ï¼Œåˆ†ä»£æ”¶é›†ã€‚æ‰€ä»¥åˆ’åˆ†ä¸ºï¼šæ–°ç”Ÿä»£ Edenã€From SurVivorç©ºé—´ã€To SurVivorç©ºé—´ï¼Œallot buffer(åˆ†é…ç©ºé—´)ï¼Œå¯èƒ½ä¼šåˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼Œè€å¹´ä»£ã€‚ æ–¹æ³•åŒºä¸å †ä¸€æ ·å±äºçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ï¼ˆåŠ¨æ€åŠ è½½OSGIï¼‰ç­‰æ•°æ®ã€‚ç†è®ºä¸Šå±äºjavaè™šæ‹Ÿæœºçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†åŒºåˆ†å¼€æ¥å«åš Non-Heapéå †ã€‚ è¿™ä¸ªåŒºåŸŸå¯ä»¥é€‰æ‹©ä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¯¥åŒºåŸŸå›æ”¶ç›®çš„ä¸»è¦æ˜¯å¸¸é‡æ± çš„å›æ”¶ï¼ŒåŠç±»å‹çš„å¸è½½class,å†…å­˜åŒºä¸è¶³æ—¶ä¼šæŠ›å‡ºOutOfMemoryå¼‚å¸¸ è¿è¡Œæ—¶å¸¸é‡æ± ï¼š æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼ŒClassçš„ç‰ˆæœ¬ã€å­—æ®µã€æ¥å£ã€æ–¹æ³•ç­‰ï¼ŒåŠç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ã€ç¬¦å·å¼•ç”¨ï¼Œç¼–è¯‘ç±»åŠ è½½åå­˜æ”¾åœ¨è¯¥åŒºåŸŸã€‚ä¼šæŠ›å‡ºOutOfMemoryå¼‚å¸¸ã€‚ ç›´æ¥å†…å­˜ç›´æ¥å†…å­˜ä¸å±äºè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œæ˜¯ä¸€ç§åŸºäºé€šé“ä¸ç¼“å†²åŒºçš„IOæ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°å‡½æ•°ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œåœ¨å †ä¸­å­˜å‚¨å¼•ç”¨çš„å¤–éƒ¨å†…å­˜åœ°å€ï¼Œé€šè¿‡å¼•ç”¨å®Œæˆå¯¹ç›´æ¥å¼•ç”¨å†…å­˜çš„æ“ä½œã€‚1.4ä¹‹åæä¾›çš„NIOæ˜¾è‘—æé«˜æ•ˆç‡ï¼Œé¿å…äº†å †å†…å­˜ä¸Nativeå†…å­˜çš„æ¥å›å¤åˆ¶æ“ä½œï¼Œä¸å—è™šæ‹Ÿæœºå†…å­˜æ§åˆ¶ï¼Œä¼šæŠ›å‡ºOUtOfMemoryå¼‚å¸¸ã€‚","tags":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"}],"categories":[{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}]}],"categories":[{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/categories/Spring/"},{"name":"ä¹¦ç±","slug":"ä¹¦ç±","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/"},{"name":"ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹","slug":"ä¹¦ç±/ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AElasticsearch%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ä¹¦ç±/ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"æ¡†æ¶","slug":"æ¡†æ¶","permalink":"https://www.cayzlh.com/categories/%E6%A1%86%E6%9E%B6/"},{"name":"MyBatis","slug":"æ¡†æ¶/MyBatis","permalink":"https://www.cayzlh.com/categories/%E6%A1%86%E6%9E%B6/MyBatis/"},{"name":"ã€ŠSpringæºç åˆ†æã€‹","slug":"Spring/ã€ŠSpringæºç åˆ†æã€‹","permalink":"https://www.cayzlh.com/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"name":"Docker","slug":"å¾®æœåŠ¡/Docker","permalink":"https://www.cayzlh.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Docker/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/categories/Java/"},{"name":"Javaè®¾è®¡æ¨¡å¼","slug":"Java/Javaè®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"SpringCloud","slug":"Spring/SpringCloud","permalink":"https://www.cayzlh.com/categories/Spring/SpringCloud/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ä¹¦ç±/ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://www.cayzlh.com/categories/Java/JVM/"}],"tags":[{"name":"è½¬è½½","slug":"è½¬è½½","permalink":"https://www.cayzlh.com/tags/%E8%BD%AC%E8%BD%BD/"},{"name":"MyBatis","slug":"MyBatis","permalink":"https://www.cayzlh.com/tags/MyBatis/"},{"name":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","slug":"ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"},{"name":"æ ¸å¿ƒå¤„ç†å±‚","slug":"æ ¸å¿ƒå¤„ç†å±‚","permalink":"https://www.cayzlh.com/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/"},{"name":"Spring","slug":"Spring","permalink":"https://www.cayzlh.com/tags/Spring/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://www.cayzlh.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"æºç å­¦ä¹ ","slug":"æºç å­¦ä¹ ","permalink":"https://www.cayzlh.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"},{"name":"æ­»ç£•Spring","slug":"æ­»ç£•Spring","permalink":"https://www.cayzlh.com/tags/%E6%AD%BB%E7%A3%95Spring/"},{"name":"åŸºç¡€æ”¯æŒå±‚","slug":"åŸºç¡€æ”¯æŒå±‚","permalink":"https://www.cayzlh.com/tags/%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81%E5%B1%82/"},{"name":"Docker","slug":"Docker","permalink":"https://www.cayzlh.com/tags/Docker/"},{"name":"Java","slug":"Java","permalink":"https://www.cayzlh.com/tags/Java/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"https://www.cayzlh.com/tags/SpringCloud/"},{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://www.cayzlh.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"},{"name":"JVM","slug":"JVM","permalink":"https://www.cayzlh.com/tags/JVM/"},{"name":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","slug":"ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹","permalink":"https://www.cayzlh.com/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"}]}