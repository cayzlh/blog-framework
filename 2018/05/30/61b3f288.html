<!DOCTYPE html>
<html lang="en">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="åŸºäºRedisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBootå®ç°Redisåˆ†å¸ƒå¼é”">
<meta property="og:url" content="https://www.cayzlh.com/blog">
<meta property="og:site_name" content="CAYZLH">
<meta property="og:description" content="åŸºäºRedisçš„åˆ†å¸ƒå¼äº‹åŠ¡é”">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-05-30T14:14:43.000Z">
<meta property="article:modified_time" content="2020-06-22T01:29:05.800Z">
<meta property="article:author" content="ğŸ³Antä¸¶">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/blog/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>SpringBootå®ç°Redisåˆ†å¸ƒå¼é”</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/blog/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/blog/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/blog/true" title="CAYZLH" type="application/atom+xml">
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/blog/">Home</a></li>
        
          <li><a href="/blog/archives/">Articles</a></li>
        
          <li><a href="/blog/about/">About</a></li>
        
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/blog/2018/06/02/5d83f396.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/blog/2018/05/28/dd9b08f1.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
<!--        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>-->
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous</span>
      <span id="i-next" class="info" style="display:none;">Next</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://www.cayzlh.com/2018/05/30/61b3f288.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&text=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&is_video=false&description=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”&body=Check out this article: https://www.cayzlh.com/2018/05/30/61b3f288.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&name=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://www.cayzlh.com/2018/05/30/61b3f288.html&t=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7-From"><span class="toc-number">3.</span> <span class="toc-text">å¯é æ€§(From)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpringBoot%E5%B7%A5%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%B3%A8%E8%A7%A3%E7%B1%BB"><span class="toc-number">5.2.</span> <span class="toc-text">å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.</span> <span class="toc-text">å®šä¹‰æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">5.4.</span> <span class="toc-text">å®šä¹‰æŠ½è±¡ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.5.</span> <span class="toc-text">å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E9%85%8DDistributeLock"><span class="toc-number">5.6.</span> <span class="toc-text">è£…é…DistributeLock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2"><span class="toc-number">5.7.</span> <span class="toc-text">å®šä¹‰åˆ‡é¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.8.</span> <span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AElog4j%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.9.</span> <span class="toc-text">é…ç½®log4jé…ç½®æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C"><span class="toc-number">6.</span> <span class="toc-text">å®Œ</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SpringBootå®ç°Redisåˆ†å¸ƒå¼é”
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ğŸ³Antä¸¶</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-05-30T14:14:43.000Z" itemprop="datePublished">2018-05-30</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/blog/categories/Spring/">Spring</a> â€º <a class="category-link" href="/blog/categories/Spring/SpringBoot/">SpringBoot</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/blog/tags/Java/" rel="tag">Java</a>, <a class="tag-link-link" href="/blog/tags/Redis/" rel="tag">Redis</a>, <a class="tag-link-link" href="/blog/tags/SpringBoot/" rel="tag">SpringBoot</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>æœ€è¿‘é¡¹ç›®ä¸­æœ‰ç”¨åˆ°rediså®ç°çš„åˆ†å¸ƒå¼é”, ä½†æ˜¯èƒ†ç å†™èµ·æ¥æ¯”è¾ƒç¹ç, å°±æƒ³ç€æ•´ä¸€å¥—æ³¨è§£çš„æ–¹å¼å®ç°çš„åˆ†å¸ƒå¼é”</p>
</blockquote>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åˆ†å¸ƒå¼é”ä¸€èˆ¬æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š1. æ•°æ®åº“ä¹è§‚é”ï¼›2. åŸºäºRedisçš„åˆ†å¸ƒå¼é”ï¼›3. åŸºäºZooKeeperçš„åˆ†å¸ƒå¼é”ã€‚æœ¬æ–‡ä»‹ç»åŸºäºRediså®ç°åˆ†å¸ƒå¼é”ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”"></a>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”</h3><p>åœ¨å•æœºæ—¶ä»£ï¼Œè™½ç„¶ä¸éœ€è¦åˆ†å¸ƒå¼é”ï¼Œä½†ä¹Ÿé¢ä¸´è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œåªä¸è¿‡åœ¨å•æœºçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¦åŒæ—¶è®¿é—®æŸä¸ªå…±äº«èµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨çº¿ç¨‹é—´åŠ é”çš„æœºåˆ¶ï¼Œå³å½“æŸä¸ªçº¿ç¨‹è·å–åˆ°è¿™ä¸ªèµ„æºåï¼Œå°±ç«‹å³å¯¹è¿™ä¸ªèµ„æºè¿›è¡ŒåŠ é”ï¼Œå½“ä½¿ç”¨å®Œèµ„æºä¹‹åï¼Œå†è§£é”ï¼Œå…¶å®ƒçº¿ç¨‹å°±å¯ä»¥æ¥ç€ä½¿ç”¨äº†ã€‚ä¾‹å¦‚ï¼Œåœ¨JAVAä¸­ï¼Œç”šè‡³ä¸“é—¨æä¾›äº†ä¸€äº›å¤„ç†é”æœºåˆ¶çš„ä¸€äº›APIï¼ˆsynchronize/Lockç­‰ï¼‰ã€‚</p>
<p>ä½†æ˜¯åˆ°äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶ä»£ï¼Œè¿™ç§çº¿ç¨‹ä¹‹é—´çš„é”æœºåˆ¶ï¼Œå°±æ²¡ä½œç”¨äº†ï¼Œç³»ç»Ÿå¯èƒ½ä¼šæœ‰å¤šä»½å¹¶ä¸”éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™äº›èµ„æºå·²ç»ä¸æ˜¯åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«äº†ï¼Œè€Œæ˜¯å±äºè¿›ç¨‹ä¹‹é—´å…±äº«çš„èµ„æºã€‚</p>
<p>å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¼•å…¥ã€Œåˆ†å¸ƒå¼é”ã€ã€‚</p>
<p>åˆ†å¸ƒå¼é”ï¼Œæ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼çš„éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œé€šè¿‡é”æœºåˆ¶æ¥è®©å¤šå®¢æˆ·ç«¯äº’æ–¥çš„å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®ã€‚</p>
<p>åˆ†å¸ƒå¼é”è¦æ»¡è¶³å“ªäº›è¦æ±‚å‘¢ï¼Ÿ</p>
<ul>
<li>æ’ä»–æ€§ï¼šåœ¨åŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å–åˆ°é”ï¼Œå…¶å®ƒå®¢æˆ·ç«¯æ— æ³•åŒæ—¶è·å–</li>
<li>é¿å…æ­»é”ï¼šè¿™æŠŠé”åœ¨ä¸€æ®µæœ‰é™çš„æ—¶é—´ä¹‹åï¼Œä¸€å®šä¼šè¢«é‡Šæ”¾ï¼ˆæ­£å¸¸é‡Šæ”¾æˆ–å¼‚å¸¸é‡Šæ”¾ï¼‰</li>
<li>é«˜å¯ç”¨ï¼šè·å–æˆ–é‡Šæ”¾é”çš„æœºåˆ¶å¿…é¡»é«˜å¯ç”¨ä¸”æ€§èƒ½ä½³</li>
</ul>
<h3 id="å¯é æ€§-From"><a href="#å¯é æ€§-From" class="headerlink" title="å¯é æ€§(From)"></a>å¯é æ€§(<a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.importnew.com/27477.html">From</a>)</h3><p>é¦–å…ˆï¼Œä¸ºäº†ç¡®ä¿åˆ†å¸ƒå¼é”å¯ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘è¦ç¡®ä¿é”çš„å®ç°åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>äº’æ–¥æ€§ã€‚åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚</li>
<li>ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚å³ä½¿æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒè€Œæ²¡æœ‰ä¸»åŠ¨è§£é”ï¼Œä¹Ÿèƒ½ä¿è¯åç»­å…¶ä»–å®¢æˆ·ç«¯èƒ½åŠ é”ã€‚</li>
<li>å…·æœ‰å®¹é”™æ€§ã€‚åªè¦å¤§éƒ¨åˆ†çš„RedisèŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥åŠ é”å’Œè§£é”ã€‚</li>
<li>è§£é“ƒè¿˜é¡»ç³»é“ƒäººã€‚åŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è‡ªå·±ä¸èƒ½æŠŠåˆ«äººåŠ çš„é”ç»™è§£äº†</li>
</ol>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸºäº<code>Redis</code>å®ç°çš„é”æœºåˆ¶ï¼Œä¸»è¦æ˜¯ä¾èµ–<code>Redis</code>è‡ªèº«çš„åŸå­æ“ä½œï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET user_key user_value NX PX 100</span><br></pre></td></tr></table></figure>
<p>redisä»2.6.12ç‰ˆæœ¬å¼€å§‹ï¼ŒSETå‘½ä»¤æ‰æ”¯æŒè¿™äº›å‚æ•°ï¼š<br><strong>NX</strong>ï¼šåªåœ¨åœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œï¼ŒSET key value NX æ•ˆæœç­‰åŒäº SETNX key value<br><strong>PX millisecond</strong>ï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸ºmillisecondæ¯«ç§’ï¼Œå½“è¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼Œè®¾ç½®çš„é”®ä¼šè‡ªåŠ¨å¤±æ•ˆ</p>
<p>ä¸Šè¿°ä»£ç ç¤ºä¾‹æ˜¯æŒ‡ï¼Œ<br>å½“<code>redis</code>ä¸­ä¸å­˜åœ¨<code>user_key</code>è¿™ä¸ªé”®çš„æ—¶å€™ï¼Œæ‰ä¼šå»è®¾ç½®ä¸€ä¸ª<code>user_key</code>é”®ï¼Œå¹¶ä¸”ç»™è¿™ä¸ªé”®çš„å€¼è®¾ç½®ä¸º <code>user_value</code>ï¼Œä¸”è¿™ä¸ªé”®çš„å­˜æ´»æ—¶é—´ä¸º<code>100ms</code></p>
<p><strong>ä¸ºä»€ä¹ˆè¿™ä¸ªå‘½ä»¤å¯ä»¥å¸®æˆ‘ä»¬å®ç°é”æœºåˆ¶å‘¢ï¼Ÿ</strong><br>å› ä¸ºè¿™ä¸ªå‘½ä»¤æ˜¯åªæœ‰åœ¨æŸä¸ªkeyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡ŒæˆåŠŸã€‚é‚£ä¹ˆå½“å¤šä¸ªè¿›ç¨‹åŒæ—¶å¹¶å‘çš„å»è®¾ç½®åŒä¸€ä¸ªkeyçš„æ—¶å€™ï¼Œå°±æ°¸è¿œåªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹æˆåŠŸã€‚<br>å½“æŸä¸ªè¿›ç¨‹è®¾ç½®æˆåŠŸä¹‹åï¼Œå°±å¯ä»¥å»æ‰§è¡Œä¸šåŠ¡é€»è¾‘äº†ï¼Œç­‰ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå†å»è¿›è¡Œè§£é”ã€‚</p>
<p>è§£é”å¾ˆç®€å•ï¼Œåªéœ€è¦åˆ é™¤è¿™ä¸ª<code>key</code>å°±å¯ä»¥äº†ï¼Œä¸è¿‡åˆ é™¤ä¹‹å‰éœ€è¦åˆ¤æ–­ï¼Œè¿™ä¸ª<code>key</code>å¯¹åº”çš„<code>value</code>æ˜¯å½“åˆè‡ªå·±è®¾ç½®çš„é‚£ä¸ªã€‚</p>
<p>å¦å¤–ï¼Œé’ˆå¯¹redisé›†ç¾¤æ¨¡å¼çš„åˆ†å¸ƒå¼é”ï¼Œå¯ä»¥é‡‡ç”¨redisçš„<code>Redlock</code>æœºåˆ¶ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹"><a href="#åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹" class="headerlink" title="åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹"></a>åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹</h4><p>ä¿®æ”¹<code>pom.xml</code>æ–‡ä»¶, æ·»åŠ å¦‚ä¸‹ä¾èµ–åŒ…:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»"><a href="#å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»" class="headerlink" title="å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»"></a>å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DistributeLock &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”çš„èµ„æºï¼Œkeyã€‚</span></span><br><span class="line"><span class="comment">     *  æ”¯æŒspring Elè¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;name&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&#x27;<span class="keyword">default</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”çš„èµ„æºï¼Œvalueã€‚</span></span><br><span class="line"><span class="comment">     *  æ”¯æŒspring Elè¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&#x27;<span class="keyword">default</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒé”æ—¶é—´,å•ä½æ¯«ç§’</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">keepMills</span><span class="params">()</span> <span class="keyword">default</span> 5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“è·å–å¤±è´¥æ—¶å€™åŠ¨ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LockFailAction <span class="title">action</span><span class="params">()</span> <span class="keyword">default</span> LockFailAction.CONTINUE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">LockFailAction</span></span>&#123;</span><br><span class="line">        <span class="comment">/** æ”¾å¼ƒ */</span></span><br><span class="line">        GIVEUP,</span><br><span class="line">        <span class="comment">/** ç»§ç»­ */</span></span><br><span class="line">        CONTINUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡è¯•çš„é—´éš”æ—¶é—´,è®¾ç½®GIVEUPå¿½ç•¥æ­¤é¡¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">sleepMills</span><span class="params">()</span> <span class="keyword">default</span> 200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡è¯•æ¬¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">retryTimes</span><span class="params">()</span> <span class="keyword">default</span> 5</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰æ¥å£"><a href="#å®šä¹‰æ¥å£" class="headerlink" title="å®šä¹‰æ¥å£"></a>å®šä¹‰æ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDistributedLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMEOUT_MILLIS = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SLEEP_MILLIS = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">int</span> retryTimes)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">int</span> retryTimes, <span class="keyword">long</span> sleepMillis)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire, <span class="keyword">int</span> retryTimes)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire, <span class="keyword">int</span> retryTimes, <span class="keyword">long</span> sleepMillis)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseLock</span><span class="params">(String key)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰æŠ½è±¡ç±»"><a href="#å®šä¹‰æŠ½è±¡ç±»" class="headerlink" title="å®šä¹‰æŠ½è±¡ç±»"></a>å®šä¹‰æŠ½è±¡ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDistributedLockImpl</span> <span class="keyword">implements</span> <span class="title">IDistributedLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, TIMEOUT_MILLIS, RETRY_TIMES, SLEEP_MILLIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">int</span> retryTimes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, TIMEOUT_MILLIS, retryTimes, SLEEP_MILLIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">int</span> retryTimes, <span class="keyword">long</span> sleepMillis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, TIMEOUT_MILLIS, retryTimes, sleepMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, expire, RETRY_TIMES, SLEEP_MILLIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire, <span class="keyword">int</span> retryTimes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, expire, retryTimes, SLEEP_MILLIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»"><a href="#å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»" class="headerlink" title="å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»"></a>å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDistributedLock</span> <span class="keyword">extends</span> <span class="title">AbstractDistributedLockImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = getLogger(RedisDistributedLock.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;String&gt; lockFlag = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String UNLOCK_LUA;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_IF_NOT_EXIST = <span class="string">&quot;NX&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_WITH_EXPIRE_TIME = <span class="string">&quot;PX&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_LUA = <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisDistributedLock</span><span class="params">(RedisTemplate&lt;Object, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, <span class="keyword">long</span> expire, <span class="keyword">int</span> retryTimes, <span class="keyword">long</span> sleepMillis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = setRedis(key, expire);</span><br><span class="line">        <span class="comment">// å¦‚æœè·å–é”å¤±è´¥ï¼ŒæŒ‰ç…§ä¼ å…¥çš„é‡è¯•æ¬¡æ•°è¿›è¡Œé‡è¯•</span></span><br><span class="line">        <span class="keyword">while</span>((!result) &amp;&amp; retryTimes-- &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;lock failed, retrying...&quot;</span> + retryTimes);</span><br><span class="line">                Thread.sleep(sleepMillis);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result = setRedis(key, expire);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseLock</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½å› ä¸ºæŒé”ä¹‹åæ–¹æ³•æ‰§è¡Œæ—¶é—´å¤§äºé”çš„æœ‰æ•ˆæœŸï¼Œæ­¤æ—¶æœ‰å¯èƒ½å·²ç»è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åˆ é™¤</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            keys.add(key);</span><br><span class="line">            List&lt;String&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            args.add(lockFlag.get());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨luaè„šæœ¬åˆ é™¤redisä¸­åŒ¹é…valueçš„keyï¼Œå¯ä»¥é¿å…ç”±äºæ–¹æ³•æ‰§è¡Œæ—¶é—´è¿‡é•¿è€Œredisé”è‡ªåŠ¨è¿‡æœŸå¤±æ•ˆçš„æ—¶å€™è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”</span></span><br><span class="line">            <span class="comment">// springè‡ªå¸¦çš„æ‰§è¡Œè„šæœ¬æ–¹æ³•ä¸­ï¼Œé›†ç¾¤æ¨¡å¼ç›´æ¥æŠ›å‡ºä¸æ”¯æŒæ‰§è¡Œè„šæœ¬çš„å¼‚å¸¸ï¼Œæ‰€ä»¥åªèƒ½æ‹¿åˆ°åŸredisçš„connectionæ¥æ‰§è¡Œè„šæœ¬</span></span><br><span class="line"></span><br><span class="line">            Long result = redisTemplate.execute((RedisCallback&lt;Long&gt;) redisConnection -&gt; &#123;</span><br><span class="line">                Object nativeConnection = redisConnection.getNativeConnection();</span><br><span class="line">                <span class="comment">// é›†ç¾¤æ¨¡å¼å’Œå•æœºæ¨¡å¼è™½ç„¶æ‰§è¡Œè„šæœ¬çš„æ–¹æ³•ä¸€æ ·ï¼Œä½†æ˜¯æ²¡æœ‰å…±åŒçš„æ¥å£ï¼Œæ‰€ä»¥åªèƒ½åˆ†å¼€æ‰§è¡Œ</span></span><br><span class="line">                <span class="comment">// é›†ç¾¤æ¨¡å¼</span></span><br><span class="line">                <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> JedisCluster) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (Long) ((JedisCluster) nativeConnection).eval(UNLOCK_LUA, keys, args);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å•æœºæ¨¡å¼</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> Jedis) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (Long) ((Jedis) nativeConnection).eval(UNLOCK_LUA, keys, args);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result != <span class="keyword">null</span> &amp;&amp; result &gt; <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;release lock occured an exception&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// æ¸…é™¤æ‰ThreadLocalä¸­çš„æ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡º</span></span><br><span class="line">            lockFlag.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setRedis</span><span class="params">(String key, <span class="keyword">long</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = redisTemplate.execute((RedisCallback&lt;String&gt;) redisConnection -&gt; &#123;</span><br><span class="line">                JedisCommands commands = (JedisCommands) redisConnection.getNativeConnection();</span><br><span class="line">                String uuid = UUID.randomUUID().toString();</span><br><span class="line">                lockFlag.set(uuid);</span><br><span class="line">                <span class="keyword">return</span> commands.set(key, uuid, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expire);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> !StringUtils.isEmpty(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;set redis occured an exception&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è£…é…DistributeLock"><a href="#è£…é…DistributeLock" class="headerlink" title="è£…é…DistributeLock"></a>è£…é…DistributeLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RedisAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLockAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(RedisTemplate.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDistributedLock <span class="title">redisDistributedLock</span><span class="params">(RedisTemplate&lt;Object, Object&gt; redisTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisDistributedLock(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰åˆ‡é¢"><a href="#å®šä¹‰åˆ‡é¢" class="headerlink" title="å®šä¹‰åˆ‡é¢"></a>å®šä¹‰åˆ‡é¢</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(IDistributedLock.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(DistributedLockAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLockAspectConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = getLogger(DistributedLockAspectConfiguration.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDistributedLock distributedLock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalVariableTableParameterNameDiscoverer discoverer = <span class="keyword">new</span> LocalVariableTableParameterNameDiscoverer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®šä¹‰åˆ‡å…¥ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.cayzlh.distributedlock.annotations.DistributeLock)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">lockPoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¯ç»•é€šçŸ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp pjp</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ–¹æ³•è¿”å›ç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around(&quot;lockPoint()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Method method = ((MethodSignature) pjp.getSignature()).getMethod();</span><br><span class="line">        DistributeLock lockAction = method.getAnnotation(DistributeLock.class);</span><br><span class="line">        String logKey = getLogKey(lockAction, pjp, method);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retryTimes = lockAction.action().equals(DistributeLock.LockFailAction.CONTINUE) ? lockAction.retryTimes() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> lock = distributedLock.lock(logKey, lockAction.keepMills(), retryTimes, lockAction.sleepMills());</span><br><span class="line">        <span class="keyword">if</span> (!lock) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;get lock failed : &quot;</span> + logKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¾—åˆ°é”,æ‰§è¡Œæ–¹æ³•ï¼Œé‡Šæ”¾é”</span></span><br><span class="line">        logger.debug(<span class="string">&quot;get lock success : &quot;</span> + logKey);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;execute locked method occured an exception&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> releaseResult = distributedLock.releaseLock(logKey);</span><br><span class="line">            logger.debug(<span class="string">&quot;release lock : &quot;</span> + logKey + (releaseResult ? <span class="string">&quot; success&quot;</span> : <span class="string">&quot; failed&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å¾—åˆ†å¸ƒå¼ç¼“å­˜çš„key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockAction æ³¨è§£å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp        pjp</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method     method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getLogKey</span><span class="params">(DistributeLock lockAction, ProceedingJoinPoint pjp, Method method)</span> </span>&#123;</span><br><span class="line">        String name = lockAction.name();</span><br><span class="line">        String value = lockAction.value();</span><br><span class="line">        Object[] args = pjp.getArgs();</span><br><span class="line">        <span class="keyword">return</span> parse(name, method, args) + <span class="string">&quot;_&quot;</span> + parse(value, method, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§£æspring ELè¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args   args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> parse result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">parse</span><span class="params">(String key, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        String[] params = discoverer.getParameterNames(method);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == params || params.length == <span class="number">0</span> || !key.contains(<span class="string">&quot;#&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line">        EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">            context.setVariable(params[i], args[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parser.parseExpression(key).getValue(context, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">-1ms</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">20ms</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®log4jé…ç½®æ–‡ä»¶"><a href="#é…ç½®log4jé…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®log4jé…ç½®æ–‡ä»¶"></a>é…ç½®log4jé…ç½®æ–‡ä»¶</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># serveré»˜è®¤ä¸ºç©º</span></span><br><span class="line"><span class="attr">server</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># æ—¥å¿—è¾“å‡ºç›®å½•</span></span><br><span class="line"><span class="attr">logFilePath</span>=<span class="string">logs</span></span><br><span class="line"><span class="meta">log4j.rootCategory</span>=<span class="string">DEBUG,stdout,debugLog,infoLog,errorLog</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ§åˆ¶å°æ—¥å¿—è¾“å‡º</span></span><br><span class="line"><span class="meta">log4j.logger.consoleLogger</span>=<span class="string">stdout</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.stdout</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.Threshold</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.layout.ConversionPattern</span>=<span class="string">[%p] %d %c - %m%n</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.ImmediateFlush</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># debugæ—¥å¿—è¾“å‡º</span></span><br><span class="line"><span class="meta">log4j.logger.debugLog</span>=<span class="string">DEBUG, debugLog</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.debugLog</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.File</span>=<span class="string">$&#123;logFilePath&#125;/debug.log</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; %5p %c&#123;1&#125;:%L - %m%n</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.DatePattern</span>=<span class="string">&#x27;.&#x27;yyyy-MM-dd</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.ImmediateFlush</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.Threshold</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.filter.debugFilter</span>=<span class="string">org.apache.log4j.varia.LevelRangeFilter</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.filter.debugFilter.LevelMin</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">log4j.appender.debugLog.filter.debugFilter.LevelMax</span>=<span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>
<h3 id="å®Œ"><a href="#å®Œ" class="headerlink" title="å®Œ"></a>å®Œ</h3><p>æºç <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cayzlh/springboot-distributedlock-demo">åœ¨è¿™</a>.</p>

  </div>

  
    <div style="text-align:center;width:100%">
      <img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-2.gif">
    </div>
  

  
    <div>
      <h4>ç‰ˆæƒå£°æ˜</h4>
      <pre>
        
        <strong>æœ¬æ–‡æ¥æºï¼š </strong><a href="https://www.cayzlh.com/blog" title="ğŸ³Antä¸¶" rel="noopener external nofollow noreferrer" target="_blank">https://www.cayzlh.com/blog</a>

        <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://www.cayzlh.com/2018/05/30/61b3f288.html" title="/blog/SpringBoot%E5%AE%9E%E7%8E%B0Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">https://www.cayzlh.com/2018/05/30/61b3f288.html</a>

        <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
        
          æ–‡ç« å†…å®¹ä»…ç”¨ä½œå­¦ä¹ å’Œåˆ†äº«ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„
        
      </pre>
    </div>
  

</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/blog/">Home</a></li>
        
          <li><a href="/blog/archives/">Articles</a></li>
        
          <li><a href="/blog/about/">About</a></li>
        
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7-From"><span class="toc-number">3.</span> <span class="toc-text">å¯é æ€§(From)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpringBoot%E5%B7%A5%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">åˆ›å»ºä¸€ä¸ªSpringBootå·¥ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%B3%A8%E8%A7%A3%E7%B1%BB"><span class="toc-number">5.2.</span> <span class="toc-text">å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.</span> <span class="toc-text">å®šä¹‰æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-number">5.4.</span> <span class="toc-text">å®šä¹‰æŠ½è±¡ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.5.</span> <span class="toc-text">å®šä¹‰Redisåˆ†å¸ƒå¼é”å®ç°ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E9%85%8DDistributeLock"><span class="toc-number">5.6.</span> <span class="toc-text">è£…é…DistributeLock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2"><span class="toc-number">5.7.</span> <span class="toc-text">å®šä¹‰åˆ‡é¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.8.</span> <span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AElog4j%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.9.</span> <span class="toc-text">é…ç½®log4jé…ç½®æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C"><span class="toc-number">6.</span> <span class="toc-text">å®Œ</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://www.cayzlh.com/2018/05/30/61b3f288.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&text=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&is_video=false&description=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”&body=Check out this article: https://www.cayzlh.com/2018/05/30/61b3f288.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&title=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://www.cayzlh.com/2018/05/30/61b3f288.html&name=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://www.cayzlh.com/2018/05/30/61b3f288.html&t=SpringBootå®ç°Redisåˆ†å¸ƒå¼é”"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
<!--        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>-->
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    CAYZLH &copy;
    
    
    2019-2021
    ç²¤ICPå¤‡20058712å·-1
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
          <li><a href="/blog/tools/">tools</a></li>
        
          <li><a href="/blog/links/">links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/blog/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/blog/lib/jquery/jquery.min.js"></script>


<script src="/blog/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/blog/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/blog/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129095667-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-129095667-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
