<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta name="generator" content="Hexo 5.4.0">
  <meta charset="utf-8">
  

  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>æ·±å…¥åˆ†æApplicationContextçš„refresh() - BLOG | CAYZLH</title>

  
    <meta name="description" content="åˆ†æSpringï¼ŒApplicationContextçš„refresh()æ–¹æ³•">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥åˆ†æApplicationContextçš„refresh()">
<meta property="og:url" content="https://www.cayzlh.com/2020/01/26/ea3a33da.html">
<meta property="og:site_name" content="BLOG | CAYZLH">
<meta property="og:description" content="åˆ†æSpringï¼ŒApplicationContextçš„refresh()æ–¹æ³•">
<meta property="og:locale">
<meta property="article:published_time" content="2020-01-26T06:53:43.000Z">
<meta property="article:modified_time" content="2021-02-20T15:30:20.528Z">
<meta property="article:author" content="ğŸ³Antä¸¶">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="æ­»ç£•Spring">
<meta name="twitter:card" content="summary">
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/blog/atom.xml" title="BLOG | CAYZLH" type="application/atom+xml">
  

  
    
<link rel="stylesheet" href="/blog/css/main.css">

  

  
</head>

<body>
  


  <div class="l_body" id="start">
    <aside class="l_left">
    

<header class="header">
  <div class="logo-wrap">
  
  
    <a class="title" href="/blog/">
      BLOG | CAYZLH
    </a>
  
</div>

  <nav class="menu dis-select"><a class="nav-item active" href="/blog/">Blog</a></nav>
</header>

<div class="widgets">
  
    
      
      
<div class="widget-wrap" id="toc"><div class="widget-header h4 dis-select"><span class="name">TOC</span></div><div class="widget-body fs14 post"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#prepareRefresh"><span class="toc-text">prepareRefresh()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#obtainFreshBeanFactory"><span class="toc-text">obtainFreshBeanFactory()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prepareBeanFactory-beanFactory"><span class="toc-text">prepareBeanFactory(beanFactory)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#postProcessBeanFactory"><span class="toc-text">postProcessBeanFactory()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#invokeBeanFactoryPostProcessors"><span class="toc-text">invokeBeanFactoryPostProcessors()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#registerBeanPostProcessors"><span class="toc-text">registerBeanPostProcessors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initMessageSource"><span class="toc-text">initMessageSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initApplicationEventMulticaster"><span class="toc-text">initApplicationEventMulticaster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#onRefresh"><span class="toc-text">onRefresh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#registerListeners"><span class="toc-text">registerListeners</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finishBeanFactoryInitialization"><span class="toc-text">finishBeanFactoryInitialization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finishRefresh"><span class="toc-text">finishRefresh</span></a></li></ol></div></div></div>

    
  
</div>


    </aside>
    <div class="l_main">
      

      


  <div class="bread-nav fs12">
  
    
    <div id="breadcrumb">
      <a class="cap breadcrumb" href="/">Home</a>
      <span class="sep"></span>
      <a class="cap breadcrumb" href="/">Blog</a>
      
        <span class="sep"></span>
        <a class="cap breadcrumb-link" href="/blog/categories/Spring/">Spring</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/blog/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/">ã€ŠSpringæºç åˆ†æã€‹</a>
      
    </div>
    <div id="post-meta">
      Posted on&nbsp;<time datetime="2020-01-26T06:53:43.000Z">2020-01-26</time>
    </div>
  
  </div>


<article class="content md post">
<h1 class="article-title"><span>æ·±å…¥åˆ†æApplicationContextçš„refresh()</span></h1>
<blockquote>
<p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p>
<p>å‡ºå¤„ï¼š<a target="_blank" rel="external nofollow noopener noreferrer" href="http://cmsblogs.com/?p=4043">http://cmsblogs.com/?p=4043</a></p>
<p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p>
<p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p>
</blockquote>
<p>ä¸Šç¯‡åšå®¢å¯¹ ApplicationContext ç›¸å…³çš„æ¥å£åšäº†ä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œä½œä¸ºä¸€ä¸ªé«˜å¯Œå¸…çº§åˆ«çš„ Spring å®¹å™¨ï¼Œå®ƒæ¶‰åŠçš„æ–¹æ³•å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå…¨éƒ¨ä»‹ç»æ˜¯ä¸å¯èƒ½çš„ï¼Œè€Œä¸”å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½å·²ç»åœ¨å‰é¢ç³»åˆ—åšå®¢ä¸­åšäº†è¯¦ç»†çš„ä»‹ç»ï¼Œæ‰€ä»¥è¿™ç¯‡åšé—®ä»‹ç» ApplicationContext æœ€é‡è¦çš„æ–¹æ³•ï¼ˆå°ç¼–è®¤ä¸ºçš„ï¼‰ ï¼š<code>refresh()</code>ã€‚</p>
<p><code>refresh()</code> æ˜¯å®šä¹‰åœ¨ ConfigurableApplicationContext ç±»ä¸­çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load or refresh the persistent representation of the configuration,</span></span><br><span class="line"><span class="comment"> * which might an XML file, properties file, or relational database schema.</span></span><br><span class="line"><span class="comment"> * As this is a startup method, it should destroy already created singletons</span></span><br><span class="line"><span class="comment"> * if it fails, to avoid dangling resources. In other words, after invocation</span></span><br><span class="line"><span class="comment"> * of that method, either all or no singletons at all should be instantiated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException if the bean factory could not be initialized</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException if already initialized and multiple refresh</span></span><br><span class="line"><span class="comment"> * attempts are not supported</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨å°±æ˜¯ï¼š<strong>åˆ·æ–° Spring çš„åº”ç”¨ä¸Šä¸‹æ–‡</strong>ã€‚å…¶å®ç°æ˜¯åœ¨ AbstractApplicationContext ä¸­å®ç°ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    <span class="comment">// å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">    prepareRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory</span></span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¡«å……BeanFactoryåŠŸèƒ½</span></span><br><span class="line">    prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</span></span><br><span class="line">      postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor</span></span><br><span class="line">      registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</span></span><br><span class="line">      initMessageSource();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨</span></span><br><span class="line">      initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean</span></span><br><span class="line">      onRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åœ¨æ‰€æœ‰beanä¸­æŸ¥æ‰¾listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</span></span><br><span class="line">      registerListeners();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„)</span></span><br><span class="line">      finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨lifecycleProcessoråˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡ºContextRefreshEventé€šçŸ¥åˆ«äºº</span></span><br><span class="line">      finishRefresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  é”€æ¯å·²ç»åˆ›å»ºçš„Bean</span></span><br><span class="line">      destroyBeans();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é‡ç½®å®¹å™¨æ¿€æ´»æ ‡ç­¾</span></span><br><span class="line">      cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">      <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">      resetCommonCaches();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¯ä¸€ä¸ªæ–¹æ³•éƒ½éå¸¸é‡è¦ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªåœ°è§£é‡Šè¯´æ˜ã€‚</p>
<h2 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh()"></a>prepareRefresh()</h2><blockquote>
<p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¯¹ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡æˆ–è€…ç³»ç»Ÿå±æ€§è¿›è¡Œå‡†å¤‡å’Œæ ¡éªŒ,å¦‚ç¯å¢ƒå˜é‡ä¸­å¿…é¡»è®¾ç½®æŸä¸ªå€¼æ‰èƒ½è¿è¡Œï¼Œå¦åˆ™ä¸èƒ½è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨è¿™é‡ŒåŠ è¿™ä¸ªæ ¡éªŒï¼Œé‡å†™initPropertySourcesæ–¹æ³•å°±å¥½äº†</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å¯åŠ¨æ—¥æœŸ</span></span><br><span class="line">  <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">  <span class="comment">// è®¾ç½® context å½“å‰çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–context environmentï¼ˆä¸Šä¸‹æ–‡ç¯å¢ƒï¼‰ä¸­çš„å ä½ç¬¦å±æ€§æ¥æº</span></span><br><span class="line">  initPropertySources();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯</span></span><br><span class="line">  getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå¦‚ï¼š</p>
<ol>
<li>è®¾ç½® context å¯åŠ¨æ—¶é—´</li>
<li>è®¾ç½® context çš„å½“å‰çŠ¶æ€</li>
<li>åˆå§‹åŒ– context environment ä¸­å ä½ç¬¦</li>
<li>å¯¹å±æ€§è¿›è¡Œå¿…è¦çš„éªŒè¯</li>
</ol>
<h2 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory()"></a>obtainFreshBeanFactory()</h2><blockquote>
<p>åˆ›å»ºå¹¶åˆå§‹åŒ– BeanFactory</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ·æ–° BeanFactory</span></span><br><span class="line">  refreshBeanFactory();</span><br><span class="line">  <span class="comment">// è·å– BeanFactory</span></span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæ–¹æ³•å°±åœ¨ <code>refreshBeanFactory()</code> ï¼Œè¯¥æ–¹æ³•çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯åˆ›å»º BeanFactory å¹¶å¯¹å…¶å°±è¡Œä¸€ç•ªåˆå§‹åŒ–ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">    destroyBeans();</span><br><span class="line">    closeBeanFactory();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">    beanFactory.setSerializationId(getId());</span><br><span class="line">    customizeBeanFactory(beanFactory);</span><br><span class="line">    loadBeanDefinitions(beanFactory);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">      <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>åˆ¤æ–­å½“å‰å®¹å™¨æ˜¯å¦å­˜åœ¨ä¸€ä¸ª BeanFactoryï¼Œå¦‚æœå­˜åœ¨åˆ™å¯¹å…¶è¿›è¡Œé”€æ¯å’Œå…³é—­</li>
<li>è°ƒç”¨ <code>createBeanFactory()</code> åˆ›å»ºä¸€ä¸ª BeanFactory å®ä¾‹ï¼Œå…¶å®å°±æ˜¯ DefaultListableBeanFactory</li>
<li>è‡ªå®šä¹‰ BeanFactory</li>
<li>åŠ è½½ BeanDefinition</li>
<li>å°†åˆ›å»ºå¥½çš„ bean å·¥å‚çš„å¼•ç”¨äº¤ç»™çš„ context æ¥ç®¡ç†</li>
</ol>
<p>ä¸Šé¢ 5 ä¸ªæ­¥éª¤ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯æœ‰å¿…è¦è®²è§£ä¸‹ç¬¬ 4 æ­¥ï¼šåŠ è½½ BeanDefinitionã€‚å¦‚æœå„ä½çœ‹è¿‡ ã€æ­»ç£• Springã€‘ç³»åˆ—çš„è¯ï¼Œåœ¨åˆšåˆšå¼€å§‹åˆ†ææºç çš„æ—¶å€™ï¼Œå°ç¼–å°±æ˜¯ä»¥ <code>loadBeanDefinitions()</code> ä¸ºå…¥å£æ¥åˆ†æçš„ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;bean.xml&quot;</span>);</span><br><span class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">reader.loadBeanDefinitions(resource);</span><br></pre></td></tr></table></figure>

<p>åªä¸è¿‡è¿™æ®µä»£ç çš„ <code>loadBeanDefinitions()</code> æ˜¯å®šä¹‰åœ¨ BeanDefinitionReader ä¸­ï¼Œè€Œæ­¤å¤„çš„ <code>loadBeanDefinitions()</code> åˆ™æ˜¯å®šä¹‰åœ¨ AbstractRefreshableApplicationContext ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> BeansException, IOException</span></span><br></pre></td></tr></table></figure>

<p>ç”±å…·ä½“çš„å­ç±»å®ç°ï¼Œæˆ‘ä»¬ä»¥ AbstractXmlApplicationContext ä¸ºä¾‹ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">  XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Configure the bean definition reader with this context&#x27;s</span></span><br><span class="line">  <span class="comment">// resource loading environment.</span></span><br><span class="line">  beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">  beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">  beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></span><br><span class="line">  <span class="comment">// then proceed with actually loading the bean definitions.</span></span><br><span class="line">  initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">  loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–°å»º XmlBeanDefinitionReader å®ä¾‹å¯¹è±¡ beanDefinitionReaderï¼Œè°ƒç”¨ <code>initBeanDefinitionReader()</code> å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ <code>loadBeanDefinitions()</code> åŠ è½½ BeanDefinitionã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">  Resource[] configResources = getConfigResources();</span><br><span class="line">  <span class="keyword">if</span> (configResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configResources);</span><br><span class="line">  &#125;</span><br><span class="line">  String[] configLocations = getConfigLocations();</span><br><span class="line">  <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configLocations);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®å†…éƒ¨ä¾ç„¶æ˜¯è°ƒç”¨ <code>BeanDefinitionReader#loadBeanDefinitionn()</code> è¿›è¡Œ BeanDefinition çš„åŠ è½½è¿›ç¨‹ã€‚</p>
<h2 id="prepareBeanFactory-beanFactory"><a href="#prepareBeanFactory-beanFactory" class="headerlink" title="prepareBeanFactory(beanFactory)"></a>prepareBeanFactory(beanFactory)</h2><blockquote>
<p>å¡«å…… BeanFactory åŠŸèƒ½</p>
</blockquote>
<p>ä¸Šé¢è·å–è·å–çš„ BeanFactory é™¤äº†åŠ è½½äº†ä¸€äº› BeanDefinition å°±æ²¡æœ‰å…¶ä»–ä»»ä½•ä¸œè¥¿äº†ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®è¿˜ä¸èƒ½æŠ•å…¥ç”Ÿäº§ï¼Œå› ä¸ºè¿˜å°‘é…ç½®äº†ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚ contextçš„ ClassLoader å’Œ åç½®å¤„ç†å™¨ç­‰ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®beanFactoryçš„classLoader</span></span><br><span class="line">  beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®beanFactoryçš„è¡¨è¾¾å¼è¯­è¨€å¤„ç†å™¨,Spring3å¼€å§‹å¢åŠ äº†å¯¹è¯­è¨€è¡¨è¾¾å¼çš„æ”¯æŒ,é»˜è®¤å¯ä»¥ä½¿ç”¨#&#123;bean.xxx&#125;çš„å½¢å¼æ¥è°ƒç”¨ç›¸å…³å±æ€§å€¼</span></span><br><span class="line">  beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">  <span class="comment">// ä¸ºbeanFactoryå¢åŠ ä¸€ä¸ªé»˜è®¤çš„propertyEditor</span></span><br><span class="line">  beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ ApplicationContextAwareProcessor</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">  <span class="comment">// è®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£</span></span><br><span class="line">  beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å‡ ä¸ªè‡ªåŠ¨è£…é…çš„ç‰¹æ®Šè§„åˆ™</span></span><br><span class="line">  beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">  beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¢åŠ å¯¹AspectJçš„æ”¯æŒ</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">    <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œé»˜è®¤çš„ç³»ç»Ÿç¯å¢ƒbean</span></span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸Šé¢çš„æºç çŸ¥é“è¿™ä¸ªå°±æ˜¯å¯¹ BeanFactory è®¾ç½®å„ç§å„ç§çš„åŠŸèƒ½ã€‚</p>
<h2 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory()"></a>postProcessBeanFactory()</h2><blockquote>
<p>æä¾›å­ç±»è¦†ç›–çš„é¢å¤–å¤„ç†ï¼Œå³å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ServletContextAwareProcessor(<span class="keyword">this</span>.servletContext, <span class="keyword">this</span>.servletConfig));</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ServletContextAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ServletConfigAware.class);</span><br><span class="line"></span><br><span class="line">  WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, <span class="keyword">this</span>.servletContext);</span><br><span class="line">  WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, <span class="keyword">this</span>.servletContext, <span class="keyword">this</span>.servletConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>æ·»åŠ  ServletContextAwareProcessor åˆ° BeanFactory å®¹å™¨ä¸­ï¼Œè¯¥ processor å®ç° BeanPostProcessor æ¥å£ï¼Œä¸»è¦ç”¨äºå°†ServletContext ä¼ é€’ç»™å®ç°äº† ServletContextAware æ¥å£çš„ bean</li>
<li>å¿½ç•¥ ServletContextAwareã€ServletConfigAware</li>
<li>æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„åŸŸï¼ˆscopeï¼‰åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿ WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚æ¯”å¦‚ â€œrequestâ€ , â€œsessionâ€ , â€œglobalSessionâ€ , â€œapplicationâ€</li>
<li>æ³¨å†Œ WEB åº”ç”¨ç‰¹å®šçš„ Environment bean åˆ° beanFactory ä¸­ï¼Œä»¥ä¾¿WebApplicationContext å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚å¦‚ï¼šâ€contextParametersâ€, â€œcontextAttributesâ€</li>
</ol>
<h2 id="invokeBeanFactoryPostProcessors"><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors()"></a>invokeBeanFactoryPostProcessors()</h2><blockquote>
<p>æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®šä¹‰ä¸€ä¸ª set ä¿å­˜æ‰€æœ‰çš„ BeanFactoryPostProcessors</span></span><br><span class="line">  Set&lt;String&gt; processedBeans = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰ BeanFactory ä¸º BeanDefinitionRegistry</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">    BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">    <span class="comment">// BeanFactoryPostProcessor é›†åˆ</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// BeanDefinitionRegistryPostProcessor é›†åˆ</span></span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿­ä»£æ³¨å†Œçš„ beanFactoryPostProcessors</span></span><br><span class="line">    <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ BeanDefinitionRegistryPostProcessorï¼Œåˆ™è°ƒç”¨ postProcessBeanDefinitionRegistry è¿›è¡Œæ³¨å†Œï¼Œ</span></span><br><span class="line">      <span class="comment">// åŒæ—¶åŠ å…¥åˆ° registryProcessors é›†åˆä¸­</span></span><br><span class="line">      <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">        BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">          (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">        registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">        registryProcessors.add(registryProcessor);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™å½“åšæ™®é€šçš„ BeanFactoryPostProcessor å¤„ç†</span></span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ° regularPostProcessors é›†åˆä¸­å³å¯ï¼Œä¾¿äºåé¢åšåç»­å¤„ç†</span></span><br><span class="line">        regularPostProcessors.add(postProcessor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºä¿å­˜å½“å‰å¤„ç†çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆå¤„ç†å®ç°äº† PriorityOrdered (æœ‰é™æ’åºæ¥å£)çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">      beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">        processedBeans.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’åº</span></span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ å…¥registryProcessorsé›†åˆ</span></span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰å®ç°äº† PriorityOrdered çš„ BeanDefinitionRegistryPostProcessors çš„ postProcessBeanDefinitionRegistry()</span></span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºï¼Œä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨</span></span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶æ¬¡ï¼Œè°ƒç”¨æ˜¯å®ç°äº† Orderedï¼ˆæ™®é€šæ’åºæ¥å£ï¼‰çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">    <span class="comment">// é€»è¾‘å’Œ ä¸Šé¢ä¸€æ ·</span></span><br><span class="line">    postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">        processedBeans.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åè°ƒç”¨å…¶ä»–çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">    <span class="keyword">boolean</span> reiterate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">      reiterate = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// è·å– BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ²¡æœ‰åŒ…å«åœ¨ processedBeans ä¸­çš„ï¼ˆå› ä¸ºåŒ…å«äº†çš„éƒ½å·²ç»å¤„ç†äº†ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">          currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">          processedBeans.add(ppName);</span><br><span class="line">          reiterate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸ä¸Šé¢å¤„ç†é€»è¾‘ä¸€è‡´</span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰ BeanDefinitionRegistryPostProcessor (åŒ…æ‹¬æ‰‹åŠ¨æ³¨å†Œå’Œé€šè¿‡é…ç½®æ–‡ä»¶æ³¨å†Œ)</span></span><br><span class="line">    <span class="comment">// å’Œ BeanFactoryPostProcessor(åªæœ‰æ‰‹åŠ¨æ³¨å†Œ)çš„å›è°ƒå‡½æ•°(postProcessBeanFactory())</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯ BeanDefinitionRegistry åªéœ€è¦è°ƒç”¨å…¶å›è°ƒå‡½æ•°ï¼ˆpostProcessBeanFactory()ï¼‰å³å¯</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  String[] postProcessorNames =</span><br><span class="line">    beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡ŒåŒæ ·éœ€è¦åŒºåˆ† PriorityOrdered ã€Ordered å’Œ no Ordered</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="comment">// å·²ç»å¤„ç†è¿‡äº†çš„ï¼Œè·³è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">      <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// PriorityOrdered</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Ordered</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no Ordered</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, PriorityOrdered æ¥å£</span></span><br><span class="line">  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">  invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Next, Ordered æ¥å£</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">    orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">  &#125;</span><br><span class="line">  sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">  invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, no ordered</span></span><br><span class="line">  List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">    nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">  &#125;</span><br><span class="line">  invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">  <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line">  beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç è¾ƒé•¿ï¼Œä½†æ˜¯å¤„ç†é€»è¾‘è¾ƒä¸ºå•ä¸€ï¼Œå°±æ˜¯å¯¹æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessors ã€æ‰‹åŠ¨æ³¨å†Œçš„ BeanFactoryPostProcessor ä»¥åŠé€šè¿‡é…ç½®æ–‡ä»¶æ–¹å¼çš„ BeanFactoryPostProcessor æŒ‰ç…§ PriorityOrdered ã€ Orderedã€no ordered ä¸‰ç§æ–¹å¼åˆ†å¼€å¤„ç†ã€è°ƒç”¨ã€‚</p>
<h2 id="registerBeanPostProcessors"><a href="#registerBeanPostProcessors" class="headerlink" title="registerBeanPostProcessors"></a>registerBeanPostProcessors</h2><blockquote>
<p>æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œå³æ³¨å†Œ BeanPostProcessor</p>
</blockquote>
<p>ä¸ BeanFactoryPostProcessor ä¸€æ ·ï¼Œä¹Ÿæ˜¯å§”æ‰˜ç»™ PostProcessorRegistrationDelegate æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰€æœ‰çš„ BeanPostProcessors</span></span><br><span class="line">  String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œ BeanPostProcessorChecker</span></span><br><span class="line">  <span class="comment">// ä¸»è¦ç”¨äºè®°å½•ä¸€äº› bean çš„ä¿¡æ¯ï¼Œè¿™äº› bean ä¸ç¬¦åˆæ‰€æœ‰ BeanPostProcessors å¤„ç†çš„èµ„æ ¼æ—¶</span></span><br><span class="line">  <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒºåˆ† PriorityOrderedã€Ordered ã€ no ordered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="comment">// MergedBeanDefinition</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      priorityOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">        internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First, PriorityOrdered</span></span><br><span class="line">  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Next, Ordered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    orderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// onOrdered</span></span><br><span class="line">  List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">    BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">    nonOrderedPostProcessors.add(pp);</span><br><span class="line">    <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">      internalPostProcessors.add(pp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, all internal BeanPostProcessors.</span></span><br><span class="line">  sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">  registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡æ–°æ³¨å†Œç”¨æ¥è‡ªåŠ¨æ¢æµ‹å†…éƒ¨ApplicationListenerçš„post-processorï¼Œè¿™æ ·å¯ä»¥å°†ä»–ä»¬ç§»åˆ°å¤„ç†å™¨é“¾æ¡çš„æœ«å°¾</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource"></a>initMessageSource</h2><blockquote>
<p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</p>
</blockquote>
<p>å…¶å®è¯¥æ–¹æ³•å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ª MessageSource æ¥å£çš„å®ç°ç±»ï¼Œä¸»è¦ç”¨äºå›½é™…åŒ–/i18nã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">  <span class="comment">// åŒ…å« â€œmessageSourceâ€ bean</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰çˆ¶ç±»</span></span><br><span class="line">    <span class="comment">// HierarchicalMessageSource åˆ†çº§å¤„ç†çš„ MessageSource</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">      HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">      <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ³¨å†Œçˆ¶ MessageSourceï¼Œåˆ™è®¾ç½®ä¸ºçˆ¶ç±»ä¸Šä¸‹æ–‡çš„çš„ MessageSource</span></span><br><span class="line">        hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ç©º MessageSource</span></span><br><span class="line">    DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">    dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">    <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">    beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Unable to locate MessageSource with name &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">                   <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster"></a>initApplicationEventMulticaster</h2><blockquote>
<p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡äº‹ä»¶å¹¿æ’­å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨ applicationEventMulticaster beanï¼Œåˆ™è·å–èµ‹å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">      beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰åˆ™æ–°å»º SimpleApplicationEventMulticasterï¼Œå¹¶å®Œæˆ bean çš„æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">    beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot;</span> +</span><br><span class="line">                   APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">                   <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰å®¹å™¨ä¸­å­˜åœ¨ applicationEventMulticaster çš„ beanï¼Œåˆ™å¯¹ applicationEventMulticaster èµ‹å€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ª SimpleApplicationEventMulticaster çš„å¯¹è±¡ï¼ˆé»˜è®¤çš„ï¼‰ï¼Œå¹¶å®Œæˆæ³¨å†Œã€‚</p>
<h2 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h2><blockquote>
<p>ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Bean</p>
</blockquote>
<p>é¢„ç•™ç»™ AbstractApplicationContext çš„å­ç±»ç”¨äºåˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šçš„ beanï¼Œè¯¥æ–¹æ³•éœ€è¦åœ¨æ‰€æœ‰å•ä¾‹ bean åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚</p>
<h2 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners"></a>registerListeners</h2><blockquote>
<p>åœ¨æ‰€æœ‰ bean ä¸­æŸ¥æ‰¾ listener beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ³¨å†Œé™æ€ ç›‘å¬å™¨</span></span><br><span class="line">  <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">    getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">    getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡³æ­¤ï¼Œå·²ç»å®Œæˆå°†ç›‘å¬å™¨æ³¨å†Œåˆ°ApplicationEventMulticasterä¸­ï¼Œä¸‹é¢å°†å‘å¸ƒå‰æœŸçš„äº‹ä»¶ç»™ç›‘å¬å™¨ã€‚</span></span><br><span class="line">  Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">  <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">      getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization"></a>finishBeanFactoryInitialization</h2><blockquote>
<p>åˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹Bean(éå»¶è¿ŸåŠ è½½çš„)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–è½¬æ¢å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">      beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">    beanFactory.setConversionService(</span><br><span class="line">      beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰æ²¡æœ‰æ³¨å†Œ bean åç½®å¤„ç†å™¨ï¼ˆä¾‹å¦‚PropertyPlaceholderConfigurerï¼‰ï¼Œåˆ™æ³¨å†Œé»˜è®¤çš„è§£æå™¨</span></span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">    beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">  String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">    getBean(weaverAwareName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ ClassLoader</span></span><br><span class="line">  beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹ï¼ˆéå»¶è¿Ÿåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">  beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh"></a>finishRefresh</h2><blockquote>
<p>å®Œæˆåˆ·æ–°è¿‡ç¨‹,é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ lifecycleProcessor åˆ·æ–°è¿‡ç¨‹,åŒæ—¶å‘å‡º ContextRefreshEvent é€šçŸ¥åˆ«äºº</p>
</blockquote>
<p>ä¸»è¦æ˜¯è°ƒç”¨ <code>LifecycleProcessor#onRefresh()</code> ï¼Œå¹¶ä¸”å‘å¸ƒäº‹ä»¶ï¼ˆContextRefreshedEventï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">  clearResourceCaches();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">  initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">  getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Publish the final event.</span></span><br><span class="line">  publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line">  LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="article-footer fs14"><section id="license"><div class="header"><span>License</span></div><div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></section></div>

</article>

<div class="related-wrap" id="read-next"><section class="header cap theme"><span>READ NEXT</span></section><section class="body"><div class="post-title h2"><a href="/blog/2020/01/26/1a84ff95.html">ApplicationContextç›¸å…³æ¥å£æ¶æ„åˆ†æ</a></div><div class="post-title fs14"><a href="/blog/2020/01/26/101fc769.html">or prev: 4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ</a></div></section></div>


<div class="related-wrap" id="related-posts">
    <section class="header">
      <div class="title cap theme">Related Posts</div>
    </section>
    <section class="body">
    <div class="related-posts"><a class="item" href="/blog/2020/01/26/101fc769.html" title="4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ"><div class="img"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/spring-201901311001_BJamFt.jpg"></div><span class="title">4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ</span><span class="excerpt">4å¼ å›¾å¸¦ä½ è¯»æ‡‚Spring IOCçš„ä¸–ç•Œ.</span></a><a class="item" href="/blog/2020/01/26/1a84ff95.html" title="ApplicationContextç›¸å…³æ¥å£æ¶æ„åˆ†æ"><div class="img"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15409479819725_t0jF0z_flFIsn.jpg"></div><span class="title">ApplicationContextç›¸å…³æ¥å£æ¶æ„åˆ†æ</span><span class="excerpt">Springçš„ApplicationContextç›¸å…³æ¥å£çš„æ¶æ„åˆ†æ</span></a><a class="item" href="/blog/2020/01/26/90c034e1.html" title="IOCä¹‹åˆ†æbeançš„ç”Ÿå‘½å‘¨æœŸ"><div class="img"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/2020/05/28/15359386381747_wNxvJ5_Lyaby1.jpg"></div><span class="title">IOCä¹‹åˆ†æbeançš„ç”Ÿå‘½å‘¨æœŸ</span><span class="excerpt">åˆ†æSpring Beançš„ç”Ÿå‘½å‘¨æœŸ</span></a><a class="item" href="/blog/2020/01/25/8ce6797f.html" title="Springçš„ç¯å¢ƒ&å±æ€§ï¼šPropertySourceã€Environmentã€Profile"><div class="img"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15398567835599_IpITEl_QAdnEu.jpg"></div><span class="title">Springçš„ç¯å¢ƒ&å±æ€§ï¼šPropertySourceã€Environmentã€Profile</span><span class="excerpt">åˆ†æä¸€ä¸‹Springçš„ç¯å¢ƒå±æ€§ï¼šPropertySourceã€Environmentã€Profile</span></a><a class="item" href="/blog/2020/01/27/9cf21717.html" title="Spring AOPå’ŒSpring Transactionæºç èµ„æ–™æ•´ç†"><div class="img"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.1/cover/76b86c0226ffd.svg"></div><span class="title">Spring AOPå’ŒSpring Transactionæºç èµ„æ–™æ•´ç†</span><span class="excerpt">æ•´ç†å­¦ä¹ AOPæºç çš„ç›¸å…³èµ„æ–™</span></a></div></section></div>





      
<footer class="page-footer fs12"><hr><div><p>All articles in this blog are licensed under <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</p>
<p>This site was deployed by <a href="https://www.cayzlh.com/blog/">@ğŸ³Antä¸¶</a> using <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.1.0">Stellar</a>.</p>
</div></footer>

      <div class="float-panel mobile-only" style="display:none">
  <button type="button" class="sidebar-toggle mobile" onclick="sidebar.toggle()">
    <svg class="icon" viewbox="0 0 1228 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2849"><path d="M0 0m97.390199 0l973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.3902l-973.901995 0q-97.390199 0-97.390199-97.3902l0 0q0-97.390199 97.390199-97.390199Z" p-id="2850"/><path d="M0 389.560798m97.390199 0l973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.3902l-973.901995 0q-97.390199 0-97.390199-97.3902l0 0q0-97.390199 97.390199-97.390199Z" p-id="2851"/><path d="M0 779.121596m97.390199 0l973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.390199l-973.901995 0q-97.390199 0-97.390199-97.390199l0 0q0-97.390199 97.390199-97.390199Z" p-id="2852"/></svg>
  </button>
</div>

    </div>
  </div>
  <div class="scripts">
    <script type="text/javascript">
  stellar = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // ä» butterfly å’Œ volantis è·å¾—çµæ„Ÿ
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script')
      script.src = src
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.1.0';
  stellar.config = {
    date_suffix: {
      just: 'Just',
      min: 'minutes ago',
      hour: 'hours ago',
      day: 'days ago',
      month: 'months ago',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js',
    sitesjs: '/blog/js/plugins/sites.js',
    friendsjs: '/blog/js/plugins/friends.js',
  };

  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper/swiper-bundle.min.css","js":"https://unpkg.com/swiper/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://cdn.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
</script>

<!-- required -->

  
<script src="/blog/js/main.js" async></script>



<!-- optional -->



<!-- inject -->


  </div>
</body>
</html>
