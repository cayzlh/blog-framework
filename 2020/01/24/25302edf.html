<!DOCTYPE html>
<html lang="en">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Spring Beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy">
<meta property="og:type" content="article">
<meta property="og:title" content="IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy">
<meta property="og:url" content="http://cmsblogs.com/?p=4022">
<meta property="og:site_name" content="CAYZLH">
<meta property="og:description" content="Spring Beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15395929815414_38Okah_ZrNViV.jpg">
<meta property="article:published_time" content="2020-01-24T12:59:40.000Z">
<meta property="article:modified_time" content="2020-06-01T13:52:52.359Z">
<meta property="article:author" content="ğŸ³Antä¸¶">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="è½¬è½½">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15395929815414_38Okah_ZrNViV.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/blog/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/blog/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/blog/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/blog/true" title="CAYZLH" type="application/atom+xml">
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/blog/">Home</a></li>
        
          <li><a href="/blog/archives/">Articles</a></li>
        
          <li><a href="/blog/about/">About</a></li>
        
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/blog/2020/01/25/86c712d3.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/blog/2020/01/24/fcc18cc7.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
<!--        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>-->
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous</span>
      <span id="i-next" class="info" style="display:none;">Next</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://www.cayzlh.com/2020/01/24/25302edf.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://www.cayzlh.com/2020/01/24/25302edf.html&text=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.cayzlh.com/2020/01/24/25302edf.html&is_video=false&description=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy&body=Check out this article: https://www.cayzlh.com/2020/01/24/25302edf.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://www.cayzlh.com/2020/01/24/25302edf.html&name=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://www.cayzlh.com/2020/01/24/25302edf.html&t=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#InstantiationStrategy"><span class="toc-number">1.</span> <span class="toc-text">InstantiationStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleInstantiationStrategy"><span class="toc-number">1.1.</span> <span class="toc-text">SimpleInstantiationStrategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MethodOverrides"><span class="toc-number">1.2.</span> <span class="toc-text">MethodOverrides</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CGLIB-%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.</span> <span class="toc-text">CGLIB å®ä¾‹åŒ–ç­–ç•¥</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">JavaæŠ€æœ¯é©¿ç«™ | chenssy |ã€æ­»ç£• Springã€‘| IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-01-24T12:59:40.000Z" itemprop="datePublished">2020-01-24</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/blog/categories/Spring/">Spring</a> â€º <a class="category-link" href="/blog/categories/Spring/%E3%80%8ASpring%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%8B/">ã€ŠSpringæºç åˆ†æã€‹</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/blog/tags/Spring/" rel="tag">Spring</a>, <a class="tag-link-link" href="/blog/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">è½¬è½½</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>æœ¬æ–‡ä½œè€…ï¼šchenssy</p>
<p>å‡ºå¤„ï¼š<a target="_blank" rel="external nofollow noopener noreferrer" href="http://cmsblogs.com/?p=4022">http://cmsblogs.com/?p=4022</a></p>
<p>åœ¨å­¦ä¹ <code>Springæºç </code>çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¥½ç«™+å¥½è´´ï¼ŒåŸåˆ›ä¸æ˜“æ„Ÿè°¢ä½œè€…ã€‚</p>
<p>Springç‰ˆæœ¬ï¼š<strong>Spring 5.0.6.RELEASE</strong></p>
</blockquote>
<p>åœ¨å¼€å§‹åˆ†æ InstantiationStrategy ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•å›é¡¾ä¸‹ bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼š</p>
<ol>
<li>bean çš„åˆ›å»ºï¼Œä¸»è¦æ˜¯ <code>AbstractAutowireCapableBeanFactory.doCreateBean()</code> ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ bean çš„å®ä¾‹åŒ–ã€å±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯¹äº bean çš„å®ä¾‹åŒ–è¿‡ç¨‹è¿™æ˜¯æ ¹æ® bean çš„ç±»å‹æ¥åˆ¤æ–­çš„ï¼Œå¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™ç›´æ¥ä» factoryBeanInstanceCache ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è°ƒç”¨ <code>createBeanInstance()</code> åˆ›å»ºã€‚</li>
<li>åœ¨ <code>createBeanInstance()</code> ä¸­ï¼Œå¦‚æœ Supplier ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>obtainFromSupplier()</code> å®ä¾‹åŒ– beanã€‚å¦‚æœ factory ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>instantiateUsingFactoryMethod()</code> å®ä¾‹åŒ– bean ï¼Œå¦‚æœéƒ½ä¸æ˜¯åˆ™è°ƒç”¨ <code>instantiateBean()</code> å®ä¾‹åŒ–bean ã€‚ä½†æ˜¯æ— è®ºæ˜¯ <code>instantiateUsingFactoryMethod()</code> è¿˜æ˜¯ <code>instantiateBean()</code> æœ€åéƒ½ä¸€å®šä¼šè°ƒç”¨åˆ° InstantiationStrategy æ¥å£çš„ <code>instantiate()</code>ã€‚</li>
</ol>
<h2 id="InstantiationStrategy"><a href="#InstantiationStrategy" class="headerlink" title="InstantiationStrategy"></a>InstantiationStrategy</h2><p>InstantiationStrategy æ¥å£å®šä¹‰äº† Spring Bean å®ä¾‹åŒ–çš„ç­–ç•¥ï¼Œæ ¹æ®åˆ›å»ºå¯¹è±¡æƒ…å†µçš„ä¸åŒï¼Œæä¾›äº†ä¸‰ç§ç­–ç•¥ï¼š<strong>æ— å‚æ„é€ æ–¹æ³•</strong>ã€<strong>æœ‰å‚æ„é€ æ–¹æ³•</strong>ã€<strong>å·¥å‚æ–¹æ³•</strong>ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstantiationStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŒ‡å®šæ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">   Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="meta">@Nullable</span> Object factoryBean, Method factoryMethod, <span class="meta">@Nullable</span> Object... args)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SimpleInstantiationStrategy"><a href="#SimpleInstantiationStrategy" class="headerlink" title="SimpleInstantiationStrategy"></a>SimpleInstantiationStrategy</h3><p><code>InstantiationStrategy</code> æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š<code>SimpleInstantiationStrategy</code> å’Œ <code>CglibSubclassingInstantiationStrategy</code>ã€‚</p>
<p><code>SimpleInstantiationStrategy</code> å¯¹ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•éƒ½åšäº†ç®€å•çš„å®ç°ã€‚</p>
<p>å¦‚æœæ˜¯å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™ç›´æ¥ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@Nullable</span> Object factoryBean, <span class="keyword">final</span> Method factoryMethod, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      ReflectionUtils.makeAccessible(factoryMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method priorInvokedFactoryMethod = currentlyInvokedFactoryMethod.get();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      currentlyInvokedFactoryMethod.set(factoryMethod);</span><br><span class="line">      Object result = factoryMethod.invoke(factoryBean, args);</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> NullBean();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (priorInvokedFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.set(priorInvokedFactoryMethod);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        currentlyInvokedFactoryMethod.remove();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// çœç•¥ catch</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æ„é€ æ–¹æ³•å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ MethodOverridesï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¯ç›´æ¥ä½¿ç”¨åå°„ï¼Œå¦‚æœæœ‰åˆ™å°±éœ€è¦ CGLIB å®ä¾‹åŒ–å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Don&#x27;t override the class with CGLIB if no overrides.</span></span><br><span class="line">  <span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">    Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">    <span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</span><br><span class="line">      constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">      <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">        <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;Specified class is an interface&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            constructorToUse = AccessController.doPrivileged(</span><br><span class="line">              (PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            constructorToUse =   clazz.getDeclaredConstructor();</span><br><span class="line">          &#125;</span><br><span class="line">          bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">&quot;No default constructor found&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Must generate CGLIB subclass.</span></span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// use own privileged to change accessibility (when security is on)</span></span><br><span class="line">      AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(ctor);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (args != <span class="keyword">null</span> ? BeanUtils.instantiateClass(ctor, args) : BeanUtils.instantiateClass(ctor));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, ctor, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SimpleInstantiationStrategy å¯¹ <code>instantiateWithMethodInjection()</code> çš„å®ç°ä»»åŠ¡äº¤ç»™äº†å­ç±» CglibSubclassingInstantiationStrategyã€‚</p>
<h3 id="MethodOverrides"><a href="#MethodOverrides" class="headerlink" title="MethodOverrides"></a>MethodOverrides</h3><p>å¯¹äº MethodOverridesï¼Œåœ¨ BeanDefinitionParserDelegate ç±»è§£æ <code>&lt;bean/&gt;</code> çš„æ—¶å€™æ˜¯å¦è¿˜è®°å¾—è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š<code>parseLookupOverrideSubElements()</code> å’Œ <code>parseReplacedMethodSubElements()</code> è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºè§£æ lookup-method å’Œ replaced-methodã€‚<code>parseLookupOverrideSubElements()</code> æºç å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/05/27/15395929815414_38Okah_ZrNViV.jpg" alt="img"></p>
<p>æ›´å¤šå…³äº lookup-method å’Œ replaced-method è¯·çœ‹ï¼š<a href="/2020/01/24/fa973ffe.html">IOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method</a></p>
<h3 id="CGLIB-å®ä¾‹åŒ–ç­–ç•¥"><a href="#CGLIB-å®ä¾‹åŒ–ç­–ç•¥" class="headerlink" title="CGLIB å®ä¾‹åŒ–ç­–ç•¥"></a>CGLIB å®ä¾‹åŒ–ç­–ç•¥</h3><p>ç±» CglibSubclassingInstantiationStrategy ä¸º Spring å®ä¾‹åŒ– bean çš„é»˜è®¤å®ä¾‹åŒ–ç­–ç•¥ï¼Œå…¶ä¸»è¦åŠŸèƒ½è¿˜æ˜¯å¯¹çˆ¶ç±»åŠŸèƒ½è¿›è¡Œè¡¥å……ï¼šå…¶çˆ¶ç±»å°† CGLIB çš„å®ä¾‹åŒ–ç­–ç•¥å§”æ‰˜å…¶å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SimpleInstantiationStrategy</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Method Injection not supported in SimpleInstantiationStrategy&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CglibSubclassingInstantiationStrategy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CglibSubclassingInstantiationStrategy å®ä¾‹åŒ– bean ç­–ç•¥æ˜¯é€šè¿‡å…¶å†…éƒ¨ç±» CglibSubclassCreator æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                <span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CglibSubclassCreator(bd, owner).instantiate(ctor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º CglibSubclassCreator å®ä¾‹ç„¶åè°ƒç”¨å…¶ <code>instantiate()</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºåŠ¨æ€åˆ›å»ºå­ç±»å®ä¾‹ï¼ŒåŒæ—¶å®ç°æ‰€éœ€è¦çš„ lookupsï¼ˆlookup-methodã€replace-methodï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(<span class="meta">@Nullable</span> Constructor&lt;?&gt; ctor, <span class="meta">@Nullable</span> Object... args)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; subclass = createEnhancedSubclass(<span class="keyword">this</span>.beanDefinition);</span><br><span class="line">  Object instance;</span><br><span class="line">  <span class="keyword">if</span> (ctor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instance = BeanUtils.instantiateClass(subclass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());</span><br><span class="line">      instance = enhancedSubclassConstructor.newInstance(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(<span class="keyword">this</span>.beanDefinition.getBeanClass(),</span><br><span class="line">                                           <span class="string">&quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot;</span> + subclass.getName() + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è¿™ä¸ªåœ°æ–¹è§£å†³ä¸€ä¸ªbugï¼Œbugæäº¤æŠ¥å‘Šhttps://jira.spring.io/browse/SPR-10785</span></span><br><span class="line">  <span class="comment">// SPR-10785: set callbacks directly on the instance instead of in the</span></span><br><span class="line">  <span class="comment">// enhanced class (via the Enhancer) in order to avoid memory leaks.</span></span><br><span class="line">  Factory factory = (Factory) instance;</span><br><span class="line">  factory.setCallbacks(<span class="keyword">new</span> Callback[] &#123;NoOp.INSTANCE,</span><br><span class="line">                                       <span class="keyword">new</span> LookupOverrideMethodInterceptor(<span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner),</span><br><span class="line">                                       <span class="keyword">new</span> ReplaceOverrideMethodInterceptor(<span class="keyword">this</span>.beanDefinition, <span class="keyword">this</span>.owner)&#125;);</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>createEnhancedSubclass()</code> ä¸ºæä¾›çš„ BeanDefinition åˆ›å»º bean ç±»çš„å¢å¼ºå­ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createEnhancedSubclass(RootBeanDefinition beanDefinition) &#123;</span><br><span class="line"> <span class="comment">// cglibé‡Œé¢çš„ç”¨æ³•ï¼Œå¯¹åŸå§‹classè¿›è¡Œå¢å¼ºï¼Œå¹¶è®¾ç½®callback</span></span><br><span class="line"> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"> enhancer.setSuperclass(beanDefinition.getBeanClass());</span><br><span class="line"> enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.owner <span class="keyword">instanceof</span> ConfigurableBeanFactory) &#123;</span><br><span class="line">  ClassLoader cl = ((ConfigurableBeanFactory) <span class="keyword">this</span>.owner).getBeanClassLoader();</span><br><span class="line">  enhancer.setStrategy(<span class="keyword">new</span> ClassLoaderAwareGeneratorStrategy(cl));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// è¿‡æ»¤ï¼Œè‡ªå®šä¹‰é€»è¾‘æ¥æŒ‡å®šè°ƒç”¨çš„callbackä¸‹æ ‡</span></span><br><span class="line"> enhancer.setCallbackFilter(<span class="keyword">new</span> MethodOverrideCallbackFilter(beanDefinition));</span><br><span class="line"> enhancer.setCallbackTypes(CALLBACK_TYPES);</span><br><span class="line"> <span class="keyword">return</span> enhancer.createClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–å­ç±»å¢å¼º class åï¼Œå¦‚æœ Constructor å®ä¾‹ ctr ä¸ºç©ºï¼Œåˆ™è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼ˆ<code>BeanUtils.instantiateClass()</code>ï¼‰æ¥å®ä¾‹åŒ–ç±»ï¼Œå¦åˆ™åˆ™æ ¹æ®æ„é€ å‡½æ•°ç±»å‹è·å–å…·ä½“çš„æ„é€ å™¨ï¼Œè°ƒç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ç±»ã€‚åœ¨ <code>createEnhancedSubclass()</code> æˆ‘ä»¬æ³¨æ„ä¸¤è¡Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enhancer.setCallbackFilter(<span class="keyword">new</span> MethodOverrideCallbackFilter(beanDefinition));</span><br><span class="line">enhancer.setCallbackTypes(CALLBACK_TYPES);</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ MethodOverrideCallbackFilter æ¥å®šä¹‰è°ƒç”¨ callback ç±»å‹ï¼ŒMethodOverrideCallbackFilter æ˜¯ç”¨æ¥å®šä¹‰ CGLIB å›è°ƒè¿‡æ»¤æ–¹æ³•çš„æ‹¦æˆªå™¨è¡Œä¸ºï¼Œå®ƒç»§æ‰¿ CglibIdentitySupport å®ç° CallbackFilter æ¥å£ï¼Œ CallbackFilter æ˜¯ CGLIB çš„ä¸€ä¸ªå›è°ƒè¿‡æ»¤å™¨ï¼ŒCglibIdentitySupport åˆ™ä¸º CGLIB æä¾› <code>hashCode()</code> å’Œ <code>equals()</code> æ–¹æ³•ï¼Œä»¥ç¡®ä¿ CGLIB ä¸ä¼šä¸ºæ¯ä¸ª bean ç”Ÿæˆä¸åŒçš„ç±»ã€‚MethodOverrideCallbackFilter å®ç° CallbackFilter <code>accept()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">  MethodOverride methodOverride = getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Override for &#x27;&quot;</span> + method.getName() + <span class="string">&quot;&#x27; is [&quot;</span> + methodOverride + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (methodOverride == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> PASSTHROUGH;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (methodOverride <span class="keyword">instanceof</span> LookupOverride) &#123;</span><br><span class="line">    <span class="keyword">return</span> LOOKUP_OVERRIDE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (methodOverride <span class="keyword">instanceof</span> ReplaceOverride) &#123;</span><br><span class="line">    <span class="keyword">return</span> METHOD_REPLACER;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Unexpected MethodOverride subclass: &quot;</span> +</span><br><span class="line">                                          methodOverride.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® BeanDefinition ä¸­å®šä¹‰çš„ MethodOverride ä¸åŒï¼Œè¿”å›ä¸åŒçš„å€¼ï¼Œ è¿™é‡Œè¿”å›çš„ PASSTHROUGH ã€LOOKUP_OVERRIDEã€METHOD_REPLACER éƒ½æ˜¯ Callbak æ•°ç»„çš„ä¸‹æ ‡ï¼Œè¿™é‡Œå¯¹åº”çš„æ•°ç»„ä¸º CALLBACK_TYPES æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] CALLBACK_TYPES </span><br><span class="line">  = <span class="keyword">new</span> Class&lt;?&gt;[] &#123;NoOp.class, LookupOverrideMethodInterceptor.class, ReplaceOverrideMethodInterceptor.class&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆå®šä¹‰äº†ä¸¤ä¸ªç†Ÿæ‚‰çš„æ‹¦æˆªå™¨ ï¼šLookupOverrideMethodInterceptor å’Œ ReplaceOverrideMethodInterceptorï¼Œä¸¤ä¸ªæ‹¦æˆªå™¨åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ callback ä¸šåŠ¡ï¼š</p>
<p><strong>LookupOverrideMethodInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupOverrideMethodInterceptor</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CglibIdentitySupport</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LookupOverrideMethodInterceptor</span><span class="params">(RootBeanDefinition beanDefinition, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(beanDefinition);</span><br><span class="line">    <span class="keyword">this</span>.owner = owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy mp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// Cast is safe, as CallbackFilter filters are used selectively.</span></span><br><span class="line">    LookupOverride lo = (LookupOverride) getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">    Assert.state(lo != <span class="keyword">null</span>, <span class="string">&quot;LookupOverride not found&quot;</span>);</span><br><span class="line">    Object[] argsToUse = (args.length &gt; <span class="number">0</span> ? args : <span class="keyword">null</span>); <span class="comment">// if no-arg, don&#x27;t insist on args at all</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(lo.getBeanName())) &#123;</span><br><span class="line">      <span class="keyword">return</span> (argsToUse != <span class="keyword">null</span> ? <span class="keyword">this</span>.owner.getBean(lo.getBeanName(), argsToUse) :</span><br><span class="line">              <span class="keyword">this</span>.owner.getBean(lo.getBeanName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (argsToUse != <span class="keyword">null</span> ? <span class="keyword">this</span>.owner.getBean(method.getReturnType(), argsToUse) :</span><br><span class="line">              <span class="keyword">this</span>.owner.getBean(method.getReturnType()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ReplaceOverrideMethodInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplaceOverrideMethodInterceptor</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CglibIdentitySupport</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReplaceOverrideMethodInterceptor</span><span class="params">(RootBeanDefinition beanDefinition, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(beanDefinition);</span><br><span class="line">    <span class="keyword">this</span>.owner = owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy mp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    ReplaceOverride ro = (ReplaceOverride) getBeanDefinition().getMethodOverrides().getOverride(method);</span><br><span class="line">    Assert.state(ro != <span class="keyword">null</span>, <span class="string">&quot;ReplaceOverride not found&quot;</span>);</span><br><span class="line">    <span class="comment">// TODO could cache if a singleton for minor performance optimization</span></span><br><span class="line">    MethodReplacer mr = <span class="keyword">this</span>.owner.getBean(ro.getMethodReplacerBeanName(), MethodReplacer.class);</span><br><span class="line">    <span class="keyword">return</span> mr.reimplement(obj, method, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œå†åŠ ä¸Šè¿™ç¯‡åšå®¢ï¼š<a href="/2020/01/fa973ffe.html">IOC ä¹‹è§£æ bean æ ‡ç­¾ï¼šmetaã€lookup-methodã€replace-method</a>ï¼Œæ˜¯ä¸æ˜¯ä¸€é“ç»ä½³çš„ç¾é£Ÿã€‚</p>

  </div>

  
    <div style="text-align:center;width:100%">
      <img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-2.gif">
    </div>
  

  
    <div>
      <h4>ç‰ˆæƒå£°æ˜</h4>
      <pre>
        
        <strong>æœ¬æ–‡æ¥æºï¼š </strong><a href="http://cmsblogs.com/?p=4022" title="JavaæŠ€æœ¯é©¿ç«™ | chenssy |ã€æ­»ç£• Springã€‘| IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy" rel="external nofollow noopener noreferrer" target="_blank">http://cmsblogs.com/?p=4022</a>

        <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://www.cayzlh.com/2020/01/24/25302edf.html" title="/blog/IOC%E4%B9%8Bbean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%AD%96%E7%95%A5%EF%BC%9AInstantiationStrategy">https://www.cayzlh.com/2020/01/24/25302edf.html</a>

        <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
        
          æ–‡ç« å†…å®¹ä»…ç”¨ä½œå­¦ä¹ å’Œåˆ†äº«ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„
        
      </pre>
    </div>
  

</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/blog/">Home</a></li>
        
          <li><a href="/blog/archives/">Articles</a></li>
        
          <li><a href="/blog/about/">About</a></li>
        
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#InstantiationStrategy"><span class="toc-number">1.</span> <span class="toc-text">InstantiationStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleInstantiationStrategy"><span class="toc-number">1.1.</span> <span class="toc-text">SimpleInstantiationStrategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MethodOverrides"><span class="toc-number">1.2.</span> <span class="toc-text">MethodOverrides</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CGLIB-%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.</span> <span class="toc-text">CGLIB å®ä¾‹åŒ–ç­–ç•¥</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.facebook.com/sharer.php?u=https://www.cayzlh.com/2020/01/24/25302edf.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/share?url=https://www.cayzlh.com/2020/01/24/25302edf.html&text=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.linkedin.com/shareArticle?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.cayzlh.com/2020/01/24/25302edf.html&is_video=false&description=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy&body=Check out this article: https://www.cayzlh.com/2020/01/24/25302edf.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://getpocket.com/save?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://reddit.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.stumbleupon.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://digg.com/submit?url=https://www.cayzlh.com/2020/01/24/25302edf.html&title=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.tumblr.com/share/link?url=https://www.cayzlh.com/2020/01/24/25302edf.html&name=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="external nofollow noopener noreferrer" href="https://news.ycombinator.com/submitlink?u=https://www.cayzlh.com/2020/01/24/25302edf.html&t=IOCä¹‹beançš„å®ä¾‹åŒ–ç­–ç•¥ï¼šInstantiationStrategy"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
<!--        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>-->
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    CAYZLH &copy;
    
    
    2019-2021
    ç²¤ICPå¤‡20058712å·-1
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
          <li><a href="/blog/tools/">tools</a></li>
        
          <li><a href="/blog/links/">links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/blog/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/blog/lib/jquery/jquery.min.js"></script>


<script src="/blog/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/blog/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/blog/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129095667-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-129095667-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
