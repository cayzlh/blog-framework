<!DOCTYPE html><html lang="[&quot;zh-Hans&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†MyBatisçš„æ ¸å¿ƒåŠŸèƒ½ã€‚"><meta name="keywords" content="MyBatis, MyBatisæŠ€æœ¯å†…å¹•"><meta name="author" content="ğŸ³Antä¸¶"><meta name="copyright" content="ğŸ³Antä¸¶"><title>æ ¸å¿ƒå¤„ç†å±‚-MyBatisåˆå§‹åŒ– | BLOG | CAYZLH</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/logo/favicon.ico"><link rel="stylesheet" href="/blog/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-129095667-1', 'auto');
ga('send', 'pageview');</script><meta name="google-site-verification" content="VrcbMTVpFGlHkIERHBt753dAtXKF4qirjnDweuXSRJw"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blog/atom.xml" title="BLOG | CAYZLH" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">å»ºé€ è€…æ¨¡å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BaseBuilder"><span class="toc-text">BaseBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XMLConfigBuilder"><span class="toc-text">XMLConfigBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XMLMapperBuilder"><span class="toc-text">XMLMapperBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XMLStatementBuilder"><span class="toc-text">XMLStatementBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%91%E5%AE%9AMapper%E6%8E%A5%E5%8F%A3"><span class="toc-text">ç»‘å®šMapperæ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86incomplete-%E9%9B%86%E5%90%88"><span class="toc-text">å¤„ç†incomplete*é›†åˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/image/IMG_4207.JPG"></div><div class="author-info__name text-center">ğŸ³Antä¸¶</div><div class="author-info__description text-center">CODE IS POETRY</div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://telegram.me/Q2F5emxo">contact me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">98</span></a><a class="author-info-articles__tags article-meta" href="/blog/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"><span class="pull-left">ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹</span><span class="pull-right">âˆš</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"><span class="pull-left">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</span><span class="pull-right">âˆš</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="pull-left">Javaè®¾è®¡æ¨¡å¼</span><span class="pull-right">âˆš</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">BLOG | CAYZLH</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">æ ¸å¿ƒå¤„ç†å±‚-MyBatisåˆå§‹åŒ–</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/">ä¹¦ç±</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">11.3k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 49 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†<code>MyBatis</code>çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»<code>MyBatis</code>çš„åˆå§‹åŒ–ã€åŠ¨æ€<code>SQL</code>è¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠ<code>SQL</code>è¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æ<code>MyBatis</code>çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£<code>MyBatis</code>çš„æ ¸å¿ƒåŸç†ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622175512211_aegXOG.png" alt="image-20200622175512211"></p>
<blockquote>
<p>æœ¬ç¯‡ä»‹ç»MyBatisçš„åˆå§‹åŒ–</p>
</blockquote>
<p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¼šè¯»å–<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½é…ç½®æ–‡ä»¶æŒ‡å®šçš„ç±»ï¼Œå¤„ç†ç±»ä¸­çš„æ³¨è§£ï¼Œåˆ›å»ºä¸€äº›é…ç½®å¯¹è±¡ï¼Œæœ€ç»ˆå®Œæˆæ¡†æ¶ä¸­å„ä¸ªæ¨¡å—çš„åˆå§‹åŒ–ã€‚</p>
<p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>JavaAPI</code>çš„æ–¹å¼å¯¹<code>MyBatis</code>è¿›è¡Œé…ç½®ï¼Œè¿™ç§ç¡¬ç¼–ç çš„é…ç½®æ–¹å¼ä¸»è¦ç”¨åœ¨é…ç½®é‡æ¯”è¾ƒå°‘ä¸”é…ç½®ä¿¡æ¯ä¸å¸¸å˜åŒ–çš„åœºæ™¯ä¸‹ã€‚</p>
<h2 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h2><p>åœ¨<code>MyBatis</code>å¤„ç†<code>mybatis-config.xml</code>ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºç›¸åº”çš„é…ç½®å¯¹è±¡ï¼Œè¯¥è¿‡ç¨‹çš„è®¾è®¡ä½¿ç”¨åˆ°<strong>å»ºé€ è€…æ¨¡å¼</strong>çš„ç›¸å…³çŸ¥è¯†ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622215026613_lPP12T.png" alt="image-20200622215026613"></p>
<p>å»ºé€ è€…æ¨¡å¼ä¸­çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><strong>å»ºé€ è€…(Builder)æ¥å£</strong></p>
<p>Builderæ¥å£ç”¨äºå®šä¹‰å»ºé€ è€…æ„å»ºäº§å“å¯¹è±¡çš„å„éƒ¨åˆ†çš„è¡Œä¸ºã€‚</p>
</li>
<li><p><strong>å…·ä½“å»ºé€ è€…(ConcreteBuilder)è§’è‰²</strong></p>
<p><strong>åœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„æ˜¯å…·ä½“å»ºé€ è€…ã€‚</strong>å…·ä½“å»ºé€ è€…ç±»å¿…é¡»å®ç°å»ºé€ è€…æ¥å£æ‰€è¦æ±‚çš„ä¸¤ç±»æ–¹æ³•ï¼š</p>
<p>ä¸€ç±»æ˜¯å»ºé€ æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„<code>buildPart1()</code>ã€<code>buildPart2()</code>ç­‰æ–¹æ³•ã€‚</p>
<p>å¦ä¸€ç±»æ˜¯è·å–æ„å»ºå¥½çš„äº§å“å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾ä¸­çš„<code>getProduct()</code>æ–¹æ³•ã€‚</p>
</li>
<li><p><strong>å¯¼æ¼”(Director)è§’è‰²</strong></p>
<p>è¯¥è§’è‰²ä¼šé€šè¿‡è°ƒç”¨å…·ä½“å»ºé€ è€…ï¼Œ åˆ›å»ºéœ€è¦çš„äº§å“å¯¹è±¡</p>
</li>
<li><p><strong>äº§å“(Product)è§’è‰²</strong></p>
<p>äº§å“å¯¹è±¡å°±æ˜¯ç”¨æˆ·éœ€è¦ä½¿ç”¨çš„å¤æ‚å¯¹è±¡</p>
</li>
</ul>
<p>å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å»ºé€ è€…æ¨¡å¼ä¸­çš„å¯¼æ¼”è§’è‰²å¹¶ä¸éœ€è¦çŸ¥æ™“äº§å“ç±»çš„å†…éƒ¨ç»†èŠ‚ï¼Œå®ƒåªæä¾›éœ€è¦çš„ä¿¡æ¯ç»™å»ºé€ è€…ï¼Œç”±å…·ä½“å»ºé€ è€…å¤„ç†è¿™äº›ä¿¡æ¯(è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚)å¹¶å®Œæˆäº§å“æ„é€ ã€‚è¿™å°±ä½¿<strong>äº§å“å¯¹è±¡çš„ä¸Šå±‚ä»£ç ä¸äº§å“å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ã€‚</strong></li>
<li>å»ºé€ è€…æ¨¡å¼å°†å¤æ‚äº§å“çš„åˆ›å»ºè¿‡ç¨‹åˆ†æ•£åˆ°äº†ä¸åŒçš„æ„é€ æ­¥éª¤ä¸­ï¼Œè¿™æ ·å¯ä»¥å¯¹äº§å“åˆ›å»ºè¿‡ç¨‹å®ç°æ›´åŠ ç²¾ç»†çš„æ§åˆ¶ï¼Œä¹Ÿä¼šä½¿<strong>åˆ›å»ºè¿‡ç¨‹æ›´åŠ æ¸…æ™°ã€‚</strong></li>
<li>æ¯ä¸ªå…·ä½“å»ºé€ è€…éƒ½å¯ä»¥åˆ›å»ºå‡ºå®Œæ•´çš„äº§å“å¯¹è±¡ï¼Œè€Œä¸”å…·ä½“å»ºé€ è€…ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡ä¸åŒçš„å…·ä½“å»ºé€ è€…ï¼Œå¾—åˆ°ä¸åŒçš„äº§å“å¯¹è±¡ã€‚<strong>å½“æœ‰æ–°äº§å“å‡ºç°æ—¶ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªéœ€è¦æ·»åŠ æ–°çš„å…·ä½“å»ºé€ è€…å³å¯å®Œæˆæ‰©å±•</strong>ï¼Œè¿™ç¬¦åˆ<strong>å¼€æ”¾-å°é—­</strong>åŸåˆ™ã€‚</li>
</ul>
<p>å»ºé€ è€…æ¨¡å¼ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå®ƒæ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œ<strong>å¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚æ€§å¾ˆå¤§ï¼Œåˆ™ä¸é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼ã€‚</strong></p>
<p>å¦‚æœäº§å“ç§ç±»è¾ƒå¤šï¼Œä¸”å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå°±éœ€è¦å®šä¹‰å¤šä¸ªå…·ä½“å»ºé€ è€…ç±»æ¥å®ç°è¿™ç§å˜åŒ–ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå˜å¾—å¾ˆå¤æ‚ï¼Œä¸æ˜“äºç†è§£ã€‚</p>
<h2 id="BaseBuilder"><a href="#BaseBuilder" class="headerlink" title="BaseBuilder"></a>BaseBuilder</h2><p><code>MyBatis</code>åˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œæ˜¯åŠ è½½å¹¶è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ã€æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠç›¸å…³çš„æ³¨è§£ä¿¡æ¯ã€‚<code>MyBatis</code>çš„åˆå§‹åŒ–å…¥å£æ˜¯<code>SqlSessionFactoryBuilder.build()</code>æ–¹æ³•ï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å–é…ç½®æ–‡ä»¶</span></span><br><span class="line">    XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">    <span class="comment">// è§£æé…ç½®æ–‡ä»¶å¾—åˆ°Configurationå¯¹è±¡ï¼Œåˆ›å»ºDefaultSqlSessionFactoryå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error building SqlSession.&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      reader.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SqlSessionFactoryBuilder.build()</code>æ–¹æ³•ä¼šåˆ›å»º<code>XMLConfigBuilder</code>å¯¹è±¡æ¥è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ï¼Œè€Œ<code>XMLConfigBuilder</code>ç»§æ‰¿è‡ª<code>BaseBuilder</code>æŠ½è±¡ç±»ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/23/image-20200623160844166_VAke1q.png" alt="image-20200623160844166"></p>
<p><code>MyBatis</code>çš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¿™é‡Œçš„<code>BaseBuilder</code>æŠ½è±¡ç±»å°±æ‰®æ¼”ç€å»ºé€ è€…æ¥å£çš„è§’è‰²ã€‚<code>BaseBuilder</code>ä¸­æ ¸å¿ƒå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationæ˜¯MyBatisåˆå§‹åŒ–è¿‡ç¨‹çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒMyBatisä¸­å‡ ä¹å…¨éƒ¨çš„é…ç½®ä¿¡æ¯éƒ½ä¼šä¿å­˜åˆ°Configurationä¸­</span></span><br><span class="line"><span class="comment">// Configurationå¯¹è±¡æ˜¯åœ¨MyBatisåˆå§‹åŒ–è¿‡ç¨‹ä¸­åˆ›å»ºä¸”æ˜¯å…¨å±€å”¯ä¸€çš„ï¼ˆall-in-oneé…ç½®å¯¹è±¡ï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeAliases&gt;æ ‡ç­¾å®šä¹‰åˆ«åï¼Œè¿™äº›å®šä¹‰çš„åˆ«åéƒ½ä¼šè®°å½•åœ¨</span></span><br><span class="line"><span class="comment">// TypeAliasRegistryå¯¹è±¡ä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeAliasRegistry typeAliasRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨mybatis-config.xmlé…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨&lt;typeHandlers&gt;æ ‡ç­¾æ·»åŠ è‡ªå®šä¹‰TypeHandlerå™¨ï¼Œ</span></span><br><span class="line"><span class="comment">// å®ŒæˆæŒ‡å®šæ•°æ®åº“ç±»å‹ä¸Javaç±»å‹çš„è½¬æ¢ï¼Œè¿™äº›TypeHandleréƒ½ä¼šè®°å½•åœ¨TypeHandlerRegistryä¸­</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;</span><br></pre></td></tr></table></figure>

<p><code>BaseBuilder</code>ä¸­è®°å½•çš„<code>TypeAliasRegistry</code>å¯¹è±¡å’Œ<code>TypeHandlerRegistry</code>å¯¹è±¡ï¼Œå…¶å®æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨<code>Configuration</code>å¯¹è±¡åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ã€‚</p>
<p><code>Configuration</code>ç±»ä¸­å®šä¹‰äº†è¿™ä¸¤ä¸ªå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeHandlerRegistry typeHandlerRegistry = <span class="keyword">new</span> TypeHandlerRegistry();</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> TypeAliasRegistry typeAliasRegistry = <span class="keyword">new</span> TypeAliasRegistry();</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>BaseBuilder</code>æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡ç›¸åº”çš„<code>Configuration.get*()</code>æ–¹æ³•å¾—åˆ°<code>TypeAliasRegistry</code>å¯¹è±¡å’Œ<code>TypeHandlerRegistry</code>å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™<code>BaseBuilder</code>ç›¸åº”å­—æ®µã€‚</p>
<p><code>BaseBuilder.resolveAlias()</code>æ–¹æ³•ä¾èµ–<code>TypeAliasRegistry</code>è§£æåˆ«åï¼Œ<code>BaseBuilder.resolveTypeHandler()</code>æ–¹æ³•ä¾èµ–<code>TypeHandlerRegistry</code>æŸ¥æ‰¾æŒ‡å®šçš„<code>TypeHandler</code>å¯¹è±¡ã€‚</p>
<p><code>MyBatis</code>ä½¿ç”¨<code>JdbcType</code>æšä¸¾ç±»å‹è¡¨ç¤º<code>JDBC</code>ç±»å‹ã€‚<code>MyBatis</code>ä¸­å¸¸ç”¨çš„æšä¸¾ç±»å‹è¿˜æœ‰<code>ResultSetType</code>å’Œ<code>ParameterMode:ResultSetType</code>æšä¸¾ç±»å‹è¡¨ç¤ºç»“æœé›†ç±»å‹ï¼Œä½¿ç”¨<code>ParameterMode</code>æšä¸¾ç±»å‹è¡¨ç¤ºå­˜å‚¨è¿‡ç¨‹ä¸­çš„å‚æ•°ç±»å‹ã€‚</p>
<p>åœ¨<code>BaseBuilder</code>ä¸­æä¾›äº†ç›¸åº”çš„<code>resolveJdbcType()</code>ã€<code>resolveResultSetType()</code>ã€<code>resolveParameterMode()</code>æ–¹æ³•ï¼Œå°†<code>String</code>è½¬æ¢æˆå¯¹åº”çš„æšä¸¾å¯¹è±¡ã€‚</p>
<h2 id="XMLConfigBuilder"><a href="#XMLConfigBuilder" class="headerlink" title="XMLConfigBuilder"></a>XMLConfigBuilder</h2><p><code>XMLConfigBuilder</code>æ˜¯<code>BaseBuilder</code>çš„ä¼—å¤šå­ç±»ä¹‹ä¸€ï¼Œå®ƒæ‰®æ¼”çš„æ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚**<code>XMLConfigBuilder</code>ä¸»è¦è´Ÿè´£è§£æ<code>mybatis-config.xml</code>é…ç½®ã€‚**</p>
<p>æ ¸å¿ƒå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ‡è¯†æ˜¯å¦å·²ç»è§£æè¿‡mybatis-config.xmlæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> parsed;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºè§£æmybatis-config.xmlé…ç½®æ–‡ä»¶çš„XpathParserå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> XPathParser parser;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ‡è¯† &lt;environment&gt; é…ç½®çš„åç§°ï¼Œ é»˜è®¤è¯»å–&lt;environment&gt;æ ‡ç­¾çš„é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">private</span> String environment;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è´Ÿè´£åˆ›å»ºå’Œç¼“å­˜Reflectorå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory localReflectorFactory = <span class="keyword">new</span> DefaultReflectorFactory();</span><br></pre></td></tr></table></figure>

<p><code>XMLConfigBuilder.parse()</code>æ–¹æ³•æ˜¯è§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶çš„å…¥å£ï¼Œå®ƒé€šè¿‡è°ƒç”¨<code>XMLConfigBuilder.parseConfiguration()</code>æ–¹æ³•å®ç°æ•´ä¸ªè§£æè¿‡ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Configuration <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®parsedå˜é‡çš„å€¼åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆäº†å¯¹mybatis-config.xmlé…ç½®æ–‡ä»¶çš„è§£æ</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ° configuration èŠ‚ç‚¹ï¼Œå¼€å§‹è§£æ</span></span><br><span class="line">  parseConfiguration(parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));</span><br><span class="line">  <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è§£æpropertiesèŠ‚ç‚¹</span></span><br><span class="line">    propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">    <span class="comment">// è§£æsettingsèŠ‚ç‚¹	</span></span><br><span class="line">    Properties settings = settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">    loadCustomVfs(settings);</span><br><span class="line">    typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">    pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">    objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">    objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">    reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">    settingsElement(settings);</span><br><span class="line">    <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">    environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">    databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">    typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">    mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;properties&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>XMLConfigBuilder.propertiesElement()</code>æ–¹æ³•ä¼šè§£æ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­çš„<code>properties</code>èŠ‚ç‚¹å¹¶å½¢æˆ<code>java.util.Properties</code>å¯¹è±¡ï¼Œä¹‹åå°†è¯¥<code>Properties</code>å¯¹è±¡è®¾ç½®åˆ°<code>XPathParser</code>å’Œ<code>Configuration</code>çš„<code>variables</code>å­—æ®µä¸­ã€‚åœ¨åé¢çš„è§£æè¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨è¯¥<code>Properties</code>å¯¹è±¡ä¸­çš„ä¿¡æ¯æ›¿æ¢å ä½ç¬¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">propertiesElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è§£æ&lt;properties&gt;çš„å­èŠ‚ç‚¹ï¼ˆ&lt;property&gt;æ ‡ç­¾ï¼‰çš„nameå’Œvalueå±æ€§ï¼Œ å¹¶è®°å½•åˆ°Propertiesä¸­</span></span><br><span class="line">    Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// è§£æ&lt;properties&gt;çš„resourceå’Œurlå±æ€§ï¼Œè¿™ä¸¤ä¸ªå±æ€§ç”¨äºç¡®å®špropertiesé…ç½®æ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line">    String resource = context.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">    String url = context.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    <span class="comment">// resourceå’Œurlå±æ€§ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">    Properties vars = configuration.getVariables();</span><br><span class="line">    <span class="keyword">if</span> (vars != <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°XPathParserå’ŒConfigurationçš„variableså­—æ®µ</span></span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;settings&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>XMLConfigBuilder.settingsAsProperties()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>settings</code>èŠ‚ç‚¹ï¼Œåœ¨<code>settings</code>ç‚¹ä¸‹çš„é…ç½®æ˜¯<code>MyBatis</code>å…¨å±€æ€§çš„é…ç½®ï¼Œå®ƒä»¬ä¼šæ”¹å˜<code>MyBatis</code>çš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œè¿™äº›å…¨å±€é…ç½®ä¿¡æ¯éƒ½ä¼šè¢«è®°å½•åˆ°<code>Configuration</code>å¯¹è±¡çš„å¯¹åº”å±æ€§ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼šå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é…ç½®<code>autoMappingBehavior</code>ä¿®æ”¹<code>MyBatis</code>æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„çš„åŠŸèƒ½ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	&lt;!- autoMappingBehavioré…ç½®é¡¹ æ˜¯å†³ å®šMyBatisæ˜¯å¦å¹µ å¯ è‡ªåŠ¨ æ˜ å°„åŠŸèƒ½çš„æ¡ ä»¶ä¹‹ä¸€ --&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;autoMappingBehavior&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PARTIAL&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨<code>Configuration</code>ä¸­å­˜åœ¨ä¸€ä¸ªåŒåçš„ç›¸åº”å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> AutoMappingBehavior autoMappingBehavior = AutoMappingBehavior.PARTIAL;</span><br></pre></td></tr></table></figure>

<p><code>settingsAsProperties()</code>æ–¹æ³•çš„è§£ææ–¹å¼ä¸<code>propertiesElement()</code>æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯å¤šäº†ä½¿ç”¨<code>MetaClass</code>æ£€æµ‹<code>key</code>æŒ‡å®šçš„å±æ€§åœ¨<code>Configuration</code>ç±»ä¸­æ˜¯å¦æœ‰å¯¹åº”<code>setter</code>æ–¹æ³•çš„æ­¥éª¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">settingsAsProperties</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Properties();</span><br><span class="line">  &#125;</span><br><span class="line">  Properties props = context.getChildrenAsProperties();</span><br><span class="line">  <span class="comment">// Check that all settings are known to the configuration class</span></span><br><span class="line">  <span class="comment">// åˆ›å»º Configuration å¯¹åº”çš„MetaClasså¯¹è±¡</span></span><br><span class="line">  MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ£€æµ‹Configurationä¸­æ˜¯å¦å®šä¹‰äº†keyæŒ‡å®šå±æ€§ç›¸åº”çš„setteræ–¹æ³•</span></span><br><span class="line">  <span class="keyword">for</span> (Object key : props.keySet()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;typeAliases&gt;</code>ã€<code>&lt;typeHandlers&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>XMLConfigBuilder.typeAliasesElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>typeAliases</code>èŠ‚ç‚¹ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡<code>TypeAliasRegistry</code>å®Œæˆåˆ«åçš„æ³¨å†Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeAliasesElement</span><span class="params">(XNode parent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// å¤„ç†å…¨éƒ¨å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123; <span class="comment">// å¤„ç†packageèŠ‚ç‚¹</span></span><br><span class="line">				<span class="comment">// è·å–æŒ‡å®šåŒ…å</span></span><br><span class="line">        String typeAliasPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡TypeAliasRegistryæ‰«ææŒ‡å®šåŒ…ä¸­æ‰€æœ‰çš„ç±»ï¼Œå¹¶è§£æ@Aliasæ³¨è§£ï¼Œå®Œæˆåˆ«åæ³¨å†Œ</span></span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¤„ç†typeAliasèŠ‚ç‚¹</span></span><br><span class="line">        String alias = child.getStringAttribute(<span class="string">&quot;alias&quot;</span>); <span class="comment">// è·å–æŒ‡å®šåˆ«å</span></span><br><span class="line">        String type = child.getStringAttribute(<span class="string">&quot;type&quot;</span>); <span class="comment">// è·å–åˆ«åå¯¹åº”çš„ç±»å‹</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">          <span class="keyword">if</span> (alias == <span class="keyword">null</span>) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz); <span class="comment">// æ‰«æ@Aliasæ³¨è§£ï¼Œå®Œæˆæ³¨å†Œ</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz); <span class="comment">// æ³¨å†Œåˆ«å</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>XMLConfigBuilder.typeHandlerElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>typeHandlers</code>èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡<code>TypeHandlerRegistry</code>å¯¹è±¡å®Œæˆ<code>TypeHandler</code>çš„æ³¨å†Œï¼Œè¯¥æ–¹æ³•çš„å®ç°ä¸<code>typeAliasesElement()</code>æ–¹æ³•ç±»ä¼¼ã€‚</p>
<p><strong>è§£æ<code>&lt;plugins&gt;</code>èŠ‚ç‚¹</strong></p>
<p>æ’ä»¶æ˜¯<code>MyBatis</code>æä¾›çš„æ‰©å±•æœºåˆ¶ä¹‹ä¸€ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰æ’ä»¶åœ¨<code>SQL</code>è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸€ç‚¹è¿›è¡Œæ‹¦æˆªã€‚</p>
<p><code>MyBatis</code>ä¸­çš„è‡ªå®šä¹‰æ’ä»¶åªéœ€å®ç°<code>Interceptor</code>æ¥å£ï¼Œå¹¶é€šè¿‡æ³¨è§£æŒ‡å®šæƒ³è¦æ‹¦æˆªçš„æ–¹æ³•ç­¾åå³å¯ã€‚è¿™é‡Œåˆ†æMyBatisä¸­å¦‚ä½•åŠ è½½å’Œç®¡ç†æ’ä»¶ã€‚<br><code>XMLConfigBuilder.pluginElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>plugins</code>èŠ‚ç‚¹ä¸­å®šä¹‰çš„æ’ä»¶ï¼Œå¹¶å®Œæˆå®ä¾‹åŒ–å’Œé…ç½®æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      <span class="comment">// è·å–pluginèŠ‚ç‚¹çš„interceptorå±æ€§</span></span><br><span class="line">      String interceptor = child.getStringAttribute(<span class="string">&quot;interceptor&quot;</span>);</span><br><span class="line">      <span class="comment">// è·å–pluginèŠ‚ç‚¹ä¸‹çš„propertiesé…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡</span></span><br><span class="line">      Properties properties = child.getChildrenAsProperties();</span><br><span class="line">      <span class="comment">// é€šè¿‡TypeAliasRegistryè§£æåˆ«åä¹‹åï¼Œå®ä¾‹åŒ–Interceptorå¯¹è±¡</span></span><br><span class="line">      Interceptor interceptorInstance </span><br><span class="line">        = (Interceptor) resolveClass(interceptor).newInstance();</span><br><span class="line">      <span class="comment">// è®¾ç½®Interceptorçš„å±æ€§</span></span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">      <span class="comment">// è®°å½•Interceptorå¯¹è±¡</span></span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰é…ç½®çš„<code>Interceptor</code>å¯¹è±¡éƒ½æ˜¯é€šè¿‡<code>Configuration.interceptorChain</code>å­—æ®µ(<code>InterceptorChain</code>ç±»å‹)ç®¡ç†çš„ï¼Œ<code>InterceptorChain</code>åº•å±‚ä½¿ç”¨<code>ArrayList&lt;Interceptor&gt;</code>å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;Interceptor&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">pluginAll</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Interceptor interceptor : interceptors) &#123;</span><br><span class="line">      target = interceptor.plugin(target);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptor</span><span class="params">(Interceptor interceptor)</span> </span>&#123;</span><br><span class="line">    interceptors.add(interceptor);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Interceptor&gt; <span class="title">getInterceptors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableList(interceptors);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;objectFactory&gt;</code>èŠ‚ç‚¹</strong></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰<code>Objectory</code>å®ç°ç±»ã€<code>ObjectWrapperFactory</code>å®ç°ç±»ä»¥åŠ<code>ReflectorFactory</code>å®ç°ç±»å¯¹<code>MyBatis</code>è¿›è¡Œæ‰©å±•ã€‚<br><code>XMLConfigBuilder.objectFactoryElement()</code>æ–¹æ³•è´Ÿè´£è§£æå¹¶å®ä¾‹åŒ–<code>&lt;objectFactory&gt;</code>èŠ‚ç‚¹æŒ‡å®šçš„<code>ObjectFactory</code>å®ç°ç±»ï¼Œä¹‹åå°†è‡ªå®šä¹‰çš„<code>ObjectFactory</code>å¯¹è±¡è®°å½•åˆ°<code>Configuration.objectFactory</code>å­—æ®µä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">objectFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–&lt;objectFactory&gt;èŠ‚ç‚¹çš„typeå±æ€§</span></span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">		<span class="comment">// è·å–&lt;ObjectFactory&gt;èŠ‚ç‚¹ä¸‹é…ç½®çš„ä¿¡æ¯ï¼Œå¹¶å½¢æˆPropertieså¯¹è±¡</span></span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// è¿›è¡Œåˆ«åè§£æåï¼Œå®ä¾‹åŒ–è‡ªå®šä¹‰ObjectFactoryå®ç°</span></span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).newInstance();</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå®šä¹‰ObjectFactoryå±æ€§ï¼Œ å®Œæˆåˆå§‹åŒ–ç›¸å…³æ“ä½œ</span></span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    <span class="comment">// å°†è‡ªå®šä¹‰ObjectFactoryå¯¹è±¡è®°å½•åˆ°Configurationå¯¹è±¡çš„ObjectFactoryå­—æ®µä¸­ï¼Œå¾…åç»­ä½¿ç”¨</span></span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>XMLConfigBuilder</code>å¯¹<code>&lt;objectWrapperFactory&gt;</code>èŠ‚ç‚¹ã€<code>&lt;reflectorFactory&gt;</code>èŠ‚ç‚¹çš„è§£æä¸ä¸Šè¿°è¿‡ç¨‹ç±»ä¼¼ï¼Œæœ€ç»ˆä¼šå°†è§£æå¾—åˆ°çš„è‡ªå®šä¹‰å¯¹è±¡è®°å½•åˆ°<code>Configuration</code>çš„ç›¸åº”å­—æ®µä¸­ã€‚</p>
<p><strong>è§£æ<code>&lt;environments&gt;</code>èŠ‚ç‚¹</strong></p>
<p>åœ¨å®é™…ç”Ÿäº§ä¸­ï¼ŒåŒä¸€é¡¹ç›®å¯èƒ½åˆ†ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§å¤šä¸ªä¸åŒçš„ç¯å¢ƒï¼Œæ¯ä¸ªç¯å¢ƒçš„é…ç½®å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒã€‚</p>
<p><code>MyBatis</code>å¯ä»¥é…ç½®å¤šä¸ª<code>&lt;environment&gt;</code>èŠ‚ç‚¹ï¼Œæ¯ä¸ª<code>&lt;environment&gt;</code>èŠ‚ç‚¹å¯¹åº”ä¸€ç§ç¯å¢ƒçš„é…ç½®ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡å¯ä»¥é…ç½®å¤šä¸ªç¯å¢ƒï¼Œæ¯ä¸ª<code>SqlSessionFactory</code>å®ä¾‹åªèƒ½é€‰æ‹©å…¶ä¸€ã€‚</p>
<p><code>XMLConfigBuilder.environmentsElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;environments&gt;</code>çš„ç›¸å…³é…ç½®ï¼Œå®ƒä¼šæ ¹æ®<code>XMLConfigBuilder.environment</code>å­—æ®µå€¼ç¡®å®šè¦ä½¿ç”¨çš„<code>&lt;environment&gt;</code>é…ç½®ï¼Œä¹‹ååˆ›å»ºå¯¹åº”çš„<code>TransactionFactory</code>å’Œ<code>DataSource</code>å¯¹è±¡ï¼Œå¹¶å°è£…è¿›<code>Environment</code>å¯¹è±¡ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æœªæŒ‡å®š XMLConfigBuilder.environment å­—æ®µï¼Œåˆ™ä½¿ç”¨defaultå±æ€§æŒ‡å®šçš„&lt;environment&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">      environment = context.getStringAttribute(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id = child.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">        TransactionFactory txFactory </span><br><span class="line">          = transactionManagerElement(child.evalNode(<span class="string">&quot;transactionManager&quot;</span>));</span><br><span class="line">        DataSourceFactory dsFactory = dataSourceElement(child.evalNode(<span class="string">&quot;dataSource&quot;</span>));</span><br><span class="line">        DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">        Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.Builder(id)</span><br><span class="line">          .transactionFactory(txFactory)</span><br><span class="line">          .dataSource(dataSource);</span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;databaseldProvider&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>MyBatis</code>ä¸èƒ½åƒ<code>Hibernate</code>é‚£æ ·ï¼Œç›´æ¥å¸®åŠ©å¼€å‘äººå‘˜å±è”½å¤šç§æ•°æ®åº“äº§å“åœ¨<code>SQL</code>è¯­è¨€æ”¯æŒæ–¹é¢çš„å·®å¼‚ã€‚</p>
<p>ä½†æ˜¯åœ¨<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡<code>&lt;databaseIdProvider&gt;</code>å®šä¹‰æ‰€æœ‰æ”¯æŒçš„æ•°æ®åº“äº§å“çš„<code>databaseld</code>,ç„¶ååœ¨æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰<code>SQL</code>è¯­å¥èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡<code>databaseld</code>æŒ‡å®šè¯¥<code>SQL</code>è¯­å¥åº”ç”¨çš„æ•°æ®åº“äº§å“ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p>
<p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œä¼šæ ¹æ®å‰é¢ç¡®å®šçš„<code>DataSource</code>ç¡®å®šå½“å‰ä½¿ç”¨çš„æ•°æ®åº“äº§å“ï¼Œç„¶ååœ¨è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼ŒåŠ è½½ä¸å¸¦<code>databaseld</code>å±æ€§å’Œå¸¦æœ‰åŒ¹é…å½“å‰æ•°æ®åº“<code>databaseld</code>å±æ€§çš„æ‰€æœ‰SQLè¯­å¥ã€‚å¦‚æœåŒæ—¶æ‰¾åˆ°å¸¦æœ‰<code>databaseld</code>å’Œä¸å¸¦<code>databaseld</code>çš„ç›¸åŒè¯­å¥ï¼Œåˆ™åè€…ä¼šè¢«èˆå¼ƒï¼Œä½¿ç”¨å‰è€…ã€‚</p>
<p><code>XMLConfigBuilder.databaseIdProviderElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;databaseIdProvider&gt;</code>èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºæŒ‡å®šçš„<code>DatabaseldProvider</code>å¯¹è±¡ã€‚<code>DatabaseldProvider</code>ä¼šè¿”å›<code>databaseld</code>å€¼ï¼Œ<code>MyBatis</code>ä¼šæ ¹æ®<code>databaseld</code>é€‰æ‹©åˆé€‚çš„<code>SQL</code>è¿›è¡Œæ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">databaseIdProviderElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  DatabaseIdProvider databaseIdProvider = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">    <span class="comment">// awful patch to keep backward compatibility</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;VENDOR&quot;</span>.equals(type)) &#123;</span><br><span class="line">      type = <span class="string">&quot;DB_VENDOR&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// åˆ›å»ºDatabaseIdProviderå¯¹è±¡</span></span><br><span class="line">    databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance();</span><br><span class="line">    <span class="comment">// é…ç½®DatabaseIdProviderï¼Œå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    databaseIdProvider.setProperties(properties);</span><br><span class="line">  &#125;</span><br><span class="line">  Environment environment = configuration.getEnvironment();</span><br><span class="line">  <span class="keyword">if</span> (environment != <span class="keyword">null</span> &amp;&amp; databaseIdProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡å‰é¢ç¡®å®šçš„DataSourceè·å–databaseldï¼Œå¹¶è®°å½•åˆ°Configuration.databaseldå­—æ®µä¸­</span></span><br><span class="line">    String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource());</span><br><span class="line">    configuration.setDatabaseId(databaseId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MyBatis</code>æä¾›çš„<code>DatabaseldProvider</code>æ¥å£åŠå…¶å®ç°æ¯”è¾ƒç®€å•ã€‚</p>
<p><code>DatabaseldProvider</code>æ¥å£çš„æ ¸å¿ƒæ–¹æ³•æ˜¯<code>getDatabaseId()</code>æ–¹æ³•ï¼Œå®ƒä¸»è¦è´Ÿè´£é€šè¿‡ç»™å®šçš„<code>DataSource</code>æ¥æŸ¥æ‰¾å¯¹åº”çš„<code>databaseld</code>ã€‚</p>
<blockquote>
<p><code>MyBatis</code>æä¾›äº†<code>VendorDatabaseldProvider</code>å’Œ<code>DefaukDatabaseldProvider</code>ä¸¤ä¸ªå®ç°ï¼Œå…¶ä¸­<code>DefaultDatabaseldProvider</code>å·±è¿‡æ—¶ã€‚</p>
</blockquote>
<p><code>VendorDatabaseIdProvider.getDatabaseId()</code>æ–¹æ³•åœ¨æ¥æ”¶åˆ°<code>DataSource</code>å¯¹è±¡æ—¶ï¼Œä¼šå…ˆè§£æ<code>DataSource</code>æ‰€è¿æ¥çš„æ•°æ®åº“äº§å“åç§°ï¼Œä¹‹åæ ¹æ®<code>&lt;databaseIdProvider&gt;</code>èŠ‚ç‚¹é…ç½®çš„æ•°æ®åº“äº§å“åç§°ä¸<code>databaseld</code>çš„å¯¹åº”å…³ç³»ç¡®å®šæœ€ç»ˆçš„<code>databaseld</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDatabaseName</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æDataSourceè¿æ¥çš„æ•°æ®åº“äº§å“çš„åç§°</span></span><br><span class="line">  String productName = getDatabaseProductName(dataSource);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; property : properties.entrySet()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (productName.contains((String) property.getKey())) &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) property.getValue();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no match, return null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> productName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDatabaseProductName</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  Connection con = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    con = dataSource.getConnection();</span><br><span class="line">    DatabaseMetaData metaData = con.getMetaData();</span><br><span class="line">    <span class="keyword">return</span> metaData.getDatabaseProductName();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        con.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="comment">// ignored</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ<code>&lt;mappers&gt;</code>èŠ‚ç‚¹</strong></p>
<p>åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶ï¼Œé™¤äº†åŠ è½½<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ï¼Œè¿˜ä¼šåŠ è½½å…¨éƒ¨çš„æ˜ å°„é…ç½®æ–‡ä»¶ï¼Œ<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶ä¸­çš„<code>&lt;mappers&gt;</code>èŠ‚ç‚¹ä¼šå‘Šè¯‰<code>MyBatis</code>å»å“ªäº›ä½ç½®æŸ¥æ‰¾æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠä½¿ç”¨äº†é…ç½®æ³¨è§£æ ‡è¯†çš„æ¥å£ã€‚<br><code>XMLConfigBuilder.mapperElement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;mappers&gt;</code>èŠ‚ç‚¹ï¼Œå®ƒä¼šåˆ›å»º<code>XMLMapperBuilder</code>å¯¹è±¡åŠ è½½æ˜ å°„æ–‡ä»¶ï¼Œå¦‚æœæ˜ å°„é…ç½®æ–‡ä»¶å­˜åœ¨ç›¸åº”çš„<code>Mapper</code>æ¥å£ï¼Œä¹Ÿä¼šåŠ è½½ç›¸åº”çš„<code>Mapper</code>æ¥å£ï¼Œè§£æå…¶ä¸­çš„æ³¨è§£å¹¶å®Œæˆå‘<code>MapperRegistry</code>çš„æ³¨å†Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// å¤„ç†&lt;mappers&gt;çš„å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;	<span class="comment">// &lt;package&gt;å­èŠ‚ç‚¹</span></span><br><span class="line">        String mapperPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‰«ææŒ‡å®šçš„åŒ…ï¼Œå¹¶å‘MapperRegistryæ³¨å†ŒMapperæ¥å£</span></span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è· å–&lt;mapper&gt;èŠ‚ç‚¹çš„resourceã€urlã€classå±æ€§ï¼Œè¿™ä¸‰ä¸ªå±æ€§äº’æ–¥</span></span><br><span class="line">        String resource = child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        String url = child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        String mapperClass = child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†resourceæˆ–æ˜¯urlå±æ€§ï¼Œåˆ™åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// å¹¶é€šè¿‡è¯¥å¯¹è±¡è§£æresourceæˆ–æ˜¯urlå±æ€§æŒ‡å®šçš„Mapperé…ç½®æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">          InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">          <span class="comment">// åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line">          XMLMapperBuilder mapperParser = </span><br><span class="line">            <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource,</span><br><span class="line">                                 configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">          <span class="comment">// åˆ›å»ºXMLMapperBuilderå¯¹è±¡ï¼Œè§£ææ˜ å°„é…ç½®æ–‡ä»¶</span></span><br><span class="line">          XMLMapperBuilder mapperParser = </span><br><span class="line">            <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, </span><br><span class="line">                                 configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœ&lt;mapper&gt;èŠ‚ç‚¹æŒ‡å®šäº†classå±æ€§ï¼Œåˆ™å‘MapperRegistryæ³¨å†Œè¯¥Mapperæ¥å£</span></span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="XMLMapperBuilder"><a href="#XMLMapperBuilder" class="headerlink" title="XMLMapperBuilder"></a>XMLMapperBuilder</h2><p>é€šè¿‡å¯¹<code>XMLConfigBuilder.mapperElement()</code>æ–¹æ³•çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œ<code>XMLMapperBuilder</code>è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ï¼Œå®ƒç»§æ‰¿äº†<code>BaseBuilder</code>æŠ½è±¡ç±»ï¼Œä¹Ÿæ˜¯å…·ä½“å»ºé€ è€…çš„è§’è‰²ã€‚<code>XMLMapperBuilder.parse()</code>æ–¹æ³•æ˜¯è§£ææ˜ å°„æ–‡ä»¶çš„å…¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²åŠ è½½è¿‡è¯¥æ˜ å°„æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">    <span class="comment">// å°†resourceæ·»åŠ åˆ°Configurationâ€¢loadedResourcesé›†åˆä¸­ä¿å­˜ï¼Œå®ƒæ˜¯HashSet&lt;String&gt;</span></span><br><span class="line">    <span class="comment">// ç±»å‹çš„é›†åˆï¼Œå…¶ä¸­è®°å½•äº†å·²ç»åŠ æ ½è¿‡çš„æ˜ å°„æ–‡ä»¶ã€‚</span></span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;resultMap&gt;èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„&lt;cache-ref&gt;èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  <span class="comment">// å¤„ç†configurationElement()æ–¹æ³•ä¸­è§£æå¤±è´¥çš„SQLè¯­å¥èŠ‚ç‚¹</span></span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>XMLMapperBuilder</code>ä¹Ÿæ˜¯å°†æ¯ä¸ªèŠ‚ç‚¹çš„è§£æè¿‡ç¨‹å°è£…æˆäº†ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•ç”±<code>XMLMapperBuilder.configurationElement()</code>æ–¹æ³•è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configurationElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    String namespace = context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (namespace == <span class="keyword">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">    cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">    cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">    parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">    resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">    sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line">    buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>1. è§£æ<code>&lt;cache&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>MyBatis</code>æ‹¥æœ‰éå¸¸å¼ºå¤§çš„äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œé…ç½®ï¼Œ**<code>MyBatis</code>é»˜è®¤æƒ…**<br><strong>å†µä¸‹æ²¡æœ‰å¼€å¯äºŒçº§ç¼“å­˜ï¼Œå¦‚æœè¦ä¸ºæŸå‘½åç©ºé—´å¼€å¯äºŒçº§ç¼“å­˜åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ç›¸åº”æ˜ å°„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ <code>&lt;cache&gt;</code>èŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥é€šè¿‡é…ç½®<code>&lt;cache&gt;</code>èŠ‚ç‚¹çš„ç›¸å…³å±æ€§ï¼Œä¸ºäºŒçº§ç¼“å­˜é…ç½®ç›¸åº”çš„ç‰¹æ€§(æœ¬è´¨ä¸Šå°±æ˜¯æ·»åŠ ç›¸åº”çš„è£…é¥°å™¨)ã€‚</strong></p>
<p><code>XMLMapperBuilder.cacheElement()</code>æ–¹æ³•ä¸»è¦è´Ÿè´£è§£æ<code>&lt;cache&gt;</code>èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;PERPETUAL&quot;</span>);</span><br><span class="line">    Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);</span><br><span class="line">    String eviction = context.getStringAttribute(<span class="string">&quot;eviction&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">    Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);</span><br><span class="line">    Long flushInterval = context.getLongAttribute(<span class="string">&quot;flushInterval&quot;</span>);</span><br><span class="line">    Integer size = context.getIntAttribute(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> readWrite = !context.getBooleanAttribute(<span class="string">&quot;readOnly&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> blocking = context.getBooleanAttribute(<span class="string">&quot;blocking&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    Properties props = context.getChildrenAsProperties();</span><br><span class="line">    builderAssistant.useNewCache(</span><br><span class="line">      typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MapperBuilderAssistant</code>æ˜¯ä¸€ä¸ªè¾…åŠ©ç±»ï¼Œå…¶<code>useNewCache()</code>æ–¹æ³•è´Ÿè´£åˆ›å»º<code>Cache</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>Configuration.caches</code>é›†åˆä¸­ä¿å­˜ã€‚</p>
<p><code>Configuration</code>ä¸­çš„<code>caches</code>å­—æ®µæ˜¯<code>StrictMap&lt;Cache&gt;</code>ç±»å‹çš„å­—æ®µï¼Œå®ƒè®°å½•<code>Cache</code>çš„id(é»˜è®¤æ˜¯æ˜ å°„æ–‡ä»¶çš„<code>namespace</code>)ä¸<code>Cache</code>å¯¹è±¡(äºŒçº§ç¼“å­˜)ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p>
<p><code>StrictMap</code>ç»§æ‰¿äº†<code>HashMap</code>,å¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†å°‘è®¸ä¿®æ”¹ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨<code>StrictMap.put()</code>æ–¹æ³•ï¼Œå¦‚æœæ£€æµ‹åˆ°é‡å¤çš„<code>key</code>åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰é‡å¤çš„<code>key</code>åˆ™æ·»åŠ <code>key</code>ä»¥åŠ<code>value</code>ï¼ŒåŒæ—¶ä¼šæ ¹æ®<code>key</code>äº§ç”Ÿ<code>shortKey</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(String key, V value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (containsKey(key)) &#123; <span class="comment">// å¦‚æœå·²ç»åŒ…å«äº†è¯¥keyï¼Œåˆ™ç›´æ¥è¿”å›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(name + <span class="string">&quot; already contains value for &quot;</span> + key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (key.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§å°†keyåˆ‡åˆ†æˆæ•°ç»„ï¼Œå¹¶å°†æ•°ç»„çš„æœ€åä¸€é¡¹ä½œä¸ºshortKey</span></span><br><span class="line">    <span class="keyword">final</span> String shortKey = getShortName(key);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.get(shortKey) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸åŒ…å«æŒ‡å®šçš„sortKeyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹</span></span><br><span class="line">      <span class="keyword">super</span>.put(shortKey, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœshortKeyå·²å­˜åœ¨ï¼Œåˆ™å°†valueä¿®æ”¹æˆAmbiguityå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">super</span>.put(shortKey, (V) <span class="keyword">new</span> Ambiguity(shortKey));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value); <span class="comment">// å¦‚æœä¸åŒ…å«è¯¥keyï¼Œåˆ™æ·»åŠ é”®å€¼å¯¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Ambiguity</code>æ˜¯<code>StrictMap</code>ä¸­å®šä¹‰çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å­˜åœ¨<strong>äºŒä¹‰æ€§çš„é”®å€¼å¯¹</strong>ã€‚<code>Ambiguity</code>ä¸­ä½¿ç”¨<code>subject</code>å­—æ®µè®°å½•äº†å­˜åœ¨äºŒä¹‰æ€§çš„<code>key</code>ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„<code>getter</code>æ–¹æ³•ã€‚</p>
<p><code>StrictMap.get()</code>æ–¹æ³•ä¼šæ£€æµ‹<code>value</code>æ˜¯å¦å­˜åœ¨ä»¥åŠ<code>value</code>æ˜¯å¦ä¸º<code>Ambiguity</code>ç±»å‹å¯¹è±¡ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  V value = <span class="keyword">super</span>.get(key);</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœkeyæ²¡æœ‰å¯¹åº”çš„valueï¼Œå°±æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Ambiguity) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MapperBuilderAssistant. useNewCache()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Class&lt;? extends Cache&gt; evictionClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Long flushInterval,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Integer size,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> readWrite,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> blocking,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Properties props)</span> </span>&#123;</span><br><span class="line">  Cache cache = <span class="keyword">new</span> CacheBuilder(currentNamespace)</span><br><span class="line">    .implementation(valueOrDefault(typeClass, PerpetualCache.class))</span><br><span class="line">    .addDecorator(valueOrDefault(evictionClass, LruCache.class))</span><br><span class="line">    .clearInterval(flushInterval)</span><br><span class="line">    .size(size)</span><br><span class="line">    .readWrite(readWrite)</span><br><span class="line">    .blocking(blocking)</span><br><span class="line">    .properties(props)</span><br><span class="line">    .build();</span><br><span class="line">  configuration.addCache(cache);</span><br><span class="line">  currentCache = cache;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CacheBuilder</code>æ˜¯<code>Cache</code>çš„å»ºé€ è€…ï¼Œå…¶å­—æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯¹åº”çš„æ˜¯æ˜ å°„æ–‡ä»¶ä¸­é…ç½®çš„namespace</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"><span class="comment">// Cacheå¯¹è±¡çš„çœŸæ­£å®ç°ç±»</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends Cache&gt; implementation;</span><br><span class="line"><span class="comment">// è£…é¥°å™¨é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Cache&gt;&gt; decorators;</span><br><span class="line"><span class="comment">// ç¼“å­˜å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> Integer size;</span><br><span class="line"><span class="comment">// æ¸…ç†æ—¶é—´å‘¨æœŸ</span></span><br><span class="line"><span class="keyword">private</span> Long clearInterval;</span><br><span class="line"><span class="comment">// æ˜¯å¦å¯è¯»å†™</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> readWrite;</span><br><span class="line"><span class="comment">// å…¶ä»–é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> Properties properties;</span><br><span class="line"><span class="comment">// æ˜¯å¦é˜»å¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> blocking;</span><br></pre></td></tr></table></figure>

<p><code>CacheBuilder.build()</code>æ–¹æ³•ï¼Œæ ¹æ®<code>CacheBuilder</code>ä¸­ä¸Šè¿°å­—æ®µçš„å€¼åˆ›å»º<code>Cache</code>å¯¹è±¡å¹¶æ·»åŠ åˆé€‚çš„è£…é¥°å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setDefaultImplementations();</span><br><span class="line">  Cache cache = newBaseCacheInstance(implementation, id);</span><br><span class="line">  setCacheProperties(cache);</span><br><span class="line">  <span class="comment">// issue #352, do not apply decorators to custom caches</span></span><br><span class="line">  <span class="keyword">if</span> (PerpetualCache.class.equals(cache.getClass())) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends Cache&gt; decorator : decorators) &#123;</span><br><span class="line">      cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">      setCacheProperties(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    cache = setStandardDecorators(cache);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123;</span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CacheBuilder.setCacheProperties()</code>æ–¹æ³•ä¼šæ ¹æ®<code>&lt;cache&gt;</code>èŠ‚ç‚¹ä¸‹é…ç½®çš„<code>&lt;property&gt;</code>ä¿¡æ¯ï¼Œåˆå§‹åŒ–<code>Cache</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCacheProperties</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">    MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">      String name = (String) entry.getKey();</span><br><span class="line">      String value = (String) entry.getValue();</span><br><span class="line">      <span class="keyword">if</span> (metaCache.hasSetter(name)) &#123;</span><br><span class="line">        Class&lt;?&gt; type = metaCache.getSetterType(name);</span><br><span class="line">        <span class="keyword">if</span> (String.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">int</span>.class == type</span><br><span class="line">                   || Integer.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Integer.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">long</span>.class == type</span><br><span class="line">                   || Long.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Long.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">short</span>.class == type</span><br><span class="line">                   || Short.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Short.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">byte</span>.class == type</span><br><span class="line">                   || Byte.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Byte.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">float</span>.class == type</span><br><span class="line">                   || Float.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Float.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">boolean</span>.class == type</span><br><span class="line">                   || Boolean.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Boolean.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">double</span>.class == type</span><br><span class="line">                   || Double.class == type) &#123;</span><br><span class="line">          metaCache.setValue(name, Double.valueOf(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (InitializingObject.class.isAssignableFrom(cache.getClass()))&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ((InitializingObject) cache).initialize();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CacheBuilder.setStandardDecorators()</code>æ–¹æ³•ä¼šæ ¹æ®<code>CacheBuilder</code>ä¸­å„ä¸ªå­—æ®µçš„å€¼ï¼Œä¸º<code>cache</code>å¯¹è±¡æ·»åŠ å¯¹åº”çš„è£…é¥°å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Cache <span class="title">setStandardDecorators</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="keyword">null</span> &amp;&amp; metaCache.hasSetter(<span class="string">&quot;size&quot;</span>)) &#123;</span><br><span class="line">      metaCache.setValue(<span class="string">&quot;size&quot;</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clearInterval != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> ScheduledCache(cache);</span><br><span class="line">      ((ScheduledCache) cache).setClearInterval(clearInterval);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (readWrite) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> SerializedCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">    cache = <span class="keyword">new</span> SynchronizedCache(cache);</span><br><span class="line">    <span class="keyword">if</span> (blocking) &#123;</span><br><span class="line">      cache = <span class="keyword">new</span> BlockingCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>XMLMapperBuilder.cacheElement()</code>æ–¹æ³•ä¼šä¸ºæ¯ä¸ª<code>namespace</code>åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„<code>Cache</code>å¯¹è±¡ï¼Œå¹¶åœ¨<code>Configuration.caches</code>é›†åˆä¸­è®°å½•<code>namespace</code>ä¸<code>Cache</code>å¯¹è±¡ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p>
<p>å¦‚æœå¸Œæœ›å¤šä¸ª<code>namespace</code>å…±ç”¨åŒä¸€ä¸ªäºŒçº§ç¼“å­˜ï¼Œå³åŒä¸€ä¸ª<code>Cache</code>å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>&lt;cache-ref&gt;</code>ç‚¹è¿›è¡Œé…ç½®ã€‚</p>
<blockquote>
<p><code>XMLMapperBuilder.cacheReffilement()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹ã€‚</p>
</blockquote>
<p>è¿™é‡Œé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯<code>Configuration.cacheRefMap</code>é›†åˆï¼Œè¯¥é›†åˆæ˜¯<code>HashMap&lt;Stringï¼ŒString&gt;</code>ç±»å‹ï¼Œå…¶ä¸­<code>key</code>æ˜¯<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹æ‰€åœ¨çš„<code>namespace</code>ï¼Œ<code>value</code>æ˜¯<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹çš„<code>namespace</code>å±æ€§æ‰€æŒ‡å®šçš„<code>namespace</code>ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰è€…å…±ç”¨åè€…çš„<code>Cache</code>å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾ï¼Œ<code>namespace2</code>å…±ç”¨äº†<code>namespace1</code>çš„<code>Cache</code>å¯¹è±¡ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/10/image-20200710104632511_3VqX9N.png" alt="image-20200710104632511"></p>
<p><code>XMLMapperBuilder.cacheReffilement()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheRefElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">    configuration.addCacheRef(</span><br><span class="line">      builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">    CacheRefResolver cacheRefResolver = <span class="keyword">new</span> CacheRefResolver(</span><br><span class="line">      builderAssistant, context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      cacheRefResolver.resolveCacheRef();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœè§£æè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™æ·»åŠ åˆ°Configuration.incompleteCacheRefsé›†åˆï¼Œç¨åå†è§£æ</span></span><br><span class="line">      configuration.addIncompleteCacheRef(cacheRefResolver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CacheRefResolver</code>æ˜¯ä¸€ä¸ªç®€å•çš„<code>Cache</code>å¼•ç”¨è§£æå™¨ï¼Œå…¶ä¸­å°è£…äº†è¢«å¼•ç”¨çš„<code>namespace</code>ä»¥åŠå½“å‰<code>XMLMapperBuilder</code>å¯¹åº”çš„<code>MapperBuilderAssistant</code>å¯¹è±¡ã€‚</p>
<p><code>CacheRefResolver.resolveCacheRef()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>MapperBuilderAssistant.useCacheRef()</code>æ–¹æ³•ã€‚åœ¨<code>MapperBuilderAssistant.useCacheRef()</code>æ–¹æ³•ä¸­ä¼šé€šè¿‡<code>namespace</code>æŸ¥æ‰¾è¢«å¼•ç”¨çš„<code>Cache</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useCacheRef</span><span class="params">(String namespace)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (namespace == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      unresolvedCacheRef = <span class="keyword">true</span>;</span><br><span class="line">      Cache cache = configuration.getCache(namespace);</span><br><span class="line">      <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      currentCache = cache;</span><br><span class="line">      unresolvedCacheRef = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">return</span> cache;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>å¦ä¸€ä¸ªéœ€è¦äº†è§£çš„<code>Configuration</code>å­—æ®µæ˜¯<code>incompleteCacheRefs</code>é›†åˆï¼Œå®ƒæ˜¯<code>LinkedList&lt;CacheRefResolver&gt;</code>ç±»å‹ï¼Œå…¶ä¸­è®°å½•äº†å½“å‰è§£æå‡ºç°å¼‚å¸¸çš„<code>CacheRefResolver</code>å¯¹è±¡ã€‚</p>
<p><strong>3. è§£æ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>select</code>è¯­å¥æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†æ˜¯ä¸€å¼ <strong>äºŒç»´è¡¨</strong>ï¼Œ<u>æ°´å¹³æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€ä¸ªä¸ªå­—æ®µï¼Œå‚ç›´æ–¹å‘ä¸Šçœ‹æ˜¯ä¸€æ¡æ¡è®°å½•</u>ã€‚</p>
<p>è€Œ<code>Java</code>æ˜¯é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå¯¹è±¡æ˜¯æ ¹æ®ç±»å®šä¹‰åˆ›å»ºçš„ï¼Œç±»ä¹‹é—´çš„å¼•ç”¨å…³ç³»å¯ä»¥è®¤ä¸ºæ˜¯åµŒå¥—çš„ç»“æ„ã€‚</p>
<p>åœ¨<code>JDBC</code>ç¼–ç¨‹ä¸­ï¼Œä¸ºäº†å°†ç»“æœé›†ä¸­çš„æ•°æ®æ˜ å°„æˆå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å†™ä»£ç ä»ç»“æœé›†ä¸­è·å–æ•°æ®ï¼Œç„¶åå°è£…æˆå¯¹åº”çš„å¯¹è±¡å¹¶è®¾ç½®å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œè¿™äº›éƒ½æ˜¯å¤§é‡çš„é‡å¤æ€§ä»£ç ã€‚</p>
<p>ä¸ºäº†å‡å°‘è¿™äº›é‡å¤çš„ä»£ç ï¼Œ<code>MyBatis</code>ä½¿ç”¨<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹å®šä¹‰äº†ç»“æœé›†ä¸ç»“æœå¯¹è±¡(<code>JavaBean</code>å¯¹è±¡)ä¹‹é—´çš„æ˜ å°„è§„åˆ™ï¼Œ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†çš„æ˜ å°„éœ€æ±‚ï¼Œä»è€Œå‡å°‘å¼€å‘äººå‘˜çš„é‡å¤æ€§åŠ³åŠ¨ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</p>
<p>æ¯ä¸ª<code>ResultMapping</code>å¯¹è±¡è®°å½•äº†ç»“æœé›†ä¸­çš„ä¸€åˆ—ä¸<code>JavaBean</code>ä¸­ä¸€ä¸ªå±æ€§ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ä¸‹é™¤äº†<code>&lt;discriminator&gt;</code>å­èŠ‚ç‚¹çš„å…¶ä»–å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šè¢«è§£ææˆå¯¹åº”çš„<code>ResultMapping</code>å¯¹è±¡ã€‚æ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="comment">//  åº” èŠ‚ ç‚¹çš„propertyå± æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸ è¯¥ åˆ—è¿› è¡Œæ˜ å°„çš„å± æ€§</span></span><br><span class="line"><span class="keyword">private</span> String property;</span><br><span class="line"><span class="comment">// æ•°æ®åº“è·å–çš„åˆ—åæˆ–åˆ«å</span></span><br><span class="line"><span class="keyword">private</span> String column;</span><br><span class="line"><span class="comment">// å¯¹åº”çš„javaç±»å‹ï¼ŒJavaBeançš„å®Œå…¨é™å®šå</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line"><span class="comment">// JDBCç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„typeHandlerå±æ€§ï¼Œè¡¨ç¤ºçš„æ˜¯ç±»å‹å¤„ç†å™¨ï¼Œå®ƒä¼šè¦†ç›–é»˜è®¤çš„ç±»å‹å¤„ç†å™¨ï¼Œåé¢ä¼šä»‹ç»è¯¥å­—æ®µçš„ä½œç”¨</span></span><br><span class="line"><span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„resultMapå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;resultMap&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒè´Ÿè´£å°†ç»“æœé›†ä¸­çš„ä¸€éƒ¨</span></span><br><span class="line"><span class="comment">// åˆ†åˆ—æ˜ å°„æˆå…¶ä»–å…³è”çš„ç»“æœå¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡joinæ–¹å¼è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œç„¶åç›´æ¥æ˜ å°„æˆå¤šä¸ªå¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">// å¹¶åŒæ—¶è®¾ç½®è¿™äº›å¯¹è±¡ä¹‹é—´çš„ç»„åˆå…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„selectå±æ€§ï¼Œè¯¥å±æ€§é€šè¿‡idå¼•ç”¨äº†å¦ä¸€ä¸ª&lt;select&gt;èŠ‚ç‚¹å®šä¹‰ï¼Œå®ƒä¼šæŠŠæŒ‡å®šçš„åˆ—çš„å€¼ä¼ å…¥</span></span><br><span class="line"><span class="comment">// selectå±æ€§æŒ‡å®šçš„selectè¯­å¥ä¸­ä½œä¸ºå‚æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚ä½¿ç”¨selectå±æ€§å¯èƒ½ä¼šå¯¼è‡´N+1é—®é¢˜</span></span><br><span class="line"><span class="keyword">private</span> String nestedQueryId;</span><br><span class="line"><span class="comment">// éç©ºå­—æ®µé›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> String columnPrefix;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> String resultSet;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> String foreignColumn;</span><br><span class="line"><span class="comment">// æ˜¯å¦å»¶è¿ŸåŠ è½½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br></pre></td></tr></table></figure>

<p><code>ResultMapping</code>ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨<code>Builder</code>ç±»ï¼Œä¹Ÿåº”ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œè¯¥<code>Builder</code>ç±»ä¸»è¦ç”¨äºæ•°æ®æ•´ç†å’Œæ•°æ®æ ¡éªŒæ ¡éªŒã€‚</p>
<p>å¦ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»æ˜¯<code>ResultMap</code>ï¼Œæ¯ä¸ª<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹éƒ½ä¼šè¢«è§£ææˆä¸€ä¸ª<code>ResultMap</code>å¯¹è±¡ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ‰€å®šä¹‰çš„æ˜ å°„å…³ç³»ï¼Œåˆ™ä½¿ç”¨<code>ResultMapping</code>å¯¹è±¡è¡¨ç¤ºã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/12/image-20200712084001741_Piqi53.png" alt="image-20200712084001741"></p>
<p><code>ResultMap</code>å­—æ®µå®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Configurationå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„idå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="comment">// å¯¹åº”èŠ‚ç‚¹çš„typeå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line"><span class="comment">// ResultMappingå¯¹è±¡é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰IDæ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;id&gt;èŠ‚ç‚¹å’Œ&lt;constructor&gt;èŠ‚ç‚¹çš„&lt;idArg&gt;å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚&lt;constructor&gt;æ‰€æœ‰å­å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•äº†æ˜ å°„å…³ç³»ä¸­ä¸å¸¦æœ‰Constructoræ ‡å¿—çš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line"><span class="comment">// è®°å½•æ‰€æœ‰æ˜ å°„å…³ç³»ä¸­æ¶‰åŠçš„columnå±æ€§çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line"><span class="comment">// é‰´åˆ«å™¨</span></span><br><span class="line"><span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line"><span class="comment">// æ˜¯å¦å«æœ‰åµŒå¥—çš„ç»“æœæ˜ å°„ï¼Œå¦‚æœæŸä¸ªæ˜ å°„å…³ç³»ä¸­å­˜åœ¨resultMapå±æ€§ï¼Œä¸”ä¸å­˜åœ¨resultSetå±æ€§ï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line"><span class="comment">// æ˜¯å¦å«æœ‰åµŒå¥—æŸ¥è¯¢ï¼Œå¦‚æœæŸä¸ªå±æ€§æ˜ å°„å­˜åœ¨selectå±æ€§ï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line"><span class="comment">// æ˜¯å¦å¼€å¯è‡ªåŠ¨æ˜ å°„</span></span><br><span class="line"><span class="keyword">private</span> Boolean autoMapping;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>XMLMapperBuilder</code>ä¸­é€šè¿‡<code>resultMapElements()</code>æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„å…¨éƒ¨<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨<code>resultMapElement()</code>æ–¹æ³•å¤„ç†æ¯ä¸ª<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ResultMap <span class="title">resultMapElement</span><span class="params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  String id </span><br><span class="line">    = resultMapNode.getStringAttribute(</span><br><span class="line">    		<span class="string">&quot;id&quot;</span>, resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  String type </span><br><span class="line">    = resultMapNode.getStringAttribute(</span><br><span class="line">    <span class="string">&quot;type&quot;</span>,resultMapNode.getStringAttribute(</span><br><span class="line">      <span class="string">&quot;ofType&quot;</span>,resultMapNode.getStringAttribute(<span class="string">&quot;resultType&quot;</span>,</span><br><span class="line">                                     resultMapNode.getStringAttribute(<span class="string">&quot;javaType&quot;</span>))));</span><br><span class="line">  String extend = resultMapNode.getStringAttribute(<span class="string">&quot;extends&quot;</span>);</span><br><span class="line">  Boolean autoMapping = resultMapNode.getBooleanAttribute(<span class="string">&quot;autoMapping&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">  Discriminator discriminator = <span class="keyword">null</span>;</span><br><span class="line">  List&lt;ResultMapping&gt; resultMappings = <span class="keyword">new</span> ArrayList&lt;ResultMapping&gt;();</span><br><span class="line">  resultMappings.addAll(additionalResultMappings);</span><br><span class="line">  List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">  <span class="keyword">for</span> (XNode resultChild : resultChildren) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">        flags.add(ResultFlag.ID);</span><br><span class="line">      &#125;</span><br><span class="line">      resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ResultMapResolver resultMapResolver = <span class="keyword">new</span> ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IncompleteElementException  e) &#123;</span><br><span class="line">    configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å¤„ç†<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥è¿‡ç¨‹åœ¨æ‰§è¡Œè·å–åˆ°<code>id</code>å±æ€§å’Œ<code>type</code>å±æ€§ä¹‹åï¼Œå°±ä¼šé€šè¿‡<code>XMLMapperBuilder.buildResultMappingFromContext()</code>æ–¹æ³•ä¸º<code>&lt;result&gt;</code>èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„<code>ResultMapping</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ResultMapping <span class="title">buildResultMappingFromContext</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  String property;</span><br><span class="line">  <span class="comment">// è·å–propertyçš„å±æ€§å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">    property = context.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    property = context.getStringAttribute(<span class="string">&quot;property&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  String column = context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">  String javaType = context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">  String jdbcType = context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">  String nestedSelect = context.getStringAttribute(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">  String nestedResultMap = context.getStringAttribute(</span><br><span class="line">    <span class="string">&quot;resultMap&quot;</span>,processNestedResultMappings(context, </span><br><span class="line">                                            Collections.&lt;ResultMapping&gt;emptyList()));</span><br><span class="line">  String notNullColumn = context.getStringAttribute(<span class="string">&quot;notNullColumn&quot;</span>);</span><br><span class="line">  String columnPrefix = context.getStringAttribute(<span class="string">&quot;columnPrefix&quot;</span>);</span><br><span class="line">  String typeHandler = context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">  String resultSet = context.getStringAttribute(<span class="string">&quot;resultSet&quot;</span>);</span><br><span class="line">  String foreignColumn = context.getStringAttribute(<span class="string">&quot;foreignColumn&quot;</span>);</span><br><span class="line">  <span class="keyword">boolean</span> lazy = <span class="string">&quot;lazy&quot;</span>.equals(</span><br><span class="line">    context.getStringAttribute(<span class="string">&quot;fetchType&quot;</span>, </span><br><span class="line">                               configuration.isLazyLoadingEnabled() ? <span class="string">&quot;lazy&quot;</span> : <span class="string">&quot;eager&quot;</span>));</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass </span><br><span class="line">    = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler);</span><br><span class="line">  JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">  <span class="keyword">return</span> builderAssistant.buildResultMapping(</span><br><span class="line">    resultType, property, column, javaTypeClass, </span><br><span class="line">    jdbcTypeEnum, nestedSelect, nestedResultMap, </span><br><span class="line">    notNullColumn, columnPrefix, typeHandlerClass, flags, </span><br><span class="line">    resultSet, foreignColumn, lazy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MapperBuilderAssistant.buildResultMapping()</code>çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">buildResultMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; resultType,</span></span></span><br><span class="line"><span class="function"><span class="params">  String property,</span></span></span><br><span class="line"><span class="function"><span class="params">  String column,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; javaType,</span></span></span><br><span class="line"><span class="function"><span class="params">  JdbcType jdbcType,</span></span></span><br><span class="line"><span class="function"><span class="params">  String nestedSelect,</span></span></span><br><span class="line"><span class="function"><span class="params">  String nestedResultMap,</span></span></span><br><span class="line"><span class="function"><span class="params">  String notNullColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">  String columnPrefix,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">  List&lt;ResultFlag&gt; flags,</span></span></span><br><span class="line"><span class="function"><span class="params">  String resultSet,</span></span></span><br><span class="line"><span class="function"><span class="params">  String foreignColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">boolean</span> lazy)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType);</span><br><span class="line">  TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);</span><br><span class="line">  List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(configuration, property, column, javaTypeClass)</span><br><span class="line">    .jdbcType(jdbcType)</span><br><span class="line">    .nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="keyword">true</span>))</span><br><span class="line">    .nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="keyword">true</span>))</span><br><span class="line">    .resultSet(resultSet)</span><br><span class="line">    .typeHandler(typeHandlerInstance)</span><br><span class="line">    .flags(flags == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;() : flags)</span><br><span class="line">    .composites(composites)</span><br><span class="line">    .notNullColumns(parseMultipleColumnNames(notNullColumn))</span><br><span class="line">    .columnPrefix(columnPrefix)</span><br><span class="line">    .foreignColumn(foreignColumn)</span><br><span class="line">    .lazy(lazy)</span><br><span class="line">    .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°<code>ResultMapping</code>å¯¹è±¡é›†åˆä¹‹åï¼Œä¼šè°ƒç”¨<code>ResultMapResolver.resolve()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨<code>MapperBuilderAssistant.addResultMap()</code>æ–¹æ³•åˆ›å»º<code>ResultMap</code>å¯¹è±¡ï¼Œå¹¶å°†<code>ResultMap</code>å¯¹è±¡æ·»åŠ åˆ°<code>Configuration.resultMaps</code>é›†åˆä¸­ä¿å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">addResultMap</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String id,</span></span></span><br><span class="line"><span class="function"><span class="params">  Class&lt;?&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">  String extend,</span></span></span><br><span class="line"><span class="function"><span class="params">  Discriminator discriminator,</span></span></span><br><span class="line"><span class="function"><span class="params">  List&lt;ResultMapping&gt; resultMappings,</span></span></span><br><span class="line"><span class="function"><span class="params">  Boolean autoMapping)</span> </span>&#123;</span><br><span class="line">  id = applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">  extend = applyCurrentNamespace(extend, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extend != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!configuration.hasResultMap(extend)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ResultMap resultMap = configuration.getResultMap(extend);</span><br><span class="line">    List&lt;ResultMapping&gt; extendedResultMappings = <span class="keyword">new</span> ArrayList&lt;ResultMapping&gt;(resultMap.getResultMappings());</span><br><span class="line">    extendedResultMappings.removeAll(resultMappings);</span><br><span class="line">    <span class="comment">// Remove parent constructor if this resultMap declares a constructor.</span></span><br><span class="line">    <span class="keyword">boolean</span> declaresConstructor = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">      <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">        declaresConstructor = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (declaresConstructor) &#123;</span><br><span class="line">      Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator();</span><br><span class="line">      <span class="keyword">while</span> (extendedResultMappingsIter.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">          extendedResultMappingsIter.remove();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resultMappings.addAll(extendedResultMappings);</span><br><span class="line">  &#125;</span><br><span class="line">  ResultMap resultMap = <span class="keyword">new</span> ResultMap.Builder(configuration, id, type, resultMappings, autoMapping)</span><br><span class="line">    .discriminator(discriminator)</span><br><span class="line">    .build();</span><br><span class="line">  configuration.addResultMap(resultMap);</span><br><span class="line">  <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;constructor&gt;</code>èŠ‚ç‚¹çš„è§£æï¼Œç”±<code>XMLMapperBuilder.processConstructorElement()</code>æ–¹æ³•å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processConstructorElement</span><span class="params">(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  List&lt;XNode&gt; argChildren = resultChild.getChildren();</span><br><span class="line">  <span class="keyword">for</span> (XNode argChild : argChildren) &#123;</span><br><span class="line">    List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">    flags.add(ResultFlag.CONSTRUCTOR);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;idArg&quot;</span>.equals(argChild.getName())) &#123;</span><br><span class="line">      flags.add(ResultFlag.ID);</span><br><span class="line">    &#125;</span><br><span class="line">    resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åä¼šè§£æ<code>&lt;association&gt;</code>èŠ‚ç‚¹ï¼Œæ­£å¦‚å‰é¢å¯¹<code>XMLMapperBuilder.resultMapElement()</code>æ–¹æ³•çš„ä»‹ç»ï¼Œ<code>&lt;association&gt;</code>èŠ‚ç‚¹ä¹Ÿæ˜¯åœ¨<code>XMLMapperBuilder.buildResultMappingFromContext()</code>æ–¹æ³•ä¸­å®Œæˆè§£æçš„ã€‚</p>
<p><code>&lt;discriminator&gt;</code>èŠ‚ç‚¹çš„è§£æï¼Œè¯¥è§£æè¿‡ç¨‹ç”±<code>XMLMapperBuilder.processDiscriminatorElement()</code>æ–¹æ³•å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Discriminator <span class="title">processDiscriminatorElement</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  String column = context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">  String javaType = context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">  String jdbcType = context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">  String typeHandler = context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler);</span><br><span class="line">  JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">  Map&lt;String, String&gt; discriminatorMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">  <span class="keyword">for</span> (XNode caseChild : context.getChildren()) &#123;</span><br><span class="line">    String value = caseChild.getStringAttribute(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    String resultMap = caseChild.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>, processNestedResultMappings(caseChild, resultMappings));</span><br><span class="line">    discriminatorMap.put(value, resultMap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. è§£æ<code>&lt;sql&gt;</code>èŠ‚ç‚¹</strong></p>
<p><code>XMLMapperBuilder.sqlElement()</code>æ–¹æ³•è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨éƒ¨<code>&lt;sql&gt;</code>èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  sqlElement(list, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">    String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line">    String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    id = builderAssistant.applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">      sqlFragments.put(id, context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="XMLStatementBuilder"><a href="#XMLStatementBuilder" class="headerlink" title="XMLStatementBuilder"></a>XMLStatementBuilder</h2><p>é™¤äº†èŠ‚ç‚¹è§£æï¼Œæ˜ å°„æ–‡ä»¶ä¸­è¿˜æœ‰ä¸€ç±»æ¯”è¾ƒé‡è¦çš„èŠ‚ç‚¹éœ€è¦è§£æï¼Œä¹Ÿå°±æ˜¯<code>SQL</code>èŠ‚ç‚¹ã€‚<code>SQL</code>èŠ‚ç‚¹ä¸»è¦ç”¨äºå®šä¹‰<code>SQL</code>è¯­å¥ï¼Œ<code>SQL</code>èŠ‚ç‚¹ç”±<code>XMLStatementBuilder</code>è´Ÿè´£è§£æã€‚</p>
<p><code>MyBatis</code>ä½¿ç”¨<code>SqlSource</code>æ¥å£è¡¨ç¤ºæ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£ä¸­å®šä¹‰çš„<code>SQL</code>è¯­å¥ï¼Œä½†å®ƒè¡¨ç¤ºçš„<code>SQL</code>è¯­å¥æ˜¯ä¸èƒ½ç›´æ¥è¢«æ•°æ®åº“æ‰§è¡Œçš„ï¼Œå› ä¸ºå…¶ä¸­å¯èƒ½å«æœ‰åŠ¨æ€<code>SQL</code>è¯­å¥ç›¸å…³çš„èŠ‚ç‚¹æˆ–æ˜¯å ä½ç¬¦ç­‰éœ€è¦è§£æçš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line">	<span class="comment">// getBoundSql()æ–¹æ³•ä¼šæ ¹æ®æ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£æè¿°çš„SQLè¯­å¥ï¼Œä»¥åŠä¼ å…¥çš„å‚æ•°ï¼Œè¿”å›å¯æ‰§è¡Œçš„SQL</span></span><br><span class="line">  <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MyBatis</code>ä½¿ç”¨<code>MappedStatement</code>è¡¨ç¤ºæ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>SQL</code>èŠ‚ç‚¹ï¼Œ<code>MappedStatement</code>åŒ…å«äº†è¿™äº›èŠ‚ç‚¹çš„å¾ˆå¤šå±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// idå±æ€§</span></span><br><span class="line"><span class="keyword">private</span> String resource;</span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="keyword">private</span> Integer fetchSize;</span><br><span class="line"><span class="keyword">private</span> Integer timeout;</span><br><span class="line"><span class="keyword">private</span> StatementType statementType;</span><br><span class="line"><span class="keyword">private</span> ResultSetType resultSetType;</span><br><span class="line"><span class="comment">// å¯¹åº”ä¸€æ¡sqlè¯­å¥</span></span><br><span class="line"><span class="keyword">private</span> SqlSource sqlSource;</span><br><span class="line"><span class="keyword">private</span> Cache cache;</span><br><span class="line"><span class="keyword">private</span> ParameterMap parameterMap;</span><br><span class="line"><span class="keyword">private</span> List&lt;ResultMap&gt; resultMaps;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> flushCacheRequired;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> useCache;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> resultOrdered;</span><br><span class="line"><span class="comment">// sqlç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> SqlCommandType sqlCommandType;</span><br><span class="line"><span class="keyword">private</span> KeyGenerator keyGenerator;</span><br><span class="line"><span class="keyword">private</span> String[] keyProperties;</span><br><span class="line"><span class="keyword">private</span> String[] keyColumns;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line"><span class="keyword">private</span> String databaseId;</span><br><span class="line"><span class="keyword">private</span> Log statementLog;</span><br><span class="line"><span class="keyword">private</span> LanguageDriver lang;</span><br><span class="line"><span class="keyword">private</span> String[] resultSets;</span><br></pre></td></tr></table></figure>

<p><code>XMLStatementBuilder.parseStatementNode()</code>æ–¹æ³•æ˜¯è§£æ<code>SQL</code>èŠ‚ç‚¹çš„å…¥å£å‡½æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="keyword">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Integer fetchSize = context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">  Integer timeout = context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  String parameterMap = context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">  String parameterType = context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">  String resultMap = context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">  String resultType = context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  String lang = context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">  LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  String resultSetType = context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">  StatementType statementType = </span><br><span class="line">    StatementType.valueOf(</span><br><span class="line">    context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">  ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®èŠ‚ç‚¹åç§°å†³å®šSqlCommandType</span></span><br><span class="line">  String nodeName = context.getNode().getNodeName();</span><br><span class="line">  SqlCommandType sqlCommandType = </span><br><span class="line">    SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">  <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">  XMLIncludeTransformer includeParser = </span><br><span class="line">    <span class="keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">  includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">  processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">  SqlSource sqlSource = </span><br><span class="line">    langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">  String resultSets = context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">  String keyProperty = context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  KeyGenerator keyGenerator;</span><br><span class="line">  String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">    keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyGenerator = </span><br><span class="line">      context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                                  configuration.isUseGeneratedKeys() </span><br><span class="line">                                  &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">      ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(</span><br><span class="line">    id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">    fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, </span><br><span class="line">    resultTypeClass,resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">    keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>1. è§£æ<code>&lt;include&gt;</code>èŠ‚ç‚¹</strong></p>
<p>åœ¨è§£æ<code>SQL</code>èŠ‚ç‚¹ä¹‹å‰ï¼Œé¦–å…ˆé€šè¿‡<code>XMLIncludeTransformer</code>è§£æ<code>SQL</code>è¯­å¥ä¸­çš„<code>&lt;include&gt;</code>èŠ‚ç‚¹ï¼Œè¯¥è¿‡ç¨‹ä¼šå°†<code>&lt;include&gt;</code>èŠ‚ç‚¹æ›¿æ¢æˆ<code>&lt;sql&gt;</code>èŠ‚ç‚¹ä¸­å®šä¹‰çš„<code>SQL</code>ç‰‡æ®µï¼Œå¹¶å°†å…¶ä¸­çš„<code>$&#123;xxx&#125;</code>å ä½ç¬¦æ›¿æ¢æˆçœŸå®çš„å‚æ•°ï¼Œè¯¥è§£æè¿‡ç¨‹åœ¨<code>XMLIncludeTransformer.applyIncludes()</code>æ–¹æ³•ä¸­å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyIncludes</span><span class="params">(Node source)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–mybatis-config.xmlä¸­&lt;properties&gt;èŠ‚ç‚¹ä¸‹å®šä¹‰çš„å˜é‡é›†åˆ</span></span><br><span class="line">  Properties variablesContext = <span class="keyword">new</span> Properties();</span><br><span class="line">  Properties configurationVariables = configuration.getVariables();</span><br><span class="line">  <span class="keyword">if</span> (configurationVariables != <span class="keyword">null</span>) &#123;</span><br><span class="line">    variablesContext.putAll(configurationVariables);</span><br><span class="line">  &#125;</span><br><span class="line">  applyIncludes(source, variablesContext, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†&lt;include&gt;èŠ‚ç‚¹çš„é‡è½½æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyIncludes</span><span class="params">(Node source, <span class="keyword">final</span> Properties variablesContext, <span class="keyword">boolean</span> included)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (source.getNodeName().equals(<span class="string">&quot;include&quot;</span>)) &#123;</span><br><span class="line">    Node toInclude = findSqlFragment(getStringAttribute(source, <span class="string">&quot;refid&quot;</span>), variablesContext);</span><br><span class="line">    Properties toIncludeContext = getVariablesContext(source, variablesContext);</span><br><span class="line">    applyIncludes(toInclude, toIncludeContext, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;</span><br><span class="line">      toInclude = source.getOwnerDocument().importNode(toInclude, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    source.getParentNode().replaceChild(toInclude, source);</span><br><span class="line">    <span class="keyword">while</span> (toInclude.hasChildNodes()) &#123;</span><br><span class="line">      toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);</span><br><span class="line">    &#125;</span><br><span class="line">    toInclude.getParentNode().removeChild(toInclude);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (included &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// replace variables in attribute values</span></span><br><span class="line">      NamedNodeMap attributes = source.getAttributes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">        Node attr = attributes.item(i);</span><br><span class="line">        attr.setNodeValue(PropertyParser.parse(attr.getNodeValue(), variablesContext));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NodeList children = source.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">      applyIncludes(children.item(i), variablesContext, included);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (included &amp;&amp; source.getNodeType() == Node.TEXT_NODE</span><br><span class="line">             &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">// replace variables in text node</span></span><br><span class="line">    source.setNodeValue(PropertyParser.parse(source.getNodeValue(), variablesContext));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;inClude&gt;</code>èŠ‚ç‚¹å’Œ<code>&lt;sql&gt;</code>èŠ‚ç‚¹å¯ä»¥é…åˆä½¿ç”¨ã€å¤šå±‚åµŒå¥—ï¼Œå®ç°æ›´åŠ å¤æ‚çš„<code>sql</code>ç‰‡æ®µçš„é‡ç”¨ï¼Œè¿™æ ·çš„è¯ï¼Œè§£æè¿‡ç¨‹å°±ä¼šé€’å½’æ›´å¤šå±‚ï¼Œæµç¨‹å˜å¾—æ›´åŠ å¤æ‚ã€‚</p>
<p><strong>2. è§£æ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹</strong></p>
<p>åœ¨<code>&lt;insert&gt;</code>ã€<code>&lt;update&gt;</code>èŠ‚ç‚¹ä¸­å¯ä»¥å®šä¹‰<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹æ¥è§£å†³ä¸»é”®è‡ªå¢é—®é¢˜ï¼Œ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹å¯¹åº”çš„<code>KeyGenerator</code>æ¥å£åœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œç°åœ¨é‡ç‚¹å…³èŠ‚ç‚¹çš„è§£æã€‚</p>
<p><code>XMLStatementBuilder.processSelectKeyNodes()</code>æ–¹æ³•è´Ÿè´£è§£æ<code>SQL</code>èŠ‚ç‚¹ä¸­å­èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectKeyNodes</span><span class="params">(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å…¨éƒ¨selectKeyèŠ‚ç‚¹</span></span><br><span class="line">  List&lt;XNode&gt; selectKeyNodes = context.evalNodes(<span class="string">&quot;selectKey&quot;</span>);</span><br><span class="line">  <span class="comment">// è§£æselectKeyèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, <span class="keyword">null</span>);</span><br><span class="line">  removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>parseSelectKeyNodes()</code>æ–¹æ³•ä¸­ä¼šä¸º<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ç”Ÿæˆ<code>id</code>ï¼Œæ£€æµ‹<code>databaseld</code>æ˜¯å¦åŒ¹é…ä»¥åŠæ˜¯å¦å·±ç»åŠ è½½è¿‡ç›¸åŒ<code>id</code>ä¸”<code>databaseld</code>ä¸ä¸ºç©ºçš„<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨<code>parseSelectKeyNode()</code>æ–¹æ³•å¤„ç†æ¯ä¸ª<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹ã€‚<br>åœ¨<code>parseSelectKeyNode()</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè¯»å–<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹çš„ä¸€ç³»åˆ—å±æ€§ï¼Œç„¶åè°ƒç”¨<code>LanguageDriver.createSqlSource()</code>æ–¹æ³•åˆ›å»ºå¯¹åº”çš„<code>SqlSource</code>å¯¹è±¡ï¼Œæœ€ååˆ›å»º<code>MappedStatement</code>å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°<code>Configuration.mappedStatements</code>é›†åˆä¸­ä¿å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectKeyNode</span><span class="params">(String id, XNode nodeToHandle, </span></span></span><br><span class="line"><span class="function"><span class="params">                                Class&lt;?&gt; parameterTypeClass, </span></span></span><br><span class="line"><span class="function"><span class="params">                                LanguageDriver langDriver, String databaseId)</span> </span>&#123;</span><br><span class="line">  String resultType = nodeToHandle.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  StatementType statementType </span><br><span class="line">    = StatementType.valueOf(</span><br><span class="line">    nodeToHandle.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, </span><br><span class="line">                                    StatementType.PREPARED.toString()));</span><br><span class="line">  String keyProperty = nodeToHandle.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = nodeToHandle.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  <span class="keyword">boolean</span> executeBefore = <span class="string">&quot;BEFORE&quot;</span>.equals(nodeToHandle.getStringAttribute(<span class="string">&quot;order&quot;</span>, <span class="string">&quot;AFTER&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//defaults</span></span><br><span class="line">  <span class="keyword">boolean</span> useCache = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = <span class="keyword">false</span>;</span><br><span class="line">  KeyGenerator keyGenerator = NoKeyGenerator.INSTANCE;</span><br><span class="line">  Integer fetchSize = <span class="keyword">null</span>;</span><br><span class="line">  Integer timeout = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = <span class="keyword">false</span>;</span><br><span class="line">  String parameterMap = <span class="keyword">null</span>;</span><br><span class="line">  String resultMap = <span class="keyword">null</span>;</span><br><span class="line">  ResultSetType resultSetTypeEnum = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  SqlSource sqlSource </span><br><span class="line">    = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);</span><br><span class="line">  SqlCommandType sqlCommandType </span><br><span class="line">    = SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(</span><br><span class="line">    id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">    fetchSize, timeout, parameterMap, parameterTypeClass, </span><br><span class="line">    resultMap, resultTypeClass,</span><br><span class="line">    resultSetTypeEnum, flushCache, useCache, resultOrdered,    </span><br><span class="line">    keyGenerator, keyProperty, keyColumn, databaseId, langDriver, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  id = builderAssistant.applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  MappedStatement keyStatement = configuration.getMappedStatement(id, <span class="keyword">false</span>);</span><br><span class="line">  configuration.addKeyGenerator(id, <span class="keyword">new</span> SelectKeyGenerator(keyStatement, executeBefore));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LanguageDriver</code>æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/07/17001915960996191596099619233.png" alt="image-20200730170018404"></p>
<p>åœ¨<code>Configuration</code>çš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬ç”±æ­¤å¯ä»¥åˆ¤æ–­é»˜è®¤ä½¿ç”¨çš„<code>XMLLanguageDriver</code>å®ç°ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">languageRegistry.setDefaultDriverClass(XMLLanguageDriver.class);</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„<code>LanguageDriver</code>å®ç°ï¼Œå¹¶åœ¨<code>mybatis-config.xml</code>ä¸­é€šè¿‡<code>defaultScriptingLanguage</code>é…ç½®æŒ‡å®šä½¿ç”¨è¯¥è‡ªå®šä¹‰å®ç°ã€‚<br>åœ¨<code>XMLLanguageDriver.createSqlSource()</code>æ–¹æ³•ä¸­ä¼šåˆ›å»º<code>XMLScriptBuilder</code>å¯¹è±¡å¹¶<code>XMLScriptBuilder.parseScriptNode()</code>æ–¹æ³•åˆ›å»º<code>SqlSource</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parseScriptNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  MixedSqlNode rootSqlNode = parseDynamicTags(context);</span><br><span class="line">  SqlSource sqlSource = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    sqlSource = <span class="keyword">new</span> DynamicSqlSource(configuration, rootSqlNode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sqlSource = <span class="keyword">new</span> RawSqlSource(configuration, rootSqlNode, parameterType);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sqlSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>XMLScriptBuilder.parseDynamicTags()</code>æ–¹æ³•ä¸­ï¼Œä¼šéå†<code>&lt;selectKey&gt;</code>ä¸‹çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœåŒ…å«ä»»ä½•æ ‡ç­¾èŠ‚ç‚¹ï¼Œåˆ™è®¤ä¸ºæ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ï¼›å¦‚æœæ–‡æœ¬èŠ‚ç‚¹ä¸­å«æœ‰<code>$&#123;&#125;</code>å ä½ç¬¦ï¼Œä¹Ÿè®¤ä¸ºå…¶ä¸ºåŠ¨æ€SQLè¯­å¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> MixedSqlNode <span class="title">parseDynamicTags</span><span class="params">(XNode node)</span> </span>&#123;</span><br><span class="line">  List&lt;SqlNode&gt; contents = <span class="keyword">new</span> ArrayList&lt;SqlNode&gt;();</span><br><span class="line">  NodeList children = node.getNode().getChildNodes();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">    XNode child = node.newXNode(children.item(i));</span><br><span class="line">    <span class="keyword">if</span> (child.getNode().getNodeType() </span><br><span class="line">        == Node.CDATA_SECTION_NODE || </span><br><span class="line">        child.getNode().getNodeType() == Node.TEXT_NODE) &#123;</span><br><span class="line">      String data = child.getStringBody(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      TextSqlNode textSqlNode = <span class="keyword">new</span> TextSqlNode(data);</span><br><span class="line">      <span class="keyword">if</span> (textSqlNode.isDynamic()) &#123;</span><br><span class="line">        contents.add(textSqlNode);</span><br><span class="line">        isDynamic = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        contents.add(<span class="keyword">new</span> StaticTextSqlNode(data));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; <span class="comment">// issue #628</span></span><br><span class="line">      String nodeName = child.getNode().getNodeName();</span><br><span class="line">      NodeHandler handler = nodeHandlerMap.get(nodeName);</span><br><span class="line">      <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Unknown element &lt;&quot;</span> + nodeName + <span class="string">&quot;&gt; in SQL statement.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      handler.handleNode(child, contents);</span><br><span class="line">      isDynamic = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MixedSqlNode(contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢é‡åˆ°çš„<code>TextSqlNode</code>ã€<code>StaticTextSqlNode</code>ç­‰éƒ½æ˜¯<code>SqlNode</code>æ¥å£çš„å®ç°ï¼Œ<code>SqlNode</code>æ¥å£çš„<br>æ¯ä¸ªå®ç°éƒ½å¯¹åº”äºä¸åŒçš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ç±»å‹ï¼Œæ¯ä¸ªå®ç°çš„å…·ä½“ä»£ç åé¢é‡åˆ°äº†å†è¯¦ç»†åˆ†æã€‚</p>
<p><code>TextSqlNode.isDynamic()</code>æ–¹æ³•ä¸­ä¼šé€šè¿‡<code>GenericTokenParser</code>å’Œ<code>DynamicCheckerTokenParser</code>é…åˆè§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦ä¸ºåŠ¨æ€<code>SQL</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDynamic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DynamicCheckerTokenParser checker = <span class="keyword">new</span> DynamicCheckerTokenParser();</span><br><span class="line">  GenericTokenParser parser = createParser(checker);</span><br><span class="line">  parser.parse(text);</span><br><span class="line">  <span class="keyword">return</span> checker.isDynamic();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.isDynamic = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. è§£æSQLèŠ‚ç‚¹</strong></p>
<p>ç»è¿‡ä¸Šè¿°ä¸¤ä¸ªè§£æè¿‡ç¨‹ä¹‹åï¼Œ<code>&lt;include&gt;</code>èŠ‚ç‚¹å’Œ<code>&lt;selectKey&gt;</code>èŠ‚ç‚¹å·±ç»è¢«è§£æå¹¶åˆ é™¤æ‰äº†ã€‚<code>XMLStatementBuilder.parseStatementNode()</code>æ–¹æ³•å‰©ä½™çš„æ“ä½œå°±æ˜¯è§£æ<code>SQL</code>èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String id = context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  String databaseId = context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="keyword">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Integer fetchSize = context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">  Integer timeout = context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">  String parameterMap = context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">  String parameterType = context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">  String resultMap = context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">  String resultType = context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">  String lang = context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">  LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">  String resultSetType = context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">  StatementType statementType = StatementType.valueOf(context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">  ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">  String nodeName = context.getNode().getNodeName();</span><br><span class="line">  SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">  <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">  <span class="keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">  <span class="keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">  XMLIncludeTransformer includeParser = <span class="keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">  includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">  processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">  SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">  String resultSets = context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line">  String keyProperty = context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">  String keyColumn = context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">  KeyGenerator keyGenerator;</span><br><span class="line">  String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">    keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyGenerator = context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                                               configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">      ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">                                      fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">                                      resultSetTypeEnum, flushCache, useCache, resultOrdered, </span><br><span class="line">                                      keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»‘å®šMapperæ¥å£"><a href="#ç»‘å®šMapperæ¥å£" class="headerlink" title="ç»‘å®šMapperæ¥å£"></a>ç»‘å®šMapperæ¥å£</h2><p>æ¯ä¸ªæ˜ å°„é…ç½®æ–‡ä»¶çš„å‘½åç©ºé—´å¯ä»¥ç»‘å®šä¸€ä¸ª<code>Mapper</code>æ¥å£ï¼Œå¹¶æ³¨å†Œåˆ°<code>MapperRegistry</code>ä¸­ã€‚</p>
<p>åœ¨<code>XMLMapperBuilder.bindMapperForNamespace()</code>æ–¹æ³•ä¸­ï¼Œå®Œæˆäº†æ˜ å°„é…ç½®æ–‡ä»¶ä¸å¯¹åº”<code>Mapper</code>æ¥å£çš„ç»‘å®šã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindMapperForNamespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String namespace = builderAssistant.getCurrentNamespace();</span><br><span class="line">  <span class="keyword">if</span> (namespace != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; boundType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      boundType = Resources.classForName(namespace);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="comment">//ignore, bound type is not required</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (boundType != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!configuration.hasMapper(boundType)) &#123;</span><br><span class="line">        <span class="comment">// Spring may not know the real resource name so we set a flag</span></span><br><span class="line">        <span class="comment">// to prevent loading again this resource from the mapper interface</span></span><br><span class="line">        <span class="comment">// look at MapperAnnotationBuilder#loadXmlResource</span></span><br><span class="line">        configuration.addLoadedResource(<span class="string">&quot;namespace:&quot;</span> + namespace);</span><br><span class="line">        configuration.addMapper(boundType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»‹ç»<code>MapperRegistry.addMapper()</code>æ–¹æ³•æ—¶ï¼Œåªæåˆ°äº†è¯¥æ–¹æ³•ä¼šå‘<code>MapperRegistry.knownMappers</code>é›†åˆæ³¨å†ŒæŒ‡å®šçš„<code>Mapper</code>æ¥å£ï¼Œå…¶å®è¯¥æ–¹æ³•è¿˜ä¼šåˆ›å»º<code>MapperAnnotationBuilder</code>ï¼Œå¹¶è°ƒç”¨<code>MapperAnnotationBuilder.parse()</code>æ–¹æ³•è§£æ<code>Mapper</code>æ¥å£ä¸­çš„æ³¨è§£ä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String resource = type.toString();</span><br><span class="line">  <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    loadXmlResource();</span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    assistant.setCurrentNamespace(type.getName());</span><br><span class="line">    parseCache();</span><br><span class="line">    parseCacheRef();</span><br><span class="line">    Method[] methods = type.getMethods();</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// issue #237</span></span><br><span class="line">        <span class="keyword">if</span> (!method.isBridge()) &#123;</span><br><span class="line">          parseStatement(method);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteMethod(<span class="keyword">new</span> MethodResolver(<span class="keyword">this</span>, method));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  parsePendingMethods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¤„ç†incomplete-é›†åˆ"><a href="#å¤„ç†incomplete-é›†åˆ" class="headerlink" title="å¤„ç†incomplete*é›†åˆ"></a>å¤„ç†incomplete*é›†åˆ</h2><p><code>XMLMapperBuilder.configurationElement()</code>æ–¹æ³•è§£ææ˜ å°„é…ç½®æ–‡ä»¶æ—¶ï¼Œæ˜¯æŒ‰ç…§ä»æ–‡ä»¶å¤´åˆ°æ–‡ä»¶å°¾çš„é¡ºåºè§£æçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åœ¨è§£æä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šå¼•ç”¨å®šä¹‰åœ¨è¯¥èŠ‚ç‚¹ä¹‹åçš„ã€è¿˜æœªè§£æçš„èŠ‚ç‚¹ï¼Œè¿™å°±ä¼šå¯¼è‡´è§£æå¤±è´¥å¹¶æŠ›å‡º<code>IncompleteElementException</code>ã€‚</p>
<p>æ ¹æ®æŠ›å‡ºå¼‚å¸¸çš„èŠ‚ç‚¹ä¸åŒï¼Œ<code>MyBatis</code>ä¼šåˆ›å»ºä¸åŒçš„<code>*Resolver</code>å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°<code>Configuration</code>çš„ä¸åŒ<code>incomplete*</code>é›†åˆä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ</p>
<ul>
<li><p>è§£æ<code>Mapper</code>æ¥å£ä¸­çš„æ–¹æ³•å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šåˆ›å»º<code>MethodResolver</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ°<code>Configuration.incompleteMethods</code>é›†åˆ(<code>LinkedList&lt;MethodResolver&gt;</code>ç±»å‹)ä¸­æš‚å­˜;</p>
</li>
<li><p>è§£æ<code>&lt;resultMap&gt;</code>èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>ResultMapResolver</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteResultMaps</code>(<code>LinkedList&lt;ResultMapResolver&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜;</p>
</li>
<li><p>è§£æ<code>&lt;cache-ref&gt;</code>èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>CacheRefResolver</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteCacheRefs</code>(<code>LinkedList&lt;CacheRefResolver&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜;</p>
</li>
<li><p>è§£æ<code>SQL</code>è¯­å¥èŠ‚ç‚¹æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™ä¼šå°†å¯¹åº”çš„<code>XMLStatementBuilder</code>å¯¹è±¡è¿½åŠ åˆ°<code>incompleteStatements</code>(<code>LinkedList&lt;XMLStatementBuilder&gt;</code>ç±»å‹)é›†åˆä¸­æš‚å­˜ã€‚</p>
</li>
</ul>
<p>åœ¨<code>XMLMapperBuilder.parse()</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡<code>configurationElement()</code>æ–¹æ³•å®Œäº†ä¸€æ¬¡æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æåï¼Œè¿˜ä¼šè°ƒç”¨<code>parsePendingResultMaps()</code>æ–¹æ³•ã€<code>parsePendingChacheRefs()</code>æ–¹æ³•ã€<code>parsePendingStatements()</code>æ–¹æ³•ä¸‰ä¸ª<code>parsePending*()</code>æ–¹æ³•å¤„ç†<code>Configuration</code>ä¸­å¯¹åº”çš„ä¸‰ä¸ª<code>incomplete*</code>é›†åˆã€‚æ‰€æœ‰<code>parsePending*()</code>æ–¹æ³•çš„é€»è¾‘éƒ½æ˜¯åŸºæœ¬ç±»ä¼¼çš„ï¼Œè¿™é‡Œä»¥<code>parsePendingStatements()</code>æ–¹æ³•ä¸ºä¾‹è¿›è¡Œåˆ†æ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePendingStatements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements();</span><br><span class="line">  <span class="keyword">synchronized</span> (incompleteStatements) &#123;</span><br><span class="line">    Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        iter.next().parseStatementNode();</span><br><span class="line">        iter.remove();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        <span class="comment">// Statement is still missing a resource...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<code>MyBatis</code>çš„åˆå§‹åŒ–è¿‡ç¨‹å°±å…¨éƒ¨ä»‹ç»å®Œäº†ï¼Œå…¶ä¸­åˆ†æäº†<code>mybatis-config.xml</code>é…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ã€æ˜ å°„é…ç½®æ–‡ä»¶çš„è§£æè¿‡ç¨‹ä»¥åŠ<code>Mapper</code>æ¥å£ä¸­ç›¸å…³æ³¨è§£çš„è§£æè¿‡ç¨‹ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
<li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">ğŸ³Antä¸¶</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.cayzlh.com/2020/06/22/c499e157.html">https://www.cayzlh.com/2020/06/22/c499e157.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.cayzlh.com">BLOG | CAYZLH</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/MyBatis/">MyBatis</a><a class="post-meta__tags" href="/blog/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><a class="post-meta__tags" href="/blog/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/">æ ¸å¿ƒå¤„ç†å±‚</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2020/08/21/bebe404d.html"><i class="fa fa-chevron-left">  </i><span>æ ¸å¿ƒå¤„ç†å±‚-SqlNode&amp;SqlSource</span></a></div><div class="next-post pull-right"><a href="/blog/2020/03/31/741621cd.html"><span>Springé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆçŸ¥è¯†æ¢³ç†ï¼‰</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="footer_custom_text">hitokoto</div><div class="copyright">ğŸ³Antä¸¶ &copy;2019 - 2021</div><div class="icp"><a><span>ç²¤ICPå¤‡20058712å·</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.9.0"></script><script src="/blog/js/fancybox.js?version=1.9.0"></script><script src="/blog/js/sidebar.js?version=1.9.0"></script><script src="/blog/js/copy.js?version=1.9.0"></script><script src="/blog/js/fireworks.js?version=1.9.0"></script><script src="/blog/js/transition.js?version=1.9.0"></script><script src="/blog/js/scroll.js?version=1.9.0"></script><script src="/blog/js/head.js?version=1.9.0"></script><script src="/blog/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>