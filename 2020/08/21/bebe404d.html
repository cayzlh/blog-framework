<!DOCTYPE html><html lang="[&quot;zh-Hans&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†MyBatisçš„æ ¸å¿ƒåŠŸèƒ½ã€‚"><meta name="keywords" content="MyBatis, MyBatisæŠ€æœ¯å†…å¹•"><meta name="author" content="ğŸ³Antä¸¶"><meta name="copyright" content="ğŸ³Antä¸¶"><title>æ ¸å¿ƒå¤„ç†å±‚-SqlNode&amp;SqlSource | BLOG | CAYZLH</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/logo/favicon.ico"><link rel="stylesheet" href="/blog/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-129095667-1', 'auto');
ga('send', 'pageview');</script><meta name="google-site-verification" content="VrcbMTVpFGlHkIERHBt753dAtXKF4qirjnDweuXSRJw"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blog/atom.xml" title="BLOG | CAYZLH" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F"><span class="toc-text">ç»„åˆæ¨¡å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">OGNLè¡¨è¾¾å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DynamicContext"><span class="toc-text">DynamicContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SqlNode"><span class="toc-text">SqlNode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SqlSourceBuilder"><span class="toc-text">SqlSourceBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DynamicSqlSource"><span class="toc-text">DynamicSqlSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RawSqISource"><span class="toc-text">RawSqISource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/cayzlh/psychic-potato@master/image/IMG_4207.JPG"></div><div class="author-info__name text-center">ğŸ³Antä¸¶</div><div class="author-info__description text-center">CODE IS POETRY</div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://telegram.me/Q2F5emxo">contact me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">98</span></a><!--if site.tags.length--><!--  a(href=url_for(config.tag_dir)).author-info-articles__tags.article-meta--><!--    span.pull-left= _p('sidebar.tags')--><!--    span.pull-right= site.tags.length--><!--if site.categories.length--><!--  a(href=url_for(config.category_dir)).author-info-articles__categories.article-meta--><!--    span.pull-left= _p('sidebar.categories')--><!--    span.pull-right= site.categories.length--><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/"><span class="pull-left">ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹</span><span class="pull-right">â™¾ï¸</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/"><span class="pull-left">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</span><span class="pull-right">â™¾ï¸</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="pull-left">Javaè®¾è®¡æ¨¡å¼</span><span class="pull-right">â™¾ï¸</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">BLOG | CAYZLH</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">æ ¸å¿ƒå¤„ç†å±‚-SqlNode&amp;SqlSource</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-21</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/">ä¹¦ç±</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">4.9k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 19 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>æ ¸å¿ƒå¤„ç†å±‚ä»¥åŸºç¡€æ”¯æŒå±‚ä¸ºåŸºç¡€ï¼Œå®ç°äº†<code>MyBatis</code>çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä»<code>MyBatis</code>çš„åˆå§‹åŒ–ã€åŠ¨æ€<code>SQL</code>è¯­å¥çš„è§£æã€ç»“æœé›†çš„æ˜ å°„ã€å‚æ•°è§£æä»¥åŠ<code>SQL</code>è¯­å¥çš„æ‰§è¡Œç­‰å‡ ä¸ªæ–¹é¢åˆ†æ<code>MyBatis</code>çš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œäº†è§£<code>MyBatis</code>çš„æ ¸å¿ƒåŸç†ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622175512211_aegXOG.png" alt="image-20200622175512211"></p>
<blockquote>
<p>æœ¬ç¯‡ä»‹ç»SqINode&amp;SqISource</p>
</blockquote>
<p>æ˜ å°„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>SQL</code>èŠ‚ç‚¹ä¼šè¢«è§£ææˆ<code>MappedStatement</code>å¯¹è±¡ï¼Œå…¶ä¸­çš„<code>SQL</code>è¯­å¥ä¼šè¢«è§£ææˆ<code>SqlSource</code>å¯¹è±¡ï¼Œ<code>SQL</code>è¯­å¥ä¸­å®šä¹‰çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€æ–‡æœ¬èŠ‚ç‚¹ç­‰ï¼Œåˆ™ç”±<code>SqlNode</code>æ¥å£çš„ç›¸åº”å®ç°è¡¨ç¤ºã€‚</p>
<p><code>SqlSource</code>æ¥å£çš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SqlSource</code>æ¥å£çš„å®ç°ç±»å›¾ï¼š</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17323715982615571598261557744.png" alt="image-20200824173236987"></p>
<ul>
<li><code>DynamicSqlSource</code>è´Ÿè´£å¤„ç†åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œ<code>RawSqlSource</code>è´Ÿè´£å¤„ç†é™æ€è¯­å¥ï¼Œä¸¤è€…æœ€ç»ˆéƒ½ä¼šå°†å¤„ç†åçš„<code>SQL</code>è¯­å¥å°è£…æˆ<code>StaticSqlSource</code>è¿”å›ã€‚</li>
<li><code>DynamicSqlSource</code>ä¸<code>StaticSqlSource</code>çš„ä¸»è¦åŒºåˆ«ï¼š<ul>
<li><code>StaticSqlSource</code>ä¸­è®°å½•çš„<code>SQL</code>è¯­å¥ä¸­å¯èƒ½å«æœ‰<code>?</code>å ä½ç¬¦ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥æäº¤ç»™æ•°æ®åº“æ‰§è¡Œ</li>
<li><code>DynamicSqlSource</code>ä¸­å°è£…çš„<code>SQL</code>è¯­å¥è¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—è§£æï¼Œæ‰ä¼šæœ€ç»ˆå½¢æˆæ•°æ®åº“å¯æ‰§è¡Œçš„<code>SQL</code>è¯­å¥</li>
</ul>
</li>
</ul>
<h2 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h2><p>ç»„åˆæ¨¡å¼æ˜¯å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ï¼Œä»¥è¡¨ç¤º<code>éƒ¨åˆ†-æ•´ä½“</code>çš„å±‚æ¬¡ç»“æ„(ä¸€èˆ¬æ˜¯æ ‘å½¢ç»“æ„)ï¼Œç”¨æˆ·å¯ä»¥åƒå¤„ç†ä¸€ä¸ªç®€å•å¯¹è±¡ä¸€æ ·æ¥å¤„ç†ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œä»è€Œä½¿å¾—è°ƒç”¨è€…æ— é¡»äº†è§£å¤æ‚å…ƒç´ çš„å†…éƒ¨ç»“æ„ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17400415982620041598262004554.png" alt="image-20200824174003381"></p>
<p>ç»„åˆæ¨¡å¼ä¸­çš„å„æ¨¡å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><strong>æŠ½è±¡ç»„ä»¶(<code>Component</code>)</strong></p>
<p><code>Component</code>æ¥å£å®šä¹‰äº†æ ‘å½¢ç»“æ„ä¸­æ‰€æœ‰ç±»çš„å…¬å…±è¡Œä¸ºï¼Œä¾‹å¦‚è¿™é‡Œçš„<code>operation()</code>æ–¹æ³•ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…¶ä¸­è¿˜ä¼šå®šä¹‰ä¸€äº›ç”¨äºç®¡ç†å­ç»„ä»¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¿™é‡Œçš„<code>add()</code>ã€<code>remove()</code>ã€<code>getChild()</code>æ–¹æ³•ã€‚</p>
</li>
<li><p><strong>æ ‘å¶(<code>Leaf</code>)</strong></p>
<p><code>Leaf</code>åœ¨æ ‘å½¢ç»“æ„ä¸­è¡¨ç¤ºå¶èŠ‚ç‚¹å¯¹è±¡ï¼Œå¶èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ã€‚</p>
</li>
<li><p><strong>æ ‘æ(<code>Composite</code>)</strong></p>
<p>å®šä¹‰æœ‰å­ç»„ä»¶çš„é‚£äº›ç»„ä»¶çš„è¡Œä¸ºã€‚è¯¥è§’è‰²ç”¨äºç®¡ç†å­ç»„ä»¶ï¼Œå¹¶é€šè¿‡<code>operation()</code>æ–¹æ³•è°ƒç”¨å…¶ç®¡ç†çš„å­ç»„ä»¶çš„ç›¸å…³æ“ä½œã€‚</p>
</li>
<li><p><strong>è°ƒç”¨è€…(<code>Client</code>)</strong></p>
<p>é€šè¿‡<code>Component</code>æ¥å£æ“çºµæ•´ä¸ªæ ‘å½¢ç»“æ„ã€‚</p>
</li>
</ul>
<p><u>ç»„åˆæ¨¡å¼ä¸»è¦æœ‰ä¸¤ç‚¹å¥½å¤„</u>ï¼Œ<strong>é¦–å…ˆç»„åˆæ¨¡å¼å¯ä»¥å¸®åŠ©è°ƒç”¨è€…å±è”½å¯¹è±¡çš„å¤æ‚æ€§</strong>ã€‚</p>
<p>å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œä½¿ç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸ä½¿ç”¨å•ä¸ª<code>Component</code>å¯¹è±¡æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨è€…å¹¶ä¸å¿…å…³å¿ƒè‡ªå·±å¤„ç†çš„æ˜¯å•ä¸ª<code>Component</code>å¯¹è±¡è¿˜æ˜¯æ•´ä¸ªæ ‘å½¢ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥å°†è°ƒç”¨è€…ä¸å¤æ‚å¯¹è±¡è¿›è¡Œè§£è€¦ã€‚</p>
<p>å¦å¤–ï¼Œ<strong>ä½¿ç”¨äº†ç»„åˆæ¨¡å¼ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ æ ‘ä¸­èŠ‚ç‚¹çš„æ–¹å¼ï¼Œæ·»åŠ æ–°çš„Componentå¯¹è±¡ï¼Œä»è€Œå®ç°åŠŸèƒ½ä¸Šçš„æ‰©å±•ï¼Œè¿™ç¬¦åˆ<code>å¼€æ”¾-å°é—­</code>åŸåˆ™ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–æ—¥åçš„ç»´æŠ¤å·¥ä½œã€‚</strong></p>
<p><u>ç»„åˆæ¨¡å¼åœ¨å¸¦æ¥ä¸Šè¿°å¥½å¤„çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¼•å…¥ä¸€äº›é—®é¢˜</u>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæœ‰äº›åœºæ™¯ä¸‹ç¨‹åºå¸Œæœ›ä¸€ä¸ªç»„åˆç»“æ„ä¸­åªèƒ½æœ‰æŸäº›ç‰¹å®šçš„ç»„ä»¶ï¼Œæ­¤æ—¶å°±å¾ˆéš¾ç›´æ¥é€šè¿‡ç»„ä»¶ç±»å‹è¿›è¡Œé™åˆ¶(å› ä¸ºéƒ½æ˜¯<code>Component</code>æ¥å£çš„å®ç°ç±»)ï¼Œè¿™å°±å¿…é¡»åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æµ‹ã€‚è€Œä¸”ï¼Œåœ¨é€’å½’ç¨‹åºä¸­å®šä½é—®é¢˜ä¹Ÿæ˜¯ä¸€ä»¶æ¯”è¾ƒå¤æ‚çš„äº‹æƒ…ã€‚</p>
<p><code>MyBatis</code>åœ¨å¤„ç†åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æ—¶ï¼Œåº”ç”¨åˆ°äº†ç»„åˆè®¾è®¡æ¨¡å¼ã€‚<code>MyBatis</code>ä¼šå°†åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹è§£ææˆå¯¹åº”çš„<code>SqlNode</code>å®ç°ï¼Œå¹¶å½¢æˆæ ‘å½¢ç»“æ„ã€‚</p>
<h2 id="OGNLè¡¨è¾¾å¼"><a href="#OGNLè¡¨è¾¾å¼" class="headerlink" title="OGNLè¡¨è¾¾å¼"></a>OGNLè¡¨è¾¾å¼</h2><p><code>OGNL</code>(<strong>Object Graphic Navigation Languageï¼Œå¯¹è±¡å›¾å¯¼èˆªè¯­è¨€</strong>)è¡¨è¾¾å¼åœ¨<code>Struts</code>ã€<code>MyBatis</code>ç­‰å¼€æºé¡¹ç›®ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå…¶ä¸­<code>Struts</code>æ¡†æ¶æ›´æ˜¯å°†<code>OGNL</code>ä½œä¸ºé»˜è®¤çš„è¡¨è¾¾å¼è¯­è¨€ã€‚</p>
<p>åœ¨<code>MyBatis</code>ä¸­æ¶‰åŠçš„<code>OGNL</code>è¡¨è¾¾å¼çš„åŠŸèƒ½ä¸»è¦æ˜¯ï¼š<strong>å­˜å–<code>Java</code>å¯¹è±¡æ ‘ä¸­çš„å±æ€§</strong>ã€<strong>è°ƒç”¨<code>Java</code>å¯¹è±¡æ ‘ä¸­çš„æ–¹æ³•ç­‰</strong>ã€‚</p>
<p><strong>OGNLä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼š</strong></p>
<ul>
<li><p><strong>è¡¨è¾¾å¼</strong></p>
<p><code>OGNL</code>è¡¨è¾¾å¼æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ ¹æ®è¡¨è¾¾å¼è§£æå¾—åˆ°çš„ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<p><code>å¯¹è±¡å.æ–¹æ³•å</code>è¡¨ç¤ºè°ƒç”¨æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•</p>
<p><code>@[ç±»çš„å®Œå…¨é™å®šå]@[é™æ€æ–¹æ³•æˆ–é™æ€å­—æ®µ]</code>è¡¨ç¤ºè°ƒç”¨æŒ‡å®šç±»çš„é™æ€æ–¹æ³•æˆ–è®¿é—®é™æ€å­—æ®µ</p>
<p><code>OGNL</code>è¡¨è¾¾å¼è¿˜å¯ä»¥å®Œæˆ<u>å˜é‡èµ‹å€¼</u>ã€<u>æ“ä½œé›†åˆ</u>ç­‰æ“ä½œã€‚</p>
</li>
<li><p><strong>rootå¯¹è±¡</strong></p>
<p><code>OGNL</code>è¡¨è¾¾å¼æŒ‡å®šäº†å…·ä½“çš„æ“ä½œï¼Œè€Œ<code>root</code>å¯¹è±¡æŒ‡å®šäº†éœ€è¦æ“ä½œçš„å¯¹è±¡ã€‚</p>
</li>
<li><p><strong>OgnlContextï¼ˆä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</strong></p>
<p><code>OgnlContext</code>ç±»ç»§æ‰¿äº†<code>Map</code>æ¥å£ï¼Œ<code>OgnlContext</code>å¯¹è±¡è¯´ç™½äº†ä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>Map</code>å¯¹è±¡ã€‚</p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œ<code>OgnIContext</code>å¯¹è±¡ä¸­å°±å¯ä»¥å­˜æ”¾é™¤<code>root</code>å¯¹è±¡ä¹‹å¤–çš„å…¶ä»–å¯¹è±¡ã€‚</p>
<p>åœ¨ä½¿ç”¨<code>OGNL</code>è¡¨è¾¾å¼æ“ä½œé<code>root</code>å¯¹è±¡æ—¶ï¼Œéœ€è¦ä½¿ç”¨<code>#</code>å‰ç¼€ï¼Œè€Œæ“ä½œ<code>root</code>å¯¹è±¡åˆ™ä¸éœ€è¦ä½¿ç”¨<code>#</code>å‰ç¼€ã€‚</p>
</li>
</ul>
<p>åœ¨<code>MyBatis</code>ä¸­ï¼Œä½¿ç”¨<code>OgnlCache</code>å¯¹åŸç”Ÿçš„<code>OGNL</code>è¿›è¡Œäº†å°è£…ã€‚<code>OGNL</code>è¡¨è¾¾å¼çš„è§£æè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œ<code>OgnlCache</code>ä¸­ä½¿ç”¨<code>expressionCache</code>å­—æ®µ(é™æ€æˆå‘˜ï¼Œ<code>ConcurrentHashMap&lt;String,Object&gt;</code>ç±»å‹)å¯¹è§£æåçš„<code>OGNL</code>è¡¨è¾¾å¼è¿›è¡Œç¼“å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; expressionCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(String expression, Object root)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Map&lt;Object, OgnlClassResolver&gt; context = Ognl.createDefaultContext(root, <span class="keyword">new</span> OgnlClassResolver());</span><br><span class="line">    <span class="keyword">return</span> Ognl.getValue(parseExpression(expression), context, root);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (OgnlException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error evaluating expression &#x27;&quot;</span> + expression + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">parseExpression</span><span class="params">(String expression)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">  Object node = expressionCache.get(expression);</span><br><span class="line">  <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">    node = Ognl.parseExpression(expression);</span><br><span class="line">    expressionCache.put(expression, node);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DynamicContext"><a href="#DynamicContext" class="headerlink" title="DynamicContext"></a>DynamicContext</h2><p><code>DynamicContext</code>ä¸»è¦ç”¨äºè®°å½•è§£æåŠ¨æ€<code>SQL</code>è¯­å¥ä¹‹åäº§ç”Ÿçš„<code>SQL</code>è¯­å¥ç‰‡æ®µï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç”¨äºè®°å½•åŠ¨æ€<code>SQL</code>è¯­å¥è§£æç»“æœçš„å®¹å™¨ã€‚</p>
<p>å…¶ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ContextMap bindings;</span><br><span class="line"><span class="comment">// åœ¨SqlNodeè§£æåŠ¨æ€sqlçš„æ—¶å€™ï¼Œä¼šå°†è§£æåçš„sqlè¯­å¥ç‰‡æ®µæ·»åŠ åˆ°è¯¥å±æ€§ä¸­ä¿å­˜ï¼Œæœ€ç»ˆæ‹¼å‡‘å‡ºä¸€æ¡å®Œæ•´çš„sqlè¯­å¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringBuilder sqlBuilder = <span class="keyword">new</span> StringBuilder();</span><br></pre></td></tr></table></figure>

<p><code>ContextMap</code>æ˜¯<code>DynamicContext</code>ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†<code>HashMap</code>å¹¶é‡å†™äº†<code>get()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextMap</span> <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2977601501966151582L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†ç”¨æˆ·ä¼ çš„å‚æ•°å°è£…æˆMetaObjectå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> MetaObject parameterMetaObject;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ContextMap</span><span class="params">(MetaObject parameterMetaObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.parameterMetaObject = parameterMetaObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    String strKey = (String) key;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.containsKey(strKey)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.get(strKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parameterMetaObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// issue #61 do not modify the context when reading</span></span><br><span class="line">      <span class="keyword">return</span> parameterMetaObject.getValue(strKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DynamicContext</code>çš„æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–<code>bindings</code>é›†åˆï¼Œæ³¨æ„æ„é€ æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°<code>pammeterObject</code>ï¼Œå®ƒæ˜¯è¿è¡Œæ—¶ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ï¼Œå…¶ä¸­åŒ…å«äº†åç»­ç”¨äºæ›¿æ¢<code>#&#123;&#125;</code>å ä½ç¬¦çš„å®å‚ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicContext</span><span class="params">(Configuration configuration, Object parameterObject)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parameterObject != <span class="keyword">null</span> &amp;&amp; !(parameterObject <span class="keyword">instanceof</span> Map)) &#123;</span><br><span class="line">    <span class="comment">// å¯¹äºä¸æ˜¯Mapç±»å‹çš„å‚æ•°ï¼Œä¼šåˆ›è£…MetaObjectå¯¹è±¡ï¼Œå¹¶å°è£…æˆContextMapå¯¹è±¡</span></span><br><span class="line">    MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">    bindings = <span class="keyword">new</span> ContextMap(metaObject);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    bindings = <span class="keyword">new</span> ContextMap(<span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  bindings.put(PARAMETER_OBJECT_KEY, parameterObject);</span><br><span class="line">  bindings.put(DATABASE_ID_KEY, configuration.getDatabaseId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SqlNode"><a href="#SqlNode" class="headerlink" title="SqlNode"></a>SqlNode</h2><p>æ¥ä¸‹æ¥çœ‹çœ‹SqlNodeçš„å®ç°ç±»æ˜¯å¦‚ä½•è§£æå…¶å¯¹åº”çš„SQLèŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlNode</span> </span>&#123;</span><br><span class="line">  <span class="comment">// apply()æ˜¯SqlNodeæ¥å£ä¸­å®šä¹‰çš„å”¯ä¸€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å®å‚ï¼Œå‚æ•°è§£æè¯¥SqlNodeæ‰€</span></span><br><span class="line">  <span class="comment">// è®°å½•çš„åŠ¨æ€SQLèŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨DynamicContext.appendSql()æ–¹æ³•å°†è§£æåçš„SQLç‰‡æ®µè¿½åŠ åˆ°</span></span><br><span class="line">  <span class="comment">// DynamicContext.sqlBuilderä¸­ä¿å­˜</span></span><br><span class="line">  <span class="comment">// å½“SQLèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰SqlNodeå®Œæˆè§£æåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»DynamicContextä¸­è·å–ä¸€æ¡åŠ¨æ€ç”Ÿæˆçš„ã€</span></span><br><span class="line">  <span class="comment">// å®Œæ•´çš„SQLè¯­å¥</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SqlNode</code>æ¥å£æœ‰å¤šä¸ªå®ç°ç±»ï¼Œæ¯ä¸ªå®ç°ç±»å¯¹åº”ä¸€ä¸ªåŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€‚æŒ‰ç…§ç»„åˆæ¨¡å¼çš„è§’è‰²æ¥åˆ’åˆ†ï¼Œ<code>SqlNode</code>æ‰®æ¼”äº†æŠ½è±¡ç»„ä»¶çš„è§’è‰²ï¼Œ<code>MixedSqlNode</code>æ‰®æ¼”äº†æ ‘æèŠ‚ç‚¹çš„è§’è‰²ï¼Œ<code>TextSqlNode</code>èŠ‚ç‚¹æ‰®æ¼”äº†æ ‘å¶èŠ‚ç‚¹çš„è§’è‰²ç­‰ç­‰ã€‚</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/16395615983447961598344796478.png" alt="image-20200825163955175"></p>
<p><strong>1ã€StaticTextSqINode&amp;MixedSqINode</strong></p>
<p><code>StaticTextSqINode</code>ä¸­ä½¿ç”¨<code>text</code>å­—æ®µ(<code>String</code>ç±»å‹)è®°å½•äº†å¯¹åº”çš„éåŠ¨æ€<code>SQL</code>è¯­å¥èŠ‚ç‚¹ï¼Œå…¶<code>apply()</code>æ–¹æ³•ç›´æ¥å°†<code>text</code>å­—æ®µè¿½åŠ åˆ°<code>DynamicContext.sqlBuilder</code>å­—æ®µä¸­ã€‚</p>
<p><code>MixedSqINode</code>ä¸­ä½¿ç”¨<code>contents</code>å­—æ®µ(<code>List&lt;SqlNode&gt;</code>ç±»å‹)è®°å½•å…¶å­èŠ‚ç‚¹å¯¹åº”çš„<code>SqlNode</code>å¯¹è±¡é›†åˆï¼Œå…¶<code>apply()</code>æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨<code>contents</code>é›†åˆä¸­æ‰€æœ‰<code>SqlNode</code>å¯¹è±¡çš„<code>apply()</code>æ–¹æ³•ã€‚</p>
<p><strong>2ã€TextSqlNode</strong></p>
<p><u><code>TextSqlNode</code>è¡¨ç¤ºçš„æ˜¯åŒ…å«å ä½ç¬¦çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹ã€‚</u><code>TextSqlNode.apply()</code>æ–¹æ³•ä¼šä½¿ç”¨<code>GenericTokenParser</code>è§£æ<code>$&#123;&#125;</code>å ä½ç¬¦ï¼Œå¹¶ç›´æ¥æ›¿æ¢æˆç”¨æˆ·ç»™å®šçš„å®é™…å‚æ•°å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºGenericTokenParserè§£æå™¨ï¼Œ</span></span><br><span class="line">  GenericTokenParser parser = createParser(<span class="keyword">new</span> BindingTokenParser(context, injectionFilter));</span><br><span class="line">  <span class="comment">// å°†è§£æåçš„SQLç‰‡æ®µæ·»åŠ åˆ°DynamicContextä¸­</span></span><br><span class="line">  context.appendSql(parser.parse(text));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> GenericTokenParser <span class="title">createParser</span><span class="params">(TokenHandler handler)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;$&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**<code>BindingTokenParser</code>**æ˜¯<code>TextSqlNode</code>ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿äº†<code>TokenHandler</code>æ¥å£ï¼Œ<u>å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®<code>DynamicContext.bindings</code>é›†åˆä¸­çš„ä¿¡æ¯è§£æ<code>SQL</code>è¯­å¥èŠ‚ç‚¹ä¸­çš„<code>$&#123;&#125;</code>å ä½ç¬¦</u>ã€‚<code>BindingTokenParser.context</code>å­—æ®µæŒ‡å‘äº†å¯¹åº”çš„<code>DynamicContext</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingTokenParser</span> <span class="keyword">implements</span> <span class="title">TokenHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> DynamicContext context;</span><br><span class="line">  <span class="keyword">private</span> Pattern injectionFilter;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BindingTokenParser</span><span class="params">(DynamicContext context, Pattern injectionFilter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">    <span class="keyword">this</span>.injectionFilter = injectionFilter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">    Object parameter = context.getBindings().get(<span class="string">&quot;_parameter&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">      context.getBindings().put(<span class="string">&quot;value&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SimpleTypeRegistry.isSimpleType(parameter.getClass())) &#123;</span><br><span class="line">      context.getBindings().put(<span class="string">&quot;value&quot;</span>, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    Object value = OgnlCache.getValue(content, context.getBindings());</span><br><span class="line">    String srtValue = (value == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : String.valueOf(value)); <span class="comment">// issue #274 return &quot;&quot; instead of &quot;null&quot;</span></span><br><span class="line">    checkInjection(srtValue);</span><br><span class="line">    <span class="keyword">return</span> srtValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkInjection</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (injectionFilter != <span class="keyword">null</span> &amp;&amp; !injectionFilter.matcher(value).matches()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ScriptingException(<span class="string">&quot;Invalid input. Please conform to regex&quot;</span> + injectionFilter.pattern());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3ã€IfSqlNode</strong></p>
<p><code>IfSqlNode</code>å¯¹åº”çš„åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æ˜¯<code>&lt;if&gt;</code>èŠ‚ç‚¹ï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªæ ¸å¿ƒå­—æ®µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºè§£æifèŠ‚ç‚¹çš„testè¡¨è¾¾å¼çš„å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExpressionEvaluator evaluator;</span><br><span class="line"><span class="comment">// è®°å½•äº†testè¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String test;</span><br><span class="line"><span class="comment">// è®°å½•å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br></pre></td></tr></table></figure>

<p><code>IfSqlNode.apply()</code>æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡<code>ExpressionEvaluator.evaluateBoolean()</code>æ–¹æ³•æ£€æµ‹å…¶<code>test</code>è¡¨è¾¾<br>å¼æ˜¯å¦ä¸º<code>true</code>ï¼Œç„¶åæ ¹æ®<code>test</code>è¡¨è¾¾å¼çš„ç»“æœï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œå…¶å­èŠ‚ç‚¹çš„<code>apply()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">    contents.apply(context);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluateBoolean</span><span class="params">(String expression, Object parameterObject)</span> </span>&#123;</span><br><span class="line">  Object value = OgnlCache.getValue(expression, parameterObject);</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Boolean) value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(String.valueOf(value)).compareTo(BigDecimal.ZERO) != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4ã€TrimSqINode&amp;WhereSqINode&amp;SetSqINode</strong></p>
<p><code>TrimSqlNode</code>ä¼šæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœï¼Œæ·»åŠ æˆ–åˆ é™¤ç›¸åº”çš„å‰ç¼€æˆ–åç¼€ã€‚å…¶ä¸­å‡ ä¸ªå­—æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br><span class="line"><span class="comment">// SQLè¯­å¥æ·»åŠ çš„å‰ç¼€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line"><span class="comment">// SQLè¯­å¥æ·»åŠ çš„åç¼€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String suffix;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; prefixesToOverride;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; suffixesToOverride;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>TrimSqlNode</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨<code>parseOverrides()</code>æ–¹æ³•å¯¹å‚æ•°<code>prefixesToOverride</code>(å¯¹åº”<code>&lt;trim&gt;</code>èŠ‚ç‚¹çš„<code>prefixOverrides</code>å±æ€§)å’Œå‚æ•°<code>suffixesToOverride</code>(å¯¹åº”<code>&lt;trim&gt;</code>èŠ‚ç‚¹çš„<code>suffixOverrides</code>å±æ€§)è¿›è¡Œè§£æï¼Œå¹¶åˆå§‹åŒ–<code>prefixesToOverride</code>å’Œ<code>sufflxesToOverride</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">parseOverrides</span><span class="params">(String overrides)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (overrides != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> StringTokenizer parser = <span class="keyword">new</span> StringTokenizer(overrides, <span class="string">&quot;|&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;(parser.countTokens());</span><br><span class="line">    <span class="keyword">while</span> (parser.hasMoreTokens()) &#123;</span><br><span class="line">      list.add(parser.nextToken().toUpperCase(Locale.ENGLISH));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TrimSqlNode.apply()</code>æ–¹æ³•é¦–å…ˆè§£æå­èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®å­èŠ‚ç‚¹çš„è§£æç»“æœå¤„ç†å‰ç¼€å’Œåç¼€ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(DynamicContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºFilteredDynamicContextå¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†DynamicContext</span></span><br><span class="line">  FilteredDynamicContext filteredDynamicContext = <span class="keyword">new</span> FilteredDynamicContext(context);</span><br><span class="line">  <span class="comment">// è°ƒç”¨å­èŠ‚ç‚¹çš„applyæ–¹æ³•è¿›è¡Œè§£æ</span></span><br><span class="line">  <span class="keyword">boolean</span> result = contents.apply(filteredDynamicContext);</span><br><span class="line">  <span class="comment">// å¤„ç†å‰ç¼€å’Œåç¼€</span></span><br><span class="line">  filteredDynamicContext.applyAll();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤„ç†å‰ç¼€å’Œåç¼€çš„ä¸»è¦é€»è¾‘æ˜¯åœ¨<code>FilteredDynamicContext</code>ä¸­å®ç°çš„ï¼Œå®ƒç»§æ‰¿äº†<code>DynamicContext</code>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯<code>DynamicContext</code>çš„ä»£ç†ç±»ã€‚</p>
<p><code>FilteredDynamicContext</code>é™¤äº†å°†å¯¹åº”æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™å…¶ä¸­å°è£…çš„<code>DynamicContext</code>å¯¹è±¡ï¼Œè¿˜æä¾›äº†å¤„ç†å‰ç¼€å’Œåç¼€çš„<code>applyAll()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteredDynamicContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åº•å±‚å°è£…çš„DynamicContextå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> DynamicContext delegate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€å’Œåç¼€</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> prefixApplied;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> suffixApplied;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">private</span> StringBuilder sqlBuffer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å­èŠ‚ç‚¹è§£æè¿‡åçš„ç»“æœï¼Œå¹¶å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™</span></span><br><span class="line">    sqlBuffer = <span class="keyword">new</span> StringBuilder(sqlBuffer.toString().trim());</span><br><span class="line">    String trimmedUppercaseSql = sqlBuffer.toString().toUpperCase(Locale.ENGLISH);</span><br><span class="line">    <span class="keyword">if</span> (trimmedUppercaseSql.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      applyPrefix(sqlBuffer, trimmedUppercaseSql);<span class="comment">// å¤„ç†å‰ç¼€</span></span><br><span class="line">      applySuffix(sqlBuffer, trimmedUppercaseSql);<span class="comment">// å¤„ç†åç¼€</span></span><br><span class="line">    &#125;</span><br><span class="line">    delegate.appendSql(sqlBuffer.toString());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å‰ç¼€</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyPrefix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!prefixApplied) &#123;</span><br><span class="line">      prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (prefixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String toRemove : prefixesToOverride) &#123;</span><br><span class="line">          <span class="keyword">if</span> (trimmedUppercaseSql.startsWith(toRemove)) &#123;</span><br><span class="line">            sql.delete(<span class="number">0</span>, toRemove.trim().length());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (prefix != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sql.insert(<span class="number">0</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">        sql.insert(<span class="number">0</span>, prefix);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†åç¼€</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySuffix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!suffixApplied) &#123;</span><br><span class="line">      suffixApplied = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (suffixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String toRemove : suffixesToOverride) &#123;</span><br><span class="line">          <span class="keyword">if</span> (trimmedUppercaseSql.endsWith(toRemove) || </span><br><span class="line">              trimmedUppercaseSql.endsWith(toRemove.trim())) &#123;</span><br><span class="line">            <span class="keyword">int</span> start = sql.length() - toRemove.trim().length();</span><br><span class="line">            <span class="keyword">int</span> end = sql.length();</span><br><span class="line">            sql.delete(start, end);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (suffix != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sql.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        sql.append(suffix);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><u><code>WhereSqlNode</code>å’Œ<code>SetSqlNode</code>éƒ½ç»§æ‰¿äº†<code>TrimSqlNode</code></u>ã€‚</p>
<p>å…¶ä¸­<code>WhereSqlNode</code>æŒ‡å®šäº†<code>prefix</code>å­—æ®µä¸º<code>WHERE</code>ï¼Œ<code>prefixesToOverride</code>é›†åˆä¸­çš„é¡¹ä¸º<code>AND</code>å’Œ<code>OR</code>ï¼Œ<code>suffix</code>å­—æ®µå’Œ<code>suffixesToOverride</code>é›†åˆä¸º<code>null</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>&lt;where&gt;</code>èŠ‚ç‚¹è§£æåçš„<code>SQL</code>è¯­å¥ç‰‡æ®µå¦‚æœä»¥<code>AND</code>æˆ–<code>OR</code>å¼€å¤´ï¼Œåˆ™å°†å¼€å¤´å¤„çš„<code>AND</code>æˆ–<code>OR</code>åˆ é™¤ï¼Œä¹‹åå†å°†<code>WHERE</code>å…³é”®å­—æ·»åŠ åˆ°<code>SQL</code>ç‰‡æ®µå¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥<code>&lt;where&gt;</code>èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„<code>SQL</code>ç‰‡æ®µã€‚</p>
<p><code>SetSqlNode</code>æŒ‡å®šäº†<code>prefix</code>å­—æ®µä¸º<code>SET</code>ï¼Œ<code>suffixesToOverride</code>é›†åˆä¸­çš„é¡¹åªæœ‰<code>suffix</code>å­—æ®µå’Œ<code>prefixesToOverride</code>é›†åˆä¸º<code>null</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>&lt;set&gt;</code>èŠ‚ç‚¹è§£æåçš„<code>SQL</code>è¯­å¥ç‰‡æ®µå¦‚æœä»¥<code>,</code>ç»“å°¾ï¼Œåˆ™å°†ç»“å°¾å¤„çš„åˆ é™¤æ‰ï¼Œä¹‹åå†å°†<code>SET</code>å…³é”®å­—æ·»åŠ åˆ°<code>SQL</code>ç‰‡æ®µçš„å¼€å§‹ä½ç½®ï¼Œä»è€Œå¾—åˆ°è¯¥<code>&lt;set&gt;</code>èŠ‚ç‚¹æœ€ç»ˆç”Ÿæˆçš„<code>SQL</code>ç‰‡æ®µã€‚</p>
<p><strong>5ã€ForeachSqINode</strong></p>
<p>åœ¨åŠ¨æ€<code>SQL</code>è¯­å¥ä¸­æ„å»º<code>IN</code>æ¡ä»¶è¯­å¥çš„æ—¶å€™ï¼Œé€šå¸¸éœ€è¦å¯¹ä¸€ä¸ªé›†åˆè¿›è¡Œè¿­ä»£ï¼Œ<code>MyBatis</code>æä¾›äº†<code>&lt;foreach&gt;</code>æ ‡ç­¾å®ç°è¯¥åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨<code>&lt;foreach&gt;</code>æ ‡ç­¾è¿­ä»£é›†åˆæ—¶ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨é›†åˆçš„å…ƒç´ å’Œç´¢å¼•å€¼ï¼Œè¿˜å¯ä»¥åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰æˆ–ç»“æŸä¹‹åæ·»åŠ æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå…è®¸åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ·»åŠ æŒ‡å®šçš„åˆ†éš”ç¬¦ã€‚</p>
<p>è§£æ<code>&lt;foreach&gt;</code>èŠ‚ç‚¹å¯¹åº”çš„<code>sqlnode</code>å®ç°ç±»æ˜¯<code>ForeachSqlNode</code>ï¼Œä»¥ä¸‹æ˜¯å…¶ä¸­å®šä¹‰çš„å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºåˆ¤æ–­å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ï¼ŒForeachSqlNodeæ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºè¯¥å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExpressionEvaluator evaluator;</span><br><span class="line"><span class="comment">// è¿­ä»£çš„é›†åˆè¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String collectionExpression;</span><br><span class="line"><span class="comment">// å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlNode contents;</span><br><span class="line"><span class="comment">// å¾ªç¯å¼€å§‹å‰è¦æ·»åŠ çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String open;</span><br><span class="line"><span class="comment">// å¾ªç¯ç»“æŸæ—¶è¦æ·»åŠ çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String close;</span><br><span class="line"><span class="comment">// åˆ†éš”ç¬¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String separator;</span><br><span class="line"><span class="comment">// æœ¬æ¬¡è¿­ä»£çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String item;</span><br><span class="line"><span class="comment">// å½“å‰è¿­ä»£çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String index;</span><br><span class="line"><span class="comment">// é…ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br></pre></td></tr></table></figure>

<p><code>ForeachSqINode</code>ä¸­æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«æ˜¯<code>PrefixedContext</code>å’Œ<code>FilteredDynamicContext</code>ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†<code>DynamicContext</code>ï¼ŒåŒæ—¶ä¹Ÿéƒ½æ˜¯<code>DynamicContext</code>çš„ä»£ç†ç±»ã€‚</p>
<p><strong><code>PreFixedContext</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PrefixedContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DynamicContext delegate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»å¤„ç†è¿‡å‰ç¼€</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> prefixApplied;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendSql</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!prefixApplied &amp;&amp; sql != <span class="keyword">null</span> &amp;&amp; sql.trim().length() &gt; <span class="number">0</span>) &#123; <span class="comment">// æ˜¯å¦éœ€è¦è¿½åŠ å‰ç¼€</span></span><br><span class="line">      delegate.appendSql(prefix); <span class="comment">// è¿½åŠ å‰ç¼€</span></span><br><span class="line">      prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    delegate.appendSql(sql); <span class="comment">// è¿½åŠ sql</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>FilteredDynamicContext</code></strong></p>
<p><code>FilteredDynamicContext</code>è´Ÿè´£å¤„ç†<code>#&#123;&#125;</code>å ä½ç¬¦ï¼Œä½†å®ƒå¹¶æœªå®Œå…¨è§£æ<code>#&#123;&#125;</code>å ä½ç¬¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteredDynamicContext</span> <span class="keyword">extends</span> <span class="title">DynamicContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">// DynamicContextå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DynamicContext delegate;</span><br><span class="line">  <span class="comment">// ç´¢å¼•ä½ç½®</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">  <span class="comment">// å¯¹åº”é›†åˆé¡¹çš„index</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String itemIndex;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String item;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendSql</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">    GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;#&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, <span class="keyword">new</span> TokenHandler() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        String newContent = </span><br><span class="line">          content.replaceFirst(<span class="string">&quot;^\\s*&quot;</span> + item + <span class="string">&quot;(?![^.,:\\s])&quot;</span>, itemizeItem(item, index));</span><br><span class="line">        <span class="keyword">if</span> (itemIndex != <span class="keyword">null</span> &amp;&amp; newContent.equals(content)) &#123;</span><br><span class="line">          newContent = </span><br><span class="line">            content.replaceFirst(<span class="string">&quot;^\\s*&quot;</span> + itemIndex + <span class="string">&quot;(?![^.,:\\s])&quot;</span>, </span><br><span class="line">                                 itemizeItem(itemIndex, index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(<span class="string">&quot;#&#123;&quot;</span>).append(newContent).append(<span class="string">&quot;&#125;&quot;</span>).toString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    delegate.appendSql(parser.parse(sql));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUniqueNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> delegate.getUniqueNumber();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6ã€ChooseSqlNode</strong></p>
<p>å¦‚æœåœ¨ç¼–å†™åŠ¨æ€<code>SQL</code>è¯­å¥æ—¶éœ€è¦ç±»ä¼¼<code>Java</code>ä¸­çš„<code>switch</code>è¯­å¥çš„åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<code>&lt;choose&gt;</code>ã€<code>&lt;when&gt;</code>å’Œ<code>&lt;otherwise&gt;</code>ä¸‰ä¸ªæ ‡ç­¾çš„ç»„åˆã€‚<code>MyBatis</code>ä¼šå°†<code>&lt;choose&gt;</code>æ ‡ç­¾è§£ææˆ<code>ChooseSqlNode</code>ï¼Œå°†<code>&lt;when&gt;</code>æ ‡ç­¾è§£ææˆ<code>IfSqlNode</code>ï¼Œå°†<code>&lt;otherwise&gt;</code>æ ‡ç­¾è§£ææˆ<code>MixedSqlNode</code>ã€‚</p>
<p><code>ChooseSqlNode.apply()</code>æ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆéå†<code>ifSqlNodes</code>é›†åˆå¹¶è°ƒç”¨å…¶ä¸­<code>SqlNode</code><br>å¯¹è±¡çš„<code>apply()</code>æ–¹æ³•ï¼Œç„¶åæ ¹æ®å‰é¢çš„å¤„ç†ç»“æœå†³å®šæ˜¯å¦è°ƒç”¨<code>defaultSqlNode</code>çš„<code>apply()</code>æ–¹æ³•ã€‚</p>
<p><strong>7ã€VarDecISqINode</strong></p>
<p><code>VarDeclSqlNode</code>è¡¨ç¤ºçš„æ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ä¸­çš„<code>&lt;bind&gt;</code>èŠ‚ç‚¹,è¯¥èŠ‚ç‚¹å¯ä»¥ä»<code>OGNL</code>è¡¨è¾¾å¼ä¸­åˆ›å»ºä¸€ä¸ªå˜é‡å¹¶å°†å…¶è®°å½•åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<p>åœ¨<code>VarDecISqINode</code>ä¸­é€šè¿‡<code>name</code>å­—æ®µè®°å½•<code>&lt;bind&gt;</code>èŠ‚ç‚¹çš„<code>name</code>å±æ€§å€¼ï¼Œ<code>expression</code>å­—æ®µè®°å½•<code>&lt;bind&gt;</code>èŠ‚ç‚¹çš„<code>value</code>å±æ€§å€¼ã€‚</p>
<h2 id="SqlSourceBuilder"><a href="#SqlSourceBuilder" class="headerlink" title="SqlSourceBuilder"></a>SqlSourceBuilder</h2><p>åœ¨ç»è¿‡<code>SqlNode.apply()</code>æ–¹æ³•çš„è§£æä¹‹åï¼Œ<code>SQL</code>è¯­å¥ä¼šè¢«ä¼ é€’åˆ°<code>SqlSourceBuilder</code>ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„è§£æã€‚</p>
<p><code>SqISourceBuilder</code>ä¸»è¦å®Œæˆäº†ä¸¤æ–¹é¢çš„æ“ä½œï¼Œä¸€æ–¹é¢æ˜¯è§£æ<code>SQL</code>è¯­å¥ä¸­çš„<code>#&#123;&#125;</code><br>å ä½ç¬¦ä¸­å®šä¹‰çš„å±æ€§ï¼Œæ ¼å¼ç±»ä¼¼äº<code>#&#123;__frc_item_0,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;</code>ï¼Œå¦ä¸€æ–¹é¢æ˜¯å°†<code>SQL</code>è¯­å¥ä¸­çš„<code>#&#123;&#125;</code>å ä½ç¬¦æ›¿æ¢æˆ<code>?</code>å ä½ç¬¦ã€‚</p>
<p><code>SqlSourceBuilder</code>ä¹Ÿæ˜¯<code>BaseBuilder</code>çš„å­ç±»ä¹‹ä¸€ï¼Œå…¶æ ¸å¿ƒé€»è¾‘ä½äº<code>parse()</code>æ–¹æ³•ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parse</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†ä¹‹åçš„sqlè¯­å¥</span></span><br><span class="line">  <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨æˆ·ä¼ å…¥çš„å®å‚ç±»å‹</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸‰ä¸ªå‚æ•°è®°å½•äº†å½¢å‚ä¸å®å‚çš„å¯¹åº”å…³ç³»ï¼Œå…¶å®å°±æ˜¯ç»è¿‡SqlNode.apply()æ–¹æ³•å¤„ç†åçš„DynamicContext.bindingsé›†åˆ</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆ›å»ºParameterMappingTokenHandlerå¯¹è±¡ï¼Œ å®ƒæ˜¯è§£æ#&#123;&#125;å ä½ç¬¦ä¸­çš„å‚æ•°å±æ€§ä»¥åŠæ›¿æ¢å ä½ç¬¦çš„æ ¸å¿ƒ</span></span><br><span class="line">  ParameterMappingTokenHandler handler = </span><br><span class="line">    <span class="keyword">new</span> ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é…åˆParameterMappingTokenHandlerè§£æå ä½ç¬¦</span></span><br><span class="line">  GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">&quot;#&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, handler);</span><br><span class="line">  String sql = parser.parse(originalSql);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StaticSqlSource(configuration, sql, handler.getParameterMappings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DynamicSqlSource"><a href="#DynamicSqlSource" class="headerlink" title="DynamicSqlSource"></a>DynamicSqlSource</h2><p><code>DynamicSqlSource</code>è´Ÿè´£è§£æåŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„<code>Sqlource</code>å®ç°ä¹‹ä¸€ã€‚<code>SqlNode</code>ä¸­ä½¿ç”¨äº†ç»„åˆæ¨¡å¼ï¼Œå½¢æˆäº†ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œ<code>DynamicSqlSource</code>ä¸­ä½¿ç”¨<code>rootSqlNode</code>å­—æ®µ(<code>SqlNode</code>ç±»å‹)è®°å½•äº†å¾…è§£æçš„<code>SqlNode</code>æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</p>
<p><code>DynamicSqlSource.getBoundSql()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºDynamicContextå¯¹è±¡</span></span><br><span class="line">  DynamicContext context = <span class="keyword">new</span> DynamicContext(configuration, parameterObject);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é€šè¿‡è°ƒç”¨rootSqlNode.apply()æ–¹æ³•è°ƒç”¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å…¨éƒ¨SqlNode.apply()æ–¹æ³•ã€‚</span></span><br><span class="line">  <span class="comment">// æ¯ä¸ªSqlNodeçš„apply()æ–¹æ³•éƒ½å°†è§£æå¾—åˆ°çš„SQLè¯­å¥ç‰‡æ®µè¿½åŠ åˆ°contextä¸­ï¼Œ</span></span><br><span class="line">  <span class="comment">// æœ€ç»ˆé€šè¿‡context.getSql()å¾—åˆ°å®Œæ•´çš„SQLè¯­å¥</span></span><br><span class="line">  rootSqlNode.apply(context);</span><br><span class="line">  SqlSourceBuilder sqlSourceParser = <span class="keyword">new</span> SqlSourceBuilder(configuration);</span><br><span class="line">  Class&lt;?&gt; parameterType = parameterObject == <span class="keyword">null</span> ? </span><br><span class="line">    Object.class : parameterObject.getClass();</span><br><span class="line">  SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), </span><br><span class="line">                                              parameterType, context.getBindings());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆ›å»ºBoundSqlå¯¹è±¡ï¼Œå¹¶å°†DynamicContext.bindingsä¸­çš„å‚æ•°ä¿¡æ¯å¤åˆ¶åˆ°å…¶</span></span><br><span class="line">  BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">    boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/10441615985826561598582656771.png" alt="image-20200828104415997"></p>
<h2 id="RawSqISource"><a href="#RawSqISource" class="headerlink" title="RawSqISource"></a>RawSqISource</h2><p><code>RawSqISource</code>æ˜¯<code>SqlSource</code>çš„å¦ä¸€ä¸ªå®ç°ï¼Œå…¶é€»è¾‘ä¸<code>DynamicSqlSource</code>ç±»ä¼¼ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶æœºä¸ä¸€æ ·ï¼Œå¤„ç†çš„<code>SQL</code>è¯­å¥ç±»å‹ä¹Ÿä¸ä¸€æ ·ã€‚</p>
<p>å‰é¢ä»‹ç»<code>XMLScriptBuilder.parseDynamicTags()</code>æ–¹æ³•æ—¶æåˆ°è¿‡ï¼Œå¦‚æœèŠ‚ç‚¹åªåŒ…å«<code>#&#123;&#125;</code>å ä½ç¬¦ï¼Œè€Œä¸åŒ…å«åŠ¨æ€<code>SQL</code>èŠ‚ç‚¹æˆ–æœªè§£æçš„<code>$&#123;&#125;</code>å ä½ç¬¦çš„è¯ï¼Œåˆ™ä¸æ˜¯åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œä¼šåˆ›å»ºç›¸åº”çš„<code>StaticTextSqlNode</code>å¯¹è±¡ã€‚</p>
<p>åœ¨<code>XMLScriptBuilder.parseScriptNode()</code>æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ•´ä¸ª<code>SQL</code>èŠ‚ç‚¹æ˜¯å¦ä¸ºåŠ¨æ€çš„ï¼Œå¦‚æœä¸æ˜¯åŠ¨æ€çš„<code>SQL</code>èŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºç›¸åº”çš„<code>RawSqlSource</code>å¯¹è±¡ã€‚</p>
<p><strong><code>RawSqlSource</code>åœ¨æ„é€ æ–¹æ³•ä¸­é¦–å…ˆä¼šè°ƒç”¨<code>getSql()</code>æ–¹æ³•ï¼Œå…¶ä¸­é€šè¿‡è°ƒç”¨<code>SqlNode.apply()</code>æ–¹æ³•å®Œæˆ<code>SQL</code>è¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥å¤„ç†ï¼›</strong>ä¹‹åä¼šä½¿ç”¨<code>SqlSourceBuilder</code>å®Œæˆå ä½ç¬¦çš„æ›¿æ¢å’Œ<code>ParameterMapping</code>é›†åˆçš„åˆ›å»ºï¼Œå¹¶è¿”å›<code>StaticSqlSource</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RawSqlSource</span> <span class="keyword">implements</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSource sqlSource;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RawSqlSource</span><span class="params">(Configuration configuration, SqlNode rootSqlNode, Class&lt;?&gt; parameterType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨getsql()æ–¹æ³•ï¼Œå®ŒæˆSQLè¯­å¥çš„æ‹¼è£…å’Œåˆæ­¥è§£æ</span></span><br><span class="line">    <span class="keyword">this</span>(configuration, getSql(configuration, rootSqlNode), parameterType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RawSqlSource</span><span class="params">(Configuration configuration, String sql, Class&lt;?&gt; parameterType)</span> </span>&#123;</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = <span class="keyword">new</span> SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; clazz = parameterType == <span class="keyword">null</span> ? Object.class : parameterType;</span><br><span class="line">    sqlSource = sqlSourceParser.parse(sql, clazz, <span class="keyword">new</span> HashMap&lt;String, Object&gt;());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getSql</span><span class="params">(Configuration configuration, SqlNode rootSqlNode)</span> </span>&#123;</span><br><span class="line">    DynamicContext context = <span class="keyword">new</span> DynamicContext(configuration, <span class="keyword">null</span>);</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    <span class="keyword">return</span> context.getSql();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sqlSource.getBoundSql(parameterObject);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ— è®ºæ˜¯<code>StaticSqlSource</code>ã€<code>DynamicSqlSource</code>è¿˜æ˜¯<code>RawSqlSource</code>ï¼Œæœ€ç»ˆéƒ½ä¼šç»Ÿä¸€ç”Ÿæˆ<code>BoundSql</code>å¯¹è±¡ï¼Œå…¶ä¸­å°è£…äº†<u>å®Œæ•´çš„<code>SQL</code>è¯­å¥(å¯èƒ½åŒ…å«<code>?</code>å ä½ç¬¦)</u>ã€<u>å‚æ•°æ˜ å°„å…³ç³»(<code>parameterMappings</code>é›†åˆ)</u>ä»¥åŠ<u>ç”¨æˆ·ä¼ å…¥çš„å‚æ•°(<code>additionalParameters</code>é›†åˆ)</u>ã€‚</p>
<p>å¦å¤–ï¼Œ<code>DynamicSqlSource</code>è´Ÿè´£å¤„ç†åŠ¨æ€<code>SQL</code>è¯­å¥ï¼Œ<code>RawSqlSource</code>è´Ÿè´£å¤„ç†é™æ€<code>SQL</code>è¯­å¥ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ<u>ä¸¤è€…è§£æ<code>SQL</code>è¯­å¥çš„æ—¶æœºä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…çš„è§£ææ—¶æœºæ˜¯åœ¨å®é™…æ‰§è¡Œ<code>SQL</code>è¯­å¥ä¹‹å‰ï¼Œè€Œåè€…åˆ™æ˜¯åœ¨<code>MyBatis</code>åˆå§‹åŒ–æ—¶å®Œæˆ<code>SQL</code>è¯­å¥çš„è§£æã€‚</u></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><p><strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
<li><p>éƒ¨åˆ†å›¾ç‰‡æ¥æºâ€”â€”<strong>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</strong></p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">ğŸ³Antä¸¶</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.cayzlh.com/2020/08/21/bebe404d.html">https://www.cayzlh.com/2020/08/21/bebe404d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.cayzlh.com">BLOG | CAYZLH</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/MyBatis/">MyBatis</a><a class="post-meta__tags" href="/blog/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a><a class="post-meta__tags" href="/blog/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/">æ ¸å¿ƒå¤„ç†å±‚</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2021/01/05/d2d07489.html"><i class="fa fa-chevron-left">  </i><span>ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹-åŸºç¡€å…¥é—¨</span></a></div><div class="next-post pull-right"><a href="/blog/2020/06/22/c499e157.html"><span>æ ¸å¿ƒå¤„ç†å±‚-MyBatisåˆå§‹åŒ–</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="footer_custom_text">hitokoto</div><div class="copyright">ğŸ³Antä¸¶ &copy;2019 - 2021</div><div class="icp"><a><span>ç²¤ICPå¤‡20058712å·</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.9.0"></script><script src="/blog/js/fancybox.js?version=1.9.0"></script><script src="/blog/js/sidebar.js?version=1.9.0"></script><script src="/blog/js/copy.js?version=1.9.0"></script><script src="/blog/js/fireworks.js?version=1.9.0"></script><script src="/blog/js/transition.js?version=1.9.0"></script><script src="/blog/js/scroll.js?version=1.9.0"></script><script src="/blog/js/head.js?version=1.9.0"></script><script src="/blog/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>